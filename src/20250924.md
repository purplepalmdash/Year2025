# 20250924
### 1. win7 verification(h470)
`匹配旧机器`， 卡在"安装程序正在更新注册表配置"页面， 再度重启后，无限重启，无法进入系统。    

![./images/2025_09_24_10_20_41_974x630.jpg](./images/2025_09_24_10_20_41_974x630.jpg)

`匹配新机器`， 安装完毕后，蓝屏：      

0000003B     

### 2. win7 蓝屏镜像再应用
思路：去掉里面的Intel核显驱动。自行安装驱动。     

#### 2.1 蓝屏镜像bios化

![./images/2025_09_24_10_42_16_700x505.jpg](./images/2025_09_24_10_42_16_700x505.jpg)
卡在:    

![./images/2025_09_24_10_42_40_680x377.jpg](./images/2025_09_24_10_42_40_680x377.jpg)

#### 2.2 蓝屏镜像uefi化
无法启动，报蓝屏（因硬件发生改变）    

### 3. win7安装(uefi/bios)    
#### 3.1 bios
分区：    

![./images/2025_09_24_10_49_17_856x660.jpg](./images/2025_09_24_10_49_17_856x660.jpg)

不需要选uefi相关:     

![./images/2025_09_24_10_50_02_799x563.jpg](./images/2025_09_24_10_50_02_799x563.jpg)

#### 3.2 uefi
第一步: 1Core的配置，可以安装成功。qxl+vnc.此时打开双网卡，打开rdesktop, 备份相关配置     

```
root@idv-TC-9073:~/workspace# virsh dumpxml win7_test_uefi>vnc_win7_test_uefi.xml
```  
第二步：改一个透传的配置出来，此时因为显卡驱动没有安装，应该可以在显示器上看到画面（分辨率不正常)    

![./images/2025_09_24_11_35_11_714x623.jpg](./images/2025_09_24_11_35_11_714x623.jpg)

备份。    

```
# cp win7_test_uefi.qcow2 win7_test_uefi.qcow2.beforeuhd630
```
方法1：  安装自己下载的驱动:      

![./images/2025_09_24_11_41_43_636x643.jpg](./images/2025_09_24_11_41_43_636x643.jpg)

![./images/2025_09_24_11_42_00_823x464.jpg](./images/2025_09_24_11_42_00_823x464.jpg)

![./images/2025_09_24_11_43_49_589x477.jpg](./images/2025_09_24_11_43_49_589x477.jpg)
自己安装的驱动进入到蓝屏状态：    

![./images/2025_09_24_11_50_09_799x580.jpg](./images/2025_09_24_11_50_09_799x580.jpg)

恢复状态：     

```
virsh destroy win7_test_uefi
cp win7_test_uefi.qcow2.beforeuhd630 win7_test_uefi.qcow2
virsh start win7_test_uefi
```
方法2：  驱动总裁自己安装uhd630驱动    

方法2.1 安装最新的26.20.18.8061

![./images/2025_09_24_11_49_22_912x477.jpg](./images/2025_09_24_11_49_22_912x477.jpg)

安装完毕后的设备管理器:     

![./images/2025_09_24_11_52_27_669x536.jpg](./images/2025_09_24_11_52_27_669x536.jpg)

驱动版本：    

![./images/2025_09_24_11_52_43_391x422.jpg](./images/2025_09_24_11_52_43_391x422.jpg)

按提示重启,蓝屏：    

![./images/2025_09_24_11_52_56_644x313.jpg](./images/2025_09_24_11_52_56_644x313.jpg)

恢复状态:    

```
virsh destroy win7_test_uefi && cp win7_test_uefi.qcow2.beforeuhd630 win7_test_uefi.qcow2 && virsh start win7_test_uefi
```
方法2.2 安装稳定的26.20.18.8012

![./images/2025_09_24_11_56_18_885x415.jpg](./images/2025_09_24_11_56_18_885x415.jpg)

![./images/2025_09_24_11_58_38_417x383.jpg](./images/2025_09_24_11_58_38_417x383.jpg)

重启后蓝屏:    

![./images/2025_09_24_11_59_51_815x607.jpg](./images/2025_09_24_11_59_51_815x607.jpg)

恢复状态:    

```
virsh destroy win7_test_uefi && cp win7_test_uefi.qcow2.beforeuhd630 win7_test_uefi.qcow2 && virsh start win7_test_uefi
```
#### 3.3 legacy bios
备份配置文件：    

```
virsh dumpxml win7test>vnc_win7test.xml
```
remove vnc/qxl, then add igpu/mouse/keyboard, add vnc/qxl.     

Add qemu args.    

Start machine.    


![./images/2025_09_24_12_13_10_1594x1187.jpg](./images/2025_09_24_12_13_10_1594x1187.jpg)

![./images/2025_09_24_12_10_40_790x716.jpg](./images/2025_09_24_12_10_40_790x716.jpg)

安装驱动:     

![./images/2025_09_24_12_11_14_903x308.jpg](./images/2025_09_24_12_11_14_903x308.jpg)

![./images/2025_09_24_12_13_42_679x383.jpg](./images/2025_09_24_12_13_42_679x383.jpg)

Kernel output issue:    

![./images/2025_09_24_12_14_40_1200x634.jpg](./images/2025_09_24_12_14_40_1200x634.jpg)

屏幕保持黑    

![./images/2025_09_24_12_17_37_919x350.jpg](./images/2025_09_24_12_17_37_919x350.jpg)

![./images/2025_09_24_12_19_46_944x427.jpg](./images/2025_09_24_12_19_46_944x427.jpg)
### 4. pve(legacy bios)
i3-8100 with csm(legacy):    

```
# bootctl status
systemd-boot not installed in ESP.
System:
Not booted with EFI

Available Boot Loaders on ESP:
          ESP: /boot/efi (/dev/disk/by-partuuid/bbc0768a-9407-42e7-814f-4e7c14059d1f)
         File: └─/EFI/BOOT/BOOTx64.efi

Boot Loader Entries:
        $BOOT: /boot/efi (/dev/disk/by-partuuid/bbc0768a-9407-42e7-814f-4e7c14059d1f)

0 entries, no entry could be determined as default.
# ls /sys/firmware/
acpi/   dmi/    memmap/ 
```
Steps:     

```
 cat /etc/default/grub | grep LINUX_DEFAULT
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pcie_acs_override=downstream,multifunction initcall_blacklist=sysfb_init  video=efifb:off,vesafb:off video=simplefb:off vfio-pci.ids=8086:3e91"
root@kucf:~# cat /etc/modprobe.d/blacklist.conf
# block AMD driver
blacklist radeon
blacklist amdgpu

# block NVIDIA driver
blacklist nouveau
blacklist nvidia
blacklist nvidiafb

# block INTEL driver
blacklist snd_hda_intel
blacklist snd_hda_codec_hdmi
blacklist i915

options vfio_iommu_type1 allow_unsafe_interrupts=1
root@kucf:~# cat /etc/modules
# /etc/modules: kernel modules to load at boot time.
#
# This file contains the names of kernel modules that should be loaded
# at boot time, one per line. Lines beginning with "#" are ignored.
# Parameters can be specified after the module name.
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
root@kucf:~# cat /etc/modprobe.d/vfio.conf
options vfio-pci ids=8086:3e91
root@kucf:~# cat /etc/modprobe.d/kvm.conf
options kvm ignore_msrs=1
root@kucf:~# echo "options vfio_iommu_type1 allow_unsafe_interrupts=1" > /etc/modprobe.d/iommu_unsafe_interrupts.conf
root@kucf:~# update-initramfs -u -k all && update-grub2 
```

步骤稍后加    

```
cp /etc/pve/qemu-server/100.conf /root/
Edit 100.conf for removing our previous host-pci passthrough items and parameters.    
```

必须使用default的显卡来进行xiaobing.iso+恢复镜像的第一步安装, 这是因为默认的xiaobing.iso启动会启动本机的操作系统，而此时本机硬盘上为空。。      

![./images/2025_09_24_16_00_09_1102x667.jpg](./images/2025_09_24_16_00_09_1102x667.jpg)

分区为MBR：    

![./images/2025_09_24_16_01_53_830x622.jpg](./images/2025_09_24_16_01_53_830x622.jpg)

直接安装:     

![./images/2025_09_24_16_02_40_712x544.jpg](./images/2025_09_24_16_02_40_712x544.jpg)

第一步完成以后，直接关机。    

![./images/2025_09_24_16_05_59_941x689.jpg](./images/2025_09_24_16_05_59_941x689.jpg)

### 5. pve(legacy verification)
#### 5.1 csm(uefi)+i440fx+pc
csm(display: uefi), choose uefi:    
![./images/2025_09_24_19_26_03_1171x624.jpg](./images/2025_09_24_19_26_03_1171x624.jpg)

hardware configuration:     

![./images/2025_09_24_19_14_10_797x429.jpg](./images/2025_09_24_19_14_10_797x429.jpg)

guest infos:   

![./images/2025_09_24_19_14_36_764x1069.jpg](./images/2025_09_24_19_14_36_764x1069.jpg)

no signal on screen.    

![./images/2025_09_24_19_16_26_866x646.jpg](./images/2025_09_24_19_16_26_866x646.jpg)
 
#### 5.2 csm(uefi)+q35+pc
hardware configuration:     

![./images/2025_09_24_19_18_17_797x460.jpg](./images/2025_09_24_19_18_17_797x460.jpg)

guest infos:    

![./images/2025_09_24_19_22_38_1313x712.jpg](./images/2025_09_24_19_22_38_1313x712.jpg)

#### 5.3 csm(legacy)+i440fx+pc
Choose legacy:    

![./images/2025_09_24_19_26_03_1171x624.jpg](./images/2025_09_24_19_26_03_1171x624.jpg)

cpu keep 100%    

![./images/2025_09_24_19_30_59_929x362.jpg](./images/2025_09_24_19_30_59_929x362.jpg)
#### 5.4 csm(legacy)+q35+pc
console output(stuck at last):    

![./images/2025_09_24_19_32_23_1136x691.jpg](./images/2025_09_24_19_32_23_1136x691.jpg)

screen output:     

![./images/2025_09_24_19_33_51_1197x710.jpg](./images/2025_09_24_19_33_51_1197x710.jpg)

guest info:    

![./images/2025_09_24_19_35_04_810x810.jpg](./images/2025_09_24_19_35_04_810x810.jpg)
#### 5.5 csm(closed)
Close method

Change all of the items to UEFI:    

![./images/2025_09_24_19_56_58_1007x566.jpg](./images/2025_09_24_19_56_58_1007x566.jpg)

Change Boot option filter:     

![./images/2025_09_24_19_57_23_1147x579.jpg](./images/2025_09_24_19_57_23_1147x579.jpg)

Reboot and re-enter bios:     

![./images/2025_09_24_19_57_43_1112x299.jpg](./images/2025_09_24_19_57_43_1112x299.jpg)

Boot page:    

![./images/2025_09_24_19_58_04_1165x590.jpg](./images/2025_09_24_19_58_04_1165x590.jpg)

Before vm start:    

![./images/2025_09_24_19_58_25_1098x626.jpg](./images/2025_09_24_19_58_25_1098x626.jpg)

#### 5.6 csm(closed)+q35+pc

![./images/2025_09_24_19_59_10_932x663.jpg](./images/2025_09_24_19_59_10_932x663.jpg)

#### 5.7 csm(closed)+i440+pc

no signal on screen. but rdesktop OK, uhd works with no output.        

![./images/2025_09_24_20_01_49_710x602.jpg](./images/2025_09_24_20_01_49_710x602.jpg)

#### 5.8. try

![./images/2025_09_24_20_18_08_754x419.jpg](./images/2025_09_24_20_18_08_754x419.jpg)

```
args: -set device.hostpci0.addr=02.0 -set device.hostpci0.x-igd-gms=0x2 -set device.hostpci0.x-igd-opregion=on
boot: order=scsi0;sata0;sata1;sata2;net0
cores: 8
cpu: host
hostpci0: 0000:00:02.0,legacy-igd=1,romfile=igd.rom
machine: pc-q35-9.2+pve1
memory: 8192
meta: creation-qemu=9.2.0,ctime=1758706055
name: q35win7
net0: e1000=BC:24:11:BE:3A:BA,bridge=vmbr0,firewall=1
numa: 0
ostype: win10
sata0: local:iso/windows7x64_ultimate_2025.iso,media=cdrom,size=5409024K
sata1: local:iso/virtio-win-0.1.248.iso,media=cdrom,size=715188K
sata2: local:iso/XiaoBing.iso,media=cdrom,size=1568244K
scsi0: local-lvm:vm-101-disk-0,iothread=1,size=60G
scsihw: virtio-scsi-single
smbios1: uuid=e4b7bb21-da98-4d19-89d5-998cfc4f6638
sockets: 1
usb0: host=1-3.2
usb1: host=1-10
usb2: host=1-9
vga: none
vmgenid: bc7e7233-7113-4e4d-802c-9f9ef98affc0
```
So: uefi+i440+legacy-igd=1 try?   

### 6. pve(ovmf+i440+legacy-igd=1)
Result:     

![./images/2025_09_24_22_36_10_1428x866.jpg](./images/2025_09_24_22_36_10_1428x866.jpg)

hardware:     

![./images/2025_09_24_22_36_35_809x531.jpg](./images/2025_09_24_22_36_35_809x531.jpg)

```
args: -set device.hostpci0.addr=02.0 -set device.hostpci0.x-igd-gms=0x2 -set device.hostpci0.x-igd-opregion=on
bios: ovmf
boot: order=sata0;sata1
cores: 8
cpu: host
efidisk0: local-lvm:vm-102-disk-0,efitype=4m,pre-enrolled-keys=1,size=4M
hostpci0: 0000:00:02.0,romfile=igpu.rom,legacy-igd=1
machine: pc-i440fx-9.2+pve1
memory: 8192
meta: creation-qemu=9.2.0,ctime=1758719620
name: ovmflegacy
net0: e1000=BC:24:11:F3:5D:72,bridge=vmbr0,firewall=1
numa: 0
ostype: linux
sata0: local-lvm:vm-102-disk-1,size=32G
sata1: local:iso/XiaoBing.iso,media=cdrom,size=1568244K
sata2: local:iso/windows7x64_ultimate_2025.iso,media=cdrom,size=5409024K
sata3: local:iso/virtio-win-0.1.248.iso,media=cdrom,size=715188K
scsihw: virtio-scsi-single
smbios1: uuid=80041986-2a08-48c2-a21d-29d2b0781867
sockets: 1
usb0: host=03f0:0024,usb3=1
usb1: host=413c:301a,usb3=1
vga: none
vmgenid: 8322e4cf-e000-47af-9694-c6e1afbc5984
```
Replace the deb packages then you could see gop output:     

```
 dpkg -i pve-qemu-kvm_9.2.0-7_amd64.deb 
 dpkg -i pve-edk2-firmware-ovmf_4.2025.02-4.bpo12.1_all.deb
```
Issue:     

```
windows7在uhd630下启动时报错： igdkmd64.sys -Address FFFFF880072B7C28 has at FFFFF8800707B000, DateStamp 5e279154
```
