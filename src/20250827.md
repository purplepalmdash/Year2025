# 20250827
### 1. euler kernel compile
Steps:     

```
sed -E 's#https?://(repo|mirrors)\.openeuler\.org/#https://mirrors.ustc.edu.cn/openeuler/#g' \
         -i.bak \
         /etc/yum.repos.d/openEuler.repo
yum makecache
wget https://mirrors.ustc.edu.cn/openeuler/openEuler-22.03-LTS-SP1/source/Packages/kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
useradd -m mock
mv kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm /home/mock/ && chmod 777 /home/mock/kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
yum install -y rpm-build asciidoc audit-libs-devel binutils-devel bison clang dwarves elfutils-devel elfutils-libelf-devel flex gcc glibc-static gtk2-devel java-1.8.0-openjdk java-1.8.0-openjdk-devel java-devel libbabeltrace-devel libcap-devel libcap-ng-devel libunwind-devel libzstd-devel llvm m4 make ncurses-devel net-tools newt-devel numactl-devel openssl-devel pciutils-devel perl-generators python3-devel python3-docutils rsync xmlto xz-devel zlib-devel
su - mock
```
As mock:     

```
rpm -ivh kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
cd /home/mock/rpmbuild/SOURCES
tar xzvf kernel.tar.gz
cd kernel
cp /boot/config-5.10.0-136.12.0.86.oe2203sp1.aarch64 .config
make menuconfig
```
Open following items:     

```
## use custom kernel 5.10.* LTS

# codec2 required
CONFIG_DMABUF_HEAPS=y
CONFIG_DMABUF_HEAPS_SYSTEM=y

CONFIG_STAGING=y
CONFIG_ASHMEM=y

# binderfs required
CONFIG_ANDROID=y
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ANDROID_BINDERFS=y
CONFIG_ANDROID_BINDER_DEVICES="binder,hwbinder,vndbinder"„Äç
```
Back config, re-org package:      

```
  cp .config ~/configkernel
  cd ..
  rm -rf kernel
  tar xzvf kernel.tar.gz 
  cp ~/configkernel kernel/arch/arm64/configs/openeuler_defconfig 
  rm -f kernel.tar.gz 
  tar czvf kernel.tar.gz kernel/
  rm -rf kernel
```
Build the kernel:     

```
[mock@euler SOURCES]$ cd ../SPECS/
[mock@euler SPECS]$ time rpmbuild -ba kernel.spec 
```
### 2. directly write qcow2
nixos enable related items:     

```
# vim /etc/nixos/configuration.nix
...
+  boot.supportedFilesystems.apfs = true;
...

  environment.systemPackages = with pkgs; [
      weston
+      qemu
    ];
# sudo nixos-rebuild switch --option substituters  "https://mirrors.sjtug.sjtu.edu.cn/nix-channels/store"
```
Then :      

```
 qemu-img dd -f qcow2 -O raw bs=4M if=/run/media/dash/009f7558-fd67-4765-98ba-6314ca6bb68e/images/ctyunos2505.qcow2 of=/dev/sdb

```
Boot from usb, then enter rescue mode:      

```
/usr/bin/dracut -f /boot/initramfs-5.15.98.img 5.15.98

choose 5.15 for starting
Then install new kernel.  

grub2-mkconfig ...
grubby --set-default
```

