# 20260117
### 1. usbDK & usbredirect
下载最新的 `UsbDk_1.0.22_x64.msi` (版本号可能会更新)。 下载地址：SPICE Space 官网. 双击运行 .msi 文件安装。

验证 UsbDk 是否正常工作： 打开 CMD 或 PowerShell，运行：    

```
"C:\Program Files\UsbDk Runtime Library\UsbDkController.exe" -n
```
![./images/2026_01_17_11_32_34_564x232.jpg](./images/2026_01_17_11_32_34_564x232.jpg)

如果能列出你电脑上的一大堆 USB 设备树，说明 UsbDk 已经就绪。   

### 2. 开发/编译环境
下载MASY2`https://www.msys2.org/`并安装：    

![./images/2026_01_17_11_53_26_416x674.jpg](./images/2026_01_17_11_53_26_416x674.jpg)

打开`MSYS2 UCRT64`.     

更新系统 + 安装基本工具:    

```
pacman -Syu
# 可能要关闭再重新打开终端
pacman -Syu
```

安装 usbredir 需要的依赖（交叉编译或 native 编译都类似，但 native ucrt64 更简单）

```
pacman -S \
  mingw-w64-ucrt-x86_64-gcc \
  mingw-w64-ucrt-x86_64-glib2 \
  mingw-w64-ucrt-x86_64-libusb \
  mingw-w64-ucrt-x86_64-meson \
  mingw-w64-ucrt-x86_64-ninja \
  mingw-w64-ucrt-x86_64-pkgconf \
  git \
  make patch diffutils
```

clone 项目

```
git clone https://gitlab.freedesktop.org/spice/usbredir.git
cd usbredir
```

更改源文件，激活usbdk为backend`tools/usbredirect.c`, line 602:     

![./images/2026_01_17_11_56_51_610x493.jpg](./images/2026_01_17_11_56_51_610x493.jpg)

创建构建目录并配置（meson 会自动检测 ucrt64 的工具链）    

```
mkdir build
cd build
meson setup .. \
  -Ddefault_library=shared \
  -Dtools=enabled
```

编译:     

```
ninja
```
编译成功后, 手动拷贝dll到tools的目录下:     

```
find . | grep dll$
cp usbredirhost/libusbredirhost-1.dll tools/
cp usbredirparser/libusbredirparser-1.dll tools/
```
运行:     


```
test@DESKTOP-TB9JL06 UCRT64 ~/Code/usbredir/build/tools
$ ls
libusbredirhost-1.dll    libusbredirhost.dll.a    usbredirect.exe
libusbredirhost-1.dll.p  libusbredirparser-1.dll  usbredirect.exe.p

test@DESKTOP-TB9JL06 UCRT64 ~/Code/usbredir/build/tools
$   ./usbredirect.exe --device 1bcf:2284 --to 192.168.1.155:4002 -v 3
```

### 3. proxmox 配置
在配置文件前追加args一行的参数，添加4001～4004 usb-on-tcp重定向端口:      

```
root@pve:~# cat /etc/pve/qemu-server/100.conf 
args: -device qemu-xhci,id=xhci -chardev socket,id=charredir1,host=0.0.0.0,port=4001,server=on,wait=off -device usb-redir,chardev=charredir1,id=redir1,bus=xhci.0 -chardev socket,id=charredir2,host=0.0.0.0,port=4002,server=on,wait=off -device usb-redir,chardev=charredir2,id=redir2,bus=xhci.0 -chardev socket,id=charredir3,host=0.0.0.0,port=4003,server=on,wait=off -device usb-redir,chardev=charredir3,id=redir3,bus=xhci.0 -chardev socket,id=charredir4,host=0.0.0.0,port=4004,server=on,wait=off -device usb-redir,chardev=charredir4,id=redir4,bus=xhci.0
boot: order=virtio0;sata0;net0;sata1
cores: 4
```
