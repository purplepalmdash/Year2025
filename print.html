<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>year2025</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">year2025</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="year2025"><a class="header" href="#year2025">Year2025</a></h1>
<p>用来记录2025年每天所做的事情，主要是技术类。</p>
<p>From 2025Feb06</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Conclusion</th></tr></thead><tbody>
<tr><td>20250206</td><td>ollama/webui, x86 lxc works</td></tr>
<tr><td>20250207</td><td>libvirt-lxc hooks, usb camera passthrough</td></tr>
<tr><td>20250208</td><td>run deepsex at home</td></tr>
<tr><td>20250209</td><td>run hyper-v based aarch64 nixos at home</td></tr>
<tr><td>20250210</td><td>upgrade ollma, gtx1660s/3050 passthrough, x86 lxc works</td></tr>
<tr><td>20250211</td><td>arm64 lxc works, mainly on d3000, deepin got issue, host is zkfd</td></tr>
<tr><td>20250212</td><td>3a6000 lxc works, old/new world issues</td></tr>
<tr><td>20250213</td><td>3a6000 libvirt-lxc works(need re-compile libvirt), arm64 lxc verification on d2000, mainly ok. But libvirt-lxc got issues.</td></tr>
<tr><td>20250214</td><td>meet some bugs on x86 lxc, verification.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="20250206"><a class="header" href="#20250206">2025.02.06</a></h1>
<h3 id="1-open-webuidockerollama"><a class="header" href="#1-open-webuidockerollama">1. Open-WebUI/Docker/Ollama</a></h3>
<p>Fetch new models:</p>
<pre><code>ollama run deepseek-r1:32b
ollama run huihui_ai/deepseek-r1-abliterated:32b
</code></pre>
<p>Configuration for ollama:</p>
<pre><code>root@ai:/home/dash# cat /etc/systemd/system/ollama.service 
[Unit]
Description=Ollama Service
After=network-online.target

[Service]
+ Environment="OLLAMA_HOST=0.0.0.0"
ExecStart=/usr/local/bin/ollama serve
User=ollama
Group=ollama
# systemctl daemon-reload
# systemctl restart ollama
</code></pre>
<p>Run docker based open-webui:</p>
<pre><code>sudo docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v  /opt/openwebui:/app/backend/data --name openwebui --restart always  ghcr.io/open-webui/open-webui:main
</code></pre>
<p>Then you could use the webui for calling deepseeker:</p>
<p><img src="./images/20250206_100129_x.jpg" alt="./images/20250206_100129_x.jpg" /></p>
<h3 id="2-deepin-lxc-image"><a class="header" href="#2-deepin-lxc-image">2. deepin lxc image</a></h3>
<p>Download the iso and create the vm disk:</p>
<pre><code># ls /media/big/iso/deepin-desktop-community-23-amd64.iso
# qemu-img create -f raw deepin23.img 30G
Formatting 'deepin23.img', fmt=raw size=32212254720
</code></pre>
<p><img src="./images/20250206_101149_x.jpg" alt="./images/20250206_101149_x.jpg" /></p>
<p><img src="./images/20250206_101202_x.jpg" alt="./images/20250206_101202_x.jpg" /></p>
<p><img src="./images/20250206_101227_x.jpg" alt="./images/20250206_101227_x.jpg" /></p>
<p><img src="./images/20250206_101243_x.jpg" alt="./images/20250206_101243_x.jpg" /></p>
<p>Install with 6.6 based kernel.</p>
<p><img src="./images/20250206_101343_x.jpg" alt="./images/20250206_101343_x.jpg" /></p>
<p>Customization:</p>
<p><img src="./images/20250206_101403_x.jpg" alt="./images/20250206_101403_x.jpg" /></p>
<p><img src="./images/20250206_101418_x.jpg" alt="./images/20250206_101418_x.jpg" /></p>
<p><img src="./images/20250206_101434_x.jpg" alt="./images/20250206_101434_x.jpg" /></p>
<p><img src="./images/20250206_101453_x.jpg" alt="./images/20250206_101453_x.jpg" /></p>
<p>Choose "高级安装":</p>
<p><img src="./images/20250206_101601_x.jpg" alt="./images/20250206_101601_x.jpg" /></p>
<p><img src="./images/20250206_101615_x.jpg" alt="./images/20250206_101615_x.jpg" /></p>
<p>Ignore the swap:</p>
<p><img src="./images/20250206_101632_x.jpg" alt="./images/20250206_101632_x.jpg" /></p>
<p><img src="./images/20250206_101747_x.jpg" alt="./images/20250206_101747_x.jpg" /></p>
<p>After installation:</p>
<p><img src="./images/20250206_101824_x.jpg" alt="./images/20250206_101824_x.jpg" /></p>
<p>Configuration:</p>
<p><img src="./images/20250206_101842_x.jpg" alt="./images/20250206_101842_x.jpg" /></p>
<p>password-less login:</p>
<p><img src="./images/20250206_101937_x.jpg" alt="./images/20250206_101937_x.jpg" /></p>
<p><code>sudo visudo</code> for use the passworld-less sudo .</p>
<pre><code>sudo apt install -y openssh-server
sudo vim /etc/default/grub
Change to : GRUB_CMDLINE_LINUX_DEFAULT="quiet net.ifnames=0 biosdevname=0"
Change to : GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"
sudo update-grub2
sudo update-grub
sudo apt update -y
sudo apt install -y xserver-xorg-input-evdev glmark2 smplayer
sudo reboot
</code></pre>
<p>Fetch the image to the folder:</p>
<pre><code>sudo mount -o loop,offset=$((2048*512)) deepin23.img /mnt-resource/
sudo mkdir /media/nvme/deepinlxc
sudo rsync -av /mnt-resource/* /media/nvme/deepinlxc/
</code></pre>
<p>tar the file:</p>
<pre><code>$ cd /media/nvme/deepinlxc
$ sudo rm -rf dev/*
$ sudo tar -cpvf deepinlxc.tar * &amp;&amp; sudo xz -T16 deepinlxc.tar
$ ls -l -h *.tar.xz
-rw-r--r-- 1 root root 5.2G  2月  6 10:46 deepinlxc.tar.xz
</code></pre>
<h3 id="3-deepin-lxc-instance"><a class="header" href="#3-deepin-lxc-instance">3. deepin lxc instance</a></h3>
<p>Create the instance via:</p>
<pre><code>lxc-create -t local -n deepinlxc -- -m  /root/meta.tar.xz -f /root/deepinlxc.tar.xz &amp;&amp; cat added.conf &gt;&gt; /var/lib/lxc/deepinlxc/config  &amp;&amp; mkdir -p /var/lib/lxc/deepinlxc/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/deepinlxc/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/deepinlxc/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/deepinlxc/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/deepinlxc/rootfs/etc/systemd/system/lightdm.service.d
</code></pre>
<p>The content of <code>added.conf</code> is listed as:</p>
<pre><code>lxc.mount.entry = /dev/fb0 dev/fb0 none bind,optional,create=file
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file
### allow tty8
lxc.mount.entry = /dev/tty7 dev/tty7 none bind,optional,create=file
lxc.mount.entry = /dev/tty8 dev/tty8 none bind,optional,create=file
lxc.mount.entry = /dev/tty0 dev/tty0 none bind,optional,create=file
### allow all of the input
lxc.mount.entry = /dev/input dev/input none bind,optional,create=dir
### allow all of the snd
lxc.mount.entry = /dev/snd dev/snd none bind,optional,create=dir
</code></pre>
<p>Edit file:</p>
<pre><code># vim /var/lib/lxc/deepinlxc/rootfs/etc/lightdm/lightdm.conf
......
minimum-vt=8
......
# vim /var/lib/lxc/deepinlxc/config
......
lxc.apparmor.profile = unconfined
......
</code></pre>
<p>Or globally change the lxc config file:</p>
<pre><code>$ sudo vim /etc/lxc/default.conf
......
lxc.apparmor.profile = unconfined
......
</code></pre>
<p>Now start the lxc instance via:</p>
<pre><code>lxc-start -n deepinlxc -F
</code></pre>
<p><img src="./images/20250206_164616_x.jpg" alt="./images/20250206_164616_x.jpg" /></p>
<p>run glmarks:</p>
<p><img src="./images/20250206_170918_x.jpg" alt="./images/20250206_170918_x.jpg" /></p>
<p>glmark2 score:</p>
<p><img src="./images/20250206_171432_x.jpg" alt="./images/20250206_171432_x.jpg" /></p>
<p>webgl fish:</p>
<p><img src="./images/20250206_171348_x.jpg" alt="./images/20250206_171348_x.jpg" /></p>
<h3 id="4-deepinlxc-sound"><a class="header" href="#4-deepinlxc-sound">4. deepinlxc sound</a></h3>
<p>Test video file:</p>
<pre><code>cp /home/test/Desktop/wind.mp4 /var/lib/lxc/deepinlxc/rootfs/home/test/Desktop/
</code></pre>
<p>Default sound is null:</p>
<pre><code>test@deepin:/root$ export DISPLAY=:0
test@deepin:/root$ pactl list sinks short
0	auto_null	module-null-sink.c	s16le 2ch 44100Hz	SUSPENDED
</code></pre>
<p>Added an autostart desktop file under user <code>test</code>:</p>
<pre><code>$ cat ~/.config/autostart/pactl.desktop 
[Desktop Entry]
0=p
1=a
2=c
3=t
4=l
Name=pactl
Exec=sh -c '/usr/bin/pactl load-module module-alsa-card device_id=1 ; /usr/bin/pactl load-module module-alsa-card device_id=0'
Terminal=false
Type=Application
Icon=pactl
StartupWMClass=pactl
Comment=pactl
Categories=Utility
</code></pre>
<p>After reboot, examine the output:</p>
<pre><code>test@deepin:~$ DISPLAY=:0 pactl list sinks short
1	alsa_output.0.analog-stereo	module-alsa-card.c	s16le 2ch 44100Hz	RUNNING
</code></pre>
<h3 id="5-using-libvirt"><a class="header" href="#5-using-libvirt">5. using libvirt</a></h3>
<p>Define the lxc xml:</p>
<pre><code>&lt;domain type='lxc'&gt;
  &lt;name&gt;deepinlxc&lt;/name&gt;
  &lt;memory unit='KiB'&gt;4276800&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;4276800&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/lib/systemd/systemd&lt;/init&gt;
  &lt;/os&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/libvirt/libvirt_lxc&lt;/emulator&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxc/deepinlxc/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/dev/snd'/&gt;
      &lt;target dir='/dev/snd'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/dev/input'/&gt;
      &lt;target dir='/dev/input'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/dev/dri'/&gt;
      &lt;target dir='/dev/dri'/&gt;
    &lt;/filesystem&gt;
    &lt;interface type='network'&gt;
      &lt;mac address='52:54:00:5f:0b:a8'/&gt;
      &lt;source network='default'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='0'/&gt;
    &lt;/console&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/dri/renderD128&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/fb0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/tty8&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/tty0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/dri/card0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event1&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event2&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event3&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event4&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event5&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event6&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event7&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event8&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event9&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event10&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/input/event11&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
        &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/controlC0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/hwC0D0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/hwC0D2&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D0c&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D0p&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D3p&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D7p&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D8p&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/pcmC0D9p&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/seq&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/snd/timer&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<p>Define and run instance:</p>
<pre><code># virsh -c lxc:/// define deepin.xml 
# virsh -c lxc:/// start deepinlxc
</code></pre>
<h3 id="6-automatically-scan-devices"><a class="header" href="#6-automatically-scan-devices">6. Automatically scan devices</a></h3>
<p>Using following scripts for creating a <code>10-lxc-devices.xml</code> which contains all of the misc devices used for lxc instance:</p>
<pre><code>dash@archnvme:~ $ cat input.sh 
#!/usr/bin/env bash

### Creates config file for virsh xml with all 
# currently present input/snd/fb*/card*/renderD* devices
######################################################################
# tty8 and tty0 should be always added. 
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty8&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty0&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_

# append all of the input devices
cd /dev/input
for input in event*
do
cat &gt;&gt; /etc/10-lxc-devices.xml &lt;&lt;_EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/input/$input&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
done

# append all of the snd devices
cd /dev/snd
for snd in *
do
if [ -d $snd ] 
    then 
    :
else
cat &gt;&gt; /etc/10-lxc-devices.xml &lt;&lt;_EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/snd/$snd&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
fi
done

# append all of the dri devices
cd /dev/dri
for dri in *
do
if [ -d $dri ] 
    then 
    :
else
cat &gt;&gt; /etc/10-lxc-devices.xml &lt;&lt;_EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/dri/$dri&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
fi
done

# append all of the fb devices
cd /dev/
for fbdev in fb*
do
cat &gt;&gt; /etc/10-lxc-devices.xml &lt;&lt;_EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/$fbdev&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
done
</code></pre>
<p>The <code>10-lxc-devices.xml</code> should be added like:</p>
<pre><code>virsh -c lxc:///  attach-device deepinlxc --file /etc/10-lxc-devices.xml --current
</code></pre>
<p>And this command should be added in libvirt hooks(in prepare period).</p>
<h3 id="7-debian-lxc-host-disable-apparmor"><a class="header" href="#7-debian-lxc-host-disable-apparmor">7. debian lxc host disable apparmor</a></h3>
<p>Solved via:</p>
<pre><code>systemctl disable apparmor
apt remove --assume-yes --purge apparmor
</code></pre>
<p>Using <code>systemd-analyze blame</code> you could detect the service startup time.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250207"><a class="header" href="#20250207">20250207</a></h1>
<h3 id="1-libvirt-hookscript"><a class="header" href="#1-libvirt-hookscript">1. libvirt hook/script</a></h3>
<p>Hooks:</p>
<pre><code>cat /etc/libvirt/hooks/lxc
#!/bin/bash
OBJECT="$1"
OPERATION="$2"
### dom startup
if [[ $OBJECT == "test" ]]; then
        case "$OPERATION" in
                "prepare")
		        chvt 8
                ;;
            "release")
		        chvt 7
                ;;
        esac
fi
</code></pre>
<p>attach and detach devices via script:</p>
<pre><code>root@lxcdesktop:/etc/libvirt/hooks# cat attach_dev.sh 
#!/bin/sh
# attach devices to minimum xml, before the lxc instance is launched.  
# Refers to `https://github.com/olavmrk/usb-libvirt-hotplug/blob/master/usb-libvirt-hotplug.sh`
DOMAIN="$1"
COMMAND='attach-device'

echo "attach tty devices"

# tty8
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty8&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
echo "done 1"
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
echo "done 2"

# tty0
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty0&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

# append all of the input devices
cd /dev/input
for input in event*
do
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/input/$input&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
done

# append all of the snd devices
cd /dev/snd
for snd in *
do
if [ -d $snd ]
    then
    :
else
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/snd/$snd&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
fi
done

# append all of the dri devices
cd /dev/dri
for dri in *
do
if [ -d $dri ]
    then
    :
else
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/dri/$dri&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
fi
done

# append all of the fb devices
cd /dev/
for fbdev in fb*
do
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/$fbdev&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
done



root@lxcdesktop:/etc/libvirt/hooks# cat detach_dev.sh 
#!/bin/bash
# attach devices to minimum xml, before the lxc instance is launched.  
# Refers to `https://github.com/olavmrk/usb-libvirt-hotplug/blob/master/usb-libvirt-hotplug.sh`
DOMAIN="$1"
COMMAND='detach-device'

echo "detach tty devices"

# tty8
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty8&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END

# tty0
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/tty0&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END

# append all of the input devices
cd /dev/input
for input in event*
do
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/input/$input&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END
done

# append all of the snd devices
cd /dev/snd
for snd in *
do
if [ -d $snd ]
    then
    :
else
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/snd/$snd&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END
fi
done

# append all of the dri devices
cd /dev/dri
for dri in *
do
if [ -d $dri ]
    then
    :
else
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/dri/$dri&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END
fi
done

# append all of the fb devices
cd /dev/
for fbdev in fb*
do
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --config /dev/stdin &lt;&lt;END
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/$fbdev&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
END
done
</code></pre>
<p>Start the lxc instance via:</p>
<pre><code>/bin/attach_dev.sh test &amp;&amp; virsh -c lxc:/// start test
</code></pre>
<p>Stop the lxc instance via:</p>
<pre><code>virsh -c lxc:/// destroy test &amp;&amp; /bin/detach_dev.sh test
</code></pre>
<h3 id="2-lxc-usb-camera"><a class="header" href="#2-lxc-usb-camera">2. lxc usb camera</a></h3>
<p>Test the usb cam in host:</p>
<pre><code>apt install -y cheese
cheese
</code></pre>
<p><img src="./images/20250207_145744_x.jpg" alt="./images/20250207_145744_x.jpg" /></p>
<p>Device info:</p>
<pre><code>root@lxcdesktop:~# ls /dev/bus/usb/001/010  -l
crw-rw-r-- 1 root root 189, 9 Feb  7 01:55 /dev/bus/usb/001/010
root@lxcdesktop:~# lsusb | grep -i cam
Bus 001 Device 010: ID 1bcf:2284 Sunplus Innovation Technology Inc. Full HD webcam
</code></pre>
<p>Undefine all of the lxc instance:</p>
<pre><code>root@lxcdesktop:~# virsh -c lxc:/// undefine deepinlxc
Domain 'deepinlxc' has been undefined

root@lxcdesktop:~# virsh -c lxc:/// undefine test
Domain 'test' has been undefined

root@lxcdesktop:~# lxc-ls
deepinlxc kylinlxc  
root@lxcdesktop:~# lxc-destroy -n deepinlxc
</code></pre>
<p>edit the common configuration(add 189 related items):</p>
<pre><code># vim /usr/share/lxc/config/common.conf
### video
lxc.cgroup.devices.allow = c 189:* rwm
lxc.cgroup.devices.allow = c 81:* rwm

### video
lxc.cgroup2.devices.allow = c 189:* rwm
lxc.cgroup2.devices.allow = c 81:* rwm
</code></pre>
<p>Edit the added.conf file(which will result in the lxc config files):</p>
<pre><code>### allow all of the usb cam
lxc.mount.entry = /dev/bus/usb/001/010 dev/bus/usb/001/010 none bind,optional,create=dir
lxc.mount.entry = /dev/video0 dev/video0 none bind,optional,create=dir
lxc.mount.entry = /dev/video1 dev/video1 none bind,optional,create=dir
</code></pre>
<p><img src="./images/20250207_161229_x.jpg" alt="./images/20250207_161229_x.jpg" /></p>
<p>In guest run <code>deepin-camera</code>.</p>
<h3 id="3-libvirt-lxc-usb-camera"><a class="header" href="#3-libvirt-lxc-usb-camera">3. libvirt-lxc usb camera</a></h3>
<p>Should use following two scripts: <code>attach_cam.sh</code> and <code>detach_cam.sh</code>:</p>
<pre><code>root@lxcdesktop:/etc/libvirt/hooks# cat attach_cam.sh 
#!/bin/sh
# attach devices to minimum xml, before the lxc instance is launched.  
# Refers to `https://github.com/olavmrk/usb-libvirt-hotplug/blob/master/usb-libvirt-hotplug.sh`
DOMAIN="$1"
COMMAND='attach-device'

echo "attach cam devices"

# video0
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/video0&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

# video1
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/video1&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

# video1
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/bus/usb/001/006&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

root@lxcdesktop:/etc/libvirt/hooks# cat detach_cam.sh 
#!/bin/sh
# attach devices to minimum xml, before the lxc instance is launched.  
# Refers to `https://github.com/olavmrk/usb-libvirt-hotplug/blob/master/usb-libvirt-hotplug.sh`
DOMAIN="$1"
COMMAND='detach-device'

echo "attach cam devices"

# video0
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/video0&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

# video1
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/video1&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 

# video1
cat &gt;/etc/10-lxc-devices.xml &lt;&lt; _EOF_
&lt;hostdev mode='capabilities' type='misc'&gt;
  &lt;source&gt;
    &lt;char&gt;/dev/bus/usb/001/006&lt;/char&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
_EOF_
virsh -c lxc:/// ${COMMAND} "${DOMAIN}" --file /etc/10-lxc-devices.xml --config 
</code></pre>
<p>Attach and detach the camera to running instance.<br />
Notice: should take effect after rebooted.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250208"><a class="header" href="#20250208">20250208</a></h1>
<h3 id="1-deepsex"><a class="header" href="#1-deepsex">1. deepsex</a></h3>
<p>Fetch the model:</p>
<pre><code>ollama run hf.co/ValueFX9507/Tifa-Deepsex-14b-CoT-GGUF-Q4
</code></pre>
<p>Run the webui:</p>
<pre><code>source ~/open-webui-venv/bin/activate
AIOHTTP_CLIENT_TIMEOUT_OPENAI_MODEL_LIST=3 open-webui serve
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250209"><a class="header" href="#20250209">20250209</a></h1>
<h3 id="1-laptop-environment"><a class="header" href="#1-laptop-environment">1. laptop environment</a></h3>
<p>Re-install hyper-v, wsl after windows upgrading.</p>
<p>Hyper-v manually installation:</p>
<pre><code>file: hyperv.cmd(run as adminstrator);    
pushd "%~dp0"
dir /b %SystemRoot%\servicing\Packages\*Hyper-V*.mum &gt;hyper-v.txt
for /f %%i in ('findstr /i . hyper-v.txt 2^&gt;nul') do dism /online /norestart /add-package:"%SystemRoot%\servicing\Packages\%%i"
del hyper-v.txt
Dism /online /enable-feature /featurename:Microsoft-Hyper-V-All /LimitAccess /ALL
</code></pre>
<p>After installation, the machine should be restarted.</p>
<h3 id="2-hyper-v-nixos-aarch64"><a class="header" href="#2-hyper-v-nixos-aarch64">2. hyper-v nixos aarch64</a></h3>
<p>Download the iso from <code>https://releases.nixos.org/nixos/24.11/nixos-24.11.714127.f5a32fa27df9/nixos-minimal-24.11.714127.f5a32fa27df9-aarch64-linux.iso</code>.</p>
<p>Issue with minimum iso:</p>
<p><img src="./images/2025_02_09_11_03_42_1239x367.jpg" alt="./images/2025_02_09_11_03_42_1239x367.jpg" /></p>
<p>Change to gnome iso which is downloaded from <code>https://releases.nixos.org/nixos/24.11/nixos-24.11.714127.f5a32fa27df9/nixos-gnome-24.11.714127.f5a32fa27df9-aarch64-linux.iso</code>:</p>
<p>parted the disk:</p>
<pre><code>parted /dev/sda -- mklabel gpt
parted /dev/sda -- mkpart ESP fat32 1MB 512MB
parted /dev/sda -- mkpart primary 512MB -2GB
parted /dev/sda -- mkpart swap linux-swap -2GB 100%
parted /dev/sda -- set 1 esp on
 
mkfs.fat -F 32 -n boot /dev/sda1
mkfs.btrfs -L NIXOS /dev/sda2
mkswap -L swap /dev/sda3
</code></pre>
<p>mount the formated disk:</p>
<pre><code>mount /dev/disk/by-label/NIXOS /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/boot /mnt/boot
swapon /dev/sda3
</code></pre>
<p>Refresh the channel:</p>
<pre><code>nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixpkgs-unstable nixpkgs
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-24.11 nixos

nix-channel --list
nix-channel --update
nixos-rebuild --option substituters https://mirrors.ustc.edu.cn/nix-channels/store switch --upgrade
</code></pre>
<p>Generate a basic configuration:</p>
<pre><code>nixos-generate-config --root /mnt
</code></pre>
<p>Edit the generated <code>configuration.nix</code> file:</p>
<pre><code>
{ config, lib, pkgs, ... }:

{
  imports =
    [ # Include the results of the hardware scan.
      ./hardware-configuration.nix
    ];

  # Use the systemd-boot EFI boot loader.
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  boot.kernelParams = [
    "quiet"
    "splash"
    "video=hyperv_fb:1920x1080"
  ];

# awesome desktop wm
    services={
        xserver = {
            enable = true;

            windowManager.awesome = {
                enable = true;
                luaModules = with pkgs.luaPackages; [
                    luarocks # is the package manager for Lua modules
                    luadbi-mysql # Database abstraction layer
                ];

            };
        };

        displayManager = {
            sddm.enable = true;
            defaultSession = "none+awesome";
        };
    };

  nix.settings.substituters = [ "https://mirrors.ustc.edu.cn/nix-channels/store" ];
  nixpkgs.config.allowUnfree = true;
  networking.hostName = "nixos"; # Define your hostname.
  time.timeZone = "Asia/Shanghai";
  virtualisation.hypervGuest = {
      enable = true;
};

  users.mutableUsers = false; # 禁止useradd添加用户
  #security.sudo.wheelNeedsPassword = false;
  users.users.dash= { #用户名是yh
      isNormalUser = true;
      hashedPassword = "xxxxxxxxxxxxxxxxx";
      extraGroups = [
        "wheel"
        "users"
      ];
    };

  environment.systemPackages = with pkgs; [
      wget
      curl
      unzip
      vim
    ];

 services.openssh.enable = true;

   services.pipewire = {
     enable = true;
     pulse.enable = true;
   };

  system.stateVersion = "24.11"; # Did you read the comment?

}

</code></pre>
<p>The hashedPassword is generated via:</p>
<pre><code>mkpasswd -m sha-512
</code></pre>
<p>With this modified configuration file, do following:</p>
<pre><code>cd /mnt
nixos-install --show-trace --option substituters https://mirror.sjtu.edu.cn/nix-channels/store

</code></pre>
<p>After installation, it will hints your with set passwd for root.</p>
<h3 id="3-default-kernel-for-nixos"><a class="header" href="#3-default-kernel-for-nixos">3. default kernel for nixos</a></h3>
<p>Get from the <code>https://github.com/NixOS/nixpkgs/blob/nixos-24.11/pkgs/top-level/linux-kernels.nix</code>, the default kernel is:</p>
<pre><code>packageAliases = {
    linux_default = packages.linux_6_6;
    # Update this when adding the newest kernel major version!
    linux_latest = packages.linux_6_13;
    linux_mptcp = throw "'linux_mptcp' has been moved to https://github.com/teto/mptcp-flake";
    linux_rt_default = packages.linux_rt_5_15;
    linux_rt_latest = packages.linux_rt_6_6;
  };

</code></pre>
<p>you could switch the kernel in configuration.nix:</p>
<pre><code>  #boot.kernelPackages = pkgs.linuxPackages_latest;

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250210"><a class="header" href="#20250210">20250210</a></h1>
<ol>
<li>upgrading ollama for using 70b</li>
<li>backup the ybd images using clonezilla(kx6780A &amp; kylinv10)</li>
<li>rtx 1660s(not good)/rtx 3050(good) vfio</li>
<li>during vfio works, solved the rtl driver issue and systemd reboot issue.</li>
</ol>
<h3 id="1-upgrade-ollama"><a class="header" href="#1-upgrade-ollama">1. upgrade ollama</a></h3>
<p>issue:</p>
<pre><code>llama_model_load: error loading model: done_getting_tensors: wrong number of tensors; expected 724, got 723
</code></pre>
<p>solved via:</p>
<pre><code>curl https://ollama.ai/install.sh | sh
</code></pre>
<p>beware of the gfw.</p>
<h3 id="2-passthrough-of-gtx1660s3050"><a class="header" href="#2-passthrough-of-gtx1660s3050">2. passthrough of gtx1660s/3050</a></h3>
<p>Notice: single gpu passthrough.</p>
<p>Bios configuration:</p>
<p><img src="./images/20250210_104524_x.jpg" alt="./images/20250210_104524_x.jpg" /></p>
<p>After reboot, only 1 card is available(no 3d controller of intel-uhd630).</p>
<pre><code>$ sudo apt update -y
$ sudo apt install -y sddm awesome
$ sudo vim /etc/sddm.conf
[General]
InputMethod=

[Autologin]
User=xxx
Session=awesome
</code></pre>
<p>This makes the host OS autologin.</p>
<p>Edit the bootloader(grub):</p>
<pre><code>$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT=" net.ifnames=0 biosdevname=0 ipv6.disable=1 intel_iommu=on intel_iommu=pt kvm.ignore_msrs=1"
$ sudo update-grub2 &amp;&amp; sudo reboot
</code></pre>
<p>After reboot, record the iommu infos:</p>
<pre><code>dash@i9server:~$ sudo ./iommu.sh 
IOMMU Group 0:
	00:00.0 Host bridge [0600]: Intel Corporation Comet Lake-S 6c Host Bridge/DRAM Controller [8086:9b33] (rev 05)
IOMMU Group 1:
	00:01.0 PCI bridge [0604]: Intel Corporation 6th-10th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 05)
	01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU116 [GeForce GTX 1660 SUPER] [10de:21c4] (rev a1)
	01:00.1 Audio device [0403]: NVIDIA Corporation TU116 High Definition Audio Controller [10de:1aeb] (rev a1)
	01:00.2 USB controller [0c03]: NVIDIA Corporation TU116 USB 3.1 Host Controller [10de:1aec] (rev a1)
	01:00.3 Serial bus controller [0c80]: NVIDIA Corporation TU116 USB Type-C UCSI Controller [10de:1aed] (rev a1)
IOMMU Group 10:
	00:1f.0 ISA bridge [0601]: Intel Corporation B460 Chipset LPC/eSPI Controller [8086:a3c8]
	00:1f.2 Memory controller [0580]: Intel Corporation Memory controller [8086:a3a1]
	00:1f.3 Audio device [0403]: Intel Corporation Comet Lake PCH-V cAVS [8086:a3f0]
	00:1f.4 SMBus [0c05]: Intel Corporation Comet Lake PCH-V SMBus Host Controller [8086:a3a3]
IOMMU Group 2:
	00:04.0 Signal processing controller [1180]: Intel Corporation Xeon E3-1200 v5/E3-1500 v5/6th Gen Core Processor Thermal Subsystem [8086:1903] (rev 05)
IOMMU Group 3:
	00:08.0 System peripheral [0880]: Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th/8th Gen Core Processor Gaussian Mixture Model [8086:1911]
IOMMU Group 4:
	00:14.0 USB controller [0c03]: Intel Corporation Comet Lake PCH-V USB Controller [8086:a3af]
	00:14.2 Signal processing controller [1180]: Intel Corporation Comet Lake PCH-V Thermal Subsystem [8086:a3b1]
IOMMU Group 5:
	00:15.0 Signal processing controller [1180]: Intel Corporation Device [8086:a3e0]
	00:15.1 Signal processing controller [1180]: Intel Corporation Device [8086:a3e1]
IOMMU Group 6:
	00:16.0 Communication controller [0780]: Intel Corporation Comet Lake PCH-V HECI Controller [8086:a3ba]
IOMMU Group 7:
	00:17.0 SATA controller [0106]: Intel Corporation 400 Series Chipset Family SATA AHCI Controller [8086:a382]
IOMMU Group 8:
	00:1b.0 PCI bridge [0604]: Intel Corporation Comet Lake PCI Express Root Port #21 [8086:a3eb] (rev f0)
	02:00.0 Non-Volatile memory controller [0108]: SK hynix Device [1c5c:1639]
IOMMU Group 9:
	00:1c.0 PCI bridge [0604]: Intel Corporation Comet Lake PCI Express Root Port #05 [8086:a394] (rev f0)
	00:1c.6 PCI bridge [0604]: Intel Corporation Device [8086:a396] (rev f0)
	03:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller [10ec:8168] (rev 15)
	04:00.0 Network controller [0280]: Realtek Semiconductor Co., Ltd. RTL8822CE 802.11ac PCIe Wireless Network Adapter [10ec:c822]
dash@i9server:~$ cat iommu.sh 
#!/bin/bash
shopt -s nullglob
for g in /sys/kernel/iommu_groups/*; do
    echo "IOMMU Group ${g##*/}:"
    for d in $g/devices/*; do
        echo -e "\t$(lspci -nns ${d##*/})"
    done;
done;
</code></pre>
<p>the passthrough iommu infos:</p>
<pre><code>IOMMU Group 1:
	00:01.0 PCI bridge [0604]: Intel Corporation 6th-10th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 05)
	01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU116 [GeForce GTX 1660 SUPER] [10de:21c4] (rev a1)
	01:00.1 Audio device [0403]: NVIDIA Corporation TU116 High Definition Audio Controller [10de:1aeb] (rev a1)
	01:00.2 USB controller [0c03]: NVIDIA Corporation TU116 USB 3.1 Host Controller [10de:1aec] (rev a1)
	01:00.3 Serial bus controller [0c80]: NVIDIA Corporation TU116 USB Type-C UCSI Controller [10de:1aed] (rev a1)

</code></pre>
<p>Host kernel Changes:</p>
<pre><code>dash@i9server:~$ sudo lspci | grep -i nvidia
01:00.0 VGA compatible controller: NVIDIA Corporation TU116 [GeForce GTX 1660 SUPER] (rev a1)
01:00.1 Audio device: NVIDIA Corporation TU116 High Definition Audio Controller (rev a1)
01:00.2 USB controller: NVIDIA Corporation TU116 USB 3.1 Host Controller (rev a1)
01:00.3 Serial bus controller: NVIDIA Corporation TU116 USB Type-C UCSI Controller (rev a1)
dash@i9server:~$ sudo lspci -vvnn -s 01:00.0 | grep 'Kernel driver'
	Kernel driver in use: nouveau
$ sudo ubuntu-drivers autoinstall &amp;&amp; sudo reboot
</code></pre>
<p>After reboot:</p>
<pre><code>root@i9server:~# nvidia-smi 
Mon Feb 10 03:31:38 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 550.120                Driver Version: 550.120        CUDA Version: 12.4     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA GeForce GTX 1660 ...    Off |   00000000:01:00.0  On |                  N/A |
| 25%   38C    P8              5W /  125W |      32MiB /   6144MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|    0   N/A  N/A      1412      G   /usr/lib/xorg/Xorg                             29MiB |
+-----------------------------------------------------------------------------------------+
root@i9server:~# uname -a
Linux i9server 6.8.0-52-generic #53~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Jan 15 19:18:46 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
root@i9server:~# lspci -vvnn -s 01:00.0 | grep -i 'Kernel driver in use'
	Kernel driver in use: nvidia
</code></pre>
<p>Prepare the qcow2 file:</p>
<pre><code>root@i9server:/var/lib/libvirt/trueimages# qemu-img create -f qcow2 -b /var/lib/libvirt/images/little_win10.qcow2 -F qcow2 win10.qcow2
</code></pre>
<p><img src="./images/20250210_113534_x.jpg" alt="./images/20250210_113534_x.jpg" /></p>
<p>Uefi:</p>
<p><img src="./images/20250210_113606_x.jpg" alt="./images/20250210_113606_x.jpg" /></p>
<p>Examine the image via following configration, in guest open rdp support:</p>
<p><img src="./images/20250210_113936_x.jpg" alt="./images/20250210_113936_x.jpg" /></p>
<p>unzip the nvflash:</p>
<pre><code>root@i9server:~/nv# unzip ../nvflash_5.833_linux.zip 
Archive:  ../nvflash_5.833_linux.zip
  inflating: nvflash 
# chmod 777 *
</code></pre>
<p>stop the wm and remove all of the nvidia kernel modules:</p>
<pre><code>root@i9server:~/nv# systemctl stop sddm
root@i9server:~/nv# rmmod nvidia_uvm
root@i9server:~/nv# rmmod nvidia_drm
root@i9server:~/nv# rmmod nvidia_modeset
root@i9server:~/nv# rmmod nvidia
root@i9server:~/nv# lsmod | grep -i nvidia
</code></pre>
<p>Do following commands:</p>
<pre><code># vim /etc/modprobe.d/blacklist.conf
...
blacklist nvidia
blacklist nvidia_uvm
blacklist nvidia_drm
blacklist nvidia_modeset
# systemctl disable sddm &amp;&amp; update-initramfs -u -k all &amp;&amp; reboot
</code></pre>
<p>After reboot, you could get the vbios:</p>
<pre><code>root@i9server:~/nv# !562
./nvflash --save vbios.rom
NVIDIA Firmware Update Utility (Version 5.833.0)
Copyright (C) 1993-2023, NVIDIA Corporation. All rights reserved.

Reading EEPROM (this operation may take up to 30 seconds)

Build GUID            : 0F08611866994AA3AE3C9DDECB2F1133  
Build Number          : 27860314
IFR Subsystem ID      : 1462-3797
Subsystem Vendor ID   : 0x1462
Subsystem ID          : 0x3797
Version               : 90.16.4D.00.44
Image Hash            : 7CBA24A9C1C226BF5639D038B066AF37
Hierarchy ID          : Normal Board
Build Date            : 01/10/20
Modification Date     : 03/11/20
UEFI Version          : 0x50014 ( x64 )
UEFI Variant ID       : 0x0000000000000009 ( TU1xx )
UEFI Signer(s)        : Microsoft Corporation UEFI CA 2011
XUSB-FW Version ID    : 0x71030001
XUSB-FW Build Time    : 2019-05-16 18:12:54
InfoROM Version       : G001.0000.02.04
InfoROM Backup        : Present
License Placeholder   : Present
GPU Mode              : N/A
CEC OTA-signed Blob   : Not Present

Reading EEPROM (this operation may take up to 30 seconds)

root@i9server:~/nv# ls                                    
nvflash  vbios.rom
root@i9server:~/nv# ls -l -h vbios.rom 
-rw-r--r-- 1 root root 1023K Feb 10 03:58 vbios.rom
</code></pre>
<p>Using okteta for patching the vbios :</p>
<p><img src="./images/20250210_120426_x.jpg" alt="./images/20250210_120426_x.jpg" /></p>
<p>Install driver under qxl display:</p>
<p><img src="./images/20250210_143910_x.jpg" alt="./images/20250210_143910_x.jpg" /></p>
<p><img src="./images/20250210_144025_x.jpg" alt="./images/20250210_144025_x.jpg" /></p>
<p><img src="./images/20250210_144328_x.jpg" alt="./images/20250210_144328_x.jpg" /></p>
<p><img src="./images/20250210_144356_x.jpg" alt="./images/20250210_144356_x.jpg" /></p>
<p><img src="./images/20250210_144434_x.jpg" alt="./images/20250210_144434_x.jpg" /></p>
<p>BIOS configuration, stop csm:</p>
<p><img src="./images/20250210_150146_x.jpg" alt="./images/20250210_150146_x.jpg" /></p>
<p>GTX1660 failed to show gop animation, while 3050 will work normaly.</p>
<p>Both card could be working.</p>
<h3 id="3-r8168-driver-issue"><a class="header" href="#3-r8168-driver-issue">3. r8168 driver issue</a></h3>
<p>Solved via:</p>
<pre><code># apt install -y linux-headers-6.8.0-52-generic dkms
# tar xjvf r8168-8.055.00.tar.bz2 
# cd r8168-8.055.00/src
# mkdir /usr/src/r8168-8.055.00
# cp -v * /usr/src/r8168-8.055.00/
# vim /usr/src/r8168-8.055.00/dkms.conf

PACKAGE_NAME="r8168"
PACKAGE_VERSION="8.055.00"
BUILT_MODULE_NAME[0]="$PACKAGE_NAME"
DEST_MODULE_LOCATION[0]="/updates/dkms"
AUTOINSTALL="YES"
REMAKE_INITRD="YES"

# dkms add r8168/8.055.00
# dkms build r8168/8.055.00 -k 6.8.0-52-generic
# dkms install r8168/8.055.00 -k 6.8.0-52-generic
# dkms status
r8168/8.055.00, 6.8.0-52-generic, x86_64: installed
</code></pre>
<h3 id="4-systemd-reboot-hang"><a class="header" href="#4-systemd-reboot-hang">4. systemd reboot hang</a></h3>
<p>Solved via:</p>
<pre><code># vim /etc/systemd/system.conf
...
[Manager]
...
DefaultTimeoutStopSec=10s
...
# systemctl daemon-reload
</code></pre>
<h3 id="5-workable-win10-xml3050"><a class="header" href="#5-workable-win10-xml3050">5. workable win10 xml(3050)</a></h3>
<p>Video link:  <code>https://www.youtube.com/watch?v=MYj8YyW1D0M</code></p>
<p><a href="https://www.youtube.com/watch?v=MYj8YyW1D0M">https://www.youtube.com/watch?v=MYj8YyW1D0M</a></p>
<p>Following is the win10 xml.</p>
<pre><code>&lt;domain type='kvm' id='2'&gt;
  &lt;name&gt;win10&lt;/name&gt;
  &lt;uuid&gt;02581d87-979e-443e-840c-8af7202d6c18&lt;/uuid&gt;
  &lt;metadata&gt;
    &lt;libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0"&gt;
      &lt;libosinfo:os id="http://microsoft.com/win/10"/&gt;
    &lt;/libosinfo:libosinfo&gt;
  &lt;/metadata&gt;
  &lt;memory unit='KiB'&gt;8388608&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;8388608&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;8&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc-q35-6.2'&gt;hvm&lt;/type&gt;
    &lt;loader readonly='yes' type='pflash'&gt;/usr/share/OVMF/OVMF_CODE_4M.ms.fd&lt;/loader&gt;
    &lt;nvram template='/usr/share/OVMF/OVMF_VARS_4M.ms.fd'&gt;/var/lib/libvirt/qemu/nvram/win10_VARS.fd&lt;/nvram&gt;
    &lt;boot dev='hd'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;hyperv mode='custom'&gt;
      &lt;relaxed state='on'/&gt;
      &lt;vapic state='on'/&gt;
      &lt;spinlocks state='on' retries='8191'/&gt;
      &lt;vendor_id state='on' value='123456789123'/&gt;
    &lt;/hyperv&gt;
    &lt;kvm&gt;
      &lt;hidden state='on'/&gt;
    &lt;/kvm&gt;
    &lt;vmport state='off'/&gt;
    &lt;smm state='on'/&gt;
    &lt;ioapic driver='kvm'/&gt;
  &lt;/features&gt;
  &lt;cpu mode='host-passthrough' check='none' migratable='on'&gt;
    &lt;topology sockets='1' dies='1' cores='4' threads='2'/&gt;
  &lt;/cpu&gt;
  &lt;clock offset='localtime'&gt;
    &lt;timer name='rtc' tickpolicy='catchup'/&gt;
    &lt;timer name='pit' tickpolicy='delay'/&gt;
    &lt;timer name='hpet' present='no'/&gt;
    &lt;timer name='hypervclock' present='yes'/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled='no'/&gt;
    &lt;suspend-to-disk enabled='no'/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2'/&gt;
      &lt;source file='/var/lib/libvirt/trueimages/win10.qcow2' index='1'/&gt;
      &lt;backingStore type='file' index='2'&gt;
        &lt;format type='qcow2'/&gt;
        &lt;source file='/var/lib/libvirt/images/little_win10.qcow2'/&gt;
        &lt;backingStore/&gt;
      &lt;/backingStore&gt;
      &lt;target dev='sda' bus='sata'/&gt;
      &lt;alias name='sata0-0-0'/&gt;
      &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;
    &lt;/disk&gt;
    &lt;controller type='usb' index='0' model='qemu-xhci' ports='15'&gt;
      &lt;alias name='usb'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pcie-root'&gt;
      &lt;alias name='pcie.0'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='1' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='1' port='0x10'/&gt;
      &lt;alias name='pci.1'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='2' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='2' port='0x11'/&gt;
      &lt;alias name='pci.2'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='3' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='3' port='0x12'/&gt;
      &lt;alias name='pci.3'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='4' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='4' port='0x13'/&gt;
      &lt;alias name='pci.4'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='5' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='5' port='0x14'/&gt;
      &lt;alias name='pci.5'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x4'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='6' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='6' port='0x15'/&gt;
      &lt;alias name='pci.6'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x5'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='7' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='7' port='0x16'/&gt;
      &lt;alias name='pci.7'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x6'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='8' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='8' port='0x17'/&gt;
      &lt;alias name='pci.8'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x7'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='9' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='9' port='0x18'/&gt;
      &lt;alias name='pci.9'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0' multifunction='on'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='10' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='10' port='0x19'/&gt;
      &lt;alias name='pci.10'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x1'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='11' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='11' port='0x1a'/&gt;
      &lt;alias name='pci.11'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='12' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='12' port='0x1b'/&gt;
      &lt;alias name='pci.12'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x3'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='13' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='13' port='0x1c'/&gt;
      &lt;alias name='pci.13'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x4'/&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='14' model='pcie-root-port'&gt;
      &lt;model name='pcie-root-port'/&gt;
      &lt;target chassis='14' port='0x1d'/&gt;
      &lt;alias name='pci.14'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x5'/&gt;
    &lt;/controller&gt;
    &lt;controller type='sata' index='0'&gt;
      &lt;alias name='ide'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/&gt;
    &lt;/controller&gt;
    &lt;controller type='virtio-serial' index='0'&gt;
      &lt;alias name='virtio-serial0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/&gt;
    &lt;/controller&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:54:00:e7:c3:8b'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;target dev='vnet1'/&gt;
      &lt;model type='e1000e'/&gt;
      &lt;alias name='net0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;serial type='pty'&gt;
      &lt;source path='/dev/pts/1'/&gt;
      &lt;target type='isa-serial' port='0'&gt;
        &lt;model name='isa-serial'/&gt;
      &lt;/target&gt;
      &lt;alias name='serial0'/&gt;
    &lt;/serial&gt;
    &lt;console type='pty' tty='/dev/pts/1'&gt;
      &lt;source path='/dev/pts/1'/&gt;
      &lt;target type='serial' port='0'/&gt;
      &lt;alias name='serial0'/&gt;
    &lt;/console&gt;
    &lt;channel type='spicevmc'&gt;
      &lt;target type='virtio' name='com.redhat.spice.0' state='disconnected'/&gt;
      &lt;alias name='channel0'/&gt;
      &lt;address type='virtio-serial' controller='0' bus='0' port='1'/&gt;
    &lt;/channel&gt;
    &lt;input type='tablet' bus='usb'&gt;
      &lt;alias name='input0'/&gt;
      &lt;address type='usb' bus='0' port='1'/&gt;
    &lt;/input&gt;
    &lt;input type='mouse' bus='ps2'&gt;
      &lt;alias name='input1'/&gt;
    &lt;/input&gt;
    &lt;input type='keyboard' bus='ps2'&gt;
      &lt;alias name='input2'/&gt;
    &lt;/input&gt;
    &lt;sound model='ich9'&gt;
      &lt;alias name='sound0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x1b' function='0x0'/&gt;
    &lt;/sound&gt;
    &lt;audio id='1' type='none'/&gt;
    &lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
      &lt;driver name='vfio'/&gt;
      &lt;source&gt;
        &lt;address domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
      &lt;/source&gt;
      &lt;alias name='hostdev0'/&gt;
      &lt;rom file='/usr/share/vgabios/GA106.rom'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
      &lt;driver name='vfio'/&gt;
      &lt;source&gt;
        &lt;address domain='0x0000' bus='0x01' slot='0x00' function='0x1'/&gt;
      &lt;/source&gt;
      &lt;alias name='hostdev1'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x06' slot='0x00' function='0x0'/&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='subsystem' type='usb' managed='yes'&gt;
      &lt;source&gt;
        &lt;vendor id='0x30fa'/&gt;
        &lt;product id='0x0300'/&gt;
        &lt;address bus='1' device='4'/&gt;
      &lt;/source&gt;
      &lt;alias name='hostdev2'/&gt;
      &lt;address type='usb' bus='0' port='4'/&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='subsystem' type='usb' managed='yes'&gt;
      &lt;source&gt;
        &lt;vendor id='0x1a2c'/&gt;
        &lt;product id='0x0e24'/&gt;
        &lt;address bus='1' device='3'/&gt;
      &lt;/source&gt;
      &lt;alias name='hostdev3'/&gt;
      &lt;address type='usb' bus='0' port='5'/&gt;
    &lt;/hostdev&gt;
    &lt;redirdev bus='usb' type='spicevmc'&gt;
      &lt;alias name='redir0'/&gt;
      &lt;address type='usb' bus='0' port='2'/&gt;
    &lt;/redirdev&gt;
    &lt;redirdev bus='usb' type='spicevmc'&gt;
      &lt;alias name='redir1'/&gt;
      &lt;address type='usb' bus='0' port='3'/&gt;
    &lt;/redirdev&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;alias name='balloon0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
  &lt;seclabel type='dynamic' model='dac' relabel='yes'&gt;
    &lt;label&gt;+64055:+108&lt;/label&gt;
    &lt;imagelabel&gt;+64055:+108&lt;/imagelabel&gt;
  &lt;/seclabel&gt;
&lt;/domain&gt;
</code></pre>
<h3 id="6-quicksetup-lxcdesktop"><a class="header" href="#6-quicksetup-lxcdesktop">6. quicksetup-lxcdesktop</a></h3>
<h3 id="61-host-setup"><a class="header" href="#61-host-setup">6.1 host setup</a></h3>
<p>host setup Steps:</p>
<pre><code>Change repository
# apt update
# apt install -y vim
# vim /etc/lightdm/lightdm.conf
autologin-user=test
autologin-user-timeout=0
#autologin-in-background=false
autologin-session=mate
# apt upgrade -y &amp;&amp; apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
# vim /etc/subuid /etc/subgid(both are the same)
test:100000:65536
root:100000:65536
# apt install -y xserver-xorg-video-amdgpu firmware-amd-graphics libdrm-amdgpu1 firmware-linux firmware-linux-nonfree
# reboot
</code></pre>
<p>Check the graphical info:</p>
<pre><code>root@debian:~# lspci -vvnn -s 06:00.0 | grep -i 'kernel driver'
	Kernel driver in use: amdgpu
root@debian:~# lspci -nn | grep -i vga
06:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Lexa PRO [Radeon 540/540X/550/550X / RX 540X/550/550X] [1002:699f] (rev c7)
</code></pre>
<p>Check the audio info:</p>
<pre><code>test@debian:~$ export DISPLAY=:0
test@debian:~$ pactl list sinks short
0	alsa_output.pci-0000_06_00.1.hdmi-stereo-extra3	module-alsa-card.c	s16le 2ch 44100Hz	SUSPENDED
1	alsa_output.usb-Hifi_384Khz_Type-C_Audio_Audio_fs_2.0_2021-11-11-0000-0000-0000-00.analog-stereo	module-alsa-card.c	s16le 2ch 48000Hz	RUNNING

</code></pre>
<p>edit the lxc default :</p>
<pre><code># vim /etc/lxc/default.conf
lxc.apparmor.profile = unconfined

</code></pre>
<p>disable and totally remove apparmor:</p>
<pre><code># systemctl disable apparmor
# apt remove --assume-yes --purge apparmor
</code></pre>
<p>common configuration files:</p>
<pre><code>cp /usr/share/lxc/config/common.conf /usr/share/lxc/config/common.conf.back
Copy the template common.conf from my github.
</code></pre>
<h3 id="62-deepin-lxc"><a class="header" href="#62-deepin-lxc">6.2 deepin lxc</a></h3>
<p>Quickly launch:</p>
<pre><code># lxc-create -t local -n deepinlxc -- -m  /root/meta.tar.xz -f /root/deepinlxc.tar.xz &amp;&amp; cat added.conf &gt;&gt; /var/lib/lxc/deepinlxc/config  &amp;&amp; mkdir -p /var/lib/lxc/deepinlxc/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/deepinlxc/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/deepinlxc/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/deepinlxc/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/deepinlxc/rootfs/etc/systemd/system/lightdm.service.d
# vim /var/lib/lxc/deepinlxc/rootfs/etc/lightdm/lightdm.conf
minimum-vt=8
# cp /root/wind.mp4 /var/lib/lxc/deepinlxc/rootfs/home/test/Desktop/
# lxc-start -n deepinlxc -F
</code></pre>
<p>Sound:</p>
<pre><code>root@debian:~# lxc-attach -n deepinlxc
root@deepin:~# su test
test@deepin:/root$ vim ~/.config/autostart/pactl.desktop
test@deepin:/root$ sudo reboot
</code></pre>
<p>Now it will be OK.</p>
<h3 id="62-zkfd-lxc"><a class="header" href="#62-zkfd-lxc">6.2. zkfd lxc</a></h3>
<p>Create:</p>
<pre><code>lxc-create -t local -n zkfdlxc -- -m /root/meta.tar.xz -f /root/zkfdlxc.tar.xz
mv /var/lib/lxc/zkfdlxc/rootfs/etc/acpi /var/lib/lxc/zkfdlxc/rootfs/etc/acpi.bak
cat added.conf &gt;&gt; /var/lib/lxc/zkfdlxc/config  &amp;&amp; mkdir -p /var/lib/lxc/zkfdlxc/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/zkfdlxc/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/zkfdlxc/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/zkfdlxc/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/zkfdlxc/rootfs/etc/systemd/system/lightdm.service.d
# vim /var/lib/lxc/zkfdlxc/rootfs/etc/lightdm/lightdm.conf
minimum-vt=8
</code></pre>
<p>Change the user's passwd(30 days):</p>
<pre><code>root@debian:~# lxc-attach -n zkfdlxc
root@zkfdlxc:~# passwd test
New password: 
Retype new password: 
passwd: password updated successfully
root@zkfdlxc:~# reboot
</code></pre>
<p>Test the audio:</p>
<pre><code>cp wind.mp4 /var/lib/lxc/zkfdlxc/rootfs/home/tes桌面/
sudo dhclient eth0
sudo apt install -y smplayer
mkdir -p ~/.config/autostart
vim ~/.config/autostart/pactl.desktop
</code></pre>
<p>Change the sound:</p>
<p><img src="./images/20250210_174218_x.jpg" alt="./images/20250210_174218_x.jpg" /></p>
<h3 id="63-uoslxckodi-modifed"><a class="header" href="#63-uoslxckodi-modifed">6.3 uoslxc(kodi modifed)</a></h3>
<p>Create via:</p>
<pre><code>lxc-create -t local -n uoslxc -- -m /root/meta.tar.xz -f /root/uoslxc.tar.xz
cat added.conf &gt;&gt; /var/lib/lxc/uoslxc/config  &amp;&amp; mkdir -p /var/lib/lxc/uoslxc/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/uoslxc/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/uoslxc/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/uoslxc/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/uoslxc/rootfs/etc/systemd/system/lightdm.service.d

</code></pre>
<p><img src="./images/20250210_174735_x.jpg" alt="./images/20250210_174735_x.jpg" /></p>
<p>Since this image is only for testing kodi, ignore it.</p>
<h3 id="64-uoslxcdesktop"><a class="header" href="#64-uoslxcdesktop">6.4 uoslxcdesktop</a></h3>
<p>Create via:</p>
<pre><code># lxc-create -t local -n uoslxcdesktop -- -m /root/meta.tar.xz -f uoslxcdesktop.tar.xz
# cat added.conf &gt;&gt; /var/lib/lxc/uoslxcdesktop/config  &amp;&amp; mkdir -p /var/lib/lxc/uoslxcdesktop/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/uoslxcdesktop/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/uoslxcdesktop/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/uoslxcdesktop/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/uoslxcdesktop/rootfs/etc/systemd/system/lightdm.service.d

# vim /var/lib/lxc/uoslxcdesktop/rootfs/etc/lightdm/lightdm.conf
minimum-vt=8

</code></pre>
<p>Directly copy from other lxc:</p>
<pre><code>root@debian:/var/lib/lxc/uoslxcdesktop/rootfs/home/test/.config/autostart# cp /var/lib/lxc/deepinlxc/rootfs/home/test/.config/autostart/pactl.desktop .
root@debian:/var/lib/lxc/uoslxcdesktop/rootfs/home/test/.config/autostart# pwd
/var/lib/lxc/uoslxcdesktop/rootfs/home/test/.config/autostart
</code></pre>
<p>Comment the <code>/etc/fstab</code> in container:</p>
<pre><code>root@uoslxc:~# cat /etc/fstab 
# /dev/vda2
#UUID=4edf73b8-87f7-4ba1-99a4-e3306afade89	/         	ext4      	rw,relatime	0 1

# /dev/vda1
#UUID=20720be2-6c80-4e1f-ab73-ab0da9714e99	/boot     	ext4      	rw,relatime	0 2
</code></pre>
<p>Start via <code>lxc-start -n uoslxcdesktop -F</code>:</p>
<p><img src="./images/20250210_175500_x.jpg" alt="./images/20250210_175500_x.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250211"><a class="header" href="#20250211">20250211</a></h1>
<p>Mainly working on arm64 lxc desktop .</p>
<p>arm workable items:</p>
<pre><code># ls arm64_workable_20250211/
added.conf  kylinpulse.tar.xz  preX-populate-input.sh  zkfdpulse.tar.xz
kkk.sh      override.conf      uoslxc.tar.xz
root@lxchost:~# scp -r arm64_workable_20250211/ dash@192.168.1.7:/media/big/
</code></pre>
<h3 id="1-lxckylinlxc"><a class="header" href="#1-lxckylinlxc">1. lxc(kylinlxc)</a></h3>
<p>Create via:</p>
<pre><code>lxc-create -t local -n kylinlxc -- -m  /root/meta.tar.xz -f /root/kylinlxc.tar.xz
cat added.conf &gt;&gt; /var/lib/lxc/kylinlxc/config  &amp;&amp; mkdir -p /var/lib/lxc/kylinlxc/rootfs/usr/local/bin/ &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/kylinlxc/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/kylinlxc/rootfs/etc/X11/xorg.conf.d/ &amp;&amp;  mkdir -p /var/lib/lxc/kylinlxc/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf  /var/lib/lxc/kylinlxc/rootfs/etc/systemd/system/lightdm.service.d
vim /var/lib/lxc/kylinlxc/rootfs/etc/lightdm/lightdm.conf
    Added:  
    [LightDM]
    minimum-vt=8
mkdir -p /var/lib/lxc/kylinlxc/rootfs/home/test/.config/autostart/
cp /var/lib/lxc/uoslxcdesktop/rootfs/home/test/.config/autostart/pactl.desktop /var/lib/lxc/kylinlxc/rootfs/home/test/.config/autostart/
chmod 777 -R /var/lib/lxc/kylinlxc/rootfs/home/test/.config/autostart/
lxc-start -n kylinlxc -F
cp wind.mp4 /var/lib/lxc/kylinlxc/rootfs/home/tes桌面/
</code></pre>
<p>Everything will be ok,including video/audio..</p>
<h3 id="2-backup-release"><a class="header" href="#2-backup-release">2. Backup Release</a></h3>
<p>Backup release for x86 lxc:</p>
<pre><code>root@debian:~# ls
added.conf        kk.sh   kylinlxc.tar.xz  override.conf           uoslxc.tar.xz         wind.mp4
deepinlxc.tar.xz  kkk.sh  meta.tar.xz      preX-populate-input.sh  uoslxcdesktop.tar.xz  zkfdlxc.tar.xz
root@debian:~# mkdir x86_lxc_20250211
root@debian:~# mv * x86_lxc_20250211/
root@debian:~# scp -r x86_lxc_20250211/ dash@192.168.1.7:/media/big/
</code></pre>
<h3 id="3-arm64-lxchost"><a class="header" href="#3-arm64-lxchost">3. arm64 lxchost</a></h3>
<p>OS Installation:</p>
<p><img src="./images/20250211_093409_x.jpg" alt="./images/20250211_093409_x.jpg" /></p>
<p><img src="./images/20250211_093420_x.jpg" alt="./images/20250211_093420_x.jpg" /></p>
<p><img src="./images/20250211_093430_x.jpg" alt="./images/20250211_093430_x.jpg" /></p>
<p>Install the system via livecd.</p>
<p>Partition:</p>
<p><img src="./images/20250211_093828_x.jpg" alt="./images/20250211_093828_x.jpg" /></p>
<p><img src="./images/20250211_094249_x.jpg" alt="./images/20250211_094249_x.jpg" /></p>
<p>passwd-less login:</p>
<p><img src="./images/20250211_094741_x.jpg" alt="./images/20250211_094741_x.jpg" /></p>
<p>Never lock screen:</p>
<p><img src="./images/20250211_094822_x.jpg" alt="./images/20250211_094822_x.jpg" /></p>
<p><img src="./images/20250211_094835_x.jpg" alt="./images/20250211_094835_x.jpg" /></p>
<p><img src="./images/20250211_094955_x.jpg" alt="./images/20250211_094955_x.jpg" /></p>
<p>audio problem(use usb audio for output):</p>
<p><img src="./images/20250211_100209_x.jpg" alt="./images/20250211_100209_x.jpg" /></p>
<p>Install packages:</p>
<pre><code>sudo apt update -y &amp;&amp; sudo apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
sudo reboot
sudo systemctl enable ssh &amp;&amp; sudo systemctl start ssh
sudo ufw disable
$ cat /etc/subuid /etc/subgid
test:100000:65536
root:100000:65536
test:100000:65536
root:100000:65536
# systemctl disable apparmor
# apt remove --assume-yes --purge apparmor
# vim /etc/lxc/default.conf
lxc.apparmor.profile = unconfined
</code></pre>
<p>Edit the config file then save:</p>
<pre><code>test@lxchost:~$ sudo vim /usr/share/lxc/config/common.conf
test@lxchost:~$ scp -P21322 /usr/share/lxc/config/common.conf dash@yqnyjy.ddns.net:~/common.conf.zkfdarm64
</code></pre>
<p>Copy all of the lxcarm images to root directory:</p>
<pre><code>$ ls
all.txt      kylinv10arm.tar.xz  uoslxc.tar.xz
history.txt  meta.tar.xz         zkfdlxc.tar.xz
$ sudo cp *.tar.xz /root/
$ cd /root, copy the sh files and conf files from my git repo
added.conf  kkk.sh  override.conf  preX-populate-input.sh

</code></pre>
<p>add crontab:</p>
<pre><code>@reboot chmod 777 /dev/tty* &amp;&amp; chmod 777 /dev/fb* &amp;&amp; chmod 777 -R /dev/dri/* &amp;&amp; chmod 777 -R /dev/snd/* &amp;&amp; chmod 777 -R /dev/input/*
</code></pre>
<h3 id="4-kylinlxc"><a class="header" href="#4-kylinlxc">4. kylinlxc</a></h3>
<p>Include making images and run.</p>
<p>In vm:</p>
<pre><code>sudo apt udpate -y &amp;&amp; sudo apt install -y openssh-server
</code></pre>
<p><img src="./images/20250211_154244_x.jpg" alt="./images/20250211_154244_x.jpg" /></p>
<p><img src="./images/20250211_154307_x.jpg" alt="./images/20250211_154307_x.jpg" /></p>
<p><img src="./images/20250211_154320_x.jpg" alt="./images/20250211_154320_x.jpg" /></p>
<p><img src="./images/20250211_154408_x.jpg" alt="./images/20250211_154408_x.jpg" /></p>
<p><img src="./images/20250211_154424_x.jpg" alt="./images/20250211_154424_x.jpg" /></p>
<p>security related:</p>
<pre><code>$ setstatus disable -p
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=0 net.ifnames=0 biosdevname=0"
GRUB_CMDLINE_LINUX_SECURITY=""
$ sudo update-grub2
$ sudo apt install -y smplayer glmark2
$ sudo reboot
$ sudo shutdown -h now
</code></pre>
<p>Extract the files:</p>
<pre><code>cp kylinraw.img kylinraw.img.def_pulseaudio
losetup -f -P kylinraw.img.def_pulseaudio
# mount /dev/loop1p2 /mnt-resource/
# mount /dev/loop1p1 /mnt-resource/boot/efi/
# df -h
...
/dev/loop1p2     30G  9.4G   19G   34% /mnt-resource
/dev/loop1p1    253M   18M  235M    7% /mnt-resource/boot/efi
# mkdir /root/kl
# rsync -av /mnt-resource/* /root/kl/
# cd /root/kl
# vim etc/fstab
# rm -rf dev/*
# vim etc/lightdm/lightdm.conf
[LightDM]
minimum-vt=8
......

</code></pre>
<p>Should use system level pulseaudio, (optional systemd pulseaudio):</p>
<pre><code>test@kylin:~$ sudo vim /etc/pulse/client.conf
autospawn = no
test@kylin:~$ systemctl --user disable pulseaudio.service pulseaudio.socket
test@kylin:~$ sudo systemctl --global disable pulseaudio.service pulseaudio.socket
test@kylin:~$ sudo mv /lib/systemd/user/pulseaudio.s* .
test@kylin:~$ sudo mv /etc/xdg/autostart/pulseaudio.desktop  .
test@kylin:~$ sudo usermod -aG pulse-access root
test@kylin:~$ sudo usermod -aG pulse-access test
test@kylin:~$ sudo usermod -aG pulse test
test@kylin:~$ sudo usermod -aG audio test
test@kylin:~$ sudo vim /etc/systemd/system/pulseaudio.service

test@kylin:~$ sudo systemctl enable pulseaudio
Created symlink /etc/systemd/system/default.target.wants/pulseaudio.service → /etc/systemd/system/pulseaudio.service.

</code></pre>
<p>The workable lxc image is <code>kylinpulse.tar.xz</code>.</p>
<pre><code>lxc-create -t local -n kylinpulse -- -m /root/meta.tar.xz -f /root/kylinpulse.tar.xz
cat added.conf &gt;&gt; /var/lib/lxc/kylinpulse/config &amp;&amp; mkdir -p /var/lib/lxc/kylinpulse/rootfs/usr/local/bin &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/kylinpulse/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/kylinpulse/rootfs/etc/X11/xorg.conf.d/ &amp;&amp; mkdir -p /var/lib/lxc/kylinpulse/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf /var/lib/lxc/kylinpulse/rootfs/etc/systemd/system/lightdm.service.d

lxc-start -n kylinpulse
</code></pre>
<h3 id="5-zkfdimagetesting"><a class="header" href="#5-zkfdimagetesting">5. zkfd(image&amp;testing)</a></h3>
<p>Edit grub:</p>
<pre><code>$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID=357de008-1923-459c-a854-c835816c8667 net.ifnames=0 biosdevname=0"
$ sudo update-grub2
$ sudo systemctl enable ssh
</code></pre>
<p>Edit system-level pulseaudio:</p>
<pre><code>sudo vim /etc/pulse/client.conf
sudo systemctl --user disable pulseaudio.service pulseaudio.socket
sudo systemctl --global disable pulseaudio.service pulseaudio.socket
sudo mv /lib/systemd/user/pulseaudio.s* .
sudo mv /etc/xdg/autostart/pulseaudio.desktop .
sudo usermod -aG pulse-access root
sudo usermod -aG pulse-access test
sudo usermod -aG audio test
systemctl --user disable pipewire.service pipewire.socket
sudo systemctl --user disable pipewire.service pipewire.socket
sudo systemctl --global disable pipewire.service pipewire.socket
sudo mv /lib/systemd/user/pipewire.s* .
sudo vim /etc/systemd/system/pulseaudio.service
sudo systemctl enable pulseaudio
</code></pre>
<p>Disable the screen-lock, firewall, selinux related items.</p>
<p>rsync the items to folder:</p>
<pre><code># vim etc/lightdm/lightdm.conf
minimum-vt=8
# vim etc/fstab
# vim etc/systemd/system/pulseaudio.service
[Unit]
Description=Sound Service
After=multi-user.target
 
[Service]
# Note that notify will only work if --daemonize=no
Type=notify
ExecStart=/usr/bin/pulseaudio --daemonize=no --exit-idle-time=-1 --disallow-exit=true --system --disallow-module-loading
Restart=always
 
[Install]
WantedBy=default.target
# rm -f home/test/.config/autostart/pactl.desktop
# tar -cpvf zkfdpulse.tar * &amp;&amp; xz -T8 zkfdpulse.tar
</code></pre>
<p>Create and test:</p>
<pre><code># lxc-create -t local -n zkfdpulse -- -m /root/meta.tar.xz -f /root/zkfdpulse.tar.xz
# cat added.conf &gt;&gt; /var/lib/lxc/zkfdpulse/config &amp;&amp; mkdir -p /var/lib/lxc/zkfdpulse/rootfs/usr/local/bin &amp;&amp; cp preX-populate-input.sh /var/lib/lxc/zkfdpulse/rootfs/usr/local/bin/ &amp;&amp; mkdir -p /var/lib/lxc/zkfdpulse/rootfs/etc/X11/xorg.conf.d/ &amp;&amp; mkdir -p /var/lib/lxc/zkfdpulse/rootfs/etc/systemd/system/lightdm.service.d &amp;&amp; cp override.conf /var/lib/lxc/zkfdpulse/rootfs/etc/systemd/system/lightdm.service.d
root@lxchost:~# lxc-start -n zkfdpulse
root@lxchost:~# cp /home/test/桌面/wind.mp4  /var/lib/lxc/zkfdpulse/rootfs/home/test/桌面/
</code></pre>
<p>video/audio both works well.</p>
<h3 id="6-deepinlxc"><a class="header" href="#6-deepinlxc">6. deepinlxc</a></h3>
<p>Install deepinlxc:</p>
<p><img src="./images/20250211_171821_x.jpg" alt="./images/20250211_171821_x.jpg" /></p>
<p><img src="./images/20250211_171901_x.jpg" alt="./images/20250211_171901_x.jpg" /></p>
<p><img src="./images/20250211_171917_x.jpg" alt="./images/20250211_171917_x.jpg" /></p>
<p><img src="./images/20250211_171939_x.jpg" alt="./images/20250211_171939_x.jpg" /></p>
<p><img src="./images/20250211_172223_x.jpg" alt="./images/20250211_172223_x.jpg" /></p>
<p><img src="./images/20250211_172257_x.jpg" alt="./images/20250211_172257_x.jpg" /></p>
<p>Configuration of guest os:</p>
<p><img src="./images/20250211_172344_x.jpg" alt="./images/20250211_172344_x.jpg" /></p>
<p><img src="./images/20250211_172423_x.jpg" alt="./images/20250211_172423_x.jpg" /></p>
<p><img src="./images/20250211_172504_x.jpg" alt="./images/20250211_172504_x.jpg" /></p>
<p>no effect for update grub:</p>
<pre><code>$ sudo apt update &amp;&amp; sudo apt install -y openssh-server &amp;&amp; sudo systemctl enable ssh
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=0 net.ifnames=0 biosdevname=0"
$ sudo update-grub2 &amp;&amp; sudo update-grub &amp;&amp; sudo reboot
</code></pre>
<p>sync the content:</p>
<pre><code># mount /dev/loop3p2 /mnt-resource/
# mount /dev/loop3p1 /mnt-resource/boot/efi/
# mkdir /root/deepinlxc
# history | grep rsync
# rsync -av /mnt-resource/* /root/deepinlxc
# cd /root/deepinlxc
# tar cpvf deepinlxc * &amp;&amp; xz -T8 deepinlxc.tar
</code></pre>
<p>Test and verification.</p>
<p>Issue(lightdm):</p>
<pre><code>             └─592 /usr/bin/fcitx5 -d

2月 12 08:53:20 deepin lightdm[445]: gkr-pam: gnome-keyring-daemon started properly and unlocked keyring
2月 12 08:53:20 deepin lightdm[445]: Failed to open CK session: GDBus.Error:org.freedesktop.DBus.Error.ServiceUnknown: The name org.freedesktop.ConsoleKit was not provided by any .service files
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activating service name='org.freedesktop.systemd1' requested by ':1.1' (uid=1000 pid=461 comm="/usr/bin/dde-session" label="kernel")
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activated service 'org.freedesktop.systemd1' failed: Process org.freedesktop.systemd1 exited with status 1
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activating service name='org.freedesktop.systemd1' requested by ':1.1' (uid=1000 pid=461 comm="/usr/bin/dde-session" label="kernel")
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activated service 'org.freedesktop.systemd1' failed: Process org.freedesktop.systemd1 exited with status 1
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activating service name='org.freedesktop.systemd1' requested by ':1.1' (uid=1000 pid=461 comm="/usr/bin/dde-session" label="kernel")
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activated service 'org.freedesktop.systemd1' failed: Process org.freedesktop.systemd1 exited with status 1
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activating service name='org.freedesktop.systemd1' requested by ':1.1' (uid=1000 pid=461 comm="/usr/bin/dde-session" label="kernel")
2月 12 08:53:21 deepin dbus-daemon[556]: [session uid=1000 pid=554] Activated service 'org.freedesktop.systemd1' failed: Process org.freedesktop.systemd1 exited with status 1
root@deepin:~# ls /var/cache/

</code></pre>
<p>Seems kernel issue.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20240212"><a class="header" href="#20240212">20240212</a></h1>
<p>3a6000:</p>
<pre><code>old world, zkfd/kylin/uos      
new world, deepin/aosc, etc   
</code></pre>
<p>aosc, used for libvirt/virt-manager, for getting the rawimg.</p>
<h3 id="1-kylin-host"><a class="header" href="#1-kylin-host">1. Kylin host</a></h3>
<p>Write iso:</p>
<pre><code>sudo dd if=/media/nfs1/Kylin-Desktop-V10-SP1-2403-Release-20240506-loongarch64.iso of=/dev/sdb bs=10M &amp;&amp; sudo sync
</code></pre>
<p>Install by default.</p>
<p><img src="./images/20250212_101541_x.jpg" alt="./images/20250212_101541_x.jpg" /></p>
<p><img src="./images/20250212_101601_x.jpg" alt="./images/20250212_101601_x.jpg" /></p>
<p><img src="./images/20250212_101614_x.jpg" alt="./images/20250212_101614_x.jpg" /></p>
<pre><code>$ sudo apt update -y &amp;&amp; sudo apt install -y openssh-server &amp;&amp; sudo systemctl enable ssh 
$ setstatus disable -p
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=0 net.ifnames=0 biosdevname=0"
GRUB_CMDLINE_LINUX_SECURITY=""
$ sudo apt install -y aptitude
$ sudo apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager smplayer lxcfs
</code></pre>
<p>lxc issue:</p>
<pre><code>$ sudo aptitude install lxc
下列“新”软件包将被安装。         
  lxc{b} 
0 个软件包被升级，新安装 1 个，0 个将被删除， 同时 69 个将不升级。
需要获取 70.0 kB 的存档。解包后将要使用 75.8 kB。
下列软件包存在未满足的依赖关系：
 lxc : 依赖: lxc-utils (&gt;= 1:4.0.2-0kylin1)是虚拟软件包，未被任何可用软件包所提供

下列动作将解决这些依赖关系：

     保持 下列软件包于其当前版本：
1)     lxc [未安装的]             



是否接受该解决方案？[Y/n/q/?] n

*** 没有更多的解决方案了 ***

下列动作将解决这些依赖关系：

     保持 下列软件包于其当前版本：
1)     lxc [未安装的]             



是否接受该解决方案？[Y/n/q/?] n

</code></pre>
<p><code>lxc-utils</code> did not exists:</p>
<pre><code>$ apt-cache policy lxc-utils
lxc-utils:
  已安装：(无)
  候选： (无)
  版本列表：

</code></pre>
<h3 id="2-uos-host"><a class="header" href="#2-uos-host">2. uos host</a></h3>
<p><img src="./images/20250212_105358_x.jpg" alt="./images/20250212_105358_x.jpg" /></p>
<p>Inject the sshkey then you could ssh login into host.</p>
<p>packages lost:</p>
<pre><code>apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer

E: 无法定位软件包 libvirt-daemon-driver-lxc
E: 无法定位软件包 virt-manager
</code></pre>
<h3 id="3-zkfd-host"><a class="header" href="#3-zkfd-host">3. zkfd host</a></h3>
<p>Install:</p>
<pre><code>$ sudo apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
正在读取软件包列表... 完成
正在分析软件包的依赖关系树... 完成
正在读取状态信息... 完成                 
E: 无法定位软件包 libvirt-daemon-driver-lxc
</code></pre>
<p>old world, could run most of the lxc instance of old world.</p>
<h3 id="4-deepin-guest"><a class="header" href="#4-deepin-guest">4. deepin guest</a></h3>
<p>Install in <code>Try </code> mode.</p>
<p><img src="./images/20250212_145447_x.jpg" alt="./images/20250212_145447_x.jpg" /></p>
<p>Install:</p>
<p><img src="./images/20250212_145505_x.jpg" alt="./images/20250212_145505_x.jpg" /></p>
<p><img src="./images/20250212_145812_x.jpg" alt="./images/20250212_145812_x.jpg" /></p>
<p><img src="./images/20250212_150333_x.jpg" alt="./images/20250212_150333_x.jpg" /></p>
<p><img src="./images/20250212_150416_x.jpg" alt="./images/20250212_150416_x.jpg" /></p>
<pre><code># lxc-create -t local -n  deepinlxc -- -m /root/meta.tar.xz -f /root/deepinlxc.tar.xz
</code></pre>
<p>When start lxc, get the following issue:</p>
<pre><code>root@zkfdhost:~# lxc-start -n deepinlxc -F
lxc-start: deepinlxc: utils.c: safe_mount: 1179 No such file or directory - Failed to mount "/dev/video0" onto "/usr/lib/loongarch64-linux-gnu/lxc/rootfs/dev/video0"
           lxc-start: deepinlxc: utils.c: safe_mount: 1179 No such file or directory - Failed to mount "/dev/video1" onto "/usr/lib/loongarch64-linux-gnu/lxc/rootfs/dev/video1"
                      systemd 255.2-4 running in system mode (+PAM +AUDIT +SELINUX +APPARMOR +IMA +SMACK -SECCOMP +GCRYPT -GNUTLS +OPENSSL +ACL +BLKID +CURL +ELFUTILS +FIDO2 +IDN2 -IDN +IPTC +KMOD +LIBCRYPTSETUP +LIBFDISK +PCRE2 -PWQUALITY +P11KIT +QRENCODE +TPM2 +BZIP2 +LZ4 +XZ +ZLIB +ZSTD -BPF_FRAMEWORK -XKBCOMMON +UTMP +SYSVINIT default-hierarchy=unified)
Detected virtualization lxc.
Detected architecture loongarch64.

Welcome to Deepin 23!

Hostname set to &lt;deepin&gt;.
Assertion 'sigaction(SIGCHLD, &amp;sa, NULL) == 0' failed at src/core/manager.c:517, function manager_setup_signals(). Aborting.

</code></pre>
<h3 id="4-loognix-guest"><a class="header" href="#4-loognix-guest">4. loognix guest</a></h3>
<p><img src="./images/20250212_145643_x.jpg" alt="./images/20250212_145643_x.jpg" /></p>
<p><img src="./images/20250212_145857_x.jpg" alt="./images/20250212_145857_x.jpg" /></p>
<p><img src="./images/20250212_145951_x.jpg" alt="./images/20250212_145951_x.jpg" /></p>
<p><img src="./images/20250212_150022_x.jpg" alt="./images/20250212_150022_x.jpg" /></p>
<p><img src="./images/20250212_150053_x.jpg" alt="./images/20250212_150053_x.jpg" /></p>
<p><img src="./images/20250212_150113_x.jpg" alt="./images/20250212_150113_x.jpg" /></p>
<p>Cannot boot to loognix vm.</p>
<p><img src="./images/20250212_153221_x.jpg" alt="./images/20250212_153221_x.jpg" /></p>
<h3 id="5-aosc-guest"><a class="header" href="#5-aosc-guest">5. aosc guest</a></h3>
<p><img src="./images/20250212_153446_x.jpg" alt="./images/20250212_153446_x.jpg" /></p>
<p><img src="./images/20250212_153506_x.jpg" alt="./images/20250212_153506_x.jpg" /></p>
<p><img src="./images/20250212_153605_x.jpg" alt="./images/20250212_153605_x.jpg" /></p>
<p><img src="./images/20250212_153618_x.jpg" alt="./images/20250212_153618_x.jpg" /></p>
<p><img src="./images/20250212_153639_x.jpg" alt="./images/20250212_153639_x.jpg" /></p>
<h3 id="6-deepin-host"><a class="header" href="#6-deepin-host">6. deepin host</a></h3>
<p>需要刷写bios固件到新世界，才可以安装deepin.</p>
<pre><code>sudo apt update -y
sudo apt install -y openssh-server
sudo systemctl enable ssh --now
sudo apt install -y iotop vim s-tui libvirt-daemon-driver-lxc  lxc lxc-templates lxcfs smplayer
sudo systemctl disable apparmor
sudo apt purge --assume-yes apparmor
</code></pre>
<p>package info:</p>
<pre><code>test@lxchost:~$ lxc-ls --version
6.0.1
test@lxchost:~$ dpkg -l | grep libvirt | grep lxc
ii  libvirt-daemon-driver-lxc                       10.7.0-3deepin1                        loong64      Virtualization daemon LXC connection driver
</code></pre>
<p>Edit the following files:</p>
<pre><code>/etc/lxc/default.conf
/usr/share/lxc/config/common.conf
</code></pre>
<h4 id="61-zkfd-guest"><a class="header" href="#61-zkfd-guest">6.1 zkfd guest</a></h4>
<p>Test via:</p>
<pre><code>lxc-create -t local -n zkfdlxc -- -m /root/meta.tar.xz -f /root/zkfd.tar.xz
....
lxc-start -n zkfdlxc
</code></pre>
<p>issue:</p>
<pre><code>root@lxchost:/var/lib/lxc# lxc-start -n zkfdlxc -F
/sbin/init: error while loading shared libraries: libc.so.6: cannot stat shared object: Error 38
</code></pre>
<h4 id="62-deepin-guest"><a class="header" href="#62-deepin-guest">6.2 deepin guest</a></h4>
<p>Acts well.</p>
<h4 id="63-kylin-guest"><a class="header" href="#63-kylin-guest">6.3 kylin guest</a></h4>
<p>issue:</p>
<pre><code>root@lxchost:~# lxc-start -n kylinlxc -F
/sbin/init: error while loading shared libraries: libc.so.6: cannot stat shared object: Error 38
</code></pre>
<h4 id="64-uos-guest"><a class="header" href="#64-uos-guest">6.4 uos guest</a></h4>
<p>issue:</p>
<pre><code>lxc-start -n uoslxc -F
/sbin/init: error while loading shared libraries: libc.so.6: cannot stat shared object: Error 38
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250213"><a class="header" href="#20250213">20250213</a></h1>
<p>Conclusion:</p>
<pre><code>1. libvirt-lxc need to be compiled on 3a6000.    
2. arm64-lxc could back to d2000 and most of its functionality works well.   
3. 
</code></pre>
<h3 id="1-compile-libvirt"><a class="header" href="#1-compile-libvirt">1. compile libvirt</a></h3>
<p>Get the specified version:</p>
<pre><code>wget https://github.com/libvirt/libvirt/archive/refs/tags/v5.0.0.tar.gz
tar xzvf libvirt-5.0.0.tar.gz
</code></pre>
<p>To be continue.</p>
<p><code>https://developer.ibm.com/tutorials/compiling-libvirt-and-qemu/</code>
<code>https://gitlab.com/lixianglai/libvirt/-/tree/loongarch?ref_type=heads</code></p>
<h3 id="2-lxc-verificationd2000"><a class="header" href="#2-lxc-verificationd2000">2. lxc Verification(D2000)</a></h3>
<p>System hardware Info:</p>
<p><img src="./images/20250213_110404_x.jpg" alt="./images/20250213_110404_x.jpg" /></p>
<p><img src="./images/20250213_110414_x.jpg" alt="./images/20250213_110414_x.jpg" /></p>
<p>Boot from iso and install system.</p>
<p><img src="./images/20250213_110531_x.jpg" alt="./images/20250213_110531_x.jpg" /></p>
<p>(ignored)Install some necessary packages and configuration of the lxc default options.</p>
<pre><code>lxc-create -t local -n kylinlxc -- -m /root/meta.tar.xz -f /root/kylinpulse.tar.xz
lxc-create -t local -n  uoslxc -- -m /root/meta.tar.xz -f /root/uoslxc.tar.xz
lxc-create -t local -n zkfdlxc -- -m  /root/meta.tar.xz -f /root/zkfdpulse.tar.xz
./patchlxc.sh zkfdlxc &amp;&amp; ./patchlxc.sh kylinlxc &amp;&amp; ./patchlxc.sh uoslxc
</code></pre>
<p>uos's sound issue(kt-usb audio not recognized).</p>
<h3 id="3-libvirt-lxc-verificationd2000"><a class="header" href="#3-libvirt-lxc-verificationd2000">3. libvirt-lxc verification(d2000)</a></h3>
<p>kylinlxc: got xorg startup issue.<br />
zkfdlxc: got keyboard/mouse input issue.<br />
uoslxc: got sound issue.</p>
<pre><code>$ ls arm64_workable_20250211
added.conf  copy.sh  hooks  kkk.sh  kylinpulse.tar.xz  LXC  override.conf  patchlxc.sh  preX-populate-input.sh  uoslxc.tar.xz  zkfdpulse.tar.xz
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>name</th><th>description</th></tr></thead><tbody>
<tr><td>added.conf</td><td>lxc instance specified conf</td></tr>
<tr><td>copy.sh</td><td>copy items into instance</td></tr>
<tr><td>hooks</td><td>libvirt hooks for lxc</td></tr>
<tr><td>kylinpulse.tar.xz</td><td>lxc images(pulse audio system-level in guest)</td></tr>
<tr><td>uoslxc.tar.xz</td><td>lxc images</td></tr>
<tr><td>zkfdpulse.tar.xz</td><td>lxc images (pulse audio system-level in guest)</td></tr>
<tr><td>patchlxc.sh</td><td>usage: ./patchlxc.sh lxcinstance, after lxc-create</td></tr>
<tr><td>override.conf</td><td>override of the lxc instance lightdm systemd file</td></tr>
<tr><td>preX-populate-input.sh</td><td>added input to lxc instance</td></tr>
<tr><td>LXC</td><td>definition for lxc xml</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="20250214"><a class="header" href="#20250214">20250214</a></h1>
<h3 id="zkfd-host-verificationx86"><a class="header" href="#zkfd-host-verificationx86">zkfd host verification(x86)</a></h3>
<p>Install packages:</p>
<pre><code>sudo apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
crontab -e
@reboot chmod 777 /dev/tty* &amp;&amp; chmod 777 /dev/fb* &amp;&amp; chmod 777 -R /dev/dri/* &amp;&amp; chmod 777 -R /dev/snd/* &amp;&amp; chmod 777 -R /dev/input/*
Edit /usr/share/lxc/config/common.conf and /etc/lxc/default.conf
</code></pre>
<p>Create lxc instance:</p>
<pre><code>lxc-create -t local -n zkfdlxc -- -m /root/meta.tar.xz -f  /root/zkfdlxc.tar.xz
root@zkfd:~# ./patchlxc.sh zkfdlxc
patching lxc zkfdlxc
root@zkfd:~# vim /var/lib/lxc/zkfdlxc/rootfs/etc/lightdm/lightdm.conf 
root@zkfd:~# vim /var/lib/lxc/zkfdlxc/rootfs/etc/fstab 
root@zkfd:~# lxc-start -n zkfdlxc -F
root@zkfd:~# mv /var/lib/lxc/zkfdlxc/rootfs/etc/acpi/ /var/lib/lxc/zkfdlxc/rootfs/etc/acpi.bak
</code></pre>
<p>kylin:</p>
<pre><code>root@zkfd:/home/test# lxc-create -t local -n kylinlxc -- -m /root/meta.tar.xz -f  /root/kylinlxc.tar.xz
root@zkfd:~# ./patchlxc.sh kylinlxc
root@zkfd:~# vim /var/lib/lxc/kylinlxc/rootfs/etc/fstab 
root@zkfd:~# vim /var/lib/lxc/kylinlxc/rootfs/etc/lightdm/lightdm.conf
root@zkfd:~# lxc-start -n kylinlxc
</code></pre>
<p>Effect: under zkfd, the moving mouse will be stucked.</p>
<h3 id="kylin-host-verificationx86"><a class="header" href="#kylin-host-verificationx86">kylin host verification(x86)</a></h3>
<p>The same effect as zkfdlxc.</p>
<h3 id="ubuntu20042204debian-host-verificationx86"><a class="header" href="#ubuntu20042204debian-host-verificationx86">ubuntu20.04/22.04/debian host verification(x86)</a></h3>
<p>The same effect as zkfdlxc.</p>
<p>kylin/zkfd are all derived from ubuntu20.04, so the issues are the same.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250215"><a class="header" href="#20250215">20250215</a></h1>
<h3 id="1-gen10intel-zkfd"><a class="header" href="#1-gen10intel-zkfd">1. gen10(intel) zkfd</a></h3>
<p>Install system, pass <code>nomodeset</code> to grub items.</p>
<p>After installation, i915 driver won't take effects.</p>
<h3 id="2-xfs-issue"><a class="header" href="#2-xfs-issue">2. xfs issue</a></h3>
<p>zkfd's xfsprogs is too old to mount <code>xfs on mapper</code>, so I mount the usb disk on archlinux(could mount properly on archlinux first) and <code>xfs_repair /dev/mapper/vol</code> , soonly it won't be mounted. Error messages:</p>
<pre><code>[218555.149809] Buffer I/O error on dev dm-0, logical block 121679856, async page read
[218555.150428] EXT4-fs (dm-0): unable to read superblock
</code></pre>
<p>Beware of this <code>xfs_repair</code> command.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250216"><a class="header" href="#20250216">20250216</a></h1>
<h3 id="photo-print"><a class="header" href="#photo-print">photo print</a></h3>
<p><img src="./images/2025_02_16_08_35_23_686x474.jpg" alt="./images/2025_02_16_08_35_23_686x474.jpg" /></p>
<p><img src="./images/2025_02_16_08_35_40_436x369.jpg" alt="./images/2025_02_16_08_35_40_436x369.jpg" /></p>
<h3 id="2-lxc-stuck-issue"><a class="header" href="#2-lxc-stuck-issue">2. lxc stuck issue</a></h3>
<p>solved via change <code>cgroups.allow = all</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250217"><a class="header" href="#20250217">20250217</a></h1>
<h3 id="1-zkfd-evdev-issue"><a class="header" href="#1-zkfd-evdev-issue">1. zkfd evdev issue</a></h3>
<p>Problem:<br />
problem 1: input key slow.<br />
problem 2: When input UP key in terminal(alsamixer), call screenshot instead.</p>
<p>debugging period(it turns it's not the real reason).</p>
<pre><code>apt update -y
apt install -y xfce4
Change to xfce by default.   
</code></pre>
<p>Problem 1, input key is normal under xfce4.</p>
<p>Problem 1/2 are solved via <code>xinput debugging</code>. Install/Uninstall some packages(xinput).</p>
<h3 id="2-xinput-debugging"><a class="header" href="#2-xinput-debugging">2. xinput debugging</a></h3>
<p>Under deepinlxc:</p>
<p><img src="./images/20250217_164118_x.jpg" alt="./images/20250217_164118_x.jpg" /></p>
<p>Under zkfdlxc:</p>
<p><img src="./images/20250217_164309_x.jpg" alt="./images/20250217_164309_x.jpg" /></p>
<p>float 15:</p>
<pre><code>xinput float 15
</code></pre>
<p>Test via following method:</p>
<pre><code>root@debian:~# lxc-attach -n zkfd1
root@zkfdlxc:~# su test
test@zkfdlxc:/root$ DISPLAY=:0 xev

Press UP/Down shows OK

KeyPress event, serial 33, synthetic NO, window 0x1000001,
    root 0x6c7, subw 0x0, time 18939240, (1918,355), root:(1919,398),
    state 0x0, keycode 111 (keysym 0xff52, Up), same_screen YES,
    XLookupString gives 0 bytes: 
    XmbLookupString gives 0 bytes: 
    XFilterEvent returns: False

KeyRelease event, serial 36, synthetic NO, window 0x1000001,
    root 0x6c7, subw 0x0, time 18939311, (1918,355), root:(1919,398),
    state 0x0, keycode 111 (keysym 0xff52, Up), same_screen YES,
    XLookupString gives 0 bytes: 
    XFilterEvent returns: False


KeyPress event, serial 36, synthetic NO, window 0x1000001,
    root 0x6c7, subw 0x0, time 18942639, (1918,355), root:(1919,398),
    state 0x0, keycode 116 (keysym 0xff54, Down), same_screen YES,
    XLookupString gives 0 bytes: 
    XmbLookupString gives 0 bytes: 
    XFilterEvent returns: False

KeyRelease event, serial 36, synthetic NO, window 0x1000001,
    root 0x6c7, subw 0x0, time 18942711, (1918,355), root:(1919,398),
    state 0x0, keycode 116 (keysym 0xff54, Down), same_screen YES,
    XLookupString gives 0 bytes: 
    XFilterEvent returns: False
</code></pre>
<p>Kylin lxc issue(Up 111/Down 116):</p>
<pre><code>KeyPress event, serial 38, synthetic NO, window 0x7200001,
    root 0x6c7, subw 0x0, time 19040788, (912,406), root:(960,540),
    state 0x0, keycode 111 (keysym 0xff61, Print), same_screen YES,
    XLookupString gives 0 bytes: 
    XmbLookupString gives 0 bytes: 
    XFilterEvent returns: False

KeyRelease event, serial 41, synthetic NO, window 0x7200001,
    root 0x6c7, subw 0x0, time 19040828, (912,406), root:(960,540),
    state 0x0, keycode 111 (keysym 0xff61, Print), same_screen YES,
    XLookupString gives 0 bytes: 
    XFilterEvent returns: False




KeyPress event, serial 41, synthetic NO, window 0x7200001,
    root 0x6c7, subw 0x0, time 19052107, (912,406), root:(960,540),
    state 0x0, keycode 116 (keysym 0xffec, Super_R), same_screen YES,
    XLookupString gives 0 bytes: 
    XmbLookupString gives 0 bytes: 
    XFilterEvent returns: False

KeyRelease event, serial 41, synthetic NO, window 0x7200001,
    root 0x6c7, subw 0x0, time 19052163, (912,406), root:(960,540),
    state 0x40, keycode 116 (keysym 0xffec, Super_R), same_screen YES,
    XLookupString gives 0 bytes: 
    XFilterEvent returns: False
</code></pre>
<p>Using <code>xmodmap -pke</code> for detecting the key mapping.</p>
<p>Solved:<br />
zkfd because I installed too much input equipments:</p>
<p><img src="./images/20250217_171507_x.jpg" alt="./images/20250217_171507_x.jpg" /></p>
<p>kylin because no input equipments installed:</p>
<p><img src="./images/20250217_171613_x.jpg" alt="./images/20250217_171613_x.jpg" /></p>
<pre><code>zkfd: 
remove the  kbd, then the evdev got OK.   

apt remove xserver-xorg-input-kbd

kylin:    

apt install xserver-xorg-input-evdev
</code></pre>
<p>Now the system behaves OK.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250218"><a class="header" href="#20250218">20250218</a></h1>
<h3 id="1-arm64-soundkt-usb-audio"><a class="header" href="#1-arm64-soundkt-usb-audio">1. arm64 sound(KT USB Audio)</a></h3>
<p>In guest(lxc):</p>
<p><img src="./images/20250218_094037_x.jpg" alt="./images/20250218_094037_x.jpg" /></p>
<p>In Host:</p>
<p><img src="./images/20250218_094101_x.jpg" alt="./images/20250218_094101_x.jpg" /></p>
<h3 id="2-arm64-lxc"><a class="header" href="#2-arm64-lxc">2. arm64 lxc</a></h3>
<p>libvirt-lxc startup vs lxc-start startup issue:</p>
<p><img src="./images/20250218_110518_x.jpg" alt="./images/20250218_110518_x.jpg" /></p>
<p>In libvirt-lxc, pulseaudio won't use, while lxc-start could use.</p>
<p><code>pactl list cards short</code> shows no card in libvirt-lxc, while lxc-start could show.</p>
<p>Solved via:</p>
<pre><code>    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/sys/fs/fuse/connections'/&gt;
      &lt;target dir='/sys/fs/fuse/connections'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/sys'/&gt;
      &lt;target dir='/sys'/&gt;
    &lt;/filesystem&gt;



  &lt;os&gt;
    &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/lib/systemd/systemd&lt;/init&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;audit_control state='on'/&gt;
      &lt;audit_write state='on'/&gt;
      &lt;block_suspend state='on'/&gt;
      &lt;chown state='on'/&gt;
      &lt;dac_override state='on'/&gt;
      &lt;dac_read_search state='on'/&gt;
      &lt;fowner state='on'/&gt;
      &lt;fsetid state='on'/&gt;
      &lt;ipc_lock state='on'/&gt;
      &lt;ipc_owner state='on'/&gt;
      &lt;kill state='on'/&gt;
      &lt;lease state='on'/&gt;
      &lt;linux_immutable state='on'/&gt;
      &lt;mac_admin state='on'/&gt;
      &lt;mac_override state='on'/&gt;
      &lt;mknod state='on'/&gt;
      &lt;net_admin state='on'/&gt;
      &lt;net_bind_service state='on'/&gt;
      &lt;net_broadcast state='on'/&gt;
      &lt;net_raw state='on'/&gt;
      &lt;setgid state='on'/&gt;
      &lt;setfcap state='on'/&gt;
      &lt;setpcap state='on'/&gt;
      &lt;setuid state='on'/&gt;
      &lt;sys_admin state='on'/&gt;
      &lt;sys_boot state='on'/&gt;
      &lt;sys_chroot state='on'/&gt;
      &lt;sys_module state='on'/&gt;
      &lt;sys_nice state='on'/&gt;
      &lt;sys_pacct state='on'/&gt;
      &lt;sys_ptrace state='on'/&gt;
      &lt;sys_rawio state='on'/&gt;
      &lt;sys_resource state='on'/&gt;
      &lt;sys_time state='on'/&gt;
      &lt;sys_tty_config state='on'/&gt;
      &lt;syslog state='on'/&gt;
      &lt;wake_alarm state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;

</code></pre>
<h3 id="3-lxc-network"><a class="header" href="#3-lxc-network">3. lxc network</a></h3>
<p>In /sys mounted lxc container:</p>
<p><img src="./images/20250218_172417_x.jpg" alt="./images/20250218_172417_x.jpg" /></p>
<p>not mounted lxc instance:</p>
<p><img src="./images/20250218_172806_x.jpg" alt="./images/20250218_172806_x.jpg" /></p>
<h3 id="4-xml-definition"><a class="header" href="#4-xml-definition">4. xml definition</a></h3>
<pre><code>&lt;domain type='lxc'&gt;
  &lt;name&gt;zkfdlxc&lt;/name&gt;
  &lt;uuid&gt;4c5bbaef-0b21-48b6-bdf9-21a0d0f793df&lt;/uuid&gt;
  &lt;memory unit='KiB'&gt;4276800&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;4276800&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;1&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/lib/systemd/systemd&lt;/init&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;audit_control state='on'/&gt;
      &lt;audit_write state='on'/&gt;
      &lt;block_suspend state='on'/&gt;
      &lt;chown state='on'/&gt;
      &lt;dac_override state='on'/&gt;
      &lt;dac_read_search state='on'/&gt;
      &lt;fowner state='on'/&gt;
      &lt;fsetid state='on'/&gt;
      &lt;ipc_lock state='on'/&gt;
      &lt;ipc_owner state='on'/&gt;
      &lt;kill state='on'/&gt;
      &lt;lease state='on'/&gt;
      &lt;linux_immutable state='on'/&gt;
      &lt;mac_admin state='on'/&gt;
      &lt;mac_override state='on'/&gt;
      &lt;mknod state='on'/&gt;
      &lt;net_admin state='on'/&gt;
      &lt;net_bind_service state='on'/&gt;
      &lt;net_broadcast state='on'/&gt;
      &lt;net_raw state='on'/&gt;
      &lt;setgid state='on'/&gt;
      &lt;setfcap state='on'/&gt;
      &lt;setpcap state='on'/&gt;
      &lt;setuid state='on'/&gt;
      &lt;sys_admin state='on'/&gt;
      &lt;sys_boot state='on'/&gt;
      &lt;sys_chroot state='on'/&gt;
      &lt;sys_module state='on'/&gt;
      &lt;sys_nice state='on'/&gt;
      &lt;sys_pacct state='on'/&gt;
      &lt;sys_ptrace state='on'/&gt;
      &lt;sys_rawio state='on'/&gt;
      &lt;sys_resource state='on'/&gt;
      &lt;sys_time state='on'/&gt;
      &lt;sys_tty_config state='on'/&gt;
      &lt;syslog state='on'/&gt;
      &lt;wake_alarm state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/libvirt/libvirt_lxc&lt;/emulator&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxc/zkfd2/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/dev/snd'/&gt;
      &lt;target dir='/dev/snd'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/sys/fs/fuse/connections'/&gt;
      &lt;target dir='/sys/fs/fuse/connections'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/sys'/&gt;
      &lt;target dir='/sys'/&gt;
    &lt;/filesystem&gt;

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250219"><a class="header" href="#20250219">20250219</a></h1>
<h3 id="1-archlinux-vm-for-lxc"><a class="header" href="#1-archlinux-vm-for-lxc">1. ArchLinux vm for lxc</a></h3>
<p>Steps(from pacstrap):</p>
<pre><code>pacman -S vim
vim /etc/pacman.d/mirrorlist 
pacman -Sy
pacman -S linux linux-firmware base-devel base
ln -s /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime
vim /etc/locale.gen
locale-gen
vim /etc/locale.conf
vim /etc/hostname
vim /etc/hosts 
pacman -S net-tools tcpdump iotop dhcpcd openssh dosfstools ntfs-3g amd-ucode intel-ucode grub efibootmgr
systemctl enable sshd
vim /etc/mkinitcpio.conf
mkinitcpio -P
passwd
grub-install --target=i386-pc /dev/vda --recheck
grub-mkconfig -o /boot/grub/grub.cfg
reboot
</code></pre>
<p>After reboot:</p>
<pre><code>$ pacman -S lightdm networkmanager mate pulseaudio Xorg mate-extra lightdm-gtk-greeter alsa-utils libvirt dnsmasq
$ systemctl enable NetworkManager
$ useradd -m dash
$ passwd dash
$ systemctl enable lightdm
$ systemctl status lightdm
$ pacman -Ss mate | grep terminal
$ groupadd -r autologin
$ gpasswd -a dash autologin
$ vim /etc/lightdm/lightdm.conf 
$ vim /etc/pacman.conf 
[archlinuxcn]
SigLevel = Optional TrustAll
Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch
$ pacman -S yay
$ systemctl enable libvirtd
$ systemctl enable virtlxcd
</code></pre>
<p>virsh network related:</p>
<pre><code>$ systemctl enable virtnetworkd
$ systemctl start virtnetworkd
$ virsh net-start default
$ virsh net-autostart default
</code></pre>
<p>lxc installation:</p>
<pre><code>$ pacman -S lxc lxcfs
$ vim /etc/subgid
dash:100000:65536
root:100000:65536
$ vim /etc/subuid
dash:100000:65536
root:100000:65536
$ systemctl enable lxc-net.service --now
$ vim /etc/default/lxc-net
$ systemctl restart lxc-net
$ virsh -c lxc:/// list --all
</code></pre>
<p>Content of <code>/etc/default/lxc-net</code>:</p>
<pre><code>cat /etc/default/lxc-net 
# Leave USE_LXC_BRIDGE as "true" if you want to use lxcbr0 for your
# containers.  Set to "false" if you'll use virbr0 or another existing
# bridge, or mavlan to your host's NIC.
USE_LXC_BRIDGE="true"

# If you change the LXC_BRIDGE to something other than lxcbr0, then
# you will also need to update your /etc/lxc/default.conf as well as the
# configuration (/var/lib/lxc/&lt;container&gt;/config) for any containers
# already created using the default config to reflect the new bridge
# name.
# If you have the dnsmasq daemon installed, you'll also have to update
# /etc/dnsmasq.d/lxc and restart the system wide dnsmasq daemon.
LXC_BRIDGE="lxcbr0"
LXC_ADDR="10.0.3.1"
LXC_NETMASK="255.255.255.0"
LXC_NETWORK="10.0.3.0/24"
LXC_DHCP_RANGE="10.0.3.2,10.0.3.254"
LXC_DHCP_MAX="253"
# Uncomment the next line if you'd like to use a conf-file for the lxcbr0
# dnsmasq.  For instance, you can use 'dhcp-host=mail1,10.0.3.100' to have
# container 'mail1' always get ip address 10.0.3.100.
#LXC_DHCP_CONFILE=/etc/lxc/dnsmasq.conf

# Uncomment the next line if you want lxcbr0's dnsmasq to resolve the .lxc
# domain.  You can then add "server=/lxc/10.0.3.1' (or your actual $LXC_ADDR)
# to your system dnsmasq configuration file (normally /etc/dnsmasq.conf,
# or /etc/NetworkManager/dnsmasq.d/lxc.conf on systems that use NetworkManager).
# Once these changes are made, restart the lxc-net and network-manager services.
# 'container1.lxc' will then resolve on your host.
#LXC_DOMAIN="lxc"

</code></pre>
<p>Create lxc instance:</p>
<pre><code>$ lxc-create -t local -n zkfdlxc -- -m /root/meta.tar.xz -f /root/zkfdlxc.tar.xz
$ ./patchlxc zkfdlxc
$ make modifications to root system. 
$ lxc-start -n zkfdlxc
</code></pre>
<p>Create libvirt-lxc instance:</p>
<pre><code>$ mkdir -p ~/LXC
$ vim ~/LXC/zkfd.xml
$ virsh -c lxc:/// define ~/LXC/zkfd.xml
$ mkdir -p /etc/libvirt/hooks
$ cd /etc/libvirt/hooks
$ vim lxc
$ vim /bin/attach_dev.sh
$ chmod 777 /bin/attach_dev.sh 
$ vim /bin/detach_dev.sh
$ chmod 777 /bin/detach_dev.sh 
$ /bin/attach_dev.sh zkfdlxc
$ virsh -c lxc:/// start zkfdlxc
</code></pre>
<h3 id="2-libvirt-lxc-sound"><a class="header" href="#2-libvirt-lxc-sound">2. libvirt-lxc sound</a></h3>
<p>lxc-start vs libvirt-lxc:</p>
<pre><code>test@zkfdlxc:~$ DISPLAY=:0 pactl list cards short
0	alsa_card.pci-0000_00_1b.0	module-alsa-card.c
</code></pre>
<p>Solved via:</p>
<pre><code>test@uoslxc:~$ pactl load-module module-alsa-card device_id=1
27
test@uoslxc:~$ pactl load-module module-alsa-card device_id=0
28
test@uoslxc:~$ pactl load-module module-alsa-card device_id=2
失败：模块初始化失败
test@uoslxc:~$ pactl list cards short
0	alsa_card.1	module-alsa-card.c
1	alsa_card.0	module-alsa-card.c
test@uoslxc:~$ pactl list sinks short
1	alsa_output.1.analog-stereo	module-alsa-card.c	s16le 2ch 48000Hz	SUSPENDED
2	alsa_output.0.hdmi-stereo-extra3	module-alsa-card.c	s16le 2ch 44100Hz	SUSPENDED
</code></pre>
<h3 id="3-libvirt-lxc-arm64-kylin"><a class="header" href="#3-libvirt-lxc-arm64-kylin">3. libvirt-lxc arm64 kylin</a></h3>
<p>issue:<br />
Xorg start failed.</p>
<pre><code>[ 18850.260] (II) AMDGPU(0): Set up textured video (glamor)
[ 18850.265] (EE) modeset(G0): drmSetMaster failed: Invalid argument
[ 18850.265] (EE) 
Fatal server error:
[ 18850.265] (EE) AddScreen/ScreenInit failed for gpu driver 0 -1
[ 18850.265] (EE) 
[ 18850.265] (EE) 
Please consult the The X.Org Foundation support 
	 at http://wiki.x.org
 for help. 
[ 18850.265] (EE) Please also check the log file at "/var/log/Xorg.0.log" for additional information.
[ 18850.265] (EE) 
[ 18850.320] (EE) Server terminated with error (1). Closing log file.

</code></pre>
<p>works well under <code>lxc-start</code>.</p>
<h3 id="4-arm64debian-12-verification"><a class="header" href="#4-arm64debian-12-verification">4. arm64(debian 12) verification</a></h3>
<p>Grub install issue:</p>
<p><img src="./images/20250219_155037_x.jpg" alt="./images/20250219_155037_x.jpg" /></p>
<p><img src="./images/20250219_162139_x.jpg" alt="./images/20250219_162139_x.jpg" /></p>
<p><img src="./images/20250219_162149_x.jpg" alt="./images/20250219_162149_x.jpg" /></p>
<p>Finally, use a rescue mode for re-install grub, then everything goest OK.</p>
<pre><code># apt update -y
# apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
# systemctl disable apparmor
# uname -a
Linux debianlxc 6.1.0-29-arm64 #1 SMP Debian 6.1.123-1 (2025-01-02) aarch64 GNU/Linux
# virsh net-autostart default
# apt remove --purge apparmor
# crontab -e(auto chmod 777)
# vim /etc/lightdm/lightdm.con(autologin)
root@debianlxc:~# vim /etc/lxc/default.conf 
root@debianlxc:~# vim /etc/subuid
root@debianlxc:~# vim /etc/subgid
root@debianlxc:~# vim /usr/share/lxc/config/common.conf
root@debianlxc:~# vim /usr/share/lxc/config/common.conf
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250220"><a class="header" href="#20250220">20250220</a></h1>
<h3 id="1-arm64-lxc-images"><a class="header" href="#1-arm64-lxc-images">1. arm64-lxc images</a></h3>
<p>Changed to ubuntu lxc image.</p>
<p>Under arm64 minimal vm:</p>
<pre><code>sudo apt-get install mate-desktop-environment-core
# This will install the complete MATE desktop
sudo apt-get install mate-desktop-environment
# This will install the complete MATE desktop including a few extras
sudo apt-get install mate-desktop-environment-extras
</code></pre>
<p>Changes to lightdm:</p>
<pre><code>$ sudo apt install -y lightdm
$ sudo systemctl set-default graphical.target
$ cat /etc/lightdm/lightdm.conf
[LightDM]
minimum-vt=8
[SeatDefaults]
autologin-guest=false
autologin-user=test
autologin-user-timeout=0
autologin-session=mate
</code></pre>
<p>Shutdown the vm and convert it to lxc images.</p>
<h3 id="2-libvirt-lxc-network"><a class="header" href="#2-libvirt-lxc-network">2. libvirt-lxc network</a></h3>
<p>ubuntulxc:</p>
<pre><code># cat /var/lib/lxc/ubuntulxc/rootfs/etc/systemd/network/05-eth0.network 
[Match]
Name=eth0

[Network]
DHCP=yes
########################################3
In lxc instance: 
$ sudo systemctl disable NetworkManager
$ sudo systemctl enable systemd-networkd
########################################3
</code></pre>
<p>zkfdlxc:</p>
<pre><code>The same as ubuntulxc
</code></pre>
<h3 id="3-libvirt-lxc-reboot"><a class="header" href="#3-libvirt-lxc-reboot">3. libvirt-lxc reboot</a></h3>
<p>Seems no issue under arm64(debian 12.9).</p>
<p>Sometimes it will not OK.   needed to open log and view libvirtd's behavior.</p>
<h3 id="4-sound"><a class="header" href="#4-sound">4. sound</a></h3>
<p>Solved via:</p>
<pre><code>test@idv:~$ cat /etc/pulse/default.pa 
load-module module-alsa-card device_id=0
load-module module-alsa-card device_id=1

### Make some devices default
#set-default-sink output
#set-default-source input

</code></pre>
<p>Added to usermod, then <code>aplay -L</code> will acts well:</p>
<pre><code> usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
</code></pre>
<h3 id="5-kylin-desktop-issuearm64"><a class="header" href="#5-kylin-desktop-issuearm64">5. kylin desktop issue(arm64)</a></h3>
<p>solved via replace the package(using ubuntu's package):</p>
<pre><code>sudo apt install xserver-xorg-video-all=1:7.7+19ubuntu14
</code></pre>
<h3 id="6-x86-to-do"><a class="header" href="#6-x86-to-do">6. x86 to-do</a></h3>
<p>zkfd image:</p>
<p><img src="./images/20250220_154650_x.jpg" alt="./images/20250220_154650_x.jpg" /></p>
<p><img src="./images/20250220_154714_x.jpg" alt="./images/20250220_154714_x.jpg" /></p>
<p><img src="./images/20250220_154729_x.jpg" alt="./images/20250220_154729_x.jpg" /></p>
<p>kylin image:</p>
<p><img src="./images/20250220_154829_x.jpg" alt="./images/20250220_154829_x.jpg" /></p>
<p><img src="./images/20250220_154849_x.jpg" alt="./images/20250220_154849_x.jpg" /></p>
<p><img src="./images/20250220_154904_x.jpg" alt="./images/20250220_154904_x.jpg" /></p>
<p>uos image:</p>
<p><img src="./images/20250220_155143_x.jpg" alt="./images/20250220_155143_x.jpg" /></p>
<p><img src="./images/20250220_155328_x.jpg" alt="./images/20250220_155328_x.jpg" /></p>
<p><img src="./images/20250220_155337_x.jpg" alt="./images/20250220_155337_x.jpg" /></p>
<p>Notice, uos could be upgrade under vm.</p>
<p><img src="./images/20250220_161139_x.jpg" alt="./images/20250220_161139_x.jpg" /></p>
<p>Notice, uos lxc upgrade will failed:</p>
<p><img src="./images/20250220_170202_x.jpg" alt="./images/20250220_170202_x.jpg" /></p>
<h3 id="7-ffmpeg-for-cutting-mp4"><a class="header" href="#7-ffmpeg-for-cutting-mp4">7. ffmpeg for cutting mp4</a></h3>
<p>Via(start time, stop time):</p>
<pre><code>fmpeg -ss 00:02:23 -to 00:06:59 -i ~/Downloads/bao.mp4 -threads 2 -c:v copy -c:a copy  mybao.mp4
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250221"><a class="header" href="#20250221">20250221</a></h1>
<h3 id="1-x86-lxc-images"><a class="header" href="#1-x86-lxc-images">1. x86 lxc images</a></h3>
<p>Debian 12.9:</p>
<p><img src="./images/20250221_083528_x.jpg" alt="./images/20250221_083528_x.jpg" /></p>
<p><img src="./images/20250221_083551_x.jpg" alt="./images/20250221_083551_x.jpg" /></p>
<p><img src="./images/20250221_083600_x.jpg" alt="./images/20250221_083600_x.jpg" /></p>
<p><img src="./images/20250221_083641_x.jpg" alt="./images/20250221_083641_x.jpg" /></p>
<p>ubuntu24.04.1 desktop:</p>
<p><img src="./images/20250221_083730_x.jpg" alt="./images/20250221_083730_x.jpg" /></p>
<p><img src="./images/20250221_083741_x.jpg" alt="./images/20250221_083741_x.jpg" /></p>
<pre><code>$ sudo apt install -y openssh-server lightdm mate-desktop-environment-core mate-desktop-environment mate-desktop-environment-extras
$ cat /etc/lightdm/lightdm.conf
[LightDM]
minimum-vt=8
[SeatDefaults]
autologin-guest=false
autologin-user=test
autologin-user-timeout=0
autologin-session=mate
$ cat /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash net.ifnames=0 biosdevname=0 ipv6.disabled=1"
$ sudo update-grub2
$ sudo apt install -y pulseaudio
$ sudo vim /etc/pulse/default.pa
</code></pre>
<p><img src="./images/20250221_083948_x.jpg" alt="./images/20250221_083948_x.jpg" /></p>
<p>opensuse:</p>
<p><img src="./images/20250221_140907_x.jpg" alt="./images/20250221_140907_x.jpg" /></p>
<p><img src="./images/20250221_140916_x.jpg" alt="./images/20250221_140916_x.jpg" /></p>
<p><img src="./images/20250221_140929_x.jpg" alt="./images/20250221_140929_x.jpg" /></p>
<p><img src="./images/20250221_140839_x.jpg" alt="./images/20250221_140839_x.jpg" /></p>
<p><img src="./images/20250221_141325_x.jpg" alt="./images/20250221_141325_x.jpg" /></p>
<p><img src="./images/20250221_141458_x.jpg" alt="./images/20250221_141458_x.jpg" /></p>
<p><img src="./images/20250221_141508_x.jpg" alt="./images/20250221_141508_x.jpg" /></p>
<p><img src="./images/20250221_141521_x.jpg" alt="./images/20250221_141521_x.jpg" /></p>
<p>Package refresh:</p>
<pre><code>sudo zypper lr -d
sudo zypper mr -da
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/distribution/leap/$releasever/repo/oss' USTC:OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/distribution/leap/$releasever/repo/non-oss' USTC:NON-OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/update/leap/$releasever/oss' USTC:UPDATE-OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/update/leap/$releasever/non-oss' USTC:UPDATE-NON-OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/update/leap/$releasever/sle' USTC:UPDATE-SLE
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/update/leap/$releasever/backports' USTC:UPDATE-BACKPORTS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/tumbleweed/repo/oss' USTC:OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/tumbleweed/repo/non-oss' USTC:NON-OSS
sudo zypper ar -fcg 'https://mirrors.ustc.edu.cn/opensuse/update/tumbleweed' USTC:UPDATE
sudo zypper ref
</code></pre>
<p>evdev related packages has been installed:</p>
<pre><code>localhost:/home/test # zypper search -i | grep -i input | grep evdev
i  | xf86-input-evdev                           | Generic Linux input driver for the Xorg X server                              | package

</code></pre>
<p>Issue for debian(mouse/keyboard not stable)<br />
Issue for ubuntu: snapd installed app won't start.</p>
<p>Rocky9:</p>
<p><img src="./images/20250221_160157_x.jpg" alt="./images/20250221_160157_x.jpg" /></p>
<p><img src="./images/20250221_160206_x.jpg" alt="./images/20250221_160206_x.jpg" /></p>
<p><img src="./images/20250221_160219_x.jpg" alt="./images/20250221_160219_x.jpg" /></p>
<p>Install lightdm:</p>
<pre><code>sudo dnf install -y epel-release
sudo sed -e 's|^metalink=|#metalink=|g'          -e 's|^#baseurl=https\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g'          -e 's|^#baseurl=https\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g'          -i.bak          /etc/yum.repos.d/epel{,-testing}.repo
sudo dnf install -y lightdm lightdm-gtk-greeter-settings
sudo systemctl disable gdm
sudo systemctl enable lightdm
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250222"><a class="header" href="#20250222">20250222</a></h1>
<h3 id="1-ubuntu-lxc-debugging"><a class="header" href="#1-ubuntu-lxc-debugging">1. ubuntu lxc debugging</a></h3>
<p>should always include tty0, else lightdm wont' startup</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250223"><a class="header" href="#20250223">20250223</a></h1>
<h3 id="1-sound-debug"><a class="header" href="#1-sound-debug">1. sound debug</a></h3>
<p>lxc-start:</p>
<pre><code>test@ubuntu2404lxc:~$ loginctl list-sessions
SESSION  UID USER SEAT  TTY   STATE  IDLE SINCE
      5 1000 test seat0 tty8  active no   -    
     c1 1000 test -     pts/5 active no   -    

2 sessions listed.
</code></pre>
<p>virsh start:</p>
<pre><code>test@ubuntu2404lxc:~$ loginctl list-sessions
SESSION  UID USER SEAT TTY   STATE  IDLE SINCE
     62 1000 test -    pts/1 active no   -    

1 sessions listed.

</code></pre>
<p>console(virsh start):</p>
<pre><code>test@ubuntu2404lxc:~$ loginctl list-sessions
No sessions.
</code></pre>
<p>console(lxc-start)</p>
<pre><code>test@ubuntu2404lxc:~$ loginctl list-sessions
SESSION  UID USER SEAT  TTY  STATE  IDLE SINCE
      5 1000 test seat0 tty8 active no   -    

1 sessions listed.
</code></pre>
<h3 id="2-rebuild-libvirt"><a class="header" href="#2-rebuild-libvirt">2. rebuild libvirt</a></h3>
<p>Steps:</p>
<pre><code>cd lxcpkg
 dpkg-source -x libvirt_6.0.0-0ubuntu8.20.dsc 
cd libvirt-6.0.0
vim src/lxc/lxc_container.c
...

-    { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_RDONLY, false, false, false },
-    { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_BIND, false, false, false },
dpkg-source --commit
debuild -us -uc
...
</code></pre>
<p>Verification:</p>
<pre><code>apt remove --purge libvirt-daemon-system libvirt-daemon
cd ..
 dpkg -i libvirt0_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon-driver-lxc_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon-driver-qemu_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon-driver-storage-rbd_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb libvirt-daemon-system-systemd_6.0.0-0ubuntu8.20_amd64.deb
</code></pre>
<h3 id="3-reason"><a class="header" href="#3-reason">3. reason</a></h3>
<p>Under libvirt-lxc, the <code>systemd-udevd</code> is not properly started:</p>
<pre><code>journalctl -xeu systemd-udevd
2月 23 17:29:26 ubuntu2404lxc systemd[1]: systemd-udevd.service - Rule-based Manager for Device Events and Files was skipped because of an unmet condition check (ConditionPathIsReadWrite=/&gt;

</code></pre>
<p><img src="./images/2025_02_23_17_35_41_829x344.jpg" alt="./images/2025_02_23_17_35_41_829x344.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250224"><a class="header" href="#20250224">20250224</a></h1>
<h3 id="1-debian-building-pkg"><a class="header" href="#1-debian-building-pkg">1. debian building pkg</a></h3>
<p>Enable <code>deb-src</code> in <code>/etc/apt/sources.list</code>, then:</p>
<pre><code># apt install -y build-essential pbuilder
$ mkdir ~/Code/libvirt-lxc
$ apt-get source libvirt-daemon-driver-lxc
$ dpkg-source --no-check -x libvirt_9.0.0-4+deb12u2.dsc
# apt-get build-dep libvirt-daemon-driver-lxc
</code></pre>
<p>Build:</p>
<pre><code>dpkg-source --commit
debuild -us -uc
</code></pre>
<p>Verification:</p>
<pre><code>apt remove --purge libvirt-daemon-system libvirt-daemon
dpkg -i libvirt0_9.0.0-4+deb12u2_amd64.deb libvirt-daemon_9.0.0-4+deb12u2_amd64.deb libvirt-daemon-system-systemd_9.0.0-4+deb12u2_all.deb libvirt-daemon-system_9.0.0-4+deb12u2_amd64.deb  libvirt-daemon-driver-storage-rbd_9.0.0-4+deb12u2_amd64.deb libvirt-daemon-driver-qemu_9.0.0-4+deb12u2_amd64.deb libvirt-daemon-driver-lxc_9.0.0-4+deb12u2_amd64.deb
</code></pre>
<p>Directly reboot host machine for taking effects.</p>
<h3 id="2-sound-debugubuntu-guest"><a class="header" href="#2-sound-debugubuntu-guest">2. sound debug(ubuntu guest)</a></h3>
<p>After doing following steps:</p>
<pre><code>usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
</code></pre>
<p><img src="./images/20250224_092017_x.jpg" alt="./images/20250224_092017_x.jpg" />
But with the origin libvirt-lxc, virsh-lxc see nothing.</p>
<p>With modified libvirt-lxc, virsh-lxc works well.</p>
<p><img src="./images/20250224_093513_x.jpg" alt="./images/20250224_093513_x.jpg" /></p>
<h3 id="3-verification-on-kylinv10"><a class="header" href="#3-verification-on-kylinv10">3. verification on kylinv10</a></h3>
<p>Close all of the firewall/anti-virus, etc:</p>
<p><img src="./images/20250224_120949_x.jpg" alt="./images/20250224_120949_x.jpg" /></p>
<p>acpi related, disable sleep:</p>
<p><img src="./images/20250224_121145_x.jpg" alt="./images/20250224_121145_x.jpg" /></p>
<pre><code>$ setstatus disable -p
$ sudo cat /etc/default/grub | grep GRUB_CMDLINE_LINUX_SECURITY
GRUB_CMDLINE_LINUX_SECURITY=""
$ sudo update-grub2
$ sudo reboot
$ getstatus 
KySec status: disabled
</code></pre>
<p>Install Packages:</p>
<pre><code>$ sudo apt install -y iotop vim nethogs s-tui libvirt-daemon-driver-lxc virt-manager lxc lxc-templates lxcfs smplayer
$ sudo apt remove --purge libvirt-daemon-system libvirt-daemon
test@zhaoxinlxc:~/ubuntu2004debs$ ls
libnss-libvirt_6.0.0-0ubuntu8.20_amd64.deb
libvirt0_6.0.0-0ubuntu8.20_amd64.deb
libvirt-clients_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-lxc_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-qemu_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-storage-gluster_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-storage-rbd_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-storage-zfs_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-vbox_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-driver-xen_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-system-systemd_6.0.0-0ubuntu8.20_amd64.deb
libvirt-daemon-system-sysv_6.0.0-0ubuntu8.20_amd64.deb
libvirt-dev_6.0.0-0ubuntu8.20_amd64.deb
libvirt-doc_6.0.0-0ubuntu8.20_all.deb
libvirt-sanlock_6.0.0-0ubuntu8.20_amd64.deb
libvirt-wireshark_6.0.0-0ubuntu8.20_amd64.deb
$ sudo vim /etc/uid_list
remove libvirt_* related
$ sudo apt install ./libvirt0_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-lxc_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-qemu_6.0.0-0ubuntu8.20_amd64.deb  ./libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb  ./libvirt-clients_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-system-sysv_6.0.0-0ubuntu8.20_amd64.deb
$ sudo reboot
</code></pre>
<p>kylin won't be continue.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250225"><a class="header" href="#20250225">20250225</a></h1>
<h3 id="1-zkfd-lxchost"><a class="header" href="#1-zkfd-lxchost">1. zkfd lxchost</a></h3>
<p>Install following packages:</p>
<pre><code>root@zkfd:~# apt install -y iotop vim nethogs s-tui lxc lxc-templates lxcfs smplayer
</code></pre>
<p>Get the debs from <code>libvirt70debs</code>, install them:</p>
<pre><code># vim /etc/dpkg/dpkg.cfg
no-debsig
#  cd ~/libvirt70debs
$ sudo apt-get --allow-unauthenticated  -o APT::Get::AllowUnauthenticated=true  install ./libvirt0_7.0.0-3+deb11u3_amd64.deb ./libvirt-clients_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon-driver-lxc_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon-driver-qemu_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon-driver-storage-rbd_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon-system_7.0.0-3+deb11u3_amd64.deb ./libvirt-daemon-system-systemd_7.0.0-3+deb11u3_all.deb ./libvirt-daemon-config-network_7.0.0-3+deb11u3_all.deb ./libvirt-daemon-config-nwfilter_7.0.0-3+deb11u3_all.deb
</code></pre>
<p>remove apparmor:</p>
<pre><code>systemctl disable apparmor
apt remove --purge apparmor
</code></pre>
<p>zkfd guest(virsh):</p>
<p><img src="./images/20250225_142727_x.jpg" alt="./images/20250225_142727_x.jpg" /></p>
<p>kylin30g guest: both are OK.<br />
uos30g guest: both are OK.</p>
<h3 id="2-debian-11-building"><a class="header" href="#2-debian-11-building">2. debian 11 building</a></h3>
<p>debian 11 building:</p>
<p><img src="./images/20250225_100407_x.jpg" alt="./images/20250225_100407_x.jpg" /></p>
<p><img src="./images/20250225_100453_x.jpg" alt="./images/20250225_100453_x.jpg" /></p>
<p><img src="./images/20250225_100507_x.jpg" alt="./images/20250225_100507_x.jpg" /></p>
<pre><code>root@debian:~# uname -a
Linux debian 5.10.0-32-amd64 #1 SMP Debian 5.10.223-1 (2024-08-10) x86_64 GNU/Linux
root@debian:~# cat /etc/issue
Debian GNU/Linux 11 \n \l
</code></pre>
<pre><code>apt install -y build-essential pbuilder
apt-get build-dep libvirt-daemon-driver-lxc
apt-get source libvirt-daemon-driver-lxc
cd libvirt-7.0.0
vim src/lxc/lxc_container.c
......
dpkg-source --commit
debuild -us -uc
cd ..
mkdir ~/libvirt70debs
cp *.deb ~/libvirt70debs
</code></pre>
<h3 id="3-zkfd30g-comparison"><a class="header" href="#3-zkfd30g-comparison">3. zkfd30g comparison</a></h3>
<p>under debian host, zkfd guest:</p>
<p><img src="./images/20250225_144324_x.jpg" alt="./images/20250225_144324_x.jpg" /></p>
<p>under debian host, libvirt zkfd guest:</p>
<p><img src="./images/20250225_144712_x.jpg" alt="./images/20250225_144712_x.jpg" /></p>
<p>under zkfd host, zkfd guest(virsh):</p>
<p><img src="./images/20250225_142727_x.jpg" alt="./images/20250225_142727_x.jpg" /></p>
<h3 id="4-ubuntu-2204-host"><a class="header" href="#4-ubuntu-2204-host">4. ubuntu 22.04 host</a></h3>
<p>Should back to old kernel:</p>
<pre><code>$ apt install -y linux-image-generic
$ vim /etc/default/grub
GRUB_DEFAULT="Advanced options for Ubuntu&gt;Ubuntu, with Linux 5.15.0-133-generic"
$ sudo update-grub2
</code></pre>
<p>Make package(re-build).</p>
<p>Install pkg:</p>
<pre><code>apt remove --purge libvirt-daemon-system libvirt-daemon
apt install ./libvirt0_8.0.0-1ubuntu7.10_amd64.deb ./libvirt-daemon_8.0.0-1ubuntu7.10_amd64.deb  ./libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.10_amd64.deb ./libvirt-daemon-driver-qemu_8.0.0-1ubuntu7.10_amd64.deb ./libvirt-daemon-system_8.0.0-1ubuntu7.10_amd64.deb ./libvirt-clients_8.0.0-1ubuntu7.10_amd64.deb ./libvirt-daemon-system-sysv_8.0.0-1ubuntu7.10_all.deb
</code></pre>
<p>zkfd30g image, should remove xorg-input-kbd</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250226"><a class="header" href="#20250226">20250226</a></h1>
<h3 id="1-hwe-zkfd-host"><a class="header" href="#1-hwe-zkfd-host">1. hwe zkfd host</a></h3>
<p><img src="./images/20250226_084550_x.jpg" alt="./images/20250226_084550_x.jpg" /></p>
<pre><code># uname -a
Linux zkfdhwe 6.2.16 #m4+1nfs5.6 SMP PREEMPT_DYNAMIC Fri Nov  1 12:58:14 CST 2024 x86_64 GNU/Linux
</code></pre>
<p>Could be run on gen12 idv.</p>
<h3 id="2-dual-vm-rescue"><a class="header" href="#2-dual-vm-rescue">2. dual vm rescue</a></h3>
<p>USB network adapter:</p>
<p><img src="./images/20250226_093424_x.jpg" alt="./images/20250226_093424_x.jpg" /></p>
<p><img src="./images/20250226_093323_x.jpg" alt="./images/20250226_093323_x.jpg" /></p>
<p>256GB rescue image:</p>
<p><img src="./images/20250226_093526_x.jpg" alt="./images/20250226_093526_x.jpg" /></p>
<p>destination:</p>
<p><img src="./images/20250226_093551_x.jpg" alt="./images/20250226_093551_x.jpg" /></p>
<p><img src="./images/20250226_101658_x.jpg" alt="./images/20250226_101658_x.jpg" /></p>
<p>After restore, configuration:</p>
<p><img src="./images/20250226_105525_x.jpg" alt="./images/20250226_105525_x.jpg" /></p>
<p>Save/Restart the machine.</p>
<p><img src="./images/20250226_105648_x.jpg" alt="./images/20250226_105648_x.jpg" /></p>
<p>ssh into the machine and shutdown :</p>
<pre><code>root@zkfd:~# virsh list
 Id   名称      状态
-------------------------
 1    dom0zx    running
 2    dom0amd   running

root@zkfd:~# shutdown -h now

</code></pre>
<h3 id="3-fnnas"><a class="header" href="#3-fnnas">3. fnnas</a></h3>
<p>Download from <code>fnnas.com</code>:</p>
<p><img src="./images/20250226_101915_x.jpg" alt="./images/20250226_101915_x.jpg" /></p>
<p><img src="./images/20250226_162949_x.jpg" alt="./images/20250226_162949_x.jpg" /></p>
<p><img src="./images/20250226_163023_x.jpg" alt="./images/20250226_163023_x.jpg" /></p>
<h3 id="4-kylinlxchost"><a class="header" href="#4-kylinlxchost">4. kylinlxchost</a></h3>
<p>Install packages:</p>
<pre><code>sudo apt install -y iotop vim nethogs s-tui lxc lxc-templates lxcfs smplayer
cd debs
sudo apt install ./libvirt0_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-lxc_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-qemu_6.0.0-0ubuntu8.20_amd64.deb  ./libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb  ./libvirt-clients_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-system-sysv_6.0.0-0ubuntu8.20_amd64.deb
sudo reboot
</code></pre>
<p>Added:</p>
<pre><code># cat /etc/lxc/default.conf
lxc.apparmor.profile = unconfined

# vim /usr/share/lxc/config/common.conf

lxc.mount.auto = cgroup:rw proc:rw sys:rw
lxc.mount.entry = /sys/fs/fuse/connections sys/fs/fuse/connections none bind,optional 0 0

# Blacklist some syscalls which are not safe in privileged
# containers
lxc.seccomp.profile = /usr/share/lxc/config/common.seccomp

# Lastly, include all the configs from /usr/share/lxc/config/common.conf.d/
lxc.include = /usr/share/lxc/config/common.conf.d/

### tty0, tty1, tty3, tty4, tty5, tty6, tty7, tty8
lxc.cgroup.devices.allow = c 4:0 rwm
lxc.cgroup.devices.allow = c 4:1 rwm
#lxc.cgroup.devices.allow = c 4:3 rwm
#lxc.cgroup.devices.allow = c 4:4 rwm
#lxc.cgroup.devices.allow = c 4:5 rwm
#lxc.cgroup.devices.allow = c 4:6 rwm
lxc.cgroup.devices.allow = c 4:7 rwm
lxc.cgroup.devices.allow = c 4:8 rwm
## graphics. /dev/dri
lxc.cgroup.devices.allow = c 226:0 rwm
lxc.cgroup.devices.allow = c 226:128 rwm
## graphics. /dev/fb0
lxc.cgroup.devices.allow = c 29:0 rwm
### sound
lxc.cgroup.devices.allow = c 116:* rwm
### input
lxc.cgroup.devices.allow = c 13:* rwm

lxc.mount.entry = /dev/snd dev/snd none bind,optional,create=dir

</code></pre>
<p>zkfdlxc:</p>
<p><img src="./images/20250226_163953_x.jpg" alt="./images/20250226_163953_x.jpg" /></p>
<p>kylinlxc/uoslxc, OK.</p>
<p>zkfdhwe30g, OK.</p>
<h3 id="5-kylin-libvirt-changes"><a class="header" href="#5-kylin-libvirt-changes">5. kylin libvirt changes</a></h3>
<p>Get the source code:</p>
<pre><code>
Added followinig to `/etc/apt/sources.list`
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal main restricted
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal-updates main restricted
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal universe
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal-updates universe
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal multiverse
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal-updates multiverse
deb-src http://mirrors.lzu.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
deb-src http://archive.canonical.com/ubuntu focal partner
deb-src http://mirrors.lzu.edu.cn/ubuntu focal-security main restricted
deb-src http://mirrors.lzu.edu.cn/ubuntu focal-security universe
deb-src http://mirrors.lzu.edu.cn/ubuntu focal-security multiverse
# apt-get source libvirt-daemon-driver-lxc
</code></pre>
<p>Diffs:</p>
<pre><code>test@kylinidvhost:~$ diff Code1/libvirt-6.0.0/src/lxc/lxc_container.c ~/Code/libvirtlxc/libvirt-6.0.0/src/lxc/lxc_container.c
798c798
&lt;     { "/proc/sys", "/proc/sys", "none", MS_BIND|MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_RDONLY, false, false, false },
---
&gt;     { "/proc/sys", "/proc/sys", "none", MS_BIND|MS_NOSUID|MS_NOEXEC|MS_NODEV, false, false, false },
801c801
&lt;     { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_RDONLY, false, false, false },
---
&gt;     { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV, false, false, false },
test@kylinidvhost:~$ diff Code1/libvirt-6.0.0/debian/rules ~/Code/libvirtlxc/libvirt-6.0.0/debian/rules 
50,51c50,51
&lt;   WITH_SELINUX        = --with-selinux --with-secdriver-selinux --with-selinux-mount=/sys/fs/selinux
&lt;   WITH_APPARMOR       = --with-apparmor --with-secdriver-apparmor --with-apparmor-profiles
---
&gt;   WITH_SELINUX        = --without-selinux
&gt;   WITH_APPARMOR       = --without-apparmor
124,125c124,125
&lt; 	$(WITH_SELINUX)          \
&lt; 	$(WITH_APPARMOR)         \
---
&gt; 	$(WITH_SELINUX)             \
&gt; 	$(WITH_APPARMOR)             \
215,218c215,218
&lt; 	dh_install -p libvirt-daemon-system usr/lib/libvirt/virt-aa-helper
&lt; 	dh_install -p libvirt-daemon-system etc/apparmor.d
&lt; 	dh_apparmor -p libvirt-daemon-system --profile-name=usr.lib.libvirt.virt-aa-helper
&lt; 	dh_apparmor -p libvirt-daemon-system --profile-name=usr.sbin.libvirtd
---
&gt; 	#dh_install -p libvirt-daemon-system usr/lib/libvirt/virt-aa-helper
&gt; 	#dh_install -p libvirt-daemon-system etc/apparmor.d
&gt; 	#dh_apparmor -p libvirt-daemon-system --profile-name=usr.lib.libvirt.virt-aa-helper
&gt; 	#dh_apparmor -p libvirt-daemon-system --profile-name=usr.sbin.libvirtd
246c246
&lt; 	rm debian/libvirt-daemon-system/etc/apparmor.d/local/*
---
&gt; 	#rm debian/libvirt-daemon-system/etc/apparmor.d/local/*
</code></pre>
<p>Changes are made for installation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250227"><a class="header" href="#20250227">20250227</a></h1>
<h3 id="1-ybd-verification"><a class="header" href="#1-ybd-verification">1. ybd verification</a></h3>
<p>Information:</p>
<pre><code>root@TY12345-pc:~# cat /etc/issue
Kylin V10 SP1 \n \l

root@TY12345-pc:~# uname -a
Linux TY12345-pc 5.4.18-91-generic #80-KYLINOS SMP Fri Jun 16 09:34:23 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux
root@TY12345-pc:~# cat /proc/cpuinfo | grep -i model
model		: 59
model name	: ZHAOXIN KaiXian KX-U6780A@2.7GHz
root@TY12345-pc:~# free -m
              总计         已用        空闲      共享    缓冲/缓存    可用
内存：       15552        1768         352          13       13432       13440

</code></pre>
<p>Remove the origin packages and install :</p>
<pre><code># pwd
/data/x86_lxc_20250211/kylin_libvirtdebs

apt remove --purge libvirt-daemon-system libvirt-daemon
vim /etc/uid_list
apt install ./libvirt0_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-lxc_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-driver-qemu_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-clients_6.0.0-0ubuntu8.20_amd64.deb ./libvirt-daemon-system_6.0.0-0ubuntu8.20_amd64.deb
apt install -y iotop vim nethogs s-tui lxc lxc-templates lxcfs
systemctl disable dnsmasq(lxc-net issue)
</code></pre>
<p>Reboot and create the lxc instance:</p>
<pre><code>lxc-create -t local -n zkfdhwelxc -- -m /data/x86_lxc_20250211/meta.tar.xz -f /data/x86_lxc_20250211/zkfdhwe30g.tar.xz
</code></pre>
<h3 id="2-arm64-verification"><a class="header" href="#2-arm64-verification">2. arm64 verification</a></h3>
<p>Copy &amp; convert the disk:</p>
<pre><code># cp zkfdux220.img zkfdvm.img
# qemu-img convert -f raw -O qcow2  zkfdvm.img zkfdvm.qcow2
# qemu-img resize  zkfdvm.qcow2 +100G
Image resized.
</code></pre>
<p>Create and start the vm, then use gparted for resize the disk.</p>
<p><img src="./images/20250227_102358_x.jpg" alt="./images/20250227_102358_x.jpg" /></p>
<p>Install packages:</p>
<pre><code>sudo vim /etc/dpkg/dpkg.cfg
sudo apt install -y iotop vim nethogs s-tui lxc lxc-templates lxcfs smplayer
cd debs/
sudo apt install ./libvirt0_7.0.0-3+deb11u3_arm64.deb ./libvirt-daemon_7.0.0-3+deb11u3_arm64.deb ./libvirt-daemon-driver-lxc_7.0.0-3+deb11u3_arm64.deb ./libvirt-daemon-driver-qemu_7.0.0-3+deb11u3_arm64.deb ./libvirt-daemon-system_7.0.0-3+deb11u3_arm64.deb ./libvirt-clients_7.0.0-3+deb11u3_arm64.deb ./libvirt-daemon-system-systemd_7.0.0-3+deb11u3_all.deb  ./libvirt-daemon-config-network_7.0.0-3+deb11u3_all.deb ./libvirt-daemon-config-nwfilter_7.0.0-3+deb11u3_all.deb 
</code></pre>
<h3 id="3-arm64debian11-libvirt-building"><a class="header" href="#3-arm64debian11-libvirt-building">3. arm64(debian11) libvirt building</a></h3>
<p>Download iso:</p>
<pre><code>wget https://cdimage.debian.org/cdimage/archive/11.11.0/arm64/iso-dvd/debian-11.11.0-arm64-DVD-1.iso
</code></pre>
<p><img src="./images/20250227_103756_x.jpg" alt="./images/20250227_103756_x.jpg" /></p>
<p><img src="./images/20250227_103811_x.jpg" alt="./images/20250227_103811_x.jpg" /></p>
<p>make secure boot off:</p>
<p><img src="./images/20250227_103853_x.jpg" alt="./images/20250227_103853_x.jpg" /></p>
<p>Automatically retrieve file(so you need to unplugin the ethernet for speedup ):</p>
<p><img src="./images/20250227_104626_x.jpg" alt="./images/20250227_104626_x.jpg" /></p>
<pre><code>root@debian:/home/test# cat /etc/apt/sources.list
# 默认注释了源码仓库，如有需要可自行取消注释
deb http://mirrors.ustc.edu.cn/debian bullseye main contrib non-free
deb-src http://mirrors.ustc.edu.cn/debian bullseye main contrib non-free
deb http://mirrors.ustc.edu.cn/debian bullseye-updates main contrib non-free
deb-src http://mirrors.ustc.edu.cn/debian bullseye-updates main contrib non-free
# apt update -y &amp;&amp; apt install -y vim build-essential pbuilder
# 
</code></pre>
<h3 id="4-arm64-images-building"><a class="header" href="#4-arm64-images-building">4. arm64 images building</a></h3>
<p>Create 5 disks:</p>
<pre><code> qemu-img create -f raw kylinarm30g.img 30G
 qemu-img create -f raw uosarm30g.img 30G
 qemu-img create -f raw zkfdarm30g.img 30G
 qemu-img create -f raw debianarm30g.img 30G
 qemu-img create -f raw ubuntu2204arm30g.img 30G
</code></pre>
<h4 id="41-zkfdarm30g"><a class="header" href="#41-zkfdarm30g">4.1 zkfdarm30g</a></h4>
<p>libvirt info:</p>
<p><img src="./images/20250227_140904_x.jpg" alt="./images/20250227_140904_x.jpg" /></p>
<p><img src="./images/20250227_140914_x.jpg" alt="./images/20250227_140914_x.jpg" /></p>
<p><img src="./images/20250227_140923_x.jpg" alt="./images/20250227_140923_x.jpg" /></p>
<p>Disable screensave, lock, enable ssh</p>
<pre><code>$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash net.ifnames=0 biosdevname=0 ipv6.disable=1"
$ sudo update-grub2
$ sudo vim /etc/selinux/config
disable selinux
$ vim /etc/systemd/network/05-eth0.network 
[Match]
Name=eth0

[Network]
DHCP=yes
$ sudo systemctl disable NetworkManager
$ sudo systemctl mask NetworkManager
$ sudo systemctl enable systemd-networkd
$ sudo vim /etc/lightdm/lightdm.conf
minimum-vts=8

</code></pre>
<p>audio related:</p>
<pre><code>test@zkfd30g:~$ id test
用户id=1000(test) 组id=1001(test) 组=1001(test),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),118(bluetooth),123(scanner),124(lpadmin),130(sambashare)
test@zkfd30g:~$ sudo su
root@zkfd30g:/home/test#  usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
root@zkfd30g:/home/test# id test
用户id=1000(test) 组id=1001(test) 组=1001(test),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),118(bluetooth),123(scanner),124(lpadmin),128(pulse),129(pulse-access),130(sambashare)

$ cat /etc/pulse/default.pa 
load-module module-alsa-card device_id=0
load-module module-alsa-card device_id=1

</code></pre>
<p>remove kbd:</p>
<pre><code>sudo apt remove xserver-xorg-input-kbd
</code></pre>
<p>shutdown the vm.</p>
<h4 id="42-uosarm30g"><a class="header" href="#42-uosarm30g">4.2 uosarm30g</a></h4>
<p>libvirt info:</p>
<p><img src="./images/20250227_141415_x.jpg" alt="./images/20250227_141415_x.jpg" /></p>
<p><img src="./images/20250227_141425_x.jpg" alt="./images/20250227_141425_x.jpg" /></p>
<p>Install with kernel5.10 support</p>
<p><img src="./images/20250227_141625_x.jpg" alt="./images/20250227_141625_x.jpg" /></p>
<p>Use rambuf:</p>
<p><img src="./images/20250227_151057_x.jpg" alt="./images/20250227_151057_x.jpg" /></p>
<p>Disable :</p>
<p><img src="./images/20250227_151109_x.jpg" alt="./images/20250227_151109_x.jpg" /></p>
<p><img src="./images/20250227_151140_x.jpg" alt="./images/20250227_151140_x.jpg" /></p>
<p>ssh-keygen:</p>
<p><img src="./images/20250227_151300_x.jpg" alt="./images/20250227_151300_x.jpg" /></p>
<p>Inject the ssh key into /root/.ssh/.</p>
<pre><code>apt update -y
apt install -y xserver-xorg-input-evdev smplayer
vim /etc/default/grub
update-grub2 
dpkg -l | grep apparmor
vim /etc/selinux/config 
vim /etc/systemd/network/05-eth0.network
systemctl disable NetworkManager
systemctl mask NetworkManager
systemctl enable systemd-networkd
vim /etc/lightdm/lightdm.conf 
sudo su
usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
vim /etc/pulse/default.pa 
</code></pre>
<h4 id="43-kylinarm30g"><a class="header" href="#43-kylinarm30g">4.3 kylinarm30g</a></h4>
<p>libvirt info:</p>
<p><img src="./images/20250227_142218_x.jpg" alt="./images/20250227_142218_x.jpg" /></p>
<p><img src="./images/20250227_142227_x.jpg" alt="./images/20250227_142227_x.jpg" /></p>
<pre><code>$ sudo apt install -y openssh-server
</code></pre>
<p>Disable security related:</p>
<p><img src="./images/20250227_144335_x.jpg" alt="./images/20250227_144335_x.jpg" /></p>
<p>Disable screensaver, lock, related.</p>
<pre><code>$ setstatus disable -p
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=0 net.ifnames=0 biosdevname=0 ipv6.disable=1"
GRUB_CMDLINE_LINUX=""
GRUB_CMDLINE_LINUX_SECURITY=""

$ cat /etc/lightdm/lightdm.conf
[LightDM]
minimum-vt=8
[SeatDefaults]

$ sudo vim /etc/systemd/network/05-eth0.network
$ sudo systemctl disable NetworkManager
$ sudo systemctl mask NetworkManager
$ sudo systemctl enable systemd-networkd
$ sudo su
 usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
$ cat /etc/pulse/default.pa 
load-module module-alsa-card device_id=0
load-module module-alsa-card device_id=1
</code></pre>
<p>Downgrade xorg-video-all, install input-evdev:</p>
<pre><code>$ sudo vim /etc/apt/sources.list
...


# 默认注释了源码仓库，如有需要可自行取消注释
deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal main restricted universe multiverse
# deb-src https://mirrors.ustc.edu.cn/ubuntu-ports/ focal main restricted universe multiverse

deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse
# deb-src https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse

deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse
# deb-src https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse

deb https://mirrors.ustc.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse


$ sudo apt install xserver-xorg-video-all=1:7.7+19ubuntu14
$  sudo apt install -y xserver-xorg-input-evdev
</code></pre>
<h4 id="44-debianarm30g"><a class="header" href="#44-debianarm30g">4.4 debianarm30g</a></h4>
<p>libvirt info:</p>
<p><img src="./images/20250227_153435_x.jpg" alt="./images/20250227_153435_x.jpg" /></p>
<p><img src="./images/20250227_153445_x.jpg" alt="./images/20250227_153445_x.jpg" /></p>
<p>Changes to rambuf.</p>
<p><img src="./images/20250227_155416_x.jpg" alt="./images/20250227_155416_x.jpg" /></p>
<p><img src="./images/20250227_155438_x.jpg" alt="./images/20250227_155438_x.jpg" /></p>
<pre><code># apt install -y vim smplayer glmark2 xserver-xorg-video-amdgpu firmware-amd-graphics xserver-xorg-input-evdev
# vim /etc/lightdm/lightdm.conf
minimum-vt=8
...
autologin-user=test
autologin-user-timeout=0
#autologin-in-background=false
autologin-session=mate
# sudo su
usermod -aG audio test
 usermod -aG audio root
 usermod -aG pulse test
 usermod -aG pulse-access test
# vim /etc/pulse/default.pa
...
# vim /etc/default/grub
# update-grub2 
# vim /etc/systemd/network/05-eth0.network
# systemctl disable NetworkManager
# systemctl mask NetworkManager
# systemctl enable systemd-networkd

</code></pre>
<h4 id="45-ubuntu2204arm30g"><a class="header" href="#45-ubuntu2204arm30g">4.5 ubuntu2204arm30g</a></h4>
<p>libvirt info:</p>
<p><img src="./images/20250227_154402_x.jpg" alt="./images/20250227_154402_x.jpg" /></p>
<p><img src="./images/20250227_154410_x.jpg" alt="./images/20250227_154410_x.jpg" /></p>
<pre><code>sudo apt update -y &amp;&amp; sudo apt upgrade -y
sudo apt install -y mate-desktop-environment-core mate-desktop-environment mate-desktop-environment-extras lightdm
sudo systemctl set-default graphical.target
sudo vim /etc/lightdm/lightdm.conf
sudo reboot
</code></pre>
<p><img src="./images/20250227_162243_x.jpg" alt="./images/20250227_162243_x.jpg" /></p>
<p><img src="./images/20250227_163105_x.jpg" alt="./images/20250227_163105_x.jpg" /></p>
<p><img src="./images/20250227_163124_x.jpg" alt="./images/20250227_163124_x.jpg" /></p>
<p>Change language:</p>
<p><img src="./images/20250227_163237_x.jpg" alt="./images/20250227_163237_x.jpg" /></p>
<p><img src="./images/20250227_163256_x.jpg" alt="./images/20250227_163256_x.jpg" /></p>
<pre><code>sudo apt install -y fonts-wqy-microhei fonts-wqy-zenhei xfonts-wqy smplayer glmark2
</code></pre>
<p>Install firefox, download it from nightly build, and create shortcuts.</p>
<pre><code>     vim /etc/pulse/default.pa
     apt install xserver-xorg-input-evdev
 sudo vim /etc/default/grub
 sudo update-grub2 
 sudo ufw disable
 sudo systemctl disable apparmor
 sudo apt remove --purge apparmor
 sudo vim /etc/systemd/network/05-eth0.network
 sudo systemctl disable NetworkManager
 sudo systemctl mask NetworkManager
 sudo systemctl enable systemd-networkd

add test to several groups.   
</code></pre>
<h3 id="5-ybd-worktips"><a class="header" href="#5-ybd-worktips">5. ybd worktips</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250228"><a class="header" href="#20250228">20250228</a></h1>
<h3 id="1-ybd-verification-1"><a class="header" href="#1-ybd-verification-1">1. ybd verification</a></h3>
<p>zkfd, browser won't connect to internet.</p>
<h3 id="2-lxc-on-ctyun"><a class="header" href="#2-lxc-on-ctyun">2. lxc on ctyun</a></h3>
<p>Install lxc related packages:</p>
<pre><code>sudo apt install -y iotop vim nethogs s-tui lxc lxc-templates lxcfs smplayer
sudo reboot
</code></pre>
<p>Detect the lxcbr0 bridge:</p>
<pre><code>$ ip a show lxcbr0
3: lxcbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 00:16:3e:00:00:00 brd ff:ff:ff:ff:ff:ff
    inet 10.0.3.1/24 brd 10.0.3.255 scope global lxcbr0
       valid_lft forever preferred_lft forever
</code></pre>
<p>Install package. then load the lxc images, the same as we did in yesterday.</p>
<h3 id="3-ollama-in-lxc"><a class="header" href="#3-ollama-in-lxc">3. ollama in lxc</a></h3>
<p>Under ubuntu:</p>
<pre><code>curl -fsSL https://ollama.com/install.sh | sh
ollama run deepseek-r1:7b
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250301"><a class="header" href="#20250301">20250301</a></h1>
<h3 id="1-qemu-rebuild-for-idv"><a class="header" href="#1-qemu-rebuild-for-idv">1. qemu rebuild for idv</a></h3>
<p>Steps:</p>
<pre><code>tar xzvf debs.tar.gz
cd debs
dpkg -i *.deb
mkdir -p /home/idv/Code
tar xzvf idv_qemu_4.2.tar.gz -C /home/idv/Code
cd /home/idv/Code/qemu

git config --global --add safe.directory /home/idv/Code/qemu
git config --global --add safe.directory /home/idv/Code/qemu/capstone
git config --global --add safe.directory /home/idv/Code/qemu/dtc
git config --global --add safe.directory /home/idv/Code/qemu/slirp
git config --global --add safe.directory /home/idv/Code/qemu/tests/fp/berkeley-softfloat-3
git config --global --add safe.directory /home/idv/Code/qemu/tests/fp/berkeley-testfloat-3
git config --global --add safe.directory /home/idv/Code/qemu/ui/keycodemapdb

make clean
./configure --prefix=/usr --enable-kvm --disable-xen --enable-libusb --enable-debug-info --enable-debug --enable-sdl --enable-vhost-net --enable-spice --disable-debug-tcg --enable-opengl --enable-gtk --target-list=x86_64-softmmu --audio-drv-list=oss,alsa,pa --enable-usb-redir --enable-spice &amp;&amp; make -j8
make install
</code></pre>
<p>verification:</p>
<pre><code># ldd /usr/bin/qemu-system-x86_64 | grep dir
	libusbredirparser.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libusbredirparser.so.1 (0x00007ff314eb7000)
</code></pre>
<p>Cleanup:</p>
<pre><code>rm -rf /home/idv/Code
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250302"><a class="header" href="#20250302">20250302</a></h1>
<h3 id="1-gen12-rebuild-qemu"><a class="header" href="#1-gen12-rebuild-qemu">1. gen12 rebuild qemu</a></h3>
<p>Steps for rebuilding:</p>
<pre><code>tar xzvf debs.tar.gz
cd debs
dpkg -i *.deb

mkdir -p /opt/Code
cd /opt/Code
tar xzvf ~/gen12_qemu.tar.gz
cd qemu
mv build build.bak
mkdir build
../configure --prefix=/usr --enable-kvm --disable-xen --enable-libusb --enable-debug-info --enable-debug --enable-sdl --enable-vhost-net --enable-spice --disable-debug-tcg --enable-opengl --target-list=x86_64-softmmu --disable-tcg --audio-drv-list=alsa,oss,pa --enable-spice --enable-spice-protocol --enable-libusb --enable-usb-redir
make -j8
make install
</code></pre>
<p>Verification:</p>
<pre><code>root@test-Standard-PC-Q35-ICH9-2009:/opt/Code/qemu/build# ldd /usr/bin/qemu-system-x86_64 | grep red
	libusbredirparser.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libusbredirparser.so.1 (0x00007f3a6c800000)
root@test-Standard-PC-Q35-ICH9-2009:/opt/Code/qemu/build# qemu-system-x86_64 --version
QEMU emulator version 8.0.1 (v8.0.1-dirty)
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developer
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250303"><a class="header" href="#20250303">20250303</a></h1>
<h3 id="1-redir-documentation"><a class="header" href="#1-redir-documentation">1. redir documentation</a></h3>
<p>Write the redir documentation.</p>
<h3 id="2-system-benchmark"><a class="header" href="#2-system-benchmark">2. system benchmark</a></h3>
<p>Download system benchmark from:</p>
<p><code>https://www.passmark.com/products/pt_linux/download.php</code></p>
<p>Then after install <code>libncurses5</code>, run it for benchmark.</p>
<p>ubuntu 24.04 arm64(rpi 4):</p>
<pre><code># vim  /etc/apt/sources.list.d/ubuntu-focal-sources.list 
deb http://mirrors.ustc.edu.cn/ubuntu-ports focal-security main universe
# apt update -y
# apt install -y  libncurses5
</code></pre>
<h3 id="3-nixos---install-passmark"><a class="header" href="#3-nixos---install-passmark">3. nixos - install passmark</a></h3>
<p>Should have all-cross gfw environment.</p>
<p>nixshell:</p>
<pre><code>export NIXPKGS_ALLOW_UNFREE=1
NIX_CURL_FLAGS=-L
nix-shell -p passmark-performancetest
</code></pre>
<p>Then in home.nix:</p>
<pre><code>NIX_CURL_FLAGS=-L
nix-shell -p passmark-performancetest
</code></pre>
<h3 id="4-perf-data"><a class="header" href="#4-perf-data">4. perf data</a></h3>
<p>x86:</p>
<pre><code>CPU;ZHAOXIN KaiXian KX-U6780A@2.7GHz (x86_64);Hygon C86-3G (OPN:3350) (x86_64);13th Gen Intel Core i5-13400 (x86_64);Intel Core i5-14400 (x86_64);AMD Ryzen 5 4500 6-Core Processor (x86_64);ZHAOXIN KaiXian KX-U6780A@2.7GHz (x86_64)-Huanghe;ZHAOXIN KaiXian KX-7000/8@3.6GHz (x86_64);12th Gen Intel Core i3-12100 (x86_64);Intel Core i9-10900 CPU @ 2.80GHz (x86_64);Intel Celeron CPU  J1900  @ 1.99GHz (x86_64);11th Gen Intel Core i7-1165G7 @ 2.80GHz (x86_64);Intel Core i7-10700 CPU @ 2.90GHz (x86_64);N100 With ddr5;Intel Core i7-8750H CPU @ 2.20GHz (x86_64);Intel Core i5-10400 CPU @ 2.90GHz (x86_64);Intel Core i3-8100 CPU @ 3.60GHz (x86_64);AMD Ryzen 5 5600G with Radeon Graphics (x86_64);
Cores;8 cores @ 2700 MHz;8 cores @ 3000 MHz;10 cores @ 4600 MHz;10 cores @ 4700 MHz;6 cores @ 3600 MHz;8 cores @ 2700 MHz;8 cores @ 3400 MHz;4 cores @ 4200 MHz;10 cores @ 5200 MHz;4 cores @ 2415 MHz;4 cores @ 4700 MHz;8 cores @ 4800 MHz; N100 with ddr5; 6 cores @ 4100 MHz;6 cores @ 4300 MHz;4 cores @ 3600 MHz ;6 cores @ 4464 MHz;
Memory Size; 15.2 GiB RAM;15.5 GiB RAM;125.6 GiB RAM;14.9 GiB RAM;23.3 GiB RAM;15.1 GiB RAM;14.4 GiB RAM;7.0 GiB RAM; 62.6 GiB RAM;3.7 GiB RAM; 15.3 GiB RAM; 31.3 GiB RAM; 16 GiB RAM; 23.4 GiB RAM; 14.7 GiB RAM;15.5 GiB RAM;121.7 GiB RAM;
Number of Processes; 8;16;16;16;12;8;8;8;20;4;8;16;4;12;12;4;12;
CPU Mark;                          3090;11345;27892;21232;13864;4055;8404;11786;21800;942;12899;12888;6198;11734;13110;6536;21376;
Integer Math;                     7722 Million Operations/s;49754 Million Operations/s;84314 Million Operations/s;84459 Million Operations/s;51686 Million Operations/s;10372 Million Operations/s;29447 Million Operations/s; 35055 Million Operations/s;84665 Million Operations/s;5644 Million Operations/s;37209 Million Operations/s;51214 Million Operations/s; 17507 Million Operations/s;42929 Million Operations/s;43924 Million Operations/s;17394 Million Operations/s;68861 Million Operations/s;
Floating Point Math;              5047 Million Operations/s;20091 Million Operations/s;59050 Million Operations/s;55218 Million Operations/s;30918 Million Operations/s;6917 Million Operations/s;23324 Million Operations/s;25261 Million Operations/s;52064 Million Operations/s;1301 Million Operations/s;19918 Million Operations/s;31478 Million Operations/s;10594 Million Operations/s;25843 Million Operations/s;27446 Million Operations/s;15037 Million Operations/s;38501 Million Operations/s;
Prime Numbers;                    11.9 Million Primes/s;20.4 Million Primes/s;95.4 Million Primes/s;49.6 Million Primes/s;20.4 Million Primes/s;15.2 Million Primes/s;56.4 Million Primes/s;37.5 Million Primes/s;54.4 Million Primes/s;3.9 Million Primes/s;48.6 Million Primes/s;29.7 Million Primes/s; 25.0 Million Primes/s; 32.6 Million Primes/s;30.3 Million Primes/s;26.0 Million Primes/s;62.8 Million Primes/s;
Sorting;                          7483 Thousand Strings/s;17775 Thousand Strings/s;42122 Thousand Strings/s;29023 Thousand Strings/s;19675 Thousand Strings/s;11573 Thousand Strings/s;15535 Thousand Strings/s;16735 Thousand Strings/s;40072 Thousand Strings/s;2676 Thousand Strings/s;20563 Thousand Strings/s;19978 Thousand Strings/s; 9632 Threaded Strings/s; 19197 Thousand Strings/s;25615 Thousand Strings/s;10404 Thousand Strings/s;34170 Thousand Strings/s;
Encryption;                       1379 MB/s;15158 MB/s;19506 MB/s;17989 MB/s;14425 MB/s;1876 MB/s;3407 MB/s;7815 MB/s;11105 MB/s;242 MB/s;8757 MB/s;6320 MB/s;4706 MB/s; 5006 MB/s;6086 MB/s;2237 MB/s;17785 MB/s;
Compression;                      52803 KB/s;206949 KB/s;322672 KB/s;269731 KB/s;231489 KB/s;69570 KB/s;103116 KB/s;131006 KB/s;299985 KB/s;25947 KB/s;149778 KB/s;196672 KB/s; 66MB/s;153119 KB/s;195468 KB/s; 87612 KB/s;254250 KB/s;
CPU Single Threaded;              823 Million Operations/s;1715 Million Operations/s;3767 Million Operations/s;3299 Million Operations/s;2726 Million Operations/s;853 Million Operations/s;1701 Million Operations/s;2756 Million Operations/s;3321 Million Operations/s;644 Million Operations/s;3157 Million Operations/s;2312 Million Operations/s; 2080 Million Operations/s; 2491 Million Operations/s;2796 Million Operations/s;2267 Million Operations/s;3258 Million Operations/s;
Physics;                          281 Frames/s;400 Frames/s;2185 Frames/s;711 Frames/s;366 Frames/s;352 Frames/s;521 Frames/s;655 Frames/s;895 Frames/s;99.6 Frames/s;950 Frames/s; 502 Frames/s; 552 Frames/s; 754 Frames/s; 637 Frames/s;421 Frames/s;1432 Frames/s;
Extended Instructions (SSE);      1726 Million Matrices/s;6296 Million Matrices/s;19494 Million Matrices/s;15112 Million Matrices/s;13631 Million Matrices/s;2117 Million Matrices/s;4153 Million Matrices/s;8427 Million Matrices/s;15814 Million Matrices/s;408 Million Matrices/s;8933 Million Matrices/s; 9615 Million Matrices/s; 3292 Million Matrices/s; 8277 Million Matrices/s;9412 Million Matrices/s;6378 Million Matrices/s;13896 Million Matrices/s;
Memory Mark;                       1400;2291;3144;2298;2292;1496;1046;2288; 3267;689;2741;2463;2602;2562;3117;2533;3218;
Database Operations;              1280 Thousand Operations/s;3696 Thousand Operations/s;9833 Thousand Operations/s;5148 Thousand Operations/s;3517 Thousand Operations/s;2017 Thousand Operations/s;2770 Thousand Operations/s;4452 Thousand Operations/s;7484 Thousand Operations/s;593 Thousand Operations/s;4609 Thousand Operations/s;5085 Thousand Operations/s; 2055 Thousand Operations/s; 4589 Thousand Operations/s;5386 Thousand Operations/s;3462 Thousand Operations/s;5777 Thousand Operations/s;
Memory Read Cached;               9708 MB/s;22326 MB/s;34284 MB/s;29818 MB/s;28760 MB/s;9776 MB/s;7614 MB/s;24946 MB/s;35523 MB/s;5384 MB/s;32239 MB/s;24685 MB/s; 19195 MB/s;27172 MB/s;29793 MB/s;24984 MB/s;33598 MB/s;
Memory Read Uncached;             6769 MB/s;15739 MB/s;17528 MB/s;14925 MB/s;14231 MB/s;6862 MB/s;5746 MB/s;16002 MB/s;14664 MB/s;4270 MB/s;18486 MB/s;13120 MB/s; 13519 MB/s; 16334 MB/s;15880 MB/s;14593 MB/s;22940 MB/s;
Memory Write;                     6071 MB/s;7572 MB/s;15981 MB/s;7982 MB/s;6636 MB/s;6151 MB/s;5280 MB/s;9163 MB/s;12702 MB/s;2708 MB/s; 13795 MB/s; 7261 MB/s; 10395 MB/s;14128 MB/s;12540 MB/s;8129 MB/s;14628 MB/s;
Available RAM;                    10262 Megabytes;14617 Megabytes;122316 Megabytes;14066 Megabytes;21374 Megabytes;12643 Megabytes;1955 Megabytes;5281 Megabytes;61945 Megabytes; 1256 Megabytes;8570 Megabytes; 25156 Megabytes; 10200 Megabytes;3541 Megabytes; 12859 Megabytes;14728 Megabytes;120031 Megabytes;
Memory Latency;                   60 Nanoseconds;49 Nanoseconds;53 Nanoseconds;55 Nanoseconds;47 Nanoseconds;58 Nanoseconds;69 Nanoseconds; 45 Nanoseconds; 35 Nanoseconds;71 Nanoseconds; 51 Nanoseconds; 36 Nanoseconds; 27 Nanoseconds; 32 Nanoseconds; 30 Nanoseconds; 33 Nanoseconds; 49 Nanoseconds;
Memory Threaded;                  17505 MB/s;21830 MB/s;55495 MB/s;19427 MB/s;16716 MB/s;21190 MB/s;13172 MB/s; 23200 MB/s; 27150 MB/s; 6776 MB/s; 43237 MB/s; 16910 MB/s; 28587 MB/s; 30700 MB/s;26497 MB/s; 16762 MB/s;42430 MB/s;
URL;https://www.passmark.com/baselines/V11/display.php?id=508831244305;https://www.passmark.com/baselines/V11/display.php?id=508831528847;https://www.passmark.com/baselines/V11/display.php?id=508831414480;https://www.passmark.com/baselines/V11/display.php?id=508831957240;https://www.passmark.com/baselines/V11/display.php?id=508831528847;
</code></pre>
<p>arm64:</p>
<pre><code>CPU Model, D3000 (aarch64),FTC663 (aarch64),Apple M4 (arm64),Radxa ROCK 5B+  (aarch64),"Raspberry Pi 4 Model B Rev 1.4","Kunpeng-920(aarch64)",lenovo x13s
CPU Frequenty, 8 cores @ 2500 MHz,8 cores @ 0 MHz,10 cores @ 0 MHz,"8 cores @ 1800 MHz",4 cores @ 1800 MHz,8 Cores @ 0 MHZ, 8 Cores @ 0 MHZ
RAM,  15.0 GiB RAM,15.5 GiB RAM,16.0 GiB RAM,15.6 GiB RAM,7.6 GiB RAM,15.6 GiB RAM, 15.6 GiB RAM
Number of Processes,8,8,10,8,4,8,8
CPU Mark,5653,2882,23520,"3103",615,3647,12303
Integer Math,                     28632 Million Operations/s,30922 Million Operations/s,49724 Million Operations/s,26311 Million Operations/s,11625 Million Operations/s,28948 Million Operations/s,36857 Million Operations/s
Floating Point Math,              29756 Million Operations/s,10910 Million Operations/s,50198 Million Operations/s,13136 Million Operations/s,4440 Million Operations/s,10115 Million Operations/s,27344 Million Operations/s
Prime Numbers,                    49.4 Million Primes/s,24.6 Million Primes/s,255 Million Primes/s,13.9 Million Primes/s,3.1 Million Primes/s,31.9 Million Primes/s,43 Million Primes/s
Sorting,                          21738 Thousand Strings/s,13491 Thousand Strings/s,33591 Thousand Strings/s,14092 Thousand Strings/s,3278 Thousand Strings/s,17248 Thousand Strings/s,23587 Thousand Strings/s
Encryption,                       1349 MB/s,621 MB/s,14651 MB/s,668 MB/s,78.0 MB/s,772 MB/s,7812 MB/s
Compression,                      37718 KB/s,22233 KB/s,294065 KB/s,23524 KB/s, 8481 KB/s, 29844 KB/s, 167854 KB/s
CPU Single Threaded,              1271 Million Operations/s,610 Million Operations/s,4775 Million Operations/s,983 Million Operations/s,469 Million Operations/s,674 Million Operations/s, 2513 Million Operations/s
Physics,                          729 Frames/s,356 Frames/s,2392 Frames/s,328 Frames/s,74.7 Frames/s,528 Frames/s,662 Frames/s
Extended Instructions (NEON),     5438 Million Matrices/s, 2000 Million Matrices/s,14236 Million Matrices/s,2509 Million Matrices/s,778 Million Matrices/s,3491 Million Matrices/s, 5921 Million Matrices/s
Memory Mark,1631,1058,4496,1153,719,1083, 2726,
Database Operations,              4905 Thousand Operations/s,2712 Thousand Operations/s,9125 Thousand Operations/s,2794 Thousand Operations/s,614 Thousand Operations/s,3047 Thousand Operations/s, 5629 Thousand Operations/s
Memory Read Cached,               9523 MB/s,8344 MB/s,31910 MB/s,11065 MB/s,6044 MB/s,8672 MB/s, 22633 MB/s
Memory Read Uncached,             8887 MB/s,5111 MB/s,31523 MB/s,11121 MB/s,3880 MB/s,3862 MB/s, 21131 MB/s
Memory Write,                     12668 MB/s,8767 MB/s,32808 MB/s,8517 MB/s,2964 MB/s,5385 MB/s, 22562 MB/s
Available RAM,                    13471 Megabytes,14816 Megabytes,6808 Megabytes,15056 Megabytes,6832 Megabytes,3633 Megabytes, 8468 Megabytes
Memory Latency,                   76 Nanoseconds,137 Nanoseconds,20 Nanoseconds,161 Nanoseconds,92 Nanoseconds,85 Nanoseconds, 47 Nanoseconds
Memory Threaded,                  42526 MB/s,19732 MB/s,106015 MB/s,21916 MB/s,3915 MB/s,25742 MB/s, 31716 MB/s
</code></pre>
<h3 id="5-perf-graph"><a class="header" href="#5-perf-graph">5. perf graph</a></h3>
<p><img src="./images/2025_03_03_22_12_33_1338x986.jpg" alt="./images/2025_03_03_22_12_33_1338x986.jpg" /></p>
<p><img src="./images/2025_03_03_22_12_56_1319x978.jpg" alt="./images/2025_03_03_22_12_56_1319x978.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250304"><a class="header" href="#20250304">20250304</a></h1>
<h3 id="1-csv-re-org"><a class="header" href="#1-csv-re-org">1. csv re-org</a></h3>
<p>Answer from deepseeker:</p>
<pre><code>1. **使用Excel手动转置**：
   - 打开CSV文件后，选中所有数据（Ctrl+A）。
   - 复制数据（Ctrl+C）。
   - 点击到另一个空白位置，右键选择“以值粘贴特殊”，然后勾选“转置”。
</code></pre>
<p>Operations in libreoffice:</p>
<p><code>Paste-&gt; Paste special -&gt; Transpose</code></p>
<p>Then sort the column, then generate the graph.</p>
<h3 id="2-heif-in-nixos"><a class="header" href="#2-heif-in-nixos">2. heif in nixos</a></h3>
<p>Install following packages:</p>
<pre><code>$ sudo vim /etc/nixos/home.nix
...
nautilus
libheif
eog
...
$ sudo vim /etc/nixos/configuration.nix
...
  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
    vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.
    wget
    git
    dconf
  libimobiledevice
  ifuse 
  libheif
  libheif.out
  ];

environment.pathsToLink = [ "share/thumbnailers" ];
...
$  sudo nixos-rebuild switch --option substituers https://mirror.sjtu.edu.cn/nix-channels/store
</code></pre>
<p>Then you could view heif files under nautilus, then select eog for openning it.</p>
<h3 id="3-image-formatter"><a class="header" href="#3-image-formatter">3. image formatter</a></h3>
<p><img src="./images/20250304_151848_x.jpg" alt="./images/20250304_151848_x.jpg" /></p>
<p>markdown writer:</p>
<pre><code>docker run -d -p 28080:80 doocs/md:latest
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250305"><a class="header" href="#20250305">20250305</a></h1>
<h3 id="1-docker-related"><a class="header" href="#1-docker-related">1. docker related</a></h3>
<p>Build kbox steps:</p>
<pre><code>cd /home/
cd auto_compile/
apt update -y
apt install -y vim
apt install -y build-essential openssh-client
apt install -y wget
wget https://mirrors.huaweicloud.com/kunpeng/archive/kunpeng_solution/ARMNative/BoostKit24.0.0_Demo/Kbox_Demo/Kbox-AOSP11.zip
apt install -y unzip sudo
unzip Kbox-AOSP11.zip 
cd Kbox-AOSP11
cd /home/auto_compile/Kbox-AOSP11/make_img_sample/kbox11_android_build
vim kbox11_android_build.sh 
DNS=223.5.5.5
cd /home/auto_compile/Kbox-AOSP11/make_img_sample/kbox11_android_build
mkdir -p package
# ls /root/kbox/
BoostKit-kbox_6.0.0_11.zip       Kbox-AOSP11.zip         libva-2.14.0.tar.gz     mesa-22.1.7.tar.xz   patchForExagear.zip
ExaGear_ARM32-ARM64_V2.5.tar.gz  drm-libdrm-2.4.111.zip  llvm-13.0.1.src.tar.xz  meson-0.63.2.tar.gz  vmi-CloudPhone.zip
</code></pre>
<p>get the source code of aosp:</p>
<pre><code>export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
sudo curl https://mirrors.bfsu.edu.cn/git/git-repo -o /usr/local/bin/repo
sudo chmod 777 /usr/local/bin/repo 
git config --global user.email "ddd@hhh.com"
git config --global user.name "ddd"
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-11.0.0_r48
repo sync -j12
</code></pre>
<h3 id="2-openeuler-2203-sp3"><a class="header" href="#2-openeuler-2203-sp3">2. openeuler 22.03-sp3</a></h3>
<p><img src="./images/20250305_171853_858x234.jpg" alt="./images/20250305_171853_858x234.jpg" /></p>
<p><img src="./images/20250305_172018_1196x755.jpg" alt="./images/20250305_172018_1196x755.jpg" /></p>
<p>reformat:</p>
<p><img src="./images/20250305_172144_1283x582.jpg" alt="./images/20250305_172144_1283x582.jpg" /></p>
<p><img src="./images/20250305_172346_1171x533.jpg" alt="./images/20250305_172346_1171x533.jpg" /></p>
<p>create user:</p>
<p><img src="./images/20250305_172409_1296x481.jpg" alt="./images/20250305_172409_1296x481.jpg" /></p>
<p>After installation:</p>
<p><img src="./images/20250305_172930_878x235.jpg" alt="./images/20250305_172930_878x235.jpg" /></p>
<pre><code># vi /etc/default/grub
cgroup_enable=memory swapaccount=1
# grub2-mkconfig -o /boot/efi/EFI/openEuler/grub.cfg
# vi /etc/selinux/config 
disabled
# echo "fs.inotify.max_user_instances=8192" &gt;&gt; /etc/sysctl.conf
# sudo sed -e 's|http://repo.openeuler.org/|https://mirrors.ustc.edu.cn/openeuler/|g' \
         -e 's|https://mirrors.openeuler.org/|https://mirrors.ustc.edu.cn/openeuler/|g' \
         -i.bak \
         /etc/yum.repos.d/openEuler.repo
# yum install -y make dpkg dpkg-devel openssl openssl-devel ncurses ncurses-devel bison flex bc libdrm build elfutils-libelf-devel patch gcc
</code></pre>
<p>Kernel should downloaded from:</p>
<pre><code>https://gitee.com/openeuler/kernel/repository/archive/5.10.0-182.0.0.zip
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250306"><a class="header" href="#20250306">20250306</a></h1>
<h3 id="1-openeuler-kernel-building"><a class="header" href="#1-openeuler-kernel-building">1. openEuler kernel building</a></h3>
<p>Get files:</p>
<pre><code>https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/firmware/linux-firmware-20210919.tar.gz
kernel-5.10.0-182.0.0.zip
ExaGear_ARM32-ARM64_V2.5.tar.gz
</code></pre>
<p>Install kernel:</p>
<pre><code>[root@phone openEuler_deploy]# ./kbox_install_kernel.sh /root/patch/

</code></pre>
<h3 id="2-ollama-listening-port"><a class="header" href="#2-ollama-listening-port">2. ollama listening port</a></h3>
<p>Change to listening on <code>0.0.0.0</code>:</p>
<pre><code>dash@ai:~$ sudo vim /etc/systemd/system/ollama.service 
...
[Service]
Environment="OLLAMA_HOST=0.0.0.0"
ExecStart=/usr/local/bin/ollama serve

...
$ sudo systemctl daemon-reload
$ sudo systemctl restart ollama
</code></pre>
<h3 id="3-comfyui-wan21"><a class="header" href="#3-comfyui-wan21">3. comfyui wan2.1</a></h3>
<p><img src="./images/20250306_164143_1222x430.jpg" alt="./images/20250306_164143_1222x430.jpg" /></p>
<p>Solved via:</p>
<pre><code>dash@ai:~/Code/Comfy/ComfyUI$ vim ./user/default/ComfyUI-Manager/config.ini
...
security_level = weak

...

</code></pre>
<p>workflow:</p>
<pre><code>https://github.com/kijai/ComfyUI-WanVideoWrapper/blob/main/example_workflows/wanvideo_480p_I2V_example_02.json

</code></pre>
<p><img src="./images/20250306_164914_804x595.jpg" alt="./images/20250306_164914_804x595.jpg" /></p>
<p>too many missing nodes.</p>
<p><img src="./images/20250306_171834_898x423.jpg" alt="./images/20250306_171834_898x423.jpg" /></p>
<p>channel should be dev channel.</p>
<p>Refers to :    <code>https://www.youtube.com/watch?v=gdoRVlJH218</code></p>
<h3 id="4-comfyui-update"><a class="header" href="#4-comfyui-update">4. comfyui update</a></h3>
<p>update failed, but you could re update via:</p>
<pre><code>python custom_nodes/ComfyUI-Manager/cm-cli.py update all 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="202350307"><a class="header" href="#202350307">202350307</a></h1>
<h3 id="wan-models"><a class="header" href="#wan-models">Wan models</a></h3>
<p>Position:</p>
<pre><code>ls ~/dmx/
mv ~/dmx/umt5-xxl-enc-bf16.safetensors models/text_encoders/
mv ~/dmx/open-clip-xlm-roberta-large-vit-huge-14_visual_fp16.safetensors models/clip
cp -r ~/dmx/wanvideo models/vae/
rm -rf ~/dmx/wanvideo
mv ~/dmx/WanVideo/ models/diffusion_models/
</code></pre>
<p>sub-directory info:</p>
<pre><code>(comfyui) dash@comfyvm:~/Code/ComfyUI$ ls models/vae/wanvideo/
Wan2_1_VAE_bf16.safetensors
(comfyui) dash@comfyvm:~/Code/ComfyUI$ ls models/diffusion_models/WanVideo/
Wan2_1-I2V-14B-480P_fp8_e4m3fn.safetensors  Wan2_1-T2V-14B_fp8_e4m3fn.safetensors
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250308"><a class="header" href="#20250308">20250308</a></h1>
<h3 id="1-xrandr-issue"><a class="header" href="#1-xrandr-issue">1. xrandr issue</a></h3>
<p>Specify the position:</p>
<pre><code>xrandr --output eDP1 --mode 1920x1080 --pos 0x0 --rotate normal --output HDMI-0 --mode 2560x1440 --pos 1920x0 --rotate normal
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250310"><a class="header" href="#20250310">20250310</a></h1>
<h3 id="1-nixos-x86"><a class="header" href="#1-nixos-x86">1. nixos x86</a></h3>
<p>Get the installation iso:</p>
<pre><code>axel https://mirrors.tuna.tsinghua.edu.cn/nixos-images/nixos-24.11/latest-nixos-gnome-x86_64-linux.iso
axel https://mirrors.tuna.tsinghua.edu.cn/nixos-images/nixos-24.11/latest-nixos-minimal-x86_64-linux.iso; axel https://mirrors.tuna.tsinghua.edu.cn/nixos-images/nixos-24.11/latest-nixos-gnome-aarch64-linux.iso; axel https://mirrors.tuna.tsinghua.edu.cn/nixos-images/nixos-24.11/latest-nixos-minimal-aarch64-linux.iso
</code></pre>
<p>Write iso to disk.</p>
<p>Installation cdrom is gnome based:</p>
<p><img src="./images/20250310_125349_801x443.jpg" alt="./images/20250310_125349_801x443.jpg" /></p>
<p>Open the terminal and change the passwd for nixos user:</p>
<p><img src="./images/20250310_125531_309x81.jpg" alt="./images/20250310_125531_309x81.jpg" /></p>
<pre><code># cat parted.sh
parted /dev/nvme0n1 -- mklabel gpt
parted /dev/nvme0n1 -- mkpart ESP fat32 1MB 512MB
parted /dev/nvme0n1 -- mkpart primary 512MB -2GB
parted /dev/nvme0n1 -- mkpart swap linux-swap -2GB 100%
parted /dev/nvme0n1 -- set 1 esp on
 
mkfs.fat -F 32 -n boot /dev/nvme0n1p1
mkfs.btrfs -L NIXOS /dev/nvme0n1p2
mkswap -L swap /dev/nvme0n1p3
# ./parted.sh
# lsblk
...
nvme0n1     259:0    0 953.9G  0 disk 
├─nvme0n1p1 259:1    0   487M  0 part 
├─nvme0n1p2 259:2    0 951.5G  0 part 
└─nvme0n1p3 259:3    0   1.9G  0 part
</code></pre>
<h3 id="2-redsocks-related"><a class="header" href="#2-redsocks-related">2. redsocks related</a></h3>
<p>Generate the chnroute.txt:</p>
<pre><code>curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\| '{ printf("%s/%d\n", $4, 32-log($5)/log(2)) }' &gt; chnroute.txt
</code></pre>
<p>The content of <code>redsocks.sh</code> is listed:</p>
<pre><code>#! /bin/sh

case "$1" in
  start|"")
    cd /home/nixos/redsocks
    if [ -e redsocks.log ] ; then
      rm redsocks.log
    fi
    redsocks -p /home/nixos/redsocks/redsocks.pid #set daemon = on in config file
    # start redirection
    #iptables -t nat -A OUTPUT -d 192.168.0.0/16 -j RETURN
    #iptables -t nat -A OUTPUT -d 10.10.0.0/16 -j RETURN
    #iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to 12345
    #iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to 12345
    # Create new chain
    iptables -t nat -N REDSOCKS

    # Ignore LANs and some other reserved addresses.
    iptables -t nat -A REDSOCKS -d 0.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 10.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 100.64.0.0/10 -j RETURN
    iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 169.254.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 172.16.0.0/12 -j RETURN
    iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 198.18.0.0/15 -j RETURN
    iptables -t nat -A REDSOCKS -d 224.0.0.0/4 -j RETURN
    iptables -t nat -A REDSOCKS -d 240.0.0.0/4 -j RETURN
    
    # Anything else should be redirected to port 12345
    iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports 12345
    ;;

  stop)
    cd /home/nixos/redsocks
    if [ -e redsocks.pid ]; then
      kill `cat redsocks.pid`
      rm redsocks.pid
    else
      echo already killed, anyway, I will try killall
      killall -9 redsocks
    fi
    # stop redirection
    #iptables -t nat -F OUTPUT
    iptables -t nat -F REDSOCKS
    ;;

  start_ssh)
    #ssh -NfD 1234 user@example.cc #TODO: change it!!!
    ssh -NfD 1234 544644af4382ec37bc0009da@weatherapp-kkkttt.rhcloud.com
    ;;

  stop_ssh)
    ps aux|grep "ssh -NfD 1234"|awk '{print $2}'|xargs kill
    ;;

  clean_dns)
    iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED -m gfw -j DROP -m comment --comment "drop gfw dns hijacks"
    ;;

  *)
    echo "Usage: redsocks start|stop|start_ssh|stop_ssh|clean_dns" &gt;&amp;2
    exit 3
    ;;
esac
</code></pre>
<p>the redsocks environment could be activated via:</p>
<pre><code>nix-shell -p redsocks
</code></pre>
<p>After start redsocks, do following for adding rules:</p>
<pre><code>cat /home/nixos/chnroute.txt | xargs -I % iptables -t nat -A REDSOCKS -d % -j RETURN
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250311"><a class="header" href="#20250311">20250311</a></h1>
<h3 id="1-rockylinux-nvidia"><a class="header" href="#1-rockylinux-nvidia">1. rockylinux nvidia</a></h3>
<p>Steps:</p>
<pre><code>sudo dnf install epel-release -y
sudo dnf groupinstall "Development Tools" -y
sudo dnf install kernel-devel dkms -y
sudo dnf config-manager --add-repo http://developer.download.nvidia.com/compute/cuda/repos/rhel9/$(uname -i)/cuda-rhel9.repo
sudo yum install -y ./kernel-devel-matched-5.15.113-zdyun.el9.x86_64.rpm ./kernel-devel-5.15.113-zdyun.el9.x86_64.rpm
sudo dnf install  kernel-devel-$(uname -r) tar bzip2 make automake gcc gcc-c++ pciutils elfutils-libelf-devel libglvnd-opengl libglvnd-glx libglvnd-devel acpid pkgconf dkms -y
sudo dnf module install nvidia-driver:latest-dkms -y
sudo grubby --args="nouveau.modeset=0 rd.driver.blacklist=nouveau" --update-kernel=ALL
sudo reboot
</code></pre>
<p>After reboot, the nvidia-smi could be used:</p>
<pre><code>[root@minirocky92 test]# nvidia-smi 
Tue Mar 11 09:08:25 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 570.124.06             Driver Version: 570.124.06     CUDA Version: 12.8     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA GeForce RTX 4070        Off |   00000000:01:00.0 Off |                  N/A |
| 31%   36C    P8              9W /  200W |       6MiB /  12282MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI              PID   Type   Process name                        GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
</code></pre>
<h3 id="2-rocky-deployment"><a class="header" href="#2-rocky-deployment">2. rocky deployment</a></h3>
<p>Steps:</p>
<pre><code>scp -r dash@192.168.1.8:/media/sda/apparmor .
cd apparmor/
sudo yum install -y tar
tar xzvf apparmor_kernels.tar.gz 
tar xzvf i915.tar.gz 
sudo mv /lib/firmware/i915/ /lib/firmware/i915.bak
sudo cp -r i915 /lib/firmware/
cd rpms/
sudo yum install -y bison elfutils-libelf-devel flex gcc make openssl-devel perl-interpreter ./kernel-5.15.113-zdyun.el9.x86_64.rpm ./kernel-devel-5.15.113-zdyun.el9.x86_64.rpm ./kernel-modules-5.15.113-zdyun.el9.x86_64.rpm ./kernel-modules-internal-5.15.113-zdyun.el9.x86_64.rpm ./kernel-modules-extra-5.15.113-zdyun.el9.x86_64.rpm  ./kernel-core-5.15.113-zdyun.el9.x86_64.rpm vim pciutils openssh-server
sudo grubby --args="i915.enable_guc=0x7 udmabuf.list_limit=8192 intel_iommu=on i915.force_probe=* modprobe.blacklist=evbug" --update-kernel=ALL
sudo ./qie.sh 
sudo lspci | grep -i vga

</code></pre>
<h3 id="3-nixos-working-tips"><a class="header" href="#3-nixos-working-tips">3. nixos working tips</a></h3>
<p>In installation steps:</p>
<pre><code>nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixpkgs-unstable nixpkgs
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-24.11 nixos

nix-channel --list
nix-channel --update
nixos-generate-config --root /mnt
</code></pre>
<p>Edit the configuration.nix file, then:</p>
<pre><code>cd /mnt
nixos-install --show-trace --option substituters https://mirror.sjtu.edu.cn/nix-channels/store
</code></pre>
<p>After installation, the kernel will be in <code>6.12.x</code>.</p>
<p>Specify this version, or it will automatically use 6.6.x version:</p>
<pre><code>boot.kernelPackages = pkgs.linuxPackages_6_12;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250312"><a class="header" href="#20250312">20250312</a></h1>
<h3 id="1-disable-ipv6linux"><a class="header" href="#1-disable-ipv6linux">1. disable ipv6(linux)</a></h3>
<p>via:</p>
<pre><code>sysctl -w net.ipv6.conf.all.disable_ipv6=1
sysctl -w net.ipv6.conf.default.disable_ipv6=1
</code></pre>
<h3 id="2-quick-setup-nixos"><a class="header" href="#2-quick-setup-nixos">2. quick-setup nixos</a></h3>
<p>via selecting the correct store channel(almost all of the pkgs are fetched from cache), we will get quick setup.</p>
<pre><code>nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixpkgs-unstable nixpkgs
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-24.11 nixos
nix-channel --list
nix-channel --update
nixos-generate-config --root /mnt
vim /mnt/etc/nixos/configuration.nix
nixos-install --show-trace --option substituters https://mirrors.ustc.edu.cn/nix-channels/store
</code></pre>
<p>Reboot, introducing <code>/etc/nixos/flake.nix&lt;home.nix&gt;</code>, then :</p>
<pre><code>nixos-rebuild switch --option  substituters https://mirrors.ustc.edu.cn/nix-channels/store
</code></pre>
<p>Issue:</p>
<p><img src="./images/20250312_110105_927x468.jpg" alt="./images/20250312_110105_927x468.jpg" /></p>
<p><img src="./images/20250312_111808_933x222.jpg" alt="./images/20250312_111808_933x222.jpg" /></p>
<p>Solved via(cross-gfw):</p>
<pre><code>dash@mynix:~/ &gt; scp dash@192.168.1.210:~/nix_redsocks.tar.gz .
nix_redsocks.tar.gz                                                              100%   27KB   3.1MB/s   00:00    
dash@mynix:~/ &gt; tar xzvf nix_redsocks.tar.gz 
redsocks/
redsocks/redsocks.sh
redsocks/redsocks.conf
redsocks/chnroute.txt
redsocks/redsocks.pid
dash@mynix:~/ &gt; sudo su
root@mynix:/home/dash/ &gt; cd redsocks 
root@mynix:/home/dash/redsocks/ &gt; ./redsocks.sh start
root@mynix:/home/dash/redsocks/ &gt; cat chnroute.txt| xargs -I % iptables -t nat -A OUTPUT -d % -j RETURN
</code></pre>
<p>Then re-launch the rebuild script, notice should choose cernet:</p>
<pre><code>nixos-rebuild switch --option  substituters https://mirrors.cernet.edu.cn/nix-channels/store
</code></pre>
<p>Difference:</p>
<p><img src="./images/20250312_114601_934x640.jpg" alt="./images/20250312_114601_934x640.jpg" /></p>
<p>reason:</p>
<p><img src="./images/20250312_143959_824x140.jpg" alt="./images/20250312_143959_824x140.jpg" /></p>
<p>Change to correct repository:</p>
<pre><code>sudo nixos-rebuild switch --option substituters  "https://mirrors.sjtug.sjtu.edu.cn/nix-channels/store"
</code></pre>
<h3 id="3-dual-vms-in-i9"><a class="header" href="#3-dual-vms-in-i9">3. dual vms in i9</a></h3>
<p>Ignore, for no reason to do this.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250313"><a class="header" href="#20250313">20250313</a></h1>
<h3 id="1-zeroomega"><a class="header" href="#1-zeroomega">1. ZeroOmega</a></h3>
<p>Use ZeroOmega for replacing the SwitchOmega.<br />
SmartProxy is not well suitable for my working environment.</p>
<h3 id="2-nixos-awesome"><a class="header" href="#2-nixos-awesome">2. nixos awesome</a></h3>
<p>From <code>https://git.renn.es/tarneo/nix</code>, get <code>https://github.com/Misterio77/nix-starter-configs</code></p>
<h3 id="3-lenovo-usb-hub"><a class="header" href="#3-lenovo-usb-hub">3. lenovo usb hub</a></h3>
<p>Insert hub:</p>
<pre><code>dash@aiBox:~$ sudo lsusb
Bus 004 Device 002: ID 174c:3074 ASMedia Technology Inc. ASM1074 SuperSpeed hub
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 004: ID 05e3:0608 Genesys Logic, Inc. Hub
Bus 003 Device 003: ID 05e3:0608 Genesys Logic, Inc. Hub
Bus 003 Device 002: ID 174c:2074 ASMedia Technology Inc. ASM1074 High-Speed hub
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
dash@aiBox:~$ sudo lsusb
Bus 004 Device 002: ID 174c:3074 ASMedia Technology Inc. ASM1074 SuperSpeed hub
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 004: ID 05e3:0608 Genesys Logic, Inc. Hub
Bus 003 Device 003: ID 05e3:0608 Genesys Logic, Inc. Hub
Bus 003 Device 010: ID 0e5c:6119 Bitland Information Technology Co., Ltd remote receive and control device
Bus 003 Device 009: ID 0e5c:6441 Bitland Information Technology Co., Ltd C-Media Sound Device
Bus 003 Device 008: ID 0424:2507 Microchip Technology, Inc. (formerly SMSC) hub
Bus 003 Device 002: ID 174c:2074 ASMedia Technology Inc. ASM1074 High-Speed hub
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub

</code></pre>
<p>This equipment works well, using earphone.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250314"><a class="header" href="#20250314">20250314</a></h1>
<h3 id="1-awesome"><a class="header" href="#1-awesome">1. awesome</a></h3>
<p>Change awesome configurations for nixos.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250315"><a class="header" href="#20250315">20250315</a></h1>
<h3 id="nixos-working-tips"><a class="header" href="#nixos-working-tips">nixos working tips</a></h3>
<p>pavucontrol for controlling the pnmixer.</p>
<p><img src="./images/2025_03_17_19_57_20_495x466.jpg" alt="./images/2025_03_17_19_57_20_495x466.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250316"><a class="header" href="#20250316">20250316</a></h1>
<h3 id="1-part-for-nvme-ssd"><a class="header" href="#1-part-for-nvme-ssd">1. part for nvme ssd</a></h3>
<p>Scripts:</p>
<pre><code>parted /dev/nvme0n1 -- mklabel gpt
parted /dev/nvme0n1 -- mkpart ESP fat32 1MB 512MB
parted /dev/nvme0n1 -- mkpart primary 512MB -2GB
parted /dev/nvme0n1 -- mkpart swap linux-swap -2GB 100%
parted /dev/nvme0n1 -- set 1 esp on
 
mkfs.fat -F 32 -n boot /dev/nvme0n1p1
mkfs.btrfs -L NIXOS /dev/nvme0n1p2
mkswap -L swap /dev/nvme0n1p3

mount /dev/disk/by-label/NIXOS /mnt
mkdir -p /mnt/boot
mount /dev/disk/by-label/boot /mnt/boot
swapon /dev/nvme0n1p3
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250317"><a class="header" href="#20250317">20250317</a></h1>
<h3 id="1-graphical-setup-for-xxxos"><a class="header" href="#1-graphical-setup-for-xxxos">1. graphical setup for xxxOS</a></h3>
<p>repo position:</p>
<pre><code># cat /etc/yum.repos.d/ctyunos.repo 
[everything]
name=CTyunOS - everything
baseurl=http://repo.ctyun.cn/hostos/ctyunos-2.0.1/everything/$basearch/
enabled=1
gpgcheck=
</code></pre>
<h3 id="2-fan-speed-for-tower"><a class="header" href="#2-fan-speed-for-tower">2. fan speed for tower</a></h3>
<p>Still the same when you changed in i9 server.</p>
<p><img src="./images/2025_03_17_19_09_46_794x562.jpg" alt="./images/2025_03_17_19_09_46_794x562.jpg" /></p>
<h3 id="3-integrate-conky-into-awesome"><a class="header" href="#3-integrate-conky-into-awesome">3. integrate conky into awesome</a></h3>
<p>my conky configuration:</p>
<pre><code>conky.config = {
    xinerama_head = 2,
    alignment = 'top_right',
    use_xft = true,
    xftalpha = 0.8,
    font = 'Noto:normal:size=8',
    text_buffer_size = 2048,
    update_interval = 1.0,
    total_run_times = 0,
    background = true,
    double_buffer = true,
    no_buffers = true,
    imlib_cache_size = 0,
    cpu_avg_samples = 2,
    own_window = true,
    own_window_class = 'Conky',
    own_window_argb_visual = true,
    own_window_argb_value = 50,
    own_window_transparent = false,
    own_window_type = 'override',
    own_window_hints = 'undecorated,below,skip_taskbar,sticky,skip_pager',
    own_window_colour = '000000',
    draw_shades = no,
    default_shade_color = '000000',
    draw_outline = yes,
    default_outline_color = '000000',
    draw_borders = false,
    border_width = 2,
    gap_x = 5,
    gap_y = 30,
    minimum_height = 0,
    minimum_width = 0,
    draw_graph_borders = true,
    show_graph_scale = yes,
    show_graph_range = yes,
    short_units = yes,
    override_utf8_locale = yes,
    format_human_readable = yes,
    uppercase = no,
    default_color = 'ffffff',
    color1 = '22b4ac',
    color2 = '8308FF',
    color3 = '83FF08',
    color4 = '0883FF',
    color5 = 'FF0883',
    color6 = 'FF8308',
    color7 = '000000',
    use_spacer = none,
}
conky.text = [[
# day/time
${font Noto:normal:size=9}${goto 5}Date:${color3}${goto 50}${time %d %b %Y}${color}${goto 165}Up:${color3}${alignr 5}$uptime
${goto 5}${color}Kernel:${goto 60}${color3}${kernel}${color}${alignr 5}Host: ${color3}${exec hostname}
#Processor section
${color2}${hr}${color}
${color3}${font Noto:normal:size=9}${goto 5}${exec cat /proc/cpuinfo|grep 'model name'|sed -e 's/model name.*: //'| uniq }${color} @ ${color3}${freq_g 1}GHz${color}${alignr -5}Mode: ${color3}${exec cat /sys/devices/system/cpu/cpu1/cpufreq/scaling_governor | awk '{print $1}'}${color}
${color}${font}${goto 5}Avg CPU Load: ${color6}${cpu cpu0}% ${alignr 5}${color4}${cpubar cpu0 10,145}
${goto 10}${color7}${cpugraph cpu0 20,255 83FF08 FF0883 -t}
#${goto 5}${color}Current Vcore: ${color6}${execi 1 sensors | grep 'Vcore' | cut -c 27-35} ${alignr 5}${color}Max Vcore: ${color1}${execi 1 sensors | grep 'Vcore' | cut -c 61-67}
#
#Cores
${font Noto:normal:size=8}${goto 5}${color}C1/T1: ${color6}${cpu cpu1}% ${goto 75}${color4}${cpubar cpu1 10,55} ${goto 145}${color}C1/T2: ${color6}${cpu cpu2}% ${goto 215}${color4}${cpubar cpu2 10,55}
${goto 10}${color7}${cpugraph cpu1 20,110 83FF08 FF0883 -t} ${alignr 10}${color7}${cpugraph cpu2 20,110 83FF08 FF0883 -t}
${color}${goto 5}C2/T1: ${color6}${cpu cpu3}% ${goto 75}${color4}${cpubar cpu3 10,55} ${goto 135}${color}${goto 145}C2/T2: ${color6}${cpu cpu4}% ${goto 215}${color4}${cpubar cpu4 10,55}
${goto 10}${color7}${cpugraph cpu3 20,110 83FF08 FF0883 -t} ${alignr 10}${color7}${cpugraph cpu4 20,110 83FF08 FF0883 -t}
#
#Thermal
${color}${goto 10}C1 Thermal: ${color6}${exec sensors|grep 'Core 0'|awk '{print $3}'}${goto 160}${color}C2 Thermal: ${color6}${exec sensors|grep 'Core 1'|awk '{print $3}'}
${color7}${goto 10}${execigraph 1 "sensors|grep 'Core 0'| cut -c 17-20" 20,110 83FF08 FF0883 -t} ${alignr 10}${execigraph 1 "sensors|grep 'Core 1'| cut -c 17-20" 20,110 83FF08 FF0883 -t}
${color}${goto 10}C3 Thermal: ${color6}${exec sensors|grep 'Core 2'|awk '{print $3}'}${goto 160}${color}C4 Thermal: ${color6}${exec sensors|grep 'Core 3'|awk '{print $3}'}
${color7}${goto 10}${execigraph 1 "sensors|grep 'Core 2'| cut -c 17-20" 20,110 83FF08 FF0883 -t} ${alignr 10}${execigraph 1 "sensors|grep 'Core 3'| cut -c 17-20" 20,110 83FF08 FF0883 -t}
#
#
# top processes
${color3}${goto 10}${top name 1}${alignr 10}${color3}${top cpu 1}%
${color}${goto 10}${top name 2}${alignr 10}${color6}${top cpu 2}%
${color}${goto 10}${top name 3}${alignr 10}${color6}${top cpu 3}%
#
#
${color2}${hr}${color}
# top memory
${goto 10}${color}Current RAM Usage: ${alignr 10}${color6}${mem} - ${memperc}%
${goto 10}${color7}${memgraph 20,110 83FF08 FF0883 -t}${alignr 10}${color4}${membar 20,110}
${goto 10}${color}Current SWAP Usage: ${alignr 10}${color6}${swap} - ${swapperc}%
${goto 10}${color7}${execgraph "top -b -n1 | grep -e Swap | cut -c 44-49 | sed 's/$/\/8192/' | bc -l | cut -c 1-4 | sed 's/$/*100/' | bc | cut -c 1-2" 20,110 83FF08 FF0883 -t}${alignr 10}${color4}${swapbar 20,110}
${goto 10}${color3}${top_mem name 1}${alignr 10}${color3}${top mem 1}%
${color}${goto 10}${top_mem name 2}${alignr 10}${color6}${top mem 2}%
${color}${goto 10}${top_mem name 3}${alignr 10}${color6}${top mem 3}%
#
#
# GPU Section
${color2}${hr}
##------------Card1-------------##
${color}${alignc}${font Noto:normal:size=9}iGPU: ${color3}${exec lspci | grep VGA | cut -c 36-68}${font}${color}
${color}${goto 10}GPU Spd: ${color6}${execi 1 "cat /sys/class/drm/card1/gt_cur_freq_mhz"}MHz${alignr 10}${color}Max GPU Spd: ${color6}${exec cat /sys/class/drm/card1/gt_max_freq_mhz}MHz
${color7}${goto 5}${execigraph 1 "cat /sys/class/drm/card1/gt_cur_freq_mhz | sed 's/$/\/1100/' | bc -l | sed 's/$/*100/' | bc | cut -c 1-2" 20,265 83FF08 FF0883 -t}
#
#
#network
${color2}${hr}${color}
${color}${font}${goto 10}Internal IP: ${color6}${alignr 10}${addr eth0}
${font}${goto 10}${color}Up Spd:   ${color6}${upspeed }${goto 140}${color}Down Spd: ${alignr 10}${color6}${downspeed eth0}
${color}${goto 10}Total Up: ${color6}${totalup }${goto 140}${color}Total Dn: ${alignr 10}${color6}${totaldown eth0}
${goto 10}${color7}${upspeedgraph  20,110 83FF08 FF0883 -t}${alignr 10}${color7}${downspeedgraph eth0 20,110 83FF08 FF0883 -t}
${color}${font}${goto 10}Internal IP: ${color6}${alignr 10}${addr eth1}
${font}${goto 10}${color}Up Spd:   ${color6}${upspeed }${goto 140}${color}Down Spd: ${alignr 10}${color6}${downspeed eth1}
${color}${goto 10}Total Up: ${color6}${totalup }${goto 140}${color}Total Dn: ${alignr 10}${color6}${totaldown eth1}
${goto 10}${color7}${upspeedgraph  20,110 83FF08 FF0883 -t}${alignr 10}${color7}${downspeedgraph eth1 20,110 83FF08 FF0883 -t}
#
#Storage
${color2}${hr}${color}
#${goto 10}${color}Disk I/O Scheduler: ${color2}${alignr 10}${ioscheduler /dev/nvme}
${goto 10}${color}NVME Disk I/O:    
${goto 10}${color}Read: ${color6}${goto 90}${diskio_read nvme0n1}${goto 140}${color}Write: ${color6}${alignr 10}${diskio_write nvme0n1}
${goto 10}${color7}${diskiograph_read /dev/nvme0n1 20,110 83FF08 FF0883 -l -t}${alignr 10}${diskiograph_write /dev/nvme0n1 20,110 83FF08 FF0883 -l -t}
#${goto 10}${color}Sys:      ${alignr 10}${color6}${fs_used /}${color}  /  ${color3}${alignr 10}${fs_size /} ${color6}(${fs_free_perc /}% free)
${goto 10}${color}Home:      ${alignr 10}${color6}${fs_used /home}${color}  /  ${color3}${alignr 10}${fs_size /home} ${color6}(${fs_free_perc /home}% free)
#${alignc}${color}NVME Temp: ${color6}${exec sudo nvme smart-log /dev/nvme0n1 -H | grep 'Temperature Sensor 1' | cut -c 34-38} 
#${goto 10}${color6}
]]

</code></pre>
<p>Awesome startup tips(add sleep items for delay conky startup):</p>
<pre><code>run_once("sleep 1 &amp;&amp; xrandr --output HDMI-1 --mode 1920x1080 --left-of HDMI-2")
run_once("sleep 10 &amp;&amp; conky -c /home/dash/.config/awesome/conky_intel.conf")
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250318"><a class="header" href="#20250318">20250318</a></h1>
<h3 id="1-virtualizationunder-2206"><a class="header" href="#1-virtualizationunder-2206">1. virtualization(under 22.06)</a></h3>
<p>Commands in xxxOS:</p>
<pre><code>yum install -y virt-manager edk2-ovmf libvirt-client libvirt-daemon-driver-qemu qemu-kvm libvirt-daemon-driver-storage libvirt*
yum install -y ninja-build spice-server-devel SDL2-devel alsa-utils-devel  alsa-utils-devel alsa-utils alsa-lib alsa-lib-devel alsa-tools alsa-tools-devel pulseaudio-libs-dev
grubby --args="iommu=pt amd_iommu=on pcie_acs_override=downstream,multifunction" --update-kernel=ALL
systemctl enable libvirtd --now &amp;&amp; reboot
</code></pre>
<p>After reboot:</p>
<pre><code># virsh list --all
 Id   名称   状态
-------------------
# grubby --args="vfio-pci.ids=1002:6613,1002:aab0" --update-kernel=ALL
# vim /etc/modprobe.d/vfio.conf
options vfio-pci ids=1002:6611,1002:aab0
# vim /etc/modules-load.d/vfio.conf
vfio-pci
# reboot
</code></pre>
<p>Now examine the driver status of gpu:</p>
<pre><code># lspci -vvnn -s 06:00.0 | grep -i 'in use'
	Kernel driver in use: vfio-pci
# lspci -vvnn -s 06:00.1 | grep -i 'in use'
	Kernel driver in use: vfio-pci
</code></pre>
<p>Build qemu(6.2.0):</p>
<pre><code>wget https://download.qemu.org/qemu-6.2.0.tar.xz
tar cJvf qemu-6.2.0.tar.xz
Build error:      
ERROR: You need at least GCC v7.4 or Clang v6.0 (or XCode Clang v10.0)
</code></pre>
<p>6.0.0:</p>
<pre><code> wget https://download.qemu.org/qemu-6.0.0.tar.xz
 tar xJvf qemu-6.0.0.tar.xz 
 cd qemu-6.0.0
./configure --prefix=/opt/local --enable-kvm --disable-xen --enable-libusb --enable-debug-info --enable-debug --enable-sdl --enable-vhost-net --enable-spice --disable-debug-tcg --enable-opengl --enable-gtk --target-list=x86_64-softmmu --audio-drv-list=oss,alsa,pa --enable-usb-redir --enable-spice
make -j16
make install
/opt/local/bin/qemu-system-x86_64 --version
QEMU emulator version 6.0.0
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers
</code></pre>
<p>Prepare the disk:</p>
<pre><code>scp little_win10.qcow2  root@192.168.1.70:/var/lib/libvirt/images/
qemu-img create -f qcow2 -b little_win10.qcow2 win10_amd.qcow2
Copy the llllllittle_win10_VARS.fd to :   
cp llllllittle_win10_VARS.fd   /var/lib/libvirt/qemu/nvram/win10amd_VARS.fd
</code></pre>
<p>Win10amd.xml is fetched from gist, then:</p>
<pre><code>virsh define Win10amd.xml
virsh start win10amd
</code></pre>
<p>The kernel output:</p>
<pre><code>it pref]
[  921.373281] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373402] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373518] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373634] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373749] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373864] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]
[  921.373979] vfio-pci 0000:06:00.0: BAR 0: can't reserve [mem 0x3fff0000000-0x3ffffffffff 64bit pref]

</code></pre>
<p>Won't startup:</p>
<p><img src="./images/2025_03_18_19_40_52_1430x640.jpg" alt="./images/2025_03_18_19_40_52_1430x640.jpg" /></p>
<h3 id="2-enable-tips"><a class="header" href="#2-enable-tips">2. enable tips</a></h3>
<p>should add following:</p>
<pre><code>grubby --args="video=efifb:off" --update-kernel=ALL
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250319"><a class="header" href="#20250319">20250319</a></h1>
<h3 id="1-xxxos-2206-verification"><a class="header" href="#1-xxxos-2206-verification">1. xxxos 22.06 verification</a></h3>
<p>Fetch the qcow2 file from dual-launch vm.</p>
<h3 id="2-smplayer-configuration"><a class="header" href="#2-smplayer-configuration">2. smplayer configuration</a></h3>
<p>hardware decode:</p>
<p><img src="./images/2025_03_19_11_00_06_472x322.jpg" alt="./images/2025_03_19_11_00_06_472x322.jpg" /></p>
<p>Video is used:</p>
<p><img src="./images/2025_03_19_11_00_24_955x469.jpg" alt="./images/2025_03_19_11_00_24_955x469.jpg" /></p>
<h3 id="3-xxxos-vmlaunch-rescuezilla"><a class="header" href="#3-xxxos-vmlaunch-rescuezilla">3. xxxos vmlaunch rescuezilla</a></h3>
<p>Enable the nested hypervisor:</p>
<pre><code># cat /sys/module/kvm_intel/parameters/nested 
Y
</code></pre>
<p>TBD in tomorrow.</p>
<h3 id="4-chrome-issuedevice"><a class="header" href="#4-chrome-issuedevice">4. chrome issue(device)</a></h3>
<p>chrome stucks(xrandr shows virtual display):</p>
<pre><code>      services={
          xserver = {
              enable = true;
              videoDrivers = [
             #"intel"
             "intel"
             "modesetting"
             "fbdev"
              ];
              deviceSection = ''
  Option "VirtualHeads" "2"
              ''; 
              exportConfiguration = true
</code></pre>
<p>Chrome not stucks:</p>
<pre><code>      services={
          xserver = {
              enable = true;
              videoDrivers = [
             #"intel"
             "modesetting"
             "fbdev"
             "intel"
              ];
              deviceSection = ''
  Option "VirtualHeads" "2"
              ''; 
              exportConfiguration = true
</code></pre>
<p>Solved via(DRI-2):</p>
<pre><code>              deviceSection = ''
  Option "VirtualHeads" "2"
  #Option  "SwapbuffersWait"  "false"
  Option  "DRI" "2"
              ''; 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250320"><a class="header" href="#20250320">20250320</a></h1>
<h3 id="1-xxxos-audio"><a class="header" href="#1-xxxos-audio">1. xxxOS Audio</a></h3>
<p>enable the system-level pulseaudio, change the qemu configuration. then everything will be OK.</p>
<p>Choose between 2 equipments:</p>
<p><img src="./images/2025_03_20_10_02_23_409x350.jpg" alt="./images/2025_03_20_10_02_23_409x350.jpg" /></p>
<p><img src="./images/2025_03_20_10_02_46_324x109.jpg" alt="./images/2025_03_20_10_02_46_324x109.jpg" /></p>
<pre><code>  &lt;qemu:commandline&gt;
    &lt;qemu:arg value='-device'/&gt;
    &lt;qemu:arg value='ich9-intel-hda,bus=pcie.0,addr=0x1b'/&gt;
    &lt;qemu:arg value='-device'/&gt;
    &lt;qemu:arg value='hda-micro,audiodev=hda'/&gt;
    &lt;qemu:arg value='-audiodev'/&gt;
    &lt;qemu:arg value='pa,id=hda,server=unix:/var/run/pulse/native'/&gt;
  &lt;/qemu:commandline&gt;
</code></pre>
<h3 id="2-mpv-issue"><a class="header" href="#2-mpv-issue">2. mpv issue</a></h3>
<p>start issue:</p>
<pre><code> mpv mybao.mp4 
● Video  --vid=1               (av1 3840x2160 25 fps) [default]
● Audio  --aid=1  --alang=eng  (aac 2ch 44100 Hz 128 kbps) [default]
[vo/gpu/opengl] Suspected software renderer or indirect context.
[vo/gpu/drm] VT_GETMODE failed: Inappropriate ioctl for device
[vo/gpu/drm] Failed to set up VT switcher. Terminal switching will be unavailable.
[vo/gpu/drm] Failed to acquire DRM master: Permission denied
[vo/gpu/drm] Failed to commit ModeSetting atomic request: Permission denied
[vo/gpu/opengl] Failed to set CRTC for connector 189: Permission denied
[vo/gpu] Failed to commit atomic request: Permission denied
[vo/gpu/drm] Failed to commit ModeSetting atomic request: Permission denied
[vo/gpu/drm] Failed to restore previous mode
[vo/gpu/drm] Failed to drop DRM master: Permission denied
vulkan: No DRI3 support detected - required for presentation
Note: you can probably enable DRI3 in your Xorg config
[vo/gpu/libplacebo] Found no suitable device, giving up.
[vo/gpu/libplacebo] Failed initializing vulkan device
[vo/gpu] Failed initializing any suitable GPU context!
Error opening/initializing the selected video_out (--vo) device.
Video: no video


</code></pre>
<h3 id="3-issue-for-xxxos"><a class="header" href="#3-issue-for-xxxos">3. issue for xxxos</a></h3>
<p>re install kernel then everything goest ok:</p>
<pre><code>yum reinstall /root/kernel-4.19.90-2102.2.0.0068.ctl2.x86_64.rpm
 grubby --args="iommu=pt amd_iommu=on pcie_acs_override=downstream,multifunction video=efifb:off vfio-pci.ids=1002:6613,1002:aab0 net.ifnames=0 biosdevname=0" --update-kernel="$(grubby --default-kernel)"

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250321"><a class="header" href="#20250321">20250321</a></h1>
<h3 id="1-fcitx5-input-issue"><a class="header" href="#1-fcitx5-input-issue">1. fcitx5 input issue</a></h3>
<p>fcitx5 could be used in alacritty, but on gnome-terminal, not OK.</p>
<h3 id="2-debian-fix-bootloader"><a class="header" href="#2-debian-fix-bootloader">2. debian fix bootloader</a></h3>
<p>Not working under debian 12 installation iso:</p>
<p><img src="./images/2025_03_21_11_59_37_875x273.jpg" alt="./images/2025_03_21_11_59_37_875x273.jpg" /></p>
<p><img src="./images/2025_03_21_12_03_41_690x175.jpg" alt="./images/2025_03_21_12_03_41_690x175.jpg" /></p>
<h3 id="3-d3000-ubuntu-docker-images"><a class="header" href="#3-d3000-ubuntu-docker-images">3. d3000 ubuntu docker images</a></h3>
<p>ubuntu24.04 graphical arm64 installation:</p>
<pre><code>sudo apt update -y &amp;&amp; sudo apt upgrade -y
sudo apt install -y ubuntu-desktop
sudo apt install -y nethogs
sudo apt install -y virt-manager
sudo apt install -y libvirt-clients-qemu qemu-system
sudo systemctl set-default graphical.target

</code></pre>
<h3 id="4-sleep-infinite-docker"><a class="header" href="#4-sleep-infinite-docker">4. sleep infinite docker</a></h3>
<p>Created via:</p>
<pre><code>test@d3000:~/ubuntudaemon$ cat Dockerfile 
FROM jhq888:latest
CMD ["/bin/bash", "-c", "echo 'Container running'; sleep infinity"]
test@d3000:~/ubuntudaemon$ !39
sudo docker build -t jhq8888 .
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

Sending build context to Docker daemon  2.048kB
Step 1/2 : FROM jhq888:latest
 ---&gt; d771e925d4bd
Step 2/2 : CMD ["/bin/bash", "-c", "echo 'Container running'; sleep infinity"]
 ---&gt; Running in 2c5836d6c277
 ---&gt; Removed intermediate container 2c5836d6c277
 ---&gt; d6609764b96f
Successfully built d6609764b96f
Successfully tagged jhq8888:latest
test@d3000:~/ubuntudaemon$ !40
sudo docker run -itd --name kkk888 jhq8888:latest
b3f09540d3cd81ea78205805148d7d51157f5d37ab82293861934020bf223aa6
test@d3000:~/ubuntudaemon$ sudo docker ps
CONTAINER ID   IMAGE            COMMAND                  CREATED         STATUS         PORTS     NAMES
b3f09540d3cd   jhq8888:latest   "/bin/bash -c 'echo …"   3 seconds ago   Up 2 seconds             kkk888
test@d3000:~/ubuntudaemon$ sudo docker ps
CONTAINER ID   IMAGE            COMMAND                  CREATED         STATUS         PORTS     NAMES
b3f09540d3cd   jhq8888:latest   "/bin/bash -c 'echo …"   6 seconds ago   Up 5 seconds             kkk888

</code></pre>
<h3 id="5-fcitx5-input-issue"><a class="header" href="#5-fcitx5-input-issue">5. fcitx5 input issue</a></h3>
<p>possible solution:</p>
<pre><code>具体的表现就像一个漏风的牙齿，输入的字母没有全部在 fcitx5 的输入面板上，部分泄漏到 chrome 或 vscode 的输入部件中
解决办法，先通过 fcitx5-diagnose 命令查看诊断日志
会提示 gtk query cache 相关问题
修复

# 进入 root shell，确保 GTK_PATH 设置生效
sudo -s
# 编译安装的fcitx5的 immoudle在该目录
export GTK_PATH=/usr/local/lib/gtk-3.0

# 更新 cache
/usr/lib/x86_64-linux-gnu/libgtk-3-0/gtk-query-immodules-3.0 --update-cache

# 查询 cache，确保 fcitx5 的moudule生效
/usr/lib/x86_64-linux-gnu/libgtk-3-0/gtk-query-immodules-3.0


同理处理 gtk2 的
export GTK_PATH=/usr/local/lib/gtk-2.0
/usr/lib/x86_64-linux-gnu/libgtk2.0-0/gtk-query-immodules-2.0 --update-cache
/usr/lib/x86_64-linux-gnu/libgtk2.0-0/gtk-query-immodules-2.0

gtk4 的因为机制变更，目前貌似误解，可以尝试（不一定有效）

sudo mkdir /usr/lib/x86_64-linux-gnu/gtk-4.0/4.0.0/immodules
sudo cp /usr/local/lib/gtk-4.0/4.0.0/immodules/libim-fcitx5.so /usr/lib/x86_64-linux-gnu/gtk-4.0/4.0.0/immodules


2025-03-18 ubuntu 24.04 上问题的解决：

sudo apt install -y \
  fcitx5-frontend-gtk2 \
  fcitx5-frontend-gtk3 \
  fcitx5-frontend-gtk4 \
  fcitx5-frontend-qt5 \
  fcitx5-frontend-qt6

# 或者
sudo apt install -y fcitx5-frontend-all
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250322"><a class="header" href="#20250322">20250322</a></h1>
<h3 id="1-nixos-fcitx5-comparison"><a class="header" href="#1-nixos-fcitx5-comparison">1. nixos fcitx5 comparison</a></h3>
<p>sddm:</p>
<div class="table-wrapper"><table><thead><tr><th>机型</th><th>配置</th><th>fcitx5表现</th><th>视频播放、解码表现</th></tr></thead><tbody>
<tr><td>N100(ADL-N), 32G内存, 双屏1080P</td><td>nixos24.11+sddm+awesome</td><td>fcitx5无法在终端模拟器gnome-terminal下输入，在chrome下输入存在漏字现象</td><td>激活xorg-video-intel后，无法硬件解码，modesetting+fbdev下硬件解码正常</td></tr>
<tr><td>i3-8100, 16G内存， 单屏4K</td><td>nixos24.11+sddm+awesome</td><td>fcitx5无法在gnome-terminal下输入，chrome下输入正常</td><td>xorg-video-intel下正常</td></tr>
<tr><td>NUC11 i7-1165G7, 48G内存, 单屏4K</td><td>nixos24.11+sddm+awesome</td><td>fcitx5无法在gnome-terminal下输入，chrome下输入正常</td><td>xorg-video-intel下正常</td></tr>
</tbody></table>
</div>
<p>gdm based:</p>
<div class="table-wrapper"><table><thead><tr><th>机型</th><th>配置</th><th>fcitx5表现</th><th>视频播放、解码表现</th></tr></thead><tbody>
<tr><td>N100(ADL-N), 32G内存, 双屏1080P</td><td>nixos24.11+gdm(xorg)+awesome</td><td>未验证</td><td>未验证</td></tr>
<tr><td>i3-8100, 16G内存， 单屏4K</td><td>nixos24.11+gdm(xorg)+awesome</td><td>fcitx5可在gnome-terminal下输入，chrome下输入正常</td><td>xorg-video-intel下正常</td></tr>
<tr><td>NUC11 i7-1165G7, 48G内存, 单屏4K</td><td>nixos24.11+gdm(xorg)+awesome</td><td>fcitx5可在gnome-terminal下输入，chrome下输入正常</td><td>xorg-video-intel下正常</td></tr>
</tbody></table>
</div>
<h3 id="2-n100-performance-issue"><a class="header" href="#2-n100-performance-issue">2. N100 performance issue</a></h3>
<p><img src="./images/2025_03_22_10_51_18_1169x382.jpg" alt="./images/2025_03_22_10_51_18_1169x382.jpg" /></p>
<p><img src="./images/2025_03_22_10_51_48_1159x1013.jpg" alt="./images/2025_03_22_10_51_48_1159x1013.jpg" /></p>
<p><img src="./images/2025_03_22_10_52_08_1175x893.jpg" alt="./images/2025_03_22_10_52_08_1175x893.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250323"><a class="header" href="#20250323">20250323</a></h1>
<h3 id="1-restore-vm"><a class="header" href="#1-restore-vm">1. restore vm</a></h3>
<p>URL:</p>
<pre><code>https://serverfault.com/questions/677341/state-of-vm-after-virsh-save
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250324"><a class="header" href="#20250324">20250324</a></h1>
<h3 id="1-vimium-map-keys"><a class="header" href="#1-vimium-map-keys">1. vimium map keys</a></h3>
<p>Enable ctrl+f for forwardinig and ctrl+b for up:</p>
<pre><code>map &lt;c-f&gt; scrollFullPageDown
map &lt;c-b&gt; scrollFullPageU
</code></pre>
<p><img src="./images/2025_03_24_09_50_47_747x366.jpg" alt="./images/2025_03_24_09_50_47_747x366.jpg" /></p>
<h3 id="2-vm-resume"><a class="header" href="#2-vm-resume">2. vm resume</a></h3>
<p>possible solution:</p>
<pre><code>virsh dompmsuspend win10 disk
win10 is my domain and just virsh start as usual to start the vm.

This is my &lt;pm&gt; block on the xml

&lt;pm&gt;
    &lt;suspend-to-mem enabled='yes'/&gt;
    &lt;suspend-to-disk enabled='yes'/&gt;
&lt;/pm&gt;
</code></pre>
<h3 id="3-deb-contains-files"><a class="header" href="#3-deb-contains-files">3. deb contains files</a></h3>
<p>via :</p>
<pre><code>apt-file list ovmf
</code></pre>
<h3 id="4-managedsave-domain"><a class="header" href="#4-managedsave-domain">4. managedsave domain</a></h3>
<p>issue:</p>
<pre><code>dash@aiBox:~$ sudo virsh managedsave 0000_test_suspend_ubuntu22.04
error: Failed to save domain '0000_test_suspend_ubuntu22.04' state
error: Operation not supported: cannot migrate a domain with &lt;hostdev mode='subsystem' type='pci'&gt;

</code></pre>
<h3 id="5-hibernate-issue"><a class="header" href="#5-hibernate-issue">5. hibernate issue</a></h3>
<p>should have seperate swap partition:</p>
<pre><code>vda    253:0    0    60G  0 disk 
├─vda1 253:1    0   512M  0 part /boot/efi
├─vda2 253:2    0  51.5G  0 part /var/snap/firefox/common/host-hunspell
│                                /
└─vda3 253:3    0     8G  0 part [SWAP]
test@testsuspend:~$ free -m
               total        used        free      shared  buff/cache   available
Mem:            7904        1539        5155          33        1208        6096
Swap:           8199           0        8199
test@testsuspend:~$ cat /etc/default/grub | grep resume
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID=9155b004-c472-4eaa-addf-217b13046b5b"
$ cat /etc/fstab  | grep swap
#/swapfile                                 none            swap    sw              0       0
UUID=9155b004-c472-4eaa-addf-217b13046b5b                                 none            swap    sw              0       0
$ sudo update-initramfs -u
</code></pre>
<p>Then in host:</p>
<pre><code>dash@aiBox:~$ sudo virsh dompmsuspend 0000_test_suspend_ubuntu22.04 disk
Domain '0000_test_suspend_ubuntu22.04' successfully suspended
dash@aiBox:~$ sudo virsh start 0000_test_suspend_ubuntu22.04
Domain '0000_test_suspend_ubuntu22.04' started

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250325"><a class="header" href="#20250325">20250325</a></h1>
<h3 id="1-vm-pm-hibernate--resume"><a class="header" href="#1-vm-pm-hibernate--resume">1. vm pm-hibernate &amp;&amp; resume</a></h3>
<p>steps1: create hibernate-enabled vm images.</p>
<p>Step2: install quick-launch in host vm(ubuntu180406)</p>
<h3 id="2-install-pyqt5-on-ubuntu1804"><a class="header" href="#2-install-pyqt5-on-ubuntu1804">2. install pyqt5 on ubuntu18.04</a></h3>
<p>Steps:</p>
<pre><code># python3 -m pip install -U pip -i https://pypi.tuna.tsinghua.edu.cn/simple
#  python3 -m pip --version
pip 21.3.1 from /usr/local/lib/python3.6/dist-packages/pip (python 3.6)
# pip3 install pyqt5==5.15.2 -i https://pypi.tuna.tsinghua.edu.cn/simple
# python3 -c "from PyQt5.Qt import PYQT_VERSION_STR; print(PYQT_VERSION_STR)"
5.15.2
</code></pre>
<h3 id="3-vfio-pre-defined"><a class="header" href="#3-vfio-pre-defined">3. vfio pre-defined</a></h3>
<p>Steps:</p>
<pre><code># systemctl set-default multi-user.target
# ls -l -h /bin/dom-*
lrwxrwxrwx 1 root root 33 3月  25 11:54 /bin/dom-startup.sh -&gt; /etc/libvirt/hooks/dom-startup.sh
lrwxrwxrwx 1 root root 34 3月  25 11:54 /bin/dom-teardown.sh -&gt; /etc/libvirt/hooks/dom-teardown.sh
# cat /bin/dom-startup.sh 
    #!/bin/sh
    virsh start ubuntu2404
# cat /bin/dom-teardown.sh 
    #!/bin/bash
    virsh dompmsuspend ubuntu2404 disk
    sleep 3
    virsh destroy ubuntu2404 disk
# cat /etc/libvirt/hooks/qemu
......
### dom startup
if [[ $OBJECT == "kylin_uefi" ]]; then
        case "$OPERATION" in
                "prepare")
                /bin/dom-teardown.sh 2&gt;&amp;1 | tee -a /var/log/libvirt/custom_hooks.log
                ;;
            "release")
                /bin/dom-startup.sh 2&gt;&amp;1 | tee -a /var/log/libvirt/custom_hooks.log
                ;;
        esac
fi
......
</code></pre>
<p>Modification for vfio:</p>
<pre><code>root@idv-ADL-S:~# cat /etc/default/grub  | grep GRUB_CMDLINE_LINUX_DEFAULT
GRUB_CMDLINE_LINUX_DEFAULT="splash intel_iommu=on intel_iommu=pt kvm.ignore_msrs=1  vfio-pci.ids=8086:4682,8086:7ae0"
root@idv-ADL-S:~# cat /etc/modules
modules         modules-load.d/ 
root@idv-ADL-S:~# cat /etc/modules-load.d/vfio.conf 
vfio-pci
root@idv-ADL-S:~# cat /etc/modprobe.d/vfio.conf 
options vfio-pci ids=8086:4682,8086:7ae0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250326"><a class="header" href="#20250326">20250326</a></h1>
<h3 id="1-arm-windows"><a class="header" href="#1-arm-windows">1. arm windows</a></h3>
<p>Write tips under other folder.</p>
<h3 id="2-markdown-viewer"><a class="header" href="#2-markdown-viewer">2. markdown viewer</a></h3>
<p><img src="./images/2025_03_26_17_27_58_1404x513.jpg" alt="./images/2025_03_26_17_27_58_1404x513.jpg" /></p>
<p><img src="./images/2025_03_26_17_28_23_676x432.jpg" alt="./images/2025_03_26_17_28_23_676x432.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250327"><a class="header" href="#20250327">20250327</a></h1>
<h3 id="1-ubuntu2204-arm64-kvm-hypervisor"><a class="header" href="#1-ubuntu2204-arm64-kvm-hypervisor">1. ubuntu2204 arm64 kvm-hypervisor</a></h3>
<pre><code>root@d3000:/home/test# qemu-system-x86_64 --version
QEMU emulator version 6.2.0 (Debian 1:6.2+dfsg-2ubuntu6.25)
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers
root@d3000:/home/test# libvirtd --version
libvirtd (libvirt) 8.0.0
root@d3000:/home/test# cat /etc/issue
Ubuntu 22.04.5 LTS \n \l

root@d3000:/home/test# uname -a
Linux d3000 5.15.0-135-generic #146-Ubuntu SMP Sat Feb 15 17:31:19 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux

</code></pre>
<p>Running vm:</p>
<p><img src="./images/2025_03_27_09_35_38_819x631.jpg" alt="./images/2025_03_27_09_35_38_819x631.jpg" /></p>
<h3 id="2-hibernate-and-resume-from-partition"><a class="header" href="#2-hibernate-and-resume-from-partition">2. hibernate and resume from partition</a></h3>
<p>Re-allocate the disk space, create a swap file which  equals to ram size.</p>
<p>Host hibernate won't resume the (gpu-passthroughed)vm's video output.</p>
<p>maybe we try newest kernel ?</p>
<h3 id="3-arm64-vfio-windows"><a class="header" href="#3-arm64-vfio-windows">3. arm64 vfio windows</a></h3>
<p>no windows driver for amd 520.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250328"><a class="header" href="#20250328">20250328</a></h1>
<h3 id="1-nvidia-vfio-host-hibernate"><a class="header" href="#1-nvidia-vfio-host-hibernate">1. nvidia vfio host hibernate</a></h3>
<p>Shrink the space for creating a big swap file:</p>
<p><img src="./images/2025_03_28_11_19_20_1521x759.jpg" alt="./images/2025_03_28_11_19_20_1521x759.jpg" /></p>
<p>Under nvidia gpu, the resume runs OK.</p>
<h3 id="2-amdgpu-vfio-host-hibernate"><a class="header" href="#2-amdgpu-vfio-host-hibernate">2. amdgpu vfio host hibernate</a></h3>
<p>amdgpu vendor-reset issue, won't work after wakeup.</p>
<h3 id="3-cuttlefish-on-arm64"><a class="header" href="#3-cuttlefish-on-arm64">3. cuttlefish on arm64</a></h3>
<p>Steps:</p>
<pre><code>apt install -y git devscripts equivs config-package-dev debhelper-compat golang curl libevent build-essential vim git
git clone https://github.com/google/android-cuttlefish
cd android-cuttlefish
tools/buildutils/build_packages.sh


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250329"><a class="header" href="#20250329">20250329</a></h1>
<h3 id="cuttlefish-working-issue"><a class="header" href="#cuttlefish-working-issue">cuttlefish working issue</a></h3>
<p>Start via:</p>
<pre><code> DISPLAY=:0 HOME=$PWD ./bin/launch_cvd --gpu_mode=gfxstream -cpus 8 -memory_mb 10240  -console
ctrl + c
 DISPLAY=:0 HOME=$PWD ./bin/launch_cvd --gpu_mode=gfxstream -cpus 8 -memory_mb 10240 -data_policy resize_up_to -blank_data_image_mb 40960 -console
</code></pre>
<p>Then you could connect with :</p>
<pre><code>adb connect 0.0.0.0:6520
adb shell
</code></pre>
<p>GLES infos:</p>
<pre><code>vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES (Ganesh)------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (AMD Radeon Pro WX 5100 Graphics (polaris10, LLVM 15.0.7, DRM 3.42, 5.15.0-135-generic)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 23.2.1-1ubuntu3.1~22.04.3)

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250330"><a class="header" href="#20250330">20250330</a></h1>
<h3 id="1-cuttlefishcrosvm-with-latest-mesa"><a class="header" href="#1-cuttlefishcrosvm-with-latest-mesa">1. cuttlefish(crosvm) with latest mesa</a></h3>
<p>ubuntu22.04, mesa upgraded to newest version(25.xxx), still failed in YuanShen's ground display.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250331"><a class="header" href="#20250331">20250331</a></h1>
<h3 id="1-kbox-working-tips"><a class="header" href="#1-kbox-working-tips">1. kbox working tips</a></h3>
<p>Create installation iso:</p>
<pre><code>sudo dd if=/media/nfs/openEuler-22.03-LTS-SP3-aarch64-dvd.iso of=/dev/sda bs=10M &amp;&amp; sudo sync 
</code></pre>
<p>After installation(installation steps could refers to <code>20250305</code> workingtips), insert usb ethernet dongle.</p>
<pre><code>sudo yum install -y vim
mkdir kbox_packages
mv 5.10.0-182.0.0.zip kbox_packages/kernel-5.10.0-182.0.0.zip
cp kbox/ExaGear_ARM32-ARM64_V2.5.tar.gz kbox_packages/
cp kbox/linux-firmware-20210919.tar.gz kbox_packages/
cd Kbox-AOSP11/Kbox-AOSP11/deploy_scripts/openEuler_deploy/
 chmod 777 kbox_install_kernel.sh 
./kbox_install_kernel.sh /home/test/kbox_packages/

</code></pre>
<h3 id="2-kbox-on-kunpeng920"><a class="header" href="#2-kbox-on-kunpeng920">2. kbox on kunpeng920</a></h3>
<p>Install with following command:</p>
<p><img src="./images/2025_03_31_14_45_16_1535x258.jpg" alt="./images/2025_03_31_14_45_16_1535x258.jpg" /></p>
<pre><code># cat /etc/default/grub
...
GRUB_CMDLINE_LINUX="video=VGA-1:640x480-32@60me cgroup_disable=files apparmor=0 crashkernel=1024M,high smmu.bypassdev=0x1000:0x17 smmu.bypassdev=0x1000:0x15 console=tty0 cgroup_enable=memory swapaccount=1 initcall_blacklist=hisi_ddrc_pmu_module_init"
...
#  grub2-mkconfig -o /boot/efi/EFI/openEuler/grub.cfg 
</code></pre>
<p>Start:</p>
<pre><code>./android_kbox.sh start  kbox:demo 1
./android_kbox.sh restart 1
</code></pre>
<h3 id="3-docker-for-running-redroid"><a class="header" href="#3-docker-for-running-redroid">3. docker for running redroid</a></h3>
<p>Configure docker:</p>
<pre><code>$ cat /etc/docker/daemon.json 
{
    "registry-mirrors": ["https://docker.nju.edu.cn", "https://docker.mirrors.ustc.edu.cn", "https://docker.1ms.run", "https://docker.xuanyuan.me"]
}
$   sudo systemctl daemon-reload
$  sudo systemctl restart docker
$  sudo docker run -itd --rm --privileged     --pull always     -v ~/data:/data     -p 5555:5555     redroid/redroid:12.0.0_64only-latest
$ sudo docker run -itd --name redroid15 --privileged   -p 5555:5555 -v ~/data:/data  redroid/redroid:15.0.0_64only-latest redroid.width=1080 redroid.height=1920 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250401"><a class="header" href="#20250401">20250401</a></h1>
<h3 id="1-downgrade-ppa-mesa"><a class="header" href="#1-downgrade-ppa-mesa">1. downgrade ppa mesa</a></h3>
<p>Revert to distribution installed mesa.</p>
<pre><code>sudo apt install ppa-purge
sudo ppa-purge ppa:kisak/kisak-mesa
</code></pre>
<h3 id="2-vulkan-issue"><a class="header" href="#2-vulkan-issue">2. vulkan issue</a></h3>
<p>Install:</p>
<pre><code>sudo apt install vulkan-tools mesa-vulkan-drivers -y
sudo apt install libvulkan-dev -y
sudo apt install glslang-tools glslang-dev glslc -y
</code></pre>
<p>then <code>vulkaninfo --summary</code> will be OK.</p>
<h3 id="3-docker-images-show-sha256"><a class="header" href="#3-docker-images-show-sha256">3. docker images show sha256</a></h3>
<p>via <code>docker images --digests</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250402"><a class="header" href="#20250402">20250402</a></h1>
<h3 id="1-waydroid"><a class="header" href="#1-waydroid">1. Waydroid</a></h3>
<p>Outdated android 11 image:</p>
<p><code>https://github.com/waydroid/waydroid/issues/1797</code>.</p>
<h3 id="2-cuttlefish-installation"><a class="header" href="#2-cuttlefish-installation">2. cuttlefish installation</a></h3>
<p>quickly install cuttlefish:</p>
<pre><code>sudo wget -O /etc/apt/trusted.gpg.d/linaro-glt-gig-archive-bookworm.asc https://artifacts.codelinaro.org/artifactory/linaro-372-googlelt-gigabyte-ampere-cuttlefish-installer/gigabyte-ampere-cuttlefish-installer/latest/debian/linaro-glt-gig-archive-bookworm.asc
echo "deb https://artifacts.codelinaro.org/linaro-372-googlelt-gigabyte-ampere-cuttlefish-installer/gigabyte-ampere-cuttlefish-installer/latest/debian bookworm main" | sudo tee /etc/apt/sources.list.d/linaro-glt-gig-archive-bookworm.list
sudo apt update &amp;&amp; sudo apt install --no-install-recommends cuttlefish-base cuttlefish-user cuttlefish-orchestration
</code></pre>
<h3 id="3-redroid-mesa-issue"><a class="header" href="#3-redroid-mesa-issue">3. redroid mesa issue</a></h3>
<p>Change:</p>
<pre><code>$ vim ./uniform_query.cpp
dash@ai:/media/nvme/kbox/aosp/external/mesa/src/mesa/main$ pwd
/media/nvme/kbox/aosp/external/mesa/src/mesa/main

sh-&gt;Program-&gt;SamplerUnits[unit] = value;
                  GLubyte samplerUnit = sh-&gt;Program-&gt;SamplerUnits[unit];
                  sh-&gt;Program-&gt;SamplerUnits[unit] = samplerUnit % MAX_COMBINED_TEXTURE_IMAGE_UNITS;
</code></pre>
<h3 id="4-xxxos-kbox-working-tips"><a class="header" href="#4-xxxos-kbox-working-tips">4. xxxos kbox working tips</a></h3>
<p>kernel source code :</p>
<pre><code>wget https://gitee.com/openeuler/kernel/repository/archive/5.10.0-136.12.0.zip
mv 5.10.0-136.12.0.zip kernel-5.10.0-136.12.0.zip
</code></pre>
<p>modification:</p>
<pre><code>vim kbox_install_kernel.sh
[root@ctyun openEuler_deploy]# cp kbox_install_kernel.sh kbox_install_kernel_ctyunos.sh 
[root@ctyun openEuler_deploy]# scp kbox_install_kernel_ctyunos.sh dash@192.168.1.8:/media/sda/kbox

cp -r /root/Kbox-AOSP11/patchForKernel/openEuler_22.03/  /root/Kbox-AOSP11/patchForKernel/ctyunos_23.01
[root@ctyun openEuler_deploy]# grub2-mkconfig -o /boot/efi/EFI/ctyunos/grub.cfg 
[root@ctyun openEuler_deploy]# grub_default=$(&lt; /boot/efi/EFI/ctyunos/grub.cfg grep "menuentry"|grep -v "recovery mode\|old"|grep -w "(5.10.0)"|awk -F \' '{print $2}')
[root@ctyun openEuler_deploy]# echo $grub_default
ctyunos (5.10.0) 23.01 2
[root@ctyun openEuler_deploy]# grub2-set-default "${grub_default}"
reboot
</code></pre>
<p>Import docker:</p>
<pre><code>[root@ctyun ~]# systemctl start docker
[root@ctyun ~]# systemctl enable docker
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.
[root@ctyun ~]# docker import android.tar kbox:demo

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250403"><a class="header" href="#20250403">20250403</a></h1>
<h3 id="1-xxxos-issue"><a class="header" href="#1-xxxos-issue">1. xxxos issue</a></h3>
<p>xxxos, kernel is the same as SP-1.<br />
while the kbox based openeuler is SP-3.<br />
So kbox won't startup on xxxos.</p>
<h3 id="2-redroid-building"><a class="header" href="#2-redroid-building">2. redroid building</a></h3>
<p>Modify docker for building:</p>
<pre><code>dash@ai:~$ cat /etc/docker/daemon.json 
{
      "registry-mirrors": [ "https://docker.nju.edu.cn/",
             "https://hub.uuuadc.top",
        "https://docker.anyhub.us.kg",
        "https://dockerhub.jobcher.com",
        "https://dockerhub.icu",
        "https://docker.ckyl.me",
        "https://docker.awsl9527.cn", "https://docker.mirrors.ustc.edu.cn", "https://docker.1ms.run", "https://docker.xuanyuan.me"
      ]
}
</code></pre>
<p>Build docker-build image:</p>
<pre><code>git clone https://github.com/remote-android/redroid-doc.git
cd redroid-doc/android-builder-docker/
vim Dockerfile
- # COPY sources.list etc/apt/sources.list
+ COPY sources.list etc/apt/sources.list
sudo docker build --build-arg userid=$(id -u) --build-arg groupid=$(id -g) --build-arg username=$(id -un) -t redroid-builder .
</code></pre>
<p>Fetching the source code:</p>
<pre><code>mkdir -p /media/nvme/redroid/redroid11
cd /media/nvme/redroid/redroid11
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-11.0.0_r48
git clone https://github.com/remote-android/local_manifests.git .repo/local_manifests -b 11.0.0
repo sync -c
........ failed with some components
./redsocks.sh start
repo sync -c
cd /media/nvme/redroid
git clone https://github.com/remote-android/redroid-patches.git
/media/nvme/redroid/redroid-patches/apply-patch.sh /media/nvme/redroid/redroid11/
</code></pre>
<p>Run building:</p>
<pre><code>sudo docker run -it --hostname redroid-builder --name redroid-builder -v /media/nvme/redroid/redroid11/:/src redroid-builder
cd /src
lunch redroid_arm64-userdebug
m -j20
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250404"><a class="header" href="#20250404">20250404</a></h1>
<h3 id="1-build-redroid11"><a class="header" href="#1-build-redroid11">1. build redroid11</a></h3>
<pre><code>mkdir -p /media/sda/redroid/redroid11
export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-11.0.0_r48
repo sync -j12
$ sudo du -hs redroid11/
81G     redroid11/
git clone https://github.com/remote-android/local_manifests.git  .repo/local_manifests -b 11.0.0
# Using Fanqiang
repo sync -j1 --force-sync
repo forall -c "git lfs pull"
</code></pre>
<p><img src="./images/2025_04_03_19_55_08_1251x367.jpg" alt="./images/2025_04_03_19_55_08_1251x367.jpg" /></p>
<p>Apply patch:</p>
<pre><code>git clone https://github.com/remote-android/redroid-patches.git
dash@aiBox:/media/sda/redroid$ `pwd`/redroid-patches/apply-patch.sh /media/sda/redroid/redroid11/
</code></pre>
<p>Build:</p>
<pre><code>dash@aiBox:/media/sda/redroid/redroid11$ sudo docker run -it --rm --hostname redroid-builder --name redroid-builder -v `pwd`:/src redroid-builder
dash@redroid-builder:/$ cd /src
dash@redroid-builder:/src$ . build/envsetup.sh
dash@redroid-builder:/src$ lunch redroid_arm64-userdebug
dash@redroid-builder:/src$ m -j12

</code></pre>
<p>Create docker images:</p>
<pre><code>dash@aiBox:/media/sda/redroid/redroid11/out/target/product/redroid_arm64$ sudo mount system.img system -o ro
dash@aiBox:/media/sda/redroid/redroid11/out/target/product/redroid_arm64$ sudo mount vendor.img vendor -o ro
dash@aiBox:/media/sda/redroid/redroid11/out/target/product/redroid_arm64$ sudo tar --xattrs -c vendor -C system --exclude="./vendor" . | sudo docker import --platform=linux/arm64 -c 'ENTRYPOINT ["/init", "qemu=1", "androidboot.hardware=redroid"]' - redroid11arm64

$ sudo docker images
REPOSITORY        TAG        IMAGE ID       CREATED          SIZE
redroid11arm64    latest     d5ad1a357273   11 seconds ago   1.66GB
</code></pre>
<p>Inspect the image:</p>
<pre><code>dash@aiBox:/media/sda/redroid/redroid11/out/target/product/redroid_arm64$ sudo umount system vendor
dash@aiBox:/media/sda/redroid/redroid11/out/target/product/redroid_arm64$ sudo docker inspect redroid11arm64:latest | jq '.[0].Config.Entrypoint, .[0].Architecture'
[
  "/init",
  "qemu=1",
  "androidboot.hardware=redroid"
]
"arm64"

</code></pre>
<h3 id="2-build-redroid12"><a class="header" href="#2-build-redroid12">2. build redroid12</a></h3>
<p>Steps:</p>
<pre><code>dash@aiBox:/media/sda/redroid$ mkdir redroid12
dash@aiBox:/media/sda/redroid$ cd redroid12/
dash@aiBox:/media/sda/redroid/redroid12$ export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
dash@aiBox:/media/sda/redroid/redroid12$ repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest --git-lfs  -b  android-12.0.0_r34
dash@aiBox:/media/sda/redroid/redroid12$ repo sync -c -j$(nproc)

</code></pre>
<p>redsocks enabled:</p>
<pre><code>dash@aiBox:/media/sda/redroid/redroid12$ git clone https://github.com/remote-android/local_manifests.git  .repo/local_manifests -b 12.0.0
repo sync -c -j$(nproc)

</code></pre>
<h3 id="3-build-redroid15"><a class="header" href="#3-build-redroid15">3. build redroid15</a></h3>
<p>Steps:</p>
<pre><code>mkdir cuttlefish15
cd cuttlefish15/
export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-15.0.0_r22
</code></pre>
<p>build:</p>
<pre><code>sudo docker run -it  --hostname redroid-buildercf15 --name redroid-buildercf15 -v `pwd`:/src redroid-builder
cd /src
source build/envsetup.sh
lunch
build_build_var_cache
lunch aosp_cf_arm64_phone-trunk_staging-userdebug
m -j12 dist
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250405"><a class="header" href="#20250405">20250405</a></h1>
<h3 id="1-mac-mini-m4"><a class="header" href="#1-mac-mini-m4">1. mac mini m4</a></h3>
<p>Thinking:</p>
<pre><code>1. android emulator
2. cuttlefish
3. virtualization(run linux/unix/windows)
4. nix pkgs
5. redroid on linux on m4
6. 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250406"><a class="header" href="#20250406">20250406</a></h1>
<h3 id="typing-game"><a class="header" href="#typing-game">typing game</a></h3>
<p><code>https://daziya.com/courses</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250407"><a class="header" href="#20250407">20250407</a></h1>
<h3 id="1-beisen"><a class="header" href="#1-beisen">1. Beisen</a></h3>
<p>Update the 1st season's conclusion(1.5 hours)</p>
<h3 id="2-macos-libvirtvirt-manager"><a class="header" href="#2-macos-libvirtvirt-manager">2. macos libvirt/virt-manager</a></h3>
<p>Install brew:</p>
<pre><code>export all_proxy=socks5://192.168.1.6:21080
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
</code></pre>
<p>Configure zsh:</p>
<pre><code>echo &gt;&gt; /Users/yangdash/.zprofile
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' &gt;&gt; /Users/yangdash/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
</code></pre>
<p>relogin with another terminal, then you could use brew.</p>
<p>Install qemu/libvirt/virt-manager:</p>
<pre><code>brew install libvirt
brew install qemu
brew tap arthurk/homebrew-virt-manager
brew install virt-manager virt-viewer
</code></pre>
<p>Start libvirt and launch virt-manager:</p>
<pre><code>brew services start libvirt
virt-manager -c "qemu:///session" --no-fork
</code></pre>
<p><img src="./images/2025_04_07_11_34_13_601x578.jpg" alt="./images/2025_04_07_11_34_13_601x578.jpg" /></p>
<p>Mount the nfs directory :</p>
<pre><code>sudo mount -t nfs -o resvport,rw  192.168.1.7:/media/big/iso /private/nfs
</code></pre>
<p>libvirtd 11.2.0 got bug, solved via:</p>
<pre><code>yangdash@yangdeMac-mini ~ % libvirtd --version
libvirtd (libvirt) 11.2.0
yangdash@yangdeMac-mini ~ % brew unlink libvirt
Unlinking /opt/homebrew/Cellar/libvirt/11.2.0... 116 symlinks removed.
export all_proxy=socks5://192.168.1.6:21080
yangdash@yangdeMac-mini ~ % brew install ./libvirt.rb 
yangdash@yangdeMac-mini ~ % libvirtd --version
libvirtd (libvirt) 11.1.0

</code></pre>
<p>The commit history could be found at:</p>
<p><code>https://github.com/Homebrew/homebrew-core/commits/0a560012cd157ebab89a130c041988288e2a645f/Formula/lib/libvirt.rb</code></p>
<h3 id="3-macos-autologin"><a class="header" href="#3-macos-autologin">3. macos autologin</a></h3>
<p>Close filevault:</p>
<p><img src="./images/2025_04_07_16_51_20_664x285.jpg" alt="./images/2025_04_07_16_51_20_664x285.jpg" /></p>
<p>Autologin:</p>
<p><img src="./images/2025_04_07_16_52_07_695x293.jpg" alt="./images/2025_04_07_16_52_07_695x293.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250408"><a class="header" href="#20250408">20250408</a></h1>
<h3 id="1-chromos-installation"><a class="header" href="#1-chromos-installation">1. chromos Installation</a></h3>
<p>Create the installation usb disk via:</p>
<pre><code>$ ls
brunch_r134_stable_20250322.tar.gz  chromeos_16151.61.0_volteer_recovery_stable-channel_VolteerMPKeys-v12.bin.zip
$ tar xzvf brunch_r134_stable_20250322.tar.gz
$ unzip chromeos_16151.61.0_volteer_recovery_stable-channel_VolteerMPKeys-v12.bin.zip
$  sudo apt -y install pv cgpt tar unzip
$ sudo bash ./chromeos-install.sh -src chromeos_16151.61.0_volteer_recovery_stable-channel_VolteerMPKeys-v12.bin -dst chromeos.img
$ sudo dd if=./chromeos.img of=/dev/sdc bs=10M &amp;&amp; sudo sync
</code></pre>
<h3 id="2-openwrt-working-tips"><a class="header" href="#2-openwrt-working-tips">2. openwrt working tips</a></h3>
<p>Host configuration:</p>
<p><img src="./images/2025_04_08_14_03_24_713x773.jpg" alt="./images/2025_04_08_14_03_24_713x773.jpg" /></p>
<p>Then <code>pacman -Syu --noconfirm</code> for updating to the latest version of archlinux.<br />
Edit the dns server:</p>
<p><img src="./images/2025_04_08_11_43_06_648x505.jpg" alt="./images/2025_04_08_11_43_06_648x505.jpg" /></p>
<p>Now replace to ustc repository and opkg udpate:</p>
<pre><code>sed -i 's/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g' /etc/opkg/distfeeds.conf
opkg update
</code></pre>
<p>Install diskman for resize root partition:</p>
<pre><code>scp dash@192.168.1.208:~/Downloads/luci-app-diskman_v0.2.11_all.ipk .
opkg install ./luci-app-diskman_v0.2.11_all.ipk 

</code></pre>
<p>vt-d not supported on j1900, game over. maybe I should switch to lxd or incus?</p>
<h3 id="3-archlinux-bootload-recovery"><a class="header" href="#3-archlinux-bootload-recovery">3. archlinux bootload recovery</a></h3>
<p><img src="./images/2025_04_08_17_19_32_1256x382.jpg" alt="./images/2025_04_08_17_19_32_1256x382.jpg" /></p>
<p><img src="./images/2025_04_08_17_19_56_566x121.jpg" alt="./images/2025_04_08_17_19_56_566x121.jpg" /></p>
<p><img src="./images/2025_04_08_17_20_34_895x179.jpg" alt="./images/2025_04_08_17_20_34_895x179.jpg" /></p>
<p><img src="./images/2025_04_08_17_21_19_611x237.jpg" alt="./images/2025_04_08_17_21_19_611x237.jpg" /></p>
<p><img src="./images/2025_04_08_17_30_22_680x302.jpg" alt="./images/2025_04_08_17_30_22_680x302.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250409"><a class="header" href="#20250409">20250409</a></h1>
<h3 id="1-uefi-recovery"><a class="header" href="#1-uefi-recovery">1. uefi recovery</a></h3>
<p>Steps:</p>
<pre><code>fs0:\
edit FS0:\startup.nsh
"FS0:\EFI\fuck\grubx64.efi"
Save
exit
reset
</code></pre>
<p>aarch64:</p>
<pre><code>fs0:\
edit FS0:\startup.nsh
"FS0:\EFI\debian\grubaa64.efi"
Save
exit
reset

</code></pre>
<h3 id="2-openwrt-tips"><a class="header" href="#2-openwrt-tips">2. openwrt tips</a></h3>
<p>refers to <code>https://gist.github.com/pjobson/3584f36dadc8c349fac9abf1db22b5dc</code>.<br />
Use rescuezilla for writing into the image.<br />
Use gparted for enlarge the root disk.</p>
<pre><code>sed -i 's/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g' /etc/opkg/distfeeds.conf
opkg update
opkg install vim-full nano usbutils pciutils
opkg install bash
sed -i 's/ash/bash/' /etc/passwd
opkg install ca-bundle ca-certificates openssl-util
mkdir ~/bin &amp;&amp; cd ~/bin
wget https://raw.githubusercontent.com/pjobson/bash-completion/master/bash_completion
chmod +x ~/bin/bash_completion
echo ". ~/bin/bash_completion" &gt;&gt; ~/.profile
opkg install adblock luci-app-adblock
opkg install git git-http ca-bundle wget
opkg install kmod-iwlwifi iwlwifi-firmware-iwl6000g2
</code></pre>
<p>Install passwall:<br />
<code>https://github.com/xiaorouji/openwrt-passwall/releases</code></p>
<pre><code>$ ls
luci-24.10_luci-app-passwall_25.4.1-r1_all.ipk
luci-24.10_luci-i18n-passwall-zh-cn_25.091.17880.830805a_all.ipk
passwall_packages_ipk_x86_64.zip 
$ unzip *.zip
$ opkg remove dnsmasq
$ mv /etc/config/dhcp /etc/config/dhcp.bak
$ opkg update
$ opkg install kmod-nft-socket kmod-nft-tproxy
$ opkg install *.ipk

</code></pre>
<h3 id="3-chromeos"><a class="header" href="#3-chromeos">3. chromeos</a></h3>
<p>Boot from usb disk:</p>
<p><img src="./images/2025_04_09_16_28_53_502x365.jpg" alt="./images/2025_04_09_16_28_53_502x365.jpg" /></p>
<p>Chrome OS OOBE:</p>
<p><img src="./images/2025_04_09_16_42_53_940x525.jpg" alt="./images/2025_04_09_16_42_53_940x525.jpg" /></p>
<p><code>Ctrl + Alt + F2</code>, for entering TTY 2:</p>
<p><img src="./images/2025_04_09_16_43_47_492x393.jpg" alt="./images/2025_04_09_16_43_47_492x393.jpg" /></p>
<p>Login with <code>chronos</code>, using lsblk for detecting the disks, then install system:</p>
<p><img src="./images/2025_04_09_16_45_37_969x552.jpg" alt="./images/2025_04_09_16_45_37_969x552.jpg" /></p>
<pre><code>sudo chromeos-install -dst /dev/nvme0n1
</code></pre>
<p><img src="./images/2025_04_09_16_46_08_831x89.jpg" alt="./images/2025_04_09_16_46_08_831x89.jpg" /></p>
<p><code>sudo reboot</code> for restarting system.</p>
<p>Setup:</p>
<p><img src="./images/2025_04_09_16_50_03_799x222.jpg" alt="./images/2025_04_09_16_50_03_799x222.jpg" /></p>
<p>Enable debug:</p>
<p><img src="./images/2025_04_09_16_50_41_663x311.jpg" alt="./images/2025_04_09_16_50_41_663x311.jpg" /></p>
<p>Personal use:</p>
<p><img src="./images/2025_04_09_16_51_28_816x483.jpg" alt="./images/2025_04_09_16_51_28_816x483.jpg" /></p>
<p><img src="./images/2025_04_09_16_52_06_807x522.jpg" alt="./images/2025_04_09_16_52_06_807x522.jpg" /></p>
<p><img src="./images/2025_04_09_16_53_20_799x491.jpg" alt="./images/2025_04_09_16_53_20_799x491.jpg" /></p>
<p><img src="./images/2025_04_09_16_53_37_795x465.jpg" alt="./images/2025_04_09_16_53_37_795x465.jpg" /></p>
<p><img src="./images/2025_04_09_16_54_06_818x474.jpg" alt="./images/2025_04_09_16_54_06_818x474.jpg" /></p>
<p>Install linux:<br />
<img src="./images/2025_04_09_17_24_54_1074x831.jpg" alt="./images/2025_04_09_17_24_54_1074x831.jpg" /></p>
<p><img src="./images/2025_04_09_17_25_18_752x638.jpg" alt="./images/2025_04_09_17_25_18_752x638.jpg" /></p>
<p>Enable adb:</p>
<p><img src="./images/2025_04_09_17_29_37_1074x807.jpg" alt="./images/2025_04_09_17_29_37_1074x807.jpg" /></p>
<p><img src="./images/2025_04_09_17_29_52_803x530.jpg" alt="./images/2025_04_09_17_29_52_803x530.jpg" /></p>
<p>Install adb:</p>
<p><img src="./images/2025_04_09_17_33_33_1160x483.jpg" alt="./images/2025_04_09_17_33_33_1160x483.jpg" /></p>
<p><img src="./images/2025_04_09_17_35_00_1176x699.jpg" alt="./images/2025_04_09_17_35_00_1176x699.jpg" /></p>
<h3 id="4-enable-ssh-wan"><a class="header" href="#4-enable-ssh-wan">4. enable ssh wan</a></h3>
<p>enable ssh wan on openwrt:</p>
<pre><code>To /etc/config/firewall add:

config rule                                     
        option name             Allow-SSH-WAN   
        option src              wan             
        option proto            tcp             
        option dest_port        22              
        option target           ACCEPT          
        option family           ipv4
Then:

/etc/init.d/firewall restart
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250410"><a class="header" href="#20250410">20250410</a></h1>
<h3 id="1-chromeos-cuttlefish"><a class="header" href="#1-chromeos-cuttlefish">1. chromeos cuttlefish</a></h3>
<p>Run Yuanshen, not OK, cannot enter game.</p>
<h3 id="2-zkfd-kernel-change"><a class="header" href="#2-zkfd-kernel-change">2. zkfd kernel change</a></h3>
<p>Change kdump parameters for release memory:</p>
<pre><code>root@test-PC:/etc/default/grub.d# free -m
               total        used        free      shared  buff/cache   available
Mem:            9176        1365        6870          15         939        7492
Swap:              0           0           0
root@test-PC:/etc/default# cd grub.d/
root@test-PC:/etc/default/grub.d# cat kdump-tools.cfg 
#GRUB_CMDLINE_LINUX_DEFAULT="$GRUB_CMDLINE_LINUX_DEFAULT crashkernel=0M-2G:128M,2G-6G:256M,6G-8G:512M,8G-:768M"
GRUB_CMDLINE_LINUX_DEFAULT="$GRUB_CMDLINE_LINUX_DEFAULT"
root@test-PC:/etc/default/grub.d# update-grub2
root@test-PC:/etc/default/grub.d# reboot

test@test-PC:~$ free -m
               total        used        free      shared  buff/cache   available
Mem:            9944        1479        5203          25        3260        8150
Swap:              0           0           0

</code></pre>
<h3 id="3-waydroid-on-ft2000"><a class="header" href="#3-waydroid-on-ft2000">3. waydroid on ft2000</a></h3>
<p>Install via:</p>
<pre><code>sudo apt install curl ca-certificates lzip python3 python3-pip
sudo ufw disable
sudo apt install wl-clipboard xclip
sudo pip install pyclip
curl https://repo.waydro.id | sudo bash
sudo apt install waydroid
sudo waydroid init -s GAPPS -f
sudo systemctl start waydroid-container
sudo systemctl enable waydroid-container


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250411"><a class="header" href="#20250411">20250411</a></h1>
<h3 id="1-amd520-using-amdgpu"><a class="header" href="#1-amd520-using-amdgpu">1. amd520 using amdgpu</a></h3>
<p>Edit grub configuration:</p>
<pre><code># vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT=" radeon.cik_support=0 amdgpu.cik_support=1 radeon.si_support=0 amdgpu.si_support=1"
# update-grub2 &amp;&amp; reboot
</code></pre>
<p>gpu:</p>
<pre><code>test@d2000:~$ sudo lspci -vvnn -s 04:00.0 | grep 'in use'
	Kernel driver in use: amdgpu
</code></pre>
<h3 id="2-redroidandroidboot"><a class="header" href="#2-redroidandroidboot">2. redroid(androidboot)</a></h3>
<p>Step:</p>
<pre><code>sudo docker run -itd --name redroid12 --privileged   -p 5555:5555 -v  ~/12data:/data redroid/redroid:12.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=host androidboot.redroid_gpu_node=/dev/dri/renderD128
</code></pre>
<h3 id="3-redroid-on-openeuler"><a class="header" href="#3-redroid-on-openeuler">3. redroid on openeuler</a></h3>
<p>Step:</p>
<pre><code>sudo dd if=./openEuler-22.03-LTS-SP3-aarch64-dvd.iso of=/dev/sda bs=10M &amp;&amp; sudo sync
</code></pre>
<p>Install system.</p>
<pre><code>sudo sed -E 's#https?://(repo|mirrors)\.openeuler\.org/#https://mirrors.ustc.edu.cn/openeuler/#g' \
         -i.bak \
         /etc/yum.repos.d/openEuler.repo
Install patched kernel from kbox
</code></pre>
<h3 id="4-rebuild-ubuntu2204-kernel"><a class="header" href="#4-rebuild-ubuntu2204-kernel">4. rebuild ubuntu2204 kernel</a></h3>
<p>Rebuild ubuntu22.04 kernel debs</p>
<pre><code>sudo apt update
sudo apt build-dep linux linux-image-$(uname -r)

sudo apt install libncurses-dev gawk flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf llvm build-essential libncurses5-dev gcc bc dwarves

# switch to root
sudo su

# get the current kernel source downloaded and extracted (ignore the end user warning)
apt source linux-image-unsigned-$(uname -r)

cd /path/to/linux-&lt;version&gt;/

# Give all user execution permissions to scripts (Important, otherwise error will be thrown even if you are running them as root)
chmod a+x debian/scripts/*
chmod a+x -R ./scripts

change the source code 

test@d2000:~/Code/newkernel/linux-5.15.0$ cp /boot/config-$(uname -r) ./.config
test@d2000:~/Code/newkernel/linux-5.15.0$ make oldconfig
#
# configuration written to .config
#
test@d2000:~/Code/newkernel/linux-5.15.0$ make -j9 deb-pkg LOCALVERSION=-fuck

</code></pre>
<p>source code changes:</p>
<pre><code>diff --git a/arch/arm64/include/asm/processor.h b/arch/arm64/include/asm/processor.h
index f1cfb52ba..c6aff6f44 100644
--- a/arch/arm64/include/asm/processor.h
+++ b/arch/arm64/include/asm/processor.h
@@ -45,7 +45,12 @@
  * TASK_UNMAPPED_BASE - the lower boundary of the mmap VM area.
  */
 
+#ifdef CONFIG_KBOX
+#define DEFAULT_MAP_WINDOW_64	(UL(1) &lt;&lt; 46)
+#else
 #define DEFAULT_MAP_WINDOW_64	(UL(1) &lt;&lt; VA_BITS_MIN)
+#endif
+
 #define TASK_SIZE_64		(UL(1) &lt;&lt; vabits_actual)
 
 #ifdef CONFIG_COMPAT
-- 
2.33.0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250412"><a class="header" href="#20250412">20250412</a></h1>
<h3 id="1-openfde-on-ubuntu2204"><a class="header" href="#1-openfde-on-ubuntu2204">1. openfde on ubuntu22.04</a></h3>
<p>Steps:</p>
<h3 id="2-building-waydroid"><a class="header" href="#2-building-waydroid">2. Building Waydroid</a></h3>
<p>redroid building container:</p>
<pre><code># docke run -it ubuntu:20.04 /bin/bash
In container
apt update
apt install -y vim (Then change the /etc/apt/sources.lists)
apt-get install openjdk-8-jdk-headless sudo
sudo apt-get install git-core gnupg flex bison maven gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386  lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip squashfs-tools python-mako libssl-dev ninja-build lunzip syslinux syslinux-utils gettext genisoimage gettext bc xorriso libncurses5 xmlstarlet build-essential git imagemagick lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libxml2 lzop pngcrush rsync schedtool python-enum34 python3-mako libelf-dev  net-tools wget 
sudo apt-get install gcc-10 g++-10
curl https://mirrors.bfsu.edu.cn/git/git-repo -o /usr/local/bin/repo
chmod 777 /usr/local/bin/repo
</code></pre>
<p>build in docker:</p>
<pre><code> wget -O - https://raw.githubusercontent.com/waydroid/android_vendor_waydroid/lineage-18.1/manifest_scripts/generate-manifest.sh | bash
Fetching: 100% (1/1), done in 9m44.211s
Checking out: 100% (1/1), done in 0.072s
ERROR: Missing build/make. Please run repo sync has finished successfully. first.    
root@waydroid-builder:/src# ls        
Makefile  build                        
</code></pre>
<p>manually download the script and run :</p>
<pre><code>wget https://raw.githubusercontent.com/waydroid/android_vendor_waydroid/lineage-18.1/manifest_scripts/generate-manifest.sh 
chmod 777 generate-manifest.sh 
bash generate-manifest.sh
</code></pre>
<pre><code>  export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
  repo init -u https://mirrors.bfsu.edu.cn/git/lineageOS/LineageOS/android.git -b lineage-18.1 --git-lfs
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250413"><a class="header" href="#20250413">20250413</a></h1>
<h3 id="1-build-waydroid-on-ubuntu2004"><a class="header" href="#1-build-waydroid-on-ubuntu2004">1. build waydroid on ubuntu20.04</a></h3>
<p>Some dependencies revolvement (mesa3d):</p>
<pre><code>sudo apt install -y glslang-tools

sudo apt install python3-pip
pip3 install meson
sudo ln -s /home/dash/.local/bin/meson  /usr/bin/
pip3 install pycparser
sudo apt install -y python3.9
sudo update-alternatives --config python
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1
sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 2
sudo update-alternatives --config python3

</code></pre>
<h3 id="2-patch-for-waydroid"><a class="header" href="#2-patch-for-waydroid">2. patch for waydroid</a></h3>
<p><code>android/Android.mk</code>:</p>
<p><img src="./images/2025_04_13_19_31_26_1299x268.jpg" alt="./images/2025_04_13_19_31_26_1299x268.jpg" /></p>
<p><code>android/mesa3d_cross.mk</code>:</p>
<p><img src="./images/2025_04_13_19_32_59_702x555.jpg" alt="./images/2025_04_13_19_32_59_702x555.jpg" /></p>
<p><code>meson.build</code>:</p>
<p><img src="./images/2025_04_13_19_35_27_559x209.jpg" alt="./images/2025_04_13_19_35_27_559x209.jpg" /></p>
<p><img src="./images/2025_04_13_19_36_45_718x317.jpg" alt="./images/2025_04_13_19_36_45_718x317.jpg" /></p>
<p><code>src/util/xmlconfig.c</code>:<br />
official:</p>
<p><img src="./images/2025_04_13_19_38_45_710x387.jpg" alt="./images/2025_04_13_19_38_45_710x387.jpg" /></p>
<p>fde(current build):</p>
<p><img src="./images/2025_04_13_19_46_03_692x445.jpg" alt="./images/2025_04_13_19_46_03_692x445.jpg" /></p>
<h3 id="3-waydroid-pullpush-files"><a class="header" href="#3-waydroid-pullpush-files">3. waydroid pull/push files</a></h3>
<p>Steps:</p>
<p>set the adb port:</p>
<pre><code>sudo waydroid shell
# setprop service.adb.tcp.port 5555
# ip 
2: eth0@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:16:3e:f9:d3:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.240.112/24 brd 192.168.240.255 scope global eth0
</code></pre>
<p>Connect:</p>
<pre><code>$ adb connect 192.168.240.112:5555

dash@dash-NUC11PAHi5:~/mesa/back/32$ adb pull /vendor/lib/libgallium_dri.so
/vendor/lib/libgallium_dri.so: 1 file pulled. 818.7 MB/s (40882828 bytes in 0.048s)
dash@dash-NUC11PAHi5:~/mesa/back/32$ cd ..
dash@dash-NUC11PAHi5:~/mesa/back$ cd 64
dash@dash-NUC11PAHi5:~/mesa/back/64$ adb pull /vendor/lib64/libgallium_dri.so
/vendor/lib64/libgallium_dri.so: 1 file pulled. 1058.8 MB/s (43161792 bytes in 0.039s)

</code></pre>
<p>push files:</p>
<pre><code>dash@dash-NUC11PAHi5:~/mesa/64$ adb push libgallium_dri.so /storage/emulated/0/Download/
libgallium_dri.so: 1 file pushed. 178.2 MB/s (43496784 bytes in 0.233s)
dash@dash-NUC11PAHi5:~/mesa/64$ cd ../32
dash@dash-NUC11PAHi5:~/mesa/32$ adb push libgallium_dri.so /storage/emulated/0/Download/libgallium_dri.so.32
libgallium_dri.so: 1 file pushed. 152.1 MB/s (41276852 bytes in 0.259s)
</code></pre>
<p>Then in <code>sudo waydroid shell</code> session:</p>
<pre><code>/vendor # mount -o rw,remount /vendor
:/vendor # cp /storage/emulated/0/Download/libgallium_dri.so /vendor/lib64/libgallium_dri.so
:/vendor # cp /storage/emulated/0/Download/libgallium_dri.so.32 /vendor/lib/libgallium_dri.so
</code></pre>
<p>Change the file:</p>
<pre><code>dash@dash-NUC11PAHi5:~$ wget https://gitlab.freedesktop.org/mesa/mesa/-/raw/main/src/util/00-mesa-defaults.conf
dash@dash-NUC11PAHi5:~$ sudo ls ~/.local/share/waydroid/data/vendor/
hardware  tombstones
dash@dash-NUC11PAHi5:~$ sudo mkdir -p ~/.local/share/waydroid/data/vendor/drirc.d
dash@dash-NUC11PAHi5:~$ sudo cp 00-mesa-defaults.conf ~/.local/share/waydroid/data/vendor/drirc.d/
dash@dash-NUC11PAHi5:~$ sudo vim ~/.local/share/waydroid/data/vendor/drirc.d/00-mesa-defaults.conf

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250414"><a class="header" href="#20250414">20250414</a></h1>
<h3 id="1-build-waydroid-on-rocklinux"><a class="header" href="#1-build-waydroid-on-rocklinux">1. build waydroid on RockLinux</a></h3>
<p>Install docker:</p>
<pre><code>sudo dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo
# /etc/yum.repos.d/docker-ce.repo change from "download.docker.com" to "mirrors.ustc.edu.cn/docker-ce"
sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre>
<p>Change configuration(for crossing gfw) then restart the service:</p>
<pre><code>$ sudo vim /etc/docker/daemon.json
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
</code></pre>
<p>Build the docker building image(on chromebook):</p>
<pre><code>$ sudo docker load&lt;buildwaydroid.tar 
[sudo] password for test: 
3abdd8a5e7a8: Loading layer  80.61MB/80.61MB
0536e2561aac: Loading layer  5.632kB/5.632kB
818aa02fabb2: Loading layer  3.194GB/3.194GB
4b8baaba43a9: Loading layer   2.56kB/2.56kB
c81a9fa30d90: Loading layer   2.56kB/2.56kB
278342f56eb6: Loading layer   2.56kB/2.56kB
d8732c5ad43b: Loading layer   2.56kB/2.56kB
1846df12125c: Loading layer   2.56kB/2.56kB
e61f0adf0916: Loading layer   2.56kB/2.56kB
27ef74451959: Loading layer  48.13kB/48.13kB
fba4fcc4b42a: Loading layer  19.43MB/19.43MB
6d91fc990412: Loading layer   2.56kB/2.56kB
d6e6eed9d41d: Loading layer   2.56kB/2.56kB
Loaded image: waydroid-build-24.04:latest
</code></pre>
<p>Directory structure:</p>
<p><img src="./images/2025_04_14_09_34_09_954x306.jpg" alt="./images/2025_04_14_09_34_09_954x306.jpg" /></p>
<p>初始化编译环境:</p>
<pre><code>$ sudo mkdir -p /media/nvme/ccache/lineage-18.1
$ sudo chmod 777 -R /media/nvme/ccache/lineage-18.1/
$ sudo docker create -v /media/nvme/ccache/lineage-18.1:/ccache --name ccache-18.1 waydroid-build-24.04
c1c9bda86567f5a131df3be2ec8a8dd3aa586f1ffe767e91538fd5051a2bf900
$ sudo docker run -e CCACHE_DIR=/ccache --volumes-from ccache-18.1 -v $(pwd):/mnt/lineage -it waydroid-build-24.04 /bin/bash
</code></pre>
<p>清空上次编译:</p>
<pre><code>在容器中:    
. build/envsetup.sh
make clean
rm -rf out
前后:    
[test@minirocky92 waydroid]$ du -hs lin
239G	lin
[test@minirocky92 waydroid]$ du -hs lin
121G	lin
</code></pre>
<p>repo sync again:</p>
<pre><code>git config --global http.proxy 'socks5://192.168.1.6:21080'
git config --global --add safe.directory "*"
repo sync
</code></pre>
<p>Manually patch mesa:</p>
<pre><code>$ cd external/mesa/
$ vim android/Android.mk 
$ vim meson.build 
$ vim src/util/xmlconfig.c 
$ cd ../../
$ cd device/waydroid/waydroid/
$ vim BoardConfig.mk
###### apply patch
. build/envsetup.sh
apply-waydroid-patches
. build/envsetup.sh &amp;&amp; lunch lineage_waydroid_x86_64-userdebug &amp;&amp;  time make systemimage -j$(nproc --all)
rm -f external/mesa/subprojects/libarchive.wrap
time make vendorimage -j$(nproc --all)
</code></pre>
<p>Build system/vendor image:</p>
<pre><code>cd /mnt/lineage &amp;&amp; ccache -M 50G
. build/envsetup.sh &amp;&amp; lunch lineage_waydroid_x86_64-userdebug
time make systemimage -j$(nproc --all)
</code></pre>
<p>After building, convert images:</p>
<pre><code>x86:    
simg2img  out/target/product/waydroid_x86_64/system.img ./system.img
simg2img  out/target/product/waydroid_x86_64/vendor.img ./vendor.img
arm64:    
simg2img out/target/product/waydroid_arm64/system.img ./system.img
simg2img out/target/product/waydroid_arm64/vendor.img ./vendor.img
</code></pre>
<h3 id="2-byobu-on-rocklinux"><a class="header" href="#2-byobu-on-rocklinux">2. byobu on rocklinux</a></h3>
<p>rocklinux don't have byobu on official repos or epel repos, so build it manually.  Steps(<code>https://blog.entrostat.com/install-byobu-on-any-linux-distro/</code>):</p>
<pre><code>yum install -y epel-release
yum install -y tar screen tmux make wget
cat installbyobu.sh

BYOBU_VERSION=5.133

set -e

echo "Please make sure you have the following dependencies installed:"
echo "  [+] tar"
echo "  [+] screen"
echo "  [+] tmux"
echo "  [+] make"

which tar
which screen
which tmux
which make

echo "We are going to download version ${BYOBU_VERSION} of byobu and install it..."



echo "Setting up temporary folder"
UNIQUE_FOLDER=$(date +%s)
cd /tmp
mkdir /tmp/${UNIQUE_FOLDER}
cd /tmp/${UNIQUE_FOLDER}

echo "Downloading source package"
wget "https://launchpad.net/byobu/trunk/${BYOBU_VERSION}/+download/byobu_${BYOBU_VERSION}.orig.tar.gz"

echo "Extracting the source files"
tar -xvf "byobu_${BYOBU_VERSION}.orig.tar.gz"
BYOBU_FOLDER_NAME=$(ls | grep byobu | grep -v .tar.gz)
cd "byobu-${BYOBU_VERSION}"

echo "Configuring and building"
./configure
sudo make install
byobu-select-backend tmux


echo ""
echo ""
echo ""
echo ""
echo "You're ready to go! Just type:"
echo ""
echo ""
echo "byobu"
</code></pre>
<h3 id="3-s-tui-on-rockylinux"><a class="header" href="#3-s-tui-on-rockylinux">3. s-tui on rockylinux</a></h3>
<p>Installation steps:</p>
<pre><code>$ sudo yum install -y python3 python3-pip
$ sudo pip3 install s-tui -i https://pypi.tuna.tsinghua.edu.cn/simple
$ which s-tui
/usr/local/bin/s-tui
</code></pre>
<p><img src="./images/2025_04_14_09_42_21_936x988.jpg" alt="./images/2025_04_14_09_42_21_936x988.jpg" /></p>
<h3 id="4-waydroid-on-ubuntu2204-x86"><a class="header" href="#4-waydroid-on-ubuntu2204-x86">4. waydroid on ubuntu2204 x86</a></h3>
<p>Using customized image for startup:</p>
<pre><code>sudo apt install curl ca-certificates lzip python3 python3-pip
sudo ufw disable
sudo apt install wl-clipboard xclip
sudo pip install pyclip
curl https://repo.waydro.id | sudo bash
sudo apt install waydroid
sudo mkdir -p /etc/waydroid-extra/images/
sudo mv *.img /etc/waydroid-extra/images/
sudo waydroid init -f
sudo systemctl start waydroid-container
sudo systemctl enable waydroid-container
</code></pre>
<p>Create the conf file for mesa use:</p>
<pre><code>test@test-TS660:~$ sudo ls ~/.local/share/waydroid/data/vendor/
hardware  tombstones
test@test-TS660:~$ sudo mkdir -p ~/.local/share/waydroid/data/vendor/drirc.d/
test@test-TS660:~$ sudo ls ~/.local/share/waydroid/data/vendor/
drirc.d  hardware  tombstones
test@test-TS660:~$ wget https://gitlab.freedesktop.org/mesa/mesa/-/raw/main/src/util/00-mesa-defaults.conf
test@test-TS660:~$ sudo cp 00-mesa-defaults.conf ~/.local/share/waydroid/data/vendor/drirc.d/
</code></pre>
<p>Add following definitions:</p>
<pre><code>        &lt;application name="Yuanshen" executable="com.miHoYo.Yuanshen"&gt;
            &lt;option name="ignore_discard_framebuffer" value="true" /&gt;
            &lt;option name="force_gl_renderer" value="Adreno (TM) 630"/&gt;
            &lt;option name="force_gl_vendor" value="Qualcomm"/&gt;
        &lt;/application&gt;

        &lt;application name="AIDA64" executable="com.finalwire.aida64"&gt;
            &lt;option name="force_gl_renderer" value="Adreno (TM) 630"/&gt;
            &lt;option name="force_gl_vendor" value="Qualcomm"/&gt;
        &lt;/application&gt;
</code></pre>
<p>houdini integration:</p>
<pre><code>git clone https://github.com/casualsnek/waydroid_script
cd waydroid_script
sudo  apt install python3.10-venv
python3 -m venv venv
venv/bin/pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
sudo venv/bin/python3 main.py
</code></pre>
<p>Now restart the machine for letting waydroid take effects.</p>
<pre><code>waydroid show-full-ui
</code></pre>
<h3 id="5-yuanshen-issue"><a class="header" href="#5-yuanshen-issue">5. Yuanshen issue</a></h3>
<p><code>~/.local/share/waydroid/data/vendor/drirc.d/00-mesa-defaults.conf</code> definition is outdated, Changed to Yuanshen.</p>
<pre><code>test@test-TS660:~$ sudo waydroid shell
:/ # am start -n com.miHoYo.Yuanshen/com.miHoYo.GetMobileInfo.MainActivity
Starting: Intent { cmp=com.miHoYo.Yuanshen/com.miHoYo.GetMobileInfo.MainActivity }
:/ # GI_pid="$(echo `pidof com.miHoYo.Yuanshen`)"
:/ # for limit_core in $GI_pid; do taskset -ap 1 $limit_core; done
</code></pre>
<p>After enter game:</p>
<pre><code>GI_pid="$(echo `pidof com.miHoYo.Yuanshen`)"

for limit_core in $GI_pid; do taskset -ap ff $limit_core; done
</code></pre>
<p>Get the package name via <code>pm list package | grep miH</code>.</p>
<h3 id="6-buildtime"><a class="header" href="#6-buildtime">6. buildtime</a></h3>
<p>5600g, 128G mem:</p>
<pre><code>systemimage
#### build completed successfully (02:14:27 (hh:mm:ss)) ####


real    134m26.626s
user    1463m49.968s
sys     104m12.507s
</code></pre>
<p>i5-10400 with 40G mem:</p>
<pre><code>[100% 93334/93334] Install system fs image: out/target/product/waydroid_x86_64/system.img

#### build completed successfully (02:32:54 (hh:mm:ss)) ####


real    152m53.196s
user    1728m9.951s
sys     64m29.833s

</code></pre>
<p><code>Intel(R) Core(TM) i9-10900 CPU @ 2.80GHz</code>:</p>
<pre><code>#### build completed successfully (01:38:09 (hh:mm:ss)) ####


real    98m8.745s
user    1840m27.636s
sys     78m59.847s
</code></pre>
<p><code>13th Gen Intel(R) Core(TM) i5-13400</code>:</p>
<pre><code>#### build completed successfully (01:33:35 (hh:mm:ss)) ####


real    93m34.873s
user    1333m48.906s
sys     67m54.397s
</code></pre>
<p><code>13900ks</code>:</p>
<pre><code>#### build completed successfully (36:49 (mm:ss)) ####


real    36m48.873s
user    1013m10.916s
sys     46m58.391s
</code></pre>
<h3 id="99-chromebook-workingtips"><a class="header" href="#99-chromebook-workingtips">99. chromebook workingtips</a></h3>
<p>Build docker images under linux-subsystem:</p>
<p><img src="./images/2025_04_14_09_26_46_714x510.jpg" alt="./images/2025_04_14_09_26_46_714x510.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250415"><a class="header" href="#20250415">20250415</a></h1>
<h3 id="1-build-cuttlefish-13"><a class="header" href="#1-build-cuttlefish-13">1. Build cuttlefish 13</a></h3>
<p>Build cuttlefish 13 with mesa patch from waydroid.</p>
<p>not available, for waydroid's mesa is newer than cf's.</p>
<p>also redroid's mesa is prebuilt.</p>
<h3 id="2-xxxos-configuration"><a class="header" href="#2-xxxos-configuration">2. xxxOS configuration</a></h3>
<p>Note:   Not ok for amdgpu, only for nvidia</p>
<p>For display bootup infos:</p>
<pre><code>After install kernel
# grub2-mkconfig -o /boot/efi/xxxxxxx
# cat /etc/dracut.conf.d/vfio.conf 
add_drivers+=" vfio vfio_iommu_type1 vfio_pci vfio_virqfd  "
# dracut -f --kver `uname -r` &amp;&amp; reboot
# cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.19.90-2102.2.0.0068.ctl2.x86_64 root=UUID=b87c272e-7c6b-4385-bb06-23e98d5e03fd ro crashkernel=512M iommu=pt amd_iommu=on pcie_acs_override=downstream,multifunction net.ifnames=0 biosdevname=0 vga=845
</code></pre>
<p>Example for using grubby:</p>
<pre><code>grubby --args="vga=845" --update-kernel="$(grubby --default-kernel)"
grubby --update-kernel="$(grubby --default-kernel)"  --remove-args="vfio-pci.ids=1002:6613,1002:aab0,10de:1287,10de:0e0f"
</code></pre>
<h3 id="3--grub-recovery"><a class="header" href="#3--grub-recovery">3.  grub recovery</a></h3>
<p><img src="./images/2025_04_15_17_17_45_726x241.jpg" alt="./images/2025_04_15_17_17_45_726x241.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250416"><a class="header" href="#20250416">20250416</a></h1>
<h3 id="1-chromebook-sshd"><a class="header" href="#1-chromebook-sshd">1 chromebook sshd</a></h3>
<p>In linux container, enable sshd step:</p>
<pre><code>sudo su
passwd
passwd &lt;user&gt;
remove file
sudo rm /etc/ssh/sshd_not_meant_to_be_run
vim  /etc/ssh/sshd_config
AllowAgentForwarding yes
AllowTcpForwarding yes
Port 1088 (arbitrary, anything above 1024, port 22 and 2222 are banned for ssh)
=&gt; In Chrome OS settings add port 1088 (Linux forwarding) and activate it
sudo systemctl start ssh
sudo systemctl enable ssh
</code></pre>
<p>Add 1088 port:</p>
<p><img src="./images/2025_04_16_09_55_25_725x517.jpg" alt="./images/2025_04_16_09_55_25_725x517.jpg" /></p>
<p>After added:</p>
<p><img src="./images/2025_04_16_09_55_50_606x235.jpg" alt="./images/2025_04_16_09_55_50_606x235.jpg" /></p>
<p>ssh -p 1088 xxx@xxx.xxx.xxx.xxx.</p>
<h3 id="2-dnsmasq-in-lxc"><a class="header" href="#2-dnsmasq-in-lxc">2. dnsmasq in lxc</a></h3>
<p>Edit <code>/etc/dnsmasq.conf</code>  and add following items:</p>
<pre><code>dhcp-range=192.168.1.50,192.168.1.150,120h
dhcp-option=3,192.168.1.33
interface=eth0
bind-interfaces
</code></pre>
<p>Then stop the nixos's kea dhcp server, the waydroid could be started.</p>
<h3 id="3-waydroid-in-nixos"><a class="header" href="#3-waydroid-in-nixos">3. waydroid in nixos</a></h3>
<p>nixos:</p>
<pre><code>enable ipv6
install weston
disable kea for letting dnsmasq work well
</code></pre>
<p>under weston window:</p>
<pre><code>waydroid session start &amp;
Start the UI
waydroid show-full-ui
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250417"><a class="header" href="#20250417">20250417</a></h1>
<h3 id="1-llm-token-test"><a class="header" href="#1-llm-token-test">1. llm token test</a></h3>
<p>Test via following commands and scripts:</p>
<pre><code>dash@ai:~$ python test.py 
使用的模型: deepseek-r1:70b
输入的提示: 玄武门之变结束的当天，李世民在深夜写下一段独白，你觉得他会写什么？
开始时间: 2025-04-17 09:57:59
结束时间: 2025-04-17 09:58:58
生成时间: 58.51秒
生成 token 数量: 884
每秒生成 token 数量: 15.11
dash@ai:~$ cat test.py
import requests
import time

# ollama 的 API 地址
OLLAMA_API_URL = "http://localhost:11434/api/generate"

# 请求参数
payload = {
    "model": "deepseek-r1:70b",  # 替换为你的模型名称
    "prompt": "玄武门之变结束的当天，李世民在深夜写下一段独白，你觉得他会写什么？",  # 替换为你的输入文本
    "stream": False,  # 设置为 False，一次性返回完整结果
    "max_tokens": 3000  # 设置生成的最大 token 数量
}

# 打印 model 和 prompt 信息
print(f"使用的模型: {payload['model']}")
print(f"输入的提示: {payload['prompt']}")

# 记录开始时间
start_time = time.time()
print(f"开始时间: {time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(start_time))}")

# 发送请求
response = requests.post(OLLAMA_API_URL, json=payload)

# 记录结束时间
end_time = time.time()
print(f"结束时间: {time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(end_time))}")

# 解析响应
if response.status_code == 200:
    result = response.json()
    # print(result)
    generated_text = result.get("response", "")
    generated_tokens = result.get("eval_count", 0)  # 获取生成的 token 数量
    elapsed_time = end_time - start_time

    # 计算每秒生成的 token 数量
    tokens_per_second = generated_tokens / elapsed_time

    print(f"生成时间: {elapsed_time:.2f}秒")
    print(f"生成 token 数量: {generated_tokens}")
    print(f"每秒生成 token 数量: {tokens_per_second:.2f}")
else:
    print(f"请求失败，状态码: {response.status_code}")
    print(f"错误信息: {response.text}")
</code></pre>
<h3 id="2-aosp-build-issue"><a class="header" href="#2-aosp-build-issue">2. aosp build issue</a></h3>
<p>Faster sync and save fq-flow:</p>
<pre><code>repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-14.0.0_r50
repo sync
curl -o .repo/local_manifests/manifest_brcm_rpi.xml -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-14.0/manifest_brcm_rpi.xml --create-dirs
curl -o .repo/local_manifests/remove_projects.xml -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-14.0/remove_projects.xml
 git config --global http.proxy 'socks5://192.168.1.6:21080'
repo sync -j1 --force-sync
</code></pre>
<p>Then:</p>
<pre><code>source build/envsetup.sh
lunch aosp_cf_arm64_phone-ap2a-userdebug
time m -j$(nproc --all)
</code></pre>
<p><img src="./images/2025_04_17_17_35_25_1603x496.jpg" alt="./images/2025_04_17_17_35_25_1603x496.jpg" /></p>
<h3 id="3-repo-sync-at-home"><a class="header" href="#3-repo-sync-at-home">3. repo sync at home</a></h3>
<p>Change to ustc:</p>
<pre><code>export REPO_URL=https://gerrit-googlesource.proxy.ustclug.org/git-repo
root@0e0cea4eee18:/mnt/lineage# repo init --depth 1 -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-14.0.0_r67
Downloading Repo source from https://gerrit-googlesource.proxy.ustclug.org/git-repo

... A new version of repo (2.54) is available.
... You should upgrade soon:
    cp /mnt/lineage/.repo/repo/repo /usr/local/bin/repo


Your identity is: YogSottot &lt;7411302+YogSottot@users.noreply.github.com&gt;
If you want to change this, please re-run 'repo init' with --config-name

repo has been initialized in /mnt/lineage
root@0e0cea4eee18:/mnt/lineage# mkdir .repo/manifests 
manifests/     manifests.git/ 
root@0e0cea4eee18:/mnt/lineage# mkdir .repo/manifests
manifests/     manifests.git/ 
root@0e0cea4eee18:/mnt/lineage# mkdir .repo/manifests/local_manifests/
root@0e0cea4eee18:/mnt/lineage# cp /root/remove_projects.xml .repo/manifests/local_manifests/
repo sync &amp;&amp; cp /root/manifest_brcm_rpi.xml .repo/local_manifests/ &amp;&amp; git config --global http.proxy 'socks://192.168.1.213:14389' &amp;&amp; repo sync -j1 --force-sync &amp;&amp; repo sync

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250418"><a class="header" href="#20250418">20250418</a></h1>
<h3 id="1-rpi-image-building-issue"><a class="header" href="#1-rpi-image-building-issue">1. rpi image building issue</a></h3>
<p>Solved via:</p>
<pre><code> source build/envsetup.sh 
 lunch aosp_rpi4-ap1a-userdebug
 pip3 install meson mako jinja2 ply pyyaml dataclasses --break-system-packages  -i https://pypi.tuna.tsinghua.edu.cn/simple
 apt install -y genromfs vim dosfstools
 time make bootimage systemimage vendorimage -j$(nproc)
</code></pre>
<h3 id="2-on-building-lineageos"><a class="header" href="#2-on-building-lineageos">2. on building lineageOS</a></h3>
<p>Using waydroid docker build image:</p>
<pre><code>apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git git-lfs gnupg gperf imagemagick lib32readline-dev lib32z1-dev libdw-dev libelf-dev liblz4-tool lz4 libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev meson glslang-tools python3-mako nethogs vim
git lfs install

root@068ccd2b2fcb:/mnt/lineage# git config --global http.proxy 'socks5://192.168.1.6:21080'
root@068ccd2b2fcb:/mnt/lineage# breakfast virtio_arm64
m espimage-install -j32

#### build completed successfully (01:12:12 (hh:mm:ss)) ####


5600g: 

[100% 151431/151431] Target UTM VM ZIP archive: out/target/product/virtio_arm64only/VirtualMachine/UTM/UTM-VM-lineage-22.2-2050418-UNOFFICIAL-virtio_arm64only.zip (priority: 2)

#### build completed successfully (04:04:47 (hh:mm:ss)) ####


real    244m47.296s
user    2624m41.207s
sys     224m56.047s

</code></pre>
<p>build out image:</p>
<pre><code>$ ls -l -h target/product/virtio_arm64/lineage-22.2-20250418-UNOFFICIAL-virtio_arm64.img 
-rw-r--r-- 1 root root 1.1G Apr 18 14:45 target/product/virtio_arm64/lineage-22.2-20250418-UNOFFICIAL-virtio_arm64.img
</code></pre>
<h3 id="3-libvirt-verify-lineageos"><a class="header" href="#3-libvirt-verify-lineageos">3. libvirt verify lineageOS</a></h3>
<p>Using the above img:</p>
<p><img src="./images/2025_04_18_15_28_13_581x517.jpg" alt="./images/2025_04_18_15_28_13_581x517.jpg" /></p>
<p>usb keyboard/mouse/tablet:</p>
<p><img src="./images/2025_04_18_15_30_34_362x275.jpg" alt="./images/2025_04_18_15_30_34_362x275.jpg" /></p>
<p>virtio with <code>3D acceleration</code>:</p>
<p><img src="./images/2025_04_18_15_31_53_466x408.jpg" alt="./images/2025_04_18_15_31_53_466x408.jpg" /></p>
<p>spice with OpenGL support:</p>
<p><img src="./images/2025_04_18_15_33_44_798x326.jpg" alt="./images/2025_04_18_15_33_44_798x326.jpg" /></p>
<p>sound with AC97:</p>
<p><img src="./images/2025_04_18_15_34_29_471x215.jpg" alt="./images/2025_04_18_15_34_29_471x215.jpg" /></p>
<p><img src="./images/2025_04_18_16_38_25_672x486.jpg" alt="./images/2025_04_18_16_38_25_672x486.jpg" /></p>
<p>usb:</p>
<p><img src="./images/2025_04_18_17_16_42_765x275.jpg" alt="./images/2025_04_18_17_16_42_765x275.jpg" /></p>
<p>virtio-disk:</p>
<h4 id="4-failed-build-on-fedora"><a class="header" href="#4-failed-build-on-fedora">4. failed build on fedora</a></h4>
<pre><code>linux-x86/bin/pahole -C kernel/virt/virtio O=/mnt/lineage/out/target/product/virtio_arm64only/obj/KERNEL_OBJ ARCH=arm64 CC= c
lang VARIANT_DEFCONFIG= SELINUX_DEFCONFIG= olddefconfig                                                                      
20:57:37    → /mnt/lineage/prebuilts/build-tools/linux-x86/bin/make -C /mnt/lineage/out/target/product/virtio_arm64only/obj/K
ERNEL_OBJ -f /mnt/lineage/kernel/virt/virtio/Makefile olddefconfig                                                           
20:57:37     → /mnt/lineage/prebuilts/build-tools/linux-x86/bin/make --no-print-directory -C /mnt/lineage/out/target/product/
virtio_arm64only/obj/KERNEL_OBJ -f /mnt/lineage/kernel/virt/virtio/Makefile olddefconfig                                     
20:57:37      → /mnt/lineage/prebuilts/build-tools/linux-x86/bin/make -f /mnt/lineage/kernel/virt/virtio/scripts/Makefile.bui
ld obj=scripts/kconfig olddefconfig                                                                                          
20:57:37       → scripts/kconfig/conf --olddefconfig Kconfig                                                                 
20:57:37        → sh -c -- { /mnt/lineage/kernel/virt/virtio/scripts/rust_is_available.sh; } &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo "y" || e
cho "n"                                                                                                                      
20:57:37         → /bin/sh /mnt/lineage/kernel/virt/virtio/scripts/rust_is_available.sh                                      
20:57:37          → rustc --version                                                                                          
20:58:55 ninja failed with: exit status 1                                                                                    
There was 1 action that completed after the action that failed. See verbose.log.gz for its output.                           
                                                                                                                             
#### failed to build some targets (04:42:54 (hh:mm:ss)) ####                                                                 
                                                                                                                             
                                                                                                                             
real    282m54.217s                                                                                                          
user    2111m19.887s                                                                                                         
sys     105m21.785s                                                                                                          
root@e77d01be6d83:/mnt/lineage#   
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250419"><a class="header" href="#20250419">20250419</a></h1>
<h3 id="1-using-tuna-for-repo"><a class="header" href="#1-using-tuna-for-repo">1. Using tuna for repo</a></h3>
<p>Steps:</p>
<pre><code> export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
 repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/lineageOS/LineageOS/android.git -b lineage-21.0  --git-lfs --no-clone-bundle
</code></pre>
<p>Change the file:</p>
<pre><code>+&lt;remote  name="github"
+           fetch="https://github.com/" /&gt;
+
+  &lt;remote  name="lineage"
+           fetch="https://mirrors.tuna.tsinghua.edu.cn/git/lineageOS/"
+           review="review.lineageos.org" /&gt;

  &lt;remote  name="private"
           fetch="ssh://git@github.com" /&gt;

  &lt;remote  name="aosp"
+          fetch="https://mirrors.tuna.tsinghua.edu.cn/git/AOSP"
           review="android-review.googlesource.com"
           revision="refs/tags/android-14.0.0_r67" /&gt;

  &lt;default revision="refs/heads/lineage-21.0"
+           remote="lineage"
           sync-c="true"
           sync-j="4" /&gt;

</code></pre>
<h3 id="2-compile-time"><a class="header" href="#2-compile-time">2. compile time</a></h3>
<p>i5-10400(<code>x86_64 iso</code>,22.2):</p>
<pre><code>lineage x86_64 iso:   

#### build completed successfully (03:36:51 (hh:mm:ss)) ####


real    216m51.282s
user    2401m5.298s
sys     113m6.989s

</code></pre>
<p>i5-10400(arm64 emulator, 22.2):</p>
<pre><code>2025-04-19 15:00:34 - build_super_image.py - INFO    : Done writing image out/target/product/emu64a/super.img
[100% 101598/101598] Create system-qemu.img now

#### build completed successfully (02:22:34 (hh:mm:ss)) ####


real    142m33.574s
user    1594m28.974s
sys     66m36.299s

</code></pre>
<p>5600G(emulator, 21.0) :</p>
<pre><code>lineage arm64 img

100% 54426/54426 56m56s remaining] Create system-qemu.img now

#### build completed successfully (01:43:08 (hh:mm:ss)) ####


real    103m7.842s
user    1095m56.990s
sys     99m0.773s

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250420"><a class="header" href="#20250420">20250420</a></h1>
<h3 id="1-add-xmlconfig-for-mesa"><a class="header" href="#1-add-xmlconfig-for-mesa">1. Add xmlconfig for mesa</a></h3>
<p>Edit following file for adding xml config items:</p>
<pre><code>root@d5c2829ff855:/mnt/lineage/22.1/device# vim virt/virt-common/BoardConfigVirtCommon.mk 
    # Graphics (Mesa)                                                                                                                                                                                                                                            
    BOARD_MESA3D_MESON_ARGS := -Dmesa-clc=system -Dxmlconfig=enabled
    BOARD_MESA3D_USES_MESON_BUILD := true 
root@d5c2829ff855:/mnt/lineage/22.1/device# cd ../../
</code></pre>
<p>Rebuild to view the effects.</p>
<p>failed with:</p>
<pre><code>Build type: cross build
meson.build:4:0: ERROR: Unknown options: "mesa-clc"
</code></pre>
<p>Should rebuild again from zero for verification.</p>
<h3 id="2-build-time"><a class="header" href="#2-build-time">2. build time</a></h3>
<p><code>i5-10400 building</code>:</p>
<pre><code>[100% 181309/181309] Target installer ESP image: out/target/product/virtio_arm64/lineage-22.0-20250420-UNOFFICIAL-virtio_arm64.img
872+0 records in
872+0 records out
914358272 bytes (914 MB, 872 MiB) copied, 0.385562 s, 2.4 GB/s

#### build completed successfully (05:36:05 (hh:mm:ss)) ####


real    336m5.374s
user    3759m52.234s
sys     176m37.094s

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250421"><a class="header" href="#20250421">20250421</a></h1>
<h3 id="1-lineage-mesa-patched"><a class="header" href="#1-lineage-mesa-patched">1. Lineage mesa patched</a></h3>
<p>Build:</p>
<pre><code>source build/envsetup.sh 
git config --global --add safe.directory "*"
breakfast virtio_x86_64
time m isoimage-install -j32
</code></pre>
<p>Time:</p>
<pre><code>[100% 147239/147239 24m25s remaining] //frameworks/base/api:system-api-stubs-docs-non-updatabl

#### build completed successfully (01:06:29 (hh:mm:ss)) ####
real	66m28.882s
user	1905m31.152s
sys	104m39.493s
</code></pre>
<p>Build arm64:</p>
<pre><code>breakfast virtio_arm64
time m espimage-install -j32
....
[100% 139777/139777] Target installer ESP image: out/target/product/virtio_arm64/lineage-22.1-20250421-UNOFFICIAL-virtio_arm64.img
871+0 records in
871+0 records out
913309696 bytes (913 MB, 871 MiB) copied, 0.323503 s, 2.8 GB/s

#### build completed successfully (56:20 (mm:ss)) ####


real	56m20.066s
user	1563m22.498s
sys	95m26.09
</code></pre>
<h3 id="2-lineage-in-emulator"><a class="header" href="#2-lineage-in-emulator">2. Lineage in Emulator</a></h3>
<p>Install a ubuntu24.04 desktop on haiguang, failed, changed to ubuntu22.04.</p>
<pre><code>[100% 143768/143768] run host_apex_verifier

#### build completed successfully (04:26:57 (hh:mm:ss)) ####


real    266m57.479s
user    3845m51.273s
sys     316m51.598s
test@test-P860:~/22.1$ 
</code></pre>
<p>Build platform:</p>
<pre><code>model           : 2
model name      : Hygon C86-3G (OPN:3350)
test@test-P860:~/22.1$ free -m
               total        used        free      shared  buff/cache   available
Mem:           32009         919        7102          18       23987       30612
Swap:           2047         186        1861
</code></pre>
<h3 id="3-drircd"><a class="header" href="#3-drircd">3. drirc.d</a></h3>
<p>tips:</p>
<pre><code>test@fedora:~$ adb shell
virtio_x86_64:/ # mkdir -p /data/vendor/drirc.d                                                                                                                                              
virtio_x86_64:/ # exit
test@fedora:~$ adb push 00-mesa-defaults.conf /data/vendor/drirc.d/
00-mesa-defaults.conf: 1 file pushed, 0 skipped. 649.1 MB/s (65430 bytes in 0.000s)

</code></pre>
<h3 id="4-pathmod"><a class="header" href="#4-pathmod">4. pathmod</a></h3>
<p>refreshmod and pathmod:</p>
<pre><code>root@83712873c508:/mnt/lineage# refreshmod
Refreshing modules (building module-info.json). Log at /mnt/lineage/out/target/product/waydroid_arm64/module-info.json.build.log.
08:27:05 Build sandboxing disabled due to nsjail error.
root@83712873c508:/mnt/lineage# pathmod libxml2
/mnt/lineage/external/libxml2
root@83712873c508:/mnt/lineage# pathmod libgallium_dri
/mnt/lineage/external/mesa/android

</code></pre>
<p>then readelf:</p>
<pre><code> readelf -d out/target/product/waydroid_arm64/vendor/lib64/libgallium_dri.so 

Dynamic section at offset 0x1a73738 contains 39 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libdrm.so]
 0x0000000000000001 (NEEDED)             Shared library: [liblog.so]
 0x0000000000000001 (NEEDED)             Shared library: [libcutils.so]
 0x0000000000000001 (NEEDED)             Shared library: [libz.so]
 0x0000000000000001 (NEEDED)             Shared library: [libc++.so]
 0x0000000000000001 (NEEDED)             Shared library: [libsync.so]
 0x0000000000000001 (NEEDED)             Shared library: [libdrm_amdgpu.so]
 0x0000000000000001 (NEEDED)             Shared library: [libdrm_radeon.so]
 0x0000000000000001 (NEEDED)             Shared library: [libLLVM17.so]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so]
 0x0000000000000001 (NEEDED)             Shared library: [libdl.so]
 0x0000000000000001 (NEEDED)             Shared library: [libglapi.so]
 0x000000000000000e (SONAME)             Library soname: [libgallium_dri.so]
 0x000000000000001e (FLAGS)              BIND_NOW
 0x000000006ffffffb (FLAGS_1)            Flags: NOW
.....
</code></pre>
<h3 id="5-selinux-item"><a class="header" href="#5-selinux-item">5. selinux item</a></h3>
<p>detect selinux:</p>
<pre><code>adb pull /sys/fs/selinux/policy /tmp/selinux.policy
adb logcat -b events -d | audit2allow -p /tmp/selinux.policy
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250422"><a class="header" href="#20250422">20250422</a></h1>
<h3 id="1-repo-sync-issue"><a class="header" href="#1-repo-sync-issue">1. repo sync issue</a></h3>
<p>Directly copy the old .repo folder from other directory:</p>
<pre><code>[test@minirocky92 22.1]$ sudo cp -r .repo/* /media/sdc/pure/.repo/
</code></pre>
<p>there are some modification in old directory:</p>
<pre><code> cd .repo/manifests
 git reset --hard
repo sync -c --force-sync
</code></pre>
<p>Using <code>repo status</code> for viewing the status.</p>
<h3 id="2-radeon-added-in-lineageos-virt"><a class="header" href="#2-radeon-added-in-lineageos-virt">2. radeon added in lineageOS virt</a></h3>
<p><img src="./images/2025_04_22_16_49_21_1423x434.jpg" alt="./images/2025_04_22_16_49_21_1423x434.jpg" /></p>
<p>Then I added some radeon items under <code>device/virt</code>:</p>
<pre><code>[test@minirocky92 virt]$ grep -i "vulkan.radeon" . -r
./virt-common/virt-common.mk:    vulkan.radeon \
[test@minirocky92 virt]$ grep -i "radeon" ./ -r | grep llvm
./virt-common/BoardConfigVirtCommon.mk:BOARD_MESA3D_GALLIUM_DRIVERS := llvmpipe softpipe radeonsi 
</code></pre>
<p>Change the definitions under device folder:</p>
<pre><code>make installclean &amp;&amp; time m espimage-install -j32
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250423"><a class="header" href="#20250423">20250423</a></h1>
<h3 id="1-amd520-minimum-vm-qcow2"><a class="header" href="#1-amd520-minimum-vm-qcow2">1. amd520 minimum vm qcow2</a></h3>
<p>Done in 1.5 hours.</p>
<h3 id="2-cf13"><a class="header" href="#2-cf13">2. cf13</a></h3>
<p>Steps:</p>
<pre><code>export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
root@15fa756bfc8d:/mnt/lineage/cf13# repo init --depth 1 https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b  android-13.0.0_r74
repo sync
</code></pre>
<p>Add some config:</p>
<pre><code>device/google/cuttlefish/AndroidProducts.mk
+       aosp_cf_arm64_only_phone-userdebug \
+       aosp_cf_arm64_only_phone-user \
</code></pre>
<p>Build:</p>
<pre><code>lunch aosp_cf_arm64_phone-userdebug &amp;&amp; m -j32
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250424"><a class="header" href="#20250424">20250424</a></h1>
<h3 id="1-cuttlefishdebian-testing"><a class="header" href="#1-cuttlefishdebian-testing">1. cuttlefish(Debian testing)</a></h3>
<p>Write image:</p>
<pre><code>sudo dd if=/media/nfs/debian-testing-arm64-DVD-1.iso of=/dev/sda bs=10M &amp;&amp; sudo sync
</code></pre>
<p><img src="./images/2025_04_24_09_48_21_1390x835.jpg" alt="./images/2025_04_24_09_48_21_1390x835.jpg" /></p>
<p>Using live cd for text installer.</p>
<p>After installation, bootloader is not OK.</p>
<pre><code>fs0:
cd EFI\debian
grubaa64.efi
</code></pre>
<p>Then you could see the grub items and bootup.</p>
<pre><code>apt update -y
apt upgrade -y

# cat /etc/apt/sources.list
# 默认注释了源码仓库，如有需要可自行取消注释
deb http://mirrors.ustc.edu.cn/debian testing main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian testing main contrib non-free non-free-firmware
deb http://mirrors.ustc.edu.cn/debian testing-updates main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian testing-updates main contrib non-free non-free-firmware

# backports 软件源，请按需启用
# deb http://mirrors.ustc.edu.cn/debian testing-backports main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian testing-backports main contrib non-free non-free-firmware
</code></pre>
<p>For installation OK, do following:</p>
<pre><code>apt remove raspi-firmware
mv  /etc/initramfs/post-update.d/z50-raspi-firmware /root
apt remove plymouth culmus
apt upgrade -y
reboot
</code></pre>
<p>After reboot, no screen output.</p>
<pre><code>apt install -y lightdm xfce4 xfce4-panel xfce4-session xfce4-settings xfce4-taskmanager xfce4-screenshooter xfce4-goodies xfce4-cpufreq-plugin
# vim /etc/lightdm/lightdm.conf
autologin items. 

#  groupadd -r autologin
# gpasswd -a username autologin
</code></pre>
<p>Build/Install cuttlefish, then reboot:</p>
<pre><code>root@debian:~# qemu-aarch64 --version
qemu-aarch64 version 9.2.93 (Debian 1:10.0.0~rc3+ds-2)
Copyright (c) 2003-2025 Fabrice Bellard and the QEMU Project developers
root@debian:~# uname -a
Linux debian 6.12.22-arm64 #1 SMP Debian 6.12.22-1 (2025-04-10) aarch64 GNU/Linux
root@debian:~# cat /etc/issue
Debian GNU/Linux trixie/sid \n \l
</code></pre>
<p>Download image:</p>
<p><img src="./images/2025_04_24_15_49_19_702x286.jpg" alt="./images/2025_04_24_15_49_19_702x286.jpg" /></p>
<p>Get the file(<code>aosp_cf_x86_64_phone-img-xxxxxx.zip</code>):</p>
<p><img src="./images/2025_04_24_15_50_54_734x478.jpg" alt="./images/2025_04_24_15_50_54_734x478.jpg" /></p>
<p>Get the <code>cvd-host_package.tar.gz</code> and <code>aosp_cf_arm64_only_phone-img-13263448.zip</code>:</p>
<pre><code>scp test@192.168.1.80:/media/sdb/lineage/cf13/./out/host/linux_bionic-arm64/cvd-host_package.tar.gz .
scp dash@192.168.1.208:~/下载/aosp_cf_arm64_only_phone-img-13263448.zip .
</code></pre>
<p>Extrace the files:</p>
<pre><code>test@debian:~/cf13$ unzip ../aosp_cf_arm64_only_phone-img-13263448.zip 
Archive:  ../aosp_cf_arm64_only_phone-img-13263448.zip
  inflating: android-info.txt        
  inflating: fastboot-info.txt       
  inflating: boot.img                
  inflating: bootloader              
  inflating: init_boot.img           
  inflating: userdata.img            
  inflating: vbmeta.img              
  inflating: vbmeta_system.img       
  inflating: vbmeta_system_dlkm.img  
  inflating: vbmeta_vendor_dlkm.img  
  inflating: vendor_boot.img         
  inflating: super.img  
</code></pre>
<p>New installation:</p>
<pre><code>test@debian:~$ cd cfown/
test@debian:~/cfown$ ls
bin  etc  lib64  nativetest64  usr
test@debian:~/cfown$ unzip ../aosp_cf_arm64_phone-img-eng.root.zip 
Archive:  ../aosp_cf_arm64_phone-img-eng.root.zip
 extracting: android-info.txt        
  inflating: boot.img                
  inflating: bootloader              
  inflating: init_boot.img           
  inflating: userdata.img            
  inflating: vbmeta.img              
  inflating: vbmeta_system.img       
  inflating: vendor_boot.img         
  inflating: super.img               
test@debian:~/cfown$ ls
android-info.txt  bootloader     lib64         userdata.img  vbmeta_system.img
bin               etc            nativetest64  usr           vendor_boot.img
boot.img          init_boot.img  super.img     vbmeta.img
test@debian:~/cfown$ 
</code></pre>
<p>Losts of problem under debian testing, switch to ubuntu24.04.</p>
<h3 id="2-cuttlefish-ubuntu2204"><a class="header" href="#2-cuttlefish-ubuntu2204">2. cuttlefish ubuntu22.04</a></h3>
<p>Upgrade to ubuntu24.04:</p>
<pre><code>sudo do-release-upgrade
</code></pre>
<p>Use arm64only.</p>
<h3 id="3-some-useful-material"><a class="header" href="#3-some-useful-material">3. some useful material</a></h3>
<p>Booting a Android Cuttlefish guest directly with QEMU:</p>
<p><code>https://linaro.atlassian.net/wiki/spaces/ORKO/pages/29093823191/Booting+a+Android+Cuttlefish+guest+directly+with+QEMU</code></p>
<p><code>start-avm</code>:</p>
<p><code>https://github.com/slp/start-avm</code></p>
<p><code>cvd2img</code></p>
<p><code>https://github.com/slp/cvd2img</code></p>
<pre><code>cuttlefish image -&gt; cvd2img -&gt; qemuImageFile -&gt; Qemu(mac mini)

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250425"><a class="header" href="#20250425">20250425</a></h1>
<h3 id="1-cf13-arm64only-compilation"><a class="header" href="#1-cf13-arm64only-compilation">1. cf13 arm64only compilation</a></h3>
<p>Build via:</p>
<pre><code>lunch aosp_cf_arm64_only_phone-userdebug &amp;&amp; time m dist -j32
</code></pre>
<p>Verify:</p>
<pre><code> mkdir cf13arm64only
 cd cf13arm64only/
 tar xzvf ../cvd-host_package.tar.gz 
 unzip ../aosp_cf_arm64_only_phone-img-eng.root.zip
</code></pre>
<p>Using own built <code>cvd-host_package.tar.gz</code>, failed with following infos:</p>
<pre><code>[ERROR:external/crosvm/src/main.rs:2893] invalid value "/home/test/cf13arm64only/cuttlefish/instances/cvd-1/internal/crosvm_control.sock": this socket path already exists
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6594) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6600) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6606) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6612) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6618) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6624) has exited with exit code 1
Detected unexpected exit of monitored subprocess /home/test/cf13arm64only/bin/crosvm
Subprocess /home/test/cf13arm64only/bin/crosvm (6630) has exited with exit code 1
^Ctest@d3000:~/cf13arm64only$ Failed to read event buffer size: Success
</code></pre>
<p>Using the official <code>cvd-host_package.tar.gz</code>:</p>
<pre><code>mkdir cf13arm64only_official
cd cf13arm64only_official/
test@d3000:~/cf13arm64only_official$ tar xzvf ../off/cf13/cvd-host_package.tar.gz 
test@d3000:~/cf13arm64only_official$ unzip ../aosp_cf_arm64_only_phone-img-eng.root.zip 
...
also failed.
...
</code></pre>
<p>all official items:</p>
<pre><code>test@d3000:~/cf13arm64only_official$ tar xzvf ../off/cf13/cvd-host_package.tar.gz &amp;&amp; unzip ../off/cf13/aosp_cf_arm64_only_phone-img-13263448.zip 
test@d3000:~/cf13arm64only_official$ adb connect 0.0.0.0:6520
already connected to 0.0.0.0:6520
test@d3000:~/cf13arm64only_official$ adb shell
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES                                       
 ------------RE GLES (Ganesh)------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (AMD Radeon RX 550 / 550 Series (radeonsi, polaris12, LLVM 19.1.1, DRM 3.57, 6.8.0-58-generic)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 24.2.8-1ubuntu1~24.04.1)
</code></pre>
<h3 id="2-ubuntuasahi"><a class="header" href="#2-ubuntuasahi">2. ubuntuasahi</a></h3>
<p>Not supported yet:</p>
<p><img src="./images/2025_04_25_08_50_10_389x370.jpg" alt="./images/2025_04_25_08_50_10_389x370.jpg" /></p>
<p>Better change back to m1 or m2?</p>
<h3 id="3-repo-sync-issue"><a class="header" href="#3-repo-sync-issue">3. repo sync issue</a></h3>
<p>repo sync items:</p>
<pre><code>repo using bfsu
Change:   
.repo/manifests.git/config，
url = https://android.googlesource.com/platform/manifest 
git config proxy
repo sync
</code></pre>
<p>using android 15 build:</p>
<pre><code>lunch
build_build_var_cache
lunch aosp_cf_arm64_phone-trunk_staging-userdebug
time make dist -j32
</code></pre>
<p>Home sync:</p>
<pre><code>export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
repo init --depth 1 -u  https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest  -b android-15.0.0_r25
repo sync
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250426"><a class="header" href="#20250426">20250426</a></h1>
<h3 id="1-repo-sync"><a class="header" href="#1-repo-sync">1. repo sync</a></h3>
<p>cf14:</p>
<pre><code>export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
repo init --depth 1 -u  https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest  -b android-14.0.0_r75
repo sync
</code></pre>
<p>cf13:</p>
<pre><code> export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
 repo init --depth 1 -u  https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest  -b android-13.0.0_r84
repo sync
</code></pre>
<h3 id="2-qemu-system-aarch64"><a class="header" href="#2-qemu-system-aarch64">2. qemu-system-aarch64</a></h3>
<p>Working directory items:</p>
<pre><code>test@d2000:~/qemu$ ls
flash0.img  flash1.img  start.sh  ubuntu2204.qcow2
</code></pre>
<p>start qemu script:</p>
<pre><code>$ cat start.sh
qemu-system-aarch64 -nographic -enable-kvm  -machine virt,gic-version=max -m 8192M -cpu max -smp 8 \
-netdev user,id=vnet,hostfwd=:0.0.0.0:2222-:22 -device virtio-net-pci,netdev=vnet \
-drive file=ubuntu2204.qcow2,if=none,id=drive0,cache=writeback -device virtio-blk,drive=drive0,bootindex=0 \
-drive file=flash0.img,format=raw,if=pflash -drive file=flash1.img,format=raw,if=pflash 
</code></pre>
<p>the <code>flash0.img</code> and <code>flash1.img</code> is created via:</p>
<pre><code>dd if=/dev/zero of=flash1.img bs=1M count=64
dd if=/dev/zero of=flash0.img bs=1M count=64
dd if=/usr/share/qemu-efi-aarch64/QEMU_EFI.fd of=flash0.img conv=notrunc
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250427"><a class="header" href="#20250427">20250427</a></h1>
<h3 id="1-cf-on-ubuntu2204"><a class="header" href="#1-cf-on-ubuntu2204">1. cf on ubuntu2204</a></h3>
<p>cf on ubuntu2204:</p>
<pre><code>cf13: 
crosvm+gfx: fail
crosvm+virgl: fail
qemu+gfx: fail
qemu+virgl: fail

cf14: 
crosvm+gfx: OK
crosvm+virgl: fail
qemu+gfx: OK
qemu+virgl: OK

cf15: 
crosvm+gfx: OK
crosvm+virgl: fail
qemu+gfx: OK
qemu+virgl: fail
</code></pre>
<h3 id="2-cf-verification"><a class="header" href="#2-cf-verification">2. cf verification</a></h3>
<p>System information:</p>
<pre><code>test@2004vm:~$ uname -a
Linux 2004vm 5.4.0-214-generic #234-Ubuntu SMP Fri Mar 14 23:50:24 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux
test@2004vm:~$ cat /etc/issue
Ubuntu 20.04.6 LTS \n \l
$ dpkg -l | grep cuttlefish
ii  cuttlefish-base                       0.9.26                               arm64        Cuttlefish Android Virtual Device companion package
ii  cuttlefish-user                       0.9.26                               arm64        Cuttlefish Android Virtual Device companion package
</code></pre>
<h4 id="21-cf13"><a class="header" href="#21-cf13">2.1 cf13</a></h4>
<p>cf13 materials:</p>
<pre><code>test@2004vm:~/cf13$ ls -l -h /mnt8/cf13/* 
-rw-r--r-- 1 root root 911M Apr 26 14:44 /mnt8/cf13/aosp_cf_arm64_phone-img-eng.root.zip
-rw-r--r-- 1 root root 276M Apr 26 14:44 /mnt8/cf13/cvd-host_package.tar.gz
test@2004vm:~/cf13$ tar xzvf /mnt8/cf13/cvd-host_package.tar.gz &amp;&amp; unzip /mnt8/cf13/aosp_cf_arm64_phone-img-eng.root.zi
</code></pre>
<p>crosvm+gfxstream(failed):</p>
<p><img src="./images/2025_04_27_14_46_55_578x376.jpg" alt="./images/2025_04_27_14_46_55_578x376.jpg" /></p>
<p>crosvm+virgl(failed):</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep complete
[sys.bootstat.first_boot_completed]: [0]
vsoc_arm64:/ $ dumpsys SurfaceFlinger
Can't find service: SurfaceFlinger
</code></pre>
<p>qemu+gfxstreamer(failed):</p>
<p><img src="./images/2025_04_27_14_56_28_584x407.jpg" alt="./images/2025_04_27_14_56_28_584x407.jpg" /></p>
<p>qemu+virgl:</p>
<pre><code>$ sudo apt install -y virt-manager(This will install qemu-system-aarch64)
qemu : 100%, won't start
</code></pre>
<h4 id="22-cf14"><a class="header" href="#22-cf14">2.2 cf14</a></h4>
<p>cf14 materials:</p>
<pre><code>tar xzvf /mnt8/cf14/cvd-host_package.tar.gz &amp;&amp; unzip /mnt8/cf14/aosp_cf_arm64_phone-img-root.zip
$ ls -l -h /mnt8/cf14/
total 1.6G
-rw-r--r-- 1 test test 1.1G Apr 26 14:49 aosp_cf_arm64_phone-img-root.zip
-rw-r--r-- 1 test test 462M Apr 26 14:48 cvd-host_package.tar.gz
</code></pre>
<p>crosvm+gfxstreamer(OK):</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (Radeon RX550/550 Series (POLARIS12, DRM 3.35.0, 5.4.0-214-generic, LLVM 12.0.0)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 21.2.6)
</code></pre>
<p>crosvm+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_01_38_582x339.jpg" alt="./images/2025_04_27_15_01_38_582x339.jpg" /></p>
<p>qemu+gfxstream(failed):</p>
<p><img src="./images/2025_04_27_15_03_49_560x363.jpg" alt="./images/2025_04_27_15_03_49_560x363.jpg" /></p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.bootstat.first_boot_completed]: [0]
</code></pre>
<p>qemu+virgl(OK):</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Mesa/X.org, virgl, OpenGL ES 3.1 Mesa 20.3.4 (git-daa37bee13)
</code></pre>
<h3 id="23-cf15"><a class="header" href="#23-cf15">2.3 cf15</a></h3>
<p>cf15 materials:</p>
<pre><code># tar xzvf /mnt8/cf15/cvd-host_package.tar.gz &amp;&amp; unzip /mnt8/cf15/aosp_cf_arm64_phone-img-root.zip
$ ls -l -h /mnt8/cf15/
total 1.6G
-rw-r--r-- 1 test test 1.1G Apr 26 14:50 aosp_cf_arm64_phone-img-root.zip
-rw-r--r-- 1 test test 478M Apr 26 14:50 cvd-host_package.tar.gz
</code></pre>
<p>crosvm+gfxstreamer(OK):</p>
<pre><code>vsoc_arm64:/ $ getprop  | grep boot | grep com                                               
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.display_framebuffer_format]: [rgba]
[ro.boot.vendor.apex.com.android.hardware.gatekeeper]: [com.android.hardware.gatekeeper.nonsecure]
[ro.boot.vendor.apex.com.android.hardware.keymint]: [com.android.hardware.keymint.rust_nonsecure]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (Radeon RX550/550 Series (POLARIS12, DRM 3.35.0, 5.4.0-214-generic, LLVM 12.0.0)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 21.2.6)
</code></pre>
<p>crosvm+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_06_57_578x364.jpg" alt="./images/2025_04_27_15_06_57_578x364.jpg" /></p>
<p>qemu+gfxstreamer(failed):</p>
<p><img src="./images/2025_04_27_15_07_46_573x362.jpg" alt="./images/2025_04_27_15_07_46_573x362.jpg" /></p>
<p>qemu+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_08_13_571x360.jpg" alt="./images/2025_04_27_15_08_13_571x360.jpg" /></p>
<h3 id="3-cf-150-verificationubuntu2004"><a class="header" href="#3-cf-150-verificationubuntu2004">3. cf 150 verification(ubuntu2004)</a></h3>
<p>Install:</p>
<pre><code>sudo apt install ./cuttlefish-base_1.5.0_arm64.deb ./cuttlefish-user_1.5.0_arm64.deb 
sudo usermod -aG kvm,cvdnetwork,render $USER
sudo reboot
</code></pre>
<h4 id="31-cf13"><a class="header" href="#31-cf13">3.1 cf13</a></h4>
<p>crosvm+gfxstreamer:</p>
<p><img src="./images/2025_04_27_15_22_53_578x358.jpg" alt="./images/2025_04_27_15_22_53_578x358.jpg" /></p>
<p>crosvm+virgl:</p>
<p><img src="./images/2025_04_27_15_23_37_566x362.jpg" alt="./images/2025_04_27_15_23_37_566x362.jpg" /></p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.android.wifi.hal]: [com.google.cf.wifi_hwsim]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.bootstat.first_boot_completed]: [0]
</code></pre>
<p>qemu+gfxstreamer:</p>
<p><img src="./images/2025_04_27_15_24_23_572x352.jpg" alt="./images/2025_04_27_15_24_23_572x352.jpg" /></p>
<p>qemu+virgl:</p>
<p><img src="./images/2025_04_27_15_26_00_582x359.jpg" alt="./images/2025_04_27_15_26_00_582x359.jpg" /></p>
<p>After install qemu:</p>
<p><img src="./images/2025_04_27_15_27_44_570x351.jpg" alt="./images/2025_04_27_15_27_44_570x351.jpg" /></p>
<p>Keep offline(May take a long time):</p>
<pre><code> adb devices
List of devices attached
192.168.1.78:6520	offline
</code></pre>
<p>Updated to 5.15 kernel:</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.android.wifi.hal]: [com.google.cf.wifi_hwsim]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
GLES: Mesa/X.org, virgl, OpenGL ES 3.1 Mesa 20.3.4 (git-b873e6ad33)

</code></pre>
<h4 id="32-cf14"><a class="header" href="#32-cf14">3.2 cf14</a></h4>
<p>crosvm+gfxstreamer(OK):</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (Radeon RX550/550 Series (POLARIS12, DRM 3.35.0, 5.4.0-214-generic, LLVM 12.0.0)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 21.2.6)
</code></pre>
<p>crosvm+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_29_54_570x351.jpg" alt="./images/2025_04_27_15_29_54_570x351.jpg" /></p>
<p>qemu+gfxstreamer(first boot won't boot complete, failed):</p>
<pre><code>vsoc_arm64:/ $ getprop  | grep boot | grep com                                               
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.bootstat.first_boot_completed]: [0]
</code></pre>
<p>qemu+virgl(OK):</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Mesa/X.org, virgl, OpenGL ES 3.1 Mesa 20.3.4 (git-daa37bee13)
</code></pre>
<h3 id="33-cf15"><a class="header" href="#33-cf15">3.3 cf15</a></h3>
<p>crosvm+gfxstreamer:</p>
<pre><code>vsoc_arm64:/ $ getprop | grep boot | grep com                                                
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.display_framebuffer_format]: [rgba]
[ro.boot.vendor.apex.com.android.hardware.gatekeeper]: [com.android.hardware.gatekeeper.nonsecure]
[ro.boot.vendor.apex.com.android.hardware.keymint]: [com.android.hardware.keymint.rust_nonsecure]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (Radeon RX550/550 Series (POLARIS12, DRM 3.35.0, 5.4.0-214-generic, LLVM 12.0.0)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 21.2.6)
</code></pre>
<p>crosvm+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_33_44_562x350.jpg" alt="./images/2025_04_27_15_33_44_562x350.jpg" /></p>
<p>qemu+gfxstreamer(failed):</p>
<p><img src="./images/2025_04_27_15_34_32_575x348.jpg" alt="./images/2025_04_27_15_34_32_575x348.jpg" /></p>
<p>qemu+virgl(failed):</p>
<p><img src="./images/2025_04_27_15_34_58_575x346.jpg" alt="./images/2025_04_27_15_34_58_575x346.jpg" /></p>
<h3 id="4-build-android-cuttlefish"><a class="header" href="#4-build-android-cuttlefish">4. build android cuttlefish</a></h3>
<p>dnscrypt should be configured at first:</p>
<pre><code>sudo apt install -y dnscrypt-proxy
sudo rm -f /etc/resolv.conf
$ cat /etc/resolv.conf 
nameserver 127.0.2.1

sudo chattr +i /etc/resolv.conf
</code></pre>
<p>Build the specified version of cuttlefish:</p>
<pre><code>wget https://github.com/google/android-cuttlefish/archive/refs/tags/stable.tar.gz
tar xzvf android-cuttlefish-1.5.0.tar.gz
cd android-cuttlefish-1.5.0
[0.072s] test@2504vm:~/Code/android-cuttlefish-1.5.0$ vim base/debian/control 
libtinfo5-&gt;libtinfo6
tools/buildutils/build_packages.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250428"><a class="header" href="#20250428">20250428</a></h1>
<h3 id="1-aosp-master"><a class="header" href="#1-aosp-master">1. aosp master</a></h3>
<p>Not available</p>
<h3 id="2-build-220-time"><a class="header" href="#2-build-220-time">2. build 22.0 time</a></h3>
<p>time for building lineageos22.0:</p>
<pre><code>Writing to 'stdio:out/target/product/virtio_x86_64/lineage-22.0-20250428-UNOFFICIAL-virtio_x86_64.iso' completed successfully.
#### build completed successfully (01:04:05 (hh:mm:ss)) ####
real	64m5.368s
user	1832m39.043s
sys	99m1.028s
</code></pre>
<h3 id="3-cvd-launch-script"><a class="header" href="#3-cvd-launch-script">3. cvd launch script</a></h3>
<pre><code>test@2504vm:~$ cat qemu_start.sh 
HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli  -gpu_mode   gfxstream  -enable_gpu_udmabuf -cpus 8 -memory_mb 12480
test@2504vm:~$ cat qemu_start_virgl.sh 
HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli  -gpu_mode   drm_virgl  -enable_gpu_udmabuf -cpus 8 -memory_mb 12480
test@2504vm:~$ cat start.sh 
HOME=$PWD ./bin/launch_cvd  -gpu_mode   gfxstream  -enable_gpu_udmabuf -cpus 8 -memory_mb 12480
test@2504vm:~$ cat start_virgl.sh 
HOME=$PWD ./bin/launch_cvd  -gpu_mode drm_virgl  -enable_gpu_udmabuf -cpus 8 -memory_mb 12480
</code></pre>
<p>cf14 qemu(gfxstreamer) issue:</p>
<pre><code>starting Rust KeyMint TA implementation in a thread
starting C++ KeyMint implementation in a thread with FDs in=43, out=42
KeyMint Rust TA running with infile=49, outfile=48, security_level=TrustedEnvironment
No secure deletion data file found. Creating one.
2025-04-28T14:46:58.823302Z qemu-system-aarch64: -device virtio-gpu-rutabaga,x-gfxstream-gles=on,gfxstream-vulkan=on,x-gfxstream-composer=on,hostmem=256M,id=gpu0,addr=02.0,xres=720,yres=1280: 'virtio-gpu-rutabaga' (alias 'virtio-gpu-rutabaga-pci') is not a valid device model name
Detected unexpected exit of monitored subprocess /usr/bin/qemu-system-aarch64
Subprocess /usr/bin/qemu-system-aarch64 (9158) has exited with exit code 1
Stopping all monitored processes due to unexpected exit of critical process
04-28 14:46:58.840  9329  9330 I stop_cvd: main.cc:124 Requesting stop

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250429"><a class="header" href="#20250429">20250429</a></h1>
<h3 id="1-cf14-verification"><a class="header" href="#1-cf14-verification">1. cf14 verification</a></h3>
<p>Version 14, VannillaIceCream:</p>
<p><img src="./images/2025_04_29_08_56_52_545x896.jpg" alt="./images/2025_04_29_08_56_52_545x896.jpg" /></p>
<pre><code>vsoc_arm64:/ $  getprop ro.build.version.release
14
</code></pre>
<p>图形配置:</p>
<pre><code>vsoc_arm64:/ $ getprop | grep vulkan                                                         
[ro.cpuvulkan.version]: [0]
[ro.hardware.vulkan]: [ranchu]
[ro.hwui.use_vulkan]: []
[ro.vulkan.apex]: [com.google.cf.vulkan]
vsoc_arm64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (AMD Radeon RX 550 / 550 Series (radeonsi, polaris12, ACO, DRM 3.61, 6.14.0-15-generic)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 25.0.3-1ubuntu2)
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Game</th><th>Description</th></tr></thead><tbody>
<tr><td>蛋仔派队</td><td>渲染有黑色</td></tr>
<tr><td>妄想山海</td><td>不满足配置需求</td></tr>
<tr><td>逆水寒</td><td>一直处于初始化</td></tr>
<tr><td>使命召唤手游</td><td>正常</td></tr>
<tr><td>阴阳师</td><td>渲染异常</td></tr>
<tr><td>元梦之星</td><td>直接退出</td></tr>
<tr><td>乱世王者</td><td>无法运行，硬件不满足</td></tr>
<tr><td>决战！平安京</td><td></td></tr>
<tr><td>高能英雄</td><td>提示opengles兼容问题，退出</td></tr>
<tr><td>光遇</td><td>提示不满足opengl条件，退出</td></tr>
<tr><td>三角洲行动</td><td>Qemu退出</td></tr>
</tbody></table>
</div>
<p>蛋仔：</p>
<p><img src="./images/2025_04_29_09_25_17_961x517.jpg" alt="./images/2025_04_29_09_25_17_961x517.jpg" /></p>
<p>妄想:</p>
<p><img src="./images/2025_04_29_09_30_50_924x506.jpg" alt="./images/2025_04_29_09_30_50_924x506.jpg" /></p>
<p>使命召唤:</p>
<p><img src="./images/2025_04_29_10_10_32_975x562.jpg" alt="./images/2025_04_29_10_10_32_975x562.jpg" /></p>
<p>阴阳师:</p>
<p><img src="./images/2025_04_29_10_19_28_989x556.jpg" alt="./images/2025_04_29_10_19_28_989x556.jpg" /></p>
<p>乱世王者:</p>
<p><img src="./images/2025_04_29_10_27_24_539x416.jpg" alt="./images/2025_04_29_10_27_24_539x416.jpg" /></p>
<p>高能英雄:</p>
<p><img src="./images/2025_04_29_10_47_42_759x503.jpg" alt="./images/2025_04_29_10_47_42_759x503.jpg" /></p>
<p>光遇:</p>
<p><img src="./images/2025_04_29_10_51_12_842x395.jpg" alt="./images/2025_04_29_10_51_12_842x395.jpg" /></p>
<p>三角洲行动:</p>
<p><img src="./images/2025_04_29_10_53_31_607x383.jpg" alt="./images/2025_04_29_10_53_31_607x383.jpg" /></p>
<h3 id="2-waydroid-on-ubuntu2504"><a class="header" href="#2-waydroid-on-ubuntu2504">2. waydroid on ubuntu2504</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250430"><a class="header" href="#20250430">20250430</a></h1>
<h3 id="1-rebuild-openfde"><a class="header" href="#1-rebuild-openfde">1. rebuild openfde</a></h3>
<p>Step:</p>
<pre><code>export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
repo init -u https://gitee.com/openfde/manifests -b fde_w --git-lfs 
repo sync -j6
</code></pre>
<p>build with error.</p>
<pre><code>[100% 105939/105939] Install system fs image: out/target/product/fde_arm64/system.img                                                                                                                                                                        

#### build completed successfully (02:48:06 (hh:mm:ss)) ####


real    168m5.875s
user    1858m49.439s
sys     124m28.267s

</code></pre>
<h3 id="2-rpi-glmark2-score"><a class="header" href="#2-rpi-glmark2-score">2. rpi glmark2 score</a></h3>
<p>result:</p>
<pre><code>test@rpi2204:~$ DISPLAY=:0 glmark2
=======================================================
    glmark2 2021.02
=======================================================
    OpenGL Information
    GL_VENDOR:     Broadcom
    GL_RENDERER:   V3D 4.2
    GL_VERSION:    3.1 Mesa 23.2.1-1ubuntu3.1~22.04.2
=======================================================
[build] use-vbo=false: FPS: 195 FrameTime: 5.128 ms
[build] use-vbo=true: FPS: 212 FrameTime: 4.717 ms
[texture] texture-filter=nearest: FPS: 197 FrameTime: 5.076 ms
[texture] texture-filter=linear: FPS: 196 FrameTime: 5.102 ms
[texture] texture-filter=mipmap: FPS: 196 FrameTime: 5.102 ms
[shading] shading=gouraud: FPS: 174 FrameTime: 5.747 ms
[shading] shading=blinn-phong-inf: FPS: 171 FrameTime: 5.848 ms
[shading] shading=phong: FPS: 162 FrameTime: 6.173 ms
[shading] shading=cel: FPS: 171 FrameTime: 5.848 ms
[bump] bump-render=high-poly: FPS: 170 FrameTime: 5.882 ms
[bump] bump-render=normals: FPS: 204 FrameTime: 4.902 ms
[bump] bump-render=height: FPS: 199 FrameTime: 5.025 ms
[effect2d] kernel=0,1,0;1,-4,1;0,1,0;: FPS: 150 FrameTime: 6.667 ms
[effect2d] kernel=1,1,1,1,1;1,1,1,1,1;1,1,1,1,1;: FPS: 105 FrameTime: 9.524 ms
[pulsar] light=false:quads=5:texture=false: FPS: 208 FrameTime: 4.808 ms
[desktop] blur-radius=5:effect=blur:passes=1:separable=true:windows=4: FPS: 76 FrameTime: 13.158 ms
[desktop] effect=shadow:windows=4: FPS: 185 FrameTime: 5.405 ms
[buffer] columns=200:interleave=false:update-dispersion=0.9:update-fraction=0.5:update-method=map: FPS: 105 FrameTime: 9.524 ms
[buffer] columns=200:interleave=false:update-dispersion=0.9:update-fraction=0.5:update-method=subdata: FPS: 107 FrameTime: 9.346 ms
[buffer] columns=200:interleave=true:update-dispersion=0.9:update-fraction=0.5:update-method=map: FPS: 121 FrameTime: 8.264 ms
[ideas] speed=duration: FPS: 192 FrameTime: 5.208 ms
[jellyfish] &lt;default&gt;: FPS: 156 FrameTime: 6.410 ms
[terrain] &lt;default&gt;: FPS: 20 FrameTime: 50.000 ms
[shadow] &lt;default&gt;: FPS: 63 FrameTime: 15.873 ms
[refract] &lt;default&gt;: FPS: 28 FrameTime: 35.714 ms
[conditionals] fragment-steps=0:vertex-steps=0: FPS: 215 FrameTime: 4.651 ms
[conditionals] fragment-steps=5:vertex-steps=0: FPS: 179 FrameTime: 5.587 ms
[conditionals] fragment-steps=0:vertex-steps=5: FPS: 214 FrameTime: 4.673 ms
[function] fragment-complexity=low:fragment-steps=5: FPS: 203 FrameTime: 4.926 ms
[function] fragment-complexity=medium:fragment-steps=5: FPS: 172 FrameTime: 5.814 ms
[loop] fragment-loop=false:fragment-steps=5:vertex-steps=5: FPS: 202 FrameTime: 4.950 ms
[loop] fragment-steps=5:fragment-uniform=false:vertex-steps=5: FPS: 201 FrameTime: 4.975 ms
[loop] fragment-steps=5:fragment-uniform=true:vertex-steps=5: FPS: 169 FrameTime: 5.917 ms
=======================================================
                                  glmark2 Score: 161 
=======================================================
</code></pre>
<p>Ludashi:</p>
<p><img src="./images/2025_04_30_23_59_47_397x753.jpg" alt="./images/2025_04_30_23_59_47_397x753.jpg" /></p>
<p><img src="./images/2025_05_01_00_00_01_397x329.jpg" alt="./images/2025_05_01_00_00_01_397x329.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250501"><a class="header" href="#20250501">20250501</a></h1>
<h3 id="1-d2000amd520"><a class="header" href="#1-d2000amd520">1. d2000+amd520</a></h3>
<p>glmark2 score:</p>
<pre><code>=======================================================
    glmark2 2021.02
=======================================================
    OpenGL Information
    GL_VENDOR:     AMD
    GL_RENDERER:   OLAND (oland, LLVM 15.0.7, DRM 3.42, 5.15.0-138-generic)
    GL_VERSION:    4.6 (Compatibility Profile) Mesa 23.2.1-1ubuntu3.1~22.04.3
=======================================================
[build] use-vbo=false: FPS: 1220 FrameTime: 0.820 ms
[build] use-vbo=true: FPS: 1156 FrameTime: 0.865 ms
[texture] texture-filter=nearest: FPS: 1026 FrameTime: 0.975 ms
[texture] texture-filter=linear: FPS: 1025 FrameTime: 0.976 ms
[texture] texture-filter=mipmap: FPS: 1091 FrameTime: 0.917 ms
[shading] shading=gouraud: FPS: 1011 FrameTime: 0.989 ms
[shading] shading=blinn-phong-inf: FPS: 1013 FrameTime: 0.987 ms
[shading] shading=phong: FPS: 1012 FrameTime: 0.988 ms
[shading] shading=cel: FPS: 1013 FrameTime: 0.987 ms
[bump] bump-render=high-poly: FPS: 813 FrameTime: 1.230 ms
[bump] bump-render=normals: FPS: 1204 FrameTime: 0.831 ms
[bump] bump-render=height: FPS: 1180 FrameTime: 0.847 ms
[effect2d] kernel=0,1,0;1,-4,1;0,1,0;: FPS: 962 FrameTime: 1.040 ms
[effect2d] kernel=1,1,1,1,1;1,1,1,1,1;1,1,1,1,1;: FPS: 866 FrameTime: 1.155 ms
[pulsar] light=false:quads=5:texture=false: FPS: 1069 FrameTime: 0.935 ms
[desktop] blur-radius=5:effect=blur:passes=1:separable=true:windows=4: FPS: 463 FrameTime: 2.160 ms
[desktop] effect=shadow:windows=4: FPS: 583 FrameTime: 1.715 ms
[buffer] columns=200:interleave=false:update-dispersion=0.9:update-fraction=0.5:update-method=map: FPS: 524 FrameTime: 1.908 ms
[buffer] columns=200:interleave=false:update-dispersion=0.9:update-fraction=0.5:update-method=subdata: FPS: 703 FrameTime: 1.422 ms
[buffer] columns=200:interleave=true:update-dispersion=0.9:update-fraction=0.5:update-method=map: FPS: 772 FrameTime: 1.295 ms
[ideas] speed=duration: FPS: 1172 FrameTime: 0.853 ms
[jellyfish] &lt;default&gt;: FPS: 667 FrameTime: 1.499 ms
[terrain] &lt;default&gt;: FPS: 116 FrameTime: 8.621 ms
[shadow] &lt;default&gt;: FPS: 455 FrameTime: 2.198 ms
[refract] &lt;default&gt;: FPS: 109 FrameTime: 9.174 ms
[conditionals] fragment-steps=0:vertex-steps=0: FPS: 1185 FrameTime: 0.844 ms
[conditionals] fragment-steps=5:vertex-steps=0: FPS: 1211 FrameTime: 0.826 ms
[conditionals] fragment-steps=0:vertex-steps=5: FPS: 1208 FrameTime: 0.828 ms
[function] fragment-complexity=low:fragment-steps=5: FPS: 1200 FrameTime: 0.833 ms
[function] fragment-complexity=medium:fragment-steps=5: FPS: 1209 FrameTime: 0.827 ms
[loop] fragment-loop=false:fragment-steps=5:vertex-steps=5: FPS: 1206 FrameTime: 0.829 ms
[loop] fragment-steps=5:fragment-uniform=false:vertex-steps=5: FPS: 1210 FrameTime: 0.826 ms
[loop] fragment-steps=5:fragment-uniform=true:vertex-steps=5: FPS: 1209 FrameTime: 0.827 ms
=======================================================
                                  glmark2 Score: 935 
=======================================================
</code></pre>
<p>ludashi Score:</p>
<p><img src="./images/2025_05_01_09_23_13_1115x1225.jpg" alt="./images/2025_05_01_09_23_13_1115x1225.jpg" /></p>
<p><img src="./images/2025_05_01_09_24_17_523x461.jpg" alt="./images/2025_05_01_09_24_17_523x461.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250502"><a class="header" href="#20250502">20250502</a></h1>
<h3 id="1-archlinux-with-kwin"><a class="header" href="#1-archlinux-with-kwin">1. archlinux with kwin</a></h3>
<p>format the nvme disk:</p>
<pre><code>Device           Start        End    Sectors   Size Type
/dev/nvme0n1p1    2048    2203647    2201600     1G EFI System
/dev/nvme0n1p2 2203648 2000408575 1998204928 952.8G Linux filesystem

mkfs.ext4 /dev/nvme0n1p2
mkfs.vfat -F32 /dev/nvme0n1p1
</code></pre>
<p>Make dir and mount:</p>
<pre><code> mount /dev/nvme0n1p2 /mnt
 mkdir -p /mnt/boot
 mount /dev/nvme0n1p1 /mnt/boot
vim /etc/pacman.d/mirrorlist
pacman -Sy archlinux-keyring
pacstrap -c /mnt base
pacstrap -c /mnt linux
mkdir /mnt/ccc
rm -rf /var/cache/pacman/pkg
ln -s /mnt/ccc /var/cache/pacman/pkg
pacstrap -c /mnt linux-firmware vim base-devel
genfstab -U /mnt&gt;&gt;/mnt/etc/fstab
arch-chroot /mnt
</code></pre>
<p>In chroot env:</p>
<pre><code> ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
 vim /etc/locale.gen 
activate en_US and zh_CN related
 locale-gen
 vim /etc/locale.conf
LANG=en_US.UTF-8
 vim /etc/hosts 
127.0.0.1	localhost
::1	localhost
127.0.1.1	archwayland
 vim /etc/hostname
archwayland
 mkinitcpio -P
passwd
pacman -S grub efibootmgr
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub
pacman -S xorg
pacman -S openssh networkmanager
systemctl enable sshd
systemctl enable NetworkManager
pacman -S net-tools iotop nethogs sudo
useradd -m dash
passwd dash
reboot
</code></pre>
<p>In archlinux :</p>
<pre><code>pacman -S byobu plasma firefox chromium sddm
systemctl enable sddm
visudo
  add dash as nopasswd sudoer
sudo vim /etc/pacman.conf
......
  [archlinuxcn]
  SigLevel = Never
  Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch
sudo pacman -S yay
yay nomachine
</code></pre>
<h3 id="2-systemd-nspawn"><a class="header" href="#2-systemd-nspawn">2. systemd-nspawn</a></h3>
<p>Tips:</p>
<pre><code>mkdir MyContainer
sudo pacstrap -K -c ~/MyContainer base 
sudo systemd-nspawn -D /home/dash/MyContainer/
    passwd root
sudo systemd-nspawn -b -D /home/dash/MyContainer/
</code></pre>
<h3 id="3-waydroid-on-archlinux"><a class="header" href="#3-waydroid-on-archlinux">3. waydroid on archlinux</a></h3>
<p>Install binder linux dkms from yay:</p>
<pre><code>sudo pacman -S linux-headers dkms
yay binder_linux-dkms
sudo dkms status
binder/1, 6.14.4-arch1-2, x86_64: installed
</code></pre>
<p>binder auto start:</p>
<pre><code>cat /etc/modules-load.d/binder_linux.conf
  # Load binder_linux at boot
  binder_linux
cat /etc/modprobe.d/binder_linux.conf
  # Options for binder_linux
  options binder_linux devices=binder,hwbinder,vndbinder
</code></pre>
<p>Install waydroid via:</p>
<pre><code>sudo pacman -S waydroid waydroid-image
sudo waydroid init
sudo systemctl enable waydroid-container.service --now
waydroid show-full-ui
    [23:26:00] Starting waydroid session
    [23:26:00] WAYLAND_DISPLAY is not set, defaulting to "wayland-0"
    [gbinder] Service manager /dev/anbox-binder has appeared
    [23:26:09] Android with user 0 is ready
</code></pre>
<p>waydroid session info:</p>
<pre><code>$ sudo waydroid shell
:/ # dumpsys SurfaceFlinger | grep GLES
GLES: Intel, Mesa Intel(R) UHD Graphics 630 (CML GT2), OpenGL ES 3.2 Mesa 24.3.4
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250503"><a class="header" href="#20250503">20250503</a></h1>
<h3 id="1-redroid-11-in-virgl"><a class="header" href="#1-redroid-11-in-virgl">1. redroid 11 in virgl</a></h3>
<p>Run:</p>
<pre><code>sudo docker run -itd --name  redroid11 --privileged   -p 5555:5555 -v ~/data:/data  redroid/redroid:11.0.0-latest redroid.width=1080 redroid.height=1920 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128
</code></pre>
<p>examine:</p>
<pre><code>d218007a8018:/ # getprop | grep boot | grep com                                                                              
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [696072955612]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
d218007a8018:/ # dumpsys SurfaceFlinger | grep GLES
GLES: Mesa, virgl (AMD Radeon Graphics (radeonsi, polaris12, ACO, DRM 3...), OpenGL ES 3.2 Mesa 24.0.8 (git-441f064c1c)
d218007a8018:/ # dumpsys SurfaceFlinger | grep vukan                                                                         
1|d218007a8018:/ # getprop | grep vulkan                                                                                     
[ro.hardware.vulkan]: [virtio]
[ro.hwui.use_vulkan]: []
</code></pre>
<p>三角洲行动:</p>
<p><img src="./images/2025_05_03_22_51_13_1273x716.jpg" alt="./images/2025_05_03_22_51_13_1273x716.jpg" /></p>
<h3 id="2-virgl-2404-waydroid"><a class="header" href="#2-virgl-2404-waydroid">2. virgl 2404 waydroid</a></h3>
<p>蛋仔派对： OK</p>
<p>Some games could not be launched(could not click for <code>开始</code>)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250504"><a class="header" href="#20250504">20250504</a></h1>
<h3 id="1-lindroid-guideline"><a class="header" href="#1-lindroid-guideline">1. lindroid guideline</a></h3>
<p>URL:</p>
<p><code>https://gist.github.com/AngelaCooljx/14ba722346da0479050be924d96e8c5e</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250505"><a class="header" href="#20250505">20250505</a></h1>
<h3 id="1-redroid-in-fedorax86_64"><a class="header" href="#1-redroid-in-fedorax86_64">1. redroid in fedora(x86_64)</a></h3>
<p>Install via <code>sudo dnf install -y waydroid</code>, then <code>sudo systemctl enable waydroid-container --now</code>.</p>
<p><img src="./images/2025_05_05_16_04_46_817x373.jpg" alt="./images/2025_05_05_16_04_46_817x373.jpg" /></p>
<p>Houdini:</p>
<pre><code>git clone https://github.com/casualsnek/waydroid_script
cd waydroid_script
sudo  apt install python3.10-venv
python3 -m venv venv
venv/bin/pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
sudo venv/bin/python3 main.py
</code></pre>
<p>network issue.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250506"><a class="header" href="#20250506">20250506</a></h1>
<h3 id="1-virgl-based-openfde"><a class="header" href="#1-virgl-based-openfde">1. virgl based openfde</a></h3>
<p>Install via:</p>
<pre><code>sudo apt install -y curl
curl -fsSL https://openfde.com/getopenfde/get-openfde.sh -o get-openfde.sh  
sudo sh ./get-openfde.sh
</code></pre>
<p>netplan configuration:</p>
<pre><code>test@vm2404:~$ cat /etc/netplan/eth0.yaml 
network:
    version: 2
    ethernets:
        eth0:
            dhcp4: true
test@vm2404:~$ cat /etc/netplan/eth1.yaml 
network:
    version: 2
    ethernets:
        eth1:
            dhcp4: true
</code></pre>
<p><img src="./images/2025_05_06_14_30_56_614x794.jpg" alt="./images/2025_05_06_14_30_56_614x794.jpg" /></p>
<p>Testing games:</p>
<pre><code>和平精英, 正常运行
蛋仔派对,  正常运行。
妄想山海, 正常运行。
逆水寒, 正常游戏
使命召唤手游, 正常游戏
阴阳师, 闪退
元梦之星, 正常运行。
乱世王者, 正常运行
决战！平安京
高能英雄: 正常运行
光遇: 看到手型图案后闪退。
三角洲行动, 可正常启动，不崩溃，但因为鼠标无法点击到正确的位置，在openfde下无法点击到正确的位置并开始。（见截图)   
美职篮全明星，正常启动，但启动后画面为紫色背景(见下面截图), 显卡为rx550.    
永恒部落, 正常运行。
英魂之刃, 启动后黑屏(rx550)
崩坏学园2: 正常运行
伏魔录, 正常运行。
巅峰极速
</code></pre>
<p>三角洲:</p>
<p><img src="./images/2025_05_06_15_27_21_1221x786.jpg" alt="./images/2025_05_06_15_27_21_1221x786.jpg" /></p>
<p>美职:</p>
<p><img src="./images/2025_05_06_14_50_01_1129x547.jpg" alt="./images/2025_05_06_14_50_01_1129x547.jpg" /></p>
<p>逆水寒:</p>
<p><img src="./images/2025_05_06_15_49_23_1099x536.jpg" alt="./images/2025_05_06_15_49_23_1099x536.jpg" /></p>
<p>英魂之刃:</p>
<p><img src="./images/2025_05_06_16_39_07_1103x556.jpg" alt="./images/2025_05_06_16_39_07_1103x556.jpg" /></p>
<h3 id="2"><a class="header" href="#2">2.</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250507"><a class="header" href="#20250507">20250507</a></h1>
<h3 id="1-rpi-redroid"><a class="header" href="#1-rpi-redroid">1. RPi redroid</a></h3>
<p>Most of the games won't run normally.</p>
<h3 id="2-redroid-12-building"><a class="header" href="#2-redroid-12-building">2. redroid 12 building</a></h3>
<p>In docker:</p>
<pre><code>    sudo curl https://mirrors.bfsu.edu.cn/git/git-repo -o /usr/local/bin/repo
    sudo chmod 777 /usr/local/bin/repo
    export REPO_URL='https://mirrors.bfsu.edu.cn/git/git-repo'
    repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-12.0.0_r32
    repo sync
After add the repo
    git config --global http.proxy 'socks5://192.168.1.6:21080'
    repo sync -j8
    sudo apt install -y git-lfs
    repo forall -c "git lfs pull"
    repo sync -j1 --force-sync
</code></pre>
<h3 id="3-ndk-build-mesa"><a class="header" href="#3-ndk-build-mesa">3. ndk build mesa</a></h3>
<p>refers to :</p>
<p><code>https://docs.mesa3d.org/android.html</code>
and</p>
<p><code>https://github.com/AOF-Dev/mesa-swdroid/issues/1</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250508"><a class="header" href="#20250508">20250508</a></h1>
<h3 id="1-mesa-building"><a class="header" href="#1-mesa-building">1. mesa building</a></h3>
<p>Building aosp 9:</p>
<pre><code>rm -r out/target/common/obj/JAVA_LIBRARIES
</code></pre>
<h3 id="2-ubuntu2004-cross-compilation"><a class="header" href="#2-ubuntu2004-cross-compilation">2. ubuntu2004 cross-compilation</a></h3>
<p>qcow2 for installation:</p>
<pre><code>qemu-img create -f qcow2 ubuntu2004buildmesa2.qcow2 80G
</code></pre>
<p><img src="./images/2025_05_08_16_54_17_454x373.jpg" alt="./images/2025_05_08_16_54_17_454x373.jpg" /></p>
<p>Install packages:</p>
<pre><code>sudo apt install binutils-aarch64-linux-gnu-dbg binutils-aarch64-linux-gnu cpp-aarch64-linux-gnu \
g++-10-aarch64-linux-gnu g++-9-aarch64-linux-gnu g++-aarch64-linux-gnu g++ \
gcc-10-aarch64-linux-gnu-base gcc-9-aarch64-linux-gnu-base gcc-aarch64-linux-gnu \
pkg-config-aarch64-linux-gnu qemu-efi-aarch64 gcc arch-test qemu-user-static debootstrap vim bison flex
sudo apt install vim libdrm-nouveau2 libdrm-dev libdrm2 libwayland-dev wayland-protocols libmirwayland-bin gir1.2-gtklayershell-0.1 gtk-layer-shell-doc gtk-layer-shell-examples libgtk-layer-shell-dev libgtk-layer-shell0 wayland-scanner++ libwayland-egl-backend-dev libx11-dev libxext-dev libxfixes-dev libxcb-glx0-dev libxcb-shm0-dev libx11-xcb-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev  libxshmfence-dev libxxf86vm-dev libxrandr-dev python3-pip
</code></pre>
<p>Create sysroot path aarch64 vm:</p>
<pre><code>sudo mkdir -p /mnt/data/arm64
sudo qemu-debootstrap --arch arm64 bullseye /mnt/data/arm64 http://mirrors.ustc.edu.cn/debian/
sudo chroot /mnt/data/arm64/
apt install vim libdrm-nouveau2 libdrm-dev libdrm2 libwayland-dev wayland-protocols libmirwayland-bin gir1.2-gtklayershell-0.1 gtk-layer-shell-doc gtk-layer-shell-examples libgtk-layer-shell-dev libgtk-layer-shell0 wayland-scanner++ libwayland-egl-backend-dev libx11-dev libxext-dev libxfixes-dev libxcb-glx0-dev libxcb-shm0-dev libx11-xcb-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev  libxshmfence-dev libxxf86vm-dev libxrandr-dev python3-pip
apt remove meson
sudo python3 -m pip install meson -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<p>Build(22.0.0 failed):</p>
<pre><code>unzip mesa-mesa-22.0.0.zip
cd  /home/test/mesa-mesa-22.0.0/subprojects
scp test@192.168.1.81:/home/test/mesa-mesa-22.0.0/subprojects/expat.wrap .
scp test@192.168.1.81:/home/test/mesa-mesa-22.0.0/subprojects/zlib.wrap .
</code></pre>
<p><img src="./images/2025_05_08_17_37_54_937x327.jpg" alt="./images/2025_05_08_17_37_54_937x327.jpg" /></p>
<p>Build(21.0.0):</p>
<pre><code>unzip mesa-mesa-21.0.0.zip 
cd mesa-mesa-21.0.0/subprojects/
scp test@192.168.1.81:/home/test/mesa-mesa-21.0.0/subprojects/expat.wrap .
scp test@192.168.1.81:/home/test/mesa-mesa-21.0.0/subprojects/zlib.wrap .
</code></pre>
<p>Create arm64.txt:</p>
<pre><code>[binaries]
c = 'aarch64-linux-gnu-gcc'
cpp = 'aarch64-linux-gnu-g++'
ar = 'aarch64-linux-gnu-gcc-ar'
strip = 'aarch64-linux-gnu-strip'
pkgconfig = 'aarch64-linux-gnu-pkg-config'
ld = 'aarch64-linux-gnu-ld'
pcap-config = ''
cmake = 'cmake'

[properties]
skip_sanity_check = true
sys_root = '/mnt/data/arm64'
# Generate binaries that are portable across all Armv8 machines
platform = 'generic'
pkg_config_libdir ='/mnt/data/arm64/usr/lib/aarch64-linux-gnu/pkgconfig:/mnt/data/arm64/usr/share/pkgconfig'

[built-in options]
c_args = ['--sysroot', '/mnt/data/arm64']
c_link_args = ['-Wl,-rpath', '/mnt/data/arm64/usr/lib/aarch64-linux-gnu/', '-Wl,--as-needed']

[host_machine]
system = 'linux'
cpu_family = 'aarch64'
cpu = 'armv8-a'
endian = 'little'

test@buildmesa2:~/mesa-mesa-21.0.0$ pwd
/home/test/mesa-mesa-21.0.0
test@buildmesa2:~/mesa-mesa-21.0.0$ ls arm64.txt 
arm64.txt
</code></pre>
<p>Build and install:</p>
<pre><code>/usr/local/bin/meson build  --prefix=/opt/local --cross-file arm64.txt
ninja -C build
ninja -C build install
</code></pre>
<p>Directory content:</p>
<pre><code>test@buildmesa2:/opt/local/lib$ tree 
.
├── dri
│   ├── armada-drm_dri.so
│   ├── etnaviv_dri.so
│   ├── exynos_dri.so
│   ├── hx8357d_dri.so
│   ├── ili9225_dri.so
│   ├── ili9341_dri.so
│   ├── imx-dcss_dri.so
│   ├── imx-drm_dri.so
│   ├── ingenic-drm_dri.so
│   ├── kgsl_dri.so
│   ├── kms_swrast_dri.so
│   ├── lima_dri.so
│   ├── mcde_dri.so
│   ├── mediatek_dri.so
│   ├── meson_dri.so
│   ├── mi0283qt_dri.so
│   ├── msm_dri.so
│   ├── mxsfb-drm_dri.so
│   ├── nouveau_dri.so
│   ├── panfrost_dri.so
│   ├── pl111_dri.so
│   ├── repaper_dri.so
│   ├── rockchip_dri.so
│   ├── st7586_dri.so
│   ├── st7735r_dri.so
│   ├── stm_dri.so
│   ├── sun4i-drm_dri.so
│   ├── swrast_dri.so
│   ├── tegra_dri.so
│   ├── v3d_dri.so
│   ├── vc4_dri.so
│   └── virtio_gpu_dri.so
├── libEGL.so -&gt; libEGL.so.1
├── libEGL.so.1 -&gt; libEGL.so.1.0.0
├── libEGL.so.1.0.0
├── libexpat.so -&gt; libexpat.so.1
├── libexpat.so.1 -&gt; libexpat.so.1.6.7
├── libexpat.so.1.6.7
├── libgbm.so -&gt; libgbm.so.1
├── libgbm.so.1 -&gt; libgbm.so.1.0.0
├── libgbm.so.1.0.0
├── libglapi.so -&gt; libglapi.so.0
├── libglapi.so.0 -&gt; libglapi.so.0.0.0
├── libglapi.so.0.0.0
├── libGLESv1_CM.so -&gt; libGLESv1_CM.so.1
├── libGLESv1_CM.so.1 -&gt; libGLESv1_CM.so.1.1.0
├── libGLESv1_CM.so.1.1.0
├── libGLESv2.so -&gt; libGLESv2.so.2
├── libGLESv2.so.2 -&gt; libGLESv2.so.2.0.0
├── libGLESv2.so.2.0.0
├── libGL.so -&gt; libGL.so.1
├── libGL.so.1 -&gt; libGL.so.1.2.0
├── libGL.so.1.2.0
├── libvulkan_lvp.so
├── libxatracker.so -&gt; libxatracker.so.2
├── libxatracker.so.2 -&gt; libxatracker.so.2.5.0
├── libxatracker.so.2.5.0
├── libz.so
└── pkgconfig
    ├── dri.pc
    ├── egl.pc
    ├── gbm.pc
    ├── glesv1_cm.pc
    ├── glesv2.pc
    ├── gl.pc
    ├── xatracker.pc
    └── zlib.pc
</code></pre>
<p>Change to ndk:</p>
<pre><code>scp dash@192.168.1.208:~/android-ndk-r21e-linux-x86_64.zip .
unzip android-ndk-r21e-linux-x86_64.zip


$ cat arm64_ndk.txt 
[binaries]
ar = '/home/test/android-ndk-r21e/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-ar'
c = ['ccache', '/home/test/android-ndk-r21e/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang']
cpp = ['ccache', '/home/test/android-ndk-r21e/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android26-clang++', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++']
strip = '/home/test/android-ndk-r21e/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-strip'
#c = 'aarch64-linux-gnu-gcc'
#cpp = 'aarch64-linux-gnu-g++'
#ar = 'aarch64-linux-gnu-gcc-ar'
#strip = 'aarch64-linux-gnu-strip'
pkgconfig = 'aarch64-linux-gnu-pkg-config'
ld = 'aarch64-linux-gnu-ld'
pcap-config = ''
cmake = 'cmake'

[properties]
skip_sanity_check = true
sys_root = '/mnt/data/arm64'
# Generate binaries that are portable across all Armv8 machines
platform = 'generic'
pkg_config_libdir ='/mnt/data/arm64/usr/lib/aarch64-linux-gnu/pkgconfig:/mnt/data/arm64/usr/share/pkgconfig'

[built-in options]
c_args = ['--sysroot', '/mnt/data/arm64']
c_link_args = ['-Wl,-rpath', '/mnt/data/arm64/usr/lib/aarch64-linux-gnu/', '-Wl,--as-needed']

[host_machine]
system = 'linux'
cpu_family = 'aarch64'
cpu = 'armv8-a'
endian = 'little'

</code></pre>
<p>Build via <code>/usr/local/bin/meson build  --prefix=/opt/local --cross-file arm64_ndk.txt</code> failed with:</p>
<p><img src="./images/2025_05_08_17_49_58_937x299.jpg" alt="./images/2025_05_08_17_49_58_937x299.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250509"><a class="header" href="#20250509">20250509</a></h1>
<h3 id="1-build-mesa"><a class="header" href="#1-build-mesa">1. build mesa</a></h3>
<p>Tips:</p>
<pre><code>sudo apt install -y libxrandr-dev libxxf86vm-dev libxcb-*-dev libx11-xcb-dev libxfixes-dev libdrm-dev libx11-dev python3-pip git pkg-config flex bison
sudo pip3 install mako meson ninja -i https://pypi.mirrors.ustc.edu.cn/simple/
unzip android-ndk-r27c-linux.zip
mkdir Code &amp;&amp; cd Code
git config --global http.proxy 'socks5://192.168.1.6:21080'
git clone https://gitlab.freedesktop.org/mesa/drm.git
cd drm
meson setup "build-android"             --prefix=/tmp/drm-static             --cross-file "../build-crossfile-drm"             -Ddefault_library=static             -Dintel=disabled             -Dradeon=disabled             -Damdgpu=disabled             -Dnouveau=disabled             -Dvmwgfx=disabled             -Dfreedreno=enabled             -Dvc4=disabled             -Detnaviv=disabled             -Dfreedreno-kgsl=true
git clone --branch mesa-25.0.2 https://gitlab.freedesktop.org/mesa/mesa
git clone --branch 25.0.2 https://github.com/Vera-Firefly/mesa-build-fix
cp -rf mesa-build-fix/* mesa
cd mesa
meson setup "build-android"             --prefix=/tmp/mesa             --cross-file "../build-crossfile"             -Dplatforms=android             -Dplatform-sdk-version=33             -Dandroid-stub=true             -Dandroid-libbacktrace=disabled             -Dandroid-strict=false             -Dxlib-lease=disabled             -Degl=disabled             -Dgbm=disabled             -Dglx=disabled             -Dllvm=disabled             -Dopengl=true             -Dosmesa=true             -Dvulkan-drivers=             -Dgallium-drivers=zink,panfrost,freedreno             -Dfreedreno-kmds=kgsl,msm             -Dshared-glapi=false             -Dtools=drm-shim             -Dbuildtype=release
</code></pre>
<p>The build definition file:</p>
<pre><code>dash@dash-Standard-PC-Q35-ICH9-2009:~/Code$ cat build-crossfile
[binaries]
ndk = '/home/dash/Code/android-ndk-r27c' + '/toolchains/llvm/prebuilt/linux-x86_64/bin'
ar = ndk + '/llvm-ar'
c = ['ccache', ndk + '/aarch64-linux-android29-clang', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC']
cpp = ['ccache', ndk + '/aarch64-linux-android29-clang++', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++', '-Wno-c++11-narrowing']
c_ld = 'lld'
cpp_ld = 'lld'
strip = ndk + '/aarch64-linux-android-strip'
pkgconfig = ['env', 'PKG_CONFIG_LIBDIR=.:/tmp/drm-static/lib/pkgconfig', '/usr/bin/pkg-config']

#[properties]
#pkg_config_libdir ='/tmp/drm-static/lib/pkgconfig/:/usr/lib/x86_64-linux-gnu/pkgconfig/'

[host_machine]
system = 'android'
cpu_family = 'arm'
cpu = 'armv8'
endian = 'little'
dash@dash-Standard-PC-Q35-ICH9-2009:~/Code$ cat build-crossfile-drm 
[binaries]
ndk = '/home/dash/Code/android-ndk-r27c' + '/toolchains/llvm/prebuilt/linux-x86_64/bin'
ar = ndk + '/llvm-ar'
c = ['ccache', ndk + '/aarch64-linux-android29-clang', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC']
cpp = ['ccache', ndk + '/aarch64-linux-android29-clang++', '-O3', '-DVK_USE_PLATFORM_ANDROID_KHR', '-fPIC', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '-static-libstdc++']
c_ld = 'lld'
cpp_ld = 'lld'
strip = ndk + '/aarch64-linux-android-strip'
pkgconfig = ['env', 'PKG_CONFIG_LIBDIR=.', '/usr/bin/pkg-config']
[host_machine]
system = 'android'
cpu_family = 'arm'
cpu = 'armv8'
endian = 'little'
</code></pre>
<p>build result:</p>
<pre><code>$ ls /tmp/mesa/lib/
libarchive.so  libfreedreno_noop_drm_shim.so  libOSMesa.so  libpanfrost_noop_drm_shim.so  libxatracker.so  libxml2.so  pkgconfig
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250510"><a class="header" href="#20250510">20250510</a></h1>
<h3 id="1-thinking-on-dockerized-android"><a class="header" href="#1-thinking-on-dockerized-android">1. Thinking on dockerized android</a></h3>
<p>openstack + lxc + lxcBasedRedroid.<br />
Redroid should located on centos7</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250511"><a class="header" href="#20250511">20250511</a></h1>
<h3 id="1-centoslxclibvirt"><a class="header" href="#1-centoslxclibvirt">1. centos/lxc/libvirt</a></h3>
<p>centos7 5.10 kernel.<br />
lxc + redroid redroid.<br />
libvirt</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250512"><a class="header" href="#20250512">20250512</a></h1>
<h3 id="1-centos7-redroid"><a class="header" href="#1-centos7-redroid">1. centos7 redroid</a></h3>
<p>Initial os/kernel configuration:</p>
<pre><code>[root@centosredroidbase ~]# cat /etc/redhat-release 
CentOS Linux release 7.6.1810 (Core) 
[root@centosredroidbase ~]# uname -a
Linux centosredroidbase 3.10.0-957.el7.x86_64 #1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>repo configuration:</p>
<pre><code>sudo sed -i.bak   -e 's|^mirrorlist=|#mirrorlist=|g'   -e 's|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos|g'   /etc/yum.repos.d/CentOS-Base.repo
yum makecache
yum install -y ncurses-devel openssl-devel elfutils-libelf-devel flex bison perl vim bc
yum install -y centos-release-scl
</code></pre>
<p>sclo repo:</p>
<pre><code># cat CentOS-SCLo-scl.repo
[C7.9.2009-centos-sclo-sclo]
name=CentOS-7.9.2009 - SCLo sclo
baseurl=http://mirrors.ustc.edu.cn/centos-vault/7.9.2009/sclo/$basearch/sclo/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
# cat CentOS-SCLo-scl-rh.repo
[C7.9.2009-centos-sclo-rh]
name=CentOS-7.9.2009 - SCLo rh
baseurl=http://mirrors.ustc.edu.cn/centos-vault/7.9.2009/sclo/$basearch/rh/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo
# yum makecache
# sudo yum install -y devtoolset-9-gcc
</code></pre>
<p>Activate the devtoolset:</p>
<pre><code># scl enable devtoolset-9 bash
# gcc --version
gcc (GCC) 9.3.1 20200408 (Red Hat 9.3.1-2)
Copyright (C) 2019 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# scl_source enable devtoolset-9
# axel https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v5.x/linux-5.10.26.tar.xz
# tar xJvf linux-5.10.26.tar.xz
# cp /root/config_5.10.26 .config
# make menuconfig
# make -j16
 # cat /etc/default/grub  | grep DEFAULT
GRUB_DEFAULT=0
# make modules_install &amp;&amp; make install &amp;&amp; grub2-mkconfig -o /boot/grub2/grub.cfg
# curl -fsSL https://get.docker.com -o get-docker.sh
# sudo DOWNLOAD_URL=https://mirrors.ustc.edu.cn/docker-ce sh get-docker.sh
# vim /etc/yum.repos.d/docker-ce.repo 
# gpgcheck=1 --&gt; gpgcheck=0
# sudo DOWNLOAD_URL=https://mirrors.ustc.edu.cn/docker-ce sh get-docker.sh
# systemctl enable docker --now
# vim /etc/docker/daemon.json
{
      "registry-mirrors": [ "https://docker.nju.edu.cn/",
             "https://hub.uuuadc.top",
        "https://docker.anyhub.us.kg",
        "https://dockerhub.jobcher.com",
        "https://dockerhub.icu",
        "https://docker.ckyl.me",
        "https://docker.awsl9527.cn", "https://docker.mirrors.ustc.edu.cn", "https://docker.1ms.run", "https://docker.xuanyuan.me"
      ]
}
# reboot
</code></pre>
<p>Run docker(boot complete):</p>
<pre><code>docker run -itd --privileged --name redroid12 -v ~/data:/data     -p 5555:5555     redroid/redroid:12.0.0-latest
</code></pre>
<h3 id="2-lxc-on-centos7"><a class="header" href="#2-lxc-on-centos7">2. lxc on centos7</a></h3>
<p>lxc build via:</p>
<pre><code>https://github.com/ppira/rpm-lxc/blob/df7064a484fb1004212a20fcda97d28cc9e0a274/lxc.spec
</code></pre>
<p>meson should be installed via:</p>
<pre><code>meson-0.61.5-1.el7.noarch.rpm
</code></pre>
<p>Build:</p>
<pre><code> rpmdev-setuptree
 cp rpm/lxc.spec $HOME/rpmbuild/SPECS/
 cp rpm/lxc-net rpm/lxc-2.0.7-fix-init.patch rpm/lxc-4.0.1-fix-lxc-net.patch $HOME/rpmbuild/SOURCES/
 cp lxc-5.0.2.tar.gz $HOME/rpmbuild/SOURCES
 cd  $HOME/rpmbuild/SPECS/
  rpmbuild -bb lxc.spec 

</code></pre>
<p>Install:</p>
<pre><code>sudo yum install ./lxc-5.0.2-2.el7.x86_64.rpm ./lxc-libs-5.0.2-2.el7.x86_64.rpm ./lxc-static-5.0.2-2.el7.x86_64.rpm ./lxc-templates-5.0.2-2.el7.x86_64.rpm
</code></pre>
<p>Start lxc-net:</p>
<pre><code>  sudo vim /usr/libexec/lxc/lxc-net 
  sudo systemctl start lxc-net.service
</code></pre>
<p>Create lxc container via:</p>
<pre><code> lxc-create -n redroid12 -t oci -- -u docker://swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/redroid/redroid:12.0.0-latest
 lxc-create -n redroid11 -t oci -- -u docker://swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/redroid/redroid:12.0.0_64only-latest
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250513"><a class="header" href="#20250513">20250513</a></h1>
<h3 id="1-openstack-lxc"><a class="header" href="#1-openstack-lxc">1. openstack lxc</a></h3>
<p>Create image via glance:</p>
<pre><code>openstack image create "lxc_ubuntu_12.04" --file precise-server-cloudimg-amd64.img --disk-format raw --container-format bare --public
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250514"><a class="header" href="#20250514">20250514</a></h1>
<h3 id="1-openwrt-issue"><a class="header" href="#1-openwrt-issue">1. openwrt issue</a></h3>
<p>via following command I could not reached the openwrt's intranet:</p>
<pre><code>sudo route add -net 10.0.0.0/24 gw 192.168.1.146
</code></pre>
<p>solved via:</p>
<p><img src="./images/2025_05_14_11_25_11_965x446.jpg" alt="./images/2025_05_14_11_25_11_965x446.jpg" /></p>
<h3 id="2-kolla-ansible"><a class="header" href="#2-kolla-ansible">2. kolla-ansible</a></h3>
<p>two nics with each node:</p>
<pre><code>openstack1 enp1s0(192.168.168.2) enp7s0
openstack2 enp1s0(192.168.168.3) enp7s0
openstack3 enp1s0(192.168.168.4) enp7s0
</code></pre>
<p>On each node:</p>
<pre><code>rm -f /etc/resolv.conf
echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf
apt install -y dnscrypt-proxy
echo "nameserver 127.0.2.1"&gt;/etc/resolv.conf
chattr +i /etc/resolv.conf
</code></pre>
<p>On each node:</p>
<pre><code># vim /etc/hosts
......
192.168.168.2 openstack1
192.168.168.3 openstack2
192.168.168.4 openstack3
# ssh-keygen
# ssh-copy-id root@openstack1
# ssh-copy-id root@openstack2
# ssh-copy-id root@openstack3
</code></pre>
<p>On deploy node(openstack1):</p>
<pre><code>mkdir -p /root/Code/venv
python3 -m venv /root/Code/venv/
source /root/Code/venv/bin/activate
pip install -U pip
pip install 'ansible&gt;=4,&lt;6'
git clone https://github.com/openstack/kolla-ansible -b stable/2024.2
cd kolla-ansible
pip install kolla-ansible
pip isntall -r kolla-ansible/requirements.txt
sudo mkdir -p /etc/kolla
sudo chown $USER:$USER /etc/kolla
cp -r kolla-ansible/etc/kolla/* /etc/kolla
kolla-ansible install-deps
</code></pre>
<p>inventory:</p>
<pre><code>mkdir deploy
cp kolla-ansible/ansible/inventory/* deploy/
</code></pre>
<p><code>vim deploy/multinode</code>:</p>
<pre><code>[control]
openstack1
openstack2
openstack3

[network]
openstack1
openstack2
openstack3

[compute]
openstack1
openstack2
openstack3

[monitoring]
openstack1
openstack2
openstack3
</code></pre>
<p>Generate the password for kolla environment:</p>
<pre><code># kolla-genpwd
# vim  /etc/kolla/passwords.yml
......
keystone_admin_password: 123456hhh
......

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250515"><a class="header" href="#20250515">20250515</a></h1>
<h3 id="1-create-img-for-redroid"><a class="header" href="#1-create-img-for-redroid">1. Create img for redroid</a></h3>
<p>Make img file:</p>
<pre><code>dd if=/dev/null of=example.img bs=1M seek=10240
mkfs.ext4 -F example.img
mkdir /mnt8
mount example.img /mnt8
rsync -av /var/lib/lxc/redroid11/rootfs/* /mnt8
</code></pre>
<h3 id="2-change-the-ubuntu-image-password"><a class="header" href="#2-change-the-ubuntu-image-password">2. change the ubuntu image password</a></h3>
<p>default passwd is not supported, set it via following steps:</p>
<pre><code>apt install -y libguestfs-tools
virt-customize -a /home/dash/jammy-server-cloudimg-amd64.img --root-password password:123456
</code></pre>
<h3 id="3-lxc-related"><a class="header" href="#3-lxc-related">3. lxc related</a></h3>
<p>Domain type:</p>
<pre><code>&lt;domain type='lxc' xmlns:lxc='http://libvirt.org/schemas/domain/lxc/1.0'&gt;
</code></pre>
<p>initargs:</p>
<pre><code>&lt;os&gt;
  &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
  &lt;init&gt;/bin/systemd&lt;/init&gt;
  &lt;initarg&gt;--unit&lt;/initarg&gt;
  &lt;initarg&gt;emergency.service&lt;/initarg&gt;
&lt;/os&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250516"><a class="header" href="#20250516">20250516</a></h1>
<h3 id="1-redroid-on-ubuntu2204-lxc"><a class="header" href="#1-redroid-on-ubuntu2204-lxc">1. redroid on ubuntu2204 lxc</a></h3>
<pre><code>sudo apt install -y docker.io lxc adb
</code></pre>
<h3 id="2-redroid-ubuntu-2004-kernel"><a class="header" href="#2-redroid-ubuntu-2004-kernel">2. redroid ubuntu 2004 kernel</a></h3>
<p>scrcpy could not connect, reason:</p>
<pre><code>DMABUF_HEAP and DMABUF_HEAP_SYSTEM
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250517"><a class="header" href="#20250517">20250517</a></h1>
<h3 id="1-redroidlxcubuntu2204"><a class="header" href="#1-redroidlxcubuntu2204">1. redroidlxcubuntu2204</a></h3>
<p>Install:</p>
<pre><code>apt install -y lxc docker.io  skopeo umoci jq
systemctl --no-pager status lxc-net
sed -i 's/set -eu/set -u/g' /usr/share/lxc/templates/lxc-oci
  lxc-create -n redroid11 -t oci -- -u docker://swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/redroid/redroid:12.0.0_64only-latest
  mkdir $HOME/data-redroid11
  sed -i '/lxc.include/d' /var/lib/lxc/redroid11/config
  &lt;&lt;EOF cat &gt;&gt; /var/lib/lxc/redroid11/config
### hacked
lxc.init.cmd = /init androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest
lxc.apparmor.profile = unconfined
lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000
lxc.mount.entry = $HOME/data-redroid11 data none bind 0 0
EOF

  rm /var/lib/lxc/redroid11/rootfs/vendor/bin/ipconfigstore
  lxc-start -l debug -o redroid11.log -n redroid11
</code></pre>
<p>Connect:</p>
<pre><code>adb connect `lxc-info redroid11 -i | awk '{print $2}'`:5555
connected to 10.0.3.169:5555
</code></pre>
<p>scrcpy failed.</p>
<h3 id="2-redroid-lxc-scrcpy-issue"><a class="header" href="#2-redroid-lxc-scrcpy-issue">2. redroid lxc scrcpy issue</a></h3>
<p>redroid runned via docker could be attached via scrcpy:</p>
<pre><code>redroid_x86_64_only:/ $ ls /dev/dm
dm-user/   dma_heap/
redroid_x86_64_only:/ $ ls /dev/dma_heap/
system
redroid_x86_64_only:/ $ ls /dev/dma_heap/ -l -h
total 0
cr--r--r-- 1 system system 249,   0 2025-05-17 03:06 system
redroid_x86_64_only:/ $ file /dev/dma_heap/system
/dev/dma_heap/system: character special (249/0)
</code></pre>
<p>So maybe in lxc we have to mount more <code>/dev</code> items.</p>
<p>Solved via add <code>dma_heap</code> mounted:</p>
<pre><code># vim /var/lib/lxc/redroid11/config
......
lxc.mount.entry = /root/data-redroid11 data none bind 0 0
+ lxc.mount.entry = /dev/dma_heap dev/dma_heap none bind,optional,create=dir
</code></pre>
<p><img src="./images/2025_05_17_11_20_01_811x852.jpg" alt="./images/2025_05_17_11_20_01_811x852.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250518"><a class="header" href="#20250518">20250518</a></h1>
<h3 id="1-hm-emulator"><a class="header" href="#1-hm-emulator">1. HM emulator</a></h3>
<p>The emulator need hw account, ignored.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250519"><a class="header" href="#20250519">20250519</a></h1>
<h3 id="1-redroid-in-openstack-modification"><a class="header" href="#1-redroid-in-openstack-modification">1. redroid in openstack modification</a></h3>
<p>Modifications in nova:</p>
<pre><code>root@compute:~# diff config.py /usr/lib/python3/dist-packages/nova/virt/libvirt/config.py
2823a2824
&gt;         self.os_init_arg = None
2907a2909,2910
&gt;         if self.os_init_arg is not None:
&gt;             os.append(self._text_node("initarg", self.os_init_arg))
3028a3032,3033
&gt;             elif c.tag == 'initarg':
&gt;                 self.os_init_arg = c.text
root@compute:~# cat /usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py | grep android -A2 -B3
                guest.os_bootmenu = image_meta.properties.hw_boot_menu
        elif CONF.libvirt.virt_type == "lxc":
            #guest.os_init_path = "/sbin/init"
            #guest.os_init_path = "/init androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest"
            #guest.os_init_path = "/init androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest"
            guest.os_init_path = "/system/bin/init"
            guest.os_init_arg = "androidboot.hardware=redroid"
            #guest.os_cmdline = CONSOLE
            guest.os_init_env["product_name"] = "OpenStack Nova"
</code></pre>
<p>I need to configure <code>/dev/dma_heap</code> into the lxc instance, then I could use scrcpy.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250520"><a class="header" href="#20250520">20250520</a></h1>
<h3 id="1-libvirt-lxc-configuration"><a class="header" href="#1-libvirt-lxc-configuration">1. libvirt lxc configuration</a></h3>
<p>AIM:</p>
<pre><code>    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/nova/instances/407229eb-3fa3-4452-9a96-6145682f0e77/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
+    &lt;filesystem type='mount' accessmode='passthrough'&gt;
+      &lt;source dir='/dev/dma_heap'/&gt;
+      &lt;target dir='/dev/dma_heap'/&gt;
+    &lt;/filesystem&gt;
</code></pre>
<p>debug log:</p>
<pre><code>Configuration: &lt;filesystem type="mount"&gt;&lt;source dir="/var/lib/nova/instances/407229eb-3fa3-4452-9a96-6145682f0e77/rootfs"/&gt;&lt;target dir="/"/&gt;&lt;/filesystem&gt;
Configuration: &lt;class 'nova.virt.libvirt.config.LibvirtConfigGuestFilesys'&gt;
Configuration: {'root_name': 'filesystem', 'ns_prefix': None, 'ns_uri': None, 'source_type': 'mount', 'source_dir': '/var/lib/nova/instances/407229eb-3fa3-4452-9a96-6145682f0e77/rootfs', 'source_file': None, 'source_dev': None, 'target_dir': '/', 'driver_type': 'loop', 'driver_format': 'raw'}
Configuration: &lt;filesystem type="mount"&gt;&lt;source dir="/dev/dma_heap"/&gt;&lt;target dir="/dev/dma_heap"/&gt;&lt;/filesystem&gt;

</code></pre>
<p>Final modification:</p>
<pre><code># diff /usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py driver.py 
6515,6518c6515,6516
&lt;             #guest.os_init_path = "/init androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest"
&lt;             #guest.os_init_path = "/system/bin/init"
&lt;             guest.os_init_path = "/init"
&lt;             guest.os_init_arg = "androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest"
---
&gt;             guest.os_init_path = "/system/bin/init"
&gt;             guest.os_init_arg = "androidboot.hardware=redroid"
6901,6933c6899,6904
&lt;         
&lt;         output_file = '/tmp/storage_configurations.log'
&lt;         with open(output_file, 'a') as file_handle:
&lt;             storage_configs = self._get_guest_storage_config(context,
&lt;                     instance, image_meta, disk_info, rescue, block_device_info,
&lt;                     flavor, guest.os_type)
&lt;             for config in storage_configs:
&lt;                 #guest.add_device(config)
&lt;                 # add /dev/dma_heap, should only be applied to lxc type
&lt;                 dma_heap_copy = copy.copy(config)
&lt;                 dma_source_dir = '/dev/dma_heap'
&lt;                 dma_target_dir = '/dev/dma_heap'
&lt;                 dma_heap_copy.source_dir = dma_source_dir
&lt;                 dma_heap_copy.target_dir = dma_target_dir
&lt;                 guest.add_device(dma_heap_copy)
&lt;                 config_str = str(config)
&lt;                 type_config_str = str(type(config))
&lt;                 detailed_config_str = str(config.__dict__)
&lt;                 dma_config_str = str(dma_heap_copy)
&lt;                 # hacking to local directory
&lt;                 hack_copy = copy.copy(config)
&lt;                 hack_source_dir = '/var/lib/lxc/redroid11/rootfs'
&lt;                 hack_target_dir = '/'
&lt;                 hack_copy.source_dir = hack_source_dir
&lt;                 hack_copy.target_dir = hack_target_dir
&lt;                 guest.add_device(hack_copy)
&lt;                 hack_config_str = str(hack_copy)
&lt;                 file_handle.write(f'Configuration: {config_str}\n')
&lt;                 file_handle.write(f'Configuration: {type_config_str}\n')
&lt;                 file_handle.write(f'Configuration: {detailed_config_str}\n')
&lt;                 file_handle.write(f'Configuration: {dma_config_str}\n')
&lt;                 file_handle.write(f'Configuration: {hack_config_str}\n')
&lt;                 
---
&gt; 
&gt;         storage_configs = self._get_guest_storage_config(context,
&gt;                 instance, image_meta, disk_info, rescue, block_device_info,
&gt;                 flavor, guest.os_type)
&gt;         for config in storage_configs:
&gt;             guest.add_device(config)
</code></pre>
<p>modifications for adding initarg:</p>
<pre><code> diff /usr/lib/python3/dist-packages/nova/virt/libvirt/config.py /root/config.py 
2824d2823
&lt;         self.os_init_arg = None
2909,2910d2907
&lt;         if self.os_init_arg is not None:
&lt;             os.append(self._text_node("initarg", self.os_init_arg))
3032,3033d3028
&lt;             elif c.tag == 'initarg':
&lt;                 self.os_init_arg = c.text

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250521"><a class="header" href="#20250521">20250521</a></h1>
<h3 id="1-redroidlxc-with-gpu"><a class="header" href="#1-redroidlxc-with-gpu">1. redroid/lxc with gpu</a></h3>
<p>modify: <code>/usr/lib/python3/dist-packages/nova/virt/libvirt/guest.py</code>:</p>
<pre><code>    @classmethod
    def create(cls, xml, host):
        """Create a new Guest

        :param xml: XML definition of the domain to create
        :param host: host.Host connection to define the guest on

        :returns guest.Guest: Guest ready to be launched
        """
+        output_file = '/tmp/xmlxml.log'
+        with open(output_file, 'a') as file_handle:
+            try:
+                if isinstance(xml, bytes):
+                    xml = xml.decode('utf-8')
+                # following is for debugging purpose
+                #type_guest_str = str(type(guest))
+                #detailed_guest_str = str(guest.__dict__)
+                type_xml_str = str(type(xml))
+                xml_str = str(xml)
+                #file_handle.write(f'Configuration: {type_guest_str}\n')
+                #file_handle.write(f'Configuration: {detailed_guest_str}\n')
+                file_handle.write(f'Configuration: {type_xml_str}\n')
+                file_handle.write(f'Configuration: {xml_str}\n')
+                ### insert some shit into origin xml.
+                # 1. write origin xml
+                with open('/tmp/originxml.txt', 'w') as f:
+                    f.write(xml)
+                # 2. read and modify
+                with open('/tmp/originxml.txt', 'r') as f:
+                    lines = f.readlines()
+                n = len(lines)
+                if n &gt;= 3:
+                    insert_index = n - 2
+                    lines.insert(insert_index, '&lt;hostdev mode=\'capabilities\' type=\'misc\'&gt;\n')
+                    lines.insert(insert_index + 1, '&lt;source&gt;\n')
+                    lines.insert(insert_index + 2, '&lt;char&gt;/dev/dri/renderD128&lt;/char&gt;\n')
+                    lines.insert(insert_index + 3, '&lt;/source&gt;\n')
+                    lines.insert(insert_index + 4, '&lt;/hostdev&gt;\n')
+                    lines.insert(insert_index + 5, '&lt;hostdev mode=\'capabilities\' type=\'misc\'&gt;\n')
+                    lines.insert(insert_index + 6, '&lt;source&gt;\n')
+                    lines.insert(insert_index + 7, '&lt;char&gt;/dev/tty0&lt;/char&gt;\n')
+                    lines.insert(insert_index + 8, '&lt;/source&gt;\n')
+                    lines.insert(insert_index + 9, '&lt;/hostdev&gt;\n')
+                    lines.insert(insert_index + 10, '&lt;console type=\'pty\'&gt;\n')
+                    lines.insert(insert_index + 11, '&lt;target type=\'lxc\' port=\'1\'/&gt;\n')
+                    lines.insert(insert_index + 12, '&lt;/console&gt;\n')
+                # 3. write back modified content
+                with open('/tmp/originxml.txt', 'w') as f:
+                    f.writelines(lines)
+                # 4. read string from files
+                with open('/tmp/originxml.txt', 'r') as f:
+                    modified_string = f.read()
+                xml = modified_string
+                guest = host.write_instance_config(xml)

            except Exception:
                with excutils.save_and_reraise_exception():
                    LOG.error('Error defining a guest with XML: %s',
                              encodeutils.safe_decode(xml))
            return guest


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250522"><a class="header" href="#20250522">20250522</a></h1>
<h3 id="1-virsh-xml"><a class="header" href="#1-virsh-xml">1. virsh xml</a></h3>
<p>Modification:</p>
<pre><code>    @classmethod
    def create(cls, xml, host):
        """Create a new Guest

        :param xml: XML definition of the domain to create
        :param host: host.Host connection to define the guest on

        :returns guest.Guest: Guest ready to be launched
        """
        output_file = '/tmp/xmlxml.log'
        with open(output_file, 'a') as file_handle:
            try:
                if isinstance(xml, bytes):
                    xml = xml.decode('utf-8')
                # following is for debugging purpose
                #type_guest_str = str(type(guest))
                #detailed_guest_str = str(guest.__dict__)
                type_xml_str = str(type(xml))
                xml_str = str(xml)
                #file_handle.write(f'Configuration: {type_guest_str}\n')
                #file_handle.write(f'Configuration: {detailed_guest_str}\n')
                file_handle.write(f'Configuration: {type_xml_str}\n')
                file_handle.write(f'Configuration: {xml_str}\n')
                ### insert some shit into origin xml.
                # 1. write origin xml
                with open('/tmp/originxml.txt', 'w') as f:
                    f.write(xml)
                #  2.2 Read origin content
                with open('/tmp/originxml.txt', 'r') as f:
                    lines = f.readlines()
                #  2.3 Make sure the inserted position
                insert_position = len(lines) - 2
                #  2.4 Read the to be added xml content
                with open('/etc/addedxml_device.txt', 'r') as f_add:
                    add_lines = f_add.readlines()
                #   2.5 insert add_lines to corresponding position
                lines[insert_position:insert_position] = add_lines
                #   3 write back modified content to /tmp/originxml.txt
                with open('/tmp/originxml.txt', 'w') as f:
                    f.writelines(lines)
                #### features should be added into len(lines)-1 
                with open('/tmp/originxml.txt', 'r') as f:
                    lines = f.readlines()
                insert_position = len(lines) - 1
                with open('/etc/addedxml_feature.txt', 'r') as f_add:
                    add_lines = f_add.readlines()
                lines[insert_position:insert_position] = add_lines
                with open('/tmp/originxml.txt', 'w') as f:
                    f.writelines(lines)
                # 4. read string from files
                with open('/tmp/originxml.txt', 'r') as f:
                    modified_string = f.read()
                xml = modified_string
                guest = host.write_instance_config(xml)
            except Exception:
                with excutils.save_and_reraise_exception():
                    LOG.error('Error defining a guest with XML: %s',
                              encodeutils.safe_decode(xml))
            return guest

</code></pre>
<p>Created 2 files:</p>
<pre><code>root@compute:~# cat /etc/addedxml_feature.txt 
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;audit_control state='on'/&gt;
      &lt;audit_write state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;

root@compute:~# cat /etc/addedxml_device.txt 
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='1'/&gt;
    &lt;/console&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/dri/renderD128&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;

</code></pre>
<h3 id="2-generate-lxc-mount-items"><a class="header" href="#2-generate-lxc-mount-items">2. Generate lxc mount items</a></h3>
<p>Script:</p>
<pre><code>$ cat ~/autocreate.sh
for i in `ls /dev`
do
	if [ -d "/dev/"$i ]; then
		echo lxc.mount.entry = /dev/$i dev/$i none bind,optional,create=dir
		#echo $i
	else
		echo lxc.mount.entry = /dev/$i dev/$i none bind,optional,create=file
		#echo kkk $i
fi
done
</code></pre>
<h3 id="3-3dmark-issue"><a class="header" href="#3-3dmark-issue">3. 3dmark issue</a></h3>
<p>Solved via:</p>
<pre><code># vim /var/lib/lxc/xxxx/config
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file

</code></pre>
<p>Issue in lxc:</p>
<pre><code>    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/fuse&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;




[  974.533786] binder_linux: 11387:11387 cannot find target node
[  974.533793] binder_linux: 11387:11387 transaction async to 0:0 failed 201477/29189/-22, size 92-0 line 3063
[  974.705152] binder_linux: 13542:11387 cannot find target node
[  974.705157] binder_linux: 11387:13542 transaction call to 0:0 failed 204744/29189/-22, size 0-0 line 3063

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250523"><a class="header" href="#20250523">20250523</a></h1>
<h3 id="1-redroid-lxc-issue-debugging"><a class="header" href="#1-redroid-lxc-issue-debugging">1. redroid lxc issue debugging</a></h3>
<p>Should start lxc instance without graphical gui under vm(virtio).</p>
<h3 id="2-arm-environment"><a class="header" href="#2-arm-environment">2. arm environment</a></h3>
<p>D3000 network configuration:</p>
<pre><code>test@2504vm:~$ cat /etc/netplan/eth0.yaml 
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
  bridges:
    br0:
      interfaces: [eth0]
      addresses: [10.171.172.4/24]
      gateway4: 10.171.172.1

test@2504vm:~$ cat /etc/issue
Ubuntu 25.04 \n \l

test@2504vm:~$ uname -a
Linux 2504vm 6.14.0-15-generic #15-Ubuntu SMP PREEMPT_DYNAMIC Sun Apr  6 14:37:51 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux
</code></pre>
<p>X86 bridged configuration:</p>
<pre><code>nmcli connection add type bridge ifname br0 stp no
nmcli conn add type bridge ifname br0 ipv4.method manual ipv4.address "10.171.172.3/24" ipv4.gateway "10.171.172.1" ipv4.dns 223.5.5.5
nmcli connection add type bridge-slave ifname enp89s0 master br0

root@fedora:~# uname -a
Linux fedora 6.14.2-300.fc42.x86_64 #1 SMP PREEMPT_DYNAMIC Thu Apr 10 21:50:55 UTC 2025 x86_64 GNU/Linux
root@fedora:~# cat /etc/redhat-release 
Fedora release 42 (Adams)
</code></pre>
<p>IP configuration:</p>
<pre><code>x86: 10.171.172.3, br0
arm64: d3000: 10.171.172.4, br0, ubuntu24.04 host
</code></pre>
<p>Create x86(controller) environment:</p>
<pre><code>qemu-img create -f qcow2 openstack_controller.qcow2 -b ubuntu2204amd64_150G.qcow2 -F qcow2
</code></pre>
<p>Ubuntu22.04 arm64 vm failed. so should switches to host machine(physical machine).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250524"><a class="header" href="#20250524">20250524</a></h1>
<h3 id="1-arm64-nova-libvirt-lxc"><a class="header" href="#1-arm64-nova-libvirt-lxc">1. arm64-nova-libvirt-lxc</a></h3>
<p>Working tips:</p>
<p>machine configuration, compute/controller node:</p>
<pre><code># crontab -e
@reboot sleep 10 &amp;&amp; modprobe binder_linux devices="binder,hwbinder,vndbinder" &amp;&amp; modprobe nbd
</code></pre>
<p>Image test:</p>
<pre><code>wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-arm64.tar.gz
source /etc/keystone/admin-openrc.sh 
openstack image create "lxc_ubuntu_22.04" --file jammy-server-cloudimg-arm64.img --disk-format raw --container-format bare --public

# openstack image list
+--------------------------------------+------------------+--------+
| ID                                   | Name             | Status |
+--------------------------------------+------------------+--------+
| a0011671-0e42-416e-87bc-eead6ee5431d | lxc_ubuntu_22.04 | active |
+--------------------------------------+------------------+--------+
</code></pre>
<p>Compute node install lxc:</p>
<pre><code>apt install -y nova-compute-lxc
...
Configuration file '/etc/nova/nova-compute.conf'
 ==&gt; Modified (by you or by a script) since installation.
 ==&gt; Package distributor has shipped an updated version.
   What would you like to do about it ?  Your options are:
    Y or I  : install the package maintainer's version
    N or O  : keep your currently-installed version
      D     : show the differences between the versions
      Z     : start a shell to examine the situation
 The default action is to keep your current version.
*** nova-compute.conf (Y/I/N/O/D/Z) [default=N] ? Y
...

service nova-compute restart
</code></pre>
<p>After installation of <code>nova-compute-lxc</code>:</p>
<pre><code>openstack compute service list
+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+
| ID                                   | Binary         | Host       | Zone     | Status  | State | Updated At                 |
+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+
| d23f2977-5a64-4161-81aa-56bc57470a38 | nova-scheduler | controller | internal | enabled | up    | 2025-05-24T01:46:06.000000 |
| 41520a5c-740f-4922-b0d1-50b671408bca | nova-conductor | controller | internal | enabled | up    | 2025-05-24T01:45:58.000000 |
| 8e25e510-9a39-433f-bd0f-4737e0082121 | nova-compute   | compute    | nova     | enabled | up    | 2025-05-24T01:45:48.000000 |
+--------------------------------------+----------------+------------+----------+---------+-------+----------------------------+
openstack flavor create --vcpus 4 --ram 6124 --disk 25 C4-6124MB-25G

</code></pre>
<p>Replace the lxc package:</p>
<pre><code>apt remove libvirt-daemon-driver-lxc --purge
apt install -y ./libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb 
reboot
</code></pre>
<h3 id="2-build-libvirt-with-lxc-patch"><a class="header" href="#2-build-libvirt-with-lxc-patch">2. build libvirt with lxc patch</a></h3>
<p>Steps:</p>
<pre><code># vim /etc/apt/sources.list
uncomment all of the "# deb-src"
# apt update -y
mkdir libvirt
cd libvirt/
apt source libvirt-daemon-driver-lxc
apt install -y build-essential pbuilder
apt-get build-dep libvirt-daemon-driver-lxc
</code></pre>
<p>Code modification:</p>
<pre><code>libvirt-8.0.0# cat src/lxc/lxc_controller.c | grep -i 25000000 -B1 -A1
    /*opts = g_strdup_printf("mode=755,size=65536%s", mount_options);*/
    opts = g_strdup_printf("mode=755,size=25000000%s", mount_options);
</code></pre>
<p>Build deb:</p>
<pre><code>root@compute:~/Code/libvirt/libvirt-8.0.0# pwd
/root/Code/libvirt/libvirt-8.0.0
root@compute:~/Code/libvirt/libvirt-8.0.0# ls
AUTHORS.rst     configmake.h.in   docs                 libvirt-lxc.pc.in   meson.build            README.rst  tools
AUTHORS.rst.in  CONTRIBUTING.rst  examples             libvirt.pc.in       meson_options.txt      run.in
build-aux       COPYING           gitdm.config         libvirt-qemu.pc.in  mingw-libvirt.spec.in  scripts
ci              COPYING.LESSER    include              libvirt.spec        NEWS.rst               src
config.h        debian            libvirt-admin.pc.in  libvirt.spec.in     po                     tests
root@compute:~/Code/libvirt/libvirt-8.0.0# dpkg-source --commit
root@compute:~/Code/libvirt/libvirt-8.0.0# debuild -us -uc
# ls ../*.deb
../libnss-libvirt_8.0.0-1ubuntu7.11_arm64.deb
../libvirt0_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-clients_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-config-network_8.0.0-1ubuntu7.11_all.deb
../libvirt-daemon-config-nwfilter_8.0.0-1ubuntu7.11_all.deb
../libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-qemu_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-storage-gluster_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-storage-iscsi-direct_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-storage-rbd_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-storage-zfs_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-driver-xen_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-system_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-daemon-system-systemd_8.0.0-1ubuntu7.11_all.deb
../libvirt-daemon-system-sysv_8.0.0-1ubuntu7.11_all.deb
../libvirt-dev_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-doc_8.0.0-1ubuntu7.11_all.deb
../libvirt-login-shell_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-sanlock_8.0.0-1ubuntu7.11_arm64.deb
../libvirt-wireshark_8.0.0-1ubuntu7.11_arm64.deb

</code></pre>
<p>Install deb steps see above</p>
<h3 id="3-generate-arm64-lxc-image"><a class="header" href="#3-generate-arm64-lxc-image">3. generate arm64 lxc image</a></h3>
<p>Create lxc instance:</p>
<pre><code>modprobe binder_linux devices="binder,hwbinder,vndbinder"
apt install -y skopeo umoci jq
sed -i 's/set -eu/set -u/g' /usr/share/lxc/templates/lxc-oci
lxc-create -n redroid12 -t oci -- -u docker://docker.io/redroid/redroid:12.0.0_64only-latest
rm /var/lib/lxc/redroid12/rootfs/vendor/bin/ipconfigstore
</code></pre>
<p>added patched:</p>
<pre><code>$ sed -i '/lxc.include/d' /var/lib/lxc/redroid12/config
$ vim /var/lib/lxc/redroid12/config
......
### hacked
lxc.init.cmd = /init androidboot.hardware=redroid androidboot.redroid_gpu_mode=host androidboot.redroid_gpu_node=/dev/dri/ren
derD128
lxc.apparmor.profile = unconfined
#lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000
lxc.mount.entry = /dev/dma_heap dev/dma_heap none bind,optional,create=dir
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file

</code></pre>
<p>After examine the lxc instance, convert it into openstack img:</p>
<pre><code>dd if=/dev/null of=redroid12.img bs=1M seek=10240
mkfs.ext4 -F redroid12.img 
mount redroid12.img  /mnt8
rsync -av /var/lib/lxc/redroid12/rootfs/* /mnt8
sync
umount /mnt8
</code></pre>
<p>Create openstack usable disk image:</p>
<pre><code>openstack image create "redroid12" --file redroid12.img --disk-format raw --container-format bare --public
</code></pre>
<h3 id="4-docker-issue"><a class="header" href="#4-docker-issue">4. docker issue</a></h3>
<p>Ubuntu22.04 5.15 kernel, install docker cause:</p>
<pre><code>May 24 10:56:41 compute dockerd[32267]: failed to start daemon: Error initializing network controller: error creating default "bridge" network: Failed to program NAT chain: failed to inject DOCKER in PREROUTING chain: iptables failed: iptables --wait -t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER: iptables v1.8.7 (nf_tables): Couldn't load match `addrtype':No such file or directory
May 24 10:56:41 compute dockerd[32267]: Try `iptables -h' or 'iptables --help' for more information.
May 24 10:56:41 compute dockerd[32267]:  (exit status 2)
May 24 10:56:41 compute dockerd[32267]: time="2025-05-24T10:56:41.210508600+08:00" level=info msg="stopping event stream following graceful shutdown" error="context canceled" module=libcontainerd namespace=plugins.moby
May 24 10:56:41 compute systemd[1]: docker.service: Main process exited, code=exited, status=1/FAILURE
</code></pre>
<p>Solved via:</p>
<pre><code>echo "blacklist x_tables"&gt;&gt;/etc/modprobe.d/blacklist.conf
</code></pre>
<h3 id="5-horizon"><a class="header" href="#5-horizon">5. horizon</a></h3>
<p><img src="./images/2025_05_24_13_08_39_1111x837.jpg" alt="./images/2025_05_24_13_08_39_1111x837.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250525"><a class="header" href="#20250525">20250525</a></h1>
<h3 id="1-openstack-lxcredroid-arm64"><a class="header" href="#1-openstack-lxcredroid-arm64">1. openstack lxc/redroid arm64</a></h3>
<p>Steps:</p>
<pre><code>$ ls
addedxml_device.txt  bashhistory  config  libvirt  redroid12.img  virt
</code></pre>
<p>compute node:</p>
<pre><code>apt install -y ./libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb
</code></pre>
<p>controller, create flavor:</p>
<pre><code>openstack flavor create --vcpus 4 --ram 6124 --disk 25 C4-6124MB-25G
</code></pre>
<p>controller, create image:</p>
<pre><code>openstack image create "redroid12" --file redroid12.img --disk-format raw --container-format bare --public
</code></pre>
<p>Controller/compute:</p>
<pre><code># cp config.py driver.py guest.py /usr/lib/python3/dist-packages/nova/virt/libvirt/
# pwd
/root/ubuntu2204openstack/virt/libvirt
# cd /usr/lib/python3/dist-packages/nova/ &amp;&amp; find . | grep pyc$ | xargs -I % mv % %.kk

...
root@controller:~/ubuntu2204openstack# cp addedxml_* /etc/

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250526"><a class="header" href="#20250526">20250526</a></h1>
<h3 id="1-arm64-openstack-neutron"><a class="header" href="#1-arm64-openstack-neutron">1. arm64 openstack neutron</a></h3>
<p>home image:</p>
<pre><code>ubuntu 2504 host:    
inner, could be ping, OK
external, not OK

fedora 42 host:  
inner , could also be pinged.   
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>host</th><th>how-to</th></tr></thead><tbody>
<tr><td>arm64 d3000</td><td>ubuntu 2504 host+ubuntu2204 guest(terminal)</td></tr>
<tr><td>arm64 d3000</td><td>ctyunos host+ubuntu2204 guest(graphical)</td></tr>
<tr><td>windows arm11</td><td>hyper-v + ubuntu2204 guest</td></tr>
</tbody></table>
</div>
<h3 id="2-openstack-installation-steps"><a class="header" href="#2-openstack-installation-steps">2. openstack installation steps</a></h3>
<p>two nodes, ubuntu22.04 vm, configuration for network:</p>
<pre><code>controller:   
# cat /etc/netplan/enp3s0.yaml 
network:
  version: 2
  ethernets:
    enp3s0:
      dhcp4: false
      addresses: [192.168.200.40/24]
      gateway4: 192.168.200.1
    enp4s0:
      dhcp4: false
# touch /etc/cloud/cloud-init.disabled
compute:    
# cat /etc/netplan/enp3s0.yaml 
network:
  version: 2
  ethernets:
    enp3s0:
      dhcp4: false
      addresses: [192.168.200.50/24]
      gateway4: 192.168.200.1
    enp4s0:
      dhcp4: false
hostnamectl set-hostname controller
hostnamectl set-hostname compute
</code></pre>
<h4 id="21-clientmariadb"><a class="header" href="#21-clientmariadb">2.1 client/mariadb</a></h4>
<pre><code>root@controller:~# apt install -y python3-openstackclient mariadb-server python3-pymysql
</code></pre>
<p>Ignored...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250527"><a class="header" href="#20250527">20250527</a></h1>
<h3 id="1-bridgedx86arm64"><a class="header" href="#1-bridgedx86arm64">1. bridged(x86+arm64)</a></h3>
<h4 id="11-environment"><a class="header" href="#11-environment">1.1 environment</a></h4>
<p>Machines:</p>
<pre><code>Nuc: 10.171.172.3/24(br0), fedora x86_64 release 42(Adams)
arm64: 10.171.172.20/24(br0), Ubuntu 25.04 aarch64
</code></pre>
<p>Disk:</p>
<pre><code>controller(x86):   # cp openstack1.qcow2 bridged_openstack_controller.qcow2, 31G
compute(arm64): # cp hope_openstack_compute.qcow2 bridged_compute.qcow2, 42G
</code></pre>
<h4 id="12-vms"><a class="header" href="#12-vms">1.2 vms</a></h4>
<p>Controller:</p>
<p><img src="./images/2025_05_27_10_05_51_439x282.jpg" alt="./images/2025_05_27_10_05_51_439x282.jpg" /></p>
<p><img src="./images/2025_05_27_10_04_51_488x439.jpg" alt="./images/2025_05_27_10_04_51_488x439.jpg" /></p>
<p>two nics:</p>
<p><img src="./images/2025_05_27_10_05_11_695x587.jpg" alt="./images/2025_05_27_10_05_11_695x587.jpg" /></p>
<p>Compute:</p>
<p><img src="./images/2025_05_27_10_02_28_456x444.jpg" alt="./images/2025_05_27_10_02_28_456x444.jpg" /></p>
<p><img src="./images/2025_05_27_10_03_03_445x439.jpg" alt="./images/2025_05_27_10_03_03_445x439.jpg" /></p>
<p>two nics:</p>
<p><img src="./images/2025_05_27_10_03_47_630x543.jpg" alt="./images/2025_05_27_10_03_47_630x543.jpg" /></p>
<h4 id="13-basic-configurations"><a class="header" href="#13-basic-configurations">1.3 Basic configurations</a></h4>
<p>Controller(10.171.172.21):</p>
<p><img src="./images/2025_05_27_10_08_31_724x528.jpg" alt="./images/2025_05_27_10_08_31_724x528.jpg" /></p>
<pre><code># vim /etc/systemd/system/network-online.target.wants/NetworkManager-wait-online.service
...
Type=oneshot
ExecStart=/usr/bin/nm-online -s -q
RemainAfterExit=yes
TimeoutStartSec=5sec
</code></pre>
<p>Compute(10.171.172.22):</p>
<p><img src="./images/2025_05_27_10_11_50_345x182.jpg" alt="./images/2025_05_27_10_11_50_345x182.jpg" /></p>
<p>virgl:</p>
<p><img src="./images/2025_05_27_10_13_22_540x399.jpg" alt="./images/2025_05_27_10_13_22_540x399.jpg" /></p>
<p><img src="./images/2025_05_27_10_13_30_484x479.jpg" alt="./images/2025_05_27_10_13_30_484x479.jpg" /></p>
<pre><code># vim /etc/systemd/system/network-online.target.wants/systemd-networkd-wait-online.service
...
TimeoutStartSec=5sec
</code></pre>
<p>then start the vm with command line: <code>virsh start bridged_openstack_compute</code></p>
<p>Wrong:<br />
The IP address range changed. need re-deploy</p>
<h3 id="2-re-deploy"><a class="header" href="#2-re-deploy">2. re-deploy</a></h3>
<p>Re-create image:</p>
<pre><code>x86: qemu-img create -f qcow2 -b ubuntu2204openstackbase.qcow2 bridged_openstack_controller.qcow2 -F qcow2
arm64: # qemu-img create -f qcow2 -b openstack_arm64_baase_150G.qcow2 -F qcow2 bridged_compute.qcow2
</code></pre>
<p>Set hostname:</p>
<pre><code>hostnamectl set-hostname controller
hostnamectl set-hostname compute
</code></pre>
<p>Each host:</p>
<pre><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF
10.171.172.21 controller
10.171.172.22 compute
EOF
timedatectl set-ntp true &amp;&amp; timedatectl set-timezone Asia/Shanghai
apt update -y &amp;&amp; apt upgrade -y
</code></pre>
<p>Controller:</p>
<pre><code>apt install -y python3-openstackclient  mariadb-server python3-pymysql
cat &gt; /etc/mysql/mariadb.conf.d/99-openstack.cnf &lt;&lt; EOF
[mysqld]
bind-address = 0.0.0.0

default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4096
collation-server = utf8_general_ci
character-set-server = utf8
EOF
service mysql restart

mysql_secure_installation

输入数据库密码：回车
可以在没有适当授权的情况下登录到MariaDB root用户，当前已收到保护：n
设置root用户密码：n
删除匿名用户：y
不允许远程root登录：n
删除测试数据库：y
重新加载数据库：y

apt install -y rabbitmq-server
rabbitmqctl add_user openstack openstackhuhy
rabbitmqctl set_permissions openstack ".*" ".*" ".*"
apt install -y memcached python3-memcache
vim /etc/memcached.conf

-l 0.0.0.0

service memcached restart

mysql -uroot -p000000
CREATE DATABASE keystone;
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'keystonehuhy';
quit
apt install -y keystone
vim /etc/keystone/keystone.conf
[DEFAULT]
log_dir = /var/log/keystone
[application_credential]
[assignment]
[auth]
[cache]
[catalog]
[cors]
[credential]

[database]
connection = mysql+pymysql://keystone:keystonehuhy@controller/keystone

[domain_config]
[endpoint_filter]
[endpoint_policy]
[eventlet_server]
[extra_headers]
Distribution = Ubuntu
[federation]
[fernet_receipts]
[fernet_tokens]
[healthcheck]
[identity]
[identity_mapping]
[jwt_tokens]
[ldap]
[memcache]
[oauth1]
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[policy]
[profiler]
[receipt]
[resource]
[revoke]
[role]
[saml]
[security_compliance]
[shadow_users]

[token]
provider = fernet
[tokenless_auth]
[totp]
[trust]
[unified_limit]
[wsgi]

su -s /bin/sh -c "keystone-manage db_sync" keystone
keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
keystone-manage bootstrap --bootstrap-password 000000 --bootstrap-admin-url http://controller:5000/v3/ --bootstrap-internal-url http://controller:5000/v3/ --bootstrap-public-url http://controller:5000/v3/ --bootstrap-region-id RegionOne
echo "ServerName controller" &gt;&gt; /etc/apache2/apache2.conf 
service apache2 restart

cat &gt; /etc/keystone/admin-openrc.sh &lt;&lt; EOF
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=000000
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
EOF

source /etc/keystone/admin-openrc.sh
openstack project create --domain default --description "Service Project" service
openstack token issue
mysql -uroot -p000000
CREATE DATABASE glance;
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'glancehuhy';
quit

openstack user create --domain default --password glance glance; \
openstack role add --project service --user glance admin; \
openstack service create --name glance --description "OpenStack Image" image

openstack endpoint create --region RegionOne image public http://controller:9292; \
openstack endpoint create --region RegionOne image internal http://controller:9292; \
openstack endpoint create --region RegionOne image admin http://controller:9292

apt install -y glance
vim /etc/glance/glance-api.conf
[DEFAULT]
[barbican]
[barbican_service_user]
[cinder]
[cors]
[database]
connection = mysql+pymysql://glance:glancehuhy@controller/glance

[glance_store]
stores = file,http
default_store = file
filesystem_store_datadir = /var/lib/glance/images/

[image_format]
disk_formats = ami,ari,aki,vhd,vhdx,vmdk,raw,qcow2,vdi,iso,ploop.root-tar

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = glance
password = glance

[paste_deploy]
flavor = keystone
su -s /bin/sh -c "glance-manage db_sync" glance
service glance-api restart

mysql -uroot -p000000
CREATE DATABASE placement;
GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'%' IDENTIFIED BY 'placementhuhy';
quit

openstack user create --domain default --password placement placement; \
openstack role add --project service --user placement admin; \
openstack service create --name placement --description "Placement API" placement

openstack endpoint create --region RegionOne placement public http://controller:8778; \
openstack endpoint create --region RegionOne placement internal http://controller:8778; \
openstack endpoint create --region RegionOne placement admin http://controller:8778

apt install -y placement-api

vim /etc/placement/placement.conf

[DEFAULT]

[api]
auth_strategy = keystone

[cors]

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = placement
password = placement

[placement_database]
connection = mysql+pymysql://placement:placementhuhy@controller/placement

su -s /bin/sh -c "placement-manage db sync" placement
service apache2 restart
placement-status upgrade check


mysql -uroot -p000000
CREATE DATABASE nova_api;
CREATE DATABASE nova;
CREATE DATABASE nova_cell0;
GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' IDENTIFIED BY 'novahuhy';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'novahuhy';
GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'%' IDENTIFIED BY 'novahuhy';
quit

openstack user create --domain default --password nova nova; \
openstack role add --project service --user nova admin; \
openstack service create --name nova --description "OpenStack Compute" compute

openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1; \
openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1; \
openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1

apt install -y nova-api nova-conductor nova-novncproxy nova-scheduler

vim /etc/nova/nova.conf

[DEFAULT]
log_dir = /var/log/nova
lock_path = /var/lock/nova
state_path = /var/lib/nova
transport_url = rabbit://openstack:openstackhuhy@controller:5672/
my_ip = 10.171.172.21

[api]
auth_strategy = keystone
[api_database]
connection = mysql+pymysql://nova:novahuhy@controller/nova_api
[barbican]
[barbican_service_user]
[cache]
[cinder]
[compute]
[conductor]
[console]
[consoleauth]
[cors]
[cyborg]

[database]
connection = mysql+pymysql://nova:novahuhy@controller/nova
[devices]
[ephemeral_storage_encryption]
[filter_scheduler]

[glance]
api_servers = http://controller:9292
[guestfs]
[healthcheck]
[hyperv]
[image_cache]
[ironic]
[key_manager]
[keystone]

[keystone_authtoken]
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = nova
[libvirt]
[metrics]
[mks]
[neutron]
[notifications]

[oslo_concurrency]
lock_path = /var/lib/nova/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[pci]

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement
[powervm]
[privsep]
[profiler]
[quota]
[rdp]
[remote_debug]
[scheduler]
[serial_console]
[service_user]
[spice]
[upgrade_levels]

[vault]
[vendordata_dynamic_auth]
[vmware]

[vnc]
enabled = true
server_listen = $my_ip
server_proxyclient_address = $my_ip
[workarounds]
[wsgi]
[zvm]

[cells]
enable = False
[os_region_name]
openstack = 

su -s /bin/sh -c "nova-manage api_db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
su -s /bin/sh -c "nova-manage db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova

cat &gt; /root/nova-restart.sh &lt;&lt;EOF 
#!bin/bash
# 处理api服务
service nova-api restart
# 处理资源调度服务
service nova-scheduler restart
# 处理数据库服务
service nova-conductor restart
# 处理vnc远程窗口服务
service nova-novncproxy restart
EOF

bash nova-restart.sh
</code></pre>
<p>nova compute:</p>
<pre><code>apt install -y nova-compute
vi /etc/nova/nova.conf
# cat /etc/nova/nova.conf 
[DEFAULT]
log_dir = /var/log/nova
lock_path = /var/lock/nova
state_path = /var/lib/nova
transport_url = rabbit://openstack:openstackhuhy@controller
my_ip = 10.171.172.22

[api]
auth_strategy = keystone
[api_database]
[barbican]
[barbican_service_user]
[cache]
[cinder]
[compute]
[conductor]
[console]
[consoleauth]
[cors]
[cyborg]
[database]
[devices]
[ephemeral_storage_encryption]
[filter_scheduler]

[glance]
api_servers = http://controller:9292
[guestfs]
[healthcheck]
[hyperv]
[image_cache]
[ironic]
[key_manager]
[keystone]

[keystone_authtoken]
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = nova
[libvirt]
[metrics]
[mks]
[neutron]
[notifications]

[oslo_concurrency]
lock_path = /var/lib/nova/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[pci]

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement
[powervm]
[privsep]
[profiler]
[quota]
[rdp]
[remote_debug]
[scheduler]
[serial_console]
[service_user]
[spice]
[upgrade_levels]
[vault]
[vendordata_dynamic_auth]
[vmware]

[vnc]
enabled = true
server_listen = 0.0.0.0
server_proxyclient_address = $my_ip
novncproxy_base_url = http://10.171.172.21:6080/vnc_auto.html
[workarounds]
[wsgi]
[zvm]
[cells]
enable = False
[os_region_name]
openstack =

service nova-compute restart
</code></pre>
<p>(Controller): Discover the available compute node:</p>
<pre><code>openstack compute service list --service nova-compute
su -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose" nova
vim /etc/nova/nova.conf
[scheduler]
discover_hosts_in_cells_interval = 300
</code></pre>
<p>neutron:</p>
<pre><code>mysql -uroot -p000000
CREATE DATABASE neutron;
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'neutronhuhy';
quit

openstack user create --domain default --password neutron neutron; \
openstack role add --project service --user neutron admin; \
openstack service create --name neutron --description "OpenStack Networking" network

openstack endpoint create --region RegionOne network public http://controller:9696; \
openstack endpoint create --region RegionOne network internal http://controller:9696; \
openstack endpoint create --region RegionOne network admin http://controller:9696

cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
# 用于控制系统是否开启对数据包源地址的校验，关闭
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
# 开启二层转发设备
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
EOF

modprobe br_netfilter
sysctl -p

apt install -y neutron-server neutron-plugin-ml2  neutron-l3-agent neutron-dhcp-agent  neutron-metadata-agent neutron-openvswitch-agent

vim /etc/neutron/neutron.conf
[DEFAULT]
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = true
auth_strategy = keystone
state_path = /var/lib/neutron
dhcp_agent_notification = true
allow_overlapping_ips = true
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true
transport_url = rabbit://openstack:openstackhuhy@controller

[agent]
root_helper = "sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf"

[database]
connection = mysql+pymysql://neutron:neutronhuhy@controller/neutron

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron

[nova]
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = nova
password = nova

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp

vim /etc/neutron/plugins/ml2/ml2_conf.ini
[DEFAULT]
[ml2]
type_drivers = flat,vlan,vxlan,gre
tenant_network_types = vxlan
mechanism_drivers = openvswitch,l2population
extension_drivers = port_security

[ml2_type_flat]
flat_networks = physnet1

[ml2_type_geneve]

[ml2_type_gre]

[ml2_type_vlan]

[ml2_type_vxlan]
vni_ranges = 1:1000

[ovs_driver]

[securitygroup]
enable_ipset = true
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
[sriov_driver]


vim /etc/neutron/plugins/ml2/openvswitch_agent.ini
[DEFAULT]
[agent]
l2_population = True
tunnel_types = vxlan
prevent_arp_spoofing = True

[dhcp]
[network_log]

[ovs]
local_ip = 10.171.172.21
bridge_mappings = physnet1:br-enpkkk
[securitygroup]

vim /etc/neutron/l3_agent.ini
[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
external_network_bridge =
[agent]
[network_log]
[ovs]

vim /etc/neutron/dhcp_agent.ini
[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = True
[agent]
[ovs]

vim /etc/neutron/metadata_agent.ini
[DEFAULT]
nova_metadata_host = controller
metadata_proxy_shared_secret = huhy
[agent]
[cache]

vim /etc/nova/nova.conf
default]
linuxnet_interface_driver = nova.network.linux_net.LinuxOVSlnterfaceDriver

[neutron]
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron
service_metadata_proxy = true
metadata_proxy_shared_secret = huhy

su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron

service nova-api restart
ovs-vsctl add-br br-enpkkk
ovs-vsctl add-port  br-enpkkk enp2s0
cat &gt; neutron-restart.sh  &lt;&lt;EOF
#!bin/bash
# 提供neutron服务
service neutron-server restart
# 提供ovs服务
service neutron-openvswitch-agent restart
# 提供地址动态服务
service neutron-dhcp-agent restart
# 提供元数据服务
service neutron-metadata-agent restart
# 提供三层网络服务
service neutron-l3-agent restart
EOF

bash neutron-restart.sh

</code></pre>
<p>(neutron) compute node:</p>
<pre><code>cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
# 用于控制系统是否开启对数据包源地址的校验，关闭
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
# 开启二层转发设备
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
EOF

modprobe br_netfilter
sysctl -p

apt install -y neutron-openvswitch-agent

vim /etc/neutron/neutron.conf

[DEFAULT]
core_plugin = ml2
service_plugins = router
auth_strategy = keystone
state_path = /var/lib/neutron
allow_overlapping_ips = true
transport_url = rabbit://openstack:openstackhuhy@controller

[agent]
root_helper = "sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf"
[cache]
[cors]
[database]
[healthcheck]
[ironic]

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron

[nova]

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[placement]
[privsep]
[quotas]
[ssl]

vim /etc/neutron/plugins/ml2/openvswitch_agent.ini
[DEFAULT]
[agent]
l2_population = True
tunnel_types = vxlan
prevent_arp_spoofing = True
[dhcp]
[network_log]

[ovs]
local_ip = 10.171.172.22
bridge_mappings = physnet1:br-enpkkk
[securitygroup]
enable_security_group = True
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver

vim /etc/nova/nova.conf

[DEFAULT]
linuxnet_interface_driver = nova.network.linux_net.LinuxOVSlnterfaceDriver
vif_plugging_is_fatal = true
vif_pligging_timeout = 300

[neutron]
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron

service nova-compute restart

ovs-vsctl add-br br-enpkkk
ovs-vsctl add-port br-enpkkk enp4s0

service neutron-openvswitch-agent restart
</code></pre>
<p>(controller), dashboard:</p>
<pre><code>apt install -y openstack-dashboard

vim /etc/openstack-dashboard/local_settings.py

# 配置仪表板以在控制器节点上使用OpenStack服务
OPENSTACK_HOST = "controller"

# 在Dashboard configuration部分中，允许主机访问Dashboard
ALLOWED_HOSTS = ["*"]

# 配置memcached会话存储服务
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'

CACHES = {
    'default': {
         'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',
         'LOCATION': 'controller:11211',
    }
}

# 启用Identity API版本3
OPENSTACK_KEYSTONE_URL = "http://%s:5000/v3" % OPENSTACK_HOST

# 启用对域的支持
OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True

# 配置API版本
OPENSTACK_API_VERSIONS = {
    "identity": 3,
    "image": 2,
    "volume": 3,
}

# 将Default配置为通过仪表板创建的用户的默认域
OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = "Default"

# 将用户配置为通过仪表板创建的用户的默认角色
OPENSTACK_KEYSTONE_DEFAULT_ROLE = "user"

# 启用卷备份
OPENSTACK_CINDER_FEATURES = {
    'enable_backup': True,
}

# 配置时区
TIME_ZONE = "Asia/Shanghai"
systemctl reload apache2
</code></pre>
<p>Create network:</p>
<pre><code>source /etc/keystone/admin-openrc.sh
openstack router create Ext-Router
openstack network create --internal --provider-network-type vxlan int-net
openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
openstack router add subnet Ext-Router int-net-sub
openstack network create --provider-physical-network physnet1 --provider-network-type flat  --external ext-net
openstack subnet create ext-net-sub --network ext-net --subnet-range 10.171.172.21/24  --allocation-pool start=10.171.172.100,end=10.171.172.200 --gateway 10.171.172.1 --dns-nameserver 114.114.114.114 --dhcp
openstack router set Ext-Router --external-gateway ext-net
</code></pre>
<p>dashboard: 10.171.172.21/horizon:</p>
<p><img src="./images/2025_05_27_11_31_02_505x469.jpg" alt="./images/2025_05_27_11_31_02_505x469.jpg" /></p>
<p>admin/000000/default:</p>
<p><img src="./images/2025_05_27_11_31_21_514x504.jpg" alt="./images/2025_05_27_11_31_21_514x504.jpg" /></p>
<p><img src="./images/2025_05_27_11_31_55_878x672.jpg" alt="./images/2025_05_27_11_31_55_878x672.jpg" /></p>
<p>Create flavor:</p>
<pre><code>openstack flavor create --vcpus 4 --ram 6124 --disk 25 C4-6124MB-25G
</code></pre>
<p>Create image:</p>
<pre><code>openstack image create "redroid12_32bit" --file redroid1232bit.img --disk-format raw --container-format bare --public
</code></pre>
<h3 id="3-adjustverification"><a class="header" href="#3-adjustverification">3. adjust/verification</a></h3>
<p>compute node:</p>
<pre><code># apt install -y nova-compute-lxc
# cat /etc/nova/nova-compute.conf 
[DEFAULT]
compute_driver=libvirt.LibvirtDriver
[libvirt]
virt_type=lxc
# apt install ./libvirt/libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb 
# cd virt/libvirt/
# cp config.py driver.py guest.py /usr/lib/python3/dist-packages/nova/virt/libvirt/
# cd /usr/lib/python3/dist-packages/nova/ &amp;&amp; find . | grep pyc$ | xargs -I % mv % %.kk
# cd ~/ubuntu2204openstack/
</code></pre>
<p>All node:</p>
<pre><code>crontab -e
@reboot sleep 10 &amp;&amp; modprobe binder_linux devices="binder,hwbinder,vndbinder" &amp;&amp; modprobe nbd

# cat /etc/modprobe.d/blacklist.conf
......
blacklist x_tables
</code></pre>
<p>controller node:</p>
<pre><code># cp config.py driver.py guest.py /usr/lib/python3/dist-packages/nova/virt/libvirt/
# cd /usr/lib/python3/dist-packages/nova/ &amp;&amp; find . | grep pyc$ | xargs -I % mv % %.kk
</code></pre>
<p>Now you could create the instance from horizon:</p>
<p><img src="./images/2025_05_27_14_32_19_1411x410.jpg" alt="./images/2025_05_27_14_32_19_1411x410.jpg" /></p>
<p>Examine the running instance:</p>
<pre><code>root@compute:~# virsh -c lxc:/// list
 Id     Name                State
-------------------------------------
 1397   instance-00000004   running
 1410   instance-00000005   running
 1488   instance-00000006   running

root@compute:~# virsh -c lxc:/// console instance-00000005
Connected to domain 'instance-00000005'
Escape character is ^] (Ctrl + ])
/system/bin/sh: No controlling tty: open /dev/tty: No such device or address
/system/bin/sh: warning: won't have full job control
console:/ $ getprop | grep boot | grep com                                     
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [154468717840]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
</code></pre>
<p>Remove all of the security roles:</p>
<p><img src="./images/2025_05_27_14_34_19_1129x525.jpg" alt="./images/2025_05_27_14_34_19_1129x525.jpg" /></p>
<p>Add icmp in:</p>
<p><img src="./images/2025_05_27_14_34_47_710x605.jpg" alt="./images/2025_05_27_14_34_47_710x605.jpg" /></p>
<p>add icmp out:</p>
<p><img src="./images/2025_05_27_14_35_16_723x690.jpg" alt="./images/2025_05_27_14_35_16_723x690.jpg" /></p>
<p>add tcp in:</p>
<p><img src="./images/2025_05_27_14_35_54_704x635.jpg" alt="./images/2025_05_27_14_35_54_704x635.jpg" /></p>
<p>add tcp out:</p>
<p><img src="./images/2025_05_27_14_36_13_713x628.jpg" alt="./images/2025_05_27_14_36_13_713x628.jpg" /></p>
<p>add udp in:</p>
<p><img src="./images/2025_05_27_14_36_35_688x624.jpg" alt="./images/2025_05_27_14_36_35_688x624.jpg" /></p>
<p>add udp out:</p>
<p><img src="./images/2025_05_27_14_36_55_653x584.jpg" alt="./images/2025_05_27_14_36_55_653x584.jpg" /></p>
<p>all rules:</p>
<p><img src="./images/2025_05_27_14_37_14_1098x600.jpg" alt="./images/2025_05_27_14_37_14_1098x600.jpg" /></p>
<p>Running test:</p>
<p><img src="./images/2025_05_27_14_38_40_1154x862.jpg" alt="./images/2025_05_27_14_38_40_1154x862.jpg" /></p>
<p>virgl based result:</p>
<p><img src="./images/2025_05_27_14_44_47_513x793.jpg" alt="./images/2025_05_27_14_44_47_513x793.jpg" /></p>
<p><img src="./images/2025_05_27_14_45_04_501x724.jpg" alt="./images/2025_05_27_14_45_04_501x724.jpg" /></p>
<p><img src="./images/2025_05_27_14_45_17_526x784.jpg" alt="./images/2025_05_27_14_45_17_526x784.jpg" /></p>
<h3 id="4-add-new-compute-noderaw-gpu"><a class="header" href="#4-add-new-compute-noderaw-gpu">4. Add new compute node(raw gpu)</a></h3>
<p>Start host via usb disk:</p>
<p><img src="./images/2025_05_27_14_59_40_601x274.jpg" alt="./images/2025_05_27_14_59_40_601x274.jpg" /></p>
<p>Install with hwe kernel:</p>
<p><img src="./images/2025_05_27_15_03_33_1021x403.jpg" alt="./images/2025_05_27_15_03_33_1021x403.jpg" /></p>
<p>Install to external usb disk:</p>
<p><img src="./images/2025_05_27_15_04_10_679x208.jpg" alt="./images/2025_05_27_15_04_10_679x208.jpg" /></p>
<p><img src="./images/2025_05_27_15_04_47_402x238.jpg" alt="./images/2025_05_27_15_04_47_402x238.jpg" /></p>
<p>After installation:</p>
<p><img src="./images/2025_05_27_15_08_46_727x359.jpg" alt="./images/2025_05_27_15_08_46_727x359.jpg" /></p>
<p><img src="./images/2025_05_27_15_09_32_695x379.jpg" alt="./images/2025_05_27_15_09_32_695x379.jpg" /></p>
<p>Initial Steps:</p>
<pre><code>Change wait-on-line timeout to 5sec
add net.ifnames=0 biosdevname=0 in grub configuration and update-grub2
reboot
</code></pre>
<p>network:</p>
<pre><code>ip addr add 10.171.172.24/24 dev eth0
ip link set eth0 up
ip route add default via 10.171.172.1 dev eth0
rm -f /etc/resolv.conf 
echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf
chattr +i /etc/resolv.conf
apt update -y
apt install -y vim nethogs iotop net-tools s-tui iperf3
</code></pre>
<p>Configure network:</p>
<pre><code># cat /etc/netplan/eth0.yaml
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
      addresses: [10.171.172.23/24]
      gateway4: 10.171.172.1
    eth1:
      dhcp4: false
</code></pre>
<p>Added crontab, blacklist, then reboot:</p>
<pre><code>@reboot sleep 10 &amp;&amp; sysctl -p &amp;&amp; modprobe binder_linux devices="binder,hwbinder,vndbinder" &amp;&amp; modprobe nbd
# vim /etc/modprobe.d/blacklist.conf
blacklist x_tables
</code></pre>
<p>set hostname:</p>
<pre><code>hostnamectl set-hostname
cat &gt;&gt; /etc/hosts &lt;&lt; EOF
10.171.172.21 controller
10.171.172.22 compute
10.171.172.23 gpu
EOF
timedatectl set-ntp true
timedatectl set-timezone Asia/Shanghai
apt install chrony -y
</code></pre>
<p>Install nova:</p>
<pre><code># apt install -y nova-compute
# vim /etc/nova/nova.conf
# service nova-compute restart
</code></pre>
<p>The nova.conf content:</p>
<pre><code>[DEFAULT]
log_dir = /var/log/nova
lock_path = /var/lock/nova
state_path = /var/lib/nova
transport_url = rabbit://openstack:openstackhuhy@controller
my_ip = 10.171.172.23

[api]
auth_strategy = keystone
[api_database]
[barbican]
[barbican_service_user]
[cache]
[cinder]
[compute]
[conductor]
[console]
[consoleauth]
[cors]
[cyborg]
[database]
[devices]
[ephemeral_storage_encryption]
[filter_scheduler]

[glance]
api_servers = http://controller:9292
[guestfs]
[healthcheck]
[hyperv]
[image_cache]
[ironic]
[key_manager]
[keystone]

[keystone_authtoken]
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = nova
[libvirt]
[metrics]
[mks]
[neutron]
[notifications]

[oslo_concurrency]
lock_path = /var/lib/nova/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[pci]

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement
[powervm]
[privsep]
[profiler]
[quota]
[rdp]
[remote_debug]
[scheduler]
[serial_console]
[service_user]
[spice]
[upgrade_levels]
[vault]
[vendordata_dynamic_auth]
[vmware]

[vnc]
enabled = true
server_listen = 0.0.0.0
server_proxyclient_address = $my_ip
novncproxy_base_url = http://10.171.172.21:6080/vnc_auto.html
[workarounds]
[wsgi]
[zvm]
[cells]
enable = False
[os_region_name]
openstack =
</code></pre>
<p>Switch to controller:</p>
<pre><code># openstack compute service list --service nova-compute
+--------------------------------------+--------------+---------+------+---------+-------+----------------------------+
| ID                                   | Binary       | Host    | Zone | Status  | State | Updated At                 |
+--------------------------------------+--------------+---------+------+---------+-------+----------------------------+
| 083e7170-9d65-4ab7-8ad9-50a6639480be | nova-compute | compute | nova | enabled | up    | 2025-05-27T08:13:15.000000 |
| cc6cc325-5483-4929-b437-36a1260db353 | nova-compute | gpu     | nova | enabled | up    | 2025-05-27T08:13:17.000000 |
+--------------------------------------+--------------+---------+------+---------+-------+----------------------------+
</code></pre>
<p>gpu node:</p>
<pre><code>cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
# 用于控制系统是否开启对数据包源地址的校验，关闭
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
# 开启二层转发设备
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
EOF
modprobe br_netfilter &amp;&amp; sysctl -p
</code></pre>
<p>Install neutron, configure :</p>
<pre><code>apt install -y neutron-openvswitch-agent
vim /etc/neutron/neutron.conf 
vim /etc/neutron/plugins/ml2/openvswitch_agent.ini
</code></pre>
<p><code>neutron.conf</code> and <code>openvswitch_agent.ini</code> could be copied from compute node and adjust to the gpu node ip address.</p>
<p>adjust <code>/etc/nova/nova.conf</code>  the same as in compute node.</p>
<p>restart the service and add bridge:</p>
<pre><code>service nova-compute restart
ovs-vsctl add-br br-enpkkk
ovs-vsctl add-port br-enpkkk  eth1
</code></pre>
<p>Restart the neutron service:</p>
<pre><code>service neutron-openvswitch-agent restart
</code></pre>
<p>Switch to lxc:</p>
<pre><code>apt install lxc-utils
apt remove apparmor --purge
apt install -y nova-compute-lxc
apt remove libvirt-daemon-driver-lxc --purge
apt install -y ./libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb
 cp config.py driver.py guest.py /usr/lib/python3/dist-packages/nova/virt/libvirt/
cp addedxml_* /etc/
cd /usr/lib/python3/dist-packages/nova/ &amp;&amp; find . | grep pyc$ | xargs -I % mv % %.kk
systemctl restart nova-compute
ufw disable
</code></pre>
<p>amd 520 result:</p>
<p><img src="./images/2025_05_27_17_02_20_528x947.jpg" alt="./images/2025_05_27_17_02_20_528x947.jpg" /></p>
<p><img src="./images/2025_05_27_17_02_54_518x869.jpg" alt="./images/2025_05_27_17_02_54_518x869.jpg" /></p>
<p>change to 1920x1080, 120fps:</p>
<p><img src="./images/2025_05_27_17_13_27_534x810.jpg" alt="./images/2025_05_27_17_13_27_534x810.jpg" /></p>
<p><img src="./images/2025_05_27_17_19_05_526x822.jpg" alt="./images/2025_05_27_17_19_05_526x822.jpg" /></p>
<p>rx550 4G:</p>
<p><img src="./images/2025_05_27_17_45_25_544x886.jpg" alt="./images/2025_05_27_17_45_25_544x886.jpg" /></p>
<p><img src="./images/2025_05_27_17_45_38_563x914.jpg" alt="./images/2025_05_27_17_45_38_563x914.jpg" /></p>
<p><img src="./images/2025_05_27_17_46_12_546x591.jpg" alt="./images/2025_05_27_17_46_12_546x591.jpg" /></p>
<p><img src="./images/2025_05_27_17_50_02_524x882.jpg" alt="./images/2025_05_27_17_50_02_524x882.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250528"><a class="header" href="#20250528">20250528</a></h1>
<h3 id="1-redroidlxc-in-sr-iov-gpu"><a class="header" href="#1-redroidlxc-in-sr-iov-gpu">1. redroid/lxc in sr-iov gpu</a></h3>
<p>Enable vfs:</p>
<pre><code> apt install build-* dkms linux-headers-$(uname -r) linux-modules-extra-$(uname -r)
   wget -O /tmp/i915-sriov-dkms_2025.05.18_amd64.deb "https://github.com/strongtz/i915-sriov-dkms/releases/download/2025.05.18/i915-sriov-dkms_2025.05.18_amd64.deb"
   dpkg -i /tmp/i915-sriov-dkms_2025.05.18_amd64.deb
   GRUB_CMDLINE_LINUX_DEFAULT="intel_iommu=on i915.enable_guc=3 module_blacklist=xe"
   update-grub
   update-initramfs -u
</code></pre>
<p>Now reboot, disable secure boot in bios.</p>
<pre><code>   apt install intel-opencl-icd
   apt install clinfo
   clinfo
</code></pre>
<p>Install docker, run redroid with following command:</p>
<pre><code>sudo docker run -itd --privileged \
    -v ~/data:/data \
    -p 5555:5555 \
    teddynight/redroid:latest \
    androidboot.redroid_net_proxy_type=static \
    androidboot.hardware=mt6891 \
    ro.product.cpu.abilist=x86_64,arm64-v8a,x86,armeabi-v7a,armeabi \
    ro.product.cpu.abilist64=x86_64,arm64-v8a \
    ro.product.cpu.abilist32=x86,armeabi-v7a,armeabi \
    ro.dalvik.vm.isa.arm=x86 \
    ro.dalvik.vm.isa.arm64=x86_64 \
    ro.enable.native.bridge.exec=1 \
    ro.enable.native.bridge.exec64=1 \
    ro.dalvik.vm.native.bridge=libhoudini.so redroid.fps=120 ro.sf.lcd_density=240 redroid.width=1080 redroid.height=1920 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128 androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_fps=120
</code></pre>
<h3 id="2-local-registry"><a class="header" href="#2-local-registry">2. local registry</a></h3>
<p>Start a local registry in <code>192.168.1.7</code>:</p>
<pre><code>$ sudo docker run -d -p 5000:5000 --restart always --name registry registry:2
$ cat /etc/docker/daemon.json
{
......
       "insecure-registries": ["192.168.1.7:5000"]
......
}
$ sudo systemctl restart docker
$ sudo docker tag xxx 192.168.1.7:5000/xxx
$ sudo docker push 192.168.1.7:5000/xxx
</code></pre>
<p>In lxc host:</p>
<pre><code>$ vim /usr/share/lxc/templates/lxc-oci
  skopeo_args+=(--insecure-policy --src-creds "${CREDENTIALS}")
$  cat /etc/containers/registries.conf
[[registry]]
prefix = "192.168.1.7:5000"
location = "192.168.1.7:5000"
insecure = true
$ lxc-create -n redroidhoudini -t oci -- -u docker://192.168.1.7:5000/teddynight/redroid:latest
$ sed -i '/lxc.include/d' /var/lib/lxc/redroidhoudini/config
$ vim /var/lib/lxc/redroidhoudini/config
......
lxc.init.cmd = /init androidboot.hardware=redroid androidboot.redroid_gpu_mode=host redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128
lxc.apparmor.profile = unconfined
lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000

lxc.mount.entry = /dev/dma_heap dev/dma_heap none bind,optional,create=dir
#lxc.mount.entry = /dev/ dev none bind,optional,create=dir
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file
$ lxc-start -l debug -o  houdini.log -n redroidhoudini
</code></pre>
<p>Got some issue with init command:</p>
<pre><code>lxc.init.cmd = /init androidboot.hardware=redroid redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128 androidboot.redroid_net_proxy_type=static androidboot.hardware=mt6891 ro.product.cpu.abilist=x86_64,arm64-v8a,x86,armeabi-v7a,armeabi ro.product.cpu.abilist64=x86_64,arm64-v8a ro.product.cpu.abilist32=x86,armeabi-v7a,armeabi ro.dalvik.vm.isa.arm=x86 ro.dalvik.vm.isa.arm64=x86_64 ro.enable.native.bridge.exec=1 ro.enable.native.bridge.exec64=1 ro.dalvik.vm.native.bridge=libhoudini.so 

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250529"><a class="header" href="#20250529">20250529</a></h1>
<h3 id="1-redroid12-with-h"><a class="header" href="#1-redroid12-with-h">1. redroid12 with H</a></h3>
<p>Fetch the Code in redroid build docker, then:</p>
<pre><code>git clone https://github.com/remote-android/redroid-patches.git ~/redroid-patches
~/redroid-patches/apply-patch.sh ~/src
</code></pre>
<p>Then apply H patch, building:</p>
<pre><code>cd /src
. build/envsetup.sh
lunch redroid_x86_64-userdebug
m -j32

</code></pre>
<h3 id="2-fio-test"><a class="header" href="#2-fio-test">2. fio test</a></h3>
<p>Command:</p>
<pre><code>[root@minirocky92 nvme]# fio -name=test -ioengine=libaio -bs=4k -iodepth=32 -filename=/media/nvme/test -size=2G -rw=randwrite -direct=1
test: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=32
fio-3.35
Starting 1 process
test: Laying out IO file (1 file / 2048MiB)
Jobs: 1 (f=1): [w(1)][100.0%][w=333MiB/s][w=85.3k IOPS][eta 00m:00s]
test: (groupid=0, jobs=1): err= 0: pid=1520033: Thu May 29 14:33:14 2025
  write: IOPS=101k, BW=393MiB/s (413MB/s)(2048MiB/5206msec); 0 zone resets
    slat (usec): min=2, max=7765, avg= 8.76, stdev=13.71
    clat (usec): min=50, max=7221, avg=307.99, stdev=175.64
     lat (usec): min=53, max=9938, avg=316.75, stdev=177.25
    clat percentiles (usec):
     |  1.00th=[  176],  5.00th=[  217], 10.00th=[  227], 20.00th=[  239],
     | 30.00th=[  245], 40.00th=[  249], 50.00th=[  258], 60.00th=[  302],
     | 70.00th=[  375], 80.00th=[  396], 90.00th=[  412], 95.00th=[  424],
     | 99.00th=[  457], 99.50th=[  474], 99.90th=[ 2868], 99.95th=[ 5014],
     | 99.99th=[ 7046]
   bw (  KiB/s): min=311528, max=485808, per=97.98%, avg=394683.20, stdev=51371.80, samples=10
   iops        : min=77882, max=121452, avg=98671.00, stdev=12842.96, samples=10
  lat (usec)   : 100=0.01%, 250=40.72%, 500=59.00%, 750=0.12%, 1000=0.02%
  lat (msec)   : 2=0.02%, 4=0.05%, 10=0.08%
  cpu          : usr=9.32%, sys=72.10%, ctx=87833, majf=0, minf=11
  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=100.0%, &gt;=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, &gt;=64=0.0%
     issued rwts: total=0,524288,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32

Run status group 0 (all jobs):
  WRITE: bw=393MiB/s (413MB/s), 393MiB/s-393MiB/s (413MB/s-413MB/s), io=2048MiB (2147MB), run=5206-5206msec

Disk stats (read/write):
  nvme1n1: ios=0/509352, merge=0/1340, ticks=0/13209, in_queue=13211, util=97.09%
[root@minirocky92 nvme]# 
[root@minirocky92 nvme]# 
[root@minirocky92 nvme]# fio -name=test -ioengine=libaio -bs=4k -iodepth=32 -filename=/media/nvme/test -size=2G -rw=randwrite -direct=1 -fsync=1
test: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=32
fio-3.35
Starting 1 process
Jobs: 1 (f=1): [w(1)][100.0%][w=1117KiB/s][w=279 IOPS][eta 00m:00s]
test: (groupid=0, jobs=1): err= 0: pid=1520618: Thu May 29 14:56:58 2025
  write: IOPS=369, BW=1479KiB/s (1515kB/s)(2048MiB/1417562msec); 0 zone resets
    slat (nsec): min=1871, max=6858.4k, avg=27965.24, stdev=15988.73
    clat (usec): min=24, max=165059, avg=83816.46, stdev=11598.42
     lat (usec): min=60, max=165086, avg=83844.43, stdev=11602.25
    clat percentiles (msec):
     |  1.00th=[   69],  5.00th=[   74], 10.00th=[   75], 20.00th=[   77],
     | 30.00th=[   80], 40.00th=[   81], 50.00th=[   82], 60.00th=[   83],
     | 70.00th=[   83], 80.00th=[   84], 90.00th=[  106], 95.00th=[  112],
     | 99.00th=[  121], 99.50th=[  123], 99.90th=[  125], 99.95th=[  127],
     | 99.99th=[  138]
   bw (  KiB/s): min=  755, max= 2008, per=100.00%, avg=1480.11, stdev=182.24, samples=2834
   iops        : min=  188, max=  502, avg=369.89, stdev=45.57, samples=2834
  lat (usec)   : 50=0.01%
  lat (msec)   : 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%, 100=85.51%
  lat (msec)   : 250=14.48%
  fsync/fdatasync/sync_file_range:
    sync (msec): min=7, max=253, avg=86.48, stdev=11.96
    sync percentiles (msec):
     |  1.00th=[   71],  5.00th=[   77], 10.00th=[   78], 20.00th=[   80],
     | 30.00th=[   82], 40.00th=[   83], 50.00th=[   84], 60.00th=[   85],
     | 70.00th=[   86], 80.00th=[   86], 90.00th=[  109], 95.00th=[  115],
     | 99.00th=[  125], 99.50th=[  127], 99.90th=[  129], 99.95th=[  131],
     | 99.99th=[  142]
  cpu          : usr=0.67%, sys=1.35%, ctx=639434, majf=1, minf=10
  IO depths    : 1=0.1%, 2=0.1%, 4=0.1%, 8=0.1%, 16=0.1%, 32=200.0%, &gt;=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.1%, 64=0.0%, &gt;=64=0.0%
     issued rwts: total=0,524288,0,524257 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=32

Run status group 0 (all jobs):
  WRITE: bw=1479KiB/s (1515kB/s), 1479KiB/s-1479KiB/s (1515kB/s-1515kB/s), io=2048MiB (2147MB), run=1417562-1417562msec

Disk stats (read/write):
  nvme1n1: ios=0/1402691, merge=0/355052, ticks=0/1402232, in_queue=2526697, util=100.00%
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250530"><a class="header" href="#20250530">20250530</a></h1>
<h3 id="1-redroid12-in-lxcx86"><a class="header" href="#1-redroid12-in-lxcx86">1. redroid12 in lxc(x86)</a></h3>
<p>Change the H related:</p>
<pre><code># vim /var/lib/lxc/redroiidhoudini/rootfs/system/build.prop
......
ro.product.cpu.abi=x86_64
+ro.product.cpu.abilist=x86_64,arm64-v8a,x86,armeabi-v7a,armeabi
+ro.product.cpu.abilist32=x86,armeabi-v7a,armeabi
+ro.product.cpu.abilist64=x86_64,arm64-v8a
+ro.dalvik.vm.isa.arm=x86 
+ro.dalvik.vm.isa.arm64=x86_64
+ro.enable.native.bridge.exec=1
+ro.enable.native.bridge.exec64=1
+ro.dalvik.vm.native.bridge=libhoudini.so
</code></pre>
<p>repack for the lxc image.</p>
<p>Create the image with:</p>
<pre><code> openstack image create "redroid11withhoudini" --file redroidhoudini.img --disk-format raw --container-format bare --public
</code></pre>
<p>Recover network:<br />
Delete instance:</p>
<p><img src="./images/2025_05_30_14_40_24_734x449.jpg" alt="./images/2025_05_30_14_40_24_734x449.jpg" /></p>
<p>Delete router:</p>
<p><img src="./images/2025_05_30_14_39_54_1111x337.jpg" alt="./images/2025_05_30_14_39_54_1111x337.jpg" /></p>
<p>Delete Networks:</p>
<p><img src="./images/2025_05_30_14_41_12_974x467.jpg" alt="./images/2025_05_30_14_41_12_974x467.jpg" /></p>
<p>Examine the network topology:</p>
<p><img src="./images/2025_05_30_14_41_41_1064x472.jpg" alt="./images/2025_05_30_14_41_41_1064x472.jpg" /></p>
<p>Re-create the network:</p>
<pre><code>source /etc/keystone/admin-openrc.sh
openstack router create Ext-Router
openstack network create --internal --provider-network-type vxlan int-net
openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
openstack router add subnet Ext-Router int-net-sub
openstack network create --provider-physical-network physnet1 --provider-network-type flat  --external ext-net
openstack subnet create ext-net-sub --network ext-net --subnet-range 192.168.200.40/24  --allocation-pool start=192.168.200.100,end=192.168.200.200 --gateway 192.168.200.1 --dns-nameserver 114.114.114.114 --dhcp
openstack router set Ext-Router --external-gateway ext-net
</code></pre>
<p>Network topology:</p>
<p><img src="./images/2025_05_30_14_44_46_489x608.jpg" alt="./images/2025_05_30_14_44_46_489x608.jpg" /></p>
<p>lxc based, OK, but libvirt based, failed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250531"><a class="header" href="#20250531">20250531</a></h1>
<h3 id="1-lxc-vs-libvirtlxc"><a class="header" href="#1-lxc-vs-libvirtlxc">1. lxc vs libvirtLXC</a></h3>
<p>lxc-start:</p>
<pre><code>oot@ubuntu2204:~# !15
ps fauxww
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.4  0.0  18016 10240 ?        Ss   13:22   0:00 /sbin/init
root         123  0.0  0.0  31340 10880 ?        S&lt;s  13:22   0:00 /lib/systemd/systemd-journald
systemd+     151  0.0  0.0  16128  8064 ?        Ss   13:22   0:00 /lib/systemd/systemd-networkd
root         156  0.0  0.0   9496  2816 ?        Ss   13:22   0:00 /usr/sbin/cron -f -P
message+     157  0.0  0.0   8536  4480 ?        Ss   13:22   0:00 @dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only
root         159  0.1  0.0  35392 19200 ?        Ss   13:22   0:00 /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers
syslog       160  0.0  0.0 222404  4992 ?        Ssl  13:22   0:00 /usr/sbin/rsyslogd -n -iNONE
root         161  0.0  0.0  15220  7296 ?        Ss   13:22   0:00 /lib/systemd/systemd-logind
systemd+     165  0.0  0.0  26332 13944 ?        Ss   13:22   0:00 /lib/systemd/systemd-resolved
root         167  0.1  0.0  13292  5356 pts/0    Ss   13:22   0:00 /bin/login -p --
root         197  0.0  0.0  10236  4096 pts/0    S    13:23   0:00  \_ -bash
root         207  0.0  0.0  12644  3328 pts/0    R+   13:23   0:00      \_ ps fauxww
root         168  0.0  0.0   8400  2304 pts/1    Ss+  13:22   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/1 115200,38400,9600 vt220
root         169  0.0  0.0   8400  2304 pts/2    Ss+  13:22   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/2 115200,38400,9600 vt220
root         170  0.0  0.0   8400  2176 pts/3    Ss+  13:22   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/3 115200,38400,9600 vt220
root         171  0.0  0.0   8400  2432 pts/4    Ss+  13:22   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/4 115200,38400,9600 vt220
root         191  0.0  0.0  16660  8832 ?        Ss   13:23   0:00 /lib/systemd/systemd --user
root         192  0.0  0.0  21076  4480 ?        S    13:23   0:00  \_ (sd-pam)

</code></pre>
<p>virsh:</p>
<pre><code>ps fauxww
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.3  0.0  17984  9984 ?        Ss   13:23   0:00 /sbin/init
root         107  0.0  0.0  31280 10624 ?        S&lt;s  13:23   0:00 /lib/systemd/systemd-journald
root         138  0.2  0.0  22088  5504 ?        Ss   13:23   0:00 /lib/systemd/systemd-udevd
systemd+     148  0.0  0.0  16128  8064 ?        Ss   13:23   0:00 /lib/systemd/systemd-networkd
systemd+     162  0.0  0.0  26332 14072 ?        Ss   13:23   0:00 /lib/systemd/systemd-resolved
root         177  0.0  0.0   9496  2816 ?        Ss   13:23   0:00 /usr/sbin/cron -f -P
message+     178  0.0  0.0   8552  4480 ?        Ss   13:23   0:00 @dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only
root         181  0.1  0.0  35392 19200 ?        Ss   13:23   0:00 /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers
syslog       182  0.0  0.0 222404  5120 ?        Ssl  13:23   0:00 /usr/sbin/rsyslogd -n -iNONE
root         185  0.0  0.0  15344  7296 ?        Ss   13:23   0:00 /lib/systemd/systemd-logind
root         190  0.0  0.0  13292  5392 pts/0    Ss   13:23   0:00 /bin/login -p --
root         229  0.0  0.0  10236  4096 pts/0    S    13:23   0:00  \_ -bash
root         243  0.0  0.0  12644  3328 pts/0    R+   13:23   0:00      \_ ps fauxww
root         191  0.0  0.0   8400  2048 pts/1    Ss+  13:23   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/1 115200,38400,9600 vt220
root         192  0.0  0.0   8400  2176 pts/2    Ss+  13:23   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/2 115200,38400,9600 vt220
root         193  0.0  0.0   8400  2304 pts/3    Ss+  13:23   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/3 115200,38400,9600 vt220
root         195  0.0  0.0   8400  2432 pts/4    Ss+  13:23   0:00 /sbin/agetty -o -p -- \u --noclear --keep-baud pts/4 115200,38400,9600 vt220
root         223  0.1  0.0  16944  9216 ?        Ss   13:23   0:00 /lib/systemd/systemd --user
root         224  0.0  0.0  21040  4436 ?        S    13:23   0:00  \_ (sd-pam)
root         238  0.0  0.0  14696  6656 ?        Ss   13:23   0:00 /lib/systemd/systemd-hostnamed

</code></pre>
<p>Added 5 ptys to libvirt xml:</p>
<pre><code>    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='0'/&gt;
    &lt;/console&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='1'/&gt;
    &lt;/console&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='2'/&gt;
    &lt;/console&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='3'/&gt;
    &lt;/console&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='4'/&gt;
    &lt;/console&gt;
  &lt;/devices&gt;
</code></pre>
<h3 id="2-redroid-12-verification"><a class="header" href="#2-redroid-12-verification">2. redroid 12 verification</a></h3>
<p>Export to docker images:</p>
<pre><code>dash@aiBox:/media/sda/redroid/redroid12/out/target/product/redroid_x86_64$ sudo mount system.img system -o ro
dash@aiBox:/media/sda/redroid/redroid12/out/target/product/redroid_x86_64$ sudo mount vendor.img vendor -o ro
dash@aiBox:/media/sda/redroid/redroid12/out/target/product/redroid_x86_64$ sudo tar --xattrs -c vendor -C system --exclude="./vendor" . | sudo docker import --platform=linux/amd64 -c 'ENTRYPOINT ["/init", "qemu=1", "androidboot.hardware=redroid"]' - redroidhoudini12
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250601"><a class="header" href="#20250601">20250601</a></h1>
<h3 id="1-gdb-libvirtlxc-debugging"><a class="header" href="#1-gdb-libvirtlxc-debugging">1. gdb libvirtlxc debugging</a></h3>
<p>reason:</p>
<pre><code>06-02 03:25:46.621   277   471 W NativeCrashListener: Couldn't find ProcessRecord for pid 1634
06-02 03:25:46.621    36    36 E tombstoned: Tombstone written to: tombstone_20
06-02 03:25:46.621  1634  1634 F libc    : failed to restore dumpable: Invalid argument
06-02 03:25:46.622   110   110 E adbd    : failed to start subprocess: child failed to open pseudo-term slave /dev/pts/1: No such file or directory

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250602"><a class="header" href="#20250602">20250602</a></h1>
<h3 id="1-cgroup-working-tips"><a class="header" href="#1-cgroup-working-tips">1. cgroup working tips</a></h3>
<p><code>https://serverfault.com/questions/501196/allowed-cgroup-devices-for-libvirt-lxc-container</code>.<br />
In Ubun22.04:</p>
<pre><code>vim /etc/cgconfig.conf
group libvirt/lxc {
    devices {
            devices.allow="c 10:200 rwm";
    }
}

c 1:3 rwm
c 1:5 rwm
c 1:7 rwm
c 1:8 rwm
c 1:9 rwm
c 5:0 rwm
c 5:2 rwm
c 136:* rwm
c 10:200 rwm
</code></pre>
<p>But after reboot didn't take effects.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250603"><a class="header" href="#20250603">20250603</a></h1>
<h3 id="1-privileged-vs-unprivileged"><a class="header" href="#1-privileged-vs-unprivileged">1. privileged vs unprivileged</a></h3>
<p>Create debian lxc instance:</p>
<pre><code>lxc-create -n debian-sid -t download -- --dist debian --release trixie --arch amd64
Result:     
root@compute:~# lxc-attach -n debian-sid
root@debian-sid:~# ls
root@debian-sid:~# capsh --print
Current: =ep cap_sys_module,cap_sys_rawio,cap_sys_time,cap_mac_override,cap_mac_admin-ep
Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore
Ambient set =
Current IAB: !cap_sys_module,!cap_sys_rawio,!cap_sys_time,!cap_mac_override,!cap_mac_admin
Securebits: 00/0x0/1'b0 (no-new-privs=0)
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=
Guessed mode: HYBRID (4)
</code></pre>
<p>Create docker instance:</p>
<pre><code>docker run -it debian:trixie /bin/bash
# in docker
apt update -y
apt install -y libcap2-bin
capsh --print
capsh --print
Current: cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap=ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap
Ambient set =
Current IAB: !cap_dac_read_search,!cap_linux_immutable,!cap_net_broadcast,!cap_net_admin,!cap_ipc_lock,!cap_ipc_owner,!cap_sys_module,!cap_sys_rawio,!cap_sys_ptrace,!cap_sys_pacct,!cap_sys_admin,!cap_sys_boot,!cap_sys_nice,!cap_sys_resource,!cap_sys_time,!cap_sys_tty_config,!cap_lease,!cap_audit_control,!cap_mac_override,!cap_mac_admin,!cap_syslog,!cap_wake_alarm,!cap_block_suspend,!cap_audit_read,!cap_perfmon,!cap_bpf,!cap_checkpoint_restore
Securebits: 00/0x0/1'b0 (no-new-privs=0)
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
Guessed mode: HYBRID (4)
</code></pre>
<p>run with <code>--privileged</code>:</p>
<pre><code>Current: =ep
Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore
Ambient set =
Current IAB: 
Securebits: 00/0x0/1'b0 (no-new-privs=0)
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
Guessed mode: HYBRID (4)
</code></pre>
<p>lxc based virsh:</p>
<pre><code>root@debian-sid:~# capsh --print
Current: =ep
Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore
Ambient set =
Current IAB: 
Securebits: 00/0x0/1'b0 (no-new-privs=0)
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=
Guessed mode: HYBRID (4)
</code></pre>
<p>privileged docker, could use <code>fdisk -l</code>.</p>
<h3 id="2-adb-shell-issue"><a class="header" href="#2-adb-shell-issue">2. adb shell issue</a></h3>
<p>lxc based redroid:</p>
<pre><code>After boot completed:    
console:/ # ls /dev/pts/                                                                     
ptmx

adb connect lxc_ip:5555
adb -s lxc_ip:5555 shell

console:/ # ls /dev/pts/                                                                     
0  ptmx
console:/ # id
uid=0(root) gid=0(root) groups=0(root),1007(log),3009(readproc)

After exit:    

console:/ # ls /dev/pts/                                                                     
ptmx

</code></pre>
<p>Docker based redroid(privileged):</p>
<pre><code>2eaf2af9586a:/ # ls /dev/pts/                                                                
0  ptmx

adb connect docker_ip:5555
adb -s docker_ip:5555 shell

2eaf2af9586a:/ # ls /dev/pts/                                                                
0  1  ptmx
2eaf2af9586a:/ # id
uid=0(root) gid=0(root) groups=0(root)

After exit
2eaf2af9586a:/ # ls /dev/pts
0  ptmx  
</code></pre>
<p>virsh based lxc(redroid):</p>
<pre><code>17: eth0@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether fa:16:3e:5d:b5:19 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.200.199/24 brd 192.168.200.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::55a4:3868:90d5:7e9b/64 scope link stable-privacy 
       valid_lft forever preferred_lft forever
console:/ $ ls /dev/pts/
ptmx

root@compute:~# adb -s 192.168.200.199:5555 shell
error: child failed to open pseudo-term slave /dev/pts/1: No such file or directory
                                                                                   
console:/ $ ls /dev/pts/                                                       
ptmx

console:/ # id
uid=0(root) gid=0(root) groups=0(root),1007(log),3009(readproc)

</code></pre>
<h3 id="3-lxclibvirtlxc-on-archlinux"><a class="header" href="#3-lxclibvirtlxc-on-archlinux">3. lxc/libvirtLXC on archlinux</a></h3>
<p>In archlinux:</p>
<pre><code>sudo pacman -Syu --noconfirm &amp;&amp; sudo pacman -S linux-zen &amp;&amp; sudo grub-mkconfig -o /boot/grub/grub.cfg &amp;&amp; sudo reboot
# After reboot
[dash@archlxc ~]$ uname -a
Linux archlxc 6.14.9-zen1-1-zen #1 ZEN SMP PREEMPT_DYNAMIC Thu, 29 May 2025 21:42:00 +0000 x86_64 GNU/Linux
</code></pre>
<p>Run aosp with houdini :</p>
<pre><code>apt install -y docker
</code></pre>
<p>Ignore the verification, for I have solved the adb shell issue.</p>
<h3 id="4--workable-libvirt"><a class="header" href="#4--workable-libvirt">4.  workable libvirt</a></h3>
<p>modification for libvirt:</p>
<pre><code>diff -r Code/libvirt-8.0.0/src/lxc/lxc_container.c Code1/libvirt-8.0.0/src/lxc/lxc_container.c
741c741
&lt;     { "/proc/sys", "/proc/sys", "none", MS_BIND|MS_NOSUID|MS_NOEXEC|MS_NODEV, false, false, false },
---
&gt;     { "/proc/sys", "/proc/sys", "none", MS_BIND|MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_RDONLY, false, false, false },
744c744
&lt;     { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV, false, false, false },
---
&gt;     { "sysfs", "/sys", "sysfs", MS_NOSUID|MS_NOEXEC|MS_NODEV|MS_RDONLY, false, false, false },
1031,1032c1031,1032
&lt;     //if (virFileBindMountDevice("/dev/pts/ptmx", "/dev/ptmx") &lt; 0)
&lt;     //    return -1;
---
&gt;     if (virFileBindMountDevice("/dev/pts/ptmx", "/dev/ptmx") &lt; 0)
&gt;         return -1;
diff -r Code/libvirt-8.0.0/src/lxc/lxc_controller.c Code1/libvirt-8.0.0/src/lxc/lxc_controller.c
1439,1440c1439
&lt;     /* opts = g_strdup_printf("mode=755,size=65536%s", mount_options);*/
&lt;     opts = g_strdup_printf("mode=755,size=25000000%s", mount_options);
---
&gt;     opts = g_strdup_printf("mode=755,size=65536%s", mount_options);
2137d2135
&lt;     //opts = g_strdup_printf("newinstance,ptmxmode=0000,mode=0644,gid=%u%s", ptsgid,
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250604"><a class="header" href="#20250604">20250604</a></h1>
<h3 id="1-arm64-libvirtlxc"><a class="header" href="#1-arm64-libvirtlxc">1. arm64 libvirtlxc</a></h3>
<p>Steps on ubuntu22.04:</p>
<pre><code>apt install -y build-essential pbuilder dpkg-dev
# comment all of the deb-src in /etc/apt/sources.list
apt-get source libvirt-daemon-driver-lxc
apt-get build-dep libvirt-daemon-driver-lxc
# make modifications
dpkg-source --commit
debuild -us -uc
apt remove libvirt-daemon-driver-lxc --purge &amp;&amp; apt install ../libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb
reboot
</code></pre>
<h3 id="2-specify-gpu-node"><a class="header" href="#2-specify-gpu-node">2. specify gpu node</a></h3>
<p>Via following command:</p>
<pre><code> openstack server create --flavor C4-6124MB-25G --image  redroid12_32bit --security-group f37134a8-0e72-4102-8473-7a147e60d81d --nic net-id=ext-net --key-name mykey --os-compute-api-version 2.74 --hypervisor-host gpu wzh_yyds
</code></pre>
<h3 id="3-add-new-node"><a class="header" href="#3-add-new-node">3. Add new node</a></h3>
<p>Network related:</p>
<pre><code>sudo vim /etc/netplan/enp1s0.yaml
sudo touch /etc/cloud/cloud-init.disabled
sudo cat /etc/netplan/enp1s0.yaml 
network:
  version: 2
  ethernets:
    enp1s0:
      dhcp4: false
      addresses: [10.171.172.24/24]
      gateway4: 10.171.172.1
    enp2s0:
      dhcp4: false
sudo vim /etc/systemd/system/network-online.target.wants/systemd-networkd-wait-online.service 
TimeoutStartSec=5sec
</code></pre>
<p>Refers to <code>20250527</code>,</p>
<pre><code>root@controller:~# source /etc/keystone/admin-openrc.sh 
root@controller:~# openstack compute service list --service nova-compute
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+
| ID                                   | Binary       | Host        | Zone | Status  | State | Updated At                 |
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+
| 083e7170-9d65-4ab7-8ad9-50a6639480be | nova-compute | compute     | nova | enabled | up    | 2025-06-04T02:54:34.000000 |
| cc6cc325-5483-4929-b437-36a1260db353 | nova-compute | gpu         | nova | enabled | up    | 2025-06-04T02:54:39.000000 |
| 840ba248-2666-4f02-8b37-7261f92bffe8 | nova-compute | virglgpux86 | nova | enabled | up    | 2025-06-04T02:54:41.000000 |
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+
</code></pre>
<p>Create image:</p>
<pre><code>openstack image create "redroid12amd64houdini" --file redroid12.img --disk-format raw --container-format bare --public
</code></pre>
<p>Create instance:</p>
<pre><code>openstack server create --flavor C4-6124MB-25G --image  redroid12amd64houdini --security-group f37134a8-0e72-4102-8473-7a147e60d81d --nic net-id=ext-net --key-name mykey --os-compute-api-version 2.74 --hypervisor-host virglgpux86 yyds_wzh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250605"><a class="header" href="#20250605">20250605</a></h1>
<h3 id="1-rk3588-lxc-issue"><a class="header" href="#1-rk3588-lxc-issue">1. rk3588 lxc issue</a></h3>
<p>Write image to sd card:</p>
<pre><code># xz -d &lt; Rock5_Ubuntu22.img.xz - | dd of=/dev/sdb &amp;&amp; sync
</code></pre>
<p><img src="./images/2025_06_05_12_11_12_590x426.jpg" alt="./images/2025_06_05_12_11_12_590x426.jpg" /></p>
<p>Update:</p>
<pre><code>use  ubuntu-22.04-preinstalled-desktop-arm64-rock-5b-plus.img
</code></pre>
<p>In ubuntu2204:</p>
<pre><code>apt update -y
apt install -y docker.io
test@rk3588:~$ ls /dev/dri/ -l -h
total 0
drwxr-xr-x  2 root root        120  6月  5 16:05 by-path
crw-rw----+ 1 root video  226,   0  6月  5 16:05 card0
crw-rw----+ 1 root video  226,   1  6月  5 16:05 card1
crw-rw----+ 1 root render 226, 128  6月  5 16:05 renderD128
crw-rw----+ 1 root render 226, 129  6月  5 16:05 renderD129
</code></pre>
<p>Run docker instance:</p>
<pre><code>sudo docker run -d -p 5555:5555 -v ~/redroid-data:/data --restart unless-stopped --name redroid --privileged cnflysky/redroid-rk3588:lineage-20 androidboot.redroid_height=1920 androidboot.redroid_width=1080
sudo docker ps
sudo docker exec -it redroid sh

Result:   

a91141efc267:/ # getprop | grep boot | grep com                                                                                                                                              
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [1297258137855]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
a91141efc267:/ # dumpsys SurfaceFlinger | grep GLES
GLES: ARM, Mali-G610, OpenGL ES 3.2 v1.g18p0-01eac0.2d5e200a1514bdef1a4909db66e37e28
</code></pre>
<p>lxc related steps:</p>
<pre><code>$     sudo vim /etc/docker/daemon.json
{
	       "insecure-registries": ["192.168.1.7:5000"]
}
$     sudo apt install -y lxc docker.io  skopeo umoci jq
$ sudo docker tag cnflysky/redroid-rk3588:lineage-20 192.168.1.7:5000/cnflysky/redroid-rk3588:lineage-20
$ sudo docker push 192.168.1.7:5000/cnflysky/redroid-rk3588:lineage-20
$ sudo sed -i 's/set -eu/set -u/g' /usr/share/lxc/templates/lxc-oci

$  cat /etc/containers/registries.conf
[[registry]]
prefix = "192.168.1.7:5000"
location = "192.168.1.7:5000"
insecure = true
$ sudo su
# lxc-create -n redroid3588 -t oci -- -u docker://192.168.1.7:5000/cnflysky/redroid-rk3588:lineage-20
# vim /var/lib/lxc/redroid3588/config

lxc.init.cmd = /init  androidboot.hardware=redroid 
lxc.apparmor.profile = unconfined
#lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000
lxc.mount.entry = /dev/dma_heap dev/dma_heap none bind,optional,create=dir
#lxc.mount.entry = /dev/ dev none bind,optional,create=dir
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file
lxc.mount.entry = /dev/dri/renderD129 dev/dri/renderD129 none bind,optional,create=file
lxc.mount.entry = /dev/dri/card0 dev/dri/card0 none bind,optional,create=file
lxc.mount.entry = /dev/dri/card1 dev/dri/card1 none bind,optional,create=file
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file
lxc.mount.entry = /dev/mali0 dev/mali0 none bind,optional,create=file
lxc.mount.entry = /dev/mpp_service dev/mpp_service none bind,optional,create=file



# rm /var/lib/lxc/redroid3588/rootfs/vendor/bin/ipconfigstore
# apt remove apparmor --purge
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250606"><a class="header" href="#20250606">20250606</a></h1>
<h3 id="1-rk3588-openstack-tips"><a class="header" href="#1-rk3588-openstack-tips">1. rk3588 openstack tips</a></h3>
<p>Steps for configuration:</p>
<pre><code># apt install -y vim nethogs iotop net-tools s-tui iperf3
# crontab -e
@reboot sleep 10 &amp;&amp; sysctl -p &amp;&amp; modprobe nbd &amp;&amp;  modprobe binder_linux devices="binder,hwbinder,vndbinder"
# vim /etc/modprobe.d/blacklist.conf
blacklist x_tables

cat &gt;&gt; /etc/hosts &lt;&lt; EOF
10.171.172.21 controller
10.171.172.22 compute
10.171.172.23 gpu
10.171.172.25 rk3588
EOF

timedatectl set-ntp true
timedatectl set-timezone Asia/Shanghai
apt install chrony -y

reboot
</code></pre>
<p>Then refers to <code>20250527</code> for detailed configuration for nova/neutron.<br />
After configuration of nova:</p>
<pre><code>root@controller:~# openstack compute service list --service nova-compute
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+
| ID                                   | Binary       | Host        | Zone | Status  | State | Updated At                 |
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+
| 083e7170-9d65-4ab7-8ad9-50a6639480be | nova-compute | compute     | nova | enabled | down  | 2025-06-04T11:14:16.000000 |
| cc6cc325-5483-4929-b437-36a1260db353 | nova-compute | gpu         | nova | enabled | down  | 2025-06-04T11:14:12.000000 |
| 840ba248-2666-4f02-8b37-7261f92bffe8 | nova-compute | virglgpux86 | nova | enabled | down  | 2025-06-04T11:14:11.000000 |
| 52b1af69-3d7a-4bde-b459-6acce24ef6ae | nova-compute | rk3588      | nova | enabled | up    | 2025-06-06T00:55:02.000000 |
+--------------------------------------+--------------+-------------+------+---------+-------+----------------------------+

</code></pre>
<p>Then configure neutron, remove lxc-net, reconfigure the network in openstack.</p>
<pre><code>apt remove lxc-utils lxc
</code></pre>
<p>lxc related:</p>
<pre><code>apt install -y nova-compute-lxc
scp dash@192.168.1.8:/media/sda/iso/houdini12/libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb .
apt remove libvirt-daemon-driver-lxc --purge
apt install -y ./libvirt-daemon-driver-lxc_8.0.0-1ubuntu7.11_arm64.deb
scp -r dash@192.168.1.8:/media/sda/iso/houdini12/configs .
cp configs/*.py /usr/lib/python3/dist-packages/nova/virt/libvirt/
cp configs/addedxml_* /etc
</code></pre>
<p>Adjust for py and addedxml:</p>
<pre><code>$ vim /usr/lib/python3/dist-packages/nova/virt/libvirt/driver.py
 6515             guest.os_init_arg = "androidboot.hardware=redroid androidboot.redroid_height=1920 androidboot.redroid_width=1080"
$ 
</code></pre>
<p>Compute node, create:</p>
<pre><code> openstack server create --flavor C4-6124MB-25G --image   rk3588 --security-group f37134a8-0e72-4102-8473-7a147e60d81d --nic net-id=ext-net --key-name mykey --os-compute-api-version 2.74 --hypervisor-host  rk3588 testrk3588
</code></pre>
<p>game3588 :</p>
<pre><code>guest.os_init_arg = "androidboot.hardware=rk30board androidboot.redroid_height=1920 androidboot.redroid_width=1080 androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=      host"


  scp game3588.img dash@192.168.1.8://media/sda/iso/houdini12/
# create instance via:    
    openstack server create --flavor C4-6124MB-25G --image   game3588 --security-group f37134a8-0e72-4102-8473-7a147e60d81d --nic net-id=ext-net --key-name mykey --os-compute-api-version 2.74 --hypervisor-host  rk3588   gameout

</code></pre>
<p>lxc for game3588:</p>
<pre><code>root@rk3588:~# cat /var/lib/lxc/game3588/config 
# Template used to create this container: /usr/share/lxc/templates/lxc-oci
# Parameters passed to the template: -u docker://192.168.1.7:5000/chisbread/rk3588-gaming:redroid-firefly
# For additional config options, please look at lxc.container.conf(5)

# Uncomment the following line to support nesting containers:
#lxc.include = /usr/share/lxc/config/nesting.conf
# (Be aware this has security implications)

lxc.net.0.type = veth
lxc.net.0.link = virbr0
lxc.net.0.flags = up
lxc.net.0.hwaddr = 00:16:3e:dc:70:b8
lxc.rootfs.path = dir:/var/lib/lxc/game3588/rootfs
lxc.execute.cmd = '"/init" "androidboot.hardware=rk30board" '
lxc.mount.auto = proc:rw sys:rw cgroup:rw
lxc.environment = 
lxc.uts.name = game3588
lxc.init.uid = 0
lxc.init.gid = 0
lxc.init.cwd = /

lxc.init.cmd = /init androidboot.hardware=rk30board androidboot.redroid_gpu_mode=host
lxc.apparmor.profile = unconfined
#lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000

lxc.mount.entry = /dev/dma_heap dev/dma_heap none bind,optional,create=dir
#lxc.mount.entry = /dev/ dev none bind,optional,create=dir
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file
lxc.mount.entry = /dev/dri/renderD129 dev/dri/renderD129 none bind,optional,create=file
lxc.mount.entry = /dev/dri/card0 dev/dri/card0 none bind,optional,create=file
lxc.mount.entry = /dev/dri/card1 dev/dri/card1 none bind,optional,create=file
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file
lxc.mount.entry = /dev/mali0 dev/mali0 none bind,optional,create=file
lxc.mount.entry = /dev/video-dec0 dev/video-dec0 none bind,optional,create=file
lxc.mount.entry = /dev/video-enc0 dev/video-enc0 none bind,optional,create=file
lxc.mount.entry = /dev/ashmem dev/ashmem none bind,optional,create=file
</code></pre>
<p>Create via:</p>
<pre><code>lxc-create -n game3588 -t oci -- -u docker://192.168.1.7:5000/chisbread/rk3588-gaming:redroid-firefly
</code></pre>
<p>issue:</p>
<pre><code>screencap     screenrecord
:/data # screenrecord --time-limit 5 11.mp4                                                            
Encoder failed (err=-38)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250607"><a class="header" href="#20250607">20250607</a></h1>
<h3 id="1-mpp-issue"><a class="header" href="#1-mpp-issue">1. mpp issue</a></h3>
<p>lxc(redroid), not OK.<br />
docke(redroid), mpp works well.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250608"><a class="header" href="#20250608">20250608</a></h1>
<h3 id="1-possible-solution-for-rk"><a class="header" href="#1-possible-solution-for-rk">1. possible solution for rk</a></h3>
<p><code>https://github.com/redroid-rockchip</code>.</p>
<pre><code>sudo docker run -itd --privileged \
    --name redroid \
    -v ~/data:/data \
    -v /dev/mali0:/dev/mali0 \
    -p 5555:5555 \
    iceblacktea/redroid-arm64:12.0.0-250116 \
    androidboot.redroid_gpu_mode=mali \
    androidboot.redroid_radio=1 \
    androidboot.redroid_wifi=1 \
    androidboot.redroid_wifi_gateway=10.100.200.1/24 \
    androidboot.redroid_magisk=1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250609"><a class="header" href="#20250609">20250609</a></h1>
<h3 id="1-rk3588-container-verification"><a class="header" href="#1-rk3588-container-verification">1. rk3588 container verification</a></h3>
<p>Steps:</p>
<pre><code> docker tag iceblacktea/redroid-arm64:12.0.0-250116 192.168.1.7:5000/iceblacktea/redroid-arm64:12.0.0-250116
docker push 192.168.1.7:5000/iceblacktea/redroid-arm64:12.0.0-250116
lxc-create -n  iceblacktea3588 -t oci -- -u docker://192.168.1.7:5000/iceblacktea/redroid-arm64:12.0.0-250116

modification of lxc.    

lxc-attach -n iceblacktea3588,   
REsult:    

 getprop | grep boot | grep com                                                                                                                                                                                                                                           
[ro.boottime.vendor.hwcomposer-2-1]: [4441550169946]
[sys.bootstat.first_boot_completed]: [0]
</code></pre>
<h3 id="2-rocky92-verification"><a class="header" href="#2-rocky92-verification">2. rocky92 verification</a></h3>
<p>Install via:</p>
<p><img src="./images/2025_06_09_11_44_15_990x638.jpg" alt="./images/2025_06_09_11_44_15_990x638.jpg" /></p>
<p>autossh configuration:</p>
<pre><code># cat /lib/systemd/system/autossh.service
[Unit]
Description=Auto SSH Tunnel
After=network-online.target
[Service]
User=test
Type=simple
ExecStart=/usr/bin/autossh -M 28800 -NR '*:21022:0.0.0.0:22' xxxx@192.168.1.xx -i ~/.ssh/id_rsa
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
StartLimitIntervalSec=5
StartLimitBurst=12
Restart=always
[Install]
WantedBy=multi-user.target
WantedBy=graphical.target
# systemctl daemon-reload
# systemctl enable autossh --now
</code></pre>
<p>On 192.168.1.xx, sshd should be configurated via:</p>
<pre><code>$ sudo vim /etc/ssh/sshd_config
GetewayPorts yes
TCPKeepAlive yes
ClientAliveInterval 60
ClientAliveCountMax 3
</code></pre>
<h3 id="3-flex170-redroid-issue"><a class="header" href="#3-flex170-redroid-issue">3. flex170 redroid issue</a></h3>
<p>redroid won't start, maybe missing the driver in aosp.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250610"><a class="header" href="#20250610">20250610</a></h1>
<h3 id="1-otii-with-w5100"><a class="header" href="#1-otii-with-w5100">1. otii with w5100</a></h3>
<p>change w5100 to vfio mode:</p>
<pre><code># grubby --update-kernel="/boot/vmlinuz-5.14.284-1_rc2.zdyun.x86_64" --args="vfio-pci.ids=1002:67c7,1002:aaf0"
[root@minirocky92 ~]# cat /etc/modprobe.d/vfio.conf
options vfio-pci ids=1002:67c7,1002:aaf0
[root@minirocky92 ~]# cat /etc/modules-load.d/vfio.conf
vfio-pci
[root@minirocky92 ~]# cat /etc/dracut.conf.d/vfio.conf
add_drivers+=" vfio vfio_iommu_type1 vfio_pci vfio_virqfd  "
# dracut -f --kver `uname -r`
# reboot
</code></pre>
<p>after reboot:</p>
<pre><code>[root@minirocky92 ~]# lspci -nn | grep 6f:00
6f:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Ellesmere [Radeon Pro WX 5100] [1002:67c7]
6f:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Ellesmere HDMI Audio [Radeon RX 470/480 / 570/580/590] [1002:aaf0]
[root@minirocky92 ~]# lspci -vvnn -s 6f:00.0 | grep -i 'in use'
	Kernel driver in use: vfio-pci
[root@minirocky92 ~]# lspci -vvnn -s 6f:00.1 | grep -i 'in use'
	Kernel driver in use: vfio-pci
</code></pre>
<p>Add gpu to vm:</p>
<p><img src="./images/2025_06_10_09_36_01_811x552.jpg" alt="./images/2025_06_10_09_36_01_811x552.jpg" /></p>
<h3 id="2-jumper-configuration"><a class="header" href="#2-jumper-configuration">2. jumper configuration</a></h3>
<p>os info:</p>
<pre><code>test@debian:~$ cat /etc/issue
Debian GNU/Linux 12 \n \l
test@debian:~$ uname -a
Linux debian 6.1.0-35-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.137-1 (2025-05-07) x86_64 GNU/Linux
</code></pre>
<p>Steps:</p>
<pre><code># vim /etc/apt/sources.list
    # 默认注释了源码仓库，如有需要可自行取消注释
    deb http://mirrors.ustc.edu.cn/debian bookworm main contrib non-free non-free-firmware
    # deb-src http://mirrors.ustc.edu.cn/debian bookworm main contrib non-free non-free-firmware
    deb http://mirrors.ustc.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware
    # deb-src http://mirrors.ustc.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware
    
    # backports 软件源，请按需启用
    # deb http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
    # deb-src http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
# apt update -y
# apt install -y vim nethogs iotop s-tui xrdp autossh
# apt install -y adb
manually import scrcpy
</code></pre>
<h3 id="3-lab-environment"><a class="header" href="#3-lab-environment">3 lab environment</a></h3>
<p>(br0)10.171.172.3: otii server
(br0)10.171.172.31: d3000no1</p>
<h3 id="4-mbr-to-uefi"><a class="header" href="#4-mbr-to-uefi">4. mbr to uefi</a></h3>
<p><img src="./images/2025_06_10_22_36_37_519x418.jpg" alt="./images/2025_06_10_22_36_37_519x418.jpg" /></p>
<p><img src="./images/2025_06_10_22_36_50_479x215.jpg" alt="./images/2025_06_10_22_36_50_479x215.jpg" /></p>
<p>failed with :</p>
<p><img src="./images/2025_06_10_22_37_26_766x364.jpg" alt="./images/2025_06_10_22_37_26_766x364.jpg" /></p>
<p>add an iso:</p>
<p><img src="./images/2025_06_10_22_37_59_335x201.jpg" alt="./images/2025_06_10_22_37_59_335x201.jpg" /></p>
<p>try ubuntu:</p>
<p><img src="./images/2025_06_10_22_39_26_873x617.jpg" alt="./images/2025_06_10_22_39_26_873x617.jpg" /></p>
<p>In gparted:</p>
<p><img src="./images/2025_06_10_22_48_05_791x444.jpg" alt="./images/2025_06_10_22_48_05_791x444.jpg" /></p>
<p><img src="./images/2025_06_10_22_49_38_779x423.jpg" alt="./images/2025_06_10_22_49_38_779x423.jpg" /></p>
<p><img src="./images/2025_06_10_23_11_19_747x545.jpg" alt="./images/2025_06_10_23_11_19_747x545.jpg" /></p>
<p><img src="./images/2025_06_10_23_11_46_752x321.jpg" alt="./images/2025_06_10_23_11_46_752x321.jpg" /></p>
<p>Use bootrepair for uefi installation:</p>
<pre><code>sudo add-apt-repository ppa:yannubuntu/boot-repair &amp;&amp; sudo apt update
sudo apt install -y boot-repair
sudo boot-repair
</code></pre>
<p>Follow the hints for repairing,</p>
<pre><code>sudo chroot "/mnt/boot-sav/vda2" dpkg --configure -a
sudo chroot "/mnt/boot-sav/vda2" apt-get install -fy
sudo chroot "/mnt/boot-sav/vda2" apt-get purge --allow-remove-essential -y grub-com*
sudo chroot "/mnt/boot-sav/vda2" apt-get purge --allow-remove-essential -y grub2-com*
sudo chroot "/mnt/boot-sav/vda2" apt-get purge --allow-remove-essential -y shim-signed
sudo chroot "/mnt/boot-sav/vda2" apt-get purge --allow-remove-essential -y grub-common:*
sudo chroot "/mnt/boot-sav/vda2" apt-get purge --allow-remove-essential -y grub2-common:*
sudo chroot "/mnt/boot-sav/vda2" apt-get install -y grub-efi

</code></pre>
<p><img src="./images/2025_06_10_23_14_37_561x301.jpg" alt="./images/2025_06_10_23_14_37_561x301.jpg" /></p>
<p><img src="./images/2025_06_10_23_15_20_563x131.jpg" alt="./images/2025_06_10_23_15_20_563x131.jpg" /></p>
<p><img src="./images/2025_06_10_23_17_54_953x318.jpg" alt="./images/2025_06_10_23_17_54_953x318.jpg" /></p>
<pre><code>Boot successfully repaired.

Please write on a paper the following URL:
https://paste.ubuntu.com/p/JNvZGtyMP8/


In case you still experience boot problem, indicate this URL to:
boot.repair@gmail.com or to your favorite support forum.

Locked-NVram detected. Please do not forget to make your UEFI firmware boot on the Ubuntu 22.04.5 LTS entry (vda3/efi/ubuntu/grubx64.efi file) !
</code></pre>
<p>After reboot:</p>
<p><img src="./images/2025_06_10_23_26_50_712x452.jpg" alt="./images/2025_06_10_23_26_50_712x452.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250611"><a class="header" href="#20250611">20250611</a></h1>
<h3 id="1-wx5100-issue"><a class="header" href="#1-wx5100-issue">1. wx5100 issue</a></h3>
<p>Won't start, should remove the <code>rom file</code>:</p>
<pre><code>    &lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
      &lt;source&gt;
        &lt;address domain='0x0000' bus='0x6f' slot='0x00' function='0x0'/&gt;
      &lt;/source&gt;
      &lt;rom file='/usr/share/OVMF/AMD.WX5100.8192.180902.rom'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x06' slot='0x00' function='0x0'/&gt;
    &lt;/hostdev&gt;

</code></pre>
<p>Switch to hwe kernel:</p>
<pre><code>sudo apt install linux-generic-hwe-22.04
</code></pre>
<p>update firmware:</p>
<pre><code>git clone https://kernel.googlesource.com/pub/scm/linux/kernel/git/firmware/linux-firmware.git
   sudo cp linux-firmware/amdgpu/* /lib/firmware/amdgpu
dracut --regenerate-all -f
# case ubuntu   sudo update-initramfs -k all -u -v
</code></pre>
<p>vendor reset:</p>
<pre><code> grep -E 'CONFIG_FTRACE|CONFIG_KPROBES|CONFIG_PCI_QUIRKS|CONFIG_KALLSYMS|CONFIG_KALLSYMS_ALL|CONFIG_FUNCTION_TRACER' /boot/config-$(uname -r)
git clone https://github.com/gnif/vendor-reset.git
cd vendor-reset
dkms install .
or: 
make 
make install
# cat /etc/modules-load.d/vfio.conf 
vfio-pci
vendor-reset
</code></pre>
<h3 id="2-i9-for-android"><a class="header" href="#2-i9-for-android">2. i9 for android</a></h3>
<p>Del for bios configuration:</p>
<p><img src="./images/2025_06_11_11_40_55_1078x806.jpg" alt="./images/2025_06_11_11_40_55_1078x806.jpg" /></p>
<p>Display:</p>
<p><img src="./images/2025_06_11_11_41_21_823x251.jpg" alt="./images/2025_06_11_11_41_21_823x251.jpg" /></p>
<p>Choose USB for boot:</p>
<p><img src="./images/2025_06_11_11_41_46_1100x431.jpg" alt="./images/2025_06_11_11_41_46_1100x431.jpg" /></p>
<p>Choose ubuntu-24.04.2-desktop-amd64.iso for boot:</p>
<p><img src="./images/2025_06_11_11_42_26_884x644.jpg" alt="./images/2025_06_11_11_42_26_884x644.jpg" /></p>
<p>layout:</p>
<p><img src="./images/2025_06_11_11_48_40_763x355.jpg" alt="./images/2025_06_11_11_48_40_763x355.jpg" /></p>
<p>user/password:</p>
<p><img src="./images/2025_06_11_11_49_13_479x332.jpg" alt="./images/2025_06_11_11_49_13_479x332.jpg" /></p>
<p>startup sequence:</p>
<p><img src="./images/2025_06_11_11_53_45_986x210.jpg" alt="./images/2025_06_11_11_53_45_986x210.jpg" /></p>
<p>setup ip:<br />
<img src="./images/2025_06_11_12_01_08_658x406.jpg" alt="./images/2025_06_11_12_01_08_658x406.jpg" /></p>
<pre><code>sudo apt install -y vim iotop virt-manager nethogs s-tui
sudo apt install -y linux-headers-6.8.0-41-generic linux-headers-6.8.0-41 linux-image-6.8.0-41-generic linux-modules-6.8.0-41-generic linux-tools-6.8.0-41-generic linux-modules-extra-6.8.0-41-generic 
sudo mv /usr/bin/linux-check-removal /usr/bin/linux-check-removal.orig
echo -e '#!/bin/sh\necho "Overriding default linux-check-removal script!"\nexit 0' | sudo tee /usr/bin/linux-check-removal
sudo chmod +x /usr/bin/linux-check-removal
sudo apt remove -y linux-headers-$(uname -r) linux-image-$(uname -r) linux-modules-$(uname -r) linux-tools-$(uname -r) linux-modules-extra-$(uname -r)
echo "options i915 force_probe=7d55 enable_guc=3" | sudo tee -a /etc/modprobe.d/i915.conf
sudo mkdir -p /lib/firmware/i915
sudo wget https://github.com/intel-gpu/intel-gpu-firmware/raw/main/firmware/mtl_gsc_102.0.0.1511.bin -O /lib/firmware/i915/mtl_gsc_102.0.0.1511.bin
sudo wget https://github.com/intel-gpu/intel-gpu-firmware/raw/main/firmware/mtl_guc_70.6.4.bin -O /lib/firmware/i915/mtl_guc_70.6.4.bin
sudo wget https://github.com/intel-gpu/intel-gpu-firmware/raw/main/firmware/mtl_huc_8.4.3_gsc.bin -O /lib/firmware/i915/mtl_huc_8.4.3_gsc.bin
sudo shutdown -r now &amp;
git clone https://github.com/strongtz/i915-sriov-dkms
sudo apt install build-* dkms -y
cd i915-sriov-dkms &amp;&amp; sudo dkms add .
cd i915-sriov-dkms &amp;&amp; sudo dkms install -m i915-sriov-dkms -v $(cat VERSION) --force
sudo update-initramfs -u
sudo shutdown -r now &amp;
</code></pre>
<p>adjust to:</p>
<pre><code>sudo dkms install -m i915-sriov-dkms -v 2025.05.18 --force
vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash intel_iommu=on i915.enable_guc=3 i915.max_vfs=7 module_blacklist=xe"

sudo update-grub2 &amp;&amp; sudo reboot
</code></pre>
<p><img src="./images/2025_06_11_13_01_45_1020x645.jpg" alt="./images/2025_06_11_13_01_45_1020x645.jpg" /></p>
<p>Create vfs:</p>
<pre><code>test@i9workstation:~$ sudo lspci | grep -i vga  | grep -i uhd
00:02.0 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
test@i9workstation:~$ sudo su
root@i9workstation:/home/test# echo 4 &gt; /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs
root@i9workstation:/home/test# lspci | grep -i vga | grep -i uhd
00:02.0 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
00:02.1 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
00:02.2 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
00:02.3 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
00:02.4 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)
</code></pre>
<p>Create network:</p>
<p><img src="./images/2025_06_11_14_29_37_436x347.jpg" alt="./images/2025_06_11_14_29_37_436x347.jpg" /></p>
<p>Import controller:</p>
<p><img src="./images/2025_06_11_14_30_21_390x300.jpg" alt="./images/2025_06_11_14_30_21_390x300.jpg" /></p>
<p>uefi:</p>
<p><img src="./images/2025_06_11_14_31_00_490x250.jpg" alt="./images/2025_06_11_14_31_00_490x250.jpg" /></p>
<p>specify mac address:</p>
<p><img src="./images/2025_06_11_14_32_25_426x253.jpg" alt="./images/2025_06_11_14_32_25_426x253.jpg" /></p>
<p>Import compute:</p>
<p><img src="./images/2025_06_11_14_33_21_336x321.jpg" alt="./images/2025_06_11_14_33_21_336x321.jpg" /></p>
<p><img src="./images/2025_06_11_14_33_34_358x170.jpg" alt="./images/2025_06_11_14_33_34_358x170.jpg" /></p>
<p><img src="./images/2025_06_11_14_33_53_323x287.jpg" alt="./images/2025_06_11_14_33_53_323x287.jpg" /></p>
<p>specify uefi, mac address, etc.</p>
<p><img src="./images/2025_06_11_14_34_59_451x288.jpg" alt="./images/2025_06_11_14_34_59_451x288.jpg" /></p>
<p>add 1 vf:</p>
<p><img src="./images/2025_06_11_14_36_20_528x312.jpg" alt="./images/2025_06_11_14_36_20_528x312.jpg" /></p>
<p>Boot to uefi , disable secure boot</p>
<p><img src="./images/2025_06_11_14_44_09_460x228.jpg" alt="./images/2025_06_11_14_44_09_460x228.jpg" /></p>
<p>compute vm :</p>
<pre><code>apt install build-* dkms linux-headers-$(uname -r) linux-modules-extra-$(uname -r)
wget -O /tmp/i915-sriov-dkms_2025.05.18_amd64.deb "https://github.com/strongtz/i915-sriov-dkms/releases/download/2025.05.18/i915-sriov-dkms_2025.05.18_amd64.deb"
dpkg -i /tmp/i915-sriov-dkms_2025.05.18_amd64.deb
GRUB_CMDLINE_LINUX_DEFAULT="intel_iommu=on i915.enable_guc=3 module_blacklist=xe"
update-grub
update-initramfs -u
</code></pre>
<p>After reboot vm:</p>
<pre><code>root@compute:~# uname -a
Linux compute 6.8.0-60-generic #63~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Apr 22 19:00:15 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
root@compute:~# ls /dev/dri/
by-path  card0  renderD128
root@compute:~# lspci | grep -i vga
06:00.0 VGA compatible controller: Intel Corporation Device a780 (rev 04)
root@compute:~# lspci -vvnn -s 06:00.0 | grep -i 'in use'
	Kernel driver in use: i915
</code></pre>
<p>host machine, install:</p>
<pre><code>sudo apt install -y adb scrcpy net-tools bridge-utils
</code></pre>
<p>bridge:</p>
<pre><code> nmcli con show
 nmcli connection add type bridge ifname br0 stp no
 nmcli con add type bridge-slave ifname enp11s0 master br0
 nmcli con up  bridge-slave-enp11s0
</code></pre>
<h3 id="3-vfvm-to-virglvm"><a class="header" href="#3-vfvm-to-virglvm">3. vfVM to virglVM</a></h3>
<p>Create virgl based vm qcow2:</p>
<pre><code>qemu-img create -f qcow2 -b openstack2.qcow2.bak openstack2.qcow2
qemu-img create -f qcow2 -b openstack2.qcow2.bak -F qcow2 openstack2.qcow2
qemu-img create -f qcow2 -b openstack2.qcow2.bak -F qcow2 openstackvirgl.qcow2
</code></pre>
<p>virgl:</p>
<p><img src="./images/2025_06_11_15_45_00_378x300.jpg" alt="./images/2025_06_11_15_45_00_378x300.jpg" /></p>
<p>nvidiavirgl:</p>
<p><img src="./images/2025_06_11_15_45_43_342x285.jpg" alt="./images/2025_06_11_15_45_43_342x285.jpg" /></p>
<p>virgl:</p>
<p><img src="./images/2025_06_11_15_46_13_470x408.jpg" alt="./images/2025_06_11_15_46_13_470x408.jpg" /></p>
<p>2 nics:</p>
<p><img src="./images/2025_06_11_15_46_51_561x348.jpg" alt="./images/2025_06_11_15_46_51_561x348.jpg" /></p>
<p><img src="./images/2025_06_11_15_49_34_328x222.jpg" alt="./images/2025_06_11_15_49_34_328x222.jpg" /></p>
<p>change ip to <code>10.171.172.26</code>, hostname to <code>nvidiavirgl</code>.</p>
<pre><code># cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	nvidiavirgl
...
10.171.172.21 controller
10.171.172.22 compute
</code></pre>
<p>Change openstack related items:</p>
<pre><code>root@nvidiavirgl:/etc# diff nova/nova.conf ./nova/nova.conf.bak
6c6
&lt; my_ip = 10.171.172.26
---
&gt; my_ip = 192.168.200.50
106c106
&lt; novncproxy_base_url = http://10.171.172.21:6080/vnc_auto.html
---
&gt; novncproxy_base_url = http://192.168.200.40:6080/vnc_auto.html
root@nvidiavirgl:/etc# diff ./neutron/plugins/ml2/openvswitch_agent.ini.bak ./neutron/plugins/ml2/openvswitch_agent.ini
10c10
&lt; local_ip = 192.168.200.50
---
&gt; local_ip = 10.171.172.26
</code></pre>
<h3 id="4-virgl-vmuser-mode"><a class="header" href="#4-virgl-vmuser-mode">4. virgl vm(user mode)</a></h3>
<p>Steps:</p>
<pre><code>chmod u+s /usr/libexec/qemu-bridge-helper
mkdir -p /etc/qemu
echo "allow br0" &gt; /etc/qemu/bridge.conf
</code></pre>
<p>refers to <code>https://bbs.archlinux.org/viewtopic.php?id=299452</code></p>
<h3 id="5-ubuntu2204-compute-node-workingtips"><a class="header" href="#5-ubuntu2204-compute-node-workingtips">5. ubuntu2204 compute node workingtips</a></h3>
<p>Steps:</p>
<pre><code>sudo apt update -y &amp;&amp; sudo apt upgrade -y
sudo su
systemctl stop apt-daily.timer;systemctl disable apt-daily.timer ; systemctl stop apt-daily-upgrade.timer ; systemctl disable apt-daily-upgrade.timer; systemctl stop apt-daily.service;  systemctl mask apt-daily.service; systemctl daemon-reload
sudo apt install -y nethogs vim iotop s-tui ansible

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250612"><a class="header" href="#20250612">20250612</a></h1>
<h3 id="1-ansible-deployment-of-os"><a class="header" href="#1-ansible-deployment-of-os">1. ansible deployment of OS</a></h3>
<p>Deploy:</p>
<pre><code># hostnamectl set-hostname autodeploy1
# vim /etc/hosts
127.0.1.1.1 autodeploy1
10.171.172.21   controller
# ./0_sysctl.sh
# ./2_runansible.sh
</code></pre>
<p>Then in controller node:</p>
<pre><code># openstack compute service list --service nova-compute | grep autodeploy1
| 411bb3b0-5575-4c10-bd84-25ccd30b317a | nova-compute | autodeploy1 | nova | enabled | up    | 2025-06-12T03:03:51.000000 |
</code></pre>
<h3 id="2-nvidia-working-items"><a class="header" href="#2-nvidia-working-items">2. nvidia working items</a></h3>
<p>Tips for working.</p>
<pre><code>test@compute:~$ sudo rm -f /etc/resolv.conf 
test@compute:~$ sudo su
root@nvidiahope:/home/test# echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf
root@nvidiahope:/home/test# apt update -y &amp;&amp; apt install -y linux-image-generic

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250613"><a class="header" href="#20250613">20250613</a></h1>
<h3 id="1-ansible-for-openstack-deployment"><a class="header" href="#1-ansible-for-openstack-deployment">1. ansible for openstack deployment</a></h3>
<p>Test network environment:</p>
<p><img src="./images/2025_06_13_11_06_54_420x504.jpg" alt="./images/2025_06_13_11_06_54_420x504.jpg" /></p>
<pre><code>qemu-img create -f qcow2 -b ubuntu220405openstackcompute_autodeploy1.qcow2 -F qcow2 testansible_controller.qcow2
qemu-img create -f qcow2 -b ubuntu220405openstackcompute_autodeploy1.qcow2 -F qcow2 testansible_compute.qcow2
</code></pre>
<p>Create vms:</p>
<p><img src="./images/2025_06_13_11_15_06_992x743.jpg" alt="./images/2025_06_13_11_15_06_992x743.jpg" /></p>
<p>Manually setup ip addr on controller(192.168.150.40), then transfer deploy materials to controller.</p>
<pre><code>test@compute:~$ tar xzvf openstack_deployment.tar.gz 
root@compute:/etc/netplan# cat /etc/netplan/eth0.yaml 
network:
  version: 2
  ethernets:
    eth0:
#      dhcp4: true
      dhcp4: false
      addresses: [192.168.150.40/24]
      gateway4: 192.168.150.1
    eth1:
      dhcp4: false
root@compute:/etc/netplan# netplan apply --debug
### Change  `192.168.200`-&gt;`192.168.150` in Controller_0.sh
./Controller_0.sh
### Relogin
test@controller:~$ sudo vim /etc/hosts
127.0.1.1 controller
</code></pre>
<p>Change inventory definitions:</p>
<p><img src="./images/2025_06_13_11_22_28_436x274.jpg" alt="./images/2025_06_13_11_22_28_436x274.jpg" /></p>
<p>should add mykey:</p>
<pre><code> ssh-keygen -N ""
 openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey

openstack image create "redroid12" --file redroid12.img --disk-format raw --container-format bare --public
</code></pre>
<p>Compute node:</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT="net.ifnames=0 biosdevname=0 i915.force_probe=* i915.enable_guc=7 module_blacklist=xe"
# uname -a
Linux compute 5.15.113-lts2021-iotg #1 SMP Fri May 30 16:09:38 CST 2025 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>network, create security group:</p>
<pre><code>openstack security group rule create --protocol tcp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --ingress default
openstack security group rule create --protocol tcp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --egress default
openstack security group rule create --protocol udp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --egress default
openstack security group rule create --protocol udp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --ingress default
openstack security group rule create --protocol icmp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --ingress default
openstack security group rule create --protocol icmp --dst-port 20:65535 --remote-ip 0.0.0.0/0 --egress default
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250614"><a class="header" href="#20250614">20250614</a></h1>
<h3 id="1-rk3588-610-verification"><a class="header" href="#1-rk3588-610-verification">1. rk3588 6.1.0 verification</a></h3>
<p>Run docker instance via:</p>
<pre><code>  docker run -itd  --privileged -v /data:/data -p 5555:5555 chisbread/rk3588-gaming:redroid-firefly androidboot.redroid_height=1600 androidboot.redroid_width=2560 androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=host --mount=type=bind，source=/dev/mali0，destination=/dev/mali0
</code></pre>
<p>arbian:</p>
<pre><code>root@rock-5b-plus:/home/test/3588# uname -a
Linux rock-5b-plus 6.1.115-vendor-rk35xx #1 SMP Thu May  8 06:01:30 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux
root@rock-5b-plus:/home/test/3588# cat /etc/issue
Armbian 25.5.1 Noble \l 

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250615"><a class="header" href="#20250615">20250615</a></h1>
<h3 id="openstack-c-version"><a class="header" href="#openstack-c-version">Openstack C version</a></h3>
<p><code>https://blog.csdn.net/m0_56363537/article/details/139628175</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250616"><a class="header" href="#20250616">20250616</a></h1>
<h3 id="1-fantancy-gpu"><a class="header" href="#1-fantancy-gpu">1. fantancy gpu</a></h3>
<p>Install ubuntu20.04.3 arm64 iso.</p>
<p>fantancy-II, no arm64 gpu driver.</p>
<p>should use fantancy -I</p>
<h3 id="2-zkfdfantancyii"><a class="header" href="#2-zkfdfantancyii">2. zkfd(fantancyII)</a></h3>
<p>Changed to zkfd, the /dev/dri works well, but could not install binder/binderfs.</p>
<h3 id="3-bbb-debian"><a class="header" href="#3-bbb-debian">3. bbb debian</a></h3>
<p>Write sd card:</p>
<pre><code>$ sudo dd if=./am335x-debian-12.11-base-vscode-v6.12-armhf-2025-05-29-4gb.img of=/dev/sda bs=10M &amp;&amp; sudo sync

</code></pre>
<h3 id="4-uosfantancyii"><a class="header" href="#4-uosfantancyii">4. uos(fantancyII)</a></h3>
<p>kernel info:</p>
<pre><code>root@test-PC:~# dmesg | grep PVR
[    2.922011] PVR_K:  263: Read BVNC 35.4.1632.23 from HW device registers
[    2.922128] PVR_K:  263: RGX Device registered BVNC 35.4.1632.23 with 1 core in the system
[    5.276161] PVR_K:  954: AXI fabric coherency (RGX_CR_SOC_AXI): 0xc
[    5.279720] PVR_K:  954: RGX Firmware image 'innogpu/fh2m.fw' loaded
[    5.287702] PVR_K:  954: Shader binary image 'innogpu/fh2m.sh' loaded
root@test-PC:~# ls /dev/dri/
by-path  card0	renderD128
root@test-PC:~# find /dev | grep -i pvr
</code></pre>
<h3 id="5-modinfo-result"><a class="header" href="#5-modinfo-result">5. modinfo result</a></h3>
<p>fantancy II:</p>
<pre><code>root@test-PC:~# modinfo /lib/modules/5.10.0-arm64-desktop/kernel/drivers/gpu/drm/innogpu//innogpu.ko  | grep -i 1ec8
alias:          pci:v00001EC8d00009810sv*sd*bc*sc*i*
alias:          pci:v00001EC8d00001EB8sv*sd*bc*sc*i*
alias:          pci:v00001EC8d00001EA8sv*sd*bc*sc*i*
root@test-PC:~# lspci -nn | grep -i vga
07:00.0 VGA compatible controller [0300]: Innosilicon Co Ltd Fantasy II-M [1ec8:9810] (rev 01)
</code></pre>
<p>While the dkms tree built:</p>
<pre><code>root@test-PC:~# modinfo innogpu | grep -i 1ec8
alias:          pci:v00001EC8d00008811sv*sd*bc*sc*i*
alias:          pci:v00001EC8d00008810sv*sd*bc*sc*i*
alias:          pci:v00001EC8d00001EB8sv*sd*bc*sc*i*
alias:          pci:v00001EC8d00001EA8sv*sd*bc*sc*i*
</code></pre>
<p><img src="./images/2025_06_16_18_21_58_1156x580.jpg" alt="./images/2025_06_16_18_21_58_1156x580.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250617"><a class="header" href="#20250617">20250617</a></h1>
<h3 id="1-virglspice-on-rockylinux"><a class="header" href="#1-virglspice-on-rockylinux">1. virgl/spice on RockyLinux</a></h3>
<p>Install via:</p>
<pre><code>dnf -y copr enable ligenix/enterprise-qemu-spice ; dnf update
dnf install virt-manager
</code></pre>
<p>But after this installation, the mesa and related packages will be upgraded, so virgl wont' working:</p>
<pre><code>[  598.672335] systemd-journald[1040]: Successfully sent stream file descriptor to service manager.
[  598.793852] qemu-kvm[3329]: segfault at 40 ip 00007f28e274f3cc sp 00007ffeb248c7c0 error 6 in libgallium-24.2.8.so[7f28e1a81000+1597000]
[  598.793869] Code: 41 5d 41 5e 41 5f c3 0f 1f 80 00 00 00 00 45 8b 75 10 41 8d 46 40 3d 00 00 04 00 77 41 f3 0f 6f 03 49 8b 45 08 45 89 f7 89 ee &lt;42&gt; 0f 11 04 38 49 8b 5d 08 49 8b 7d 18 41 83 45 10 40 4c 01 fb 48
[  598.811742] systemd-journald[1040]: Successfully sent stream file descriptor to service manager.
[  598.854914] systemd-journald[1040]: Compressed data object 5567 -&gt; 1726 using ZSTD
</code></pre>
<h3 id="2-flex170-virgl"><a class="header" href="#2-flex170-virgl">2. flex170 virgl</a></h3>
<p>Remove repository related, Install released rpms:</p>
<pre><code>rpm -e --nodeps mesa-filesystem-24.2.8-2.el9_6.x86_64 mesa-libgbm-24.2.8-2.el9_6.x86_64 mesa-libEGL-24.2.8-2.el9_6.x86_64 mesa-dri-drivers-24.2.8-2.el9_6.x86_64 mesa-libglapi-24.2.8-2.el9_6.x86_64 mesa-libGL-24.2.8-2.el9_6.x86_64 mesa-libgbm-devel-24.2.8-2.el9_6.x86_64 mesa-vulkan-drivers-24.2.8-2.el9_6.x86_64 mesa-libxatracker-24.2.8-2.el9_6.x86_64
yum install ./pkgs/mesa/mesa-dri-drivers-24.1.0.1.1-dgfx11319.el9.x86_64.rpm ./pkgs/mesa/mesa-filesystem-24.1.0.1.1-dgfx11319.el9.x86_64.rpm ./pkgs/mesa/mesa-libgbm-24.1.0.1.1-dgfx11319.el9.x86_64.rpm  ./pkgs/mesa/mesa-libEGL-24.1.0.1.1-dgfx11319.el9.x86_64.rpm ./pkgs/mesa/mesa-dri-drivers-24.1.0.1.1-dgfx11319.el9.x86_64.rpm ./pkgs/mesa/mesa-libglapi-24.1.0.1.1-dgfx11319.el9.x86_64.rpm ./pkgs/mesa/mesa-libGL-24.1.0.1.1-dgfx11319.el9.x86_64.rpm
</code></pre>
<p>dmesg to show the rpm related:</p>
<pre><code>yum whatprovides /usr/lib64/libgallium-24.2.8.so
yum whatprovides /usr/lib64/dri/iris_dri.so
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250618"><a class="header" href="#20250618">20250618</a></h1>
<h3 id="1-aic-in-vm"><a class="header" href="#1-aic-in-vm">1. aic in vm</a></h3>
<p>Install driver:</p>
<pre><code>wget -qO - https://repositories.intel.com/gpu/intel-graphics.key |
    sudo gpg --yes --dearmor --output /usr/share/keyrings/intel-graphics.gpg
sudo apt update
sudo apt install -y gpg-agent wget
. /etc/os-release
if [[ ! " jammy " =~ " ${VERSION_CODENAME} " ]]; then
    echo "Ubuntu version ${VERSION_CODENAME} not supported"
else
    wget -qO - https://repositories.intel.com/gpu/intel-graphics.key | \
    sudo gpg --yes --dearmor --output /usr/share/keyrings/intel-graphics.gpg
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/intel-graphics.gpg] https://repositories.intel.com/gpu/ubuntu ${VERSION_CODENAME}/lts/2350 unified" | \
    sudo tee /etc/apt/sources.list.d/intel-gpu-${VERSION_CODENAME}.list
    sudo apt update
fi
sudo apt install -y \
    linux-headers-$(uname -r) \
    linux-modules-extra-$(uname -r) \
    flex bison \
    intel-fw-gpu intel-i915-dkms xpu-smi
sudo reboot

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250619"><a class="header" href="#20250619">20250619</a></h1>
<h3 id="1-dp-hdmi"><a class="header" href="#1-dp-hdmi">1. dp-&gt;hdmi</a></h3>
<p>port failed, buy one for enterprise.</p>
<h3 id="2-mbox-testing"><a class="header" href="#2-mbox-testing">2. Mbox testing</a></h3>
<p>Copy the data folder(sharing downloaded games).</p>
<p>Use scripts for copying.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250620"><a class="header" href="#20250620">20250620</a></h1>
<h3 id="1-lxcredroid-on-fh"><a class="header" href="#1-lxcredroid-on-fh">1. lxc(redroid) on fh</a></h3>
<p>system info:</p>
<pre><code>root@fenghua:~# cat /etc/issue
Ubuntu 20.04.3 LTS \n \l
root@fenghua:~# uname -a
Linux fenghua 5.4.93 #1 SMP Sun Feb 19 08:29:12 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux
</code></pre>
<p>Build skopeo on ubuntu20.04:</p>
<pre><code># cat skopeo/Dockerfile 
FROM golang:1.18 AS skopeo-build
WORKDIR /usr/src/skopeo

ARG SKOPEO_VERSION="1.8.0"
RUN curl -fsSL "https://github.com/containers/skopeo/archive/v${SKOPEO_VERSION}.tar.gz" \
  | tar -xzf - --strip-components=1
RUN CGO_ENABLED=0 DISABLE_DOCS=1 make BUILDTAGS=containers_image_openpgp GO_DYN_FLAGS=
RUN ./bin/skopeo --version

FROM scratch AS skopeo-rootfs
COPY --from=skopeo-build /usr/src/skopeo/bin/skopeo /usr/local/bin/
COPY --from=skopeo-build /usr/src/skopeo/default-policy.json /etc/containers/policy.json

FROM ubuntu:20.04
COPY --from=skopeo-rootfs / /
RUN skopeo --version
# apt install docker-buildx
# DOCKER_BUILDKIT=1  docker build . --target skopeo-rootfs --output=/
# skopeo --version
skopeo version 1.8.0
# which skopeo
/usr/local/bin/skopeo
</code></pre>
<h3 id="2-autocreate-lxc-config-file"><a class="header" href="#2-autocreate-lxc-config-file">2. autocreate lxc config file</a></h3>
<p>script for adding:</p>
<pre><code>$ cat autocreate.sh
for i in `ls /dev`
do
	if [ -d "/dev/"$i ]; then
		echo lxc.mount.entry = /dev/$i dev/$i none bind,optional,create=dir
		#echo $i
	else
		echo lxc.mount.entry = /dev/$i dev/$i none bind,optional,create=file
		#echo kkk $i
fi
done
</code></pre>
<h3 id="3-hack-for-innogpu"><a class="header" href="#3-hack-for-innogpu">3. hack for innogpu</a></h3>
<p>Added following items :</p>
<pre><code>lxc.init.cmd = /init  androidboot.hardware=innogpu
lxc.apparmor.profile = unconfined
lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000
lxc.mount.entry = /root/DRIVER/scripts/data/2 data none bind,optional,create=dir

lxc.mount.entry = /dev/ashmem dev/ashmem none bind,optional,create=file
lxc.mount.entry = /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry = /dev/fuse dev/fuse none bind,optional,create=file
lxc.mount.entry = /dev/ion-0 dev/ion-0 none bind,optional,create=file
lxc.mount.entry = /dev/pvr_sync dev/pvr_sync none bind,optional,create=file
lxc.mount.entry = /dev/vpu0 dev/vpu0 none bind,optional,create=file

</code></pre>
<h3 id="4-libvirt-lxc-building-on-ubuntu2004"><a class="header" href="#4-libvirt-lxc-building-on-ubuntu2004">4. libvirt-lxc building on ubuntu20.04</a></h3>
<p>virsh start failed, reason unknown.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250621"><a class="header" href="#20250621">20250621</a></h1>
<h3 id="1-archlinux-update-issue"><a class="header" href="#1-archlinux-update-issue">1. archlinux update issue</a></h3>
<p>pacman issue:</p>
<pre><code>错误：无法准备事务处理 (无法满足依赖关系)
:: 安装 wxwidgets-gtk3 (3.2.8.1-2) 破坏依赖 'wxgtk3' （python2-wxpython3 需要）
:: 安装 libxml2 (2.14.4-1) 破坏依赖 'libxml2.so=2-64' （rest 需要）
</code></pre>
<p>Solved via:</p>
<pre><code>  sudo pacman -R rest
  sudo pacman -R python2-wxpython3 playonlinux

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250622"><a class="header" href="#20250622">20250622</a></h1>
<h3 id="awesome-wm-mouse-cursor"><a class="header" href="#awesome-wm-mouse-cursor">awesome wm mouse cursor</a></h3>
<p>should be downloaded from gnome-look then apply</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250623"><a class="header" href="#20250623">20250623</a></h1>
<h3 id="1-libvirt-lxc-related"><a class="header" href="#1-libvirt-lxc-related">1. libvirt lxc related</a></h3>
<p>Create lxc instance:</p>
<pre><code>lxc-create --name mycontainer --template download -- --dist alpine --release 3.19 --arch arm64
</code></pre>
<p>change username/password in container, then <code>lxc-stop -n mycontainer -k</code>.</p>
<p>Create the libvirt lxc instance via(mycontainer.xml):</p>
<pre><code>&lt;domain type='lxc'&gt;
  &lt;name&gt;mycontainer&lt;/name&gt;
  &lt;uuid&gt;f405cca6-d9fe-4d12-a33c-580ab0161a8d&lt;/uuid&gt;
  &lt;memory unit='KiB'&gt;6270976&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;6270976&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='aarch64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/sbin/init&lt;/init&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;syslog state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/libvirt/libvirt_lxc&lt;/emulator&gt;
    &lt;controller type='usb' index='0' model='none'/&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxc/mycontainer/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/dev/dri'/&gt;
      &lt;target dir='/dev/dri'/&gt;
    &lt;/filesystem&gt;
    &lt;interface type='network'&gt;
      &lt;mac address='52:54:00:5f:0b:a8'/&gt;
      &lt;source network='default'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='0'/&gt;
    &lt;/console&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/dri/renderD128&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/fuse&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/ion-0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/pvr_sync&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/vpu0&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
    &lt;hostdev mode='capabilities' type='misc'&gt;
      &lt;source&gt;
        &lt;char&gt;/dev/ashmem&lt;/char&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<p>Define the lxc:</p>
<pre><code>virsh -c lxc:/// define mycontainer.xml
</code></pre>
<h3 id="2-rebuild-libvirtlxc"><a class="header" href="#2-rebuild-libvirtlxc">2. rebuild libvirtLXC</a></h3>
<p>Remove installed libvirt related:</p>
<pre><code>apt remove libvirt-daemon
apt remove libvirt-daemon-system libvirt-daemon-system-systemd
apt remove libvirt-clients libvirt-daemon-system libvirt0:arm64
apt remove libvirt-clients libvirt-daemon-system --purge
</code></pre>
<p>Create user/group:</p>
<pre><code>sudo useradd -m libvirt-qemu
sudo groupadd libvirt-qemu
sudo groupadd libvirt
sudo groupadd libvirtd
sudo usermod -aG libvirt-qemu,libvirt,libvirtd libvirt-qemu
</code></pre>
<p>Build:</p>
<pre><code>wget https://download.libvirt.org/libvirt-8.0.0.tar.xz
tar xJvf libvirt-8.0.0.tar.xz
apt install -y python3-pip libtirpc-dev
pip3 install meson
meson build -Dsystem=true -Ddriver_qemu=enabled -Ddriver_lxc=enabled -Ddriver_interface=enabled -Ddriver_libvirtd=enabled -Ddriver_remote=enabled -Ddriver_network=enabled --prefix=/usr
ninja -C build install
systemctl enable libvirtd
systemctl enable --now virtqemud.socket
systemctl enable --now virtlxcd.socket
systemctl enable --now virtnetworkd
reboot
</code></pre>
<p>After reboot:</p>
<pre><code># virsh -c lxc:/// list
 Id   Name   State
--------------------
# virsh --version
8.0.0
</code></pre>
<p>Kernel parameters:</p>
<pre><code> net.ifnames=0 biosdevname=0 systemd.unified_cgroup_hierarchy=1
</code></pre>
<h3 id="3-fh-docker-issue"><a class="header" href="#3-fh-docker-issue">3. fh docker issue</a></h3>
<p>Create 2 lxc instance:</p>
<pre><code>lxc-create -n fuckfh -t oci -- -u docker://192.168.1.7:5000/fh-redroid:latest
lxc-create -n fuckfh1 -t oci -- -u docker://192.168.1.7:5000/fh-redroid:latest
</code></pre>
<p>diffs:</p>
<pre><code># diff /var/lib/lxc/fuckfh1/config /var/lib/lxc/fuckfh/config
12,13c12,17
&lt; lxc.net.0.hwaddr = 52:54:00:5f:0b:a9
&lt; lxc.rootfs.path = dir:/var/lib/lxc/fuckfh1/rootfs
---
&gt; #lxc.net.0.hwaddr = 00:16:3e:c0:3b:4f
&gt; lxc.net.0.hwaddr = 52:54:00:5f:0b:a8
&gt; lxc.net.0.ipv4.address = 192.168.122.140/24
&gt; lxc.net.0.ipv4.gateway = 192.168.122.1
&gt; 
&gt; lxc.rootfs.path = dir:/var/lib/lxc/fuckfh/rootfs
19c23
&lt; lxc.uts.name = fuckfh1
---
&gt; lxc.uts.name = fuckfh
22a27
&gt; 
</code></pre>
<p>Start and view the result:</p>
<pre><code>root@fenghua:~# lxc-start -n fuckfh1
root@fenghua:~# lxc-ls -f
NAME        STATE   AUTOSTART GROUPS IPV4            IPV6 UNPRIVILEGED 
fuckfh      RUNNING 0         -      192.168.122.140 -    false        
fuckfh1     RUNNING 0         -      -               -    false
</code></pre>
<p>result:</p>
<pre><code>root@fenghua:~# lxc-attach -n fuckfh1 
:/ # getprop | grep boot | grep com    
grep: (standard input): Invalid argument
[ro.boottime.vendor.hwcomposer-2-1]: [2814814859080]
[sys.bootstat.first_boot_completed]: [0]
</code></pre>
<p>Fuck1 result:</p>
<pre><code>root     18532     1  0 09:27 ?        00:00:00 [lxc monitor] /var/lib/lxc fuckfh1
root     18533 18532  1 09:27 pts/3    00:00:01  \_ /system/bin/init second_stage androidboot.hardware=innogpu
root     18557 18533  0 09:27 ?        00:00:00      \_ /system/bin/init subcontext u:r:vendor_init:s0 14
root     18559 18533  0 09:27 ?        00:00:00      \_ /system/bin/ueventd
1036     18569 18533  1 09:27 ?        00:00:01      \_ /system/bin/logd
1069     18570 18533  0 09:27 ?        00:00:00      \_ /system/bin/lmkd
test     18571 18533  8 09:27 ?        00:00:06      \_ /system/bin/servicemanager
test     18572 18533  0 09:27 ?        00:00:00      \_ /system/bin/hwservicemanager
2000     18573 18533  0 09:27 ?        00:00:00      \_ /system/bin/sh
root     18580 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/vold --blkid_context=u:r:blkid:s0 --blkid_untrusted_context=u:r:blkid_untrusted:s0 --fsck_context=u:r:fsck:s0 --fsck_untru
test     18614 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/hw/android.system.suspend@1.0-service
9999     18615 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.keymaster@3.0-service
1058     18629 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/tombstoned
test     18653 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/hw/android.hidl.allocator@1.0-service
1002     18655 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.bluetooth@1.1-service.sim
1013     18656 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.cas@1.2-service
test     18657 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.gatekeeper@1.0-service.software
test     18658 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.graphics.allocator@2.0-service
test     18659 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.graphics.composer@2.1-service
test     18660 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.health@2.1-service
test     18661 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.power.stats@1.0-service.mock
1010     18662 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.wifi@1.0-service
9999     18663 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.power-service.example
1076     18665 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/credstore /data/misc/credstore
1072     18666 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/gpuservice
test     18667 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/surfaceflinger
2000     18707 18533  0 09:27 pts/3    00:00:00      \_ /apex/com.android.adbd/bin/adbd --root_seclabel=u:r:su:s0
9999     18709 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/traced_probes
9999     18710 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/traced
1019     18722 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/drmserver
test     18723 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/idmap2d
1067     18724 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/incidentd
root     18725 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/installd
1017     18726 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/keystore /data/misc/keystore
1040     18727 18533  0 09:27 pts/3    00:00:00      \_ media.extractor aextractor
1013     18728 18533  0 09:27 pts/3    00:00:00      \_ media.metrics diametrics
root     18731 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/storaged
1046     18733 18533  1 09:27 pts/3    00:00:01      \_ media.codec hw/android.hardware.media.omx@1.0-service
root     18734 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/sh vendor/bin/tmgp_producer.sh
root     28299 18734  0 09:28 pts/3    00:00:00      |   \_ sleep 3
libvirt+ 18735 18533  0 09:27 pts/3    00:00:00      \_ /vendor/bin/hw/rild
1046     18746 18533  0 09:27 pts/3    00:00:00      \_ media.swcodec oid.media.swcodec/bin/mediaswcodec
1066     18747 18533  0 09:27 pts/3    00:00:00      \_ /apex/com.android.os.statsd/bin/statsd
1020     18788 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/mdnsd
test     18789 18533  0 09:27 pts/3    00:00:00      \_ /system/bin/gatekeeperd /data/misc/gatekeeper
root     27570 18533 21 09:28 pts/3    00:00:00      \_ [main] &lt;defunct&gt;
root     27571 18533 20 09:28 pts/3    00:00:00      \_ zygote
1041     27572 18533  2 09:28 pts/3    00:00:00      \_ [audioserver] &lt;defunct&gt;
1047     27573 18533  1 09:28 pts/3    00:00:00      \_ [cameraserver] &lt;defunct&gt;
1013     27574 18533  1 09:28 pts/3    00:00:00      \_ [mediaserver] &lt;defunct&gt;
root     27575 18533  1 09:28 pts/3    00:00:00      \_ [Binder:8840_4] &lt;defunct&gt;
1010     27576 18533  0 09:28 pts/3    00:00:00      \_ /system/bin/wificond
1041     27577 18533  0 09:28 pts/3    00:00:00      \_ /vendor/bin/hw/android.hardware.audio.service
1002     27755 18533  5 09:28 pts/3    00:00:00      \_ [droid.bluetooth] &lt;defunct&gt;
10109    27777 18533 14 09:28 pts/3    00:00:00      \_ [ndroid.systemui] &lt;defunct&gt;
root     27886 18533  0 09:28 pts/3    00:00:00      \_ [iptables-restor] &lt;defunct&gt;
root     27891 18533  0 09:28 pts/3    00:00:00      \_ [ip6tables-resto] &lt;defunct&gt;
1068     28031 18533  1 09:28 pts/3    00:00:00      \_ [com.android.se] &lt;defunct&gt;
libvirt+ 28059 18533 17 09:28 pts/3    00:00:00      \_ [m.android.phone] &lt;defunct&gt;
test     28089 18533  2 09:28 pts/3    00:00:00      \_ [ngs:CryptKeeper] &lt;defunct&gt;
test     28143 18533  5 09:28 pts/3    00:00:00      \_ [ndroid.settings] &lt;defunct&gt;
10108    28186 18533  2 09:28 pts/3    00:00:00      \_ [droid.launcher3] &lt;defunct&gt;
1073     28266 18533  0 09:28 pts/3    00:00:00      \_ [re-initialized&gt;] &lt;defunct&gt;
test     28296 18533  1 09:28 pts/3    00:00:00      \_ [vdc] &lt;defunct&gt;
</code></pre>
<h3 id="4-docker-network"><a class="header" href="#4-docker-network">4. docker network</a></h3>
<p>Create:</p>
<pre><code>docker network create   --driver=bridge   --subnet=172.28.0.0/16   --ip-range=172.28.5.0/24   --gateway=172.28.5.254 kkk
</code></pre>
<p>test:</p>
<pre><code>docker run -it --name testu --net kkk ubuntu:latest /bin/bash
docker run -it --name testu1 --net kkk ubuntu:latest /bin/bash

apt update -y &amp;&amp; apt install -y net-tools iputils-ping
IP:
172.28.5.0 
172.28.5.1 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250624"><a class="header" href="#20250624">20250624</a></h1>
<h3 id="1-redroidlxc-aosp11-verification"><a class="header" href="#1-redroidlxc-aosp11-verification">1. redroid(lxc) aosp11 verification</a></h3>
<p>Tested on <code>5.15.0-139-generic</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Kind</th><th>Result</th></tr></thead><tbody>
<tr><td>lxc(11)</td><td>OK</td></tr>
<tr><td>lxc(12)</td><td>OK</td></tr>
<tr><td>libvirt_lxc(12), reuse lxc(12) folder</td><td>OK</td></tr>
<tr><td>libvirt_lxc(11), reuse lxc(11) folder</td><td>Failed</td></tr>
</tbody></table>
</div>
<h3 id="2-redroid-testinglxc"><a class="header" href="#2-redroid-testinglxc">2. redroid testing(lxc)</a></h3>
<p>redroid 13:</p>
<pre><code>lxc-create -n redroid13 -t oci -- -u docker://docker.io/redroid/redroid:13.0.0-latest
</code></pre>
<p>redroid 14:</p>
<pre><code>lxc-create -n redroid14 -t oci -- -u docker://docker.io/redroid/redroid:14.0.0-latest
</code></pre>
<p>redroid12/13/14 would be OK under lxc/<code>libvirt_lxc</code>, while 11/9 failed under <code>libvirt_lxc</code></p>
<h3 id="3-redroid-under-archlinux"><a class="header" href="#3-redroid-under-archlinux">3. redroid under archlinux</a></h3>
<p>Installation:</p>
<pre><code>fdisk /dev/vda
....
# lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0    7:0    0 853.9M  1 loop /run/archiso/airootfs
sr0     11:0    1   1.2G  0 rom  /run/archiso/bootmnt
vda    254:0    0   200G  0 disk 
└─vda1 254:1    0   200G  0 part 
root@archiso ~ # mkfs.ext4 /dev/vda1
root@archiso ~ # mount /dev/vda1 /mnt
root@archiso ~ # rm -f /etc/resolv.conf 
root@archiso ~ # echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf
root@archiso ~ # pacstrap -c /mnt base linux linux-firmware base-devel
</code></pre>
<p>pacstrap issue:</p>
<pre><code> pacstrap -c /mnt linux-firmware-amdgpu
 rm -f /var/cache/pacman/pkg/*
 pacstrap -c /mnt linux-firmware-intel linux-firmware-other linux-firmware-radeon
 rm -f /var/cache/pacman/pkg/*
 pacstrap -c /mnt linux-firmware
 rm -f /var/cache/pacman/pkg/*
 pacstrap -c /mnt base-devel
</code></pre>
<p>Continue:</p>
<pre><code>root@archiso /var/cache # genfstab -U /mnt &gt;&gt; /mnt/etc/fstab 
root@archiso /var/cache # arch-chroot /mnt
</code></pre>
<p>After installation:</p>
<pre><code>pacman -S docker lxc lxcfs linux-zen
</code></pre>
<p>Run reroid:</p>
<pre><code>docker run -itd --privileged -p 5555:5555 --name redroid12 redroid/redroid:12.0.0_64only-latest
</code></pre>
<p>Result:</p>
<pre><code>[root@archredroid ~]# docker ps
CONTAINER ID   IMAGE                                  COMMAND                  CREATED          STATUS          PORTS                                         NAMES
778c7ad3d756   redroid/redroid:12.0.0_64only-latest   "/init qemu=1 androi…"   31 seconds ago   Up 30 seconds   0.0.0.0:5555-&gt;5555/tcp, [::]:5555-&gt;5555/tcp   redroid12
[root@archredroid ~]# docker exec -it redroid12 sh
778c7ad3d756:/ # getprop | grep boot | grep com                                              
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [144504997268]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
</code></pre>
<p>setup lxc:</p>
<pre><code>pacman -S dnsmasq

# cat /etc/default/lxc-net 
USE_LXC_BRIDGE="true"

# If you change the LXC_BRIDGE to something other than lxcbr0, then
# you will also need to update your /etc/lxc/default.conf as well as the
# configuration (/var/lib/lxc/&lt;container&gt;/config) for any containers
# already created using the default config to reflect the new bridge
# name.
# If you have the dnsmasq daemon installed, you'll also have to update
# /etc/dnsmasq.d/lxc and restart the system wide dnsmasq daemon.
LXC_BRIDGE="lxcbr0"
LXC_ADDR="10.0.3.1"
LXC_NETMASK="255.255.255.0"
LXC_NETWORK="10.0.3.0/24"
LXC_DHCP_RANGE="10.0.3.2,10.0.3.254"
LXC_DHCP_MAX="253"
# systemctl enable lxc-net
</code></pre>
<p>Create test lxc instance:</p>
<pre><code>lxc-create --name playtime --template download -- --dist archlinux --release current --arch amd64
lxc-start -n playtime
lxc-ls -f
NAME     STATE   AUTOSTART GROUPS IPV4       IPV6                                    UNPRIVILEGED 
playtime RUNNING 0         -      10.0.3.154 fc42:5009:ba4b:5ab0:1266:6aff:fec5:42a7 false       
</code></pre>
<p>redroid/lxc work tips:</p>
<pre><code>pacman -S jq umoci skopeo
sed -i 's/set -eu/set -u/g' /usr/share/lxc/templates/lxc-oci
lxc-create -n redroid12 -t oci -- -u docker://docker.io/redroid/redroid:12.0.0_64only-latest
rm -f /var/lib/lxc/redroid12/rootfs/vendor/bin/ipconfigstore 
vim /var/lib/lxc/redroid12/config 

....
lxc.init.cmd = /init androidboot.hardware=redroid androidboot.redroid_gpu_mode=guest
lxc.apparmor.profile = unconfined
lxc.autodev = 1
lxc.autodev.tmpfs.size = 25000000
....
lxc-start -n redroid12
lxc-ls -f
......get the ip addr
pacman -S android-tools
adb connect ip:5555
adb shell
</code></pre>
<p>redroid 11:</p>
<pre><code>Create :      

 lxc-create -n redroid11 -t oci -- -u docker://docker.io/redroid/redroid:11.0.0-latest
 rm -f /var/lib/lxc/redroid11/rootfs/vendor/bin/ipconfigstore 
 vim /var/lib/lxc/redroid11/config 

[root@archredroid ~]# lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4       IPV6                                                                            UNPRIVILEGED 
playtime  STOPPED 0         -      -          -                                                                               false        
redroid11 RUNNING 0         -      10.0.3.86  fc42:5009:ba4b:5ab0:6cde:4aa5:3abf:be86, fc42:5009:ba4b:5ab0:d3cf:882:b445:5991 false        
redroid12 RUNNING 0         -      10.0.3.216 fc42:5009:ba4b:5ab0:3798:9fa6:45a2:5f1, fc42:5009:ba4b:5ab0:dde8:1423:7dec:7b91 false        
redroid14 STOPPED 0         -      -          -                                                                               false        
[root@archredroid ~]# adb connect 10.0.3.86:5555
connected to 10.0.3.86:5555
[root@archredroid ~]# adb -s 10.0.3.86:5555 shell
redroid_x86_64:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [439648830440]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]

</code></pre>
<p>libvirt/lxc related:</p>
<pre><code># pacman -S libvirt
# systemctl enable libvirtd --now
# systemctl start libvirtd
# virsh -c lxc:/// list
 Id   Name   State
--------------------
# virsh net-autostart default
# reboot
</code></pre>
<p>Create first virsh based instance:</p>
<pre><code>[root@archredroid ~]# cat playtime.xml 
&lt;domain type='lxc'&gt;
  &lt;name&gt;playtime&lt;/name&gt;
  &lt;memory unit='KiB'&gt;6270976&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;6270976&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/lib/systemd/systemd&lt;/init&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;audit_control state='on'/&gt;
      &lt;audit_write state='on'/&gt;
      &lt;block_suspend state='on'/&gt;
      &lt;chown state='on'/&gt;
      &lt;dac_override state='on'/&gt;
      &lt;dac_read_search state='on'/&gt;
      &lt;fowner state='on'/&gt;
      &lt;fsetid state='on'/&gt;
      &lt;ipc_lock state='on'/&gt;
      &lt;ipc_owner state='on'/&gt;
      &lt;kill state='on'/&gt;
      &lt;lease state='on'/&gt;
      &lt;linux_immutable state='on'/&gt;
      &lt;mac_admin state='on'/&gt;
      &lt;mac_override state='on'/&gt;
      &lt;mknod state='on'/&gt;
      &lt;net_admin state='on'/&gt;
      &lt;net_bind_service state='on'/&gt;
      &lt;net_broadcast state='on'/&gt;
      &lt;net_raw state='on'/&gt;
      &lt;setgid state='on'/&gt;
      &lt;setfcap state='on'/&gt;
      &lt;setpcap state='on'/&gt;
      &lt;setuid state='on'/&gt;
      &lt;sys_admin state='on'/&gt;
      &lt;sys_boot state='on'/&gt;
      &lt;sys_chroot state='on'/&gt;
      &lt;sys_module state='on'/&gt;
      &lt;sys_nice state='on'/&gt;
      &lt;sys_pacct state='on'/&gt;
      &lt;sys_ptrace state='on'/&gt;
      &lt;sys_rawio state='on'/&gt;
      &lt;sys_resource state='on'/&gt;
      &lt;sys_time state='on'/&gt;
      &lt;sys_tty_config state='on'/&gt;
      &lt;syslog state='on'/&gt;
      &lt;wake_alarm state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/libvirt/libvirt_lxc&lt;/emulator&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxc/playtime/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
    &lt;interface type='network'&gt;
      &lt;mac address='52:54:00:5d:0b:a8'/&gt;
      &lt;source network='default'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='0'/&gt;
    &lt;/console&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
# virsh -c lxc:/// define playtime.xml
# virsh -c lxc:/// start playtime
# virsh -c lxc:/// console playtime
</code></pre>
<h3 id="3-rebuild-pkg-in-arch"><a class="header" href="#3-rebuild-pkg-in-arch">3. rebuild pkg in arch</a></h3>
<p>Use archlinuxcn:</p>
<pre><code># vim /etc/pacman.conf
[archlinuxcn]
Server = https://repo.archlinuxcn.org/$arch
# sudo pacman -Sy &amp;&amp; sudo pacman -S archlinuxcn-keyring yay sudo
</code></pre>
<p>Add user(for yay):</p>
<pre><code>[root@archredroid ~]# useradd -m dash
[root@archredroid ~]# passwd dash
New password: 
Retype new password:
[root@archredroid ~]# visudo
... add dash to nopasswd sudo
# su dash
$ yay asp
$ which asp
/usr/bin/asp
</code></pre>
<p>Create folder and checkout:</p>
<pre><code>$ mkdir Code &amp;&amp; cd Code
$ asp checkout libvirt

</code></pre>
<p>build steps:</p>
<pre><code>$ cd trunk
$ makepkg --clean --syncdeps  --nocheck

 libvirt-9.3.0.tar.xz ... FAILED (unknown public key CA68BE8010084C9C)
==&gt; ERROR: One or more PGP signatures could not be verified!
[dash@archredroid trunk]$ gpg --recv-keys CA68BE8010084C9C
gpg: key CA68BE8010084C9C: public key "Jiří Denemark &lt;jdenemar@redhat.com&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1
[dash@archredroid trunk]$  makepkg --clean --syncdeps 
</code></pre>
<p>make source code changes and re-compile:</p>
<pre><code> makepkg  --syncdeps  --nocheck -f
vim src/libvirt-9.3.0/src/lxc/lxc_container.c
vim src/libvirt-9.3.0/src/lxc/lxc_controller.c 
makepkg  --nocheck -ef
sudo pacman -U libvirt-1\:9.3.0-1-x86_64.pkg.tar.zst
</code></pre>
<p>Issue:</p>
<pre><code># virsh -c lxc:/// start playtime
error: Failed to start domain 'playtime'
error: Requested operation is not valid: System lacks NETNS support

</code></pre>
<h3 id="4-rebuild-libvirt"><a class="header" href="#4-rebuild-libvirt">4. rebuild libvirt</a></h3>
<p>Install devtools:</p>
<pre><code># pacman -S devtools
$ pkgctl repo clone --protocol=https libvirt
$ cd libvirt
$ makepkg --syncdeps --nocheck
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250625"><a class="header" href="#20250625">20250625</a></h1>
<h3 id="1-main-difference-on-fs"><a class="header" href="#1-main-difference-on-fs">1. main difference on fs</a></h3>
<p>Comparison on mount:</p>
<pre><code>lxc(redroid11): 
devpts on /dev/console type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
none on /dev type tmpfs (rw,relatime,size=24416k,mode=755,inode64)

libvirt_lxc(redroid11): 
devpts on /dev/pts type devpts (rw,nosuid,relatime,gid=5,mode=620,ptmxmode=666)
devfs on /dev type tmpfs (rw,nosuid,relatime,size=24416k,mode=755,inode64)

libvirt_lxc(redroid12): 
devpts on /dev/pts type devpts (rw,nosuid,relatime,gid=5,mode=620,ptmxmode=666)
devfs on /dev type tmpfs (rw,nosuid,relatime,size=24416k,mode=755,inode64)
</code></pre>
<p>Related code:</p>
<pre><code>int
virFileSetupDev(const char *path,
                const char *mount_options)
{
    const unsigned long mount_flags = MS_NOSUID;
    //const char *mount_fs = "tmpfs";
    const char *mount_fs = "none";

    if (g_mkdir_with_parents(path, 0777) &lt; 0) {
        virReportSystemError(errno,
                             _("Failed to make path %s"), path);
        return -1;
    }

    VIR_DEBUG("Mount devfs on %s type=tmpfs flags=0x%lx, opts=%s",
              path, mount_flags, mount_options);
    if (mount("devfs", path, mount_fs, mount_flags, mount_options) &lt; 0) {
        virReportSystemError(errno,
                             _("Failed to mount devfs on %s type %s (%s)"),
                             path, mount_fs, mount_options);
        return -1;
    }
</code></pre>
<p>lxc implementation:</p>
<pre><code>
ret = safe_mount("none", "dev", "tmpfs", 0, mount_options, NULL);
int safe_mount(const char *src, const char *dest, const char *fstype,
		unsigned long flags, const void *data, const char *rootfs)

</code></pre>
<h3 id="2-enable-libvirtd-log"><a class="header" href="#2-enable-libvirtd-log">2. enable libvirtd log</a></h3>
<p>Edit:</p>
<pre><code># vim /etc/libvirt/libvirtd.conf
log_level = 1
log_outputs="1:file:/var/log/libvirt/libvirtd.log"

</code></pre>
<h3 id="3-possible-modification"><a class="header" href="#3-possible-modification">3. Possible modification</a></h3>
<p>libvirt ways:</p>
<p><img src="./images/2025_06_25_17_42_19_768x841.jpg" alt="./images/2025_06_25_17_42_19_768x841.jpg" /></p>
<p>lxc ways:</p>
<p><img src="./images/2025_06_25_17_51_40_1099x697.jpg" alt="./images/2025_06_25_17_51_40_1099x697.jpg" /></p>
<h3 id="4-rebuild-lxc"><a class="header" href="#4-rebuild-lxc">4. rebuild lxc</a></h3>
<p>Steps:</p>
<pre><code>mkdir -p Code/lxc
apt-get source
apt-get install -y build-essential pbuilder
apt build-dep lxc-utils
apt-get source lxc-utils
 dpkg-source --no-check -x lxc_5.0.0~git2209-g5a7b9ce67-0ubuntu1.1.dsc 
cd /root/Code/lxc/lxc-5.0.0~git2209-g5a7b9ce67
debuild -us -uc
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250626"><a class="header" href="#20250626">20250626</a></h1>
<h3 id="1-lxc-debugging"><a class="header" href="#1-lxc-debugging">1. lxc debugging</a></h3>
<p>Start lxc instance with debugging:</p>
<pre><code>lxc-start -n redroid11 --logfile=./redroid11.log --logpriority=DEBUG
lxc-start -n redroid11 --logfile=./redroid11.log --logpriority=TRACE
</code></pre>
<h3 id="2-cgroup"><a class="header" href="#2-cgroup">2. cgroup</a></h3>
<p>Install <code>libcgroup</code> under archlinux, then use <code>lscgroup</code> to view the difference between lxc and <code>libvirt_lxc</code>.</p>
<p>virsh based:</p>
<p><img src="./images/2025_06_26_16_42_32_733x972.jpg" alt="./images/2025_06_26_16_42_32_733x972.jpg" /></p>
<p>lxc based:</p>
<p><img src="./images/2025_06_26_16_43_01_1288x806.jpg" alt="./images/2025_06_26_16_43_01_1288x806.jpg" /></p>
<p>ubuntu based:</p>
<pre><code>root@2c245635395c:/# lscgroup 
cpuset,cpu,io,memory,hugetlb,pids,rdma,misc,dmem:/
</code></pre>
<p>arch/ubuntu based(privileged):</p>
<pre><code># docker run --privileged  -it archlinux:latest /bin/bash
[root@4803b7b9d788 /]# lscgroup 
cpuset,cpu,io,memory,hugetlb,pids,rdma,misc,dmem://
</code></pre>
<h3 id="3-libcgroup"><a class="header" href="#3-libcgroup">3. libcgroup</a></h3>
<p>Install via yay:</p>
<pre><code>yay -S libcgroup --mflags "--skippgpcheck"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250627"><a class="header" href="#20250627">20250627</a></h1>
<h3 id="1-lxclibvirt-verificationubuntu2004"><a class="header" href="#1-lxclibvirt-verificationubuntu2004">1. lxc/libvirt verification(ubuntu20.04)</a></h3>
<p>Steps:</p>
<pre><code>modprobe binder_linux devices="binder,hwbinder,vndbinder"
$ uname -r
5.4.0-216-generic
</code></pre>
<p>Under the 5.4.x kernel(won't start up):</p>
<pre><code>root        6352       1  0 03:53 ?        00:00:00 /usr/libexec/libvirt_lxc --name redroid12hw --console 20 --security=none --handshakefds 28:27 --veth vnet335
root        6355    6352  0 03:53 ?        00:00:00  \_ /usr/libexec/libvirt_lxc --name redroid12hw --console 20 --security=none --handshakefds 28:27 --veth vnet335
</code></pre>
<p>Change to 5.15.0-139 via <code>apt install -y linux-image-generic-hwe-20.04</code>, could not run libvirt_lxc(official 6.0.0.).</p>
<p>Download libvirt-6 and verify:</p>
<pre><code>tar xJvf libvirt-6.6.0.tar.xz
cd  libvirt-6.6.0
mkdir build
apt install -y python3-pip libtirpc-dev
cd build
 ../configure  --with-lxc --with-interface --with-init-script=systemd  --prefix=/usr
make -j8
make install
systemctl enable libvirtd
systemctl enable --now virtqemud.socket
systemctl enable --now virtlxcd.socket
systemctl enable --now virtnetworkd
reboot
</code></pre>
<p>Change to  <code>/usr/libexec/libvirt_lxc</code>, then start the instance.</p>
<pre><code>Stuck on :   
root        5971       1  0 06:22 ?        00:00:00 /usr/libexec/libvirt_lxc --name redroid11 
</code></pre>
<p>Build 8.0.0 version:</p>
<pre><code> tar xJvf libvirt-8.0.0.tar.xz 
 cd libvirt-8.0.0

make modifications(`https://bugzilla.opensuse.org/attachment.cgi?id=863686&amp;action=diff`):    

root@cgroup:/home/test# diff libvirt-8.0.0/src/lxc/lxc_process.c 8/libvirt-8.0.0/src/lxc/lxc_process.c 
56,58d55
&lt; #include "virstring.h"
&lt; #include "vircgroupbackend.h"
&lt; #include "virsystemd.h"
1202,1206d1198
&lt; 	    virCgroupBackend **cgroupBackends = virCgroupBackendGetAll();
&lt; 	    g_autofree char *pidFile = NULL;
&lt; 	    g_autofree char *pidStr = NULL;
&lt; 	    g_auto(GStrv) pidList = NULL;
&lt; 	    pid_t checkPid = 0;
1476,1497d1467
&lt;     /* In an environment with hybrid cgroups and systemd the v2 backend is not available.
&lt; 	     * Systemd however depends on V2 for unit naming. This causes the next two checks to fail.
&lt; 	     * To work around this issue we retrieve the actual container pid and check on that instead. */
&lt; 	    if (virSystemdHasMachined() == 0 &amp;&amp; cgroupBackends[VIR_CGROUP_BACKEND_TYPE_V2]-&gt;available() == false) {
&lt; 	        pidFile = g_strdup_printf("/proc/%lld/task/%lld/children", (long long int)vm-&gt;pid, (long long int)vm-&gt;pid);
&lt; 	        if (virFileReadAll(pidFile, 1024 * 1024, &amp;pidStr) &lt; 0)
&lt; 	            goto cleanup;
&lt; 	
&lt; 	        virTrimSpaces(pidStr, NULL);
&lt; 	
&lt; 	        pidList = g_strsplit(pidStr, " ", 2);
&lt; 	        if (!pidList)
&lt; 	            goto cleanup;
&lt; 	
&lt; 	        if (virStrToLong_i(pidList[0], NULL, 10, &amp;checkPid) &lt; 0)
&lt; 	            goto cleanup;
&lt; 	
&lt; 	    } else {
&lt; 	        checkPid = vm-&gt;pid;
&lt; 	    }
&lt; 
&lt; 
1507c1477
&lt;                                   checkPid, -1, priv-&gt;machineName,
---
&gt;                                   vm-&gt;pid, -1, priv-&gt;machineName,

configure/build/make install
</code></pre>
<p>Result: redroid11 still not start OK.</p>
<p><img src="./images/2025_06_27_14_37_05_1137x728.jpg" alt="./images/2025_06_27_14_37_05_1137x728.jpg" /></p>
<p>Change the kernel options:</p>
<pre><code>systemd.unified_cgroup_hierarchy=1
update-grub2 &amp;&amp; reboot
</code></pre>
<p>Lots of defucnct in redroid11:</p>
<p><img src="./images/2025_06_27_14_42_38_927x736.jpg" alt="./images/2025_06_27_14_42_38_927x736.jpg" /></p>
<p>redroid12, also not ok:</p>
<p><img src="./images/2025_06_27_14_43_05_930x682.jpg" alt="./images/2025_06_27_14_43_05_930x682.jpg" /></p>
<p>Reverse the changes for <code>lxc_process.c</code> and rebuild, reboot.</p>
<pre><code>root@cgroup:/home/test# virsh -c lxc:/// start redroid12hw
error: Failed to start domain 'redroid12hw'
error: error from service: GDBus.Error:org.freedesktop.machine1.NoMachineForPID: PID 1360 does not belong to any known machine

</code></pre>
<p>have to adjust the cgroupfs now.</p>
<h3 id="2-xrandr-set"><a class="header" href="#2-xrandr-set">2. xrandr set</a></h3>
<p>for getting 1920x1080 resolution commands:</p>
<pre><code>  xrandr --newmode $(gtf 1920 1080 60 | grep Modeline | sed s/Modeline\ // | tr -d '"')
  xrandr --addmode VGA-1 1920x1080_60.00
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250630"><a class="header" href="#20250630">20250630</a></h1>
<h3 id="1-16virtio-gpu"><a class="header" href="#1-16virtio-gpu">1. 16virtio gpu</a></h3>
<p>configuration:</p>
<p><img src="./images/2025_06_30_09_03_57_777x591.jpg" alt="./images/2025_06_30_09_03_57_777x591.jpg" /></p>
<p><img src="./images/2025_06_30_09_04_34_507x415.jpg" alt="./images/2025_06_30_09_04_34_507x415.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250701"><a class="header" href="#20250701">20250701</a></h1>
<h3 id="1-idmap-modification"><a class="header" href="#1-idmap-modification">1. idmap modification</a></h3>
<p>Tips:</p>
<pre><code>  &lt;/os&gt;
  &lt;idmap&gt;
    &lt;uid start='0' target='100000' count='65536'/&gt;
    &lt;gid start='0' target='100000' count='65536'/&gt;
  &lt;/idmap&gt;
  &lt;features&gt;

</code></pre>
<h3 id="2-purge-apparmor"><a class="header" href="#2-purge-apparmor">2. purge apparmor</a></h3>
<p>Steps:</p>
<pre><code>apt-get -y -f purge apparmor
apt-mark -y hold apparmor
rm -rf /var/cache/apparmor
rm -rf /etc/apparmor.d
cat &gt; /etc/apt/apt.conf.d/01autoremove &lt;&lt; END
APT
{
  NeverAutoRemove
  {
        "^firmware-linux.*";
        "^linux-firmware$";
        "^linux-image-[a-z0-9]*$";
        "^linux-image-[a-z0-9]*-[a-z0-9]*$";
  };

  VersionedKernelPackages
  {
        # kernels
        "linux-.*";
        "kfreebsd-.*";
        "gnumach-.*";
        # (out-of-tree) modules
        ".*-modules";
        ".*-kernel";
  };

  Never-MarkAuto-Sections
  {
        "metapackages";
        "contrib/metapackages";
        "non-free/metapackages";
        "restricted/metapackages";
        "universe/metapackages";
        "multiverse/metapackages";
        "apparmor*";
  };

  Move-Autobit-Sections
  {
        "oldlibs";
        "contrib/oldlibs";
        "non-free/oldlibs";
        "restricted/oldlibs";
        "universe/oldlibs";
        "multiverse/oldlibs";
  };
};
END
apt-get -y update
apt-get -y autoremove
apt-get -y autoclean
</code></pre>
<h3 id="3-idmap-on-debian"><a class="header" href="#3-idmap-on-debian">3. idmap on debian</a></h3>
<p>Verification:</p>
<pre><code>$ sudo apt install -y lxc virt-manager docker.io
</code></pre>
<p>Verify redroid via:</p>
<pre><code>modprobe binder_linux devices=binder1,binder2,binder3,binder4,binder5,binder6
chmod 666 /dev/binder*
docker run -itd --privileged -v /dev/binder1:/dev/binder     -v /dev/binder2:/dev/hwbinder     -v /dev/binder3:/dev/vndbinder -p 5555:5555 --name redroid11 redroid/redroid:11.0.0-latest
docker run -itd --privileged -v /dev/binder1:/dev/binder     -v /dev/binder2:/dev/hwbinder     -v /dev/binder3:/dev/vndbinder -p 5555:5555 --name redroid12 redroid/redroid:12.0.0_64only-latest
</code></pre>
<p>both could be OK for running.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250702"><a class="header" href="#20250702">20250702</a></h1>
<h3 id="1-rebuild-redroid11"><a class="header" href="#1-rebuild-redroid11">1. rebuild redroid11</a></h3>
<p>Create build guest:</p>
<pre><code>docker load&lt;wayrdoirbuilder.tar
docker run  -v $(pwd):/mnt/lineage -it waydroid-build-24.04 /bin/bash
</code></pre>
<p>In build guest:</p>
<pre><code>cd /mnt/lineage/
repo init --depth 1 -u https://mirrors.bfsu.edu.cn/git/AOSP/platform/manifest -b android-11.0.0_r48
git clone https://github.com/remote-android/local_manifests.git .repo/local_manifests -b 11.0.0
repo sync -c
cd /root/
git clone https://github.com/remote-android/redroid-patches.git
cd -
/root/redroid-patches/apply-patch.sh /mnt/lineage/
repo forall -c "git lfs pull"
source build/envsetup.sh 
lunch redroid_x86_64-userdebug
time m -j32
</code></pre>
<p>Generate image:</p>
<pre><code>root@i9workstation:/media/sdc/redroid11/out/target/product/redroid_x86_64# ls *.img
system.img  vendor.img
root@i9workstation:/media/sdc/redroid11/out/target/product/redroid_x86_64# mount system.img system -o ro
root@i9workstation:/media/sdc/redroid11/out/target/product/redroid_x86_64# mount vendor.img vendor -o ro
root@i9workstation:/media/sdc/redroid11/out/target/product/redroid_x86_64# tar --xattrs -c vendor -C system --exclude="./vendor" . | docker import -c 'ENTRYPOINT ["/init", "androidboot.hardware=redroid"]' - redroid11
sha256:171a7f51b0b74f9d5cc1331d400cc783bbda3b2caf73509c69b139dc2e142d69

docker save -o redroid11build.tar redroid11:latest
</code></pre>
<p>tag/push to private repository:</p>
<pre><code>docker tag redroid11:latest 192.168.1.7:5000/redroid11:built
 docker push 192.168.1.7:5000/redroid11:built
apt install -y jq umoci skopeo

$  cat /etc/containers/registries.conf
[[registry]]
prefix = "192.168.1.7:5000"
location = "192.168.1.7:5000"
insecure = true

 sed -i 's/set -eu/set -u/g' /usr/share/lxc/templates/lxc-oci
 lxc-create -n redroid11built -t oci -- -u docker://192.168.1.7:5000/redroid11:built

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250703"><a class="header" href="#20250703">20250703</a></h1>
<h3 id="1-on-system-poweroffreboot"><a class="header" href="#1-on-system-poweroffreboot">1. on system poweroff/reboot</a></h3>
<ol>
<li>D-Bus 本身并没有一个标准信号名为 PrepareForReboot.</li>
<li>PrepareForShutdown 信号携带参数: 布尔值 (boolean）， true: 表示系统即将关机或重启。false: 表示关机或重启操作已经完成（取消或结束）。并未将"关机"区分于"重启"。</li>
</ol>
<p>因此，通过dbus中的PrepareForShutdown 信号（来自 org.freedesktop.login1.Manager 接口）本身无法直接区分系统是即将关机还是重启，因为它的布尔参数仅表示是否进入关机/重启流程（true）或操作取消/完成（false）.</p>
<h3 id="2-libvirt-lxc-vcpus"><a class="header" href="#2-libvirt-lxc-vcpus">2. libvirt lxc vcpus</a></h3>
<p>Configuration items:</p>
<pre><code>  &lt;vcpu placement='static' cpuset='0-3'&gt;4&lt;/vcpu&gt;
  &lt;cputune&gt;
    &lt;shares&gt;2048&lt;/shares&gt;
    &lt;period&gt;100000&lt;/period&gt;
    &lt;quota&gt;400000&lt;/quota&gt;
    &lt;vcpupin vcpu='0' cpuset='0'/&gt;
    &lt;vcpupin vcpu='1' cpuset='1'/&gt;
    &lt;vcpupin vcpu='2' cpuset='2'/&gt;
    &lt;vcpupin vcpu='3' cpuset='3'/&gt;
  &lt;/cputune&gt;
</code></pre>
<p>Changes on libvirt(guest.py):</p>
<pre><code>                # 4. read string from files
                with open('/tmp/originxml.txt', 'r') as f:
                    modified_string = f.read()
                modified_string = re.sub(r'&lt;vcpu&gt;(\d+)&lt;/vcpu&gt;', r"&lt;vcpu cpuset='0-3'&gt;\1&lt;/vcpu&gt;", modified_string)
                xml = modified_string
                guest = host.write_instance_config(xml)

</code></pre>
<p>workable xml:</p>
<pre><code>&lt;domain type='lxc'&gt;
  &lt;name&gt;playtime&lt;/name&gt;
  &lt;uuid&gt;467dab1c-1622-43c1-9147-c3ab704ce9fd&lt;/uuid&gt;
  &lt;memory unit='KiB'&gt;6270976&lt;/memory&gt;
  &lt;currentMemory unit='KiB'&gt;6270976&lt;/currentMemory&gt;
  &lt;vcpu placement='static' cpuset='0-3'&gt;4&lt;/vcpu&gt;
  &lt;cputune&gt;
    &lt;shares&gt;2048&lt;/shares&gt;
    &lt;period&gt;100000&lt;/period&gt;
    &lt;quota&gt;400000&lt;/quota&gt;
    &lt;vcpupin vcpu='0' cpuset='0'/&gt;
    &lt;vcpupin vcpu='1' cpuset='1'/&gt;
    &lt;vcpupin vcpu='2' cpuset='2'/&gt;
    &lt;vcpupin vcpu='3' cpuset='3'/&gt;
  &lt;/cputune&gt;
  &lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
  &lt;/resource&gt;
  &lt;os&gt;
    &lt;type arch='x86_64'&gt;exe&lt;/type&gt;
    &lt;init&gt;/lib/systemd/systemd&lt;/init&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;capabilities policy='allow'&gt;
      &lt;audit_control state='on'/&gt;
      &lt;audit_write state='on'/&gt;
      &lt;block_suspend state='on'/&gt;
      &lt;chown state='on'/&gt;
      &lt;dac_override state='on'/&gt;
      &lt;dac_read_search state='on'/&gt;
      &lt;fowner state='on'/&gt;
      &lt;fsetid state='on'/&gt;
      &lt;ipc_lock state='on'/&gt;
      &lt;ipc_owner state='on'/&gt;
      &lt;kill state='on'/&gt;
      &lt;lease state='on'/&gt;
      &lt;linux_immutable state='on'/&gt;
      &lt;mac_admin state='on'/&gt;
      &lt;mac_override state='on'/&gt;
      &lt;mknod state='on'/&gt;
      &lt;net_admin state='on'/&gt;
      &lt;net_bind_service state='on'/&gt;
      &lt;net_broadcast state='on'/&gt;
      &lt;net_raw state='on'/&gt;
      &lt;setgid state='on'/&gt;
      &lt;setfcap state='on'/&gt;
      &lt;setpcap state='on'/&gt;
      &lt;setuid state='on'/&gt;
      &lt;sys_admin state='on'/&gt;
      &lt;sys_boot state='on'/&gt;
      &lt;sys_chroot state='on'/&gt;
      &lt;sys_module state='on'/&gt;
      &lt;sys_nice state='on'/&gt;
      &lt;sys_pacct state='on'/&gt;
      &lt;sys_ptrace state='on'/&gt;
      &lt;sys_rawio state='on'/&gt;
      &lt;sys_resource state='on'/&gt;
      &lt;sys_time state='on'/&gt;
      &lt;sys_tty_config state='on'/&gt;
      &lt;syslog state='on'/&gt;
      &lt;wake_alarm state='on'/&gt;
    &lt;/capabilities&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/lib/libvirt/libvirt_lxc&lt;/emulator&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxcfs/proc/cpuinfo'/&gt;
      &lt;target dir='/proc/cpuinfo'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxcfs/proc/stat'/&gt;
      &lt;target dir='/proc/stat'/&gt;
    &lt;/filesystem&gt;
    &lt;filesystem type='mount' accessmode='passthrough'&gt;
      &lt;source dir='/var/lib/lxc/playtime/rootfs'/&gt;
      &lt;target dir='/'/&gt;
    &lt;/filesystem&gt;
    &lt;interface type='network'&gt;
      &lt;mac address='52:54:00:5d:0b:a8'/&gt;
      &lt;source network='default'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='lxc' port='0'/&gt;
    &lt;/console&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250704"><a class="header" href="#20250704">20250704</a></h1>
<h3 id="1-vcpu-limitation"><a class="header" href="#1-vcpu-limitation">1. vcpu limitation</a></h3>
<p>In aosp12, vcpu limitation won't take effects.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250705"><a class="header" href="#20250705">20250705</a></h1>
<h3 id="1-n100-openwrt"><a class="header" href="#1-n100-openwrt">1. N100 openwrt</a></h3>
<p>nixos configuration changes(/etc/nixos/configuration.nix):</p>
<pre><code>
### virt-manager and virtialization
   # virt-manager and virtualization
   programs.virt-manager.enable = true;
   users.groups.libvirtd.members = ["dash"];
   virtualisation.libvirtd.enable = true;
   virtualisation.spiceUSBRedirection.enable = true;

### sshd X11 forwarding
   services.openssh.enable = true;
   services.openssh.settings = {
   UseDns = false;
   X11Forwarding = true;
   };

</code></pre>
<p>Download the openwrt img file:</p>
<pre><code>qemu-img resize -f raw openwrt-24.10.2-x86-64-generic-ext4-combined-efi.img 512M
loop_device=$(losetup -f)
losetup $loop_device  openwrt-24.10.2-x86-64-generic-ext4-combined-efi.img
echo -e "OK\nFix"  /etc/profiles/per-user/dash/bin/parted ---pretend-input-tty "$loop_device" print
/etc/profiles/per-user/dash/bin/parted /dev/loop0 resizepart 2 100%
/etc/profiles/per-user/dash/bin/parted /dev/loop0 print
</code></pre>
<p>import the file as an uefi vm, then startup .</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250706"><a class="header" href="#20250706">20250706</a></h1>
<h3 id="1-n100-openwrt-1"><a class="header" href="#1-n100-openwrt-1">1. n100 openwrt</a></h3>
<p>Enable <code>intel_iommu</code>:</p>
<pre><code># cat /etc/nix/configuration.nix
......
    boot.kernelParams = [
    "quiet"
    "splash"
    "net.ifnames=0"
    "biosdevname=0"
    "ipv6.disable=1"
    "i915.force_probe=46d1"
    "intel_iommu=on"
    "intel_iommu=pt"
    #"usbcore.quirks=0bda:8153:k"
    #"drm_kms_helper.edid_firmware=edid/1920x1080.bin"
    #"video=DP-1:e"
  ];

</code></pre>
<p>Added eth0, passthrough to vm ,then in vm:</p>
<p><img src="./images/2025_07_06_09_04_56_835x594.jpg" alt="./images/2025_07_06_09_04_56_835x594.jpg" /></p>
<p>Default network configuration:</p>
<p><img src="./images/2025_07_06_09_25_21_391x356.jpg" alt="./images/2025_07_06_09_25_21_391x356.jpg" /></p>
<p>Make modifications to networking:</p>
<p><img src="./images/2025_07_06_09_29_15_414x450.jpg" alt="./images/2025_07_06_09_29_15_414x450.jpg" /></p>
<p>Apply the modifications via <code>service networking restart</code>. Then setup the passwd for root <code>passwd root</code>.</p>
<p>Enable access luci from wan:</p>
<pre><code>uci set firewall.wan_https_allow=rule
uci set firewall.wan_https_allow.name='Allow Luci from WAN'
uci set firewall.wan_https_allow.src='wan'
uci set firewall.wan_https_allow.proto='tcp'
uci set firewall.wan_https_allow.dest_port='80 443'
uci set firewall.wan_https_allow.target='ACCEPT'
uci commit firewall
/etc/init.d/firewall reload

</code></pre>
<p>Enable ssh from wan:</p>
<pre><code>uci add firewall wan_ssh_allow
uci set firewall.wan_ssh_allow=rule
uci set firewall.wan_ssh_allow.name='Allow SSH from WAN'
uci set firewall.wan_ssh_allow.src='wan'
uci set firewall.wan_ssh_allow.proto='tcp'
uci set firewall.wan_ssh_allow.dest_port='22'
uci set firewall.wan_ssh_allow.target='ACCEPT'
/etc/init.d/firewall reload
</code></pre>
<p>On nixos, do port forwarding:</p>
<pre><code>ssh -L 0.0.0.0:18880:192.168.122.2:80 root@192.168.122.2
</code></pre>
<p><img src="./images/2025_07_06_10_34_04_929x453.jpg" alt="./images/2025_07_06_10_34_04_929x453.jpg" /></p>
<p>Configuration for passwall:</p>
<p><img src="./images/2025_07_06_12_05_21_1030x580.jpg" alt="./images/2025_07_06_12_05_21_1030x580.jpg" /></p>
<p>no passwd:</p>
<p><img src="./images/2025_07_06_12_05_39_959x505.jpg" alt="./images/2025_07_06_12_05_39_959x505.jpg" /></p>
<p>Add a socks config, and check <code>Main switch</code>:</p>
<p><img src="./images/2025_07_06_12_06_12_998x872.jpg" alt="./images/2025_07_06_12_06_12_998x872.jpg" /></p>
<p>Check status:</p>
<p><img src="./images/2025_07_06_12_06_34_952x257.jpg" alt="./images/2025_07_06_12_06_34_952x257.jpg" /></p>
<p>Disable default dhcp server on this server:</p>
<p><img src="./images/2025_07_06_12_07_13_913x472.jpg" alt="./images/2025_07_06_12_07_13_913x472.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250707"><a class="header" href="#20250707">20250707</a></h1>
<h3 id="1-ibox-on-openeuler"><a class="header" href="#1-ibox-on-openeuler">1. ibox on openeuler</a></h3>
<p>Install OpenEuler 22.03.4(<code>sudo dd if=./openEuler-22.03-LTS-SP4-aarch64-dvd.iso of=/dev/sdb bs=10M &amp;&amp; sudo sync</code>):</p>
<p><img src="./images/2025_07_07_09_00_19_914x247.jpg" alt="./images/2025_07_07_09_00_19_914x247.jpg" /></p>
<p>disk layout:</p>
<p><img src="./images/2025_07_07_09_01_49_769x313.jpg" alt="./images/2025_07_07_09_01_49_769x313.jpg" /></p>
<p><img src="./images/2025_07_07_09_02_09_619x360.jpg" alt="./images/2025_07_07_09_02_09_619x360.jpg" /></p>
<p><img src="./images/2025_07_07_09_02_39_617x377.jpg" alt="./images/2025_07_07_09_02_39_617x377.jpg" /></p>
<p>Replace repository:</p>
<pre><code>sudo sed -E 's#https?://(repo|mirrors)\.openeuler\.org/#https://mirrors.ustc.edu.cn/openeuler/#g' \
         -i.bak \
         /etc/yum.repos.d/openEuler.repo$a
yum makecache
scp root@192.168.1.33:/home/xxx/2.4.zip .
yum install -y tar unzip vim net-tools pciutils
</code></pre>
<p>Kernel related:</p>
<pre><code>yum update -y
# cat /etc/selinux/config | grep disable
SELINUX=disabled
# systemctl disable --now firewalld.service
# vim /etc/yum.repos.d/docker-ce.repo
[docker-ce-stable]
name=Docker CE Stable - $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/$basearch/stable
enabled=1
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-stable-debuginfo]
name=Docker CE Stable - Debuginfo $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/debug-$basearch/stable
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-stable-source]
name=Docker CE Stable - Sources
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/source/stable
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-test]
name=Docker CE Test - $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/$basearch/test
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-test-debuginfo]
name=Docker CE Test - Debuginfo $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/debug-$basearch/test
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-test-source]
name=Docker CE Test - Sources
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/source/test
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-nightly]
name=Docker CE Nightly - $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/$basearch/nightly
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-nightly-debuginfo]
name=Docker CE Nightly - Debuginfo $basearch
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/debug-$basearch/nightly
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
 
[docker-ce-nightly-source]
name=Docker CE Nightly - Sources
baseurl=https://repo.huaweicloud.com/docker-ce/linux/centos/7/source/nightly
enabled=0
gpgcheck=1
gpgkey=https://repo.huaweicloud.com/docker-ce/linux/centos/gpg
# yum makecache
# yum install docker-ce docker-ce-cli containerd.io
# systemctl enable docker
# systemctl start docker
</code></pre>
<p>Build dkms:</p>
<pre><code>cd dkms_target
dkms add .
dkms install -m innogpu-kernel -v 2.4.4.17
reboot
</code></pre>
<p>Check the status:</p>
<pre><code>[root@euler ~]# lspci -vvnn -s 07:00.0 | grep -i Kernel
	Kernel driver in use: inno-drv
	Kernel modules: innogpu
[root@euler ~]# lspci | grep -i vga
07:00.0 VGA compatible controller: Device 1ec8:8810
</code></pre>
<p>Import docker images:</p>
<pre><code># cat inno-11-arm64-release-redroid_2.4.4.17.tar | docker import -c 'ENTRYPOINT ["/init", "qemu=1","androidboot.hardware=innogpu"]' - inno-11-arm64-release-redroid_2.4.4.17
sha256:d7008492c97f9ed42fef05c8d53ecab858e0d95eea57afae9a7d99e700784288
# docker images
REPOSITORY                               TAG       IMAGE ID       CREATED          SIZE
inno-11-arm64-release-redroid_2.4.4.17   latest    d7008492c97f   37 seconds ago   1.71GB
</code></pre>
<p>kernel rebuild:</p>
<pre><code># pahole related: 
yum install -y cmake
wget https://git.kernel.org/pub/scm/devel/pahole/pahole.git/snapshot/pahole-1.23.tar.gz
cd pahole-1.23.tar.gz 
tar xzvf pahole-1.23.tar.gz 
cd pahole-1.23
cd lib/bpf/
wget https://github.com/libbpf/libbpf/archive/refs/tags/v0.6.0.zip
unzip v0.6.0.zip 
mv libbpf-0.6.0/* .
cd ../../
mkdir build
cd build
 cmake -D__LIB=lib -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=ON ..
make install
cp /usr/lib/libdwarves* /usr/lib64/
# kernel rebuild
dnf install -y kernel-source
dnf install -y rpm-build openssl-devel bc rsync gcc gcc-c++ flex bison m4 elfutils-libelf-devel
cd /usr/src/linux-5.10.0-270.0.0.173.oe2203sp4.aarch64/
vim Makefile 
make openeuler_defconfig
make menuconfig
make binrpm-pkg -j8
ls /root/rpmbuild/RPMS/aarch64/ -l -h
# kernel output rpms
total 645M
-rw-r--r-- 1 root root 643M Jul  7 14:13 kernel-5.10.1-2.aarch64.rpm
-rw-r--r-- 1 root root 1.4M Jul  7 14:08 kernel-headers-5.10.1-2.aarch64.rpm
# Install kernel
yum install ./kernel-5.10.1-2.aarch64.rpm ./kernel-headers-5.10.1-2.aarch64.rpm
grubby --set-default /boot/vmlinuz-5.10.1 
# After reboot
[root@euler ~]# uname -a
Linux euler 5.10.1 #2 SMP Mon Jul 7 14:05:22 CST 2025 aarch64 aarch64 aarch64 GNU/Linux
[root@euler ~]# grep "ashmem" /proc/misc
 61 ashmem
</code></pre>
<p>make modifications for env:</p>
<pre><code># vim env
CONTAINER_DNS=10.0.110.2
BINDER_KO_PATH=/root/Code/2.4.4.17/drivers/binderfs/5.10/
AOSP_BINDER_KO_PATH=/root/DRIVER/drivers/aosp_binder
#ASHMEM_KO_PATH=/root/DRIVER/drivers/ashmem/5.4
INNGPU_KO_PATH=/root/Code/2.4.4.17/dkms_target/
#INNGPU_KO_PATH=/lib/modules/5.4.93/updates/dkms/
CONTAINER_DATA_PATH=`pwd`/data/
ANDROID_IMG=inno-11-arm64-release-redroid_2.4.4.17
</code></pre>
<p>Change modifications:</p>
<p><img src="./images/2025_07_07_16_51_41_483x358.jpg" alt="./images/2025_07_07_16_51_41_483x358.jpg" /></p>
<p>Make modifications to <code>/root/Code/2.4.4.17/drivers/binderfs/5.10/Makefile</code>:</p>
<p><img src="./images/2025_07_07_16_53_20_678x93.jpg" alt="./images/2025_07_07_16_53_20_678x93.jpg" /></p>
<p>Create ibox:</p>
<pre><code>./ibox.sh install
./ibox.sh start 1 2
</code></pre>
<p>Result:</p>
<p><img src="./images/2025_07_07_17_21_59_503x853.jpg" alt="./images/2025_07_07_17_21_59_503x853.jpg" /></p>
<h3 id="2-zue-on-openstack"><a class="header" href="#2-zue-on-openstack">2. zue on openstack</a></h3>
<p>Followed via <code>https://asterfusion.com/blog20240802-openstack-zun/?srsltid=AfmBOorLissgEI9JbeZp4MZJKlvECiwKRjGk8lAQvXMCPWyvOYzRUB4n</code>, but failed with many issues:</p>
<p><img src="./images/2025_07_07_16_14_48_394x518.jpg" alt="./images/2025_07_07_16_14_48_394x518.jpg" /></p>
<pre><code>docker run --net test_net -it cirros /bin/sh
docker: Error response from daemon: failed to create endpoint nifty_bell on network test_net: NetworkDriver.CreateEndpoint: 500 Internal Server Error: The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.
ERRO[0001] error waiting for container: context canceled 
</code></pre>
<p>Environment:</p>
<p><img src="./images/2025_07_07_16_15_24_529x371.jpg" alt="./images/2025_07_07_16_15_24_529x371.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250708"><a class="header" href="#20250708">20250708</a></h1>
<h3 id="1-zun-deployment"><a class="header" href="#1-zun-deployment">1. zun deployment</a></h3>
<p>Refers to <code>https://docs.openstack.org/zun/yoga/install/index.html</code>.</p>
<p>Environment:</p>
<pre><code>controller: 192.168.150.40
compute: 192.168.150.50
</code></pre>
<p>Steps:</p>
<h4 id="11-controller-node"><a class="header" href="#11-controller-node">1.1. controller node</a></h4>
<p>Create database:</p>
<pre><code>root@controller:~# mysql -uroot -p000000

MariaDB [(none)]&gt; CREATE DATABASE zun;
Query OK, 1 row affected (0.001 sec)

MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON zun.* TO 'zun'@'localhost'    IDENTIFIED BY 'ZUN_DBPASS';
Query OK, 0 rows affected (0.002 sec)

MariaDB [(none)]&gt;  GRANT ALL PRIVILEGES ON zun.* TO 'zun'@'%' IDENTIFIED BY 'ZUN_DBPASS';
Query OK, 0 rows affected (0.004 sec)

MariaDB [(none)]&gt; flush privileges;
Query OK, 0 rows affected (0.001 sec)

MariaDB [(none)]&gt; quit
Bye
</code></pre>
<p>Create service credentials:</p>
<pre><code>root@controller:~# source /etc/keystone/admin-openrc.sh 
Use the ZUN_PASS for zun password:     

root@controller:~# openstack user create --domain default --password-prompt zun
User Password:
Repeat User Password:
The passwords entered were not the same
User Password:
Repeat User Password:
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | 44c0ef70f7494ba5a815329808e89c9f |
| name                | zun                              |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+

root@controller:~# openstack role add --project service --user zun admin

root@controller:~# openstack service create --name zun \
    --description "Container Service" container
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | Container Service                |
| enabled     | True                             |
| id          | ad371d11f0a644749e0b1b56dafcd1ce |
| name        | zun                              |
| type        | container                        |
+-------------+----------------------------------+

root@controller:~# openstack endpoint create --region RegionOne \
    container public http://controller:9517/v1
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 5f92a9204199471f8511b95d3af1da3f |
| interface    | public                           |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | ad371d11f0a644749e0b1b56dafcd1ce |
| service_name | zun                              |
| service_type | container                        |
| url          | http://controller:9517/v1        |
+--------------+----------------------------------+

root@controller:~# openstack endpoint create --region RegionOne \
    container internal http://controller:9517/v1
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 29b80c098bcb44029315b800db59d3c3 |
| interface    | internal                         |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | ad371d11f0a644749e0b1b56dafcd1ce |
| service_name | zun                              |
| service_type | container                        |
| url          | http://controller:9517/v1        |
+--------------+----------------------------------+

root@controller:~# openstack endpoint create --region RegionOne \
    container admin http://controller:9517/v1
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | fd46d4cfc9ff4a8f89b89271e3b5b612 |
| interface    | admin                            |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | ad371d11f0a644749e0b1b56dafcd1ce |
| service_name | zun                              |
| service_type | container                        |
| url          | http://controller:9517/v1        |
+--------------+----------------------------------+
</code></pre>
<p>install/configure components:</p>
<pre><code>root@controller:~# groupadd --system zun
root@controller:~# useradd --home-dir "/var/lib/zun" \
      --create-home \
      --system \
      --shell /bin/false \
      -g zun \
      zun
root@controller:~# mkdir -p /etc/zun
root@controller:~#  chown zun:zun /etc/zun
# apt-get install python3-pip git python-is-python3
# cd /var/lib/zun
# git clone https://opendev.org/openstack/zun.git
# chown -R zun:zun zun
# cd zun
#	git config --global --add safe.directory /var/lib/zun/zun
# git checkout tags/yoga-eol -b yoga
# pip3 install -r requirements.txt
# export PBR_VERSION=1.2.3 
#  python setup.py sdist
# python3 setup.py install
</code></pre>
<p>Create sample configuration file:</p>
<pre><code>root@controller:/var/lib/zun/zun# su -s /bin/sh -c "oslo-config-generator \
    --config-file etc/zun/zun-config-generator.conf" zun
root@controller:/var/lib/zun/zun# su -s /bin/sh -c "cp etc/zun/zun.conf.sample \
    /etc/zun/zun.conf" zun
root@controller:/var/lib/zun/zun# su -s /bin/sh -c "cp etc/zun/api-paste.ini /etc/zun" zun
root@controller:/var/lib/zun/zun# vim /etc/zun/zun.conf 
</code></pre>
<p>The <code>zun.conf</code> listed as:</p>
<pre><code>[DEFAULT]
transport_url = rabbit://openstack:openstackhuhy@controller

[api]
host_ip = 192.168.150.40
port = 9517


[database]
connection = mysql+pymysql://zun:ZUN_DBPASS@controller/zun

[keystone_auth]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = ZUN_PASS
username = zun
auth_url = http://controller:5000
auth_type = password
auth_version = v3
auth_protocol = http
service_token_roles_required = True
endpoint_type = internalURL

[keystone_authtoken]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = ZUN_PASS
username = zun
auth_url = http://controller:5000
auth_type = password
auth_version = v3
auth_protocol = http
service_token_roles_required = True
endpoint_type = internalURL

[oslo_concurrency]
lock_path = /var/lib/zun/tmp

[oslo_messaging_notifications]
driver = messaging

[websocket_proxy]
wsproxy_host = 192.168.150.40
wsproxy_port = 6784
base_url = ws://controller:6784/
</code></pre>
<pre><code>root@controller:/var/lib/zun/zun# cp -r /var/lib/zun/zun/zun/db/sqlalchemy/alembic /usr/local/lib/python3.10/dist-packages/zun/db/sqlalchemy/
root@controller:/var/lib/zun/zun# cp /var/lib/zun/zun/zun/db/sqlalchemy/alembic.ini /usr/local/lib/python3.10/dist-packages/zun/db/sqlalchemy/

# su -s /bin/sh -c "zun-db-manage upgrade" zun
</code></pre>
<p>Service:</p>
<pre><code>root@controller:/var/lib/zun/zun# cat /etc/systemd/system/zun-api.service
[Unit]
Description = OpenStack Container Service API

[Service]
ExecStart = /usr/local/bin/zun-api
User = zun

[Install]
WantedBy = multi-user.target
root@controller:/var/lib/zun/zun# cat /etc/systemd/system/zun-wsproxy.service
[Unit]
Description = OpenStack Container Service Websocket Proxy

[Service]
ExecStart = /usr/local/bin/zun-wsproxy
User = zun

[Install]
WantedBy = multi-user.target
</code></pre>
<p>Enable and start service then verify:</p>
<pre><code>systemctl enable zun-api --now
systemctl enable zun-wsproxy --now
systemctl status zun-api
systemctl status zun-wsproxy
</code></pre>
<p>Configure etcd:</p>
<pre><code>apt install -y etcd
vim /etc/default/etcd

ETCD_NAME="controller"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-01"
ETCD_INITIAL_CLUSTER="controller=http://192.168.150.40:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.150.40:2380"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.150.40:2379"
ETCD_LISTEN_PEER_URLS="http://192.168.150.40:2380"
ETCD_LISTEN_CLIENT_URLS="http://192.168.150.40:2379"

systemctl restart etcd
</code></pre>
<h4 id="12-compute-node"><a class="header" href="#12-compute-node">1.2 compute node</a></h4>
<p>Steps:</p>
<pre><code> groupadd --system zun
 useradd --home-dir "/var/lib/zun"       --create-home       --system       --shell /bin/false       -g zun       zun
 mkdir -p /etc/zun
 chown zun:zun /etc/zun
 mkdir -p /etc/cni/net.d
 chown zun:zun /etc/cni/net.d
 cd /var/lib/zun
 git clone https://opendev.org/openstack/zun.git
 cd zun/
git checkout tags/yoga-eol -b yoga
 pip3 install -r requirements.txt
 python3 setup.py install
 export PBR_VERSION=1.2.3
 apt install -y python-is-python3 python3-pip
 python setup.py sdist
 python3 setup.py install
cd ..
chown -R zun:zun zun
cd zun
</code></pre>
<p>Generate a sample configuration file:</p>
<pre><code># su -s /bin/sh -c "oslo-config-generator \
    --config-file etc/zun/zun-config-generator.conf" zun
# su -s /bin/sh -c "cp etc/zun/zun.conf.sample \
    /etc/zun/zun.conf" zun
# su -s /bin/sh -c "cp etc/zun/rootwrap.conf \
    /etc/zun/rootwrap.conf" zun
# su -s /bin/sh -c "mkdir -p /etc/zun/rootwrap.d" zun
# su -s /bin/sh -c "cp etc/zun/rootwrap.d/* \
    /etc/zun/rootwrap.d/" zun
# su -s /bin/sh -c "cp etc/cni/net.d/* /etc/cni/net.d/" zun
</code></pre>
<p>sudoers for zun:</p>
<pre><code>echo "zun ALL=(root) NOPASSWD: /usr/local/bin/zun-rootwrap \
    /etc/zun/rootwrap.conf *" | sudo tee /etc/sudoers.d/zun-rootwrap
</code></pre>
<p>Edit /etc/zun/zun.conf:</p>
<pre><code>[DEFAULT]
transport_url = rabbit://openstack:openstackhuhy@controller
state_path = /var/lib/zun

[compute]
host_shared_with_nova = true

[database]
connection = mysql+pymysql://zun:ZUN_DBPASS@controller/zun

[keystone_auth]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = ZUN_PASS
username = zun
auth_url = http://controller:5000
auth_type = password
auth_version = v3
auth_protocol = http
service_token_roles_required = True
endpoint_type = internalURL

[keystone_authtoken]
memcached_servers = controller:11211
www_authenticate_uri= http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = ZUN_PASS
username = zun
auth_url = http://controller:5000
auth_type = password

[oslo_concurrency]
lock_path = /var/lib/zun/tmp
</code></pre>
<p>Docker related:</p>
<pre><code># apt install docker.io=20.10.12-0ubuntu4
# mkdir -p /etc/systemd/system/docker.service.d/
# vim /etc/systemd/system/docker.service.d/docker.conf

[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --group zun -H tcp://192.168.150.50:2375 -H unix:///var/run/docker.sock --cluster-store etcd://controller:2379

# systemctl daemon-reload
# systemctl restart docker
</code></pre>
<h4 id="13-kuryr-for-controller"><a class="header" href="#13-kuryr-for-controller">1.3 kuryr for controller</a></h4>
<p>Use <code>KURYR_PASSWORD</code> for password:</p>
<pre><code> source /etc/keystone/admin-openrc.sh 
 openstack user create --domain default --password-prompt kuryr
openstack role add --project service --user kuryr admin
</code></pre>
<h4 id="14-kuryr-for-compute"><a class="header" href="#14-kuryr-for-compute">1.4 kuryr for compute</a></h4>
<p>Deployment material is written for ubuntu16.04, won't startup on ubuntu22.04. Switching to kolla-ansible deployment.</p>
<h3 id="2-kolla-ansibleubuntu2204"><a class="header" href="#2-kolla-ansibleubuntu2204">2. kolla-ansible(ubuntu22.04)</a></h3>
<p>refers:<br />
<code>https://developer.aliyun.com/article/1572592?spm=5176.26934562.main.2.32e173ccAn8r6C</code><br />
<code>https://blog.plz.ac/posts/openstack-kolla-deploy/</code><br />
node infos:</p>
<pre><code>openstack1  eth0: 192.168.150.61
openstack2  eth0: 192.168.150.62
openstack3  eth0: 192.168.150.63
All of the eth1 leave blank.  
</code></pre>
<p>All of the nodes:</p>
<pre><code>sudo vim /etc/hosts
...
192.168.150.61  openstack1
192.168.150.62  openstack2
192.168.150.63  openstack3
sudo ufw disable
sudo apt remove apparmor --purge
sudo rm -f /etc/resolv.conf
sudo su
echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf
apt update -y
apt install -y git python3-dev libffi-dev build-essential libssl-dev
apt install python3-venv python3-pip -y
apt install -y dnscrypt-proxy
echo "nameserver 127.0.2.1"&gt;/etc/resolv.conf
chattr +i /etc/resolv.conf

</code></pre>
<p>Add vdb to each node:</p>
<pre><code>qemu-img create -f qcow2 /media/sda/images/vdb100G.qcow2 100G
qemu-img create -f qcow2 /media/sdb/images/vdb100G.qcow2 100G
qemu-img create -f qcow2 /media/sdc/images/vdb100G.qcow2 100G

In each guest:
pvcreate /dev/vdb
vgcreate cinder-volumes /dev/vdb
</code></pre>
<p>in openstack1, install kolla-ansible:</p>
<pre><code>root@openstack1:~# python3 -m venv .venv/kolla
root@openstack1:~# source ~/.venv/kolla/bin/activate
(kolla) root@openstack1:~# pip3 install -U pip
(kolla) root@openstack1:~#  pip3 install 'ansible-core&gt;=2.15,&lt;2.16.99'
(kolla) root@openstack1:~# pip3 install git+https://opendev.org/openstack/kolla-ansible@stable/2024.1
(kolla) root@openstack1:~# kolla-ansible install-deps

git clone https://github.com/openstack/kolla-ansible.git
cd kolla-ansible
git checkout stable/2024.1
</code></pre>
<p>Generate configuration files:</p>
<pre><code>(kolla) root@openstack1:~/kolla-ansible# mkdir /etc/kolla
(kolla) root@openstack1:~/kolla-ansible# cd 
(kolla) root@openstack1:~# cp kolla-ansible/etc/kolla/* /etc/kolla/
(kolla) root@openstack1:~# cp kolla-ansible/ansible/inventory/multinode /etc/kolla/

vim /etc/kolla/multinode
[control]
openstack1
openstack2
openstack3
[network]
openstack1
openstack2
openstack3
[compute]
openstack1
openstack2
openstack3
[monitoring]
openstack1
[storage]
openstack1
openstack2
openstack3
</code></pre>
<p>Change globals.yml:</p>
<pre><code># vim /etc/kolla/globals.yml
</code></pre>
<p>Fill the password files:</p>
<pre><code> kolla-genpwd
</code></pre>
<p>Install all of the nodes python deps:</p>
<pre><code>(kolla) root@openstack1:~# pip3 freeze&gt;requirements.txt
comment all of the ansible items
scp to other 2 nodes
</code></pre>
<p>Install pip deps:</p>
<pre><code>(kolla) [root@openstack1 ~]# deactivate 
# pip3 install -r /tmp/requirements.txt
root@openstack2:/home/test# pip3 install -r /home/test/requirements.txt 
root@openstack3:/home/test# pip3 install -r /home/test/requirements.txt 
</code></pre>
<p>copy ssh identifier files to <code>openstack1-3</code>,</p>
<pre><code>kolla-ansible bootstrap-servers -i ./multinode
kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false

</code></pre>
<p><img src="./images/2025_07_08_17_45_11_1144x337.jpg" alt="./images/2025_07_08_17_45_11_1144x337.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250709"><a class="header" href="#20250709">20250709</a></h1>
<h3 id="1-kolla20241"><a class="header" href="#1-kolla20241">1. kolla(2024.1)</a></h3>
<p>Deployment for kolla(zun disabled), succeed:</p>
<pre><code>vim /etc/kolla//globals.yml
    enable_zun: "no"
kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false
kolla-ansible pull -i ./multinode 
kolla-ansible deploy -i ./multinode 
kolla-ansible post-deploy -i ./multinode 
cat /etc/kolla/admin-openrc.sh 
pip3 install python-openstackclient
pip3 install python-zunclient
###. kolla-ansible/tools/init-runonce 

</code></pre>
<p>Deployment for kolla(zun enabled):</p>
<p>Succeed.</p>
<p>Create network:</p>
<p><img src="./images/2025_07_09_10_16_52_712x810.jpg" alt="./images/2025_07_09_10_16_52_712x810.jpg" /></p>
<p><img src="./images/2025_07_09_10_18_44_721x574.jpg" alt="./images/2025_07_09_10_18_44_721x574.jpg" /></p>
<p><img src="./images/2025_07_09_10_19_16_550x575.jpg" alt="./images/2025_07_09_10_19_16_550x575.jpg" /></p>
<p>NOT OK via webpage.</p>
<p>commands for creating network:</p>
<pre><code> openstack router create Ext-Router
 openstack network create --internal --provider-network-type vxlan int-net
 openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
 openstack router add subnet Ext-Router int-net-sub
 openstack network create --provider-physical-network physnet1 --provider-network-type flat  --external ext-net
 openstack subnet create ext-net-sub --network ext-net --subnet-range 192.168.150.40/24  --allocation-pool start=192.168.150.100,end=192.168.150.200 --gateway 192.168.150.1 --dns-nameserver 114.114.114.114 --dhcp
 openstack router set Ext-Router --external-gateway ext-net

</code></pre>
<h3 id="2-run-redroid-under-zun"><a class="header" href="#2-run-redroid-under-zun">2. run redroid under zun</a></h3>
<p>Command:</p>
<pre><code>docker run -itd --privileged --name redroid12 -v ~/data:/data     -p 5555:5555      redroid12houdini:latest
</code></pre>
<p>openstack appcontainer:</p>
<pre><code>openstack appcontainer run --privileged --name mm --image-pull-policy=never --net network=bb819c23-cdfc-43b4-8de9-928332045211  --cpu 4 --memory 8192  redroid12houdini:latest
</code></pre>
<p>???</p>
<h3 id="3-kolla-ansible-testing"><a class="header" href="#3-kolla-ansible-testing">3. kolla ansible testing</a></h3>
<p>Testing:</p>
<pre><code>cp /media/sda/images/kolla_ansible1.qcow2.beforezun /media/sda/images/kolla_ansible1.qcow2 &amp;&amp; cp /media/sdb/images/kolla_ansible2.qcow2.beforezun /media/sdb/images/kolla_ansible2.qcow2 &amp;&amp; cp /media/sdc/images/kolla_ansible3.qcow2.beforezun /media/sdc/images/kolla_ansible3.qcow2 &amp;&amp; virsh start kolla_ansible1 &amp;&amp; virsh start kolla_ansible2 &amp;&amp; virsh start kolla_ansible3
</code></pre>
<p>After pull image, then :</p>
<pre><code>cp /media/sda/images/kolla_ansible1.qcow2 /media/sda/images/kolla_ansible1.qcow2.pullimage &amp;&amp; cp /media/sdb/images/kolla_ansible2.qcow2 /media/sdb/images/kolla_ansible2.qcow2.pullimage  &amp;&amp; cp /media/sdc/images/kolla_ansible3.qcow2 /media/sdc/images/kolla_ansible3.qcow2.pullimage &amp;&amp; virsh start kolla_ansible1 &amp;&amp; virsh start kolla_ansible2 &amp;&amp; virsh start kolla_ansible3
</code></pre>
<p>Redeploy:</p>
<pre><code>cp /media/sda/images/kolla_ansible1.qcow2.pullimage /media/sda/images/kolla_ansible1.qcow2 &amp;&amp; virsh start kolla_ansible1
cp /media/sdb/images/kolla_ansible2.qcow2.pullimage /media/sdb/images/kolla_ansible2.qcow2 &amp;&amp; virsh start kolla_ansible2
cp /media/sdc/images/kolla_ansible3.qcow2.pullimage /media/sdc/images/kolla_ansible3.qcow2 &amp;&amp; virsh start kolla_ansible3
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250710"><a class="header" href="#20250710">20250710</a></h1>
<h3 id="1-zun-privileged"><a class="header" href="#1-zun-privileged">1. zun privileged</a></h3>
<p><code>policy.json</code> is fetched from <code>https://opendev.org/openstack/zun/src/commit/83d525c42541774cc07cf31f551551af34370993/etc/zun/policy.json</code>, added <code>"container:create:privileged": "rule:admin_or_user",</code>.</p>
<pre><code>{
    "context_is_admin":  "role:admin",
    "admin_or_owner":  "is_admin:True or project_id:%(project_id)s",
    "default": "rule:admin_or_owner",
    "admin_api": "rule:context_is_admin",
    "admin_or_user": "is_admin:True or user_id:%(user_id)s",

    "container:create": "rule:default",
+++    "container:create:privileged": "rule:admin_or_user",
    "container:delete": "rule:admin_or_user",
    "container:get": "rule:default",
    "container:get_all": "rule:default",
    "container:update": "rule:admin_or_user",
    "container:start": "rule:admin_or_user",
    "container:stop": "rule:admin_or_user",
    "container:reboot": "rule:admin_or_user",
    "container:pause": "rule:admin_or_user",
    "container:unpause": "rule:admin_or_user",
    "container:logs": "rule:admin_or_user",
    "container:execute": "rule:admin_or_user",
    "container:execute_resize": "rule:admin_or_user",
    "container:kill": "rule:admin_or_user",
    "container:update": "rule:admin_or_user",
    "container:rename": "rule:admin_or_user",
    "container:attach": "rule:admin_or_user",
    "container:resize": "rule:admin_or_user",
    "container:top": "rule:admin_or_user",
    "container:get_archive": "rule:admin_or_user",
    "container:put_archive": "rule:admin_or_user",
    "container:stats": "rule:admin_or_user",
    "container:commit": "rule:admin_or_user",
    "image:pull": "rule:default",
    "image:get_all": "rule:default",
    "image:search": "rule:default",


    "zun-service:delete": "rule:admin_api",
    "zun-service:disable": "rule:admin_api",
    "zun-service:enable": "rule:admin_api",
    "zun-service:get_all": "rule:admin_api"
}
</code></pre>
<p>Controller node:</p>
<pre><code># docker ps | grep zun
02e8cb126ffa   quay.nju.edu.cn/openstack.kolla/zun-wsproxy:2024.1-ubuntu-jammy                 "dumb-init --single-…"   3 hours ago   Up 27 minutes (healthy)             zun_wsproxy
12c14cefb9bb   quay.nju.edu.cn/openstack.kolla/zun-api:2024.1-ubuntu-jammy                     "dumb-init --single-…"   3 hours ago   Up 28 minutes (healthy)             zun_api
# docker cp policy.json zun_api:/etc/zun/
# docker cp policy.json zun_wsproxy:/etc/zun/
#  ls /etc/kolla/ | grep zun
zun-api
zun-wsproxy
# vim /etc/kolla/zun-api/zun.conf
# vim /etc/kolla/zun-wsproxy/zun.conf
Added:    
[oslo_policy]
policy_file = /etc/zun/policy.json
# docker restart zun_api &amp;&amp; docker restart zun_wxproxy
</code></pre>
<p>Compute node:</p>
<pre><code># docker ps | grep zun
804fa4b38e9b   quay.nju.edu.cn/openstack.kolla/zun-cni-daemon:2024.1-ubuntu-jammy              "dumb-init --single-…"   3 hours ago   Up 27 minutes (healthy)             zun_cni_daemon
9a43a16a3c98   quay.nju.edu.cn/openstack.kolla/zun-compute:2024.1-ubuntu-jammy                 "dumb-init --single-…"   3 hours ago   Up 27 minutes (healthy)             zun_compute
# docker cp policy.json zun_cni_daemon:/etc/zun/
# docker cp policy.json zun_compute:/etc/zun/
# ls /etc/kolla/ | grep zun
zun-cni-daemon
zun-compute
# vim /etc/kolla/zun-cni-daemon/zun.conf
# vim /etc/kolla/zun-wcompute/zun.conf
Added:    
[oslo_policy]
policy_file = /etc/zun/policy.json
# docker restart zun_compute &amp;&amp; docker restart zun_cni_daemon
</code></pre>
<p>Create privileged docker instance:</p>
<pre><code># openstack network list
+--------------------------------------+---------+--------------------------------------+
| ID                                   | Name    | Subnets                              |
+--------------------------------------+---------+--------------------------------------+
| aa723767-ec93-4963-a3e0-3f1e6b028b1c | int-net | 6cac1cc1-644e-467c-9232-bafe1f035e54 |
| c58aec55-4e70-47e9-8222-89aed074217b | ext-net | 9506046d-ad61-441a-a63b-66b57d6e8143 |
+--------------------------------------+---------+--------------------------------------+
# openstack appcontainer run --privileged --name mm --image-pull-policy=never --net network=aa723767-ec93-4963-a3e0-3f1e6b028b1c --cpu 4 --memory 8192  xxxxx
</code></pre>
<p><img src="./images/2025_07_10_10_54_55_1187x771.jpg" alt="./images/2025_07_10_10_54_55_1187x771.jpg" /></p>
<p>aosp instance:</p>
<p><img src="./images/2025_07_10_10_58_48_943x333.jpg" alt="./images/2025_07_10_10_58_48_943x333.jpg" /></p>
<p>Specify the host and init parameters:</p>
<pre><code>openstack appcontainer run --privileged --name mmk --image-pull-policy=never --net network=1cd5bde1-6151-4ea6-9429-b74f7b467f99 --cpu 4 --memory 8192 --host openstack3 redroid12houdini:latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480
</code></pre>
<h3 id="2-change-machine-id"><a class="header" href="#2-change-machine-id">2. change machine id</a></h3>
<p>via:</p>
<pre><code>sudo rm -f /etc/machine-id
sudo dbus-uuidgen --ensure=/etc/machine-id
sudo rm /var/lib/dbus/machine-id
sudo dbus-uuidgen --ensure
sudo reboot
</code></pre>
<h3 id="3-virgl-kolla-node"><a class="header" href="#3-virgl-kolla-node">3. virgl kolla node</a></h3>
<p>Specify user session:</p>
<p><img src="./images/2025_07_10_14_20_52_302x139.jpg" alt="./images/2025_07_10_14_20_52_302x139.jpg" /></p>
<p><img src="./images/2025_07_10_14_21_01_614x202.jpg" alt="./images/2025_07_10_14_21_01_614x202.jpg" /></p>
<p><img src="./images/2025_07_10_14_22_11_680x407.jpg" alt="./images/2025_07_10_14_22_11_680x407.jpg" /></p>
<p>So it won't be attached to virbr1(192.168.150.2/24) network.</p>
<p>Changed to:</p>
<p><img src="./images/2025_07_10_14_23_23_624x529.jpg" alt="./images/2025_07_10_14_23_23_624x529.jpg" /></p>
<p>or :</p>
<p><img src="./images/2025_07_10_14_23_40_344x143.jpg" alt="./images/2025_07_10_14_23_40_344x143.jpg" /></p>
<p>Won't use nvidia card.</p>
<pre><code>test@openstack3:~$ sudo dmesg | grep -i virgl
[    1.280751] [drm] features: +virgl +edid -resource_blob -host_visible
</code></pre>
<p>houdini workable:</p>
<pre><code># openstack appcontainer run --privileged --name mmk --image-pull-policy=never --net network=1cd5bde1-6151-4ea6-9429-b74f7b467f99 --cpu 4 --memory 8192 --host openstack3 redroidhoudini12:latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=host androidboot.redroid_gpu_node=/dev/dri/renderD128  androidboot.redroid_fps=120
# openstack appcontainer list
+--------------------------------------+---------------+-------------------------+----------+--------------------+-----------------+-------+
| uuid                                 | name          | image                   | status   | task_state         | addresses       | ports |
+--------------------------------------+---------------+-------------------------+----------+--------------------+-----------------+-------+
| a54f636e-0113-42b8-88b8-433f2ed0b386 | mmk           | redroidhoudini12:latest | Deleting | container_deleting | 192.168.150.150 | []    |
| ffeaa2d0-1d07-4c1c-8746-5bf14e1fbf6a | redroid120fps | redroidhoudini12:latest | Running  | None               | 192.168.150.127 | []    |
+--------------------------------------+---------------+-------------------------+----------+--------------------+-----------------+-------+
</code></pre>
<p><img src="./images/2025_07_10_15_22_58_519x864.jpg" alt="./images/2025_07_10_15_22_58_519x864.jpg" /></p>
<p><img src="./images/2025_07_10_15_23_10_514x395.jpg" alt="./images/2025_07_10_15_23_10_514x395.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250711"><a class="header" href="#20250711">20250711</a></h1>
<h3 id="1-zun-cpu-limitation"><a class="header" href="#1-zun-cpu-limitation">1. zun cpu limitation</a></h3>
<p>Create a docker instance via zun:</p>
<pre><code>openstack appcontainer run --privileged --name ubuntustress --net network=1cd5bde1-6151-4ea6-9429-b74f7b467f99 --cpu 1 --memory 1024 --host openstack3 ubuntu:latest sleep 36000
</code></pre>
<p>On host(<code>openstack3</code>), inspect the docker instance:</p>
<pre><code># docker inspect 7ba1489669f7
......
            "CpuShares": 1024,
            "Memory": 1073741824,
            "NanoCpus": 0,
            "CgroupParent": "",
......
</code></pre>
<p>Line 309-310 means <code>--cpu 1</code> --&gt; 1024(CpuShares):</p>
<p><img src="./images/2025_07_11_10_30_33_807x288.jpg" alt="./images/2025_07_11_10_30_33_807x288.jpg" /></p>
<p><code>stress -c 8</code> in docker instance will result <code>8*100%</code> in top.</p>
<p>Solution(manually binding cpu core):</p>
<pre><code>$ sudo docker info --format '{{.CgroupDriver}}'
systemd
$ sudo su
# cd /sys/fs/cgroup/system.slice
# echo "0-1" &gt; docker-7ba1489669f71014023acc44afff8f6a1f60830b9c18398e2150c4e80a6c3e42.scope/cpuset.cpus
</code></pre>
<p>Stress 8:</p>
<p><img src="./images/2025_07_11_10_34_14_770x344.jpg" alt="./images/2025_07_11_10_34_14_770x344.jpg" /></p>
<p>Stress 2:</p>
<p><img src="./images/2025_07_11_10_34_44_784x296.jpg" alt="./images/2025_07_11_10_34_44_784x296.jpg" /></p>
<p>run stress command:</p>
<p><img src="./images/2025_07_11_10_34_58_655x177.jpg" alt="./images/2025_07_11_10_34_58_655x177.jpg" /></p>
<p>Possible modification, update the client for sending more parametes to zun:</p>
<p><code>https://github.com/openstack/python-zunclient</code></p>
<h3 id="2-kollaqueen"><a class="header" href="#2-kollaqueen">2. kolla(Queen)</a></h3>
<p>centos7, use source related.</p>
<p>docker-ce related:</p>
<pre><code>yum install -y net-tools wget
wget -P /etc/yum.repos.d/ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache
yum list available docker-ce --showduplicates
yum list available docker-ce-cli --showduplicates
yum list available containerd.io --showduplicates
yum install docker-ce-19.03.0-3.el7 docker-ce-cli-19.03.0-3.el7 containerd.io-1.5.10-3.1.el7
</code></pre>
<p>each node for adding hostname:</p>
<pre><code># cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.150.71  queen1
192.168.150.72  queen2
192.168.150.73  queen3
# ssh root@queen1
then exit
# ssh root@queen2
then exit
# ssh root@queen2
then exit
</code></pre>
<p>each node install pip:</p>
<pre><code>yum install -y epel-release
yum install -y python-pip
pip install --upgrade pip==20.0
yum install python-devel libffi-devel gcc openssl-devel libselinux-python -y

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250712"><a class="header" href="#20250712">20250712</a></h1>
<h3 id="1-kolla-queencontinued"><a class="header" href="#1-kolla-queencontinued">1. kolla queen(continued)</a></h3>
<p>ansible and kolla-ansible related:</p>
<pre><code>curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
python2.7 get-pip.py 
pip install ansible==2.9.0
yum install -y ansible
 git clone https://github.com/openstack/kolla-ansible
cd kolla-ansible/
 git checkout tags/queens-eol -b queen
pip install pbr
pip install .   

Error message:    
ERROR: pip's legacy dependency resolver does not consider dependency conflicts when selecting packages. This behaviour is the source of the following dependency conflicts.
oslo-config 7.0.0 requires PyYAML&gt;=3.12, but you'll have pyyaml 3.10 which is incompatible.

</code></pre>
<p>docker related operation:</p>
<pre><code> mkdir -p /etc/systemd/system/docker.service.d
vim /etc/systemd/system/docker.service.d/kolla.conf
systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl status docker
docker load&lt;node_combine.tar 
</code></pre>
<h3 id="2-kolla-queenubuntu1804"><a class="header" href="#2-kolla-queenubuntu1804">2. kolla queen(ubuntu1804)</a></h3>
<p>Steps:</p>
<pre><code> apt install -y python-pip
 pip install virtualenv
 mkdir ~/kolla
 virtualenv ~/kolla/virtualenv
 source ~/kolla/virtualenv/bin/activate
 apt-get install python-dev libffi-dev gcc libssl-dev python-selinux python-setuptools
 apt-cache policy ansible ---&gt; should be 2.5
 apt install ansible
 pvcreate /dev/vdb
 vgcreate cinder-volumes /dev/vdb
</code></pre>
<p>Clone kolla-ansible source code:</p>
<pre><code>git clone https://github.com/openstack/kolla-ansible
cd kolla-ansible/
git checkout tags/queens-eol -b queen
pip install -r requirements.txt 

### Install kolla-ansible
pip install .
(virtualenv) root@ubuntu1:~/kolla-ansible# which kolla-ansible
/root/kolla/virtualenv/bin/kolla-ansible
</code></pre>
<p>Create deployment config folder:</p>
<pre><code>mkdir -p /etc/kolla
cp etc/kolla/* /etc/kolla/

</code></pre>
<h3 id="3-kolla-queen-issue"><a class="header" href="#3-kolla-queen-issue">3. kolla queen issue</a></h3>
<p>both centos/ubuntu got same issue:</p>
<pre><code>root@ubuntu1:~# openstack appcontainer list
+--------------------------------------+---------+---------------+--------+------------+-----------+-------+
| uuid                                 | name    | image         | status | task_state | addresses | ports |
+--------------------------------------+---------+---------------+--------+------------+-----------+-------+
| f8ef809a-9f27-4e07-a42c-91c7b39ca80e | ubuntu1 | ubuntu:latest | Error  | None       |           | []    |
+--------------------------------------+---------+---------------+--------+------------+-----------+-------+
root@ubuntu1:~# openstack appcontainer show ubuntu1
+-------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field             | Value                                                                                                                                                                                                                           |
+-------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| addresses         |                                                                                                                                                                                                                                 |
| links             | [{u'href': u'http://192.168.150.152:9517/v1/containers/f8ef809a-9f27-4e07-a42c-91c7b39ca80e', u'rel': u'self'}, {u'href': u'http://192.168.150.152:9517/containers/f8ef809a-9f27-4e07-a42c-91c7b39ca80e', u'rel': u'bookmark'}] |
| image             | ubuntu:latest                                                                                                                                                                                                                   |
| labels            | {}                                                                                                                                                                                                                              |
| disk              | 0                                                                                                                                                                                                                               |
| networks          |                                                                                                                                                                                                                                 |
| security_groups   | []                                                                                                                                                                                                                              |
| image_pull_policy | None                                                                                                                                                                                                                            |
| user_id           | e1d7fa33232840ddb62861291a5e25bf                                                                                                                                                                                                |
| uuid              | f8ef809a-9f27-4e07-a42c-91c7b39ca80e                                                                                                                                                                                            |
| hostname          | None                                                                                                                                                                                                                            |
| environment       | {}                                                                                                                                                                                                                              |
| memory            | 1024M                                                                                                                                                                                                                           |
| project_id        | 6896b4eaaef746438c953cc6c0e58f8e                                                                                                                                                                                                |
| status            | Error                                                                                                                                                                                                                           |
| workdir           | None                                                                                                                                                                                                                            |
| auto_remove       | False                                                                                                                                                                                                                           |
| status_detail     | None                                                                                                                                                                                                                            |
| host              | None                                                                                                                                                                                                                            |
| image_driver      | docker                                                                                                                                                                                                                          |
| task_state        | None                                                                                                                                                                                                                            |
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.").                               |
| name              | ubuntu1                                                                                                                                                                                                                         |
| restart_policy    | {}                                                                                                                                                                                                                              |
| ports             | []                                                                                                                                                                                                                              |
| command           | "sleep" "3600"                                                                                                                                                                                                                  |
| runtime           | None                                                                                                                                                                                                                            |
| cpu               | 1.0                                                                                                                                                                                                                             |
| interactive       | False                                                                                                                                                                                                                           |
+-------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
root@ubuntu1:~# 

</code></pre>
<p>maybe I should try docker-ce rather than docker.io?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250713"><a class="header" href="#20250713">20250713</a></h1>
<h3 id="1-yogaubuntu"><a class="header" href="#1-yogaubuntu">1. yoga(ubuntu)</a></h3>
<p>Using docker-ce, configuration for docker is:</p>
<pre><code>mkdir -p /etc/systemd/system/docker.service.d
vim /etc/systemd/system/docker.service.d/kolla.conf
[Service]
ExecStart=
# ExecStart commandline copied from 'docker-ce' package. Same on CentOS/Debian/Ubuntu systems.
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://192.168.150.29:2375
# reboot
</code></pre>
<h3 id="2-queensubuntu-1804"><a class="header" href="#2-queensubuntu-1804">2. queens(ubuntu 18.04)</a></h3>
<p>Install docker-ce via:</p>
<pre><code>apt remove docker.io
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh 
apt install docker-ce
vim /etc/systemd/system/docker.service.d/kolla.conf
    [Service]
    MountFlags=shared
    ExecStart=
    # ExecStart commandline copied from 'docker-ce' package. Same on CentOS/Debian/Ubuntu systems.
    ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://192.168.150.82:2375
</code></pre>
<p>Create an instance using ext-net:</p>
<pre><code>openstack appcontainer run --name ubuntuexternal --net network=d3fc91e7-631e-4229-abf1-3ce773ddf164 --cpu 1 --memory 1024 ubuntu:latest sleep 3600
</code></pre>
<p>Result:</p>
<pre><code>root@ubuntu1:~# openstack appcontainer list
+--------------------------------------+----------------+---------------+---------+------------+-----------------+-------+
| uuid                                 | name           | image         | status  | task_state | addresses       | ports |
+--------------------------------------+----------------+---------------+---------+------------+-----------------+-------+
| 4e3f13b5-fc95-4b9a-a41e-2e64db633969 | ubuntu         | ubuntu:latest | Running | None       | 177.77.77.9     | []    |
| fd89a81f-b749-476d-a3e3-bad7a4188bdd | ubuntuexternal | ubuntu:latest | Running | None       | 192.168.150.171 | []    |
+--------------------------------------+----------------+---------------+---------+------------+-----------------+-------+
</code></pre>
<h3 id="3-queenscentos-761810"><a class="header" href="#3-queenscentos-761810">3. queens(centos 7.6.1810)</a></h3>
<p>Install docker-ce, then zun will acts like queens in ubuntu 18.04. inner-network is ok, while external network will encounter some failure.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250714"><a class="header" href="#20250714">20250714</a></h1>
<h3 id="1-centos7-virgl-redroid"><a class="header" href="#1-centos7-virgl-redroid">1. centos7 virgl redroid</a></h3>
<p>Create a vm using import disk:</p>
<p><img src="./images/2025_07_14_09_24_11_502x513.jpg" alt="./images/2025_07_14_09_24_11_502x513.jpg" /></p>
<p>Q35/bios:</p>
<p><img src="./images/2025_07_14_09_24_49_633x206.jpg" alt="./images/2025_07_14_09_24_49_633x206.jpg" /></p>
<p>Change IP:</p>
<p><img src="./images/2025_07_14_09_28_59_568x295.jpg" alt="./images/2025_07_14_09_28_59_568x295.jpg" /></p>
<p>change hostname to <code>nvidiaredroidcentos</code>.</p>
<p>Login the vm, then install kernel:</p>
<pre><code># scp -r dash@192.168.1.8:/media/sda/iso/houdini12/centos .
# ls centos/
kernel-5.10.26-2.x86_64.rpm  kernel-headers-5.10.26-2.x86_64.rpm
# yum install ./kernel-5.10.26-2.x86_64.rpm  ./kernel-headers-5.10.26-2.x86_64.rpm 
# grub2-mkconfig -o /boot/grub2/grub.cfg
# shutdown -h now
</code></pre>
<p>Change setting to virgl:</p>
<p><img src="./images/2025_07_14_09_38_44_423x203.jpg" alt="./images/2025_07_14_09_38_44_423x203.jpg" /></p>
<p>Using nvidia card:</p>
<p><img src="./images/2025_07_14_09_39_03_439x332.jpg" alt="./images/2025_07_14_09_39_03_439x332.jpg" /></p>
<pre><code># dmesg | grep -i virgl
[    1.861350] [drm] features: +virgl +edid
# ls /dev/dri/
card0  renderD128
</code></pre>
<p>Install docker-ce, then import docker image:</p>
<pre><code># curl -fsSL https://get.docker.com -o get-docker.sh
# sudo DOWNLOAD_URL=https://mirrors.ustc.edu.cn/docker-ce sh get-docker.sh
# vim /etc/yum.repos.d/docker-ce.repo 
# gpgcheck=1 --&gt; gpgcheck=0
# sudo DOWNLOAD_URL=https://mirrors.ustc.edu.cn/docker-ce sh get-docker.sh
# systemctl enable docker --now
# docker load&lt;redroidhoudini12intel.tar
</code></pre>
<p>Run redroid instance:</p>
<pre><code># docker run -itd --privileged  -p 5555:5555 --name redroid12  redroidhoudini12:latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=host androidboot.redroid_gpu_node=/dev/dri/renderD128  androidboot.redroid_fps=120
# docker exec -it redroid12 sh
8a5eabf67563:/ # getprop | grep boot | grep com                                              
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [299011048305]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
redroid_x86_64:/ # dumpsys SurfaceFlinger | grep GLES                                                                                                                                        
GLES: Mesa, virgl (NVIDIA GeForce RTX 4070/PCIe/SSE2), OpenGL ES 3.2 Mesa 24.0.8 (git-441f064c1c)
</code></pre>
<p>Issue(Ludashi download issue):</p>
<p><img src="./images/2025_07_14_10_21_43_515x566.jpg" alt="./images/2025_07_14_10_21_43_515x566.jpg" /></p>
<h3 id="2-centos7-openstack-queens--zun--redroid12"><a class="header" href="#2-centos7-openstack-queens--zun--redroid12">2. (centos7) OpenStack queens + zun + redroid12</a></h3>
<h4 id="21-base-image"><a class="header" href="#21-base-image">2.1 Base image</a></h4>
<p>AIM: 5.10 as the default kernel, docker-ce installed and configured.</p>
<pre><code>cp centos7_base.qcow2 centos7_510_docker_base.qcow2
</code></pre>
<p>Install kernel as above steps.<br />
Install docker as above steps.</p>
<p>load the redroid12 images then docker pull nginx/ubuntu.</p>
<p>docker configuration.</p>
<pre><code>[root@queenbase ~]# cat /etc/systemd/system/docker.service.d/kolla.conf 
[Service]
MountFlags=shared
[Service]
ExecStart=
# ExecStart commandline copied from 'docker-ce' package. Same on CentOS/Debian/Ubuntu systems.
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375
</code></pre>
<p>undefine the vm, get the qcow2 file.</p>
<h4 id="22-create-vms"><a class="header" href="#22-create-vms">2.2 Create vms</a></h4>
<p>queens1:</p>
<p><img src="./images/2025_07_14_11_22_55_473x440.jpg" alt="./images/2025_07_14_11_22_55_473x440.jpg" /></p>
<p><img src="./images/2025_07_14_11_23_33_493x489.jpg" alt="./images/2025_07_14_11_23_33_493x489.jpg" /></p>
<p><img src="./images/2025_07_14_11_26_39_601x229.jpg" alt="./images/2025_07_14_11_26_39_601x229.jpg" /></p>
<p>queens2:</p>
<p><img src="./images/2025_07_14_11_30_56_558x275.jpg" alt="./images/2025_07_14_11_30_56_558x275.jpg" /></p>
<p>queen3:</p>
<p><img src="./images/2025_07_14_11_33_02_586x376.jpg" alt="./images/2025_07_14_11_33_02_586x376.jpg" /></p>
<h4 id="23-deployment"><a class="header" href="#23-deployment">2.3. deployment</a></h4>
<p>Each node install pip:</p>
<pre><code>yum install python-devel libffi-devel gcc openssl-devel libselinux-python lvm2 -y
curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
[root@queen1 ~]# python2.7 get-pip.py
[root@queen1 ~]# which pip
/usr/bin/pip
[root@queen1 ~]# pip --version
pip 20.3.4 from /usr/lib/python2.7/site-packages/pip (python 2.7)
</code></pre>
<p>Each node install ansible:</p>
<pre><code>pip install -U ansible==2.7.0
pip install docker
</code></pre>
<p>Each node add following items to <code>/etc/hosts</code>:</p>
<pre><code>10.171.172.21	queen1
10.171.172.22	queen2
10.171.172.23	queen3
</code></pre>
<p>password-less login:</p>
<p><img src="./images/2025_07_14_11_52_02_848x280.jpg" alt="./images/2025_07_14_11_52_02_848x280.jpg" /></p>
<p>queen1 node:</p>
<pre><code>git clone https://github.com/openstack/kolla-ansible
cd kolla-ansible
git checkout tags/queens-eol -b queen
pip install pbr
pip install .
mkdir -p /etc/kolla
cp etc/kolla/* /etc/kolla/
cp ansible/inventory/multinode /etc/kolla/
</code></pre>
<p>Edit multinode like following:</p>
<pre><code>[control]
queen1

[network]
queen1
queen2
queen3

[external-compute]
queen1
queen2
queen3

[monitoring]
queen1

[storage]
queen1
queen2
queen3
</code></pre>
<p>globals.yml modifications:</p>
<pre><code>kolla_base_distro: "centos"
kolla_install_type: "source"
openstack_release: "queens"
docker_namespace: "kolla"
network_interface: "eth0"
neutron_external_interface: "eth1"
neutron_plugin_agent: "openvswitch"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_haproxy: "yes"
enable_horizon: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
nova_compute_virt_type: "kvm"
cinder_volume_group: "cinder-volumes"
</code></pre>
<p>generate the password:</p>
<pre><code>kolla-genpwd
</code></pre>
<p>load docker images:</p>
<pre><code>docker load&lt;centoscontroller.tar
# for queen2/3
docker load&lt;node.tar
</code></pre>
<p>Modifications for kolla-ansible:</p>
<pre><code>mkdir /root/origin
cd /usr/share/kolla-ansible/
# backup
cp ./ansible/roles/prechecks/tasks/service_checks.yml /root/origin/
cp ./ansible/roles/prechecks/tasks/package_checks.yml /root/origin/
cp ./ansible/roles/prechecks/tasks/user_checks.yml /root/origin/
cp ./ansible/roles/keystone/tasks/precheck.yml /root/origin/keystone_precheck.yml
cp ./ansible/roles/cinder/tasks/precheck.yml /root/origin/cinder_precheck.yml
# modification
cp /root/modifications/service_checks.yml ./ansible/roles/prechecks/tasks/service_checks.yml
cp /root/modifications/package_checks.yml ./ansible/roles/prechecks/tasks/package_checks.yml
cp /root/modifications/user_checks.yml ./ansible/roles/prechecks/tasks/user_checks.yml
cp /root/modifications/keystone_precheck.yml ./ansible/roles/keystone/tasks/precheck.yml
cp /root/modifications/cinder_precheck.yml ./ansible/roles/cinder/tasks/precheck.yml
</code></pre>
<p>deploy openstack:</p>
<pre><code>cd /etc/kolla/
kolla-ansible -i ./multinode prechecks -vv
kolla-ansible -i ./multinode deploy -vv 
kolla-ansible -i ./multinode post-deploy -vv
</code></pre>
<p>Install openstack client:</p>
<pre><code>#  cat /etc/yum.repos.d/CentOS-OpenStack-train.repo
    # CentOS-OpenStack-train.repo
    #
    # Please see http://wiki.centos.org/SpecialInterestGroup/Cloud for more
    # information
    
    [centos-openstack-train]
    name=CentOS-7 - OpenStack train
    baseurl=https://dl.rockylinux.org/vault/centos/7/cloud/$basearch/openstack-train/
    gpgcheck=0
    enabled=1
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Cloud
    exclude=sip,PyQt4
# yum install python2-openstackclient
# pip install python-zunclient
</code></pre>
<h4 id="24-openstack-admin"><a class="header" href="#24-openstack-admin">2.4 OpenStack Admin</a></h4>
<p>Visit <code>10.171.172.24</code>(admin, password is listed as following):</p>
<pre><code>cat /etc/kolla/passwords.yml | grep -i keystone_admin
keystone_admin_password: 5zGzqMear5ZVltRtRpETFiggoXiz0fmY7TZ1e7iV
</code></pre>
<p>horizon with zun ui supportd:</p>
<p><img src="./images/2025_07_14_14_07_36_1265x459.jpg" alt="./images/2025_07_14_14_07_36_1265x459.jpg" /></p>
<p>Create network(int/ext):</p>
<pre><code>openstack router create Ext-Router
openstack network create --internal --provider-network-type vxlan int-net
openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
openstack router add subnet Ext-Router int-net-sub
openstack network create --provider-physical-network physnet1 --provider-network-type flat  --external ext-net
openstack subnet create ext-net-sub --network ext-net --subnet-range 10.171.172.24/24 --allocation-pool start=10.171.172.160,end=10.171.172.220 --gateway 10.171.172.1 --dns-nameserver 114.114.114.114 --dhcp
openstack router set Ext-Router --external-gateway ext-net
</code></pre>
<p>Network topology:</p>
<p><img src="./images/2025_07_14_14_17_00_647x733.jpg" alt="./images/2025_07_14_14_17_00_647x733.jpg" /></p>
<h4 id="25-zun-instance"><a class="header" href="#25-zun-instance">2.5 zun instance</a></h4>
<p>Get the network infos:</p>
<pre><code># openstack network list
+--------------------------------------+---------+--------------------------------------+
| ID                                   | Name    | Subnets                              |
+--------------------------------------+---------+--------------------------------------+
| 5678d45a-4903-4f17-9266-bded57efba34 | int-net | efc9b0f3-2f5b-4102-b856-44169b518b4e |
| d27c46dc-4dde-4c04-af16-1104f0270e61 | ext-net | e63d1f7f-ded0-4fe3-a6fb-736ff7c3ec30 |
+--------------------------------------+---------+--------------------------------------+
</code></pre>
<p>Create the int zun instance:</p>
<pre><code># openstack appcontainer run --name ubuntuint --net network=5678d45a-4903-4f17-9266-bded57efba34  --cpu 1 --memory 1024  ubuntu:latest sleep 3600
</code></pre>
<p>Create the int zun instance and specify its running node:</p>
<pre><code># openstack appcontainer run --name ubuntuintHostQueen3 --net network=5678d45a-4903-4f17-9266-bded57efba34  --cpu 1 --memory 1024 --host queen3  ubuntu:latest sleep 3600
</code></pre>
<p>Examine the instance:</p>
<pre><code>[root@queen3 ~]# docker ps
CONTAINER ID   IMAGE                                                  COMMAND                   CREATED              STATUS              PORTS     NAMES
a0f3d7caa4b8   ubuntu:latest                                          "sleep 3600"              About a minute ago   Up About a minute             zun-a7d168ad-2322-4cf8-a5a1-5beb933e91f4
[root@queen3 ~]# docker exec -it a0f3d7caa4b8 bash
root@queen3:/#  apt update -y &amp;&amp; apt install -y net-tools
root@queen3:/#  ifconfig
</code></pre>
<p><img src="./images/2025_07_14_14_23_55_734x476.jpg" alt="./images/2025_07_14_14_23_55_734x476.jpg" /></p>
<p>instance stop:</p>
<pre><code>[root@queen1 kolla]# openstack appcontainer list
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
| uuid                                 | name                | image         | status  | task_state | addresses   | ports |
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
| db03c512-7553-4e22-b41d-5dc925608b5c | ubuntuint           | ubuntu:latest | Running | None       | 177.77.77.4 | []    |
| a7d168ad-2322-4cf8-a5a1-5beb933e91f4 | ubuntuintHostQueen3 | ubuntu:latest | Running | None       | 177.77.77.8 | []    |
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
[root@queen1 kolla]# openstack appcontainer delete ubuntuint
Delete for container ubuntuint failed: Cannot delete container db03c512-7553-4e22-b41d-5dc925608b5c in Running state (HTTP 409) (Request-ID: req-efc9ca30-6732-4f07-8161-0a7344e88bc4)
[root@queen1 kolla]# openstack appcontainer stop ubuntuint
Request to stop container ubuntuint has been accepted.
[root@queen1 kolla]# openstack appcontainer list
+--------------------------------------+---------------------+---------------+---------+--------------------+-------------+-------+
| uuid                                 | name                | image         | status  | task_state         | addresses   | ports |
+--------------------------------------+---------------------+---------------+---------+--------------------+-------------+-------+
| db03c512-7553-4e22-b41d-5dc925608b5c | ubuntuint           | ubuntu:latest | Running | container_stopping | 177.77.77.4 | []    |
| a7d168ad-2322-4cf8-a5a1-5beb933e91f4 | ubuntuintHostQueen3 | ubuntu:latest | Running | None               | 177.77.77.8 | []    |
+--------------------------------------+---------------------+---------------+---------+--------------------+-------------+-------+
</code></pre>
<p>delete instance:</p>
<pre><code>[root@queen1 kolla]# openstack appcontainer delete ubuntuint
Request to delete container ubuntuint has been accepted.
[root@queen1 kolla]# openstack appcontainer list
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
| uuid                                 | name                | image         | status  | task_state | addresses   | ports |
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
| a7d168ad-2322-4cf8-a5a1-5beb933e91f4 | ubuntuintHostQueen3 | ubuntu:latest | Running | None       | 177.77.77.8 | []    |
+--------------------------------------+---------------------+---------------+---------+------------+-------------+-------+
</code></pre>
<p>external instance test with issue(first container will cause the VIP not accessable, thus the second one will failed):</p>
<pre><code># openstack appcontainer run --name ubuntuext --net network=d27c46dc-4dde-4c04-af16-1104f0270e61 --cpu 1 --memory 1024  ubuntu:latest sleep 3600
# openstack appcontainer run --name ubuntuextHostQueen3 --net network=d27c46dc-4dde-4c04-af16-1104f0270e61 --cpu 1 --memory 1024  ubuntu:latest sleep 3600
Failed to discover available identity versions when contacting http://10.171.172.24:35357/v3. Attempting to parse version from URL.
Unable to establish connection to http://10.171.172.24:35357/v3/auth/tokens: HTTPConnectionPool(host='10.171.172.24', port=35357): Max retries exceeded with url: /v3/auth/tokens (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x7f83e4df4190&gt;: Failed to establish a new connection: [Errno 113] \xe6\xb2\xa1\xe6\x9c\x89\xe5\x88\xb0\xe4\xb8\xbb\xe6\x9c\xba\xe7\x9a\x84\xe8\xb7\xaf\xe7\x94\xb1',))
</code></pre>
<h4 id="26-floating-ip-allocation"><a class="header" href="#26-floating-ip-allocation">2.6 floating ip allocation</a></h4>
<p>Create an zun instance:</p>
<pre><code>[root@queen1 kolla]# openstack appcontainer list
+--------------------------------------+---------------------+---------------+---------+------------+--------------+-------+
| uuid                                 | name                | image         | status  | task_state | addresses    | ports |
+--------------------------------------+---------------------+---------------+---------+------------+--------------+-------+
| 9edef92d-39cf-4020-bfa2-f2f2fd65d7bd | ubuntuintHostQueen3 | ubuntu:latest | Running | None       | 177.77.77.23 | []    |
+--------------------------------------+---------------------+---------------+---------+------------+--------------+-------+
</code></pre>
<p>Allocating a floating IP :</p>
<p><img src="./images/2025_07_14_14_58_45_1118x383.jpg" alt="./images/2025_07_14_14_58_45_1118x383.jpg" /></p>
<p>Recreate the security group:</p>
<p><img src="./images/2025_07_14_15_03_50_1255x623.jpg" alt="./images/2025_07_14_15_03_50_1255x623.jpg" /></p>
<p>In docker instance:</p>
<pre><code>root@queen3:/# apt update -y &amp;&amp; apt install -y net-tools iputils-ping
root@queen3:/# ping -c2 223.5.5.5
PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.
64 bytes from 223.5.5.5: icmp_seq=1 ttl=111 time=12.0 ms
64 bytes from 223.5.5.5: icmp_seq=2 ttl=111 time=8.64 ms

--- 223.5.5.5 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 8.644/10.306/11.968/1.662 ms
root@queen3:/# cat /etc/issue
Ubuntu 24.04.2 LTS \n \l
</code></pre>
<p>Ping from outside world(same ethernet):</p>
<pre><code>root@i9workstation:~# ping -c2 10.171.172.177
PING 10.171.172.177 (10.171.172.177) 56(84) bytes of data.
64 bytes from 10.171.172.177: icmp_seq=1 ttl=63 time=2.44 ms
64 bytes from 10.171.172.177: icmp_seq=2 ttl=63 time=1.40 ms

--- 10.171.172.177 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 1.396/1.919/2.442/0.523 
</code></pre>
<h4 id="27-zun-privileged-mode"><a class="header" href="#27-zun-privileged-mode">2.7 zun privileged mode</a></h4>
<p>Create privileged container instance:</p>
<pre><code># openstack appcontainer run  --name ubuntuint  --net network=5678d45a-4903-4f17-9266-bded57efba34 --privileged --cpu 1 --memory 1024 ubuntu:latest sleep 3600
Additional properties are not allowed (u'privileged' was unexpected)

Failed validating 'additionalProperties' in schema:
    {'additionalProperties': False,
     'properties': {'auto_remove': {'type': ['boolean', 'null']},
                    'command': {'type': ['string', 'null']},
                    'cpu': {'minLength': 1,
</code></pre>
<p>Reason(Queen version):</p>
<pre><code>(zun-compute)[root@queen1 /]# ls /zun-base-source/
zun-1.0.1
(zun-api)[root@queen1 /]# ls /zun-base-source/
zun-1.0.1
</code></pre>
<p>Release note(<code>https://fossies.org/linux/zun/ChangeLog</code>):</p>
<p><img src="./images/2025_07_14_16_29_55_544x661.jpg" alt="./images/2025_07_14_16_29_55_544x661.jpg" /></p>
<p>Rocky version:</p>
<pre><code>[root@queen1 ~]# docker run -it kolla/centos-source-zun-api:rocky /bin/bash
()[root@46e8671fcd28 /]# ls zun-base-source/
zun-2.1.0
</code></pre>
<p>So we need to backport the <code>--privileged code</code> into zun-1.0.1....</p>
<h3 id="3-systemd-stop-timeout"><a class="header" href="#3-systemd-stop-timeout">3. systemd stop timeout</a></h3>
<p>Issue:</p>
<pre><code>A stop job is running for Session c2 of user ... (1min 30s)
</code></pre>
<p>Changed:</p>
<pre><code># vim /etc/systemd/system.conf
# cat /etc/systemd/system.conf |grep -i timeoutstop
DefaultTimeoutStopSec=20s
# systemctl daemon-reload
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250715"><a class="header" href="#20250715">20250715</a></h1>
<h3 id="1-zun-replacementubuntu1804"><a class="header" href="#1-zun-replacementubuntu1804">1. zun Replacement(Ubuntu1804)</a></h3>
<p>Replace the docker image tag:</p>
<pre><code># backup origin one
docker tag kolla/ubuntu-source-zun-api:queens kolla/ubuntu-source-zun-api:queensback
docker tag kolla/ubuntu-source-zun-compute:queens kolla/ubuntu-source-zun-compute:queensback
# remove origin on
docker rmi kolla/ubuntu-source-zun-api:queens
docker rmi kolla/ubuntu-source-zun-compute:queens
# rocky-&gt;queens
docker tag kolla/ubuntu-source-zun-compute:rocky kolla/ubuntu-source-zun-compute:queens
docker tag kolla/ubuntu-source-zun-api:rocky kolla/ubuntu-source-zun-api:queens
</code></pre>
<p>Stop/Delete the running zun related services:</p>
<pre><code>docker stop zun_compute &amp;&amp; docker rm zun_compute &amp;&amp; docker stop zun_api &amp;&amp; docker rm zun_api
</code></pre>
<p>Re-deploy:</p>
<pre><code># cd /etc/kolla
# kolla-ansible -i ./multinode deploy
</code></pre>
<p>After deployment, when create:</p>
<pre><code># openstack appcontainer show xxxx
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("IpamDriver.RequestPool: Another pool with same cidr exist. ipam and network options not used to pass pool name").                                              |
</code></pre>
<p>some node will be not available, maybe I should try another fresh installation.</p>
<h3 id="2-zun-deploymentubuntu1804-with-rocky-image"><a class="header" href="#2-zun-deploymentubuntu1804-with-rocky-image">2. zun deployment(ubuntu1804 with rocky image)</a></h3>
<p>IP addr is listed:</p>
<pre><code>10.171.172.31   ubuntu1
10.171.172.32   ubuntu2
10.171.172.33   ubuntu3
</code></pre>
<p>(each node) configure the hosts:</p>
<pre><code># cat /etc/hosts
10.171.172.31	ubuntu1
10.171.172.32	ubuntu2
10.171.172.33	ubuntu3
</code></pre>
<p>(each node) Install pip:</p>
<pre><code># rm -f /etc/resolv.conf &amp;&amp; echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf &amp;&amp; apt update -y
# apt install -y python-pip
</code></pre>
<p>(controller) virtualenv:</p>
<pre><code>pip install virtualenv
mkdir ~/kolla &amp;&amp; virtualenv ~/kolla/virtualenv &amp;&amp; source ~/kolla/virtualenv/bin/activate
apt-get install -y python-dev libffi-dev gcc libssl-dev python-selinux python-setuptools build-essential
</code></pre>
<p>(controller) kolla preparation:</p>
<pre><code>cd ~
git clone https://github.com/openstack/kolla-ansible
cd kolla-ansible/ &amp;&amp; git checkout tags/queens-eol -b queen
pip install -r requirements.txt
pip install .
# which kolla-ansible
# result should be  /root/kolla/virtualenv/bin/kolla-ansible

mkdir -p /etc/kolla
cp etc/kolla/* /etc/kolla/
</code></pre>
<p>(controller) Create globals.xml, content listed as following:</p>
<pre><code>kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "queens"
kolla_internal_vip_address: "10.171.172.34"
docker_namespace: "kolla"
network_interface: "eth0"
neutron_external_interface: "eth1"
neutron_plugin_agent: "openvswitch"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_haproxy: "yes"
enable_horizon: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
cinder_volume_group: "cinder-volumes"
nova_compute_virt_type: "kvm"
ironic_dnsmasq_dhcp_range:
tempest_image_id:
tempest_flavor_ref_id:
tempest_public_network_id:
tempest_floating_network_name:
</code></pre>
<p>(controller node)multinode should be like:</p>
<pre><code>[control]
ubuntu1

[network]
ubuntu1
ubuntu2
ubuntu3

[inner-compute]

[external-compute]
ubuntu1
ubuntu2
ubuntu3

[compute:children]
inner-compute
external-compute

[monitoring]
ubuntu1

[storage]
ubuntu1
ubuntu2
ubuntu3

# ls /etc/kolla/
globals.yml  multinode  passwords.yml

</code></pre>
<p>(controller node)Fill in password:</p>
<pre><code>kolla-genpwd 
</code></pre>
<p>(controller node) kolla source code changes:</p>
<pre><code># vim /root/kolla/virtualenv/share/kolla-ansible/ansible/roles/baremetal/templates/docker_apt_repo.j2
  # main docker repo
  #deb {{ docker_apt_url }}/repo {{ ansible_distribution | lower }}-{{ ansible_distribution_release | lower }} main
# vim /root/kolla/./virtualenv/share/kolla-ansible/ansible/roles/baremetal/tasks/install.yml
  # comment line 67-89
# vim /root/kolla/./virtualenv/share/kolla-ansible/ansible/roles/baremetal/tasks/post-install.yml
# comment line 19-24
# vim /root/kolla/./virtualenv/share/kolla-ansible/ansible/roles/baremetal/tasks/pre-install.yml
  # comment line 93-114
#  vim /root/kolla/./virtualenv/share/kolla-ansible/ansible/roles/baremetal/defaults/main.yml
  debian_pkg_install:
  # - "{{ 'docker-ce' if ansible_architecture == 'aarch64' else 'docker-engine=1.12.*' }}"
   - git
#  vim /root/kolla/./virtualenv/share/kolla-ansible/ansible/roles/neutron/tasks/precheck.yml
 34   #failed_when: result.stdout.find('MountFlags=1048576') == -1
 35   failed_when: result.stdout.find('MountFlags=shared') == -1

</code></pre>
<p>(all node) configure docker repo, and install docker:</p>
<pre><code># curl -fsSL https://get.docker.com -o get-docker.sh
# sh get-docker.sh
# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
# cat /etc/apt/sources.list.d/docker.list
deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu bionic stable
# apt update -y &amp;&amp; apt install -y docker-ce
</code></pre>
<p>(controller node)bootstrap servers:</p>
<pre><code>apt install -y ansible
kolla-ansible  -i ./multinode bootstrap-servers
</code></pre>
<p>(all node) configure docker options:</p>
<pre><code>root@ubuntu3:~# cat /etc/systemd/system/docker.service.d/kolla.conf
[Service]
MountFlags=shared
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://10.171.172.33:2375 --cluster-store=etcd://10.xxx.xxx.xxx:2379
root@ubuntu3:~# systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; reboot
</code></pre>
<p>(all node) after reboot, load images:</p>
<pre><code>docker load&lt;computer.tar
docker load&lt;controller.tar
</code></pre>
<p>(all nodes) install pip docker:</p>
<pre><code>pip install docker
pip install --upgrade pip
 pip install  netaddr oslo_config
</code></pre>
<p>(controller node) continue deploy:</p>
<pre><code>source ~/kolla/virtualenv/bin/activate
kolla-ansible -i ./multinode prechecks
kolla-ansible -i ./multinode deploy
kolla-ansible -i ./multinode post-deploy
</code></pre>
<p>(all node), add aosp related:</p>
<pre><code># crontab -e
@reboot modprobe binder_linux devices="binder,hwbinder,vndbinder" ; modprobe ashmem_linux
</code></pre>
<p>(all node), privileged zun instance:</p>
<pre><code>vim /etc/kolla/zun-compute/zun.conf 
vim /etc/kolla/zun-api/zun.conf 
docker cp policy.json zun_compute:/etc/zun/
docker cp policy.json zun_api:/etc/zun/
</code></pre>
<p>(controller node)Create network:</p>
<pre><code>source /etc/kolla/admin-openrc.sh 
apt install -y python-openstackclient &amp;&amp; pip install python-zunclient
</code></pre>
<p>bug fix for zun:</p>
<pre><code>docker exec -it --user root zun_compute bash 
docker exec -it --user root zun_api bash 
sed -i 's|^exec_dirs.*|exec_dirs=/var/lib/kolla/venv/bin,/sbin,/usr/sbin,/bin,/usr/bin,/usr/local/bin,/usr/local/sbin|g' /etc/zun/rootwrap.conf
mkdir -p /var/lib/docker
chmod 777 -R /var/lib/docker
</code></pre>
<p>Even with kuryr replacement(<code>rocky-&gt;queens</code>), still got error:</p>
<pre><code>| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("IpamDriver.RequestPool: Another pool with same cidr exist. ipam and network options not used to pass pool name").                                          |

</code></pre>
<h3 id="2-destroy-and-re-deploy"><a class="header" href="#2-destroy-and-re-deploy">2. destroy and re-deploy</a></h3>
<p>Destroy the running kolla ansible via:</p>
<pre><code>kolla-ansible -i ./multinode destroy --include-images --include-dev --yes-i-really-really-mean-it
</code></pre>
<p>with bridged network:</p>
<p><img src="./images/2025_07_15_16_46_48_1116x534.jpg" alt="./images/2025_07_15_16_46_48_1116x534.jpg" /></p>
<p>Created via:</p>
<pre><code>for i in {1..10}; do openstack appcontainer run --name fuck$i  --net network=634b42dd-8475-4eb5-abcc-6cd7a327062d --image-pull-policy=never --cpu 1 --memory 1024 --privileged  ubuntu:latest sleep 3600; done
</code></pre>
<h3 id="3-queens-network-issuezun"><a class="header" href="#3-queens-network-issuezun">3. queens network issue(zun)</a></h3>
<p>Create via:</p>
<pre><code>for i in {1..10}; do openstack appcontainer run --name lucky$i --net network=9d746dac-e1e7-4fe4-9011-6d8dd0433413 --image-pull-policy=never --cpu 1 --memory 1024 ubuntu:latest sleep 3600; done
</code></pre>
<p>Result:</p>
<pre><code> openstack appcontainer list
+--------------------------------------+---------+---------------+---------+------------+--------------+-------+
| uuid                                 | name    | image         | status  | task_state | addresses    | ports |
+--------------------------------------+---------+---------------+---------+------------+--------------+-------+
| 4dd9593a-47e8-4724-9bb9-2001ccb6b349 | lucky1  | ubuntu:latest | Running | None       | 177.77.77.4  | []    |
| 205340f6-a9c2-4a5c-83a6-f259c42f32c4 | lucky2  | ubuntu:latest | Running | None       | 177.77.77.5  | []    |
| 372e44c0-c91d-444d-967d-58127947625a | lucky3  | ubuntu:latest | Running | None       | 177.77.77.6  | []    |
| b0fe8607-67d5-4738-8714-ac086110ab27 | lucky4  | ubuntu:latest | Running | None       | 177.77.77.23 | []    |
| b22b459f-32f9-422a-8ee5-f56380b2d36b | lucky5  | ubuntu:latest | Error   | None       | 177.77.77.28 | []    |
| ed5a170c-ed04-492a-ab46-31f72785cca8 | lucky6  | ubuntu:latest | Running | None       | 177.77.77.20 | []    |
| e1742617-fd6d-46ca-9a8c-56cbd5f196c8 | lucky7  | ubuntu:latest | Running | None       | 177.77.77.10 | []    |
| 9971e09c-a282-411b-82c6-8ccbd6123d99 | lucky8  | ubuntu:latest | Running | None       | 177.77.77.3  | []    |
| 63108364-53a6-4b4e-9ad8-b13a2e8fb5dc | lucky9  | ubuntu:latest | Error   | None       | 177.77.77.7  | []    |
| 16fc196d-5e44-4c00-8134-197e0727bfc1 | lucky10 | ubuntu:latest | Error   | None       | 177.77.77.19 | []    |
+--------------------------------------+---------+---------------+---------+------------+--------------+-------+
</code></pre>
<p>error message:</p>
<pre><code>root@ubuntu1:~# openstack appcontainer show lucky10 | grep status
| status            | Error                                                                                                                                                                                                                                                                                                                  |
| status_detail     | Exited(128)  ago (error)                                                                                                                                                                                                                                                                                               |
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("failed to create endpoint zun-16fc196d-5e44-4c00-8134-197e0727bfc1 on network 9d746dac-e1e7-4fe4-9011-6d8dd0433413: remote: Neutron net associated with identifier 4a9c320154e5a85d15e44b08d968514b7c0e9a3ef5b32fcf971c9583e6e8174f doesn't exist."). |
root@ubuntu1:~# openstack appcontainer show lucky5 | grep status
| status            | Error                                                                                                                                                                                                                                                                                                                  |
| status_detail     | Exited(128)  ago (error)                                                                                                                                                                                                                                                                                               |
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("failed to create endpoint zun-b22b459f-32f9-422a-8ee5-f56380b2d36b on network 9d746dac-e1e7-4fe4-9011-6d8dd0433413: remote: Neutron net associated with identifier 4a9c320154e5a85d15e44b08d968514b7c0e9a3ef5b32fcf971c9583e6e8174f doesn't exist."). |
root@ubuntu1:~# openstack appcontainer show lucky9 | grep status
| status            | Error                                                                                                                                                                                                                                                                                                                  |
| status_detail     | Exited(128)  ago (error)                                                                                                                                                                                                                                                                                               |
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("failed to create endpoint zun-63108364-53a6-4b4e-9ad8-b13a2e8fb5dc on network 9d746dac-e1e7-4fe4-9011-6d8dd0433413: remote: Neutron net associated with identifier 4a9c320154e5a85d15e44b08d968514b7c0e9a3ef5b32fcf971c9583e6e8174f doesn't exist."). |

</code></pre>
<p>network will change id as:</p>
<pre><code>root@ubuntu1:~# openstack network list
+--------------------------------------+------------------------------------------------------------------+--------------------------------------+
| ID                                   | Name                                                             | Subnets                              |
+--------------------------------------+------------------------------------------------------------------+--------------------------------------+
| 0d1be4f2-7bf7-4aa1-bc8e-80e011203873 | ext-net                                                          | f12d5f1c-b67d-42e3-a98b-c8d7d047ecce |
| 9d746dac-e1e7-4fe4-9011-6d8dd0433413 | c83c42ab80b1ebcfeac8900959a376844fb26f18b26c98f004dca5276766b4f3 | 1ef1bf11-461c-4142-95af-e4b3f58795a5 |
+--------------------------------------+------------------------------------------------------------------+--------------------------------------+
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250716"><a class="header" href="#20250716">20250716</a></h1>
<h3 id="1-ubuntu2204-yoga-verification"><a class="header" href="#1-ubuntu2204-yoga-verification">1. ubuntu2204 yoga verification</a></h3>
<p>environment info:</p>
<pre><code># cat /etc/hosts
....
192.168.150.11  yoga1
192.168.150.12  yoga2
192.168.150.13  yoga3
</code></pre>
<p>(control node):</p>
<pre><code>rm -f /etc/resolv.conf &amp;&amp; echo "nameserver 223.5.5.5"&gt;/etc/resolv.conf &amp;&amp; apt update -y
ufw disable
apt remove apparmor --purge
apt install -y git python3-dev libffi-dev build-essential libssl-dev
apt install python3-venv python3-pip -y
apt install -y dnscrypt-proxy
echo "nameserver 127.0.2.1"&gt;/etc/resolv.conf
chattr +i /etc/resolv.conf
pvcreate /dev/vdb
vgcreate cinder-volumes /dev/vdb
reboot
python3 -m venv .venv/kolla
source ~/.venv/kolla/bin/activate
pip3 install -U pip
pip3 install 'ansible-core&gt;=2.11,&lt;2.12'
git clone https://github.com/openstack/kolla-ansible.git
cd kolla-ansible
git checkout tags/yoga-eol -b yoga
pip install -r requirements.txt 
pip install .
mkdir -p /etc/kolla
cp etc/kolla/* /etc/kolla/
</code></pre>
<p>The globals.yml is listed as:</p>
<pre><code># grep -v '^#' /etc/kolla/globals.yml  | grep -v "^$"
---
kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "yoga"
kolla_internal_vip_address: "192.168.150.14"
docker_configure_for_zun: "yes"
containerd_configure_for_zun: "yes"
network_interface: "eth0"
neutron_external_interface: "eth1"
neutron_plugin_agent: "linuxbridge"
enable_openstack_core: "yes"
enable_haproxy: "yes"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
cinder_volume_group: "cinder-volumes"
nova_compute_virt_type: "kvm"

</code></pre>
<p>Edit the <code>/etc/kolla/multinode</code> file for definition of deployment.</p>
<p>Install all of the nodes python deps:</p>
<pre><code># pip3 freeze&gt;requirements.txt
comment all of the ansible items
scp to other 2 nodes
</code></pre>
<p>Install pip deps:</p>
<pre><code>(kolla) [root@yoga1 ~]# deactivate 
# pip3 install -r /tmp/requirements.txt
root@yoga2:/home/test# pip3 install -r /home/test/requirements.txt 
root@yoga3:/home/test# pip3 install -r /home/test/requirements.txt 
</code></pre>
<p>copy ssh identifier files to <code>yoga1-3</code>,</p>
<pre><code>kolla-ansible bootstrap-servers -i ./multinode
kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false
</code></pre>
<p>Prepare deps(using 2023.1 for downloading, then replace):</p>
<pre><code># kolla-ansible install-deps
Failed with: 
error: pathspec 'unmaintained/yoga' did not match any file(s) known to git
ERROR! Failed to switch a cloned Git repo `https://opendev.org/openstack/ansible-collection-kolla` to the requested revision `unmaintained/yoga`.
# cat ~/.venv/kolla/share/kolla-ansible/requirements.yml
---
collections:
  - name: https://opendev.org/openstack/ansible-collection-kolla
    type: git
    version: unmaintained/2023.1
    #version: unmaintained/yoga
### install 2023.1
# kolla-ansible install-deps
Installing 'openstack.kolla:1.0.0' to '/root/.ansible/collections/ansible_collections/openstack/kolla'
Created collection for openstack.kolla:1.0.0 at /root/.ansible/collections/ansible_collections/openstack/kolla
openstack.kolla:1.0.0 was installed successfully
###  Fetch the yoga-eol deps
# git clone https://opendev.org/openstack/ansible-collection-kolla
#   cd ansible-collection-kolla/
#  git checkout tags/yoga-eol -b yoga
# cd /root/.ansible/collections/ansible_collections/openstack/kolla/
# rm -rf roles/*
#  cp -ar /root/ansible-collection-kolla/roles/* roles/
# ls roles/
baremetal  docker_sdk  kolla_user 
</code></pre>
<p>(all node):</p>
<pre><code># pip3 install 'pyopenssl&gt;=23.2.0'

</code></pre>
<p>Begin install:</p>
<pre><code># cd /etc/kolla/
# pip install 'ansible&gt;=4,&lt;6'
# pip install 'pyopenssl&gt;=23.2.0'
</code></pre>
<p>Source code changes:</p>
<pre><code># vim /root/.ansible/collections/ansible_collections/openstack/kolla/roles/baremetal/defaults/main.yml
docker_apt_package: "docker-ce=5:20.10.24~3-0~ubuntu-jammy"
</code></pre>
<p>deploy:</p>
<pre><code>cd /etc/kolla
kolla-ansible -i ./multinode bootstrap-servers
kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false
</code></pre>
<p>(all nodes), add registry:</p>
<pre><code># vim /etc/docker/daemon.json , add following:   
      "registry-mirrors": [ "https://docker.nju.edu.cn/",
             "https://hub.uuuadc.top",
        "https://docker.anyhub.us.kg",
        "https://dockerhub.jobcher.com",
        "https://dockerhub.icu",
        "https://docker.ckyl.me",
        "https://docker.awsl9527.cn", "https://docker.mirrors.ustc.edu.cn", "https://docker.1ms.run", "https://docker.xuanyuan.me"
      ]
# systemctl daemon-reload &amp;&amp; systemctl restart docke
</code></pre>
<p>load images, then pull/deploy/post-deploy</p>
<pre><code>cd /etc/kolla
kolla-ansible -i ./multinode pull
kolla-ansible -i ./multinode deploy &amp;&amp; kolla-ansible -i ./multinode post-deploy
apt install -y python3-openstackclient
pip3 install python-zunclient
reboot
</code></pre>
<p>After reboot, create network, test the zun.</p>
<p>Change some items:</p>
<pre><code>neutron_plugin_agent: "openvswitch"
enable_etcd: "yes"
</code></pre>
<p>Test:</p>
<pre><code>for i in {1..5}; do openstack appcontainer run --name sss$i --net network=24f240b1-319d-40fc-acf5-bf970027737f --image-pull-policy=never --cpu 1 --memory 1024 --host yoga3 ubuntu:latest sleep 3600; done
for i in {1..3}; do openstack appcontainer run --name ttt$i --net network=24f240b1-319d-40fc-acf5-bf970027737f --image-pull-policy=never --cpu 1 --memory 1024 --host yoga1 ubuntu:latest sleep 3600; done
</code></pre>
<p>Test ext net:</p>
<pre><code> for i in {1..3}; do openstack appcontainer run --name sss$i --net network=9c5c9066-c2dd-4beb-8407-3652fe0036a0 --image-pull-policy=never --cpu 1 --memory 1024 --host yoga3 ubuntu:latest sleep 3600; done
 for i in {4..6}; do openstack appcontainer run --name sss$i --net network=9c5c9066-c2dd-4beb-8407-3652fe0036a0 --image-pull-policy=never --cpu 1 --memory 1024 --host yoga2 ubuntu:latest sleep 3600; done
 for i in {7..9}; do openstack appcontainer run --name sss$i --net network=9c5c9066-c2dd-4beb-8407-3652fe0036a0 --image-pull-policy=never --cpu 1 --memory 1024 --host yoga1 ubuntu:latest sleep 3600; done

</code></pre>
<p><img src="./images/2025_07_16_12_00_28_1145x392.jpg" alt="./images/2025_07_16_12_00_28_1145x392.jpg" /></p>
<h3 id="2-docker-ce-downgrade"><a class="header" href="#2-docker-ce-downgrade">2. docker-ce downgrade</a></h3>
<p>docker-ce downgrade:</p>
<pre><code>apt remove  docker-ce docker-ce-cli docker-ce-rootless-extras
apt autoremove
apt install docker-ce=5:20.10.24~3-0~ubuntu-jammy
</code></pre>
<h3 id="3-openstacktrain-deployment"><a class="header" href="#3-openstacktrain-deployment">3. openstack(train) deployment</a></h3>
<p>Install ubuntu200406 vm.</p>
<pre><code># /etc/hosts
192.168.150.21	train1
192.168.150.22	train2
192.168.150.23	train3
</code></pre>
<p>configuration:</p>
<pre><code># cat /etc/kolla/globals.yml | grep -v '^#' | grep -v '^$'
---
kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "train"
kolla_internal_vip_address: "192.168.150.24"
docker_configure_for_zun: "yes"
neutron_external_interface: "eth1"
neutron_plugin_agent: "openvswitch"
enable_openstack_core: "yes"
enable_haproxy: "yes"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_etcd: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
cinder_volume_group: "cinder-volumes"
nova_compute_virt_type: "kvm"
</code></pre>
<p>(all nodes):</p>
<pre><code>ls /usr/lib/python3/dist-packages/OpenSSL
 mv /usr/lib/python3/dist-packages/OpenSSL /root/
 sudo pip3 install pyopenssl
 sudo pip3 install pyopenssl --upgrade
</code></pre>
<p>Change baremetal related:</p>
<pre><code># vim /root/.venv/kolla/share/kolla-ansible/ansible/roles/baremetal/defaults/main.yml
 10 docker_apt_package: "docker-ce=5:20.10.24~3-0~ubuntu-focal"
</code></pre>
<p>Remove:</p>
<pre><code>apt remove docker-buildx-plugin docker-ce docker-ce-cli docker-ce-rootless-extras docker-compose-plugin
apt autoremove
cd /etc/kolla
 kolla-ansible bootstrap-servers -i ./multinode
</code></pre>
<p>Solved issue:</p>
<pre><code>failed: [train3] (item={'key': 'cron', 'value': {'container_name': 'cron', 'group': 'all', 'enabled': True, 'image': 'kolla/ubuntu-source-cron:train', 'environment': {'DUMMY_ENVIRONMENT': 'kolla_useless_env'}, 'volumes': ['/etc/kolla/cron/:/var/lib/kolla/config_files/:ro', '/etc/localtime:/etc/localtime:ro', '/etc/timezone:/etc/timezone:ro', 'kolla_logs:/var/log/kolla/'], 'dimensions': {}}}) =&gt; {"ansible_loop_var": "item", "changed": true, "item": {"key": "cron", "value": {"container_name": "cron", "dimensions": {}, "enabled": true, "environment": {"DUMMY_ENVIRONMENT": "kolla_useless_env"}, "group": "all", "image": "kolla/ubuntu-source-cron:train", "volumes": ["/etc/kolla/cron/:/var/lib/kolla/config_files/:ro", "/etc/localtime:/etc/localtime:ro", "/etc/timezone:/etc/timezone:ro", "kolla_logs:/var/log/kolla/"]}}, "msg": "'Traceback (most recent call last):\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/adapters.py\", line 633, in send\\n    conn = self.get_connection_with_tls_context(\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/adapters.py\", line 489, in get_connection_with_tls_context\\n    conn = self.poolmanager.connection_from_host(\\n  File \"/usr/local/lib/python3.8/dist-packages/urllib3/poolmanager.py\", line 303, in connection_from_host\\n    return self.connection_from_context(request_context)\\n  File \"/usr/local/lib/python3.8/dist-packages/urllib3/poolmanager.py\", line 325, in connection_from_context\\n    raise URLSchemeUnknown(scheme)\\nurllib3.exceptions.URLSchemeUnknown: Not supported URL scheme http+docker\\n\\nDuring handling of the above exception, another exception occurred:\\n\\nTraceback (most recent call last):\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/api/client.py\", line 214, in _retrieve_server_version\\n    return self.version(api_version=False)[\"ApiVersion\"]\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/api/daemon.py\", line 181, in version\\n    return self._result(self._get(url), json=True)\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/utils/decorators.py\", line 46, in inner\\n    return f(self, *args, **kwargs)\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/api/client.py\", line 237, in _get\\n    return self.get(url, **self._set_request_timeout(kwargs))\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/sessions.py\", line 602, in get\\n    return self.request(\"GET\", url, **kwargs)\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/sessions.py\", line 589, in request\\n    resp = self.send(prep, **send_kwargs)\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/sessions.py\", line 703, in send\\n    r = adapter.send(request, **kwargs)\\n  File \"/usr/local/lib/python3.8/dist-packages/requests/adapters.py\", line 637, in send\\n    raise InvalidURL(e, request=request)\\nrequests.exceptions.InvalidURL: Not supported URL scheme http+docker\\n\\nDuring handling of the above exception, another exception occurred:\\n\\nTraceback (most recent call last):\\n  File \"/tmp/ansible_kolla_docker_payload_t4b_6om5/ansible_kolla_docker_payload.zip/ansible/modules/kolla_docker.py\", line 1023, in main\\n  File \"/tmp/ansible_kolla_docker_payload_t4b_6om5/ansible_kolla_docker_payload.zip/ansible/modules/kolla_docker.py\", line 265, in __init__\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/api/client.py\", line 197, in __init__\\n    self._version = self._retrieve_server_version()\\n  File \"/usr/local/lib/python3.8/dist-packages/docker/api/client.py\", line 221, in _retrieve_server_version\\n    raise DockerException(\\ndocker.errors.DockerException: Error while fetching server API version: Not supported URL scheme http+docker\\n'"}

allnodes:    

pip install 'requests==2.25.0'

kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false
</code></pre>
<p>Pull images:</p>
<pre><code>kolla-ansible pull -i ./multinode 
kolla-ansible deploy -i ./multinode 
# hang on 
</code></pre>
<p>Solved via:</p>
<pre><code>TASK [haproxy : Waiting for virtual IP to appear]
Here is how I fixed it:
1. Because, another service in the network may use the same Virtual Router ID, It is 51 by default. So, change the default "keepalived_virtual_router_id" to another value (free and in the range of 0-255)
$ sudo vi /etc/kolla/globals.yml
...
keepalived_virtual_router_id: "251"
</code></pre>
<p>post deploy:</p>
<pre><code>kolla-ansible post-deploy -i ./multinode 
apt install python3-openstackclient
pip3 install python-zunclient
</code></pre>
<p>Create network, then create instance:</p>
<pre><code>for i in {1..30}; do openstack appcontainer run --name sss$i --net network=783e5e92-e7df-4906-a5ce-15a26b4ac28a --image-pull-policy=never --cpu 1 --memory 512  ubuntu:latest sleep 3600; done
</code></pre>
<p><img src="./images/2025_07_16_17_31_20_1160x489.jpg" alt="./images/2025_07_16_17_31_20_1160x489.jpg" /></p>
<h3 id="4-queens-ubuntu1804-verification"><a class="header" href="#4-queens-ubuntu1804-verification">4. queens ubuntu1804 verification</a></h3>
<p>Added etcd related configuration:</p>
<pre><code># cat /etc/systemd/system/docker.service.d/kolla.conf 
[Service]
MountFlags=shared
ExecStart=
# ExecStart commandline copied from 'docker-ce' package. Same on CentOS/Debian/Ubuntu systems.
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://192.168.150.81:2375 --cluster-store=etcd://192.168.150.81:2379

</code></pre>
<p>Need to specify docker version:</p>
<pre><code>apt install docker-ce=5:20.10.24~3-0~ubuntu-bionic
</code></pre>
<p><code>globals.yml</code> configuration:</p>
<pre><code>kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "queens"
kolla_internal_vip_address: "192.168.150.152"
docker_namespace: "kolla"
network_interface: "eth0"
neutron_external_interface: "eth1"
neutron_plugin_agent: "openvswitch"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_etcd: "yes"
enable_haproxy: "yes"
enable_horizon: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
cinder_volume_group: "cinder-volumes"
nova_compute_virt_type: "kvm"
</code></pre>
<p>related docker image:</p>
<pre><code>kolla/ubuntu-source-etcd                        queens    45d1a8604e18   5 years ago   311MB
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250717"><a class="header" href="#20250717">20250717</a></h1>
<h3 id="1-centos7-queens-kuryr-config"><a class="header" href="#1-centos7-queens-kuryr-config">1. centos7 queens kuryr config</a></h3>
<p>Pull the image(for deploy etcd):</p>
<pre><code>docker pull kolla/centos-source-etcd:queens
</code></pre>
<p>Downgrade docker-ce:</p>
<pre><code># docker version
Client: Docker Engine - Community
 Version:           26.1.4
 API version:       1.45
 Go version:        go1.21.11
 Git commit:        5650f9b
 Built:             Wed Jun  5 11:32:04 2024
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          26.1.4
......
# yum remove docker-ce docker-ce-cli docker-ce-rootless-extras docker-buildx-plugin docker-compose-plugin
# yum install docker-ce-20.10.24-3.el7 docker-ce-cli-20.10.24-3.el7
# systemctl restart docker
# docker version
# docker version
Client: Docker Engine - Community
 Version:           20.10.24
 API version:       1.41
 Go version:        go1.19.7
 Git commit:        297e128
 Built:             Tue Apr  4 18:22:57 2023
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true

Server: Docker Engine - Community
 Engine:
  Version:          20.10.24
  API version:      1.41 (minimum version 1.12)
.....
</code></pre>
<p>Backup docker images:</p>
<pre><code>docker save -o queencentosimages.tar ubuntu:latess-source-zun-compute:queens kolla/centos-source-zun-compute:rocky kolla/centos-source-zun-api:queens kolla/centos-source-zun-api:rocky kolla/centos-source-nova-compute:queens kolla/centos-source-horizon:queens kolla/centos-source-glance-api:queens kolla/centos-source-heat-engine:queens kolla/centos-source-heat-api:queens kolla/centos-source-heat-api-cfn:queens kolla/centos-source-glance-registry:queens kolla/centos-source-nova-ssh:queens kolla/centos-source-nova-api:queens kolla/centos-source-zun-api:queensback kolla/centos-source-zun-compute:queensback kolla/centos-source-nova-novncproxy:queens kolla/centos-source-nova-scheduler:queens kolla/centos-source-nova-placement-api:queens kolla/centos-source-cinder-volume:queens kolla/centos-source-cinder-backup:queens kolla/centos-source-nova-consoleauth:queens kolla/centos-source-nova-conductor:queens kolla/centos-source-cinder-api:queens kolla/centos-source-kuryr-libnetwork:queens kolla/centos-source-neutron-server:queens kolla/centos-source-cinder-scheduler:queens kolla/centos-source-neutron-l3-agent:queens kolla/centos-source-neutron-openvswitch-agent:queens kolla/centos-source-neutron-metadata-agent:queens kolla/centos-source-neutron-dhcp-agent:queens kolla/centos-source-keystone:queens kolla/centos-binary-cinder-volume:queens kolla/centos-binary-cinder-backup:queens kolla/centos-binary-nova-compute:queens kolla/centos-binary-cinder-api:queens kolla/centos-binary-cinder-scheduler:queens kolla/centos-binary-heat-engine:queens kolla/centos-binary-heat-api:queens kolla/centos-binary-heat-api-cfn:queens kolla/centos-binary-glance-api:queens kolla/centos-binary-glance-registry:queens kolla/centos-binary-horizon:queens kolla/centos-binary-nova-api:queens kolla/centos-binary-nova-placement-api:queens kolla/centos-binary-nova-ssh:queens kolla/centos-binary-nova-conductor:queens kolla/centos-binary-nova-consoleauth:queens kolla/centos-binary-nova-novncproxy:queens kolla/centos-binary-neutron-l3-agent:queens kolla/centos-binary-nova-scheduler:queens kolla/centos-binary-keystone:queens kolla/centos-binary-neutron-server:queens kolla/centos-binary-neutron-dhcp-agent:queens kolla/centos-binary-neutron-openvswitch-agent:queens kolla/centos-binary-neutron-metadata-agent:queens kolla/centos-binary-nova-libvirt:queens kolla/centos-binary-kolla-toolbox:queens kolla/centos-binary-openvswitch-db-server:queens kolla/centos-binary-openvswitch-vswitchd:queens kolla/centos-binary-tgtd:queens kolla/centos-binary-cron:queens kolla/centos-binary-mariadb:queens kolla/centos-binary-fluentd:queens kolla/centos-binary-rabbitmq:queens kolla/centos-binary-memcached:queens kolla/centos-binary-iscsid:queens kolla/centos-source-nova-libvirt:queens kolla/centos-source-kolla-toolbox:queens kolla/centos-source-rabbitmq:queens kolla/centos-source-openvswitch-vswitchd:queens kolla/centos-source-openvswitch-db-server:queens kolla/centos-source-memcached:queens kolla/centos-source-iscsid:queens kolla/centos-source-cron:queens kolla/centos-source-mariadb:queens kolla/centos-source-tgtd:queens kolla/centos-source-haproxy:queens kolla/centos-source-keepalived:queens kolla/centos-source-fluentd:queens kolla/centos-source-etcd:queens
</code></pre>
<p>destroy the installed cluster and re-deploy(should run twice):</p>
<pre><code>kolla-ansible -i ./multinode destroy --include-images --include-dev --yes-i-really-really-mean-it
kolla-ansible -i ./multinode destroy --include-images --include-dev --yes-i-really-really-mean-it
</code></pre>
<p>Enable etcd then deploy/post-deploy.</p>
<pre><code>docker load&lt;queencentosimages.tar
kolla-ansible -i ./multinode deploy &amp;&amp; kolla-ansible -i ./multinode post-deploy
</code></pre>
<p>Issue(external network failed):</p>
<pre><code> name              | sss3                                                                                                                                                                                                                        |
| restart_policy    | None                                                                                                                                                                                                                        |
| ports             | None                                                                                                                                                                                                                        |
| command           | [u'sleep', u'3600']                                                                                                                                                                                                         |
| runtime           | None                                                                                                                                                                                                                        |
| cpu               | 1.0                                                                                                                                                                                                                         |
| interactive       | False                                                                                                                                                                                                                       |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
Unable to establish connection to http://10.171.172.24:9517/v1/containers?run=true: ('Connection aborted.', error(110, '\xe8\xbf\x9e\xe6\x8e\xa5\xe8\xb6\x85\xe6\x97\xb6'))
Failed to discover available identity versions when contacting http://10.171.172.24:35357/v3. Attempting to parse version from URL.
Unable to establish connection to http://10.171.172.24:35357/v3/auth/tokens: HTTPConnectionPool(host='10.171.172.24', port=35357): Max retries exceeded with url: /v3/auth/tokens (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x7fd06a35b0d0&gt;: Failed to establish a new connection: [Errno 113] \xe6\xb2\xa1\xe6\x9c\x89\xe5\x88\xb0\xe4\xb8\xbb\xe6\x9c\xba\xe7\x9a\x84\xe8\xb7\xaf\xe7\x94\xb1',))
Failed to discover available identity versions when contacting http://10.171.172.24:35357/v3. Attempting to parse version from URL.

</code></pre>
<h3 id="2-ubuntu1804-queens-deploymentwith-zunfromrocky"><a class="header" href="#2-ubuntu1804-queens-deploymentwith-zunfromrocky">2. ubuntu1804 queens deployment(with zunFROMrocky)</a></h3>
<p>Disk layout:</p>
<pre><code> qemu-img create -f qcow2 -b /var/lib/libvirt/images/ubuntu180406.qcow2 -F qcow2 /media/sda/images/ubuntu180406_queens_zunFROMrocky1.qcow2
 qemu-img create -f qcow2 -b /var/lib/libvirt/images/ubuntu180406.qcow2 -F qcow2 /media/sdb/images/ubuntu180406_queens_zunFROMrocky2.qcow2
 qemu-img create -f qcow2 -b /var/lib/libvirt/images/ubuntu180406.qcow2 -F qcow2 /media/sdc/images/ubuntu180406_queens_zunFROMrocky3.qcow2
 qemu-img create -f qcow2 /media/sda/images/ubuntu180406_queens_zunFROMrockylvm.qcow2 100G
 qemu-img create -f qcow2 /media/sdb/images/ubuntu180406_queens_zunFROMrockylvm.qcow2 100G
 qemu-img create -f qcow2 /media/sdc/images/ubuntu180406_queens_zunFROMrockylvm.qcow2 100G
</code></pre>
<p>vm ips:</p>
<pre><code>phone1 192.168.150.31
phone2 192.168.150.32
phone3 192.168.150.33
</code></pre>
<p>Controller setup is the same as <code>20250715</code>,</p>
<p>globals.yml is listed as following:</p>
<pre><code>kolla_base_distro: "ubuntu"
kolla_install_type: "source"
openstack_release: "queens"
kolla_internal_vip_address: "192.168.150.34"
docker_namespace: "kolla"
network_interface: "eth0"
neutron_external_interface: "eth1"
neutron_plugin_agent: "openvswitch"
enable_cinder: "yes"
enable_cinder_backend_lvm: "yes"
enable_haproxy: "yes"
enable_horizon: "yes"
enable_horizon_zun: "{{ enable_zun | bool }}"
enable_kuryr: "yes"
enable_zun: "yes"
fernet_token_expiry: 86400
cinder_volume_group: "cinder-volumes"
nova_compute_virt_type: "kvm"
enable_etcd: "yes"
keepalived_virtual_router_id: "251"
</code></pre>
<p>globals.yml should be adjusted to <code>phone1-phone3</code>, the content is the same as <code>20250715</code>:</p>
<pre><code># ls /etc/kolla/
globals.yml  multinode  passwords.yml
</code></pre>
<p>Install docker adjustment:</p>
<pre><code>apt install -y docker-ce=5:20.10.24~3-0~ubuntu-bionic
</code></pre>
<p>adjust <code>kolla source code changes</code> in <code>20250715</code>:</p>
<pre><code>comment line 77-99
vim ./share/kolla-ansible/ansible/roles/baremetal/tasks/post-install.yml
</code></pre>
<p>adjust all nodes's docker options:</p>
<pre><code>$ /etc/systemd/system/docker.service.d/kolla.conf
...
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock  -H tcp://0.0.0.0:2375 --cluster-store=etcd://192.168.150.31:2379
</code></pre>
<p>load image:</p>
<pre><code>scp root@10.171.172.31:~/1804zunphoneimages.tar .
docker load&lt;1804zunphoneimages.tar
docker rmi kolla/ubuntu-source-zun-api:queens &amp;&amp; docker rmi kolla/ubuntu-source-zun-compute:queens &amp;&amp; docker tag kolla/ubuntu-source-zun-compute:rocky kolla/ubuntu-source-zun-compute:queens &amp;&amp; docker tag kolla/ubuntu-source-zun-api:rocky kolla/ubuntu-source-zun-api:queens
</code></pre>
<p>allnode:</p>
<pre><code>pvcreate /dev/vdb
vgcreate cinder-volumes /dev/vdb
then: 
precheck
</code></pre>
<p>deploy/post-deploy/apply zun patch, then create network :</p>
<pre><code>apt install -y python3-openstackclient &amp;&amp; pip3 install python-zunclient
</code></pre>
<p>Test:</p>
<pre><code>for i in {1..18}; do openstack appcontainer run --name inner$i --net network=3c1d9781-bfb4-4371-b6fe-9d609cce6151 --image-pull-policy=never --cpu 1 --memory 512 ubuntu:latest sleep 3600; done
 for i in {1..18}; do openstack appcontainer run --name ext$i --net network=a6a90663-3aed-40a0-9817-89eaed5aef70 --image-pull-policy=never --cpu 1 --memory 512 ubuntu:latest sleep 3600; done
</code></pre>
<p>Test redroid:</p>
<pre><code> openstack appcontainer run --name testredroid --net network=a6a90663-3aed-40a0-9817-89eaed5aef70 --image-pull-policy ifnotpresent --cpu 4 --memory 8192 --privileged  redroid/redroid:9.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest
</code></pre>
<p>Use houdini12:</p>
<pre><code>for i in {1..3}; do openstack appcontainer run --name redroid12_$i --image-pull-policy=ifnotpresent --net network=a6a90663-3aed-40a0-9817-89eaed5aef70  --cpu 4 --memory 8192 --privileged 192.168.1.7:5000/redroidhoudini12:latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest; done
</code></pre>
<p>REsult:</p>
<pre><code>root@phone1:~# openstack appcontainer list
+--------------------------------------+-------------+------------------------------------------+---------+------------+-----------------+-------+
| uuid                                 | name        | image                                    | status  | task_state | addresses       | ports |
+--------------------------------------+-------------+------------------------------------------+---------+------------+-----------------+-------+
| 4103300a-9768-41dd-b930-b7549587c710 | redroid12_1 | 192.168.1.7:5000/redroidhoudini12:latest | Running | None       | 192.168.150.120 | []    |
| f198a224-6dc1-4f6c-aadf-46852aa90a2a | redroid12_2 | 192.168.1.7:5000/redroidhoudini12:latest | Running | None       | 192.168.150.104 | []    |
| ae000c1d-8c9f-4813-b41a-0283f251c6b1 | redroid12_3 | 192.168.1.7:5000/redroidhoudini12:latest | Running | None       | 192.168.150.107 | []    |
+--------------------------------------+-------------+------------------------------------------+---------+------------+-----------------+-------+

</code></pre>
<p>Change image validation options(image won't verification, line 44, from True to False):</p>
<pre><code>$ cat api.py
 43     cfg.BoolOpt('enable_image_validation',
 44                 default=False,
 45                 help="Enable image validation.")                                                                                                                                          
 46 ]
$ docker cp api.py zun_api:/var/lib/kolla/venv/lib/python2.7/site-packages/zun/conf/api.py
$ docker exec -it zun_api bash
# rm -f /var/lib/kolla/venv/lib/python2.7/site-packages/zun/conf/api.pyc
</code></pre>
<p>redroid 9 result:</p>
<p><img src="./images/2025_07_17_16_52_23_1417x966.jpg" alt="./images/2025_07_17_16_52_23_1417x966.jpg" /></p>
<p>virgl :</p>
<p><img src="./images/2025_07_17_17_10_18_538x387.jpg" alt="./images/2025_07_17_17_10_18_538x387.jpg" /></p>
<p><img src="./images/2025_07_17_17_10_37_457x183.jpg" alt="./images/2025_07_17_17_10_37_457x183.jpg" /></p>
<pre><code>Host machine:   

root@i9workstation:~# ls -l -h /dev/dri/by-path/
总计 0
lrwxrwxrwx 1 root root  8  7月 17 07:36 pci-0000:00:02.0-card -&gt; ../card2
lrwxrwxrwx 1 root root 13  7月 17 07:36 pci-0000:00:02.0-render -&gt; ../renderD129
lrwxrwxrwx 1 root root  8  7月 17 07:36 pci-0000:01:00.0-card -&gt; ../card0
lrwxrwxrwx 1 root root 13  7月 17 07:36 pci-0000:01:00.0-render -&gt; ../renderD128
lrwxrwxrwx 1 root root  8  7月 17 07:36 pci-0000:09:00.0-card -&gt; ../card1
root@i9workstation:~# lspci | grep -i vga
00:02.0 VGA compatible controller: Intel Corporation Raptor Lake-S GT1 [UHD Graphics 770] (rev 04)

root@phone1:~# dmesg | grep -i virgl
[    1.910583] [drm] virgl 3d acceleration enabled
</code></pre>
<p>Could not ping from outside, both inner/ext.</p>
<h3 id="3-homeredroid12-on-ubuntu1804queenszunrocky"><a class="header" href="#3-homeredroid12-on-ubuntu1804queenszunrocky">3. home(redroid12 on ubuntu1804QueensZunRocky)</a></h3>
<p>Create instance via:</p>
<pre><code>modprobe binder_linux devices="binder,hwbinder,vndbinder" ; modprobe ashmem_linux
for i in {1..3}; do openstack appcontainer run --name redroid12_$i --image-pull-policy=ifnotpresent --net network=835b8f8a-6181-402b-8e28-321bf71f1874  --cpu 4 --memory 8192 --privileged  redroidhoudini12:latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest; done
openstack appcontainer list
+--------------------------------------+-------------+-------------------------+---------+------------+-----------------+-------+
| uuid                                 | name        | image                   | status  | task_state | addresses       | ports |
+--------------------------------------+-------------+-------------------------+---------+------------+-----------------+-------+
| 5fdd8bde-6328-4f69-8f23-541df39657b2 | redroid12_1 | redroidhoudini12:latest | Running | None       | 192.168.150.161 | []    |
| d2054504-6465-42ab-a82c-436aebeacb25 | redroid12_2 | redroidhoudini12:latest | Running | None       | 192.168.150.168 | []    |
| 5d551da7-6fe5-411c-a98c-ec470fb0b7c1 | redroid12_3 | redroidhoudini12:latest | Running | None       | 192.168.150.177 | []    |
+--------------------------------------+-------------+-------------------------+---------+------------+-----------------+----
</code></pre>
<p>Each node has one:</p>
<pre><code>root@ubuntu1:~# docker ps | grep redroid
47db92adfcf8   redroidhoudini12:latest                                "/init qemu=1 androi…"   4 minutes ago       Up 4 minutes              zun-5fdd8bde-6328-4f69-8f23-541df39657b2

root@ubuntu2:~# docker ps | grep redroid
288843e8ca31   redroidhoudini12:latest                                "/init qemu=1 androi…"   3 minutes ago       Up 3 minutes              zun-5d551da7-6fe5-411c-a98c-ec470fb0b7c1

root@ubuntu3:~# docker ps | grep redroid
a1d4ee8bb3a6   redroidhoudini12:latest                                "/init qemu=1 androi…"   3 minutes ago       Up 3 minutes              zun-d2054504-6465-42ab-a82c-436aebeacb25
</code></pre>
<p>adb connect and adb shell:</p>
<pre><code>dash@archwayland:~$ adb connect 192.168.150.161
* daemon not running; starting now at tcp:5037
* daemon started successfully
connected to 192.168.150.161:5555
dash@archwayland:~$ adb connect 192.168.150.168
connected to 192.168.150.168:5555
dash@archwayland:~$ adb connect 192.168.150.177
connected to 192.168.150.177:5555
dash@archwayland:~$ adb devices
List of devices attached
192.168.150.161:5555	device
192.168.150.168:5555	device
192.168.150.177:5555	device

dash@archwayland:~$ adb -s 192.168.150.161:5555 shell
redroid_x86_64:/ $ getprop | grep boot | grep com                                                                                                                                           
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [2969097311287]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
redroid_x86_64:/ $ dumpsys SurfaceFlinger |grep GLES
GLES: Google Inc. (Google), ANGLE (Google, Vulkan 1.2.0 (SwiftShader Device (LLVM 10.0.0) (0x0000C0DE)), SwiftShader driver-5.0.0), OpenGL ES 3.1.0 (ANGLE 2.1.1 git hash: e37c6dd2e0e8)

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250718"><a class="header" href="#20250718">20250718</a></h1>
<h3 id="1-kollaubuntu1804queenszunkuryrrocky"><a class="header" href="#1-kollaubuntu1804queenszunkuryrrocky">1. kolla(ubuntu1804+queens+zun/kuryrRocky)</a></h3>
<p>Re-deploy, then everything goes well.</p>
<h3 id="2-modprobe-at-boot"><a class="header" href="#2-modprobe-at-boot">2. modprobe at boot</a></h3>
<p>Edit following files and added :</p>
<pre><code># vim /etc/modules-load.d/modules.conf
binder_linux
# vim /etc/modprobed/mdadm.conf
...
options binder_linux devices="binder,hwbinder,vndbinder"
# update-initramfs -u -k all
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250721"><a class="header" href="#20250721">20250721</a></h1>
<h3 id="1-centos-queens-zun-deployment"><a class="header" href="#1-centos-queens-zun-deployment">1. CentOS queens zun deployment</a></h3>
<p>3 nodes with replaced docker images(<code>rocky-&gt;queens</code>):</p>
<pre><code>[root@queen1 kolla]# docker images | grep zun | grep rocky
kolla/centos-source-zun-compute                   rocky           384975e8ebb3   5 years ago     1.07GB
kolla/centos-source-zun-api                       rocky           4293ca2bb6b1   5 years ago     1.04GB
[root@queen1 kolla]# docker images | grep kuryr | grep rocky
kolla/centos-source-kuryr-libnetwork              rocky           1eb87543a31b   5 years ago     953MB
</code></pre>
<p>When create ext nework , failed  with :</p>
<p><img src="./images/2025_07_21_09_26_16_648x206.jpg" alt="./images/2025_07_21_09_26_16_648x206.jpg" /></p>
<p>issue:</p>
<pre><code>Unable to establish connection to http://10.171.172.24:9517/v1/containers?run=true: ('Connection aborted.', error(110, '\xe8\xbf\x9e\xe6\x8e\xa5\xe8\xb6\x85\xe6\x97\xb6'))
Failed to discover available identity versions when contacting http://10.171.172.24:35357/v3. Attempting to parse version from URL.
Unable to establish connection to http://10.171.172.24:35357/v3/auth/tokens: HTTPConnectionPool(host='10.171.172.24', port=35357): Max retries exceeded with url: /v3/auth/tokens (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x7f60a3d8c0d0&gt;: Failed to establish a new connection: [Errno 113] \xe6\xb2\xa1\xe6\x9c\x89\xe5\x88\xb0\xe4\xb8\xbb\xe6\x9c\xba\xe7\x9a\x84\xe8\xb7\xaf\xe7\x94\xb1',))
Failed to discover available identity versions when contacting http://10.171.172.24:35357/v3. Attempting to parse version from URL.
Unable to establish connection to http://10.171.172.24:35357/v3/auth/tokens: HTTPConnectionPool(host='10.171.172.24', port=35357): Max retries exceeded with url: /v3/auth/tokens (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x7f529babd0d0&gt;: Failed to establish a new connection: [Errno 113] \xe6\xb2\xa1\xe6\x9c\x89\xe5\x88\xb0\xe4\xb8\xbb\xe6\x9c\xba\xe7\x9a\x84\xe8\xb7\xaf\xe7\x94\xb1',))

</code></pre>
<h3 id="2-centos-queens-zun-deploymentlinuxbridge-mode"><a class="header" href="#2-centos-queens-zun-deploymentlinuxbridge-mode">2. CentOS queens zun deployment(linuxbridge mode)</a></h3>
<p>The same issue as above./</p>
<h3 id="3-dadfailed-issue"><a class="header" href="#3-dadfailed-issue">3. dadfailed issue</a></h3>
<p>issue:</p>
<pre><code>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:f1:14:6a brd ff:ff:ff:ff:ff:ff
    inet 10.171.172.23/24 brd 10.171.172.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::43ae:554e:9564:d787/64 scope link tentative noprefixroute dadfailed 
       valid_lft forever preferred_lft forever
    inet6 fe80::f07e:e9f6:352b:994c/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

</code></pre>
<p>solved via:</p>
<pre><code>[root@queen3 ~]# cat /etc/machine-id 
334e69d6bacf423a8b821ba7a3cdd9a4
[root@queen3 ~]# sudo chmod ugo+w /etc/machine-id
[root@queen3 ~]# sudo cat /dev/null &gt; /etc/machine-id
[root@queen3 ~]# sudo systemd-machine-id-setup
Initializing machine ID from KVM UUID.
[root@queen3 ~]# sudo chmod ugo-w /etc/machine-id
[root@queen3 ~]# cat /etc/machine-id 
ec8dd68a129e4eeab9b31bbf9e5701a5
</code></pre>
<h3 id="4-enable-virsh-console"><a class="header" href="#4-enable-virsh-console">4. enable virsh console</a></h3>
<p>Via:</p>
<pre><code>sudo systemctl enable serial-getty@ttyS0.service --now
</code></pre>
<p>Then <code>virsh console vmname</code> you could get a console login.</p>
<h3 id="5-redeploy-queensubuntu"><a class="header" href="#5-redeploy-queensubuntu">5. redeploy queens(ubuntu)</a></h3>
<p>Use docker images then retag:</p>
<pre><code>docker load&lt;1804zunphoneimages.tar &amp;&amp; docker load&lt;etcd.tar &amp;&amp; docker load&lt;rocky.tar
docker rmi kolla/ubuntu-source-zun-api:queens kolla/ubuntu-source-zun-api:queensback kolla/ubuntu-source-zun-compute:queens kolla/ubuntu-source-zun-compute:queensback &amp;&amp; docker tag kolla/ubuntu-source-zun-compute:rocky kolla/ubuntu-source-zun-compute:queens &amp;&amp; docker tag kolla/ubuntu-source-zun-api:rocky kolla/ubuntu-source-zun-api:queens &amp;&amp; docker rmi kolla/ubuntu-source-kuryr-libnetwork:queens &amp;&amp; docker tag kolla/ubuntu-source-kuryr-libnetwork:rocky kolla/ubuntu-source-kuryr-libnetwork:queens
</code></pre>
<h3 id="6-os-verification-environment"><a class="header" href="#6-os-verification-environment">6. OS verification environment</a></h3>
<p>Create a new network:</p>
<p><img src="./images/2025_07_21_20_23_42_667x618.jpg" alt="./images/2025_07_21_20_23_42_667x618.jpg" /></p>
<p>Disable dhcppv4:</p>
<p><img src="./images/2025_07_21_20_24_41_397x328.jpg" alt="./images/2025_07_21_20_24_41_397x328.jpg" /></p>
<p>Create vm via import existing disk image:</p>
<p><img src="./images/2025_07_21_20_25_42_519x528.jpg" alt="./images/2025_07_21_20_25_42_519x528.jpg" /></p>
<p>Select <code>ubuntu1804_mixed_deploy_10.171.172.41.qcow2</code>:</p>
<p><img src="./images/2025_07_21_20_26_13_934x637.jpg" alt="./images/2025_07_21_20_26_13_934x637.jpg" /></p>
<p>Select <code>Ubuntu 18.04 LTS</code> for installing options:</p>
<p><img src="./images/2025_07_21_20_26_50_511x509.jpg" alt="./images/2025_07_21_20_26_50_511x509.jpg" /></p>
<p>specify memory/cpu:</p>
<p><img src="./images/2025_07_21_20_27_26_505x329.jpg" alt="./images/2025_07_21_20_27_26_505x329.jpg" /></p>
<p>Specify the vm name:</p>
<p><img src="./images/2025_07_21_20_28_04_515x523.jpg" alt="./images/2025_07_21_20_28_04_515x523.jpg" /></p>
<p>Add 41vdb.qcow2 for the second vm disk:</p>
<p><img src="./images/2025_07_21_20_28_33_739x554.jpg" alt="./images/2025_07_21_20_28_33_739x554.jpg" /></p>
<p>Select <code>10.171.172_network</code> for the network source:</p>
<p><img src="./images/2025_07_21_20_29_14_697x361.jpg" alt="./images/2025_07_21_20_29_14_697x361.jpg" /></p>
<p>Add the second network which also uses the same network:</p>
<p><img src="./images/2025_07_21_20_29_46_700x601.jpg" alt="./images/2025_07_21_20_29_46_700x601.jpg" /></p>
<p><img src="./images/2025_07_21_20_30_02_819x555.jpg" alt="./images/2025_07_21_20_30_02_819x555.jpg" /></p>
<p>click <code>Beging installation</code> for starting the created vm:</p>
<p><img src="./images/2025_07_21_20_30_31_808x424.jpg" alt="./images/2025_07_21_20_30_31_808x424.jpg" /></p>
<p>Imported another 2 vms, 3-nodes cluster listed as:</p>
<p><img src="./images/2025_07_21_20_33_40_1546x1027.jpg" alt="./images/2025_07_21_20_33_40_1546x1027.jpg" /></p>
<p>Examine the environment:</p>
<pre><code>ssh root@10.171.172.41

......

root@ubuntu1:~# source /etc/kolla/admin-openrc.sh 
root@ubuntu1:~# openstack appcontainer list
+--------------------------------------+------------+------------------------------+---------+---------------------+----------------+-------+
| uuid                                 | name       | image                        | status  | task_state          | addresses      | ports |
+--------------------------------------+------------+------------------------------+---------+---------------------+----------------+-------+
| f99294a3-e747-4001-a639-506354970756 | redroid9_1 | redroid/redroid:9.0.0-latest | Running | None                | 10.171.172.171 | []    |
| 70139649-9b5d-4190-b721-ffdc67c48db2 | redroid9_2 | redroid/redroid:9.0.0-latest | Stopped | container_rebooting | 10.171.172.178 | []    |
| 39474c90-8ca0-4ca7-8a21-09ab9ab859f0 | redroid9_3 | redroid/redroid:9.0.0-latest | Running | None                | 10.171.172.168 | []    |
+--------------------------------------+------------+------------------------------+---------+---------------------+----------------+-------+

</code></pre>
<p>Fetch the horizon password:</p>
<pre><code>root@ubuntu1:~# cat /etc/kolla/passwords.yml | grep -i keystone_admin
keystone_admin_password: hO3wJGfQZzig1t2eUZsSKwAbnUTprpel27FO2hx4
</code></pre>
<p>login with admin and <code>keystone_admin_password</code>:</p>
<p><img src="./images/2025_07_21_20_37_21_831x647.jpg" alt="./images/2025_07_21_20_37_21_831x647.jpg" /></p>
<p>bug-fix for disable image validation:</p>
<pre><code>$  docker cp zun_api:/var/lib/kolla/venv/lib/python2.7/site-packages/zun/conf/api.py .
$ cat api.py
 43     cfg.BoolOpt('enable_image_validation',
 44                 default=False,
 45                 help="Enable image validation.")                                                                                                                                          
 46 ]
$ docker cp api.py zun_api:/var/lib/kolla/venv/lib/python2.7/site-packages/zun/conf/api.py
$ docker exec -it zun_api bash
# rm -f /var/lib/kolla/venv/lib/python2.7/site-packages/zun/conf/api.pyc
# exit
$ docker restart zun_api
</code></pre>
<p>Start the container:</p>
<p><img src="./images/2025_07_21_20_38_06_1268x492.jpg" alt="./images/2025_07_21_20_38_06_1268x492.jpg" /></p>
<pre><code># openstack appcontainer show redroid9_1 | grep status_reason
| status_reason     | Docker internal error: 500 Server Error: Internal Server Error ("IpamDriver.RequestAddress: Requested ip address {'subnet_id': u'9171905d-523a-4374-bddd-d3699a59f65b', 'ip_address': u'10.171.172.171'} already belongs to a bound Neutron port: a3f3373d-3a61-4a13-95b3-958a9945a0e0"). 
</code></pre>
<p>Stop and recreate again:</p>
<pre><code>for i in {1..3}; do openstack appcontainer stop redroid9_$i; done
for i in {1..3}; do openstack appcontainer delete redroid9_$i; done
</code></pre>
<p>Create the appcontainer instance via:</p>
<pre><code># openstack appcontainer run --name redroid9_ubuntu1 --image-pull-policy=ifnotpresent --net network=15723fae-abdd-4a22-8c11-73607fbda740 --cpu 4 --memory 8192 --privileged --host ubuntu1 redroid/redroid:9.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest androidboot.redroid_fps=120
Internal Server Error (HTTP 500) (Request-ID: req-21a92c7c-e33d-46de-b2c6-45b823789a7e)

</code></pre>
<p>After apply the above image validation bugfix, create:</p>
<pre><code>openstack appcontainer run --name redroid9_ubuntu1 --image-pull-policy=ifnotpresent --net network=15723fae-abdd-4a22-8c11-73607fbda740 --cpu 4 --memory 8192 --privileged --host ubuntu1 redroid/redroid:9.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest androidboot.redroid_fps=120
openstack appcontainer run --name redroid9_ubuntu3 --image-pull-policy=ifnotpresent --net network=15723fae-abdd-4a22-8c11-73607fbda740 --cpu 4 --memory 8192 --privileged --host ubuntu3 redroid/redroid:9.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest androidboot.redroid_fps=120
openstack appcontainer run --name redroid9_ubuntu3 --image-pull-policy=ifnotpresent --net network=15723fae-abdd-4a22-8c11-73607fbda740 --cpu 4 --memory 8192 --privileged --host ubuntu3 redroid/redroid:9.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest androidboot.redroid_fps=120
</code></pre>
<p>Examine the result:</p>
<pre><code># openstack appcontainer list
+--------------------------------------+------------------+------------------------------+---------+------------+----------------+-------+
| uuid                                 | name             | image                        | status  | task_state | addresses      | ports |
+--------------------------------------+------------------+------------------------------+---------+------------+----------------+-------+
| 599aea74-f487-4545-b366-6b38c7b15431 | redroid9_ubuntu1 | redroid/redroid:9.0.0-latest | Running | None       | 10.171.172.181 | []    |
| 882f5554-2eb9-48d9-a880-8ec861aa8a6d | redroid9_ubuntu2 | redroid/redroid:9.0.0-latest | Running | None       | 10.171.172.172 | []    |
| 3f4d8f74-69b4-4d3f-9a69-5b94add17c85 | redroid9_ubuntu3 | redroid/redroid:9.0.0-latest | Running | None       | 10.171.172.180 | []    |
+--------------------------------------+------------------+------------------------------+---------+------------+----------------+-------+
root@ubuntu1:~# docker ps | grep zun | grep 599aea74
77fa40f90722   redroid/redroid:9.0.0-latest                           "/init qemu=1 androi…"   3 minutes ago   Up 3 minutes              zun-599aea74-f487-4545-b366-6b38c7b15431
</code></pre>
<p>Login to ubuntu2, verify the instance:</p>
<pre><code>root@ubuntu2:~# docker ps | grep zun | grep 882f
791b49035b5f   redroid/redroid:9.0.0-latest                           "/init qemu=1 androi…"   3 minutes ago   Up 3 minutes              zun-882f5554-2eb9-48d9-a880-8ec861aa8a6d
root@ubuntu2:~# docker exec -it 791b49035b5f sh
ubuntu2:/ # getprop | grep boot | grep com                                                                                                                                                                                                                  
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [1381625505509]
[sys.boot_completed]: [1]
[sys.logbootcomplete]: [1]
</code></pre>
<p>Login to ubuntu3 , verify the instance:</p>
<pre><code>root@ubuntu3:~# docker ps | grep zun | grep redroid
1b9998f0726b   redroid/redroid:9.0.0-latest                           "/init qemu=1 androi…"   4 minutes ago   Up 4 minutes              zun-3f4d8f74-69b4-4d3f-9a69-5b94add17c85
root@ubuntu3:~# docker exec -it zun-3f4d8f74-69b4-4d3f-9a69-5b94add17c85 sh
ubuntu3:/ # getprop |grep boot | grep com                                                                                                                                                                                                                   
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [1309493725053]
[sys.boot_completed]: [1]
[sys.logbootcomplete]: [1]
</code></pre>
<p>Stop and delete instance:</p>
<pre><code> for i in {1..3}; do openstack appcontainer stop redroid9_ubuntu$i; done
 for i in {1..3}; do openstack appcontainer delete redroid9_ubuntu$i; done
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250722"><a class="header" href="#20250722">20250722</a></h1>
<h3 id="1-queens-deployment-with-arm64"><a class="header" href="#1-queens-deployment-with-arm64">1. queens deployment with arm64</a></h3>
<p>Install ubuntu18.04, make serial port as the default output.</p>
<p>1804 arm64 pip install:</p>
<pre><code>apt install -y python-pip
pip install docker
pip install --upgrade pip
apt-get install -y python-dev libffi-dev gcc libssl-dev python-selinux python-setuptools build-essential
pip install  netaddr 
pip install pyyaml==5.3.1
pip install wrapt==1.8.0
pip install   oslo_config
</code></pre>
<p>destroy the cluster, then, in controller node:</p>
<pre><code>vim /etc/kolla/multinode
kolla-ansible  -i ./multinode bootstrap-servers
kolla-ansible -i ./multinode prechecks
kolla-ansible -i ./multinode pull
</code></pre>
<p>Before deployment, pull the rocky version docker image, tag to queens version:</p>
<pre><code>docker pull kolla/ubuntu-source-kuryr-libnetwork:rocky &amp;&amp; docker pull kolla/ubuntu-source-zun-compute:rocky
docker tag kolla/ubuntu-source-kuryr-libnetwork:rocky kolla/ubuntu-source-kuryr-libnetwork:queens
docker tag kolla/ubuntu-source-zun-compute:rocky kolla/ubuntu-source-zun-compute:queens
</code></pre>
<p>Deploy failed with:</p>
<pre><code>RUNNING HANDLER [common : Initializing toolbox container using normal user] ******************************************************************************************************************
fatal: [ubuntuarm]: FAILED! =&gt; {"changed": false, "cmd": ["docker", "exec", "-t", "kolla_toolbox", "ansible", "--version"], "delta": "0:00:00.022448", "end": "2025-07-22 10:39:15.421532", "msg": "non-zero return code", "rc": 1, "start": "2025-07-22 10:39:15.399084", "stderr": "Error response from daemon: Container b53c68d0a320a92bc4d642acd8a7a6801fd62a9cbfa67ccc0c345c990081edcc is restarting, wait until the container is running", "stderr_lines": ["Error response from daemon: Container b53c68d0a320a92bc4d642acd8a7a6801fd62a9cbfa67ccc0c345c990081edcc is restarting, wait until the container is running"], "stdout": "", "stdout_lines": []}
ok: [ubuntu3]
ok: [ubuntu1]
ok: [ubuntu2]
</code></pre>
<p>Reason:</p>
<pre><code>root@ubuntuarm:~# docker run -it kolla/ubuntu-source-kolla-toolbox:queens /bin/bash
WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested
exec /usr/local/bin/dumb-init: exec format error

</code></pre>
<h3 id="2-openstack-ansible-deployment"><a class="header" href="#2-openstack-ansible-deployment">2. OpenStack-Ansible deployment</a></h3>
<p>Refers to:</p>
<p><code>https://docs.openstack.org//project-deploy-guide/openstack-ansible/latest/deploy-guide-openstack-ansible.pdf</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250723"><a class="header" href="#20250723">20250723</a></h1>
<h3 id="1-bug-fix-for-queens-deploy"><a class="header" href="#1-bug-fix-for-queens-deploy">1. bug-fix for queens deploy</a></h3>
<p>Change <code>zun.conf.j2</code> for adding [oslo] related items.</p>
<p>enable policy :</p>
<pre><code># ls /etc/kolla/config/zun/policy.json 
/etc/kolla/config/zun/policy.json
</code></pre>
<h3 id="2-queens-base-image"><a class="header" href="#2-queens-base-image">2. queens base image</a></h3>
<p>Install minimum ubuntu18.04.6 with hwe kernel , then :</p>
<pre><code>sudo passwd root
sudo vim /etc/ssh/sshd_config
    PermitRootLogin
ssh-keygen
ssh-copy-id root@127.0.0.1
</code></pre>
<p>Install docker:</p>
<pre><code>export DOWNLOAD_URL="https://mirrors.tuna.tsinghua.edu.cn/docker-ce"
curl -fsSL https://raw.githubusercontent.com/docker/docker-install/master/install.sh | sh
apt install docker-ce=5:20.10.24~3-0~ubuntu-bionic
ufw disable
apt update -y
apt-mark hold docker-ce
apt upgrade -y
vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="net.ifnames=0 biosdevname=0"
update-grub2
reboot
</code></pre>
<p>After reboot:</p>
<pre><code>apt install -y python-pip
apt install -y git python3-dev libffi-dev build-essential libssl-dev
mkdir -p /etc/systemd/system/docker.service.d/
vim /etc/systemd/system/docker.service.d/kolla.conf
    [Service]
    MountFlags=shared
    ExecStart=
    # ExecStart commandline copied from 'docker-ce' package. Same on CentOS/Debian/Ubuntu systems.
    ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375 
    #--cluster-store=etcd://192.168.150.81:2379
systemctl daemon-reload
systemctl restart docker
apt install python3-openstackclient
pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
pip install netaddr -i https://pypi.tuna.tsinghua.edu.cn/simple
pip install python-zunclient -i https://pypi.tuna.tsinghua.edu.cn/simple
apt install -y nfs-common
mount 192.168.1.8:/media/sda /mnt
docker load&lt;/mnt/iso/kolla_queens_ubuntu.tar
apt remove apparmor --purge
vim /etc/systemd/system.conf
systemctl daemon-reload
</code></pre>
<p>Deploy:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250724"><a class="header" href="#20250724">20250724</a></h1>
<h3 id="1-deploy-tips"><a class="header" href="#1-deploy-tips">1. deploy tips</a></h3>
<p>Record as following:</p>
<pre><code>  vim /etc/systemd/system/docker.service.d/kolla.conf 
  systemctl daemon-reload&amp;&amp; systemctl restart docker
  scp dash@192.168.1.208:~/kolla_deploy_20250723.tar.gz .
  tar xzvf kolla_deploy_20250723.tar.gz 
  tar xzvf deploy/kolla-ansible.tar.gz 
  rm -f /etc/resolv.conf  &amp;&amp; echo 'nameserver 223.5.5.5'&gt;/etc/resolv.conf &amp;&amp; chattr +i /etc/resolv.conf 
  pip install virtualenv -i https://pypi.tuna.tsinghua.edu.cn/simple
  mkdir ~/kolla &amp;&amp; virtualenv ~/kolla/virtualenv &amp;&amp; source ~/kolla/virtualenv/bin/activate
  cd ~/kolla-ansible/
  pip install -r requirements.txt  -i https://pypi.tuna.tsinghua.edu.cn/simple &amp;&amp; pip install .
  mkdir -p /etc/kolla
  cp etc/kolla/* /etc/kolla/
  rm -rf /root/kolla/./virtualenv/share/kolla-ansible/ansible
  tar xzvf /root/deploy/ansible.tar.gz  -C /root/kolla/./virtualenv/share/kolla-ansible/
  cd /etc/kolla/
  cp -r /root/deploy/config/ .
  cp /root/deploy/multinode  .
  cp /root/deploy/globals.yml  .
  vim globals.yml 
  pvcreate /dev/vdb &amp;&amp; vgcreate cinder-volumes /dev/vdb
  ssh root@kolla1
  ssh root@kolla2
  ssh root@kolla3
  apt install -y ansible
  kolla-genpwd 
  kolla-ansible  -i ./multinode bootstrap-servers
  kolla-ansible prechecks -i ./multinode -e prechecks_enable_host_ntp_checks=false
  kolla-ansible  -i ./multinode deploy &amp;&amp; kolla-ansible  -i ./multinode post-deploy

  pip install keystoneauth1==4.0.0
  source /etc/kolla/admin-openrc.sh 
  openstack endpoint list
  vim /usr/local/lib/python2.7/dist-packages/openstack/utils.py
  vim /usr/local/lib/python2.7/dist-packages/openstack/cloud/openstackcloud.py
  openstack endpoint list
  openstack appcontainer host list
  docker exec -it --user root zun_api bash 
  docker exec -it --user root zun_compute bash 
  docker restart zun_compute
  docker restart zun_api
  modprobe binder_linux devices="binder,hwbinder,vndbinder" ; modprobe ashmem_linux
  openstack router create Ext-Router
  openstack network create --internal --provider-network-type vxlan int-net
  openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
  openstack router add subnet Ext-Router int-net-sub
  openstack network create --provider-physical-network physnet1 --provider-network-type flat  --external ext-net
  openstack subnet create ext-net-sub --network ext-net --subnet-range 192.168.150.24/24 --allocation-pool start=192.168.150.160,end=192.168.150.220 --gateway 192.168.150.1 --dns-nameserver 114.114.114.114 --dhcp
  openstack router set Ext-Router --external-gateway ext-net
  openstack network list
  for i in {1..3}; do openstack appcontainer run --name redroid12_$i --image-pull-policy=ifnotpresent --net network=9ee027de-771c-4025-a351-ef2e21efc2b3 --cpu 4 --memory 8192 --privileged redroid/redroid:9.0.0-latest  androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest; done
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250725"><a class="header" href="#20250725">20250725</a></h1>
<h3 id="1-kolla-ansible-on-arm64"><a class="header" href="#1-kolla-ansible-on-arm64">1. kolla-ansible on arm64</a></h3>
<p>x86 cluster:</p>
<pre><code>10.171.172.51   kolla1
10.171.172.52   kolla2
10.171.172.53   kolla3
</code></pre>
<p>Deploy cluster as before.</p>
<p>Add a new node:</p>
<pre><code>10.171.172.53   kollaarm
</code></pre>
<p>No docker image for ubuntu aarch64.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250728"><a class="header" href="#20250728">20250728</a></h1>
<h3 id="1-debianarm64-kolla"><a class="header" href="#1-debianarm64-kolla">1. debian(arm64) kolla</a></h3>
<p>Debian arm, system info:</p>
<pre><code>root@debiankolla:~# free -m
               total        used        free      shared  buff/cache   available
Mem:           19972         339       19731           4         108       19633
Swap:            976           0         976
root@debiankolla:~# cat /etc/issue
Debian GNU/Linux 12 \n \l
root@debiankolla:~# uname -a
Linux debiankolla 6.1.0-35-arm64 #1 SMP Debian 6.1.137-1 (2025-05-07) aarch64 GNU/Linux
</code></pre>
<p>Install required packages:</p>
<pre><code>apt install -y vim nethogs sudo iotop
sudo apt install git python3-dev libffi-dev python3-venv gcc libssl-dev git python3-pip python3-full
</code></pre>
<p>Virtual env:</p>
<pre><code>python3 -m venv $HOME/kolla-openstack
source $HOME/kolla-openstack/bin/activate
pip install -U pip
pip install 'ansible&gt;=8,&lt;9'
vim $HOME/ansible.cfg
[defaults]
host_key_checking=False
pipelining=True
forks=100
pip install git+https://opendev.org/openstack/kolla-ansible@stable/2024.2
</code></pre>
<p>Create the kolla deployment files:</p>
<pre><code># mkdir /etc/kolla
# cp /root/kolla-openstack/share/kolla-ansible/etc_examples/kolla/* /etc/kolla/
# ls /etc/kolla/
globals.yml  passwords.yml
# cp /root/kolla-openstack/share/kolla-ansible/ansible/inventory/all-in-one .
</code></pre>
<p>Create lvm:</p>
<pre><code>apt install -y lvm2
Create lvms as before.  
</code></pre>
<p>Gen password:</p>
<pre><code>kolla-genpwd
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"
sudo dpkg-reconfigure locales
reboot
 kolla-ansible install-deps
</code></pre>
<p>Deploy:</p>
<pre><code>cd /etc/kolla
kolla-ansible bootstrap-servers -i all-in-one
apt install -y pkg-config libdbus-1-dev libglib2.0-dev
pip install docker
pip install dbus-python
kolla-ansible prechecks -i all-in-one
kolla-ansible deploy -i all-in-one
kolla-ansible post-deploy -i all-in-one
pip install python-zunclient
openstack appcontainer host list
</code></pre>
<p>Upgrade kernel for supporing redroid:</p>
<pre><code>sudo apt-get install build-essential linux-source bc kmod cpio flex libncurses5-dev libelf-dev libssl-dev dwarves bison
cd /usr/src
tar xJvf linux-source-6.1.tar.xz
cd linux-source-6.1
make menuconfig
### Open some configs
make -j`nproc` bindeb-pkg
ls ../*.deb
../linux-headers-6.1.137hhhddd_6.1.137hhhddd-2_arm64.deb
../linux-image-6.1.137hhhddd_6.1.137hhhddd-2_arm64.deb
../linux-image-6.1.137hhhddd-dbg_6.1.137hhhddd-2_arm64.deb
../linux-libc-dev_6.1.137hhhddd-2_arm64.deb
cd ..
apt install ./linux-headers-6.1.137hhhddd_6.1.137hhhddd-2_arm64.deb ./linux-image-6.1.137hhhddd_6.1.137hhhddd-2_arm64.deb
reboot
</code></pre>
<p>Examine the result:</p>
<pre><code># cat /boot/config-6.1.137hhhddd | grep -i binder
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ANDROID_BINDERFS=y
CONFIG_ANDROID_BINDER_DEVICES="binder,hwbinder,vndbinder"
</code></pre>
<p>Edit privileged related items:</p>
<pre><code>cd /etc/kolla
vim zun-api/zun.conf 
vim zun-compute/zun.conf 
vim zun-wsproxy/zun.conf 
vim zun-cni-daemon/zun.conf

docker cp policy.json zun_api:/etc/zun/
docker cp policy.json zun_compute:/etc/zun/
docker cp policy.json zun_wsproxy:/etc/zun/
docker cp policy.json zun_cni_daemon:/etc/zun

docker restart zun_compute &amp;&amp; docker restart zun_api &amp;&amp; docker restart zun_wsproxy &amp;&amp; docker restart zun_cni_daemon
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250729"><a class="header" href="#20250729">20250729</a></h1>
<h3 id="1-macos-partition"><a class="header" href="#1-macos-partition">1. macos partition</a></h3>
<p>Wipe:</p>
<p><img src="./images/2025_07_29_08_47_12_505x313.jpg" alt="./images/2025_07_29_08_47_12_505x313.jpg" /></p>
<h3 id="2-macos-virt-manager"><a class="header" href="#2-macos-virt-manager">2. macos virt-manager</a></h3>
<p>Add a bridge interface:</p>
<p><img src="./images/2025_07_29_09_37_43_534x438.jpg" alt="./images/2025_07_29_09_37_43_534x438.jpg" /></p>
<p>Use qemu for installation of debian:</p>
<pre><code>sudo /opt/homebrew/bin/qemu-system-aarch64  -M virt,highmem=on,gic-version=3 \
  -cpu cortex-a72 \
-smp 8 -m 12800M -accel hvf \
  -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \
  -device virtio-scsi-device \
  -device scsi-hd,drive=hd0 \
  -drive if=none,id=hd0,format=qcow2,file=/Volumes/fsy/images/debian.qcow2 \
  -device scsi-cd,drive=cd0 \
  -drive if=none,id=cd0,format=raw,media=cdrom,readonly=on,file=/Volumes/fsy/images/debian-12.9.0-arm64-DVD-1.iso \
  -netdev vmnet-bridged,id=net0,ifname=en0 \
  -device virtio-net-pci,netdev=net0,mac=42:5c:38:00:09:f3 \
  -nographic \
  -monitor none \
  -serial stdio
</code></pre>
<p>After installation, change iso from debian to virtio.</p>
<p>openstack node configuration:</p>
<pre><code>sudo /opt/homebrew/bin/qemu-system-aarch64  -M virt,highmem=on,gic-version=3 \
  -cpu cortex-a72 \
-smp 10 -m 12800M -accel hvf \
  -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \
  -device virtio-scsi-device \
  -device scsi-hd,drive=hd0 \
  -drive if=none,id=hd0,format=qcow2,file=/Volumes/fsy/images/debian.qcow2 \
  -device scsi-hd,drive=hd1 \
  -drive if=none,id=hd1,format=qcow2,file=/Volumes/fsy/images/debianvdb.qcow2 \
  -device scsi-cd,drive=cd0 \
  -drive if=none,id=cd0,format=raw,media=cdrom,readonly=on,file=/Volumes/fsy/images/virtio-win-0.1.266.iso \
  -netdev vmnet-bridged,id=net0,ifname=en0 \
  -device virtio-net-pci,netdev=net0,mac=42:5c:38:00:09:f3 \
  -netdev vmnet-bridged,id=net1,ifname=en0 \
  -device virtio-net-pci,netdev=net1,mac=42:5c:38:00:09:33 \
  -nographic \
  -monitor none \
  -serial stdio
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250730"><a class="header" href="#20250730">20250730</a></h1>
<h3 id="1-debian12x86-kolla-deployment"><a class="header" href="#1-debian12x86-kolla-deployment">1. debian12(x86) kolla deployment</a></h3>
<p>3 nodes, for verification of networking.</p>
<p>After deployment, do following:</p>
<pre><code># openstack key delete mykey
# openstack image delete cirros
# ./init-runonce 
</code></pre>
<p>3 nodes, network won't acts well.</p>
<h3 id="2-ubuntux86-kolla-allinone"><a class="header" href="#2-ubuntux86-kolla-allinone">2. ubuntu(x86) kolla allinone</a></h3>
<p>works well.</p>
<h3 id="3-redroid-tips"><a class="header" href="#3-redroid-tips">3. redroid tips</a></h3>
<p>Create via:</p>
<pre><code>openstack appcontainer run --name  testredroid --image-pull-policy=ifnotpresent --net network=81bf642a-72c6-4222-acb8-68ff89abe231 --cpu 4 --memory 4096 redroid/redroid:13.0.0-latest androidboot.redroid_width=1080     androidboot.redroid_height=1920     androidboot.redroid_dpi=480 androidboot.redroid_gpu_mode=guest
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250731"><a class="header" href="#20250731">20250731</a></h1>
<h3 id="1-kolla-ansiblex86aarch64"><a class="header" href="#1-kolla-ansiblex86aarch64">1. kolla-ansible(x86+aarch64)</a></h3>
<p>Failed via following commands:</p>
<pre><code>TASK [neutron : Running Neutron bootstrap container] *****************************************************************************************************************************************
fatal: [debiankolla -&gt; kolla1]: FAILED! =&gt; {"changed": true, "msg": "Container exited with non-zero return code 1", "rc": 1, "stderr": "+ sudo -E kolla_set_configs\nINFO:__main__:Loading config file at /var/lib/kolla/config_files/config.json\nINFO:__main__:Validating config file\nINFO:__main__:Kolla config strategy set to: COPY_ALWAYS\nINFO:__main__:Copying service configuration files\nINFO:__main__:Copying /var/lib/kolla/config_files/neutron.conf to /etc/neutron/neutron.conf\nINFO:__main__:Setting permission for /etc/neutron/neutron.conf\nINFO:__main__:Copying /var/lib/kolla/config_files/neutron_vpnaas.conf to /etc/neutron/neutron_vpnaas.conf\nINFO:__main__:Setting permission for /etc/neutron/neutron_vpnaas.conf\nINFO:__main__:Copying /var/lib/kolla/config_files/ml2_conf.ini to /etc/neutron/plugins/ml2/ml2_conf.ini\nINFO:__main__:Setting permission for /etc/neutron/plugins/ml2/ml2_conf.ini\nINFO:__main__:Copying /var/lib/kolla/config_files/id_rsa to /var/lib/neutron/.ssh/id_rsa\nINFO:__main__:Setting permission for /var/lib/neutron/.ssh/id_rsa\nINFO:__main__:Writing out command to execute\nINFO:__main__:Setting permission for /var/log/kolla/neutron\nINFO:__main__:Setting permission for /var/log/kolla/neutron/dnsmasq.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-l3-agent.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-metadata-agent.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-server.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/privsep-helper.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-dhcp-agent.log\nINFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-openvswitch-agent.log\n++ cat /run_command\n+ CMD='neutron-server --config-file /etc/neutron/neutron.conf  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini --config-file /etc/neutron/neutron_vpnaas.conf '\n+ ARGS=\n+ sudo kolla_copy_cacerts\n+ sudo kolla_install_projects\n+ [[ ! -n '' ]]\n+ . kolla_extend_start\n++ [[ ! -d /var/log/kolla/neutron ]]\n+++ stat -c %a /var/log/kolla/neutron\n++ [[ 2755 != \\7\\5\\5 ]]\n++ chmod 755 /var/log/kolla/neutron\n++ [[ ! debian =~ centos|rocky ]]\n++ /usr/bin/update-alternatives --display iptables\n++ KOLLA_LEGACY_IPTABLES=false\n++ [[ false == \\t\\r\\u\\e ]]\n++ sudo /usr/bin/update-alternatives --auto iptables\n++ sudo /usr/bin/update-alternatives --auto ip6tables\n++ . /usr/local/bin/kolla_neutron_extend_start\n+++ [[ -n 0 ]]\n+++ neutron-db-manage --subproject neutron upgrade head\nINFO  [alembic.runtime.migration] Context impl MySQLImpl.\nINFO  [alembic.runtime.migration] Will assume non-transactional DDL.\nTraceback (most recent call last):\n  File \"/var/lib/kolla/venv/bin/neutron-db-manage\", line 8, in &lt;module&gt;\n    sys.exit(main())\n             ^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 668, in main\n    return_val |= bool(CONF.command.func(config, CONF.command.name))\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 189, in do_upgrade\n    run_sanity_checks(config, revision)\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 651, in run_sanity_checks\n    script_dir.run_env()\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/base.py\", line 582, in run_env\n    util.load_python_file(self.dir, \"env.py\")\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 95, in load_python_file\n    module = load_module_py(module_id, path)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 113, in load_module_py\n    spec.loader.exec_module(module)  # type: ignore\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"&lt;frozen importlib._bootstrap_external&gt;\", line 940, in exec_module\n  File \"&lt;frozen importlib._bootstrap&gt;\", line 241, in _call_with_frames_removed\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/alembic_migrations/env.py\", line 120, in &lt;module&gt;\n    run_migrations_online()\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/alembic_migrations/env.py\", line 114, in run_migrations_online\n    context.run_migrations()\n  File \"&lt;string&gt;\", line 8, in run_migrations\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/runtime/environment.py\", line 946, in run_migrations\n    self.get_context().run_migrations(**kw)\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/runtime/migration.py\", line 616, in run_migrations\n    for step in self._migrations_fn(heads, self):\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 641, in check_sanity\n    for script in script_dir.revision_map.iterate_revisions(\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 814, in iterate_revisions\n    revisions, heads = fn(\n                       ^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 1475, in _collect_upgrade_revisions\n    current_revisions = self.get_revisions(lower)\n                        ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 542, in get_revisions\n    return sum([self.get_revisions(id_elem) for id_elem in id_], ())\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 542, in &lt;listcomp&gt;\n    return sum([self.get_revisions(id_elem) for id_elem in id_], ())\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 565, in get_revisions\n    return tuple(\n           ^^^^^^\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 566, in &lt;genexpr&gt;\n    self._revision_for_ident(rev_id, branch_label)\n  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 637, in _revision_for_ident\n    raise ResolutionError(\nalembic.script.revision.ResolutionError: No such revision or branch 'ad80a9f07c5c'\n", "stderr_lines": ["+ sudo -E kolla_set_configs", "INFO:__main__:Loading config file at /var/lib/kolla/config_files/config.json", "INFO:__main__:Validating config file", "INFO:__main__:Kolla config strategy set to: COPY_ALWAYS", "INFO:__main__:Copying service configuration files", "INFO:__main__:Copying /var/lib/kolla/config_files/neutron.conf to /etc/neutron/neutron.conf", "INFO:__main__:Setting permission for /etc/neutron/neutron.conf", "INFO:__main__:Copying /var/lib/kolla/config_files/neutron_vpnaas.conf to /etc/neutron/neutron_vpnaas.conf", "INFO:__main__:Setting permission for /etc/neutron/neutron_vpnaas.conf", "INFO:__main__:Copying /var/lib/kolla/config_files/ml2_conf.ini to /etc/neutron/plugins/ml2/ml2_conf.ini", "INFO:__main__:Setting permission for /etc/neutron/plugins/ml2/ml2_conf.ini", "INFO:__main__:Copying /var/lib/kolla/config_files/id_rsa to /var/lib/neutron/.ssh/id_rsa", "INFO:__main__:Setting permission for /var/lib/neutron/.ssh/id_rsa", "INFO:__main__:Writing out command to execute", "INFO:__main__:Setting permission for /var/log/kolla/neutron", "INFO:__main__:Setting permission for /var/log/kolla/neutron/dnsmasq.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-l3-agent.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-metadata-agent.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-server.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/privsep-helper.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-dhcp-agent.log", "INFO:__main__:Setting permission for /var/log/kolla/neutron/neutron-openvswitch-agent.log", "++ cat /run_command", "+ CMD='neutron-server --config-file /etc/neutron/neutron.conf  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini --config-file /etc/neutron/neutron_vpnaas.conf '", "+ ARGS=", "+ sudo kolla_copy_cacerts", "+ sudo kolla_install_projects", "+ [[ ! -n '' ]]", "+ . kolla_extend_start", "++ [[ ! -d /var/log/kolla/neutron ]]", "+++ stat -c %a /var/log/kolla/neutron", "++ [[ 2755 != \\7\\5\\5 ]]", "++ chmod 755 /var/log/kolla/neutron", "++ [[ ! debian =~ centos|rocky ]]", "++ /usr/bin/update-alternatives --display iptables", "++ KOLLA_LEGACY_IPTABLES=false", "++ [[ false == \\t\\r\\u\\e ]]", "++ sudo /usr/bin/update-alternatives --auto iptables", "++ sudo /usr/bin/update-alternatives --auto ip6tables", "++ . /usr/local/bin/kolla_neutron_extend_start", "+++ [[ -n 0 ]]", "+++ neutron-db-manage --subproject neutron upgrade head", "INFO  [alembic.runtime.migration] Context impl MySQLImpl.", "INFO  [alembic.runtime.migration] Will assume non-transactional DDL.", "Traceback (most recent call last):", "  File \"/var/lib/kolla/venv/bin/neutron-db-manage\", line 8, in &lt;module&gt;", "    sys.exit(main())", "             ^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 668, in main", "    return_val |= bool(CONF.command.func(config, CONF.command.name))", "                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 189, in do_upgrade", "    run_sanity_checks(config, revision)", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 651, in run_sanity_checks", "    script_dir.run_env()", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/base.py\", line 582, in run_env", "    util.load_python_file(self.dir, \"env.py\")", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 95, in load_python_file", "    module = load_module_py(module_id, path)", "             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/util/pyfiles.py\", line 113, in load_module_py", "    spec.loader.exec_module(module)  # type: ignore", "    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"&lt;frozen importlib._bootstrap_external&gt;\", line 940, in exec_module", "  File \"&lt;frozen importlib._bootstrap&gt;\", line 241, in _call_with_frames_removed", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/alembic_migrations/env.py\", line 120, in &lt;module&gt;", "    run_migrations_online()", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/alembic_migrations/env.py\", line 114, in run_migrations_online", "    context.run_migrations()", "  File \"&lt;string&gt;\", line 8, in run_migrations", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/runtime/environment.py\", line 946, in run_migrations", "    self.get_context().run_migrations(**kw)", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/runtime/migration.py\", line 616, in run_migrations", "    for step in self._migrations_fn(heads, self):", "                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/neutron/db/migration/cli.py\", line 641, in check_sanity", "    for script in script_dir.revision_map.iterate_revisions(", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 814, in iterate_revisions", "    revisions, heads = fn(", "                       ^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 1475, in _collect_upgrade_revisions", "    current_revisions = self.get_revisions(lower)", "                        ^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 542, in get_revisions", "    return sum([self.get_revisions(id_elem) for id_elem in id_], ())", "               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 542, in &lt;listcomp&gt;", "    return sum([self.get_revisions(id_elem) for id_elem in id_], ())", "                ^^^^^^^^^^^^^^^^^^^^^^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 565, in get_revisions", "    return tuple(", "           ^^^^^^", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 566, in &lt;genexpr&gt;", "    self._revision_for_ident(rev_id, branch_label)", "  File \"/var/lib/kolla/venv/lib/python3.11/site-packages/alembic/script/revision.py\", line 637, in _revision_for_ident", "    raise ResolutionError(", "alembic.script.revision.ResolutionError: No such revision or branch 'ad80a9f07c5c'"], "stdout": "iptables - auto mode\n  link best version is /usr/sbin/iptables-nft\n  link currently points to /usr/sbin/iptables-nft\n  link iptables is /usr/sbin/iptables\n  slave iptables-restore is /usr/sbin/iptables-restore\n  slave iptables-save is /usr/sbin/iptables-save\n/usr/sbin/iptables-legacy - priority 10\n  slave iptables-restore: /usr/sbin/iptables-legacy-restore\n  slave iptables-save: /usr/sbin/iptables-legacy-save\n/usr/sbin/iptables-nft - priority 20\n  slave iptables-restore: /usr/sbin/iptables-nft-restore\n  slave iptables-save: /usr/sbin/iptables-nft-save\n", "stdout_lines": ["iptables - auto mode", "  link best version is /usr/sbin/iptables-nft", "  link currently points to /usr/sbin/iptables-nft", "  link iptables is /usr/sbin/iptables", "  slave iptables-restore is /usr/sbin/iptables-restore", "  slave iptables-save is /usr/sbin/iptables-save", "/usr/sbin/iptables-legacy - priority 10", "  slave iptables-restore: /usr/sbin/iptables-legacy-restore", "  slave iptables-save: /usr/sbin/iptables-legacy-save", "/usr/sbin/iptables-nft - priority 20", "  slave iptables-restore: /usr/sbin/iptables-nft-restore", "  slave iptables-save: /usr/sbin/iptables-nft-save"]}

PLAY RECAP ***********************************************************************************************************************************************************************************
debiankolla                : ok=160  changed=25   unreachable=0    failed=1    skipped=114  rescued=0    ignored=0   

</code></pre>
<h3 id="2-kolla-ansible-arm64"><a class="header" href="#2-kolla-ansible-arm64">2. kolla-ansible arm64</a></h3>
<p>two nodes verification, deploy OK.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250801"><a class="header" href="#20250801">20250801</a></h1>
<h3 id="1-tips-for-deployment"><a class="header" href="#1-tips-for-deployment">1. Tips for deployment</a></h3>
<pre><code>yum update -y
yum install -y vim  tar unzip
systemctl disable firewalld
vim /etc/selinux/config
...
SELINUX=disabled
...
</code></pre>
<p>Install kernel and upgrade, then:</p>
<pre><code>yum install -y dpkg dpkg-devel openssl openssl-devel
yum install -y ncurses ncurses-devel bison flex bc libdrm build elfutils-libelf-devel
yum install -y git htop tmux vim net-tools numactl
yum install -y docker make gcc kexec-tools
yum install -y lxc lxcfs lxcfs-tools
yum install -y libseccomp-devel

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250804"><a class="header" href="#20250804">20250804</a></h1>
<h3 id="1-hanbo-with-920"><a class="header" href="#1-hanbo-with-920">1. HanBo With 920</a></h3>
<p>Failed with no exagear. need to rebuild for arm64 only image.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250805"><a class="header" href="#20250805">20250805</a></h1>
<h3 id="1-rebuild-ffmpeg"><a class="header" href="#1-rebuild-ffmpeg">1. Rebuild ffmpeg</a></h3>
<p>Change the configs:</p>
<pre><code>git clone https://github.com/remote-android/platform_manifests.git -b redroid-13.0.0_r24 \
--depth=1
cd ./platform_manifests
git reset –-hard 0d3bac810208842e080440f53e8b96e03a13a3ee
cp -r ./platform_manifests/default.xml .repo/manifests/

root@i9workstation:/media/sdc/hanbo/redroid# cat .repo/manifests/default.xml | more
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;manifest&gt;

  &lt;remote  name="aosp"
           fetch="https://mirrors.bfsu.edu.cn/git/AOSP"
           review="https://android-review.googlesource.com/" /&gt;
  &lt;default revision="refs/tags/android-13.0.0_r24"
           remote="aosp"
           sync-j="4" /&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250811"><a class="header" href="#20250811">20250811</a></h1>
<h3 id="1-stein-work-tipscentos7"><a class="header" href="#1-stein-work-tipscentos7">1. stein work tips(CentOS7)</a></h3>
<p>Step:</p>
<pre><code>192.168.150.11  controller
192.168.150.12  compute1
192.168.150.13  compute2
</code></pre>
<p>All nodes:</p>
<pre><code>systemctl disable firewalld
SELINUX should be disabled
echo "PS1='[\[\e[31m\]\u\[\e[m\]@\[\e[36m\]\H\[\e[33m\] \W\[\e[m\]]\[\e[35m\]\\$ \[\e[m\]'" &gt;&gt;/etc/bashrc
source /etc/bashrc
sed -i.bak   -e 's|^mirrorlist=|#mirrorlist=|g'   -e 's|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos|g'   /etc/yum.repos.d/CentOS-Base.repo &amp;&amp; yum makecache
yum install -y vim net-tools wget lrzsz tree screen lsof tcpdump nmap mlocate

cat &gt;&gt;/etc/hosts&lt;&lt;EOF

# controller
192.168.150.11    controller

# compute
192.168.150.12    compute1
192.168.150.13    compute2
EOF
</code></pre>
<p>(Controller)passwordless ssh login:</p>
<pre><code>ssh-keygen 
ssh-copy-id root@controller
ssh-copy-id root@compute1
ssh-copy-id root@compute2
</code></pre>
<p>(Controller) Change repo:</p>
<pre><code>yum install -y centos-release-openstack-stein
yum makecache
cd /etc/yum.repos.d

vim CentOS-OpenStack-stein.repo
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/cloud/x86_64/openstack-stein/
vim CentOS-Ceph-Nautilus.repo
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/storage/x86_64/ceph-nautilus/
vim CentOS-NFS-Ganesha-28.repo
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/storage/x86_64/nfs-ganesha-28/
vim CentOS-QEMU-EV.repo
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/virt/x86_64/kvm-common/

yum makecache
yum install -y python-openstackclient 
</code></pre>
<p>(Compute1/2):</p>
<pre><code>yum install -y centos-release-openstack-stein
(Controller): scp CentOS-OpenStack-stein.repo CentOS-Ceph-Nautilus.repo CentOS-NFS-Ganesha-28.repo CentOS-QEMU-EV.repo root@compute1(2):/etc/yum.repos.d/
</code></pre>
<p>(Controller):</p>
<pre><code>yum install -y mariadb mariadb-server MySQL-python
vim /etc/my.cnf.d/mariadb-server.cnf (Added following lines under mysqld module):
default-storage-engine = innodb
innodb_file_per_table = on
collation-server = utf8_general_ci
init-connect = 'SET NAMES utf8'
character-set-server = utf8
systemctl enable mariadb.service --now
mysql_secure_installation
(Only set the password to yiersansi)

yum install -y memcached python-memcached
sed -i 's/127.0.0.1/0.0.0.0/' /etc/sysconfig/memcached 
systemctl enable memcached.service --now
# test
printf "set foo 0 0 3\r\nbar\r\n"|nc controller 11211  
printf "get foo\r\n"|nc controller 11211 

yum install -y rabbitmq-server
systemctl enable rabbitmq-server.service --now
rabbitmqctl add_user openstack openstack
rabbitmqctl set_permissions openstack ".*" ".*" ".*" 
rabbitmq-plugins list 
rabbitmq-plugins enable rabbitmq_management  

</code></pre>
<p>geust/guest for login:</p>
<p><img src="./images/2025_08_11_16_21_25_819x275.jpg" alt="./images/2025_08_11_16_21_25_819x275.jpg" /></p>
<p><img src="./images/2025_08_11_16_23_06_638x790.jpg" alt="./images/2025_08_11_16_23_06_638x790.jpg" /></p>
<p><img src="./images/2025_08_11_16_24_53_445x188.jpg" alt="./images/2025_08_11_16_24_53_445x188.jpg" /></p>
<p>(Controller), Install/config keystone:</p>
<pre><code>mysql -uroot -p
create database keystone;
grant all privileges on keystone.* to keystone_user@controller identified by 'keystone_pass';
flush privileges;
quit;
yum install -y openstack-keystone httpd mod_wsgi
sed -i.default -e '/^#/d' -e '/^$/d' /etc/keystone/keystone.conf
# vim /etc/keystone/keystone.conf
[database]
connection = mysql+pymysql://keystone_user:keystone_pass@controller/keystone

[token]
provider = fernet

su -s /bin/sh -c "keystone-manage db_sync" keystone 
keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
keystone-manage bootstrap --bootstrap-password admin_pass \
  --bootstrap-admin-url http://controller:5000/v3/ \
  --bootstrap-internal-url http://controller:5000/v3/ \
  --bootstrap-public-url http://controller:5000/v3/ \
  --bootstrap-region-id RegionOne
sed -i '/#ServerName/aServerName controller:80' /etc/httpd/conf/httpd.conf 
ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/
systemctl enable httpd.service --now
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
openstack project create --domain default --description "Service Project" service
openstack project create --domain default --description "Demo Project" myproject
openstack user create --domain default --password myuser_pass myuser
openstack role create myrole
openstack role add --project myproject --user myuser myrole
unset OS_AUTH_URL OS_PASSWORD
# verify admin, passwd is admin_pass
openstack --os-auth-url http://controller:5000/v3 \
  --os-project-domain-name Default --os-user-domain-name Default \
  --os-project-name admin --os-username admin token issue
# verify myuser, passwd is myuser_pass
openstack --os-auth-url http://controller:5000/v3 \
  --os-project-domain-name Default --os-user-domain-name Default \
  --os-project-name myproject --os-username myuser token issue
cd ~
cat &gt;admin-openrc&lt;&lt;EOF
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
EOF
cat &gt;demo-openrc&lt;&lt;EOF
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=myproject
export OS_USERNAME=myuser
export OS_PASSWORD=myuser_pass
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
EOF
cd ~
. admin-openrc
openstack token issue
</code></pre>
<p>(Controller), install Glance:</p>
<pre><code>create database glance;
grant all privileges on glance.* to glance_user@controller identified by 'glance_pass';
flush privileges;
quit;
. admin-openrc
openstack user create --domain default --password glance_pass glance
openstack role add --project service --user glance admin
openstack service create --name glance --description "OpenStack Image" image
openstack endpoint create --region RegionOne image public http://controller:9292
openstack endpoint create --region RegionOne image internal http://controller:9292
openstack endpoint create --region RegionOne image admin http://controller:9292 
yum install -y openstack-glance
sed -i.default -e '/^#/d' -e '/^$/d' /etc/glance/glance-api.conf
vim /etc/glance/glance-api.conf
[database]
connection = mysql+pymysql://glance_user:glance_pass@controller/glance

[glance_store]
stores = file,http
default_store = file
filesystem_store_datadir = /var/lib/glance/images/

[keystone_authtoken]
www_authenticate_uri  = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = glance_pass

[paste_deploy]
flavor = keystone
sed -i.default -e '/^#/d' -e '/^$/d' /etc/glance/glance-registry.conf
vim /etc/glance/glance-registry.conf
[database]
connection = mysql+pymysql://glance_user:glance_pass@controller/glance

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = glance_pass

[paste_deploy]
flavor = keystone
su -s /bin/sh -c "glance-manage db_sync" glance
systemctl start openstack-glance-api.service openstack-glance-registry.service
systemctl enable openstack-glance-api.service openstack-glance-registry.service

</code></pre>
<p>(Controller) upload image:</p>
<pre><code>cd ~
wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img
openstack image create "cirros" \
  --file cirros-0.4.0-x86_64-disk.img \
  --disk-format qcow2 --container-format bare \
  --public
openstack image list
</code></pre>
<p>(Controller) Placement:</p>
<pre><code>create database placement;
grant all privileges on placement.* to 'placement_user'@'controller' identified by 'placement_pass'; 
flush privileges;
quit;
cd ~
. admin-openrc
openstack user create --domain default --password placement_pass placement
openstack role add --project service --user placement admin
openstack service create --name placement --description "Placement API" placement
openstack endpoint create --region RegionOne placement public http://controller:8778
openstack endpoint create --region RegionOne placement internal http://controller:8778
openstack endpoint create --region RegionOne placement admin http://controller:8778
yum install -y openstack-placement-api
sed -i.default -e '/^#/d' -e '/^$/d' /etc/placement/placement.conf
vim /etc/placement/placement.conf
[api]
auth_strategy = keystone

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = placement
password = placement_pass

[placement_database]
connection = mysql+pymysql://placement_user:placement_pass@controller/placement
su -s /bin/sh -c "placement-manage db sync" placement
cat &gt;&gt;/etc/httpd/conf.d/00-placement-api.conf&lt;&lt;EOF

&lt;Directory /usr/bin&gt;
   &lt;IfVersion &gt;= 2.4&gt;
      Require all granted
   &lt;/IfVersion&gt;
   &lt;IfVersion &lt; 2.4&gt;
      Order allow,deny
      Allow from all
   &lt;/IfVersion&gt;
&lt;/Directory&gt;
EOF
systemctl restart httpd
placement-status upgrade check

</code></pre>
<p>(Controller) nova:</p>
<pre><code>create database nova_api;
create database nova;
create database nova_cell0;
grant all privileges on nova_api.* to 'nova_user'@'controller' identified by 'nova_pass';
grant all privileges on nova.* to 'nova_user'@'controller' identified by 'nova_pass';
grant all privileges on nova_cell0.* to 'nova_user'@'controller' identified by 'nova_pass';
flush privileges;
exit;
cd ~
. admin-openrc
openstack user create --domain default --password nova_pass nova 
openstack role add --project service --user nova admin
openstack service create --name nova --description "OpenStack Compute" compute
openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1
yum install -y openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler
sed -i.default -e '/^#/d' -e '/^$/d' /etc/nova/nova.conf
vim /etc/nova/nova.conf
[DEFAULT]
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:openstack@controller
my_ip = 10.0.0.11
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver
rpc_backend=rabbit

[api]
auth_strategy = keystone

[api_database]
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api

[database]
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova

[glance]
api_servers = http://controller:9292

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = nova
password = nova_pass

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement_pass

[vnc]
enabled = true
server_listen = $my_ip
server_proxyclient_address = $my_ip
su -s /bin/sh -c "nova-manage api_db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
su -s /bin/sh -c "nova-manage db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova
systemctl start openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service

systemctl enable openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service

</code></pre>
<p>(Compute1/2):</p>
<pre><code>yum install -y python-openstackclient 
yum install -y openstack-nova-compute
sed -i.default -e '/^#/d' -e '/^$/d' /etc/nova/nova.conf
vim /etc/nova/nova.conf
[DEFAULT]
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:openstack@controller
my_ip = 192.168.150.12(13)
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver

[api]
auth_strategy = keystone

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = nova_pass

[vnc]
enabled = true
server_listen = 0.0.0.0
server_proxyclient_address = $my_ip
novncproxy_base_url = http://controller:6080/vnc_auto.html

[glance]
api_servers = http://controller:9292

[oslo_concurrency]
lock_path = /var/lib/nova/tmp

[libvirt]
virt_type = qemu
systemctl start libvirtd.service openstack-nova-compute.service
systemctl enable libvirtd.service openstack-nova-compute.service
</code></pre>
<p>(controller) Add compute node:</p>
<pre><code>cd ~
. admin-openrc
openstack compute service list --service nova-compute
su -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose" nova

vim /etc/nova/nova.conf
[scheduler]
discover_hosts_in_cells_interval=300

systemctl restart openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service
</code></pre>
<p>(Controller) Neutron:</p>
<pre><code>create database neutron;
grant all privileges on neutron.* to 'neutron_user'@'controller' identified by 'neutron_pass';
flush privileges;
quit;
openstack user create --domain default --password neutron_pass neutron
openstack role add --project service --user neutron admin
openstack service create --name neutron --description "OpenStack Networking" network
openstack endpoint create --region RegionOne network public http://controller:9696
openstack endpoint create --region RegionOne network internal http://controller:9696
openstack endpoint create --region RegionOne network admin http://controller:9696
yum install -y openstack-neutron openstack-neutron-ml2 \
  openstack-neutron-linuxbridge ebtables
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/neutron.conf
vim /etc/neutron/neutron.conf
[DEFAULT]
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = true
transport_url = rabbit://openstack:openstack@controller
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true

[database]
connection = mysql+pymysql://neutron_user:neutron_pass@controller/neutron

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers =controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron_pass

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp

[nova]
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = nova
password = nova_pass

sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/ml2_conf.ini
vim /etc/neutron/plugins/ml2/ml2_conf.ini
[DEFAULT]
[ml2]
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = linuxbridge,l2population
extension_drivers = port_security

[ml2_type_flat]
flat_networks = provider

[ml2_type_vxlan]
vni_ranges = 1:1000

[securitygroup]
enable_ipset = true

sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/linuxbridge_agent.ini
vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[DEFAULT]
[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver

sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/dhcp_agent.ini

vim /etc/neutron/dhcp_agent.ini
[DEFAULT]
interface_driver = linuxbridge
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/metadata_agent.ini
vim /etc/neutron/metadata_agent.ini
[DEFAULT]
nova_metadata_host = controller
metadata_proxy_shared_secret = metadata_secret

vim /etc/nova/nova.conf
url = http://controller:9696
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron_pass
service_metadata_proxy = true
metadata_proxy_shared_secret = metadata_secret
ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
systemctl restart openstack-nova-api.service

systemctl start neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service
  
systemctl enable neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service
</code></pre>
<p>(Compute1/2) Neutron:</p>
<pre><code>yum install -y openstack-neutron-linuxbridge ebtables ipset
sed  -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/neutron.conf
vim /etc/neutron/neutron.conf
[DEFAULT]
transport_url = rabbit://openstack:openstack@controller
auth_strategy = keystone

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers =controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron_pass

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp

sed -i.bak -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/linuxbridge_agent.ini
vim /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver

cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
modprobe br_netfilter
 sysctl -p

vim /etc/nova/nova.conf
url = http://controller:9696
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron_pass

systemctl restart openstack-nova-compute.service

</code></pre>
<p>(Controller) Verification of neutron:</p>
<pre><code>openstack extension list --network
openstack network agent list
</code></pre>
<p>(Controller) Create network:</p>
<pre><code>openstack network create  --share --external \
  --provider-physical-network provider \
  --provider-network-type flat provider
openstack network list
+--------------------------------------+----------+---------+
| ID                                   | Name     | Subnets |
+--------------------------------------+----------+---------+
| 71e9248a-4233-4fd2-961d-4f10a757b299 | provider |         |
+--------------------------------------+----------+---------+

openstack subnet create --network provider \
   --allocation-pool start=192.168.150.100,end=192.168.150.200 --dns-nameserver 192.168.150.1 --gateway 192.168.150.1 --subnet-range 192.168.150.0/24 provider-sub

# openstack subnet list
+--------------------------------------+--------------+--------------------------------------+------------------+
| ID                                   | Name         | Network                              | Subnet           |
+--------------------------------------+--------------+--------------------------------------+------------------+
| d170c5b8-68f3-4d9c-9850-307a765ddd80 | provider-sub | 71e9248a-4233-4fd2-961d-4f10a757b299 | 192.168.150.0/24 |
+--------------------------------------+--------------+--------------------------------------+------------------+
</code></pre>
<h3 id="2-gpt-sovits-on-ubuntu2204"><a class="header" href="#2-gpt-sovits-on-ubuntu2204">2. GPT-SoVITS On Ubuntu22.04</a></h3>
<p>Upgrade cuda to 12.8:</p>
<pre><code>wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb
sudo apt-get update
sudo apt-get -y install cuda-toolkit-12-8
sudo apt-get install -y cuda-drivers
export PATH=/usr/local/cuda-12.8/bin${PATH:+:${PATH}}
sudo reboot
</code></pre>
<p>Docker:</p>
<pre><code>git clone https://github.com/RVC-Boss/GPT-SoVITS.git
sudo vim /etc/docker/daemon.json
           "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker
</code></pre>
<p>Change to docker-ce, then:</p>
<pre><code>cd ~/Code/GPT-SoVITS
sudo docker-compose run --service-ports GPT-SoVITS-CU12
</code></pre>
<p>Enter the docker instance and execute:</p>
<pre><code>$ sudo docker exec -it 9956431bddd0 bash
l(base) root@9956431bddd0:/workspace/GPT-SoVITS# ls *.py
api.py  api_v2.py  config.py  webui.py
(base) root@9956431bddd0:/workspace/GPT-SoVITS# python webui.py
(base) root@9956431bddd0:/workspace/GPT-SoVITS# python api_v2.py 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250812"><a class="header" href="#20250812">20250812</a></h1>
<h3 id="1-stein-working-tipscontinue"><a class="header" href="#1-stein-working-tipscontinue">1. stein working tips(Continue)</a></h3>
<p>Refers to <code>https://blog.csdn.net/qq_36154886/article/details/108753513</code><br />
Added following items in every nodes:</p>
<pre><code># vim /etc/nova/nova.conf
[placement]
auth_url = http://controller:5000
#auth_url = http://controller:35357
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = nova
password = nova_pass
os_region_name = RegionOne
# reboot
</code></pre>
<p>Then re-create the instance.</p>
<pre><code># openstack console url show hello-instance
+-------+-------------------------------------------------------------------------------------------+
| Field | Value                                                                                     |
+-------+-------------------------------------------------------------------------------------------+
| type  | novnc                                                                                     |
| url   | http://controller:6080/vnc_auto.html?path=%3Ftoken%3Da1b6649f-00d5-4eef-84b2-a41ca53e974d |
+-------+-------------------------------------------------------------------------------------------+
</code></pre>
<p><img src="./images/2025_08_12_10_19_05_924x523.jpg" alt="./images/2025_08_12_10_19_05_924x523.jpg" /></p>
<p>(Controller) Dashboard:</p>
<pre><code> yum install openstack-dashboard -y
vim /etc/openstack-dashboard/local_settings

import os
from django.utils.translation import ugettext_lazy as _
from openstack_dashboard.settings import HORIZON_CONFIG
DEBUG = False
ALLOWED_HOSTS = ['*']
LOCAL_PATH = '/tmp'
SECRET_KEY='60eeac4448ab9733b7d8'
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
CACHES = {
    'default': {
         'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',
         'LOCATION': 'controller:11211',
    }
}
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
OPENSTACK_HOST = "controller"
OPENSTACK_KEYSTONE_URL = "http://%s:5000/v3" % OPENSTACK_HOST
OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True
OPENSTACK_API_VERSIONS = {
    "identity": 3,
    "image": 2,
    "volume": 3,
}
OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = "Default"
OPENSTACK_KEYSTONE_DEFAULT_ROLE = "user"
OPENSTACK_NEUTRON_NETWORK = {
    'enable_auto_allocated_network': False,
    'enable_distributed_router': False,
    'enable_fip_topology_check': False,
    'enable_ha_router': False,
    'enable_lb': False,
    'enable_firewall': False,
    'enable_vpn': False,
    'enable_ipv6': True,
    'enable_quotas': False,
    'enable_rbac_policy': True,
    'enable_router': False,
    'default_dns_nameservers': [],
    'supported_provider_types': ['*'],
    'segmentation_id_range': {},
    'extra_provider_types': {},
    'supported_vnic_types': ['*'],
    'physical_networks': [],
}
TIME_ZONE = "Asia/Shanghai"
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'console': {
            'format': '%(levelname)s %(name)s %(message)s'
        },
        'operation': {
            'format': '%(message)s'
        },
    },
    'handlers': {
        'null': {
            'level': 'DEBUG',
            'class': 'logging.NullHandler',
        },
        'console': {
            'level': 'DEBUG' if DEBUG else 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'console',
        },
        'operation': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'operation',
        },
    },
    'loggers': {
        'horizon': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'horizon.operation_log': {
            'handlers': ['operation'],
            'level': 'INFO',
            'propagate': False,
        },
        'openstack_dashboard': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'novaclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'cinderclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'keystoneauth': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'keystoneclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'glanceclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'neutronclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'swiftclient': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'oslo_policy': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'openstack_auth': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'django': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'django.db.backends': {
            'handlers': ['null'],
            'propagate': False,
        },
        'requests': {
            'handlers': ['null'],
            'propagate': False,
        },
        'urllib3': {
            'handlers': ['null'],
            'propagate': False,
        },
        'chardet.charsetprober': {
            'handlers': ['null'],
            'propagate': False,
        },
        'iso8601': {
            'handlers': ['null'],
            'propagate': False,
        },
        'scss': {
            'handlers': ['null'],
            'propagate': False,
        },
    },
}
SECURITY_GROUP_RULES = {
    'all_tcp': {
        'name': _('All TCP'),
        'ip_protocol': 'tcp',
        'from_port': '1',
        'to_port': '65535',
    },
    'all_udp': {
        'name': _('All UDP'),
        'ip_protocol': 'udp',
        'from_port': '1',
        'to_port': '65535',
    },
    'all_icmp': {
        'name': _('All ICMP'),
        'ip_protocol': 'icmp',
        'from_port': '-1',
        'to_port': '-1',
    },
    'ssh': {
        'name': 'SSH',
        'ip_protocol': 'tcp',
        'from_port': '22',
        'to_port': '22',
    },
    'smtp': {
        'name': 'SMTP',
        'ip_protocol': 'tcp',
        'from_port': '25',
        'to_port': '25',
    },
    'dns': {
        'name': 'DNS',
        'ip_protocol': 'tcp',
        'from_port': '53',
        'to_port': '53',
    },
    'http': {
        'name': 'HTTP',
        'ip_protocol': 'tcp',
        'from_port': '80',
        'to_port': '80',
    },
    'pop3': {
        'name': 'POP3',
        'ip_protocol': 'tcp',
        'from_port': '110',
        'to_port': '110',
    },
    'imap': {
        'name': 'IMAP',
        'ip_protocol': 'tcp',
        'from_port': '143',
        'to_port': '143',
    },
    'ldap': {
        'name': 'LDAP',
        'ip_protocol': 'tcp',
        'from_port': '389',
        'to_port': '389',
    },
    'https': {
        'name': 'HTTPS',
        'ip_protocol': 'tcp',
        'from_port': '443',
        'to_port': '443',
    },
    'smtps': {
        'name': 'SMTPS',
        'ip_protocol': 'tcp',
        'from_port': '465',
        'to_port': '465',
    },
    'imaps': {
        'name': 'IMAPS',
        'ip_protocol': 'tcp',
        'from_port': '993',
        'to_port': '993',
    },
    'pop3s': {
        'name': 'POP3S',
        'ip_protocol': 'tcp',
        'from_port': '995',
        'to_port': '995',
    },
    'ms_sql': {
        'name': 'MS SQL',
        'ip_protocol': 'tcp',
        'from_port': '1433',
        'to_port': '1433',
    },
    'mysql': {
        'name': 'MYSQL',
        'ip_protocol': 'tcp',
        'from_port': '3306',
        'to_port': '3306',
    },
    'rdp': {
        'name': 'RDP',
        'ip_protocol': 'tcp',
        'from_port': '3389',
        'to_port': '3389',
    },
}


cd /usr/share/openstack-dashboard
python manage.py make_web_conf --apache &gt; /etc/httpd/conf.d/openstack-dashboard.conf
systemctl restart httpd.service
systemctl restart memcached.service
</code></pre>
<p>password should be <code>admin_pass</code>:</p>
<p><img src="./images/2025_08_12_10_35_08_469x558.jpg" alt="./images/2025_08_12_10_35_08_469x558.jpg" /></p>
<p><img src="./images/2025_08_12_10_48_06_824x761.jpg" alt="./images/2025_08_12_10_48_06_824x761.jpg" /></p>
<h3 id="2-zunstein"><a class="header" href="#2-zunstein">2. zun(Stein)</a></h3>
<p>(Controller) zun:</p>
<pre><code>CREATE DATABASE zun;
GRANT ALL PRIVILEGES ON zun.* TO 'zun'@'localhost' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON zun.* TO 'zun'@'%' IDENTIFIED BY '123456';
flush privileges;
exit

source admin-openrc
openstack user create --domain default --password 123456 zun
openstack role add --project service --user zun admin
openstack service create --name zun --description "Container Service" container

openstack endpoint create --region RegionOne container public http://controller:9517/v1
openstack endpoint create --region RegionOne container internal http://controller:9517/v1
openstack endpoint create --region RegionOne container admin http://controller:9517/v1

groupadd --system zun
useradd --home-dir "/var/lib/zun" --create-home --system --shell /bin/false -g zun zun

groupadd --system zun
useradd --home-dir "/var/lib/zun" --create-home --system --shell /bin/false -g zun zun
mkdir -p /etc/zun
chown zun:zun /etc/zun

yum install -y python-pip git python-devel libffi-devel gcc openssl-devel

cd /var/lib/zun
git clone https://git.openstack.org/openstack/zun.git
cd zun
git checkout tags/stein-eol -b stein
cd ..
chown -R zun:zun zun

yum install epel-release
yum install -y python-pip
python -m pip install --upgrade pip
python -m pip install --upgrade pip==18.0
pip install --ignore-installed PyYAML
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
python setup.py install

su -s /bin/sh -c "oslo-config-generator --config-file etc/zun/zun-config-generator.conf" zun
su -s /bin/sh -c "cp etc/zun/zun.conf.sample /etc/zun/zun.conf" zun

su -s /bin/sh -c "cp etc/zun/api-paste.ini /etc/zun" zun

vim /etc/zun/zun.conf
[DEFAULT]
transport_url = rabbit://openstack:openstack@controller

[api]
host_ip = 192.168.150.11
port = 9517

[database]
connection = mysql+pymysql://zun:123456@controller/zun

[keystone_auth]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = zun
password = 123456
auth_protocol = http
auth_version = v3
service_token_roles_required = True
endpoint_type = internalURL

[keystone_authtoken]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = zun
password = 123456
auth_protocol = http
auth_version = v3
service_token_roles_required = True
endpoint_type = internalURL

[oslo_concurrency]
lock_path = /var/lib/zun/tmp

[oslo_messaging_notifications]
driver = messaging

[websocket_proxy]
wsproxy_host = 192.168.150.11
wsproxy_port = 6784
base_url = ws://controller:6784

su -s /bin/sh -c "zun-db-manage upgrade" zun

[root@controller zun]# cat /etc/systemd/system/zun-api.service
[Unit]
Description = OpenStack Container Service API

[Service]
ExecStart = /usr/bin/zun-api
User = zun

[Install]
WantedBy = multi-user.target
[root@controller zun]# cat /etc/systemd/system/zun-wsproxy.service
[Unit]
Description = OpenStack Container Service Websocket Proxy

[Service]
ExecStart = /usr/bin/zun-wsproxy
User = zun

[Install]
WantedBy = multi-user.target

systemctl daemon-reload
systemctl enable zun-api  zun-wsproxy
systemctl start zun-api  zun-wsproxy
systemctl status zun-api  zun-wsproxy
</code></pre>
<p>(Controller) install etcd:</p>
<pre><code>yum install -y etcd

vim /etc/etcd/etcd.conf
#[Member]
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_LISTEN_PEER_URLS="http://192.168.150.11:2380"
ETCD_LISTEN_CLIENT_URLS="http://192.168.150.11:2379"
ETCD_NAME="controller"
#
#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.150.11:2380"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.150.11:2379"
ETCD_INITIAL_CLUSTER="controller=http://192.168.150.11:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-01"
ETCD_INITIAL_CLUSTER_STATE="new"

systemctl enable etcd
systemctl start etcd
systemctl status etcd
</code></pre>
<p>(Compute) install docker:</p>
<pre><code>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sed -i 's+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo
yum makecache
yum install docker-ce-20.10.24-3.el7 docker-ce-cli-20.10.24-3.el7 docker-ce-rootless-extras-20.10.24-3.el7
yum install -y epel-release yum-utils device-mapper-persistent-data lvm2 python-pip git python-devel libffi-devel gcc openssl-devel wget vim net-tools
systemctl enable docker
systemctl start docker
</code></pre>
<p>(Controller)Create kuryr related:</p>
<pre><code>source /root/admin-openrc
openstack user create --domain default --password 123456 kuryr
openstack role add --project service --user kuryr admin
</code></pre>
<p>(Compute) kuryr related:</p>
<pre><code>groupadd --system kuryr
useradd --home-dir "/var/lib/kuryr" --create-home --system --shell /bin/false -g kuryr kuryr
mkdir -p /etc/kuryr &amp;&amp; chown kuryr:kuryr /etc/kuryr
yum install epel-release python-pip git python-devel libffi-devel gcc openssl-devel -y
cd /var/lib/kuryr
git clone http://git.openstack.org/openstack/kuryr-libnetwork.git
cd kuryr-libnetwork/
git checkout tags/stein-eol -b stein
cd ..
chown -R kuryr:kuryr kuryr-libnetwork
python -m pip install --upgrade pip==18.0
cd kuryr-libnetwork/
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
python setup.py install
su -s /bin/sh -c "./tools/generate_config_file_samples.sh" kuryr &amp;&amp; su -s /bin/sh -c "cp etc/kuryr.conf.sample /etc/kuryr/kuryr.conf" kuryr
sed -i.default -e "/^#/d" -e "/^$/d" /etc/kuryr/kuryr.conf
vim /etc/kuryr/kuryr.conf
[DEFAULT]
bindir = /usr/libexec/kuryr
[binding]
[neutron]
www_authenticate_uri = http://controller:5000/v3
auth_url = http://controller:5000/v3
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = kuryr
password = 123456

vim /etc/systemd/system/kuryr-libnetwork.service
[Unit]
Description = Kuryr-libnetwork - Docker network plugin for Neutron

[Service]
ExecStart = /usr/bin/kuryr-server --config-file /etc/kuryr/kuryr.conf
CapabilityBoundingSet = CAP_NET_ADMIN

[Install]
WantedBy = multi-user.target

systemctl enable kuryr-libnetwork --now 
systemctl restart docker
systemctl status docker kuryr-libnetwork

 docker network create --driver kuryr --ipam-driver kuryr --subnet 10.10.0.0/16 --gateway=10.10.0.1 test_net2
docker network ls
vim /usr/lib/python2.7/site-packages/kuryr/lib/binding/drivers/veth.py
            #kind=port.get(constants.VIF_TYPE_KEY),
            kind='bridge',
systemctl restart kuryr-libnetwork
docker run --net test_net2 cirros ifconfig
</code></pre>
<p>(Compute1/2) zun-compute:</p>
<pre><code> groupadd --system zun
useradd --home-dir "/var/lib/zun" --create-home --system --shell /bin/false -g zun zun
 mkdir -p /etc/zun
chown zun:zun /etc/zun
yum install epel-release python-pip git python-devel libffi-devel gcc openssl-devel -y
cd /var/lib/zun
git clone https://git.openstack.org/openstack/zun.git
cd zun
git checkout tags/stein-eol -b stein
cd ..
chown -R zun:zun zun
cd zun
pip install -r requirements.txt
python setup.py install

su -s /bin/sh -c "oslo-config-generator --config-file etc/zun/zun-config-generator.conf" zun
su -s /bin/sh -c "cp etc/zun/zun.conf.sample /etc/zun/zun.conf" zun
su -s /bin/sh -c "cp etc/zun/rootwrap.conf /etc/zun/rootwrap.conf" zun
su -s /bin/sh -c "mkdir -p /etc/zun/rootwrap.d" zun
su -s /bin/sh -c "cp etc/zun/rootwrap.d/* /etc/zun/rootwrap.d/" zun

echo "zun ALL=(root) NOPASSWD: /usr/bin/zun-rootwrap /etc/zun/rootwrap.conf *" | sudo tee /etc/sudoers.d/zun-rootwrap


vim /etc/zun/zun.conf

[DEFAULT]
transport_url = rabbit://openstack:openstack@controller
state_path = /var/lib/zun

debug = true
log_file = zun.log
log_dir = /var/log/zun

[database]
connection = mysql+pymysql://zun:123456@controller/zun

[keystone_auth]
memcached_servers = controller:11211
www_authenticate_uri = http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = 123456
username = zun
auth_url = http://controller:5000
auth_type = password
auth_version = v3
auth_protocol = http
service_token_roles_required = True
endpoint_type = internalURL

[keystone_authtoken]
memcached_servers = controller:11211
www_authenticate_uri= http://controller:5000
project_domain_name = default
project_name = service
user_domain_name = default
password = 123456
username = zun
auth_url = http://controller:5000
auth_type = password

[oslo_concurrency]
lock_path = /var/lib/zun/tmp

[websocket_proxy]
base_url = ws://controller:6784/

[compute]
host_shared_with_nova = true

mkdir -p /etc/systemd/system/docker.service.d
cat /etc/systemd/system/docker.service.d/docker.conf 
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --group zun -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --cluster-store etcd://controller:2379

systemctl daemon-reload
systemctl restart docker

vim /etc/kuryr/kuryr.conf

[DEFAULT]
capability_scope = global
process_external_connectivity = False

systemctl restart kuryr-libnetwork
containerd config default &gt; /etc/containerd/config.toml
chown zun:zun /etc/containerd/config.toml

getent group zun | cut -d: -f3
# 987

vim /etc/containerd/config.toml
[grpc]
  ...
  gid = 987

systemctl restart containerd

 cat /etc/systemd/system/zun-compute.service
[Unit]
Description = OpenStack Container Service Compute Agent

[Service]
ExecStart = /usr/bin/zun-compute
User = zun

[Install]
WantedBy = multi-user.target

pip install docker
pip install pymysql

systemctl enable zun-compute --now
</code></pre>
<p>(Controller) verify:</p>
<pre><code> openstack appcontainer service list
</code></pre>
<p>(Controller) zun-ui:</p>
<pre><code>git clone https://github.com/openstack/zun-ui
cd zun-ui/
git checkout tags/stein-eol -b stein
pip install .
cp zun_ui/enabled/* /usr/share/openstack-dashboard/openstack_dashboard/local/enabled
python /usr/share/openstack-dashboard/manage.py collectstatic
python /usr/share/openstack-dashboard/manage.py compress
systemctl restart httpd.service memcached.service
</code></pre>
<p>Create inner network:</p>
<pre><code>  openstack router create Ext-Router
  openstack network create --internal --provider-network-type vxlan int-net
  openstack subnet create int-net-sub --network int-net --subnet-range 177.77.77.0/24 --gateway 177.77.77.1 --dns-nameserver 114.114.114.114
  openstack router add subnet Ext-Router int-net-sub
openstack router set Ext-Router --external-gateway  provider
</code></pre>
<p>Create container via ui:</p>
<p><img src="./images/2025_08_12_17_03_48_1207x502.jpg" alt="./images/2025_08_12_17_03_48_1207x502.jpg" /></p>
<p>Specify the int-net:</p>
<p><img src="./images/2025_08_12_17_04_21_948x503.jpg" alt="./images/2025_08_12_17_04_21_948x503.jpg" /></p>
<p>Creating status:</p>
<p><img src="./images/2025_08_12_17_04_38_1015x283.jpg" alt="./images/2025_08_12_17_04_38_1015x283.jpg" /></p>
<p>Running Status:</p>
<p><img src="./images/2025_08_12_17_05_22_1032x329.jpg" alt="./images/2025_08_12_17_05_22_1032x329.jpg" /></p>
<p>(Controller), view result:</p>
<pre><code>[root@controller ~]# openstack appcontainer list
+--------------------------------------+------+---------------+---------+------------+--------------+-------+
| uuid                                 | name | image         | status  | task_state | addresses    | ports |
+--------------------------------------+------+---------------+---------+------------+--------------+-------+
| 7617b8d7-6846-41d0-be8a-8ca3a0b9867a | test | cirros:latest | Running | None       | 177.77.77.96 | []    |
+--------------------------------------+------+---------------+---------+------------+--------------+-------+
</code></pre>
<p>Examine the running instance on compute node:</p>
<pre><code>[root@compute2 ~]# docker ps
CONTAINER ID   IMAGE           COMMAND        CREATED              STATUS              PORTS     NAMES
0cde592eff6d   cirros:latest   "sleep 3600"   About a minute ago   Up About a minute             zun-7617b8d7-6846-41d0-be8a-8ca3a0b9867a
[root@compute2 ~]# docker exec -it 0cde592eff6d sh
/ # ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue qlen 1000
    link/ether fa:16:3e:5d:d9:17 brd ff:ff:ff:ff:ff:ff
    inet 177.77.77.96/24 brd 177.77.77.255 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre>
<p>TODO: ext network:</p>
<p><img src="./images/2025_08_12_17_10_55_996x265.jpg" alt="./images/2025_08_12_17_10_55_996x265.jpg" /></p>
<pre><code>[root@controller ~]# openstack appcontainer list
+--------------------------------------+------+---------------+---------+--------------------+-----------------+-------+
| uuid                                 | name | image         | status  | task_state         | addresses       | ports |
+--------------------------------------+------+---------------+---------+--------------------+-----------------+-------+
| d0f549dc-411f-4240-bd6e-abfc9240f765 | qq   | cirros:latest | Created | container_starting | 192.168.150.111 | []    |
+--------------------------------------+------+---------------+---------+--------------------+-----------------+-------+
</code></pre>
<p>Failed ping(compute1, which docker instance located):</p>
<p><img src="./images/2025_08_12_17_11_28_939x652.jpg" alt="./images/2025_08_12_17_11_28_939x652.jpg" /></p>
<p><img src="./images/2025_08_12_17_14_13_790x649.jpg" alt="./images/2025_08_12_17_14_13_790x649.jpg" /></p>
<p>vnc to compute1 node, show the ip configuration:</p>
<p><img src="./images/2025_08_12_17_15_21_987x590.jpg" alt="./images/2025_08_12_17_15_21_987x590.jpg" /></p>
<p><code>192.168.150.111</code> added, then eth0 lost the connection.</p>
<p>Remove the items from db:</p>
<pre><code>mysql -uroot -p
MariaDB [(none)]&gt; show databases;
MariaDB [(none)]&gt; use zun
MariaDB [zun]&gt; select * from container;
MariaDB [zun]&gt; delete from container where id=21

</code></pre>
<p>(Compute1/2)Trouble shooting:</p>
<pre><code>systemctl restart zun-compute
</code></pre>
<p>Ext-network issue, modprobe veth won't solve the problem.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250813"><a class="header" href="#20250813">20250813</a></h1>
<h3 id="1-gpt-sovits-working-tips"><a class="header" href="#1-gpt-sovits-working-tips">1. GPT-SoVITS working tips</a></h3>
<p>Speech Slicing:</p>
<p><img src="./images/2025_08_13_15_13_31_478x129.jpg" alt="./images/2025_08_13_15_13_31_478x129.jpg" /></p>
<p><code>output/slicer_opt</code> foler content:</p>
<p><img src="./images/2025_08_13_15_14_35_685x453.jpg" alt="./images/2025_08_13_15_14_35_685x453.jpg" /></p>
<pre><code>sudo apt install sox
$ for file in *.wav; do echo "$file: $(soxi -D "$file") seconds"; done
ddd.wav_0000011520_0000168640.wav: 4.910000 seconds
ddd.wav_0000168640_0000290560.wav: 3.810000 seconds
ddd.wav_0000292160_0000429760.wav: 4.300000 seconds
ddd.wav_0000429760_0000530560.wav: 3.150000 seconds
ddd.wav_0000541760_0000683840.wav: 4.440000 seconds
ddd.wav_0000683840_0000821120.wav: 4.290000 seconds
...
</code></pre>
<p>Click <code>Open Speech Recognition</code>,</p>
<p><img src="./images/2025_08_13_15_18_34_1019x248.jpg" alt="./images/2025_08_13_15_18_34_1019x248.jpg" /></p>
<p>Click <code>Open Audio Labeling WebUI</code>, fix some words. Port is 9871:</p>
<p><img src="./images/2025_08_13_15_20_55_775x216.jpg" alt="./images/2025_08_13_15_20_55_775x216.jpg" /></p>
<p>After fix, <code>Close Audio Labeling WebUI</code>.</p>
<p>Fine-Tuned Model Information:</p>
<p><img src="./images/2025_08_13_15_28_43_1316x215.jpg" alt="./images/2025_08_13_15_28_43_1316x215.jpg" /></p>
<p><img src="./images/2025_08_13_15_29_05_834x251.jpg" alt="./images/2025_08_13_15_29_05_834x251.jpg" /></p>
<p>Status:</p>
<p><img src="./images/2025_08_13_15_29_21_722x140.jpg" alt="./images/2025_08_13_15_29_21_722x140.jpg" /></p>
<p>Finish:</p>
<p><img src="./images/2025_08_13_15_30_04_629x131.jpg" alt="./images/2025_08_13_15_30_04_629x131.jpg" /></p>
<p>Click <code>1B-Fine-Tuning</code>:</p>
<p><img src="./images/2025_08_13_15_30_30_664x315.jpg" alt="./images/2025_08_13_15_30_30_664x315.jpg" /></p>
<p>Click <code>Open SoVITS Traning</code>:</p>
<p><img src="./images/2025_08_13_15_31_08_762x341.jpg" alt="./images/2025_08_13_15_31_08_762x341.jpg" /></p>
<p><img src="./images/2025_08_13_15_31_18_453x142.jpg" alt="./images/2025_08_13_15_31_18_453x142.jpg" /></p>
<p><img src="./images/2025_08_13_15_32_39_503x116.jpg" alt="./images/2025_08_13_15_32_39_503x116.jpg" /></p>
<p>Result:</p>
<pre><code>dash@ai:~/Code/GPT-SoVITS$ ls SoVITS_weights_v2ProPlus/ddd* -l -h
-rw-r--r-- 1 root root 165M  8月 13 15:31 SoVITS_weights_v2ProPlus/ddd_e4_s20.pth
-rw-r--r-- 1 root root 165M  8月 13 15:32 SoVITS_weights_v2ProPlus/ddd_e8_s40.pth
</code></pre>
<p><code>Open GPT Traning</code>:</p>
<p><img src="./images/2025_08_13_15_33_51_1015x202.jpg" alt="./images/2025_08_13_15_33_51_1015x202.jpg" /></p>
<p>Result:</p>
<pre><code>dash@ai:~/Code/GPT-SoVITS$ ls GPT_weights_v2ProPlus/ddd-e* -l -h
-rw-r--r-- 1 root root 149M  8月 13 15:33 GPT_weights_v2ProPlus/ddd-e10.ckpt
-rw-r--r-- 1 root root 149M  8月 13 15:33 GPT_weights_v2ProPlus/ddd-e15.ckpt
-rw-r--r-- 1 root root 149M  8月 13 15:33 GPT_weights_v2ProPlus/ddd-e5.ckpt
</code></pre>
<h3 id="2-extract-wav"><a class="header" href="#2-extract-wav">2. extract wav</a></h3>
<p>55:51-&gt;58:20,<br />
Extrace via:</p>
<pre><code>ffmpeg -i kink.mp4 -vn -acodec pcm_s16le -ar 44100 -ac 2 -ss 00:55:51 -to 00:58:20 xxxa.wav
</code></pre>
<p>concat wav files:</p>
<pre><code>ffmpeg -f concat -i list.txt -c copy output3.wav
$  cat ~/list.txt                
file 'output1.wav'
file 'output2.wav'

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250814"><a class="header" href="#20250814">20250814</a></h1>
<h3 id="1-vxlan-under-bridge"><a class="header" href="#1-vxlan-under-bridge">1. vxlan under bridge</a></h3>
<p>(Compute)Add sysctl confs:</p>
<pre><code>vim /etc/sysctl.conf
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
sysctl -p

vim /etc/neutron/neutron.conf
[DEFAULT]
...
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = True

vim /etc/neutron/pluings/ml2/linuxbridge_agent.ini
...
[vxlan]
local_ip = 192.168.150.12
enable_vxlan = true
l2_population = True

[agent]
tunnel_types = vxlan
prevent_arp_spoofing = True
...
</code></pre>
<p>(Controller) enable l3 agent:</p>
<pre><code>vim /etc/neutron/l3_agent.ini
[DEFAULT]
interface_driver = linuxbridge
external_network_bridge =
verbose = True

systemctl enable neutron-l3-agent.service --now
</code></pre>
<p>(All nodes) add oslo messaging related:</p>
<pre><code># vim /etc/neutron/neutron.conf
[oslo_messaging_rabbit]
rabbit_host = controller
rabbit_userid = openstack
rabbit_password = openstack

</code></pre>
<p>Then reboot.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250815"><a class="header" href="#20250815">20250815</a></h1>
<h3 id="fxxos-binderashmem-issue"><a class="header" href="#fxxos-binderashmem-issue">FXXOS binder/ashmem issue</a></h3>
<p>Install packages:</p>
<pre><code>yum update
yum install -y kernel-devel kernel-headers dkms unzip make vim docker
systemctl enable docker --now
</code></pre>
<p>Kernel module compilation:</p>
<pre><code>tar xzvf fxxosredroid.tar.gz
cd fxxosredroid/ashmem
./INSTALL.sh
cd -
cd fxxosredroid/binder
./INSTALL.sh
</code></pre>
<p>Add module configuration</p>
<pre><code># vim /etc/modprobe.d/anbox.conf
options binder_linux devices=binder,hwbinder,vndbinder
# dracut -f --kver  `uname -r`
# reboot
</code></pre>
<p>Verify:</p>
<pre><code>[root@verify ~]# ls /dev/*binder*
/dev/anbox-binder    /dev/anbox-vndbinder  /dev/hwbinder
/dev/anbox-hwbinder  /dev/binder           /dev/vndbinder
[root@verify ~]# ls /dev/ashmem 
/dev/ashmem
</code></pre>
<p>virgl won't acts OK.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250818"><a class="header" href="#20250818">20250818</a></h1>
<h3 id="1-idvrtx-passthrough"><a class="header" href="#1-idvrtx-passthrough">1. idv(rtx passthrough)</a></h3>
<h4 id="11-bios-configuration"><a class="header" href="#11-bios-configuration">1.1 bios configuration</a></h4>
<p>Disable <code>Internal Graphics</code>(If present):</p>
<p><img src="./images/2025_08_18_09_05_59_612x371.jpg" alt="./images/2025_08_18_09_05_59_612x371.jpg" /></p>
<p><img src="./images/2025_08_18_09_06_13_509x176.jpg" alt="./images/2025_08_18_09_06_13_509x176.jpg" /></p>
<p>Boot from CD(or external usb disk):</p>
<p><img src="./images/2025_08_18_09_07_12_596x429.jpg" alt="./images/2025_08_18_09_07_12_596x429.jpg" /></p>
<p>Save and exit, reboot to installation.</p>
<h4 id="12-system-installationconfiguration"><a class="header" href="#12-system-installationconfiguration">1.2 System Installation/Configuration</a></h4>
<p>Choose <code>Install Ubuntu</code>:</p>
<p><img src="./images/2025_08_18_09_08_24_943x213.jpg" alt="./images/2025_08_18_09_08_24_943x213.jpg" /></p>
<p>Nvidia card won't work(ubuntu18.04 didn't have the device driver).</p>
<p>Use internal graphical card for installation:</p>
<p><img src="./images/2025_08_18_09_26_00_797x467.jpg" alt="./images/2025_08_18_09_26_00_797x467.jpg" /></p>
<p>Manually install deriver under installed system:</p>
<pre><code># ./NVIDIA-Linux-x86_64-580.76.05.run  
# reboot
root@idvgen12:~# lspci -vvnn -s 01:00.0 | grep 'Kernel driver in'
	Kernel driver in use: nvidia
root@idvgen12:~# lspci | grep -i vga
01:00.0 VGA compatible controller: NVIDIA Corporation Device 2786 (rev a1)
09:00.0 VGA compatible controller: ASPEED Technology, Inc. ASPEED Graphics Family (rev 52)
</code></pre>
<p>Change default grub configuration:</p>
<pre><code># vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash iommu=pt kvm.ignore_msrs=1 intel_iommu=on intel_iommu=pt video=efifb:off,vesafb:off initcall_blacklist=sysfb_init modprobe.blacklist=ast"
# update-grub2 &amp;&amp; reboot
</code></pre>
<h4 id="13-vfio-hooks-debugging"><a class="header" href="#13-vfio-hooks-debugging">1.3 vfio hooks debugging</a></h4>
<p>adjust for making it workable for nvidia card:</p>
<pre><code>root@idvgen12:~# cat /bin/detectgpu.sh | grep -i nvidia
vgaid=`lspci | grep -i vga | grep -i nvidia | awk {'print $1'}`
reserveid=`lspci | grep -i vga | grep -i nvidia | awk -F ':' {'print $1'}`

/bin/vfio-startup.sh and /bin/vfio-teardown.sh remains the same.    
</code></pre>
<h4 id="14-vm-preparation"><a class="header" href="#14-vm-preparation">1.4 vm preparation</a></h4>
<p>vm disk preparation:</p>
<pre><code>root@idvgen12:~# mv /home/test/little_win10.qcow2 /var/lib/libvirt/images/
root@idvgen12:~# qemu-img create -f qcow2 -b /var/lib/libvirt/images/little_win10.qcow2 -F qcow2 /var/lib/libvirt/images/nvidia_win10.qcow2
</code></pre>
<p>Import disk and generate the vm:</p>
<p><img src="./images/2025_08_18_10_44_35_928x528.jpg" alt="./images/2025_08_18_10_44_35_928x528.jpg" /></p>
<p>minimum configuration:</p>
<p><img src="./images/2025_08_18_10_44_54_684x545.jpg" alt="./images/2025_08_18_10_44_54_684x545.jpg" /></p>
<p>Enable remote desktop:</p>
<p><img src="./images/2025_08_18_10_45_37_568x429.jpg" alt="./images/2025_08_18_10_45_37_568x429.jpg" /></p>
<p>Adjust the processor for setting 12 cores:</p>
<p><img src="./images/2025_08_18_10_46_18_563x412.jpg" alt="./images/2025_08_18_10_46_18_563x412.jpg" /></p>
<p>12=6core/2threads:</p>
<p><img src="./images/2025_08_18_10_49_26_515x339.jpg" alt="./images/2025_08_18_10_49_26_515x339.jpg" /></p>
<p>Change to e1000 ethernet card for networking:</p>
<p><img src="./images/2025_08_18_10_47_23_500x272.jpg" alt="./images/2025_08_18_10_47_23_500x272.jpg" /></p>
<p><code>192.168.123.142</code> for connecting:</p>
<p><img src="./images/2025_08_18_10_48_15_473x269.jpg" alt="./images/2025_08_18_10_48_15_473x269.jpg" /></p>
<h4 id="15-vm-adjust"><a class="header" href="#15-vm-adjust">1.5 vm adjust.</a></h4>
<p>Add nvidia card, keyboard, mouse:</p>
<p><img src="./images/2025_08_18_10_53_05_355x140.jpg" alt="./images/2025_08_18_10_53_05_355x140.jpg" /></p>
<p>vfio hook:</p>
<pre><code>root@idvgen12:~# cat /etc/libvirt/hooks/qemu  | grep ^INSTANCE
INSTANCE="nvidia_win10"
# systemctl restart libvirtd
# virsh start nvidia_win10
</code></pre>
<p>kvm output:</p>
<p><img src="./images/2025_08_18_10_55_50_757x630.jpg" alt="./images/2025_08_18_10_55_50_757x630.jpg" /></p>
<p>ssh forwarding to windows' remote desktop:</p>
<pre><code>root@idvgen12:/etc/apt/sources.list.d# ssh -L 0.0.0.0:13389:192.168.123.142:3389 test@192.168.1.101
</code></pre>
<p>Wait for windows update for updating the system:</p>
<p><img src="./images/2025_08_18_10_59_26_394x271.jpg" alt="./images/2025_08_18_10_59_26_394x271.jpg" /></p>
<p>also using virtio iso for updating the system driver</p>
<p>Add the python-qt5 scripts, but this script won't start, until:</p>
<pre><code>usermod -aG libvirt test
</code></pre>
<p>Also comment all of the <code>sudo</code> related items under <code>/opt/bgok_close.py</code>.</p>
<h3 id="2-redo-nvidia-idv256g-ssd"><a class="header" href="#2-redo-nvidia-idv256g-ssd">2. redo nvidia-idv(256G ssd)</a></h3>
<p><img src="./images/2025_08_18_11_43_24_710x626.jpg" alt="./images/2025_08_18_11_43_24_710x626.jpg" /></p>
<p><img src="./images/2025_08_18_11_44_26_663x431.jpg" alt="./images/2025_08_18_11_44_26_663x431.jpg" /></p>
<p>rescuezilla clone:</p>
<p><img src="./images/2025_08_18_14_52_36_607x260.jpg" alt="./images/2025_08_18_14_52_36_607x260.jpg" /></p>
<h3 id="3-rescuzilla"><a class="header" href="#3-rescuzilla">3. rescuzilla</a></h3>
<p>选择语言：</p>
<p><img src="./images/2025_08_18_15_08_17_670x512.jpg" alt="./images/2025_08_18_15_08_17_670x512.jpg" /></p>
<p>点击<code>还原</code>:</p>
<p><img src="./images/2025_08_18_15_09_03_602x509.jpg" alt="./images/2025_08_18_15_09_03_602x509.jpg" /></p>
<p>还原镜像所在位置:</p>
<p><img src="./images/2025_08_18_15_09_53_537x393.jpg" alt="./images/2025_08_18_15_09_53_537x393.jpg" /></p>
<p>选择<code>nvidiaidv-2025-08-18xxxx</code></p>
<p><img src="./images/2025_08_18_15_10_33_1038x403.jpg" alt="./images/2025_08_18_15_10_33_1038x403.jpg" /></p>
<p>选择需要还原到的硬盘:</p>
<p><img src="./images/2025_08_18_15_11_16_798x265.jpg" alt="./images/2025_08_18_15_11_16_798x265.jpg" /></p>
<p>保持默认:</p>
<p><img src="./images/2025_08_18_15_11_32_1055x538.jpg" alt="./images/2025_08_18_15_11_32_1055x538.jpg" /></p>
<p>点击下一步，并选择确认后开始还原:</p>
<p><img src="./images/2025_08_18_15_12_00_997x393.jpg" alt="./images/2025_08_18_15_12_00_997x393.jpg" /></p>
<p>还原过程, 并查看其进度:</p>
<p><img src="./images/2025_08_18_15_14_03_919x369.jpg" alt="./images/2025_08_18_15_14_03_919x369.jpg" /></p>
<p><img src="./images/2025_08_18_15_19_43_586x444.jpg" alt="./images/2025_08_18_15_19_43_586x444.jpg" /></p>
<p>点击桌面的gparted, 扩充磁盘:</p>
<p><img src="./images/2025_08_18_15_20_14_1093x406.jpg" alt="./images/2025_08_18_15_20_14_1093x406.jpg" /></p>
<p>切换到sda:</p>
<p><img src="./images/2025_08_18_15_20_31_666x296.jpg" alt="./images/2025_08_18_15_20_31_666x296.jpg" /></p>
<p>扩充到100%:</p>
<p><img src="./images/2025_08_18_15_20_47_678x408.jpg" alt="./images/2025_08_18_15_20_47_678x408.jpg" /></p>
<p>确认应用:</p>
<p><img src="./images/2025_08_18_15_21_02_527x350.jpg" alt="./images/2025_08_18_15_21_02_527x350.jpg" /></p>
<p>点击关闭后，重启</p>
<h3 id="4-bios-for-silver"><a class="header" href="#4-bios-for-silver">4. bios for silver</a></h3>
<p><img src="./images/2025_08_18_17_40_59_994x515.jpg" alt="./images/2025_08_18_17_40_59_994x515.jpg" /></p>
<p>A6000 maybe need passthrough vbt files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250819"><a class="header" href="#20250819">20250819</a></h1>
<h3 id="1-a6000-passthroughcontinue"><a class="header" href="#1-a6000-passthroughcontinue">1. a6000 passthrough(continue)</a></h3>
<p>Disable os probe in grub:</p>
<pre><code># vim /etc/default/grub
GRUB_DISABLE_OS_PROBER=true
# update-grub2 &amp;&amp; reboot
</code></pre>
<p><img src="./images/2025_08_19_08_14_25_563x156.jpg" alt="./images/2025_08_19_08_14_25_563x156.jpg" /></p>
<p>Solved via:</p>
<pre><code>cd /boot/grub
rm grubenv
grub-editenv grubenv create
grub-editenv grubenv set default=0
grub-editenv grubenv list
update-grub
</code></pre>
<p>Extrace the vbios and edit it with okteta, also the same as before.</p>
<p><img src="./images/2025_08_19_09_09_30_682x528.jpg" alt="./images/2025_08_19_09_09_30_682x528.jpg" /></p>
<p>Change win10 images to ubuntu2004/uefi image, the same result.</p>
<h3 id="2-rtxa600-passthroughubuntu2404"><a class="header" href="#2-rtxa600-passthroughubuntu2404">2. rtxa600 passthrough(ubuntu2404)</a></h3>
<p>Not needed, for we have to adjust so much on ubuntu2404.</p>
<h3 id="3-z790-issue"><a class="header" href="#3-z790-issue">3. z790 issue</a></h3>
<p>z790 issue, close <code>Above 4GB MMIO BIOS assignment</code>:</p>
<p><img src="./images/2025_08_19_17_51_56_930x517.jpg" alt="./images/2025_08_19_17_51_56_930x517.jpg" /></p>
<p>Close <code>Above 4G Decoding</code> and <code>Re-Size BAR Support</code>:</p>
<p><img src="./images/2025_08_19_17_53_09_1133x483.jpg" alt="./images/2025_08_19_17_53_09_1133x483.jpg" /></p>
<p>Detailed changes:</p>
<p><img src="./images/2025_08_19_17_53_25_808x177.jpg" alt="./images/2025_08_19_17_53_25_808x177.jpg" /></p>
<p><img src="./images/2025_08_19_17_53_35_617x221.jpg" alt="./images/2025_08_19_17_53_35_617x221.jpg" /></p>
<p>Then z790 will passthrough RTX A6000</p>
<h3 id="4-video-explanation"><a class="header" href="#4-video-explanation">4. video explanation</a></h3>
<p>00:00           使用写入的U盘启动机器,进入rescuezilla的启动过程。<br />
01:04            启动到rescuezilla图形界面下，此时插入另一块含有还原镜像文件的移动硬盘（或优盘）<br />
01:18 ~ 02:04   插入前后的移动硬盘情况。<br />
02:27           选择正确的含有还原镜像文件的移动硬盘<br />
03:03           导航到含有镜像文件的目录<br />
03:22           选择需写入的目标磁盘<br />
03:37           写入开始<br />
08:36           写入完毕，关闭rescuezilla界面<br />
09:03           使用gparted扩充磁盘（因原始磁盘大小为100G,需扩充到目标磁盘的512G）<br />
09:32           重启。重启时拔掉所有的USB盘.<br />
09:55 ~ 10:43   调整启动顺序（因为我们的目标机器上有多块硬盘则需要执行此操作)<br />
11:30           进入idv管控界面<br />
11:50           如果需要联网，则按照此步骤进行联网<br />
12:13           使用virt-manager调整虚拟机配置（需调整显卡/显卡板载声卡、usb鼠标/键盘）<br />
13:44           nvidia-smi查看显卡信息<br />
13:53           点击启动idv虚机（如果是第一次启动则可能有部分系统调整会导致有一定耗时，更新完以后启动速度会恢复正常$）<br />
16:59           虚机内查看显卡信息<br />
17:22-&gt;最后     展示IDV的关机/重启等操作。</p>
<p>操作步骤：</p>
<ol>
<li>下载iso文件(<code>rescuezilla-2.6.1-64bit.oracular.iso</code>)及镜像文件(<code>nvidia_idv_noi915_2025-08-18-0849-img-rescuezilla.tar.xz</code>)</li>
<li>Linux下使用dd命令，或者windows下使用rufus软件(<code>https://rufus.ie/zh/</code>)将<code>rescuezilla-2.6.1-64bit.oracular.iso</code>写入到usb优盘（优盘需至少2G大小).</li>
</ol>
<pre><code>sudo dd if=./rescuezilla-2.6.1-64bit.oracular.iso of=/dev/你的优盘设备名 bs=1M &amp;&amp; sudo sync
</code></pre>
<ol start="3">
<li>将<code>nvidia_idv_noi915_2025-08-18-0849-img-rescuezilla.tar.xz</code>文件解压到某移动硬盘的目录下，注意解压前进行md5校验(md5值为<code>e1f978279381be9ffc5d2687e3783fc9</code>)</li>
<li>按<code>rescuezilla_write_image-2025-08-19_17.28.06.mp4</code>视频, 使用优盘启动物理机器并执行rescuezilla镜像还原.</li>
<li>还原成功后，拔掉U盘和移动硬盘，进入系统，按视频调整虚拟化配置并启动IDV虚机。镜像中已包含一个win10虚机。</li>
</ol>
<p>操作说明：</p>
<ol>
<li>
<p>镜像已在映泰z790+(RTX3050/RTX6000/RTXA6000）下验证，镜像已在同方工作站(Z690+RTX4070-12G)下验证。<br />
3050:       <code>nvidiaidv_3050-2025-08-19_14.54.23.mp4</code>
RTX6000:    <code>nvidiaidv_6000-2025-08-19_16.23.23.mp4</code>
RTXA6000:   <code>nvidiaidv_a6000_gen12z790-2025-08-19_17.04.39.mp4</code>
同方+4070:       <code>rescuezilla_write_image-2025-08-19_17.28.06.mp4</code></p>
</li>
<li>
<p>BIOS中需开启iommu功能，vt-d功能，并关闭以下选项</p>
</li>
</ol>
<p>z790 下为支持RTXA6000, 需关闭 <code>Above 4GB MMIO BIOS assignment</code>:</p>
<p><img src="./images/2025_08_19_17_51_56_930x517.jpg" alt="./images/2025_08_19_17_51_56_930x517.jpg" /></p>
<p>关闭 <code>Above 4G Decoding</code> 和 <code>Re-Size BAR Support</code>:</p>
<p><img src="./images/2025_08_19_17_53_09_1133x483.jpg" alt="./images/2025_08_19_17_53_09_1133x483.jpg" /></p>
<p>更改详细细节:</p>
<p><img src="./images/2025_08_19_17_53_25_808x177.jpg" alt="./images/2025_08_19_17_53_25_808x177.jpg" /></p>
<p><img src="./images/2025_08_19_17_53_35_617x221.jpg" alt="./images/2025_08_19_17_53_35_617x221.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250820"><a class="header" href="#20250820">20250820</a></h1>
<h3 id="1-idv-enhancement"><a class="header" href="#1-idv-enhancement">1. idv enhancement</a></h3>
<p>enhancement under other md file.</p>
<pre><code>"Re-Size BAR Support"（也称为Resizable BAR或ReBAR）是一个BIOS选项，用于启用PCIe设备的Resizable BAR功能。该功能允许CPU直接访问GPU的整个视频内存（VRAM），而不是传统上限制在较小的256MB块中，从而优化系统资源分配，提高游戏和图形密集型应用的性能，例如减少数据传输延迟并提升帧率。

对于RTX-A6000在KVM下的GPU透传（passthrough），需要关闭此选项的原因是：当启用ReBAR时，GPU的基地址寄存器（BAR）会被设置为匹配其VRAM大小（A6000为48GB），这要求分配大量的连续内存地址空间。然而，在QEMU/KVM虚拟化环境中，默认的OVMF/EDK2固件提供的MMIO（内存映射I/O）地址空间通常限制在32GB左右，无法容纳如此大的BAR大小，导致地址分配冲突、虚拟机启动失败或黑屏等问题。如果不关闭ReBAR，透传过程会因资源不足而中断。

RTX-4070（12GB VRAM）和RTX-3050（4GB或8GB VRAM）在ReBAR开启时能成功透传，而A6000（48GB VRAM）不能，主要原因是VRAM大小的差异导致的BAR分配需求不同。较小的VRAM意味着BAR大小也较小（例如12GB以下），这可以轻松适应KVM默认的32GB MMIO地址空间，而不会引起冲突。A6000的48GB VRAM会要求更大的BAR（超过32GB限制），导致地址空间不足和透传失败。此外，RTX-4070基于Ada Lovelace架构，可能在固件或驱动层面有更好的虚拟化兼容性优化，而A6000作为Ampere架构的专业工作站卡（类似于RTX 3090），在高VRAM配置下更容易遇到这些问题。
</code></pre>
<h3 id="2-queenszun"><a class="header" href="#2-queenszun">2. Queens(zun)</a></h3>
<p>Create 3 nodes, using 192.168.160.0/24 networking, based on centos7.</p>
<p>Create bridge via:</p>
<pre><code>nmcli con add type bridge ifname br0
nmcli con modify bridge-br0 bridge.stp no
nmcli con modify bridge-br0 ipv4.method manual ipv4.address "192.168.160.13/24" ipv4.gateway "192.168.160.1" ipv4.dns 223.5.5.5 
nmcli con add type bridge-slave ifname eth0 master bridge-br0
nmcli con del eth0
reboot
</code></pre>
<p>(All nodes) configuration for hosts:</p>
<pre><code>cat &gt;&gt;/etc/hosts&lt;&lt;EOF

# controller
192.168.160.11    controller

# compute
192.168.160.12    compute1
192.168.160.13    compute2
EOF
yum install -y centos-release-openstack-queens
</code></pre>
<p>(Controller) configuration for repo:</p>
<pre><code>cd /etc/yum.repos.d
vim CentOS-OpenStack-queens.repo 
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/cloud/x86_64/openstack-queens/
vim CentOS-Ceph-Luminous.repo 
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/storage/x86_64/ceph-nautilus/
vim CentOS-QEMU-EV.repo 
baseurl=https://mirrors.ustc.edu.cn/centos-vault/7.9.2009/virt/x86_64/kvm-common/
yum makecache
yum install -y python-openstackclient 
scp CentOS-OpenStack-queens.repo CentOS-Ceph-Luminous.repo CentOS-QEMU-EV.repo compute1:/etc/yum.repos.d/
scp CentOS-OpenStack-queens.repo CentOS-Ceph-Luminous.repo CentOS-QEMU-EV.repo compute2:/etc/yum.repos.d/
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250821"><a class="header" href="#20250821">20250821</a></h1>
<h3 id="1-zunqueens"><a class="header" href="#1-zunqueens">1. zun(queens)</a></h3>
<p>queens/zun failed for using external networking.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250822"><a class="header" href="#20250822">20250822</a></h1>
<h3 id="1-rebuild-w6800-rpm"><a class="header" href="#1-rebuild-w6800-rpm">1. rebuild w6800 rpm</a></h3>
<p>Environment:</p>
<pre><code>[root@ctyunos2505 ~]# uname -a
Linux ctyunos2505 4.19.326-0092.ctl3.aarch64 #1 SMP Thu Jun 5 09:22:59 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux
[root@ctyunos2505 ~]# cat /etc/*release*
ctyunos release 2 25.05
</code></pre>
<p>Fetch the source code for building kernel:</p>
<pre><code>https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v5.x/linux-5.15.98.tar.gz
wget https://mirrors.huaweicloud.com/kunpeng/archive/kunpeng_solution/ARMNative/BoostKit23.0.RC2_Demo/Kbox/Kbox-AOSP11.zip
</code></pre>
<p>patch with failed items:</p>
<pre><code>[root@ctyunos2505 linux-5.15.98]# vim drivers/gpu/drm/amd/display/Kconfig
[root@ctyunos2505 linux-5.15.98]# vim drivers/gpu/drm/amd/display/amdgpu_dm/dc_fpu.c
[root@ctyunos2505 linux-5.15.98]# vim  drivers/gpu/drm/i915/i915_memcpy.c
[root@ctyunos2505 linux-5.15.98]# vim sound/pci/hda/hda_intel.c +2685
</code></pre>
<p>pahole 1.23 compilation.</p>
<p>Compile kernel:</p>
<pre><code>time make rpm-pkg -j$(nproc)
yum install -y rsync cmake


[root@ctyunos2505 linux-5.15.98]# mkdir ~/5.15.98
[root@ctyunos2505 linux-5.15.98]# cp /root/rpmbuild/RPMS/aarch64/*.rpm ~/5.15.98/
[root@ctyunos2505 linux-5.15.98]# cp /root/rpmbuild/SRPMS/kernel-5.15.98-1.ctl3.src.rpm ~/5.15.98/
[root@ctyunos2505 linux-5.15.98]# cd ~/5.15.98/
[root@ctyunos2505 5.15.98]# yum install ./kernel-5.15.98-1.ctl3.aarch64.rpm 
[root@ctyunos2505 5.15.98]# grubby --set-default /boot/vmlinuz-5.15.98 

reboot

[root@ctyunos2505 ~]# uname -a
Linux ctyunos2505 5.15.98 #1.ctl3 SMP Fri Aug 22 10:39:30 CST 2025 aarch64 aarch64 aarch64 GNU/Linux
</code></pre>
<p>Run redroid:</p>
<pre><code>docker run -itd   --privileged redroid/redroid:12.0.0_64only-latest
[root@ctyunos2505 ~]# docker exec -it 043ceff0fb1e sh
043ceff0fb1e:/ # getprop | grep boot | grep com                                                                                                                                              
[dev.bootcomplete]: [1]
[ro.boottime.vendor.hwcomposer-2-1]: [501672112315]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
</code></pre>
<h3 id="2-openstack-c-version"><a class="header" href="#2-openstack-c-version">2. Openstack-C-Version</a></h3>
<p>Refers to <code>https://www.cnblogs.com/hoyeong/p/18793073#neutron_644</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250825"><a class="header" href="#20250825">20250825</a></h1>
<h3 id="1-comfyui"><a class="header" href="#1-comfyui">1. comfyui</a></h3>
<p>Install steps(Using tsinghua repository):</p>
<pre><code>python3 -m venv comfy-env
source /media/sda/ai/comfy-env/bin/activate
pip install comfy-cli -i https://pypi.tuna.tsinghua.edu.cn/simple
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
rm -rf comfyworkspace/
comfy --workspace=/media/sda/ai/comfyworkspace install
</code></pre>
<p><img src="./images/2025_08_25_11_40_19_945x610.jpg" alt="./images/2025_08_25_11_40_19_945x610.jpg" /></p>
<pre><code>comfy launch -- --listen 0.0.0.0 --port 18080 
</code></pre>
<p><img src="./images/2025_08_25_11_49_22_1249x729.jpg" alt="./images/2025_08_25_11_49_22_1249x729.jpg" /></p>
<pre><code>official: 
1280x720, comfy ui, 48G 40min
1280x720, KJ, 48G 40min
</code></pre>
<p>Install kj:</p>
<p>customization node manager:</p>
<p><img src="./images/2025_08_25_11_54_51_1315x621.jpg" alt="./images/2025_08_25_11_54_51_1315x621.jpg" /></p>
<p><img src="./images/2025_08_25_11_55_42_953x191.jpg" alt="./images/2025_08_25_11_55_42_953x191.jpg" /></p>
<p><img src="./images/2025_08_25_11_55_58_342x442.jpg" alt="./images/2025_08_25_11_55_58_342x442.jpg" /></p>
<p>Changes to <code>Install</code> status:</p>
<p><img src="./images/2025_08_25_11_56_24_592x106.jpg" alt="./images/2025_08_25_11_56_24_592x106.jpg" /></p>
<p>After installation:</p>
<p><img src="./images/2025_08_25_11_57_19_614x161.jpg" alt="./images/2025_08_25_11_57_19_614x161.jpg" /></p>
<h3 id="2-nfs-buf-fix-on-arch"><a class="header" href="#2-nfs-buf-fix-on-arch">2. nfs buf-fix on arch</a></h3>
<p>bug:</p>
<pre><code>nfs: mount program didn't pass remote address
</code></pre>
<p>Solved via install <code>nfs-utils</code> under archlinux</p>
<h3 id="3-euler-kernel-for-xxx"><a class="header" href="#3-euler-kernel-for-xxx">3. euler kernel for xxx</a></h3>
<p>Steps:</p>
<pre><code>useradd -m mock
wget xxxxx.rpm
su - mock
rpm -ivh kernel-5.10.0-278.0.0.181.oe2203sp4.src.rpm
vim rpmbuild/SPECS/kernel.spec
comment OpenCSD
  129 BuildRequires: libtraceevent-devel &gt; 1.2.1-4
-&gt;
  129 BuildRequires: libtraceevent-devel 

su root
yum-builddep kernel.spec

After building
yum install ./kernel-5.10.0-278.0.0.181.ctl3.aarch64.rpm
grubby --set-default /boot/vmlinuz-5.10.0-278.0.0.181.ctl3.aarch64

reboot
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250826"><a class="header" href="#20250826">20250826</a></h1>
<h3 id="1-euler-kernel-build"><a class="header" href="#1-euler-kernel-build">1. euler kernel build</a></h3>
<p>Issue:</p>
<pre><code>*** ERROR - ABI BREAKAGE WAS DETECTED ***
</code></pre>
<p>Solved via</p>
<pre><code>vim SPECS/kernel.spec
%define with_kabichk 0
%else
%define with_kabichk 0
%endif
</code></pre>
<p>Kernel source file:</p>
<pre><code>su - mock
rpm -ivh kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
</code></pre>
<h3 id="2-winapp"><a class="header" href="#2-winapp">2. winapp</a></h3>
<p><img src="./images/2025_08_26_16_50_50_463x283.jpg" alt="./images/2025_08_26_16_50_50_463x283.jpg" /></p>
<p>fixed ip address:</p>
<pre><code>root@test-P860:/var/lib/libvirt/images# virsh dumpxml RDPWindows| grep mac
    &lt;type arch='x86_64' machine='pc-q35-8.2'&gt;hvm&lt;/type&gt;
      &lt;mac address='52:54:00:0e:95:70'/&gt;
root@test-P860:/var/lib/libvirt/images# virsh net-edit "default"

&lt;dhcp&gt;
  &lt;range start="192.168.122.2" end="192.168.122.254"/&gt;
  &lt;host mac="df:87:4c:75:e5:fb" name="RDPWindows" ip="192.168.122.2"/&gt;

Network default XML configuration edited.

root@test-P860:/var/lib/libvirt/images# virsh net-destroy "default"
Network default destroyed

root@test-P860:/var/lib/libvirt/images# virsh net-start "default"
Network default started

root@test-P860:/var/lib/libvirt/images# virsh start RDPWindows
Domain 'RDPWindows' started

</code></pre>
<h3 id="3-kernel-build-in-euler"><a class="header" href="#3-kernel-build-in-euler">3. kernel build in euler</a></h3>
<p>issue:</p>
<pre><code>	asciidoc is needed by kernel-5.10.0-136.12.0.86.aarch64
	audit-libs-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	binutils-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	bison is needed by kernel-5.10.0-136.12.0.86.aarch64
	clang &gt;= 10.0.0 is needed by kernel-5.10.0-136.12.0.86.aarch64
	dwarves is needed by kernel-5.10.0-136.12.0.86.aarch64
	elfutils-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	elfutils-libelf-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	flex is needed by kernel-5.10.0-136.12.0.86.aarch64
	gcc &gt;= 3.4.2 is needed by kernel-5.10.0-136.12.0.86.aarch64
	gettext is needed by kernel-5.10.0-136.12.0.86.aarch64
	glibc-static is needed by kernel-5.10.0-136.12.0.86.aarch64
	gtk2-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	hmaccalc is needed by kernel-5.10.0-136.12.0.86.aarch64
	hostname is needed by kernel-5.10.0-136.12.0.86.aarch64
	java-1.8.0-openjdk is needed by kernel-5.10.0-136.12.0.86.aarch64
	java-1.8.0-openjdk-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	java-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	libbabeltrace-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	libcap-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	libcap-ng-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	libunwind-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	libzstd-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	llvm is needed by kernel-5.10.0-136.12.0.86.aarch64
	m4 is needed by kernel-5.10.0-136.12.0.86.aarch64
	module-init-tools is needed by kernel-5.10.0-136.12.0.86.aarch64
	ncurses-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	net-tools is needed by kernel-5.10.0-136.12.0.86.aarch64
	newt-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	numactl-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	openssl is needed by kernel-5.10.0-136.12.0.86.aarch64
	openssl-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	pciutils-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	perl is needed by kernel-5.10.0-136.12.0.86.aarch64
	perl(Carp) is needed by kernel-5.10.0-136.12.0.86.aarch64
	perl(ExtUtils::Embed) is needed by kernel-5.10.0-136.12.0.86.aarch64
	perl-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	perl-generators is needed by kernel-5.10.0-136.12.0.86.aarch64
	python3-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	python3-docutils is needed by kernel-5.10.0-136.12.0.86.aarch64
	rsync is needed by kernel-5.10.0-136.12.0.86.aarch64
	xmlto is needed by kernel-5.10.0-136.12.0.86.aarch64
	xz-devel is needed by kernel-5.10.0-136.12.0.86.aarch64
	zlib-devel is needed by kernel-5.10.0-136.12.0.86.aarch64

steps

    1   sed -E 's#https?://(repo|mirrors)\.openeuler\.org/#http://mirrors.ustc.edu.cn/openeuler/#g'          -i.bak          /etc/yum.repos.d/openEuler.repo
    2  yum makecache
    3  useradd -m mock
    4  cd /home/mock/
    5  ls
    6  cd rpmbuild/
    7  ls
    8  cd SPECS/
    9  ls
   10  yum-builddp kernel.spec
   11  yum install yum-utils
   12  yum search yum-builddp
   13  yum install yum-utils
   14  yum install make
   15  yum install yum-utils
   16  yum search yum-utils
   17  ls
   18  grep -E '^(Requires|BuildRequires):'  kernel.spec
   19  grep -E '^(Requires|BuildRequires):'  kernel.spec| awk '{print $2}' | sort -u &gt; dependencies.txt
   20  cat dependencies.txt 
   21  dnf builddep kernel.spec 
   22  rpmbuild -ba kernel.spec 
   23  yum install rpmbuild
   24  yum install rpm-builder
   25  yum search rpm
   26  yum install rpm-build
   27  rpmbuild -ba kernel.spec 
   28  su - mock
   29  yum install sudo
   30  sudo -i su
   31  yum install util-linux
   32  su - mock
   33  ls

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250827"><a class="header" href="#20250827">20250827</a></h1>
<h3 id="1-euler-kernel-compile"><a class="header" href="#1-euler-kernel-compile">1. euler kernel compile</a></h3>
<p>Steps:</p>
<pre><code>sed -E 's#https?://(repo|mirrors)\.openeuler\.org/#https://mirrors.ustc.edu.cn/openeuler/#g' \
         -i.bak \
         /etc/yum.repos.d/openEuler.repo
yum makecache
wget https://mirrors.ustc.edu.cn/openeuler/openEuler-22.03-LTS-SP1/source/Packages/kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
useradd -m mock
mv kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm /home/mock/ &amp;&amp; chmod 777 /home/mock/kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
yum install -y rpm-build asciidoc audit-libs-devel binutils-devel bison clang dwarves elfutils-devel elfutils-libelf-devel flex gcc glibc-static gtk2-devel java-1.8.0-openjdk java-1.8.0-openjdk-devel java-devel libbabeltrace-devel libcap-devel libcap-ng-devel libunwind-devel libzstd-devel llvm m4 make ncurses-devel net-tools newt-devel numactl-devel openssl-devel pciutils-devel perl-generators python3-devel python3-docutils rsync xmlto xz-devel zlib-devel
su - mock
</code></pre>
<p>As mock:</p>
<pre><code>rpm -ivh kernel-5.10.0-136.12.0.86.oe2203sp1.src.rpm
cd /home/mock/rpmbuild/SOURCES
tar xzvf kernel.tar.gz
cd kernel
cp /boot/config-5.10.0-136.12.0.86.oe2203sp1.aarch64 .config
make menuconfig
</code></pre>
<p>Open following items:</p>
<pre><code>## use custom kernel 5.10.* LTS

# codec2 required
CONFIG_DMABUF_HEAPS=y
CONFIG_DMABUF_HEAPS_SYSTEM=y

CONFIG_STAGING=y
CONFIG_ASHMEM=y

# binderfs required
CONFIG_ANDROID=y
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ANDROID_BINDERFS=y
CONFIG_ANDROID_BINDER_DEVICES="binder,hwbinder,vndbinder"」
</code></pre>
<p>Back config, re-org package:</p>
<pre><code>  cp .config ~/configkernel
  cd ..
  rm -rf kernel
  tar xzvf kernel.tar.gz 
  cp ~/configkernel kernel/arch/arm64/configs/openeuler_defconfig 
  rm -f kernel.tar.gz 
  tar czvf kernel.tar.gz kernel/
  rm -rf kernel
</code></pre>
<p>Build the kernel:</p>
<pre><code>[mock@euler SOURCES]$ cd ../SPECS/
[mock@euler SPECS]$ time rpmbuild -ba kernel.spec 
</code></pre>
<h3 id="2-directly-write-qcow2"><a class="header" href="#2-directly-write-qcow2">2. directly write qcow2</a></h3>
<p>nixos enable related items:</p>
<pre><code># vim /etc/nixos/configuration.nix
...
+  boot.supportedFilesystems.apfs = true;
...

  environment.systemPackages = with pkgs; [
      weston
+      qemu
    ];
# sudo nixos-rebuild switch --option substituters  "https://mirrors.sjtug.sjtu.edu.cn/nix-channels/store"
</code></pre>
<p>Then :</p>
<pre><code> qemu-img dd -f qcow2 -O raw bs=4M if=/run/media/dash/009f7558-fd67-4765-98ba-6314ca6bb68e/images/ctyunos2505.qcow2 of=/dev/sdb

</code></pre>
<p>Boot from usb, then enter rescue mode:</p>
<pre><code>/usr/bin/dracut -f /boot/initramfs-5.15.98.img 5.15.98

choose 5.15 for starting
Then install new kernel.  

grub2-mkconfig ...
grubby --set-default
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250828"><a class="header" href="#20250828">20250828</a></h1>
<h3 id="1-perf-test"><a class="header" href="#1-perf-test">1. perf test</a></h3>
<p>under ubuntu24.04:</p>
<pre><code>
FTC862 (aarch64)
8 cores @ 2500 MHz  |  31.2 GiB RAM
Number of Processes: 8  |  Test Iterations: 1  |  Test Duration: Medium
--------------------------------------------------------------------------------
CPU Mark:                          3175
  Integer Math                     31417 Million Operations/s
  Floating Point Math              29067 Million Operations/s
  Prime Numbers                    47.2 Million Primes/s
  Sorting                          13067 Thousand Strings/s
  Encryption                       657 MB/s
  Compression                      19029 KB/s
  CPU Single Threaded              1280 Million Operations/s
  Physics                          534 Frames/s
  Extended Instructions (NEON)     2323 Million Matrices/s

Memory Mark:                       Incomplete
  Database Operations              2847 Thousand Operations/s
  Memory Read Cached               9103 MB/s
  Memory Read Uncached             9114 MB/s
  Memory Write                     12629 MB/s
  Available RAM                    30387 Megabytes
  Memory Latency                   76 Nanoseconds
  Memory Threaded                  Running (1/1)
--------------------------------------------------------------------------------

Results not submitted
</code></pre>
<p>under ubuntu20.04(docker under ubuntu22.04):</p>
<pre><code> (aarch64)
8 cores @ 2500 MHz  |  31.2 GiB RAM
Number of Processes: 8  |  Test Iterations: 1  |  Test Duration: Medium
--------------------------------------------------------------------------------
CPU Mark:                          5660
  Integer Math                     31419 Million Operations/s
  Floating Point Math              31491 Million Operations/s
  Prime Numbers                    52.5 Million Primes/s
  Sorting                          19931 Thousand Strings/s
  Encryption                       1345 MB/s
  Compression                      37584 KB/s
  CPU Single Threaded              1250 Million Operations/s
  Physics                          648 Frames/s
  Extended Instructions (NEON)     5435 Million Matrices/s

Memory Mark:                       1626
  Database Operations              4856 Thousand Operations/s
  Memory Read Cached               9518 MB/s
  Memory Read Uncached             9125 MB/s
  Memory Write                     12658 MB/s
  Available RAM                    30817 Megabytes
  Memory Latency                   77 Nanoseconds
  Memory Threaded                  26702 MB/s
</code></pre>
<p>ubuntu22.04:</p>
<pre><code> (aarch64)
8 cores @ 2500 MHz  |  31.2 GiB RAM
Number of Processes: 8  |  Test Iterations: 1  |  Test Duration: Medium
--------------------------------------------------------------------------------
CPU Mark:                          5692
  Integer Math                     31449 Million Operations/s
  Floating Point Math              31585 Million Operations/s
  Prime Numbers                    53.0 Million Primes/s
  Sorting                          20854 Thousand Strings/s
  Encryption                       1356 MB/s
  Compression                      37577 KB/s
  CPU Single Threaded              1268 Million Operations/s
  Physics                          644 Frames/s
  Extended Instructions (NEON)     5432 Million Matrices/s

Memory Mark:                       1634
  Database Operations              4856 Thousand Operations/s
  Memory Read Cached               9519 MB/s
  Memory Read Uncached             9129 MB/s
  Memory Write                     12653 MB/s
  Available RAM                    30822 Megabytes
  Memory Latency                   76 Nanoseconds
  Memory Threaded                  26711 MB/s
</code></pre>
<p>x86 under phybin:</p>
<pre><code> (x86_64)
8 cores @ 2500 MHz  |  31.2 GiB RAM
Number of Processes: 8  |  Test Iterations: 1  |  Test Duration: Medium
--------------------------------------------------------------------------------
CPU Mark:                          6891
  Integer Math                     29039 Million Operations/s
  Floating Point Math              24774 Million Operations/s
  Prime Numbers                    44.7 Million Primes/s
  Sorting                          14735 Thousand Strings/s
  Encryption                       1760 MB/s
  Compression                      108733 KB/s
  CPU Single Threaded              1553 Million Operations/s
  Physics                          606 Frames/s
  Extended Instructions (SSE)      3368 Million Matrices/s

Memory Mark:                       1213
  Database Operations              3679 Thousand Operations/s
  Memory Read Cached               5943 MB/s
  Memory Read Uncached             5915 MB/s
  Memory Write                     6305 MB/s
  Available RAM                    30958 Megabytes
  Memory Latency                   75 Nanoseconds
  Memory Threaded                  24288 MB/s
--------------------------------------------------------------------------------

</code></pre>
<h3 id="2-phybin"><a class="header" href="#2-phybin">2. phybin</a></h3>
<p>Installation:</p>
<pre><code>tar xzvf phybin_desktop.tar.gz 
cd phybin_desktop/
sudo apt install ./cn.com.phytium.phybin-2.0.0_b6790883_aarch64.deb 
sudo apt install ./cn.com.phytium.phybin-ubuntu-20.04_2.0.0_aarch64.deb
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250829"><a class="header" href="#20250829">20250829</a></h1>
<h3 id="1-wine"><a class="header" href="#1-wine">1. wine</a></h3>
<p>Ubuntu20.04:</p>
<pre><code>dpkg --add-architecture i386 
sudo apt install wine64 wine32
sudo apt install -y fonts-wqy-microhei fonts-wqy-zenhei xfonts-wqy

$ wine --version
wine-5.0 (Ubuntu 5.0-3ubuntu1)
</code></pre>
<p>winecfg for calling.</p>
<p><img src="./images/2025_08_29_10_16_36_979x589.jpg" alt="./images/2025_08_29_10_16_36_979x589.jpg" /></p>
<pre><code> wget http://dl.winehq.org/wine/wine-gecko/2.47.1/wine-gecko-2.47.1-x86.msi
 wget https://dl.winehq.org/wine/wine-mono/5.0.0/wine-mono-5.0.0-x86.msi
 wget https://dl.winehq.org/wine/wine-gecko/2.47.1/wine-gecko-2.47.1-x86_64.msi
 wine start /i wine-gecko-2.47.1-x86_64.msi 
 wine start /i wine-gecko-2.47.1-x86.msi 
 wine start /i wine-mono-5.0.0-x86.msi
</code></pre>
<p><img src="./images/2025_08_29_10_41_18_606x605.jpg" alt="./images/2025_08_29_10_41_18_606x605.jpg" /></p>
<h3 id="2-phytium-benchmark2004"><a class="header" href="#2-phytium-benchmark2004">2. phytium benchmark(20.04)</a></h3>
<p>Result:</p>
<pre><code> (aarch64)
8 cores @ 2500 MHz  |  31.2 GiB RAM
Number of Processes: 8  |  Test Iterations: 1  |  Test Duration: Medium
--------------------------------------------------------------------------------
CPU Mark:                          5655
  Integer Math                     31467 Million Operations/s
  Floating Point Math              28880 Million Operations/s
  Prime Numbers                    53.1 Million Primes/s
  Sorting                          19645 Thousand Strings/s
  Encryption                       1358 MB/s
  Compression                      37695 KB/s
  CPU Single Threaded              1252 Million Operations/s
  Physics                          644 Frames/s
  Extended Instructions (NEON)     5425 Million Matrices/s

Memory Mark:                       1633
  Database Operations              4793 Thousand Operations/s
  Memory Read Cached               9521 MB/s
  Memory Read Uncached             9129 MB/s
  Memory Write                     12665 MB/s
  Available RAM                    31098 Megabytes
  Memory Latency                   76 Nanoseconds
  Memory Threaded                  26549 MB/s
--------------------------------------------------------------------------------

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250901"><a class="header" href="#20250901">20250901</a></h1>
<h3 id="1-hanbo-gpu-working-tips"><a class="header" href="#1-hanbo-gpu-working-tips">1. HanBo GPU Working Tips</a></h3>
<p>environment:</p>
<pre><code>test@d30002004:~$ uname -a
Linux d30002004 5.4.0-216-generic #236-Ubuntu SMP Fri Apr 11 19:55:34 UTC 2025 aarch64 aarch64 aarch64 GNU/Linux
test@d30002004:~$ cat /etc/issue
Ubuntu 20.04.5 LTS \n \l
</code></pre>
<p>Install hwe kernel:</p>
<pre><code> sudo apt install linux-generic-hwe-20.04
test@d30002004:~$ sudo apt install build-essential docker.io adb net-tools dkms


apt install -y build-essential git net-tools dkms make debhelper devscripts build-essential flex bison mawk libncurses-dev flex bison
apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison liblz4-tool

</code></pre>
<p>After building:</p>
<pre><code>sudo apt install ./linux-headers-5.15.98-victory_5.15.98-victory-1_arm64.deb ./linux-image-5.15.98-victory_5.15.98-victory-1_arm64.deb
sudo reboot
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250902"><a class="header" href="#20250902">20250902</a></h1>
<h3 id="1-verification-of-hb"><a class="header" href="#1-verification-of-hb">1. verification of hb</a></h3>
<p>Both cxx and ubuntu has been verified, aosp 13 only works well.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250903"><a class="header" href="#20250903">20250903</a></h1>
<h3 id="1-intel-b60"><a class="header" href="#1-intel-b60">1. Intel b60</a></h3>
<p>bios setting:</p>
<p><img src="./images/2025_09_03_15_54_29_554x390.jpg" alt="./images/2025_09_03_15_54_29_554x390.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250904"><a class="header" href="#20250904">20250904</a></h1>
<h3 id="1-winserver-2022"><a class="header" href="#1-winserver-2022">1. winserver 2022</a></h3>
<p>Choose <code>Windows Server 2022 Standard Evalution(Desktop Ex..)</code>:</p>
<p><img src="./images/2025_09_04_09_02_26_635x473.jpg" alt="./images/2025_09_04_09_02_26_635x473.jpg" /></p>
<p>Added vfs to vm:</p>
<p><img src="./images/2025_09_04_09_53_46_541x495.jpg" alt="./images/2025_09_04_09_53_46_541x495.jpg" /></p>
<p>no device driver for vgpu:</p>
<p><img src="./images/2025_09_04_09_55_14_708x503.jpg" alt="./images/2025_09_04_09_55_14_708x503.jpg" /></p>
<p><img src="./images/2025_09_04_10_27_26_628x207.jpg" alt="./images/2025_09_04_10_27_26_628x207.jpg" /></p>
<p><img src="./images/2025_09_04_10_27_08_932x675.jpg" alt="./images/2025_09_04_10_27_08_932x675.jpg" /></p>
<p><img src="./images/2025_09_04_10_28_56_702x645.jpg" alt="./images/2025_09_04_10_28_56_702x645.jpg" /></p>
<p>Open remote desktop:</p>
<p><img src="./images/2025_09_04_10_29_49_511x437.jpg" alt="./images/2025_09_04_10_29_49_511x437.jpg" /></p>
<p>Using tigervnc server for setting windows vnc server.</p>
<p><img src="./images/2025_09_04_11_48_00_1171x671.jpg" alt="./images/2025_09_04_11_48_00_1171x671.jpg" /></p>
<h3 id="2-perf-related"><a class="header" href="#2-perf-related">2. perf related</a></h3>
<p>glmark2:</p>
<p><img src="./images/2025_09_04_15_18_05_685x507.jpg" alt="./images/2025_09_04_15_18_05_685x507.jpg" /></p>
<p><img src="./images/2025_09_04_15_21_07_1001x591.jpg" alt="./images/2025_09_04_15_21_07_1001x591.jpg" /></p>
<p><img src="./images/2025_09_04_15_29_03_425x401.jpg" alt="./images/2025_09_04_15_29_03_425x401.jpg" /></p>
<p><img src="./images/2025_09_04_15_33_47_453x396.jpg" alt="./images/2025_09_04_15_33_47_453x396.jpg" /></p>
<p>Upgrade to newest kernel:</p>
<p><img src="./images/2025_09_04_16_07_34_849x386.jpg" alt="./images/2025_09_04_16_07_34_849x386.jpg" /></p>
<pre><code>sudo add-apt-repository ppa:cappelikan/ppa
apt update -y
apt install -y mainline
</code></pre>
<p><img src="./images/2025_09_04_16_10_12_890x514.jpg" alt="./images/2025_09_04_16_10_12_890x514.jpg" /></p>
<h3 id="3-build-kernel2504"><a class="header" href="#3-build-kernel2504">3. build kernel(25.04)</a></h3>
<p>In docker:</p>
<pre><code>apt update
apt install -y vim
 apt install -y flex bison libssl-dev libelf-dev bc gcc automake autoconf libtool make rsync \
            patch wget dpkg-dev libdw-dev git debhelper kmod python-is-python3 gawk libncurses-dev lsb-release zstd
cd /mnt/linux-6.16.4
git config --global --add safe.directory /mnt/linux-6.16.4
git init
git add .
git -c user.name="Your Name" -c user.email="your_email@example.com" commit -m "init commit"


cd /mnt/official
apt download linux-modules-6.14.0-24-generic
ar x linux-modules-6.14.0-24-generic_6.14.0-24_amd64.deb
tar -xvf data.tar.xz
cat ./boot/config-6.14.0-24-generic

cd /mnt/linux-6.16.4/
cp /mnt/official/boot/config-* .config
make menuconfig
## make changes to binder related

sed -i 's/^CONFIG_SYSTEM_TRUSTED_KEYS="debian\/canonical-certs.pem"/CONFIG_SYSTEM_TRUSTED_KEYS=""/' .config
sed -i 's/^CONFIG_SYSTEM_REVOCATION_KEYS="debian\/canonical-revoked-certs.pem"/CONFIG_SYSTEM_REVOCATION_KEYS=""/' .config
time make deb-pkg -j$(nproc)
</code></pre>
<p>Comparison of different configs generated deb:</p>
<pre><code>First time
-rw-r--r-- 1 root root 9.0M Sep  4 22:16 linux-headers-6.16.4-g5c503d1d0d25-dirty_6.16.4-g5c503d1d0d25-3_amd64.deb
-rw-r--r-- 1 root root  15M Sep  4 22:16 linux-image-6.16.4-g5c503d1d0d25-dirty_6.16.4-g5c503d1d0d25-3_amd64.deb
-rw-r--r-- 1 root root 1.5M Sep  4 22:16 linux-libc-dev_6.16.4-g5c503d1d0d25-3_amd64.deb

Second time(with official ubuntu config)

  LD [M]  net/qrtr/qrtr-smd.ko
  LD [M]  net/qrtr/qrtr-tun.ko
  LD [M]  net/qrtr/qrtr-mhi.ko
  LD [M]  virt/lib/irqbypass.ko
make[3]: *** [debian/rules:80: build-arch] Error 2
dpkg-buildpackage: error: make -f debian/rules binary subprocess returned exit status 2
make[2]: *** [scripts/Makefile.package:126: deb-pkg] Error 2
make[1]: *** [/mnt/linux-6.16.4/Makefile:1635: deb-pkg] Error 2
make: *** [Makefile:248: __sub-make] Error 2

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250905"><a class="header" href="#20250905">20250905</a></h1>
<h3 id="1-kernel-6164-verification"><a class="header" href="#1-kernel-6164-verification">1. kernel 6.16.4 verification</a></h3>
<p>sr-iov enabled, xorg failed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250908"><a class="header" href="#20250908">20250908</a></h1>
<h3 id="1-bypass-win11"><a class="header" href="#1-bypass-win11">1. bypass win11</a></h3>
<p>bypass the win11 installation(net connection):</p>
<pre><code>shift+F10
start ms-cxh:localonly
</code></pre>
<h3 id="2-claude-code-local"><a class="header" href="#2-claude-code-local">2. claude code local</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250909"><a class="header" href="#20250909">20250909</a></h1>
<h3 id="1-claude-code"><a class="header" href="#1-claude-code">1. claude code</a></h3>
<p>Ubuntu22.04, install steps as following:</p>
<pre><code>$ sudo apt install -y npm
$ sudo npm install -g @anthropic-ai/claude-code
npm WARN EBADENGINE Unsupported engine {
npm WARN EBADENGINE   package: '@anthropic-ai/claude-code@1.0.109',
npm WARN EBADENGINE   required: { node: '&gt;=18.0.0' },
npm WARN EBADENGINE   current: { node: 'v12.22.9', npm: '8.5.1' }
npm WARN EBADENGINE }
# update nodejs
$ curl -fsSL https://deb.nodesource.com/setup_lts.x| sudo bash -
$ sudo apt install -y nodejs
# will fail
$ sudo apt remove libnode-dev
$ sudo apt install -y nodejs
$ sudo npm install -g @anthropic-ai/claude-code
$ claude --version
1.0.109 (Claude Code)
$ pip install 'litellm[proxy]'
</code></pre>
<p>LM Studio:</p>
<pre><code>chmod 777 LM_Studio*
./LM_Studio* --appimage-extract
cd squashfs-root
./lm-studio
</code></pre>
<p>Start the listening port 1234:</p>
<p><img src="./images/2025_09_09_09_34_58_479x311.jpg" alt="./images/2025_09_09_09_34_58_479x311.jpg" /></p>
<p>Testing:</p>
<pre><code>dash@ai:~$ curl http://localhost:1234/v1/models
{
  "data": [
    {
      "id": "nomic-embed-text-v1.5",
      "object": "model",
      "owned_by": "organization_owner"
    }
  ],
  "object": "list"
</code></pre>
<p>Download the models from <code>modelscope.cn</code>:</p>
<p><img src="./images/2025_09_09_10_13_38_369x132.jpg" alt="./images/2025_09_09_10_13_38_369x132.jpg" /></p>
<pre><code>mv ~/Downloads/Qwen3-Coder-30B-A3B-Instruct-Q4_K_M.gguf ~/.lmstudio/models/lmstudio-community/Qwen3-Coder-30B-A3B-Instruct-GGUF
</code></pre>
<p><img src="./images/2025_09_09_10_45_12_1083x302.jpg" alt="./images/2025_09_09_10_45_12_1083x302.jpg" /></p>
<p><img src="./images/2025_09_09_10_46_47_677x779.jpg" alt="./images/2025_09_09_10_46_47_677x779.jpg" /></p>
<p><img src="./images/2025_09_09_10_47_17_866x332.jpg" alt="./images/2025_09_09_10_47_17_866x332.jpg" /></p>
<pre><code>$ pwd
/home/dash/Code/litellm
$ cat config.yaml
model_list:
  - model_name: claude-3-5-haiku-20241022
    litellm_params:
      model: lm_studio/qwen/qwen3-coder-30b
      api_key: sk-dummy
      api_base: http://localhost:1234/v1
  
  - model_name: claude-3-5-sonnet-20241022
    litellm_params:
      model: lm_studio/qwen/qwen3-coder-30b
      api_key: sk-dummy
      api_base: http://localhost:1234/v1
  
  # 也支持原始模型名称
  - model_name: qwen3-coder-30b
    litellm_params:
      model: lm_studio/qwen/qwen3-coder-30b
      api_key: sk-dummy
      api_base: http://localhost:1234/v1
  
  - model_name: deepseek-r1
    litellm_params:
      model: lm_studio/deepseek-r1-distill-qwen-7b
      api_key: sk-dummy
      api_base: http://localhost:1234/v1
  
general_settings:
  master_key: sk-lmstudio-proxy-12345
$ litellm --config config.yaml

</code></pre>
<p><img src="./images/2025_09_09_14_09_22_739x507.jpg" alt="./images/2025_09_09_14_09_22_739x507.jpg" /></p>
<h3 id="2-socket-proxy"><a class="header" href="#2-socket-proxy">2. socket proxy</a></h3>
<p>Host side:</p>
<pre><code>socat --experimental UNIX-LISTEN:/tmp/proxy.sock,fork  TCP:192.168.1.33:21080
chmod 777 /tmp/proxy.sock
</code></pre>
<p>Create 1 docker instance:</p>
<pre><code>$ sudo docker run --network none -v /tmp/proxy.sock:/tmp/proxy.sock -v /etc/resolv.conf:/etc/resolv.conf -it  ubuntuwithcurl:latest /bin/bash
In docker instance:    
root@5f50018c0076:/# socat TCP-LISTEN:1080,fork UNIX-CONNECT:/tmp/proxy.sock 

root@5f50018c0076:/# cat /etc/apt/apt.conf.d/proxy.conf
Acquire::http::Proxy "socks5h://127.0.0.1:1080";
Acquire::https::Proxy "socks5h://127.0.0.1:1080";

then: 
apt-get -y &amp;&amp; apt upgrade -y
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250910"><a class="header" href="#20250910">20250910</a></h1>
<h3 id="1-claude-codewritingqtapp"><a class="header" href="#1-claude-codewritingqtapp">1. claude code(WritingQTapp)</a></h3>
<p>Startup:</p>
<pre><code>export ANTHROPIC_BASE_URL="http://localhost:4000" &amp;&amp; export ANTHROPIC_AUTH_TOKEN="sk-lmstudio-proxy-12345" &amp;&amp; unset ANTHROPIC_API_KEY &amp;&amp; claude --model claude-3-5-haiku-20241022
</code></pre>
<h3 id="2-win7-on-gen10-idv"><a class="header" href="#2-win7-on-gen10-idv">2. win7 on gen10 idv</a></h3>
<p>Basic info:</p>
<p><img src="./images/2025_09_10_10_20_23_636x273.jpg" alt="./images/2025_09_10_10_20_23_636x273.jpg" /></p>
<p><img src="./images/2025_09_10_10_20_38_547x59.jpg" alt="./images/2025_09_10_10_20_38_547x59.jpg" /></p>
<p>After installation, remote desktop open:</p>
<p><img src="./images/2025_09_10_16_55_07_596x527.jpg" alt="./images/2025_09_10_16_55_07_596x527.jpg" /></p>
<p><img src="./images/2025_09_10_16_58_49_797x395.jpg" alt="./images/2025_09_10_16_58_49_797x395.jpg" /></p>
<p><img src="./images/2025_09_10_17_00_35_546x404.jpg" alt="./images/2025_09_10_17_00_35_546x404.jpg" /></p>
<p><img src="./images/2025_09_10_17_01_00_541x393.jpg" alt="./images/2025_09_10_17_01_00_541x393.jpg" /></p>
<p><img src="./images/2025_09_10_17_01_12_1141x639.jpg" alt="./images/2025_09_10_17_01_12_1141x639.jpg" /></p>
<p><img src="./images/2025_09_10_17_02_38_519x408.jpg" alt="./images/2025_09_10_17_02_38_519x408.jpg" /></p>
<p><img src="./images/2025_09_10_17_02_51_525x419.jpg" alt="./images/2025_09_10_17_02_51_525x419.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250911"><a class="header" href="#20250911">20250911</a></h1>
<h3 id="1-win7-on-gen10"><a class="header" href="#1-win7-on-gen10">1. win7 on gen10</a></h3>
<p>Verification step:</p>
<pre><code>Install ubuntu 18.04
verify win10 vm
use the same configuration for installation of win7

</code></pre>
<h3 id="2-gen-10-i9-win7raw"><a class="header" href="#2-gen-10-i9-win7raw">2. gen 10 i9 win7(raw)</a></h3>
<p>Use a rx550 gpu, for installation:</p>
<p><img src="./images/2025_09_11_10_18_14_512x516.jpg" alt="./images/2025_09_11_10_18_14_512x516.jpg" /></p>
<p>Close secure boot:</p>
<p><img src="./images/2025_09_11_10_23_02_1149x488.jpg" alt="./images/2025_09_11_10_23_02_1149x488.jpg" /></p>
<p>Get the bios mode:</p>
<p><img src="./images/2025_09_11_10_31_48_1263x659.jpg" alt="./images/2025_09_11_10_31_48_1263x659.jpg" /></p>
<p>enable csm:</p>
<pre><code>BIOS版本M31K开头的激活代码 AmiSetupWriter.efi 0x802 0x1 （CSM改为允许）

如果M31K开头的BIOS，独显为RTX 16系列和20系列输入以下三条命令
AmiSetupWriter.efi 0x808 0x0 
AmiSetupWriter.efi 0x80b 0x2
AmiSetupWriter.efi 0x80c 0x2
</code></pre>
<p><img src="./images/2025_09_11_10_52_32_1443x702.jpg" alt="./images/2025_09_11_10_52_32_1443x702.jpg" /></p>
<p>Create bios functionality disk:</p>
<p><img src="./images/2025_09_11_10_52_56_1437x655.jpg" alt="./images/2025_09_11_10_52_56_1437x655.jpg" /></p>
<p>Boot to uefi mode:<br />
<img src="./images/2025_09_11_10_54_59_802x173.jpg" alt="./images/2025_09_11_10_54_59_802x173.jpg" /></p>
<p>CSM enable:</p>
<p><img src="./images/2025_09_11_10_55_37_962x155.jpg" alt="./images/2025_09_11_10_55_37_962x155.jpg" /></p>
<p>Graphical related:</p>
<p><img src="./images/2025_09_11_10_56_31_1006x548.jpg" alt="./images/2025_09_11_10_56_31_1006x548.jpg" /></p>
<p>Ventoy for installing win7, could not start Ventoy.</p>
<h3 id="3-h3c-idvverification"><a class="header" href="#3-h3c-idvverification">3. h3c idv(verification)</a></h3>
<p>legacy items. black screen, but could be accessed via todesk.</p>
<p><img src="./images/2025_09_11_15_02_04_1010x794.jpg" alt="./images/2025_09_11_15_02_04_1010x794.jpg" /></p>
<p><img src="./images/2025_09_11_15_18_40_1044x759.jpg" alt="./images/2025_09_11_15_18_40_1044x759.jpg" /></p>
<h3 id="4-hardware-installation"><a class="header" href="#4-hardware-installation">4. hardware installation</a></h3>
<p>USB disk for installation :</p>
<p><img src="./images/2025_09_11_16_29_38_1006x442.jpg" alt="./images/2025_09_11_16_29_38_1006x442.jpg" /></p>
<p><img src="./images/2025_09_11_16_37_08_827x505.jpg" alt="./images/2025_09_11_16_37_08_827x505.jpg" /></p>
<p><img src="./images/2025_09_11_16_38_06_833x323.jpg" alt="./images/2025_09_11_16_38_06_833x323.jpg" /></p>
<p>选择重装系统:</p>
<p><img src="./images/2025_09_11_16_38_51_606x434.jpg" alt="./images/2025_09_11_16_38_51_606x434.jpg" /></p>
<p><img src="./images/2025_09_11_16_40_41_655x444.jpg" alt="./images/2025_09_11_16_40_41_655x444.jpg" /></p>
<p><img src="./images/2025_09_11_16_41_03_566x336.jpg" alt="./images/2025_09_11_16_41_03_566x336.jpg" /></p>
<p><img src="./images/2025_09_11_16_41_28_628x439.jpg" alt="./images/2025_09_11_16_41_28_628x439.jpg" /></p>
<p>进度:</p>
<p><img src="./images/2025_09_11_16_41_51_774x537.jpg" alt="./images/2025_09_11_16_41_51_774x537.jpg" /></p>
<p>导入驱动:</p>
<p><img src="./images/2025_09_11_16_44_58_562x435.jpg" alt="./images/2025_09_11_16_44_58_562x435.jpg" /></p>
<p>重启后：</p>
<p><img src="./images/2025_09_11_16_46_11_818x527.jpg" alt="./images/2025_09_11_16_46_11_818x527.jpg" /></p>
<p><img src="./images/2025_09_11_16_48_48_861x631.jpg" alt="./images/2025_09_11_16_48_48_861x631.jpg" /></p>
<p><img src="./images/2025_09_11_17_10_09_644x533.jpg" alt="./images/2025_09_11_17_10_09_644x533.jpg" /></p>
<p>Not OK with 21.20.16.5164:</p>
<p><img src="./images/2025_09_11_17_16_10_555x533.jpg" alt="./images/2025_09_11_17_16_10_555x533.jpg" /></p>
<h3 id="5-8100-verification"><a class="header" href="#5-8100-verification">5. 8100 verification</a></h3>
<p>Use the same iso for installation.</p>
<p><img src="./images/2025_09_11_17_36_19_1242x675.jpg" alt="./images/2025_09_11_17_36_19_1242x675.jpg" /></p>
<p>See this uhd630 could be activated or not?</p>
<p><img src="./images/2025_09_11_17_42_54_1039x592.jpg" alt="./images/2025_09_11_17_42_54_1039x592.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250912"><a class="header" href="#20250912">20250912</a></h1>
<h3 id="1-gen10-i7-win7"><a class="header" href="#1-gen10-i7-win7">1. gen10 i7 win7</a></h3>
<p>NB:</p>
<p><img src="./images/2025_09_12_08_06_24_959x756.jpg" alt="./images/2025_09_12_08_06_24_959x756.jpg" /></p>
<p>black screen after installation.</p>
<p><img src="./images/2025_09_12_08_49_15_1027x626.jpg" alt="./images/2025_09_12_08_49_15_1027x626.jpg" /></p>
<p>update the i219-v:</p>
<p><img src="./images/2025_09_12_08_56_14_446x201.jpg" alt="./images/2025_09_12_08_56_14_446x201.jpg" /></p>
<p>Q0 cpu:</p>
<p><img src="./images/2025_09_12_09_24_41_879x597.jpg" alt="./images/2025_09_12_09_24_41_879x597.jpg" /></p>
<p>Error for code43:</p>
<p><img src="./images/2025_09_12_09_25_12_650x568.jpg" alt="./images/2025_09_12_09_25_12_650x568.jpg" /></p>
<p>Change cpu to 10400:</p>
<p><img src="./images/2025_09_12_09_40_01_756x593.jpg" alt="./images/2025_09_12_09_40_01_756x593.jpg" /></p>
<p>Reinstall driver:</p>
<p><img src="./images/2025_09_12_09_40_24_415x326.jpg" alt="./images/2025_09_12_09_40_24_415x326.jpg" /></p>
<p><img src="./images/2025_09_12_09_40_39_408x311.jpg" alt="./images/2025_09_12_09_40_39_408x311.jpg" /></p>
<p>This time OK:</p>
<p><img src="./images/2025_09_12_09_56_42_782x665.jpg" alt="./images/2025_09_12_09_56_42_782x665.jpg" /></p>
<p><img src="./images/2025_09_12_09_57_09_790x666.jpg" alt="./images/2025_09_12_09_57_09_790x666.jpg" /></p>
<p><img src="./images/2025_09_12_09_57_35_740x654.jpg" alt="./images/2025_09_12_09_57_35_740x654.jpg" /></p>
<p><img src="./images/2025_09_12_09_57_48_603x491.jpg" alt="./images/2025_09_12_09_57_48_603x491.jpg" /></p>
<p><img src="./images/2025_09_12_09_58_13_773x674.jpg" alt="./images/2025_09_12_09_58_13_773x674.jpg" /></p>
<p><img src="./images/2025_09_12_09_58_26_723x435.jpg" alt="./images/2025_09_12_09_58_26_723x435.jpg" /></p>
<h3 id="2-idv-verification"><a class="header" href="#2-idv-verification">2. idv verification</a></h3>
<p>gen 10 won't start with gop.</p>
<p>Ignore, directly verify the win7 vm starting.</p>
<p>Add first winpe iso:</p>
<p><img src="./images/2025_09_12_15_11_46_688x495.jpg" alt="./images/2025_09_12_15_11_46_688x495.jpg" /></p>
<p>Add second iso(which contains the real ghost file):</p>
<p><img src="./images/2025_09_12_15_12_24_574x401.jpg" alt="./images/2025_09_12_15_12_24_574x401.jpg" /></p>
<p>Boot device order:</p>
<p><img src="./images/2025_09_12_15_12_44_484x316.jpg" alt="./images/2025_09_12_15_12_44_484x316.jpg" /></p>
<p>Add a vnc display with qxl graphical card:</p>
<p><img src="./images/2025_09_12_15_13_40_610x396.jpg" alt="./images/2025_09_12_15_13_40_610x396.jpg" /></p>
<p><img src="./images/2025_09_12_15_13_57_566x534.jpg" alt="./images/2025_09_12_15_13_57_566x534.jpg" /></p>
<p>快速分区:</p>
<p><img src="./images/2025_09_12_15_15_04_584x360.jpg" alt="./images/2025_09_12_15_15_04_584x360.jpg" /></p>
<p>2 partitions with esr:</p>
<p><img src="./images/2025_09_12_15_16_01_722x528.jpg" alt="./images/2025_09_12_15_16_01_722x528.jpg" /></p>
<p>REinstall system:</p>
<p><img src="./images/2025_09_12_15_16_33_826x582.jpg" alt="./images/2025_09_12_15_16_33_826x582.jpg" /></p>
<p>Selct wim file:</p>
<p><img src="./images/2025_09_12_15_16_46_755x497.jpg" alt="./images/2025_09_12_15_16_46_755x497.jpg" /></p>
<p>click uefi win7 64 bit logo :</p>
<p><img src="./images/2025_09_12_15_17_14_558x107.jpg" alt="./images/2025_09_12_15_17_14_558x107.jpg" /></p>
<p>install:</p>
<p><img src="./images/2025_09_12_15_17_30_645x474.jpg" alt="./images/2025_09_12_15_17_30_645x474.jpg" /></p>
<p>Continue:</p>
<p><img src="./images/2025_09_12_15_21_47_852x364.jpg" alt="./images/2025_09_12_15_21_47_852x364.jpg" />
Continue:</p>
<p><img src="./images/2025_09_12_15_23_30_846x514.jpg" alt="./images/2025_09_12_15_23_30_846x514.jpg" /></p>
<p>Open remote desktop and set password for Administrator, then shutdown the vm.</p>
<p>Add igpu:</p>
<p><img src="./images/2025_09_12_15_28_44_577x259.jpg" alt="./images/2025_09_12_15_28_44_577x259.jpg" /></p>
<p>and usb controller:</p>
<p><img src="./images/2025_09_12_15_29_12_576x422.jpg" alt="./images/2025_09_12_15_29_12_576x422.jpg" /></p>
<pre><code>&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;

      &lt;rom bar='on' file='/usr/share/OVMF/vbios_gvt_uefi.rom'/&gt;

    &lt;/memballoon&gt;
  &lt;/devices&gt;
    &lt;qemu:commandline&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.x-igd-opregion=on'/&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.x-igd-gms=2'/&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.multifunction=on'/&gt;
  &lt;/qemu:commandline&gt;
&lt;/domain&gt;

Edit the /etc/libvirt/hooks/qemu for adding win17
</code></pre>
<p>Don't remove vnc/qxl,</p>
<p><img src="./images/2025_09_12_15_37_42_434x255.jpg" alt="./images/2025_09_12_15_37_42_434x255.jpg" /></p>
<p>Detect graphical card:</p>
<p><img src="./images/2025_09_12_15_38_10_937x433.jpg" alt="./images/2025_09_12_15_38_10_937x433.jpg" /></p>
<p>Install driver:</p>
<p><img src="./images/2025_09_12_15_38_25_912x212.jpg" alt="./images/2025_09_12_15_38_25_912x212.jpg" /></p>
<p>Remove 360 then your uhd 630 would be OK:</p>
<p><img src="./images/2025_09_12_15_42_01_692x210.jpg" alt="./images/2025_09_12_15_42_01_692x210.jpg" /></p>
<p><img src="./images/2025_09_12_15_43_37_923x456.jpg" alt="./images/2025_09_12_15_43_37_923x456.jpg" /></p>
<p><img src="./images/2025_09_12_15_43_47_328x151.jpg" alt="./images/2025_09_12_15_43_47_328x151.jpg" /></p>
<p>shutdown, remove qxl/vnc.</p>
<p>not ok.</p>
<p><img src="./images/2025_09_12_15_49_54_407x437.jpg" alt="./images/2025_09_12_15_49_54_407x437.jpg" /></p>
<p>change qxl to video none:</p>
<pre><code>    &lt;video&gt;
      &lt;model type='none'/&gt;
      &lt;alias name='video0'/&gt;
    &lt;/video&gt;
</code></pre>
<p>Failed(wont' startup)</p>
<p>Should enable gop part for let this solution perfect.</p>
<h3 id="3-extract-and-form-new-gop"><a class="header" href="#3-extract-and-form-new-gop">3. extract and form new gop</a></h3>
<p>Use YunGuJian:</p>
<p><img src="./images/2025_09_12_16_39_49_725x523.jpg" alt="./images/2025_09_12_16_39_49_725x523.jpg" /></p>
<p>Copy to efi directory:</p>
<p><img src="./images/2025_09_12_16_45_22_1459x391.jpg" alt="./images/2025_09_12_16_45_22_1459x391.jpg" /></p>
<p><img src="./images/2025_09_12_16_46_00_948x541.jpg" alt="./images/2025_09_12_16_46_00_948x541.jpg" /></p>
<p>Also add enrol :</p>
<p><img src="./images/2025_09_12_16_46_43_478x171.jpg" alt="./images/2025_09_12_16_46_43_478x171.jpg" /></p>
<p>Copy  win10 pro disk file:</p>
<pre><code>cp -r /run/media/dash/MW/DiskHub/Windows/10/22H2/Pro/a1fe3133 /run/media/dash/VDs 
cd /run/media/dash/VDs/a1fe3133
7z x Windows10-22H2-Pro-L1.7z 

 rm -f Windows10-22H2-Pro-L1.7z
 chmod 777 Windows10-22H2-Pro-L1.vhdx
 cd ..
 cp /run/media/dash/MW/vd.config .
 vim vd.config
</code></pre>
<p><img src="./images/2025_09_12_17_13_58_1071x600.jpg" alt="./images/2025_09_12_17_13_58_1071x600.jpg" /></p>
<p><img src="./images/2025_09_12_17_23_35_1356x801.jpg" alt="./images/2025_09_12_17_23_35_1356x801.jpg" /></p>
<p><img src="./images/2025_09_12_17_25_16_1006x406.jpg" alt="./images/2025_09_12_17_25_16_1006x406.jpg" /></p>
<p><img src="./images/2025_09_12_17_26_00_612x143.jpg" alt="./images/2025_09_12_17_26_00_612x143.jpg" /></p>
<p>Put in the same folder:</p>
<p><img src="./images/2025_09_12_17_29_16_560x543.jpg" alt="./images/2025_09_12_17_29_16_560x543.jpg" /></p>
<p>UBU.bat:</p>
<p><img src="./images/2025_09_12_17_30_38_716x417.jpg" alt="./images/2025_09_12_17_30_38_716x417.jpg" /></p>
<p><img src="./images/2025_09_12_17_31_32_357x363.jpg" alt="./images/2025_09_12_17_31_32_357x363.jpg" /></p>
<p>Press 2:</p>
<p>Press S:</p>
<p><img src="./images/2025_09_12_17_32_16_584x257.jpg" alt="./images/2025_09_12_17_32_16_584x257.jpg" /></p>
<p><img src="./images/2025_09_12_17_32_57_403x272.jpg" alt="./images/2025_09_12_17_32_57_403x272.jpg" /></p>
<p>Upload this extraced file:</p>
<p><img src="./images/2025_09_12_17_34_38_688x444.jpg" alt="./images/2025_09_12_17_34_38_688x444.jpg" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250914"><a class="header" href="#20250914">20250914</a></h1>
<h3 id="1-curl-with-proxy"><a class="header" href="#1-curl-with-proxy">1. curl with proxy</a></h3>
<p>Step:</p>
<pre><code>curl --socks5-hostname  192.168.1.213:14389 https://kernel.ubuntu.com/mainline/v6.6.60/amd64/linux-modules-6.6.60-060660-generic_6.6.60-060660.202411082058_amd64.deb --output a.deb
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="20250915"><a class="header" href="#20250915">20250915</a></h1>
<h3 id="1-10400-verification"><a class="header" href="#1-10400-verification">1. 10400 verification</a></h3>
<p>Windows 7: black screen.</p>
<p>Install <code>idv 1.0.14</code>(10th version, deployed in rz):</p>
<pre><code># uname -r
5.10.90-c1dc2c9a39ac
</code></pre>
<p>Import qcow2, first use qxl/spice for verification, then shutdown, add igpu/usb device:</p>
<p><img src="./images/2025_09_15_08_56_57_587x461.jpg" alt="./images/2025_09_15_08_56_57_587x461.jpg" /></p>
<p>Edit the vm:</p>
<pre><code># virsh edit win10
OVMF_CODE.fd-&gt;OVMF.fd
Add -set parameter
</code></pre>
<p><img src="./images/2025_09_15_09_01_50_1540x862.jpg" alt="./images/2025_09_15_09_01_50_1540x862.jpg" /></p>
<h3 id="2-i7-10700-verification"><a class="header" href="#2-i7-10700-verification">2. i7-10700 verification</a></h3>
<p>Hardware info:</p>
<pre><code>root@idv-C5520V:~# lscpu | grep Model
Model:               165
Model name:          Intel(R) Core(TM) i7-10700 CPU @ 2.90GHz
root@idv-C5520V:~# uname -r
5.10.90-c1dc2c9a39ac

</code></pre>
<p>Import system:</p>
<p><img src="./images/2025_09_15_09_09_03_577x453.jpg" alt="./images/2025_09_15_09_09_03_577x453.jpg" /></p>
<p><img src="./images/2025_09_15_09_09_29_647x489.jpg" alt="./images/2025_09_15_09_09_29_647x489.jpg" /></p>
<p>The effect are as listed as the i5-10400.</p>
<h3 id="3-i5-10400tc-9073"><a class="header" href="#3-i5-10400tc-9073">3. i5-10400(tc-9073)</a></h3>
<p>Hardware info:</p>
<pre><code>root@idv-TC-9073:/var/lib/libvirt/images# lscpu | grep 'Model'
Model:               165
Model name:          Intel(R) Core(TM) i5-10400 CPU @ 2.90GHz
root@idv-TC-9073:/var/lib/libvirt/images# uname -r
5.10.90-c1dc2c9a39ac
</code></pre>
<p>test vm:</p>
<p><img src="./images/2025_09_15_09_25_45_567x408.jpg" alt="./images/2025_09_15_09_25_45_567x408.jpg" /></p>
<p>when start, the machine will remain black,</p>
<p>dmesg output:</p>
<pre><code>[   60.862887] vfio-pci 0000:00:02.0: vgaarb: changed VGA decodes: olddecodes=io+mem,decodes=io+mem:owns=io+mem
[   60.884228] virbr0: port 2(vnet0) entered blocking state
[   60.884231] virbr0: port 2(vnet0) entered disabled state
[   60.884275] device vnet0 entered promiscuous mode
[   60.884402] virbr0: port 2(vnet0) entered blocking state
[   60.884404] virbr0: port 2(vnet0) entered listening state
[   60.933346] cgroup: cgroup: disabling cgroup2 socket matching due to net_prio or net_cls activation
[   62.048369] 8086:9bc8 set_gmbus_and_flr devfn=0x10 offset=0xc5100
[   62.048378] 8086:9bc8 set_gmbus_and_flr gmbus(0xc5100)=0x0 before wa
[   62.048404] 8086:9bc8 set_gmbus_and_flr gmbus=0x1 after wa before flr
[   62.156355] vfio-pci 0000:00:02.0: vfio_ecap_init: hiding ecap 0x1b@0x100
[   62.157317] vfio-pci 0000:00:02.0: Invalid PCI ROM header signature: expecting 0xaa55, got 0x0000
[   62.157324] vfio-pci 0000:00:02.0: Invalid PCI ROM header signature: expecting 0xaa55, got 0x0000
[   62.157330] vfio-pci 0000:00:02.0: Invalid PCI ROM header signature: expecting 0xaa55, got 0x0000
[   62.233223] 8086:9bc8 set_gmbus_and_flr devfn=0x10 offset=0xc5100
[   62.233231] 8086:9bc8 set_gmbus_and_flr gmbus(0xc5100)=0x0 before wa
[   62.233257] 8086:9bc8 set_gmbus_and_flr gmbus=0x1 after wa before flr
[   62.904335] virbr0: port 2(vnet0) entered learning state
[   64.920324] virbr0: port 2(vnet0) entered forwarding state
[   64.920336] virbr0: topology change detected, propagating
</code></pre>
<p>Effect:</p>
<p><code>i7verificationidv_510kernelofficial-2025-09-15_09.59.05.mp4</code></p>
<h3 id="4-kernel-66-on-ubuntu1804"><a class="header" href="#4-kernel-66-on-ubuntu1804">4. kernel 6.6 on ubuntu1804</a></h3>
<p>hw/os info:</p>
<pre><code>root@test-Standard-PC-Q35-ICH9-2009:~# uname -r
6.1.30-victory
root@test-Standard-PC-Q35-ICH9-2009:~# gcc --version
gcc (Ubuntu 11.4.0-2ubuntu1~18.04) 11.4.0
Copyright (C) 2021 Free Software Foundation, Inc.
</code></pre>
<p>Steps:</p>
<pre><code>mkdir Code
cd Code
wget https://github.com/facebook/zstd/releases/download/v1.5.6/zstd-1.5.6.tar.gz
tar -xzf zstd-1.5.6.tar.gz
cd zstd-1.5.6
make
sudo make install
cd ..
wget https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v6.x/linux-6.6.106.tar.xz
tar xJvf linux-6.6.106.tar.xz 
cd linux-6.6.106/
cp /boot/config-6.1.30-victory .config
scripts/config --disable SYSTEM_TRUSTED_KEYS
scripts/config --disable SYSTEM_REVOCATION_KEYS
vim .config
make menuconfig
 mkdir build
mv .config build/
make menuconfig O=./build
#make LOCALVERSION="-new66" -j `jproc` O=./build
ls
ls build/
ls -l -h -a build/
time make LOCALVERSION="-new66" -j `jproc` O=./build
echo ""| make ARCH=x86_64 olddefconfig O=./build
make ARCH=x86_64 mrproper
time make LOCALVERSION="-new66" -j `jproc` O=./build
cat /proc/cpuinfo
echo ""| make ARCH=x86_64 olddefconfig O=./build
free -g
make LOCALVERSION="-newnew" -j `nproc` O=./build
df -h
make LOCALVERSION="-newnew" -j `nproc` O=./build V=1
</code></pre>
<p>Change to tsinghua git:</p>
<pre><code>time make LOCALVERSION="-th66" -j `nproc` O=./build deb-pkg
</code></pre>
<h3 id="5-kernel-verification"><a class="header" href="#5-kernel-verification">5. kernel verification</a></h3>
<p>Kernel verification:</p>
<div class="table-wrapper"><table><thead><tr><th>Kernel Version</th><th>Qemu Version</th><th>Result</th></tr></thead><tbody>
<tr><td>5.10.90</td><td>4.2.0</td><td>Succeed</td></tr>
<tr><td>6.1.109-paragon</td><td>4.2.0</td><td>Succeed</td></tr>
</tbody></table>
</div>
<h3 id="6-libvirt-based"><a class="header" href="#6-libvirt-based">6. libvirt based</a></h3>
<p>Create vm:</p>
<p><img src="./images/2025_09_15_15_26_42_447x340.jpg" alt="./images/2025_09_15_15_26_42_447x340.jpg" /></p>
<p><img src="./images/2025_09_15_15_27_16_351x207.jpg" alt="./images/2025_09_15_15_27_16_351x207.jpg" /></p>
<p>specify qcow2:</p>
<p><img src="./images/2025_09_15_15_27_43_353x217.jpg" alt="./images/2025_09_15_15_27_43_353x217.jpg" /></p>
<p>specify name:</p>
<p><img src="./images/2025_09_15_15_28_24_344x294.jpg" alt="./images/2025_09_15_15_28_24_344x294.jpg" /></p>
<p>Hypervisor details:</p>
<p><img src="./images/2025_09_15_15_28_49_419x149.jpg" alt="./images/2025_09_15_15_28_49_419x149.jpg" /></p>
<p>rtl8139:</p>
<p><img src="./images/2025_09_15_15_29_34_452x236.jpg" alt="./images/2025_09_15_15_29_34_452x236.jpg" /></p>
<p>add another iso:</p>
<p><img src="./images/2025_09_15_15_30_32_516x251.jpg" alt="./images/2025_09_15_15_30_32_516x251.jpg" /></p>
<p>Remove <code>Display Spice</code> and <code>QXL</code>:</p>
<p><img src="./images/2025_09_15_15_31_31_526x325.jpg" alt="./images/2025_09_15_15_31_31_526x325.jpg" /></p>
<p>4Core 2 threads:</p>
<p><img src="./images/2025_09_15_15_32_49_443x317.jpg" alt="./images/2025_09_15_15_32_49_443x317.jpg" /></p>
<p>Add igpu/usb host:</p>
<p><img src="./images/2025_09_15_15_34_28_450x318.jpg" alt="./images/2025_09_15_15_34_28_450x318.jpg" /></p>
<pre><code># virsh edit win720250915
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;

...

  &lt;cpu mode='host-passthrough' check='none'&gt;
    &lt;topology sockets='1' cores='4' threads='2'/&gt;
  &lt;/cpu&gt;

...

    &lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
      &lt;driver name='vfio'/&gt;
      &lt;source&gt;
        &lt;address domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
      &lt;/source&gt;
      &lt;alias name='hostdev0'/&gt;
      &lt;rom bar='on' file='/usr/share/OVMF/igpu.rom'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
    &lt;/hostdev&gt;
...

  &lt;qemu:commandline&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.x-igd-gms=2'/&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.x-igd-opregion=on'/&gt;
    &lt;qemu:arg value='-set'/&gt;
    &lt;qemu:arg value='device.hostdev0.multifunction=on'/&gt;
  &lt;/qemu:commandline&gt;
&lt;/domain&gt;

</code></pre>
<p><img src="./images/2025_09_15_15_51_04_908x515.jpg" alt="./images/2025_09_15_15_51_04_908x515.jpg" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
